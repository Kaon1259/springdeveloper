{{>layouts/header}}

<main class="schedule-shell py-4">

    <div class="schedule-layout container">

        <!-- ============ 패널 1: 상태 + 아르바이트 카드 리스트 (3열 카드) ============ -->
        <section class="panel panel-filter">
            <!-- ✅ 파란색 헤더 + 상단 라운드 -->
            <header class="panel-header panel-header-blue d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">STAFF FILTER</div>
                    <h2 class="title-lg">아르바이트 현황</h2>
                </div>
                <div class="text-end">
                    <div class="badge-soft">주간</div>
                    <div class="text-xs text-muted mt-1" id="weekRangeLabel">{{weekRangeLabel}}</div>
                </div>
            </header>

            <div class="panel-body">
                <!-- 상단: 상태 선택 + 인원 수 -->
                <div class="filter-toolbar d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <label class="form-label text-xs text-muted mb-0" for="statusSelect">상태 선택</label>
                        <select id="statusSelect" class="form-select form-select-sm status-select-inline">
                            <option value="WORKING" selected>근무중</option>
                            <option value="WAITING">시작전</option>
                            <option value="RESTING">휴식중</option>
                            <option value="PAUSED">일시중지</option>
                            <option value="RESIGNED">퇴사</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-xs text-muted">아르바이트 수</span>
                        <span id="memberCountBadge" class="badge-count">0명</span>
                    </div>
                </div>

                <!-- 3열 카드 그리드 -->
                <div id="memberList" class="member-card-grid">
                    <!-- JS 렌더: .member-card -->
                </div>

                <!-- 설명 문구 -->
                <p class="text-xs text-muted mt-3 mb-0">
                    • 상태 선택에 따라 위 카드 목록이 필터링됩니다.<br>
                    • 카드 상단 파란색 헤더(이름/상태/수정 버튼 영역)를 포함한 카드 전체를 클릭하면 아래 <strong>주간 템플릿</strong> 패널에 해당 아르바이트의 템플릿이 표시됩니다.<br>
                    • 카드 헤더의 <strong>수정</strong> 버튼을 누르면 해당 아르바이트의 <code>/members/{id}/edit</code> 화면으로 이동합니다.<br>
                    • 카드 하단의 버튼으로 <strong>주간근무 템플릿 / 주간근무시간 / 월간근무시간 / 급여관리</strong>를 바로 열 수 있습니다.
                </p>
            </div>
        </section>

        <!-- ============ 패널: 스케줄(주간템플릿만 표시) ============ -->
        <section class="panel panel-schedule" id="schedulePanel">
            <!-- ✅ 이미 파란색 헤더 + 상단 라운드 처리 -->
            <header class="panel-header panel-header-blue d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">SCHEDULE</div>
                    <h3 class="title-md mb-1" id="selectedMemberTitle">주간 템플릿 (월~일)</h3>
                    <div id="navWeek" class="nav-chips mt-1">
                        <span class="chip-ghost">{{weekRangeLabel}}</span>
                        <a class="chip-outline" id="btnWeekPrev" href="{{weekPrevUrl}}">◀ 이전 주</a>
                        <a class="chip-outline" id="btnWeekNext" href="{{weekNextUrl}}">다음 주 ▶</a>
                    </div>
                </div>
                <div class="text-end d-flex flex-column align-items-end gap-2">
                    <div>
                        <button type="button" id="btnSaveTemplate"
                                class="btn btn-sm btn-primary btn-save-template me-2"
                                disabled>
                            주간 템플릿 저장
                        </button>
                        <span id="selectedMemberStatus" class="status-chip d-none">-</span>
                    </div>
                    <div class="text-xs text-muted">
                        10분 단위 · 주간 템플릿 뷰에서만 저장 가능
                    </div>
                </div>
            </header>

            <div class="panel-body">

                <!-- 뷰: 주간 템플릿 그리드 -->
                <div id="viewWeekGrid">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-xs text-muted">슬롯 단위</span>
                            <div class="btn-group btn-group-sm slot-btn-group" id="gridSlotButtons" role="group" aria-label="슬롯 단위 선택">
                                <button type="button" class="btn btn-outline-secondary active" data-grid-slot="10">10분</button>
                                <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30분</button>
                                <button type="button" class="btn btn-outline-secondary" data-grid-slot="60">1시간</button>
                            </div>
                        </div>
                        <div class="text-xs text-muted text-end">
                            마우스를 드래그하거나 클릭하여 <strong>주간 템플릿(계획)</strong>을 설정하세요.<br>
                            <span class="text-primary">선택된 셀만 색이 칠해지고, 다시 클릭하면 흰색으로 돌아옵니다.</span>
                        </div>
                    </div>

                    <div class="schedule-board">
                        <div class="schedule-table-wrap">
                            <table class="schedule-table" id="tableWeek10m">
                                <thead>
                                <tr id="theadWeek">
                                    <th class="time-col">시간</th>
                                    <th>월</th>
                                    <th>화</th>
                                    <th>수</th>
                                    <th>목</th>
                                    <th>금</th>
                                    <th>토</th>
                                    <th>일</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeek10m"></tbody>
                            </table>
                        </div>
                        <div class="legend-row text-xs text-muted mt-2">
                            <span class="legend-box legend-plan"></span> 선택된 템플릿 셀
                        </div>
                    </div>

                </div>

            </div>
        </section>

    </div>
</main>

<!-- ===== 근무시간 팝업(기존) ===== -->
<div class="modal fade" id="schedulePopup" tabindex="-1" aria-labelledby="schedulePopupTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedulePopupTitle">근무시간</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body text-center text-muted py-5">
                표시할 데이터가 없습니다.<br>
                (주간/월간 근무시간 팝업 영역 · 추후 구현용)
            </div>
        </div>
    </div>
</div>

<!-- ===== 예상 급여 팝업(신규) ===== -->
<div class="modal fade" id="payEstimatePopup" tabindex="-1" aria-labelledby="payEstimatePopupTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payEstimatePopupTitle">예상 급여 계산</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body" id="payEstimatePopupBody">
                <!-- JS에서 계산 결과를 채웁니다. -->
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== 전체 배경/레이아웃 ===== */
    body {
        background:
                radial-gradient(circle at top left, #f5f7ff 0, #eef3ff 36%, transparent 70%),
                radial-gradient(circle at bottom right, #fef6f3 0, #ffe8da 40%, #ffe1f0 75%);
    }
    .schedule-shell {
        min-height: calc(100vh - 80px);
    }

    .schedule-layout {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .panel {
        border-radius: 18px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 18px 40px rgba(15,23,42,0.08);
        border: 1px solid rgba(148,163,184,0.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        overflow: hidden;
    }

    .panel-header {
        padding: 1.1rem 1.3rem 0.7rem 1.3rem;
        border-bottom: 1px solid rgba(226,232,240,0.9);
        background: rgba(255,255,255,0.95);
    }

    /* ✅ 상단/하단 헤더 공통 파란 스타일 + 위쪽 라운드 */
    .panel-header-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        color: #e5eeff;
        border-bottom-color: rgba(191, 219, 254, 0.7);
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.25);
        border-radius: 18px 18px 0 0; /* 상단 양쪽 라운드 */
    }
    .panel-header-blue .title-sm {
        color: rgba(226,232,255,0.85);
    }
    .panel-header-blue .title-md,
    .panel-header-blue .title-lg {
        color: #f9fafb;
    }
    .panel-header-blue .text-muted {
        color: rgba(226,232,255,0.85) !important;
    }
    .panel-header-blue .chip-ghost {
        background: rgba(15,23,42,0.22);
        color: #e5eeff;
    }
    .panel-header-blue .chip-outline {
        border-color: rgba(191,219,254,0.9);
        background: transparent;
        color: #e5eeff;
    }
    .panel-header-blue .chip-outline:hover {
        background: rgba(15,23,42,0.25);
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(15,23,42,0.5);
    }
    .panel-header-blue .status-chip {
        background: rgba(15,23,42,0.25);
        color: #e5eeff;
    }
    .panel-header-blue .btn-save-template.btn-primary {
        background-color: #0f172a;
        border-color: #0f172a;
    }
    .panel-header-blue .btn-save-template.btn-primary:disabled {
        background-color: rgba(15,23,42,0.5);
        border-color: rgba(15,23,42,0.5);
    }

    .panel-body {
        padding: 0.9rem 1.3rem 1.2rem 1.3rem;
    }

    .title-sm {
        font-size: 0.7rem;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: #9ca3af;
        font-weight: 600;
    }
    .title-lg {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }
    .title-md {
        font-size: 0.98rem;
        font-weight: 600;
        color: #111827;
    }
    .text-xs {
        font-size: 0.75rem;
    }

    .badge-soft {
        display:inline-flex;
        align-items:center;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: rgba(59,130,246,0.08);
        color:#2563eb;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .filter-toolbar {
        border-radius: 999px;
        background: rgba(248,250,252,0.8);
        padding: 0.4rem 0.8rem;
    }

    .status-select-inline {
        min-width: 130px;
        border-radius: 999px;
        border:1px solid rgba(148,163,184,0.7);
        font-size:0.85rem;
        padding-inline:0.9rem;
        padding-block:0.3rem;
        background-color:#f9fafb;
    }

    .badge-count {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        border-radius:999px;
        padding:0.18rem 0.65rem;
        background:#0f172a;
        color:#f9fafb;
        font-size:0.75rem;
        font-weight:600;
    }

    /* ===== 3열 카드 그리드 ===== */
    .member-card-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.9rem;
    }

    @media (max-width: 992px) {
        .member-card-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }
    @media (max-width: 576px) {
        .member-card-grid {
            grid-template-columns: 1fr;
        }
    }

    .member-card {
        border-radius: 16px;
        border: 1px solid rgba(226,232,240,0.9);
        background: #ffffff;
        box-shadow: 0 10px 25px rgba(15,23,42,0.06);
        display: flex;
        flex-direction: column;
        gap: 0;
        cursor: pointer;
        transition: box-shadow .12s, transform .08s, border-color .12s;
        padding: 0;
        overflow: hidden;
    }
    .member-card:hover {
        box-shadow: 0 16px 32px rgba(15,23,42,0.10);
        transform: translateY(-1px);
        border-color: rgba(59,130,246,0.6);
    }
    .member-card.active {
        border-color: rgba(59,130,246,0.9);
        box-shadow: 0 0 0 1px rgba(59,130,246,0.4), 0 18px 36px rgba(37,99,235,0.26);
    }

    /* 파란색 헤더 바 (기본) */
    .member-card-header {
        padding: 0.6rem 0.9rem;
        background: linear-gradient(90deg, #2563eb, #1d4ed8);
        color: #eff6ff;
        border-radius: 16px 16px 0 0;
        margin: 0;
    }

    /* ✅ 선택된 카드(.active)의 헤더를 주황색으로 변경 */
    .member-card.active .member-card-header {
        background: linear-gradient(90deg, #fb923c, #f97316); /* 주황 그라데이션 */
        color: #fff;
    }

    .member-name {
        font-size: 0.95rem;
        font-weight: 700;
        color:#f9fafb;
    }
    .member-card-header .dot {
        width:14px;
        height:14px;
        border-radius:50%;
        border:2px solid rgba(239,246,255,0.95);
        box-shadow:0 0 0 1px rgba(191,219,254,0.9);
        flex:0 0 14px;
    }

    .status-badge {
        display:inline-flex;
        align-items:center;
        padding:0.18rem 0.65rem;
        border-radius:999px;
        font-size:0.78rem;
        font-weight:600;
        background:#e5e7eb;
        color:#111827;
    }

    /* 헤더 안 수정 버튼 */
    .member-edit-btn {
        border-radius:999px;
        font-size:0.9rem;
        padding:0.1rem 0.6rem;
        line-height:1.2;
    }

    .member-card-body {
        font-size: 0.78rem;
        color:#111827;
        display:flex;
        flex-direction:column;
        gap: 2px;
        padding: 0.7rem 0.9rem 0.4rem 0.9rem;
    }

    .member-row {
        display: grid;
        grid-template-columns: auto 1fr auto 1fr;
        gap: 2px 8px;
        align-items: baseline;
    }

    .member-row .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color:#9ca3af;
    }
    .member-row .value {
        font-size: 0.78rem;
        font-weight: 500;
        color:#111827;
        min-width: 0;
        word-break: break-all;
    }

    .member-meta-row {
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        justify-content:space-between;
        gap:0.4rem;
        margin-top:0.25rem;
    }

    .member-card-footer {
        margin-top: 0.1rem;
        display:flex;
        flex-wrap:wrap;
        gap:0.35rem;
        justify-content:flex-end;
        padding: 0 0.9rem 0.6rem 0.9rem;
    }

    /* 카드 하단 버튼 – 탭처럼 pill 스타일 */
    .card-schedule-btn {
        border-radius:999px;
        border:1px solid transparent;
        font-size:0.78rem;
        padding:0.26rem 0.9rem;
        background:transparent;
        color:#4b5563;
        font-weight:500;
        cursor:pointer;
        transition: all .12s;
    }
    .card-schedule-btn:hover {
        background:rgba(255,255,255,0.9);
        border-color:rgba(148,163,184,0.7);
        box-shadow:0 8px 16px rgba(15,23,42,0.12);
    }
    .member-card.active .card-schedule-btn[data-action="template"] {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
        box-shadow:0 8px 16px rgba(15,23,42,0.35);
    }

    .btn-save-template {
        border-radius:999px;
        padding-inline:0.75rem;
        font-size:0.78rem;
    }
    .btn-save-template:disabled {
        opacity:.45;
        cursor:not-allowed;
    }

    .nav-chips {
        display:flex;
        flex-wrap:wrap;
        gap:0.4rem;
        align-items:center;
    }
    .chip-ghost {
        padding:0.25rem 0.8rem;
        border-radius:999px;
        background:rgba(15,23,42,0.05);
        font-size:0.75rem;
        color:#374151;
    }
    .chip-outline {
        display:inline-flex;
        align-items:center;
        padding:0.22rem 0.7rem;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.7);
        font-size:0.75rem;
        color:#374151;
        text-decoration:none;
        background:rgba(255,255,255,0.9);
        transition:all .1s;
    }
    .chip-outline:hover {
        border-color:#2563eb;
        color:#1d4ed8;
        box-shadow:0 8px 16px rgba(37,99,235,0.15);
    }

    .status-chip {
        padding:0.18rem 0.7rem;
        border-radius:999px;
        font-size:0.78rem;
        font-weight:600;
        background:#e5e7eb;
        color:#111827;
    }

    /* ===== 스케줄 보드 ===== */
    .schedule-board {
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        overflow: hidden;
        padding: 0.6rem 0.6rem 0.7rem;
    }
    .schedule-table-wrap {
        max-height: 520px;
        overflow: auto;
    }

    .schedule-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
        font-size: 0.78rem;
    }
    .schedule-table thead th {
        background: #f8fafc;
        color:#64748b;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: center;
        padding: .5rem .4rem;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    .schedule-table tbody th.time-col {
        background: #fafafa;
        color:#6b7280;
        font-weight: 600;
        width: 74px;
        border-right: 1px solid #e5e7eb;
        text-align: center;
        padding: .25rem .25rem;
        font-size: .8rem;
        position: sticky;
        left: 0;
        z-index: 1;
        font-variant-numeric: tabular-nums;
    }

    .schedule-table th,
    .schedule-table td {
        border: 0;
        padding: 2px 3px;
        vertical-align: middle;
    }

    .cell-10m {
        height: 18px;
        margin: 1px 0;
        border-radius: 6px;                 /* ✅ 라운드 렉트 */
        border: 1px solid #eef2f6;
        background: #ffffff;
        cursor: pointer;
        user-select: none;
        transition: background .15s ease,
        box-shadow .15s ease,
        border-color .15s ease,
        transform .08s ease;
    }

    .cell-10m:hover {
        background: #f8fbff;
        box-shadow: 0 0 0 1px rgba(148,163,184,0.35);
        transform: translateY(-0.5px);
    }

    .cell-10m.schedule-on {
        background: rgba(102, 187, 106, 0.55);
        border-color: rgba(46, 160, 67, 0.6);
        box-shadow: inset 0 0 0 1px rgba(46, 160, 67, 0.6);
    }

    tr.hour-start > td,
    tr.hour-start > th {
        border-top: 2px solid #e5e7eb !important;
    }

    .legend-row {
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-wrap:wrap;
        margin-top: 0.5rem;
    }
    .legend-box {
        display:inline-block;
        width:14px;
        height:14px;
        border-radius:4px;
        border:1px solid rgba(209,213,219,0.9);
        vertical-align:middle;
    }
    .legend-plan {
        background: rgba(102,187,106,0.55);
        border-color: rgba(46,160,67,0.6);
    }

    .slot-btn-group .btn {
        border-radius:999px;
        font-size:0.76rem;
        padding-inline:0.6rem;
    }
    .slot-btn-group .btn.active {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
    }

    @media (max-width: 768px) {
        .member-row {
            grid-template-columns: auto 1fr;
        }
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const HOUR_START = 6;
        const HOUR_END   = 22;

        const API_BASE_PLAN     = '/api/member';          // 주간 "템플릿" GET + POST(update)
        const PAYMENT_POPUP_URL = '/payment/individual/popup'; // ✅ 급여관리 팝업 엔드포인트

        const DOW_LABELS = ['월','화','수','목','금','토','일'];
        const DAY_CODES  = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

        // DOM
        const statusSelect      = document.getElementById('statusSelect');
        const memberList        = document.getElementById('memberList');
        const memberCountBadge  = document.getElementById('memberCountBadge');

        const tbodyWeek         = document.getElementById('tbodyWeek10m');
        const theadWeek         = document.getElementById('theadWeek');
        const selectedMemberTitle   = document.getElementById('selectedMemberTitle');
        const selectedMemberStatus  = document.getElementById('selectedMemberStatus');

        const weekRangeLabelEl  = document.getElementById('weekRangeLabel');

        const gridSlotButtonsWrapper = document.getElementById('gridSlotButtons');
        const btnSaveTemplate        = document.getElementById('btnSaveTemplate');

        const payEstimatePopupEl   = document.getElementById('payEstimatePopup');
        const payEstimatePopupBody = document.getElementById('payEstimatePopupBody');

        // 월/주 요약 관련 DOM (팝업용, 없으면 null)
        const tbodyWeekSummary      = document.getElementById('tbodyWeekSummary');
        const weekPlannedTotalCell  = document.getElementById('weekPlannedTotalCell');
        const weekActualTotalCell   = document.getElementById('weekActualTotalCell');
        const weekDeltaCell         = document.getElementById('weekDeltaCell');
        const weekPayCell           = document.getElementById('weekPayCell');
        const weekJuhyuPayCell      = document.getElementById('weekJuhyuPayCell');
        const hourlyWageCellW       = document.getElementById('hourlyWageCellW');

        const calendarGrid          = document.getElementById('calendarGrid');
        const monthLabel            = document.getElementById('monthLabel');
        const monthRangeLabel       = document.getElementById('monthRangeLabel');
        const btnMonthPrev          = document.getElementById('btnMonthPrev');
        const btnMonthThis          = document.getElementById('btnMonthThis');
        const btnMonthNext          = document.getElementById('btnMonthNext');
        const monthActualTotalCell  = document.getElementById('monthActualTotalCell');
        const monthJuhyuPayCell     = document.getElementById('monthJuhyuPayCell');
        const monthPayCell          = document.getElementById('monthPayCell');
        const hourlyWageCellM       = document.getElementById('hourlyWageCellM');

        let payEstimateModal = null;

        // 상태
        let currentMember      = null;
        let selectedMemberId   = null;
        let allMembers         = [];
        let gridStepMinutes    = 10;           // 10 / 30 / 60
        let currentWeekDates   = [];           // ["YYYY-MM-DD", ... 7개]
        let lastPlanMap        = {};           // GET된 계획 데이터 캐시

        // 드래그 선택 상태
        let gridDragging       = false;
        let gridDragAdding     = true;

        // 멤버 데이터 파싱
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        /* ✅ 단일 객체로 넘어와도 항상 배열로 정규화 */
        if (!Array.isArray(allMembers)) {
            allMembers = allMembers ? [allMembers] : [];
        }

        if (allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        attachGridSlotHandlers();
        if (btnSaveTemplate) {
            btnSaveTemplate.addEventListener('click', onClickSaveTemplate);
        }

        if (window.bootstrap && payEstimatePopupEl) {
            payEstimateModal = new bootstrap.Modal(payEstimatePopupEl);
        }

        statusSelect.addEventListener('change', handleStatusChange);

        // 카드 클릭 / 버튼 클릭 (이벤트 위임)
        memberList.addEventListener('click', async (e)=>{
            const editBtn  = e.target.closest('button[data-role="editMember"]');
            const payBtn   = e.target.closest('button[data-role="payEstimate"]');
            const actionBtn= e.target.closest('button[data-action]');
            const card     = e.target.closest('.member-card');

            // ✅ 수정 버튼: /members/{id}/edit 로 이동
            if (editBtn) {
                e.preventDefault();
                e.stopPropagation();
                const memberId = editBtn.dataset.memberId;
                if (memberId) {
                    window.location.href = `/members/${encodeURIComponent(memberId)}/edit`;
                }
                return;
            }

            // 예상 급여 버튼
            if (payBtn) {
                const memberId = payBtn.dataset.memberId;
                const m = (allMembers||[]).find(x=>String(x.id)===String(memberId));
                if (!m) return;
                await selectMember(m);
                onClickPayEstimate();
                return;
            }

            // 카드 하단 버튼들
            if (actionBtn) {
                const memberId = actionBtn.dataset.memberId;
                const action   = actionBtn.dataset.action;
                const m = (allMembers||[]).find(x=>String(x.id)===String(memberId));
                if (!m) return;

                await selectMember(m);

                if (action === 'template') {
                    // 주간템플릿 버튼 클릭 시: 하단 타임테이블로 스크롤 이동
                    const schedulePanel = document.getElementById('schedulePanel');
                    if (schedulePanel && typeof schedulePanel.scrollIntoView === 'function') {
                        schedulePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else if (action === 'week') {
                    // 주간 근무시간 팝업
                    openWeekSummaryPopupWindow();
                } else if (action === 'month') {
                    // 월간 근무시간 팝업
                    openMonthSummaryPopupWindow();
                } else if (action === 'payment') {
                    // ✅ 급여관리 팝업
                    openPaymentIndividualPopupWindow();
                }
                return;
            }

            // 카드 전체 클릭: 해당 아르바이트 선택 + 템플릿 갱신
            if (card) {
                const memberId = card.dataset.memberId;
                const m = (allMembers||[]).find(x=>String(x.id)===String(memberId));
                if (m) {
                    selectMember(m);
                }
            }
        });

        // 시작
        handleStatusChange();
        updateSaveButtonByStep();

        // ===== 상태 변경 시 카드 리스트 렌더링 =====
        function handleStatusChange(){
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);
            renderMemberList(filtered);

            if (filtered.length){
                const keep = filtered.find(m=>String(m.id)===String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            } else {
                selectedMemberId = null;
                clearRight();
            }
        }

        function renderMemberList(members){
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;

            if (!members.length){
                memberList.innerHTML = '<div class="text-xs text-muted">해당 상태의 아르바이트생이 없습니다.</div>';
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const card = document.createElement('article');
                        card.className = 'member-card';
                        card.dataset.memberId = String(m.id);
                        const color      = colorForMember(m);
                        const healthStr  = healthLabel(m);
                        const paydayStr  = formatPayday(m.payday);
                        const taxStr     = yesNoLabel(m.applyTax);
                        const includeWeeklyStr = yesNoLabel(m.includeWeeklyHolidayAllowance);
                        const createdStr = createdAtStr(m);
                        const hourlyStr  = (typeof m.hourlyWage==='number') ? krw(m.hourlyWage) : '-';
                        const hourlyStr2  = (typeof m.hourlyWage2==='number') ? krw(m.hourlyWage2) : '-';

                        card.innerHTML = `
                        <div class="member-card-header">
                            <div class="d-flex align-items-center justify-content-between gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="dot" style="background:${color}"></span>
                                    <h3 class="member-name mb-0">${escapeHtml(m.name ?? '-')}</h3>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button type="button"
                                        class="btn btn-sm btn-outline-light member-edit-btn"
                                        data-role="editMember"
                                        data-member-id="${m.id}">
                                        상세보기
                                    </button>
                                    <span class="status-badge ${statusClass(m.status)}">${statusLabel(m.status)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="member-card-body">
                            <div class="member-row">
                                <span class="label">성별</span>
                                <span class="value">${escapeHtml(m.gender ?? '-')}</span>
                                <span class="label">이메일</span>
                                <span class="value">${escapeHtml(m.email ?? '-')}</span>
                            </div>
                            <div class="member-row">
                                <span class="label">전화번호</span>
                                <span class="value">${escapeHtml(m.phone ?? '-')}</span>
                                <span class="label">보건증</span>
                                <span class="value">${escapeHtml(healthStr)}</span>
                            </div>
                            <div class="member-row">
                                <span class="label">시작일</span>
                                <span class="value">${escapeHtml(m.startDate ?? '-')}</span>
                                <span class="label">시급</span>
                                <span class="value">${escapeHtml(hourlyStr)}/${escapeHtml(hourlyStr2)}</span>
                            </div>
                            <div class="member-row">
                                <span class="label">급여지급일</span>
                                <span class="value">${escapeHtml(paydayStr)}</span>
                                <span class="label">세금 적용</span>
                                <span class="value">${escapeHtml(taxStr)}</span>
                            </div>
                            <div class="member-row">
                                <span class="label">은행</span>
                                <span class="value">${escapeHtml(m.bankName ?? '-')}</span>
                                <span class="label">계좌번호</span>
                                <span class="value">${escapeHtml(m.bankAccount ?? '-')}</span>
                            </div>
                            <div class="member-meta-row">
                                <span class="text-xs text-muted">
                                    등록일: ${escapeHtml(createdStr)} · 주휴수당: ${escapeHtml(includeWeeklyStr)}
                                </span>
                                <button type="button"
                                    class="btn btn-sm btn-outline-primary member-pay-btn"
                                    data-role="payEstimate"
                                    data-member-id="${m.id}">
                                    예상 급여 보기
                                </button>
                            </div>
                        </div>
                        <div class="member-card-footer">
                            <button type="button"
                                class="card-schedule-btn"
                                data-action="template"
                                data-member-id="${m.id}">
                                주간근무 템플릿
                            </button>
                            <button type="button"
                                class="card-schedule-btn"
                                data-action="week"
                                data-member-id="${m.id}">
                                주간근무시간
                            </button>
                            <button type="button"
                                class="card-schedule-btn"
                                data-action="month"
                                data-member-id="${m.id}">
                                월간근무시간
                            </button>
                            <!-- ✅ 새로 추가된 급여관리 버튼 -->
                            <button type="button"
                                class="card-schedule-btn"
                                data-action="payment"
                                data-member-id="${m.id}">
                                급여관리
                            </button>
                        </div>
                    `;
                        memberList.appendChild(card);
                    });

            updateMemberListActive();
        }

        async function selectMember(member){
            currentMember   = member;
            selectedMemberId= member.id;
            updateMemberListActive();
            await renderAll(member);
        }

        function updateMemberListActive(){
            Array.from(memberList.querySelectorAll('.member-card')).forEach(c=>{
                c.classList.toggle('active', c.dataset.memberId===String(selectedMemberId));
            });
        }

        // ===== 멤버 선택 시 전체 렌더 =====
        async function renderAll(member){
            if(!member) return;

            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = statusLabel(member?.status);
            selectedMemberStatus.className   = `status-chip ${statusClass(member?.status)}`;

            const { weekStartIso, weekEndIso, weekDates } = parseWeekRangeToDates(weekRangeLabelEl?.textContent || '');
            currentWeekDates = weekDates;
            renderWeekHeadDates(weekDates);

            lastPlanMap = {};

            try{
                const urlPlan = `${API_BASE_PLAN}/${encodeURIComponent(member.id)}/schedule`;
                const respPlan = await fetch(urlPlan, { headers:{'Accept':'application/json'} });
                if(respPlan.ok){
                    const data = await respPlan.json();
                    lastPlanMap = normalizeWeeklyTemplate(data, currentWeekDates);
                }
            }catch(e){
                console.error('plan fetch error', e);
            }

            rebuildWeekGridAndPaint();

            selectedMemberTitle.textContent = `${member.name ?? '-'} — 주간 템플릿`;
            updateSaveButtonByStep();
        }

        function rebuildWeekGridAndPaint(){
            buildWeekGrid();
            paintPlanFromMap(lastPlanMap, currentWeekDates);
            attachCellDragHandlers();
        }

        // ===== 슬롯 단위 버튼 처리 =====
        function attachGridSlotHandlers(){
            if(!gridSlotButtonsWrapper) return;
            gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const mins = parseInt(btn.dataset.gridSlot, 10);
                    if(!mins || mins === gridStepMinutes) return;

                    gridStepMinutes = mins;

                    gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');

                    rebuildWeekGridAndPaint();
                    updateSaveButtonByStep();
                });
            });
        }

        function updateSaveButtonByStep(){
            if(!btnSaveTemplate) return;
            const enable = (gridStepMinutes === 10 && !!currentMember && currentWeekDates.length);
            btnSaveTemplate.disabled = !enable;
            btnSaveTemplate.title = enable ? '' : '템플릿 저장은 10분 단위에서만 가능합니다.';
        }

        // ===== 주간 템플릿 그리드 =====
        function buildWeekGrid(){
            tbodyWeek.innerHTML = '';
            const totalMinutes = (HOUR_END - HOUR_START) * 60;
            const totalRows    = totalMinutes / gridStepMinutes;

            for(let idx=0; idx<totalRows; idx++){
                const absMin = HOUR_START*60 + idx*gridStepMinutes;
                const h = Math.floor(absMin/60), m = absMin%60;
                const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('hour-start');
                tr.innerHTML = `
                    <th class="time-col" scope="row">${hm}</th>
                    <td data-col="1"><div class="cell-10m"></div></td>
                    <td data-col="2"><div class="cell-10m"></div></td>
                    <td data-col="3"><div class="cell-10m"></div></td>
                    <td data-col="4"><div class="cell-10m"></div></td>
                    <td data-col="5"><div class="cell-10m"></div></td>
                    <td data-col="6"><div class="cell-10m"></div></td>
                    <td data-col="7"><div class="cell-10m"></div></td>
                `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDates(weekDates){
            const ths = theadWeek.querySelectorAll('th');
            for(let i=0; i<7; i++){
                const th = ths[i+1];
                if(!th) continue;
                const d = new Date(weekDates[i]);
                th.innerHTML = `${DOW_LABELS[i]}<br><small class="text-muted">(${d.getMonth()+1}/${d.getDate()})</small>`;
            }
        }

        function rowToInterval(rIdx){
            const startMin = HOUR_START*60 + rIdx*gridStepMinutes;
            const endMin   = startMin + gridStepMinutes;
            return { startMin, endMin };
        }

        function paintPlanFromMap(planMap, weekDates){
            if(!tbodyWeek) return;

            tbodyWeek.querySelectorAll('.cell-10m').forEach(c=>{
                c.classList.remove('schedule-on');
            });

            if(!weekDates || !weekDates.length) return;
            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso   = weekDates[dayIdx];
                const entry = planMap[iso];
                const segs  = entry?.segments || [];
                if(!segs.length) continue;

                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const { startMin, endMin } = rowToInterval(rIdx);

                    const overlaps = segs.some(seg=>{
                        const ss = hmToMin(seg.start);
                        const ee = hmToMin(seg.end);
                        return !(ee <= startMin || ss >= endMin);
                    });
                    if(overlaps){
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        // ===== 드래그/클릭으로 템플릿 선택/해제 =====
        let cellDragHandlersBound = false;

        function attachCellDragHandlers(){
            if (!tbodyWeek || cellDragHandlersBound) return;
            cellDragHandlersBound = true;

            tbodyWeek.addEventListener('mousedown', (e)=>{
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                e.preventDefault();
                gridDragging = true;

                const nowOn  = cell.classList.contains('schedule-on');
                const nextOn = !nowOn;
                gridDragAdding = nextOn;

                togglePlanCell(cell, nextOn);
            });

            tbodyWeek.addEventListener('mouseover', (e)=>{
                if (!gridDragging) return;

                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                togglePlanCell(cell, gridDragAdding);
            });

            window.addEventListener('mouseup', ()=>{
                if (gridDragging){
                    gridDragging = false;
                }
            }, { passive:true });
        }

        function togglePlanCell(cell, on){
            if(on){
                cell.classList.add('schedule-on');
            }else{
                cell.classList.remove('schedule-on');
            }
        }

        // ===== 템플릿 저장 =====
        async function onClickSaveTemplate(){
            if(gridStepMinutes !== 10){
                alert('템플릿 저장은 10분 단위에서만 가능합니다. 슬롯 단위를 10분으로 변경해 주세요.');
                return;
            }
            if(!currentMember || !currentWeekDates.length){
                alert('저장할 아르바이트와 주간 범위가 없습니다.');
                return;
            }

            const byDate = collectPlanSegmentsFromGrid();

            const summaryLines = currentWeekDates.map((iso, idx)=>{
                const label = `${DOW_LABELS[idx]} (${iso})`;
                const segs  = byDate[iso] || [];
                if(!segs.length) return `${label}: 휴무`;
                return `${label}: ${segs.map(s=>`${s.start}~${s.end}`).join(', ')}`;
            });

            const ok = confirm(
                    `다음과 같이 주간 템플릿(계획)을 저장합니다:\n\n`+
                    summaryLines.join('\n')+
                    `\n\n이대로 저장하시겠습니까?`
            );
            if(!ok) return;

            try{
                for(let idx = 0; idx < currentWeekDates.length; idx++){
                    const iso      = currentWeekDates[idx];
                    const dayCode  = DAY_CODES[idx];
                    const segments = byDate[iso] || [];

                    const payload = {
                        memberId: currentMember.id,
                        day: dayCode,
                        segments: segments
                    };

                    const url = `${API_BASE_PLAN}/${encodeURIComponent(currentMember.id)}/update`;

                    const resp = await fetch(url, {
                        method:'POST',
                        headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if(!resp.ok){
                        const txt = await resp.text().catch(()=> '');
                        alert(`저장 실패 (${iso}): ${resp.status} ${txt}`);
                        return;
                    }
                }

                alert('주간 템플릿(계획)이 저장되었습니다.');
                await renderAll(currentMember);
            }catch(e){
                console.error('템플릿 저장 중 예외:', e);
                alert('템플릿 저장 중 오류가 발생했습니다.\n' + (e.message || e));
            }
        }

        function collectPlanSegmentsFromGrid(){
            const result = {};
            if(!currentWeekDates.length || !tbodyWeek) return result;

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));
            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const indices = [];
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(cellDiv && cellDiv.classList.contains('schedule-on')){
                        indices.push(rIdx);
                    }
                });
                if(!indices.length) continue;

                const merged = mergeConsecutive(indices);
                const iso    = currentWeekDates[dayIdx];
                result[iso] = merged.map(([sIdx, eIdx])=>{
                    const startMin = HOUR_START*60 + sIdx*gridStepMinutes;
                    const endMin   = HOUR_START*60 + (eIdx+1)*gridStepMinutes;
                    return { start: minToHm(startMin), end: minToHm(endMin) };
                });
            }
            return result;
        }

        function mergeConsecutive(arr){
            if(!arr.length) return [];
            const sorted = arr.slice().sort((a,b)=>a-b);
            const out = [];
            let s = sorted[0], prev = sorted[0];
            for(let i=1;i<sorted.length;i++){
                const v = sorted[i];
                if(v === prev+1){
                    prev = v;
                    continue;
                }
                out.push([s, prev]);
                s = prev = v;
            }
            out.push([s, prev]);
            return out;
        }

        // ===== 예상 급여 버튼 클릭 (현재 주 기준) =====
        function onClickPayEstimate(){
            if(!currentMember || !currentWeekDates.length){
                alert('선택된 아르바이트 또는 주간 정보가 없습니다.');
                return;
            }

            const memberId  = currentMember.id;
            const weekStart = currentWeekDates[0];
            const weekEnd   = currentWeekDates[6];

            const url =
                    `/members/pay-estimate` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&weekStart=${encodeURIComponent(weekStart)}` +
                    `&weekEnd=${encodeURIComponent(weekEnd)}`;

            window.open(
                    url,
                    'payEstimatePopup',
                    'width=1200,height=900,scrollbars=yes,resizable=yes'
            );
        }

        // ===== 팝업 호출 =====
        function openMonthSummaryPopupWindow() {
            if (!currentMember || !currentWeekDates.length) {
                alert('선택된 아르바이트 또는 주간 정보가 없습니다.');
                return;
            }

            const memberId  = currentMember.id;
            const anchor    = currentWeekDates[0];

            const url =
                    `/members/showworkmonthdashboardpopup` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&week=${encodeURIComponent(anchor)}` +
                    `&month=${encodeURIComponent(anchor)}`;

            window.open(
                    url,
                    'monthSummaryPopup',
                    'width=1600,height=800,scrollbars=yes,resizable=yes'
            );
        }

        function openWeekSummaryPopupWindow() {
            if (!currentMember || !currentWeekDates.length) {
                alert('선택된 아르바이트 또는 주간 정보가 없습니다.');
                return;
            }

            const memberId   = currentMember.id;
            const startDate  = currentWeekDates[0];
            const endDate    = currentWeekDates[6];

            const url =
                    `/members/showworktimedashboardpopup` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&startDate=${encodeURIComponent(startDate)}` +
                    `&endDate=${encodeURIComponent(endDate)}`;

            window.open(
                    url,
                    'weekSummaryPopup',
                    'width=1600,height=800,scrollbars=yes,resizable=yes'
            );
        }

        // ✅ 새로 추가: 급여관리 팝업
        function openPaymentIndividualPopupWindow() {
            if (!currentMember) {
                alert('선택된 아르바이트가 없습니다.');
                return;
            }

            let anchorIso = null;

            // 1순위: 현재 주 배열
            if (currentWeekDates && currentWeekDates.length) {
                anchorIso = currentWeekDates[0];
            } else if (weekRangeLabelEl && weekRangeLabelEl.textContent) {
                // 2순위: weekRangeLabel에서 파싱
                const parsed = parseWeekRangeToDates(weekRangeLabelEl.textContent);
                anchorIso = parsed.weekStartIso;
            }

            // 3순위: 오늘 날짜
            if (!anchorIso) {
                anchorIso = toIso(new Date());
            }

            const memberId = currentMember.id;

            const url =
                    `${PAYMENT_POPUP_URL}` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&month=${encodeURIComponent(anchorIso)}` +
                    `&week=${encodeURIComponent(anchorIso)}`;

            window.open(
                    url,
                    'paymentIndividualPopup',
                    'width=1600,height=800,scrollbars=yes,resizable=yes'
            );
        }

        // ===== 초기화 =====
        function clearRight(){
            selectedMemberTitle.textContent   = '주간 템플릿 (월~일)';
            selectedMemberStatus.textContent  = '-';
            selectedMemberStatus.className    = 'status-chip d-none';

            tbodyWeek.innerHTML               = '';
            if(tbodyWeekSummary) tbodyWeekSummary.innerHTML        = '';
            if(calendarGrid) calendarGrid.innerHTML                = '';

            if(weekPlannedTotalCell) weekPlannedTotalCell.textContent  = '0시간';
            if(weekActualTotalCell)  weekActualTotalCell.textContent   = '0시간';
            if(weekDeltaCell)        weekDeltaCell.textContent         = '0분';
            if(weekPayCell)          weekPayCell.textContent           = '-';
            if(weekJuhyuPayCell)     weekJuhyuPayCell.textContent      = '-';
            if(hourlyWageCellW)      hourlyWageCellW.textContent       = '-';

            if(monthActualTotalCell) monthActualTotalCell.textContent  = '0시간';
            if(monthJuhyuPayCell)    monthJuhyuPayCell.textContent     = '-';
            if(monthPayCell)         monthPayCell.textContent          = '-';
            if(hourlyWageCellM)      hourlyWageCellM.textContent       = '-';
            if(monthRangeLabel)      monthRangeLabel.textContent       = '0000.00.01 ~ 00.00';

            currentWeekDates = [];
            lastPlanMap      = {};
            updateSaveButtonByStep();
        }

        // ===== 유틸 =====
        function hmToMin(hm){
            const [h,m]=String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60+(m||0);
        }

        function parseWeekRangeToDates(label){
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            let start;
            if(m){ start = new Date(+m[1], +m[2]-1, +m[3]); }
            else { const today = new Date(); start = toMonday(today); }
            const weekDates = Array.from({length:7}, (_,i)=>toIso(addDays(start,i)));
            return { weekStartIso: weekDates[0], weekEndIso: weekDates[6], weekDates };
        }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const off=(d.getDay()+6)%7;
            d.setDate(d.getDate()-off);
            return d;
        }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function formatMins(mins){
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60), m=v%60;
            return m===0 ? `${h}시간` : `${h}시간 ${m}분`;
        }
        function deltaString(min){
            const sign = min>0?'+':min<0?'-':'';
            const v=Math.abs(min);
            const h=Math.floor(v/60), m=v%60;
            return `${sign}${h}시간${m?` ${m}분`:''}`;
        }
        function krw(v){
            return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v);
        }

        function normalizeWeeklyTemplate(apiRows, weekDates){
            const map = {};
            const arr = Array.isArray(apiRows) ? apiRows : [];

            const dates = Array.isArray(weekDates) ? weekDates : [];
            const dayOrder = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

            const byDayCode = {};

            arr.forEach(row => {
                const dayCode = String(row.day || '').toUpperCase();
                if(!dayCode) return;

                if(!byDayCode[dayCode]) {
                    byDayCode[dayCode] = [];
                }

                const startHm = (row.start || '').slice(0,5);
                const endHm   = (row.end   || '').slice(0,5);

                byDayCode[dayCode].push({
                    start: startHm,
                    end: endHm
                });
            });

            dates.forEach((iso, idx) => {
                const dayCode = dayOrder[idx];
                const segs    = byDayCode[dayCode] || [];

                const minutes = segs.reduce((acc, s) => {
                    return acc + diffMinutes(s.start, s.end);
                }, 0);

                map[iso] = {
                    segments: segs,
                    minutes: minutes
                };
            });

            return map;
        }

        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }

        function statusClass(s){
            const map = {
                WORKING :'bg-success text-white',
                WAITING :'bg-secondary text-white',
                RESTING :'bg-info text-white',
                PAUSED  :'bg-warning text-dark',
                RESIGNED:'bg-danger text-white'
            };
            return map[s] || '';
        }

        function statusLabel(s){
            const map = {
                WORKING :'근무중',
                WAITING :'시작전',
                RESTING :'휴식중',
                PAUSED  :'일시중지',
                RESIGNED:'퇴사'
            };
            return map[s] || (s || '-');
        }

        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }

        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        function getCreatedAt(m){
            const v = m?.created_at ?? m?.createdAt ?? null;
            if(v==null) return null;
            if(typeof v === 'number'){
                const ms = v < 1e12 ? v * 1000 : v;
                const d = new Date(ms);
                return isNaN(d.getTime()) ? null : d;
            }
            if(typeof v === 'string'){
                const d = new Date(v);
                return isNaN(d.getTime()) ? null : d;
            }
            return null;
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function formatYmdHm(d){
            const y=d.getFullYear();
            const M=pad2(d.getMonth()+1);
            const D=pad2(d.getDate());
            const h=pad2(d.getHours());
            const m=pad2(d.getMinutes());
            return `${y}-${M}-${D} ${h}:${m}`;
        }

        function minToHm(min){
            const h = Math.floor(min/60);
            const m = min%60;
            return `${pad2(h)}:${pad2(m)}`;
        }

        function formatPayday(code){
            if(code == null || String(code).trim() === '') return '-';
            if(String(code).toUpperCase() === 'EOM') return '말일';
            const n = parseInt(code, 10);
            return isNaN(n) ? String(code) : `${n}일`;
        }
        function yesNoLabel(v){
            return Boolean(v) ? '적용' : '미적용';
        }

        function healthLabel(m){
            if (!m || !m.hasHealthCertificate) return '미보유';
            if (m.healthCertExpiry) return `보유 (${m.healthCertExpiry}까지)`;
            return '보유';
        }

        function createdAtStr(m){
            const d = getCreatedAt(m);
            return d ? formatYmdHm(d) : '-';
        }

    })();
</script>

{{>layouts/footer}}
