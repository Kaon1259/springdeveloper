{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ ì™¼ìª½: ìƒíƒœ ì„ íƒ + ì•Œë°”ìƒ ë¦¬ìŠ¤íŠ¸ + ì •ë³´ ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">

                <!-- ìƒíƒœ + ì•Œë°”ìƒ ë¦¬ìŠ¤íŠ¸ì—… -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">ì¶”ê°€ë“±ë¡</a>
                    </div>
                    <div class="card-body">
                        <!-- ìƒíƒœ ì„ íƒ -->
                        <div class="mb-3">
                            <label class="form-label small text-muted" for="statusSelect">ìƒíƒœ</label>
                            <select id="statusSelect" class="form-select">
                                <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                                <option value="WAITING">ì‹œì‘ì „</option>
                                <option value="RESTING">íœ´ì‹ì¤‘</option>
                                <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                <option value="RESIGNED">í‡´ì‚¬</option>
                            </select>
                            <div class="form-text">ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ì™€ ìš°ì¸¡ íƒ€ì„í…Œì´ë¸”ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
                        </div>

                        <hr>

                        <!-- ì•Œë°”ìƒ ë¦¬ìŠ¤íŠ¸ -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">ì•Œë°”ìƒ ëª©ë¡</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0ëª…</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS ë Œë” -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´ -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>
                            ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´
                            <small id="createdAtLabel" class="text-muted ms-2">(ë“±ë¡ì¼: -)</small>
                        </span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6">
                                <div class="text-muted">ì´ë¦„</div>
                                <div id="infoName" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ì„±ë³„</div>
                                <div id="infoGender" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ì „í™”ë²ˆí˜¸</div>
                                <div id="infoPhone" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ì´ë©”ì¼</div>
                                <div id="infoEmail" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ì‹œì‘ì¼</div>
                                <div id="infoStartDate" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ë³´ê±´ì¦</div>
                                <div id="infoHealth" class="fw-semibold">-</div>
                            </div>
                            <div class="col-12">
                                <div class="text-muted">ì‹œê¸‰(ì›)</div>
                                <div id="infoHourlyWage" class="fw-semibold">-</div>
                            </div>
                            <!-- ì€í–‰ / ê³„ì¢Œë²ˆí˜¸ -->
                            <div class="col-12">
                                <div class="text-muted">ì€í–‰</div>
                                <div id="infoBankName" class="fw-semibold">-</div>
                            </div>
                            <div class="col-12">
                                <div class="text-muted">ê³„ì¢Œë²ˆí˜¸</div>
                                <div id="infoBankAccount" class="fw-semibold">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë²”ë¡€ -->
                <div class="card">
                    <div class="card-body d-flex gap-3 align-items-center">
                        <span class="legend legend-plan"></span><span class="small">ê³„íš</span>
                        <span class="legend legend-actual"></span><span class="small">ì‹¤ì œ</span>
                        <span class="legend legend-both"></span><span class="small">ë‘˜ ë‹¤</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ ì˜¤ë¥¸ìª½ ============ -->
        <div class="col-12 col-lg-7">
            <!-- ğŸ”¼ ìƒë‹¨(ì¹´ë“œ ë°”ê¹¥): ë·° ì „í™˜ íƒ­ + ì£¼/ì›” ë‚´ë¹„ (sticky ëŒ€ìƒ) -->
            <div id="rightTopBar" class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 w-100">
                <div id="viewTabsTop" class="btn-group btn-group-sm" role="group" aria-label="view switch">
                    <button type="button" class="btn btn-outline-primary" data-view="weekGrid">ì£¼ê°„ìŠ¤ì¼€ì¤„</button>
                    <button type="button" class="btn btn-outline-primary" data-view="weekSummary">ì£¼ê°„ê·¼ë¬´ì‹œê°„</button>
                    <button type="button" class="btn btn-outline-primary" data-view="monthCalendar">ì›”ê°„ ê·¼ë¬´ì‹œê°„</button>
                </div>

                <!-- ì£¼ê°„ ë‚´ë¹„ (ì£¼ ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
                <div id="navWeek" class="d-flex align-items-center small text-muted gap-2">
                    <span id="weekRangeLabel">{{weekRangeLabel}}</span>
                    <a class="btn btn-sm btn-outline-secondary" id="btnWeekPrev" href="{{weekPrevUrl}}">â—€ ì´ì „ ì£¼</a>
                    <a class="btn btn-sm btn-outline-secondary" id="btnWeekNext" href="{{weekNextUrl}}">ë‹¤ìŒ ì£¼ â–¶</a>
                </div>

                <!-- ì›”ê°„ ë‚´ë¹„ (ì›” ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
                <div id="navMonth" class="d-none d-flex align-items-center small text-muted gap-2">
                    <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
                    <a class="btn btn-sm btn-outline-secondary" id="btnMonthPrev" href="#">â—€ ì´ì „ ë‹¬</a>
                    <a class="btn btn-sm btn-outline-secondary" id="btnMonthThis" href="#">ì´ë²ˆ ë‹¬</a>
                    <a class="btn btn-sm btn-outline-secondary" id="btnMonthNext" href="#">ë‹¤ìŒ ë‹¬ â–¶</a>
                    <!-- ìƒíƒœ ë³´ê´€ìš©(í‘œì‹œ ì•ˆ í•¨) -->
                    <span id="monthLabel" class="d-none">0000.00</span>
                </div>
            </div>

            <div class="card">
                <!-- âœ… ë©”ì¸ ì¹´ë“œ í—¤ë”ë„ sticky ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš© -->
                <div class="card-header main-header fw-bold d-flex justify-content-between align-items-center">
                    <span id="selectedMemberTitle">ì£¼ê°„ 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</span>
                    <span id="selectedMemberStatus" class="badge bg-secondary d-none">-</span>
                </div>

                <div class="card-body">
                    <!-- ë·° 1: ì£¼ê°„ 10ë¶„ ê·¸ë¦¬ë“œ -->
                    <div id="viewWeekGrid">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle text-center timetable-week-10m mb-2" id="tableWeek10m">
                                <!-- ğŸ”½ ì£¼ê°„ ìŠ¤ì¼€ì¤„ í—¤ë” thead - JSì—ì„œ sticky-sub-header í† ê¸€ -->
                                <thead class="table-light js-weekgrid-head">
                                <tr id="theadWeek">
                                    <th style="width:80px;">ì‹œê°„</th>
                                    <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeek10m"></tbody>
                            </table>
                        </div>
                        <div class="small text-muted mt-1">
                            * 10ë¶„ ë‹¨ìœ„ë¡œ ì¹ í•´ì§‘ë‹ˆë‹¤. <span class="legend legend-plan"></span> ê³„íš,
                            <span class="legend legend-actual"></span> ì‹¤ì œ, <span class="legend legend-both"></span> ê²¹ì¹˜ë©´ ì§„í•œ í‘œì‹œ.
                        </div>
                    </div>

                    <!-- ë·° 2: ì£¼ê°„ ê·¼ë¬´ì‹œê°„ ìš”ì•½ í‘œ -->
                    <div id="viewWeekSummary" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle" id="tableWeekSummary">
                                <!-- ğŸ”½ ì£¼ê°„ ìš”ì•½ í—¤ë” thead - JSì—ì„œ sticky-sub-header í† ê¸€ -->
                                <thead class="table-light js-weeksummary-head">
                                <tr>
                                    <th style="width:110px;">ìš”ì¼</th>
                                    <th>ê³„íš ê·¼ë¬´ê¸°ê°„</th>
                                    <th>ì‹¤ ê·¼ë¬´ì‹œê°„</th>
                                    <th style="width:120px;" class="text-end">ì‹¤ í•©ê³„</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeekSummary"></tbody>
                                <tfoot>
                                <tr>
                                    <th>í•©ê³„(ê³„íš)</th>
                                    <td class="text-end fw-semibold" id="weekPlannedTotalCell">0ì‹œê°„</td>
                                    <td class="text-muted">ê³„íš ë¯¸ ë°˜ì˜</td>
                                    <th></th>
                                </tr>
                                <tr class="table-secondary">
                                    <th>í•©ê³„(ì‹¤ì œ)</th>
                                    <td></td>
                                    <td class="text-end fw-semibold" colspan="2" id="weekActualTotalCell">0ì‹œê°„</td>
                                </tr>
                                <tr>
                                    <th>ì‹œê¸‰</th>
                                    <td></td>
                                    <td class="text-end">ê¸°ì¤€ ì‹œê¸‰</td>
                                    <th class="text-end" id="hourlyWageCellW">-</th>
                                </tr>
                                <!-- ğŸ”½ ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹ -->
                                <tr>
                                    <th>ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹</th>
                                    <td></td>
                                    <td class="text-end small text-muted">ì‹¤ê·¼ë¬´ â‰¥ 15ì‹œê°„ì¸ ì£¼ì— í•œí•´<br>(ì£¼ê°„ ì‹¤ê·¼ë¬´ Ã· 5ì‹œê°„)</td>
                                    <th class="text-end" id="weekJuhyuPayCell">-</th>
                                </tr>
                                <!-- ğŸ”½ ì£¼ê°„ ì˜ˆìƒ ê¸‰ì—¬(ì‹¤ê·¼ë¬´+ì£¼íœ´) -->
                                <tr class="table-secondary">
                                    <th>ì˜ˆìƒ ê¸‰ì—¬</th>
                                    <td></td>
                                    <td class="text-end">ì£¼ê°„ ì‹¤ê·¼ë¬´ + ì£¼íœ´ìˆ˜ë‹¹</td>
                                    <th class="text-end text-primary" id="weekPayCell">-</th>
                                </tr>
                                <tr>
                                    <th>ì‹¤ì œ-ê³„íš</th>
                                    <td></td>
                                    <td class="text-end">í”ŒëŸ¬ìŠ¤ë©´ ì´ˆê³¼ê·¼ë¬´</td>
                                    <th class="text-end" id="weekDeltaCell">0ë¶„</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- ë·° 3: ì›”ê°„ ë‹¬ë ¥ -->
                    <div id="viewMonthCalendar" class="d-none">
                        <div class="calendar-grid" id="calendarGrid"></div>

                        <!-- ì›” í•©ê³„/ê¸‰ì—¬(+ì£¼íœ´) -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” í•©ê³„(ì‹¤ê·¼ë¬´)</div>
                                <div class="fw-semibold" id="monthActualTotalCell">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì‹œê¸‰</div>
                                <div id="hourlyWageCellM">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ì£¼íœ´ìˆ˜ë‹¹(ì£¼ë³„ í•©ì‚°)</div>
                                <div class="fw-semibold" id="monthJuhyuPayCell">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ì˜ˆìƒ ê¸‰ì—¬(ì‹¤ê·¼ë¬´+ì£¼íœ´)</div>
                                <div class="text-primary fw-semibold" id="monthPayCell">-</div>
                            </div>
                        </div>

                        <div class="small text-muted mt-2">
                            * ë‚ ì§œ ì¹¸ì— ì‹¤ ê·¼ë¬´ êµ¬ê°„ ì¹©ê³¼ ì¼ í•©ê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
                            * ì›” ì£¼íœ´ìˆ˜ë‹¹ì€ í•´ë‹¹ ì›”ì— í¬í•¨ëœ ê° <b>ì£¼(ì›”~ì¼)</b>ì˜ ì‹¤ê·¼ë¬´ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •ë©ë‹ˆë‹¤.
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</main>

<style>
    /* ================= ì¢Œì¸¡ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ chip ================= */
    .member-chip {
        display:flex; align-items:center; justify-content:space-between;
        gap:8px; padding:8px 10px; border-radius:10px;
        background:#fff; border:1px solid #eee; margin-bottom:6px; cursor:pointer;
        transition: background .15s, border-color .15s, box-shadow .15s;
    }
    .member-chip:hover { background:#f8f9fa; }
    .member-chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
    }
    .member-chip.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ìš”ì•½/ë‹¬ë ¥ì—ì„œ ì‚¬ìš©í•˜ëŠ” chip */
    .chip {
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid #e9ecef; border-radius:14px;
        padding:4px 8px; background:#fff;
    }

    .cell-10m { height: 16px; border: 1px solid #eef2f6; border-radius: 3px; background: #fff; }
    .cell-10m.schedule-on { background: rgba(255,159,67,.28); border-color: rgba(255,159,67,.55); }
    .cell-10m.actual-on { background: rgba(25,135,84,.22); border-color: rgba(25,135,84,.35); }
    .cell-10m.schedule-on.actual-on {
        background: linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%);
        border-color: rgba(25,135,84,.5);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,.25);
    }
    tr.hour-start > td, tr.hour-start > th { border-top: 2px solid #dee2e6 !important; }
    .timecell { font-variant-numeric: tabular-nums; }

    .legend {
        display:inline-block; width:14px; height:14px;
        border-radius:3px; border:1px solid #ddd; vertical-align:middle;
    }
    .legend-plan { background: rgba(255,159,67,.35); border-color: rgba(255,159,67,.65); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.4); }
    .legend-both {
        background: linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%);
        border-color: rgba(25,135,84,.5);
    }

    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }

    /* âœ… ì›”ê°„ ìš”ì¼ì¤„ sticky */
    .calendar-grid .dow {
        text-align:center; font-weight:600; color:#6c757d;
        padding:6px 0; border-bottom:1px dashed #e9ecef;
        position: sticky;
        top: var(--sub-header-offset, 120px);
        z-index: 15;
        background:#fff;
    }
    .calendar-grid .cell {
        border:1px solid #e9ecef; border-radius:10px;
        padding:8px; min-height:120px; background:#fff;
        display:flex; flex-direction:column; gap:6px;
    }
    .cell .date-head {
        display:flex; align-items:center; justify-content:space-between;
        font-weight:600; font-size:.95rem;
    }
    .cell .date-head .dow-mini {
        color:#6c757d; font-weight:500; font-size:.85rem;
    }
    .cell .segments { display:flex; flex-wrap:wrap; gap:6px; }
    .cell .day-total { margin-top:auto; text-align:right; font-size:.875rem; color:#212529; }
    .cell.muted { background:#fcfcfc; color:#96a0aa; }
    .cell.today { outline:2px solid #51cf66; outline-offset:2px; }

    #rightTopBar {
        position: sticky;
        top: 68px;        /* ì›ë˜ var(--topbar-offset, 56px) */
        z-index: 40;
        background:#fff;
    }

    /* âœ… ë©”ì¸ ì¹´ë“œ í—¤ë” sticky (ì„ íƒ ë©¤ë²„/ìƒíƒœ) */
    .main-header {
        position: sticky;
        top: 108px;        /* ì›ë˜ var(--main-header-offset, 88px) â€“ í•„ìš”ì— ë”°ë¼ 90~110px ì •ë„ ì¡°ì • */
        z-index: 30;
        background:#fff;
    }

    /* âœ… ì£¼ê°„/ìš”ì•½ í…Œì´ë¸” í—¤ë” sticky (ì‹œê°„/ìš”ì¼ ì¤„) */
    .sticky-sub-header th {
        position: sticky;
        top: 148px;       /* ì›ë˜ var(--sub-header-offset, 120px) â€“ ìœ„ ê°’ì— ë§ì¶° ì•½ê°„ ë” ë‚´ë ¤ì¤Œ */
        z-index: 20;
        background:#f8f9fa;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const HOUR_START=6, HOUR_END=22, STEP_MIN=10, SLOTS_PER_HOUR=60/STEP_MIN;
        const VIEW_PARAM='view', VIEW_STORAGE_KEY='schedule:view', DEFAULT_VIEW='weekGrid';

        const API_BASE_PLAN   = '/api/schedule/work';   // ì£¼ê°„ "ê³„íš" API
        const API_BASE_ACTUAL = '/api/schedule';        // ì£¼ê°„/ì›”ê°„ "ì‹¤ì œ" API

        // ì¢Œì¸¡ DOM
        const statusSelect=document.getElementById('statusSelect');
        const memberList=document.getElementById('memberList');
        const memberCountBadge=document.getElementById('memberCountBadge');

        const statusBadge=document.getElementById('statusBadge');
        const infoName=document.getElementById('infoName');
        const infoGender=document.getElementById('infoGender');
        const infoPhone=document.getElementById('infoPhone');
        const infoEmail=document.getElementById('infoEmail');
        const infoStartDate=document.getElementById('infoStartDate');
        const infoHealth=document.getElementById('infoHealth');
        const infoHourlyWage=document.getElementById('infoHourlyWage');
        const infoBankName=document.getElementById('infoBankName');
        const infoBankAccount=document.getElementById('infoBankAccount');
        const createdAtLabel=document.getElementById('createdAtLabel');

        // ìš°ì¸¡ DOM
        const tbodyWeek=document.getElementById('tbodyWeek10m');
        const theadWeek=document.getElementById('theadWeek');
        const selectedMemberTitle=document.getElementById('selectedMemberTitle');
        const selectedMemberStatus=document.getElementById('selectedMemberStatus');

        const weekRangeLabelEl=document.getElementById('weekRangeLabel');

        const viewTabsTop=document.getElementById('viewTabsTop');
        const navWeek=document.getElementById('navWeek');
        const navMonth=document.getElementById('navMonth');

        const tbodyWeekSummary=document.getElementById('tbodyWeekSummary');
        const weekPlannedTotalCell=document.getElementById('weekPlannedTotalCell');
        const weekActualTotalCell=document.getElementById('weekActualTotalCell');
        const weekDeltaCell=document.getElementById('weekDeltaCell');
        const weekPayCell=document.getElementById('weekPayCell');
        const weekJuhyuPayCell=document.getElementById('weekJuhyuPayCell');
        const hourlyWageCellW=document.getElementById('hourlyWageCellW');

        const calendarGrid=document.getElementById('calendarGrid');
        const monthLabel=document.getElementById('monthLabel');
        const monthRangeLabel=document.getElementById('monthRangeLabel');
        const btnMonthPrev=document.getElementById('btnMonthPrev');
        const btnMonthThis=document.getElementById('btnMonthThis');
        const btnMonthNext=document.getElementById('btnMonthNext');
        const monthActualTotalCell=document.getElementById('monthActualTotalCell');
        const monthJuhyuPayCell=document.getElementById('monthJuhyuPayCell');
        const monthPayCell=document.getElementById('monthPayCell');
        const hourlyWageCellM=document.getElementById('hourlyWageCellM');

        const viewWeekGrid=document.getElementById('viewWeekGrid');
        const viewWeekSummary=document.getElementById('viewWeekSummary');
        const viewMonthCalendar=document.getElementById('viewMonthCalendar');

        // âœ… sticky ëŒ€ìƒ theadë§Œ ì¡ëŠ”ë‹¤
        const weekGridHead = document.querySelector('#tableWeek10m thead');
        const weekSummaryHead = document.querySelector('#tableWeekSummary thead');

        // ìƒíƒœ
        let currentMember=null;
        let selectedMemberId=null;

        // ë©¤ë²„ ë°ì´í„° íŒŒì‹±
        let allMembers=[];
        try{
            allMembers=JSON.parse(document.getElementById('membersData').textContent||'[]');
        }catch(e){
            allMembers=[];
        }
        if(Array.isArray(allMembers) && allMembers.length>0){
            statusSelect.value=allMembers[0].status || 'WORKING';
        }

        // ì´ˆê¸° ë·°
        const initialView = (() => {
            const url = new URL(window.location.href);
            return url.searchParams.get(VIEW_PARAM) || localStorage.getItem(VIEW_STORAGE_KEY) || DEFAULT_VIEW;
        })();
        setActiveTabButton(initialView);
        switchView(initialView);

        attachMonthHandlers();

        viewTabsTop.addEventListener('click', (e)=>{
            const btn=e.target.closest('button[data-view]');
            if(!btn) return;
            const view=btn.dataset.view;
            setActiveTabButton(view);
            switchView(view);
            const url=new URL(window.location.href);
            url.searchParams.set(VIEW_PARAM, view);
            window.history.replaceState({}, '', url.toString());
            try{ localStorage.setItem(VIEW_STORAGE_KEY, view); }catch(_){}
        });

        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        // ì‹œì‘
        handleStatusChange();

        // ===== ì¢Œì¸¡: ìƒíƒœ ë³€ê²½ ì‹œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
        function handleStatusChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            renderMemberList(filtered);

            if(filtered.length){
                const keep = filtered.find(m=>String(m.id)===String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            }else{
                selectedMemberId=null;
                clearRight();
                clearMemberInfo();
            }
        }

        function renderMemberList(members){
            memberList.innerHTML='';
            memberCountBadge.textContent=`${members.length}ëª…`;

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const li=document.createElement('li');
                        li.className='list-group-item member-chip';
                        li.dataset.memberId=String(m.id);
                        const color=colorForMember(m);
                        li.innerHTML=`
                        <span class="left d-inline-flex align-items-center gap-2">
                            <span class="dot" style="background:${color}"></span>
                            <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
                            <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-primary view-btn" data-id="${String(m.id)}">ìƒì„¸</button>
                    `;
                        memberList.appendChild(li);
                    });

            if(!members.length){
                const li=document.createElement('li');
                li.className='list-group-item';
                li.textContent='í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤.';
                memberList.appendChild(li);
            }

            updateMemberListActive();
        }

        async function onMemberListClick(e){
            const btn=e.target.closest('.view-btn');
            if(btn){
                const id=btn.getAttribute('data-id');
                if(id) window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
                return;
            }
            const li=e.target.closest('li.member-chip');
            if(!li) return;
            const id=li.dataset.memberId;
            const m=(allMembers||[]).find(x=>String(x.id)===String(id));
            if(m) selectMember(m);
        }

        async function selectMember(member){
            currentMember=member;
            selectedMemberId=member.id;
            updateMemberListActive();
            await renderAll(member);
        }

        function updateMemberListActive(){
            Array.from(memberList.querySelectorAll('.member-chip')).forEach(li=>{
                li.classList.toggle('active', li.dataset.memberId===String(selectedMemberId));
            });
        }

        // ===== ë©¤ë²„ ì„ íƒ ì‹œ ìš°ì¸¡ ì „ì²´ ë Œë” =====
        async function renderAll(member){
            if(!member) return;

            renderMemberInfo(member);
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member?.status || '-';
            selectedMemberStatus.className = `badge ${statusClass(member?.status)}`;

            const { weekStartIso, weekEndIso, weekDates } = parseWeekRangeToDates(weekRangeLabelEl?.textContent || '');
            renderWeekHeadDates(weekDates);
            buildWeekGrid10m();

            // 1) ì£¼ê°„ ê³„íš
            let planMap = {};
            try{
                const url = `${API_BASE_PLAN}/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                if(resp.ok){
                    const data = await resp.json();
                    planMap = normalizeDays(data);
                }
            }catch(e){
                console.error('plan fetch error', e);
            }

            // 2) ì£¼ê°„ ì‹¤ì œ
            let actualMap = {};
            try{
                const url=`${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const resp=await fetch(url,{headers:{'Accept':'application/json'}});
                if(resp.ok){
                    const data=await resp.json();
                    actualMap = normalizeDays(data);
                }
            }catch(e){
                console.error('actual fetch error', e);
            }

            // 3) ê·¸ë¦¬ë“œ ì¹ í•˜ê¸°
            paintPlanFromMap(planMap, weekDates);
            paintActualFromMap(actualMap, weekDates);

            // 4) ì£¼ê°„ ìš”ì•½í‘œ
            await renderWeekSummary(member, weekDates, planMap, actualMap);

            // 5) ì›”ê°„ ë‹¬ë ¥
            const baseDate = parseIsoDate(weekStartIso);
            await renderMonthCalendar(member, baseDate);

            selectedMemberTitle.textContent = `${member.name ?? '-'} â€” ë³´ê¸° ì „í™˜`;
            const active = getActiveView();
            switchView(active);
        }

        // ===== íƒ­/ë·° ì „í™˜ =====
        function setActiveTabButton(view){
            viewTabsTop.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            const btn=viewTabsTop.querySelector(`button[data-view="${view}"]`) || viewTabsTop.querySelector(`button[data-view="${DEFAULT_VIEW}"]`);
            if(btn) btn.classList.add('active');
        }
        function getActiveView(){
            return viewTabsTop.querySelector('button.active')?.dataset.view || DEFAULT_VIEW;
        }

        function switchView(view){
            const isWeek = (view==='weekGrid' || view==='weekSummary');
            navWeek.classList.toggle('d-none', !isWeek);
            navMonth.classList.toggle('d-none', view!=='monthCalendar');

            viewWeekGrid.classList.toggle('d-none', view!=='weekGrid');
            viewWeekSummary.classList.toggle('d-none', view!=='weekSummary');
            viewMonthCalendar.classList.toggle('d-none', view!=='monthCalendar');

            // âœ… í™œì„± ë·°ì—ë§Œ sticky-sub-header ì ìš©
            if (weekGridHead && weekSummaryHead) {
                weekGridHead.classList.remove('sticky-sub-header');
                weekSummaryHead.classList.remove('sticky-sub-header');

                if (view === 'weekGrid') {
                    weekGridHead.classList.add('sticky-sub-header');
                } else if (view === 'weekSummary') {
                    weekSummaryHead.classList.add('sticky-sub-header');
                }
            }
        }

        // ===== ì›” ë‚´ë¹„: ë¦¬ë¡œë“œ ì—†ì´ ì‘ë™ =====
        function attachMonthHandlers(){
            if(btnMonthPrev){
                btnMonthPrev.addEventListener('click', (e)=>{
                    e.preventDefault();
                    navigateMonth(-1);
                });
            }
            if(btnMonthNext){
                btnMonthNext.addEventListener('click', (e)=>{
                    e.preventDefault();
                    navigateMonth(+1);
                });
            }
            if(btnMonthThis){
                btnMonthThis.addEventListener('click', (e)=>{
                    e.preventDefault();
                    const today = new Date();
                    const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    if(currentMember){
                        renderMonthCalendar(currentMember, thisMonth);
                    }
                });
            }
        }

        function navigateMonth(offset){
            const curStart = getCurrentMonthStart();
            const target = new Date(curStart.getFullYear(), curStart.getMonth()+offset, 1);
            if(currentMember){
                renderMonthCalendar(currentMember, target);
            }
        }

        // ===== ì£¼ê°„ 10ë¶„ ê·¸ë¦¬ë“œ =====
        function buildWeekGrid10m(){
            tbodyWeek.innerHTML='';
            const totalRows = (HOUR_END - HOUR_START) * SLOTS_PER_HOUR;
            for(let idx=0; idx<totalRows; idx++){
                const minutesFromStart = idx * STEP_MIN;
                const absMin = HOUR_START*60 + minutesFromStart;
                const h = Math.floor(absMin/60), m = absMin%60;
                const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('hour-start');
                tr.innerHTML = `
                <th class="timecell" scope="row">${hm}</th>
                <td data-col="1"><div class="cell-10m"></div></td>
                <td data-col="2"><div class="cell-10m"></div></td>
                <td data-col="3"><div class="cell-10m"></div></td>
                <td data-col="4"><div class="cell-10m"></div></td>
                <td data-col="5"><div class="cell-10m"></div></td>
                <td data-col="6"><div class="cell-10m"></div></td>
                <td data-col="7"><div class="cell-10m"></div></td>
            `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDates(weekDates){
            const ths = theadWeek.querySelectorAll('th');
            for(let i=0;i<7;i++){
                const th = ths[i+1];
                if(!th) continue;
                const d = new Date(weekDates[i]);
                th.innerHTML = `${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]}<br><small class="text-muted">(${d.getMonth()+1}/${d.getDate()})</small>`;
            }
        }

        function rowToHm(rIdx){
            const absMin = HOUR_START*60 + rIdx*STEP_MIN;
            const h = Math.floor(absMin/60), m = absMin%60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        // ê³„íš ì¹ í•˜ê¸°
        function paintPlanFromMap(planMap, weekDates){
            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso = weekDates[dayIdx];
                const entry = planMap[iso];
                if(!entry) continue;
                const segs = entry.segments || [];
                if(!segs.length) continue;

                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const hm = rowToHm(rIdx);
                    if(segs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        // ì‹¤ì œ ì¹ í•˜ê¸°
        function paintActualFromMap(actualMap, weekDates){
            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso = weekDates[dayIdx];
                const entry = actualMap[iso];
                if(!entry) continue;
                const segs = entry.segments || [];
                if(!segs.length) continue;

                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const hm = rowToHm(rIdx);
                    if(segs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('actual-on');
                    }
                });
            }
        }

        // ===== ì£¼ê°„ ìš”ì•½ (ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹ í¬í•¨) =====
        async function renderWeekSummary(member, weekDates, planMap, actualMap){
            const DOW = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

            let wPlanned = 0, wActual = 0;
            const rows = [];

            for(let i=0;i<7;i++){
                const d = new Date(weekDates[i]);
                const iso = weekDates[i];

                const p = planMap[iso] || {segments:[], minutes:0};
                const a = actualMap[iso] || {segments:[], minutes:0};

                wPlanned += (p.minutes||0);
                wActual  += (a.minutes||0);

                const chipsPlanned = p.segments.length
                        ? p.segments.map(s=>chipHtml('#ff9f43', s.start, s.end)).join(' ')
                        : '<span class="text-muted">â€”</span>';
                const chipsActual = a.segments.length
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted">â€”</span>';

                rows.push(`
                <tr>
                    <th scope="row">${DOW[d.getDay()]}</th>
                    <td>${chipsPlanned}</td>
                    <td>${chipsActual}</td>
                    <td class="text-end">${formatMins(a.minutes||0)}</td>
                </tr>
            `);
            }

            tbodyWeekSummary.innerHTML = rows.join('');
            weekPlannedTotalCell.textContent = formatMins(wPlanned);
            weekActualTotalCell.textContent  = formatMins(wActual);
            weekDeltaCell.textContent        = deltaString(wActual - wPlanned);

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            hourlyWageCellW.textContent = (wage!=null) ? krw(wage) : '-';

            const juhyuMinutesWeek = calcWeeklyJuhyuMinutes(wActual);
            const juhyuPayWeek = (wage!=null) ? Math.round((juhyuMinutesWeek/60)*wage) : null;
            weekJuhyuPayCell.textContent = (juhyuPayWeek!=null) ? krw(juhyuPayWeek) : '-';

            const basePayWeek = (wage!=null) ? Math.round((wActual/60)*wage) : null;
            const totalPayWeek = (basePayWeek!=null && juhyuPayWeek!=null) ? basePayWeek + juhyuPayWeek : null;
            weekPayCell.textContent = (totalPayWeek!=null) ? krw(totalPayWeek) : '-';
        }

        // ===== ì›”ê°„ ë‹¬ë ¥ (ì‹¤ì œ ê·¼ë¬´ + ì£¼ë³„ ì£¼íœ´ìˆ˜ë‹¹ í•©ì‚°) =====
        async function renderMonthCalendar(member, baseDate){
            const ms = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
            const me = new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 0);
            const monthStartIso = toIso(ms), monthEndIso = toIso(me);

            monthLabel.textContent = `${ms.getFullYear()}.${String(ms.getMonth()+1).padStart(2,'0')}`;
            monthLabel.dataset.monthStart = monthStartIso;

            const leftY = ms.getFullYear();
            const leftM = String(ms.getMonth()+1).padStart(2,'0');
            const leftD = '01';
            const rightM = String(me.getMonth()+1).padStart(2,'0');
            const rightD = String(me.getDate()).padStart(2,'0');
            monthRangeLabel.textContent = `${leftY}.${leftM}.${leftD} ~ ${rightM}.${rightD}`;

            let actualMap = {};
            try {
                const url = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (resp.ok) { actualMap = normalizeDays(await resp.json()); }
            } catch (e) { console.error(e); }

            calendarGrid.innerHTML = '';
            const DOW_HEAD = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            DOW_HEAD.forEach(label=>{
                const h = document.createElement('div');
                h.className = 'dow';
                h.textContent = label;
                calendarGrid.appendChild(h);
            });

            const todayIso = toIso(new Date());
            const firstDow = ms.getDay();
            for (let i=0;i<firstDow;i++){
                const blank = document.createElement('div');
                blank.className = 'cell muted';
                calendarGrid.appendChild(blank);
            }

            let monthMinutes = 0;
            const weeklyMinutesMap = {};

            for (let d = new Date(ms); d <= me; d.setDate(d.getDate()+1)) {
                const iso = toIso(d);
                const dow = d.getDay();
                const a = actualMap[iso] || {segments:[], minutes:0};
                const dayMinutes = a.minutes || 0;
                monthMinutes += dayMinutes;

                if (dayMinutes > 0){
                    const weekStartIso = toIso(toMonday(d));
                    weeklyMinutesMap[weekStartIso] = (weeklyMinutesMap[weekStartIso] || 0) + dayMinutes;
                }

                const cell = document.createElement('div');
                cell.className = 'cell';
                if (iso === todayIso) cell.classList.add('today');

                const chipsHtml = (a.segments?.length)
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted small">â€”</span>';

                cell.innerHTML = `
                <div class="date-head">
                    <span>${d.getDate()}ì¼</span>
                    <span class="dow-mini">${DOW_HEAD[dow]}</span>
                </div>
                <div class="segments">${chipsHtml}</div>
                <div class="day-total">${formatMins(dayMinutes)}</div>
            `;
                calendarGrid.appendChild(cell);
            }

            let monthJuhyuMinutes = 0;
            Object.values(weeklyMinutesMap).forEach(weekMinutes=>{
                monthJuhyuMinutes += calcWeeklyJuhyuMinutes(weekMinutes);
            });

            monthActualTotalCell.textContent = formatMins(monthMinutes);
            const wage = (typeof member?.hourlyWage==='number') ? member?.hourlyWage : null;
            hourlyWageCellM.textContent = (wage!=null) ? krw(wage) : '-';

            let basePay = null, juhyuPay = null, totalPay = null;
            if (wage != null){
                basePay = Math.round((monthMinutes/60)*wage);
                juhyuPay = Math.round((monthJuhyuMinutes/60)*wage);
                totalPay = basePay + juhyuPay;
            }

            monthJuhyuPayCell.textContent = (juhyuPay!=null) ? krw(juhyuPay) : '-';
            monthPayCell.textContent      = (totalPay!=null) ? krw(totalPay) : '-';
        }

        function getCurrentMonthStart(){
            const ds = monthLabel?.dataset?.monthStart;
            if(ds && /^\d{4}-\d{2}-\d{2}$/.test(ds)) return parseIsoDate(ds);
            const t = new Date();
            return new Date(t.getFullYear(), t.getMonth(), 1);
        }

        // ===== Info/Utils =====
        function renderMemberInfo(m){
            infoName.textContent=m.name ?? '-';
            infoGender.textContent=m.gender ?? '-';
            infoPhone.textContent=m.phone ?? '-';
            infoEmail.textContent=m.email ?? '-';
            infoStartDate.textContent=m.startDate ?? '-';
            infoHealth.textContent = m.hasHealthCertificate
                    ? (m.healthCertExpiry ? `ë³´ìœ  (ìœ íš¨ê¸°ê°„: ${m.healthCertExpiry})` : 'ë³´ìœ ')
                    : 'ë¯¸ë³´ìœ ';
            infoHourlyWage.textContent=(typeof m.hourlyWage==='number') ? krw(m.hourlyWage) : '-';
            infoBankName.textContent = m.bankName ?? '-';
            infoBankAccount.textContent = m.bankAccount ?? '-';

            const created = getCreatedAt(m);
            const createdStr = created ? formatYmdHm(created) : '-';
            createdAtLabel.textContent = `(ë“±ë¡ì¼: ${createdStr})`;

            statusBadge.textContent=m.status || '-';
            statusBadge.className=`badge ${statusClass(m.status)}`;
        }

        function clearMemberInfo(){
            infoName.textContent='-';
            infoGender.textContent='-';
            infoPhone.textContent='-';
            infoEmail.textContent='-';
            infoStartDate.textContent='-';
            infoHealth.textContent='-';
            infoHourlyWage.textContent='-';
            infoBankName.textContent='-';
            infoBankAccount.textContent='-';
            createdAtLabel.textContent='(ë“±ë¡ì¼: -)';
            statusBadge.textContent='-';
            statusBadge.className='badge bg-secondary';
        }

        function clearRight(){
            selectedMemberTitle.textContent='ì£¼ê°„ 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)';
            selectedMemberStatus.textContent='-';
            selectedMemberStatus.className='badge bg-secondary d-none';

            tbodyWeek.innerHTML='';
            tbodyWeekSummary.innerHTML='';
            calendarGrid.innerHTML='';

            weekPlannedTotalCell.textContent='0ì‹œê°„';
            weekActualTotalCell.textContent='0ì‹œê°„';
            weekDeltaCell.textContent='0ë¶„';
            weekPayCell.textContent='-';
            weekJuhyuPayCell.textContent='-';
            hourlyWageCellW.textContent='-';

            monthActualTotalCell.textContent='0ì‹œê°„';
            monthJuhyuPayCell.textContent='-';
            monthPayCell.textContent='-';
            hourlyWageCellM.textContent='-';
            monthRangeLabel.textContent='0000.00.01 ~ 00.00';
        }

        function slotInside(hm, s, e){ const t=hmToMin(hm), ss=hmToMin(s), ee=hmToMin(e); return t>=ss && t<ee; }
        function hmToMin(hm){ const [h,m]=String(hm).split(':').map(n=>parseInt(n,10)); return h*60+(m||0); }

        function parseWeekRangeToDates(label){
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            let start;
            if(m){ start = new Date(+m[1], +m[2]-1, +m[3]); }
            else { const today = new Date(); start = toMonday(today); }
            const weekDates = Array.from({length:7}, (_,i)=>toIso(addDays(start,i)));
            return { weekStartIso: weekDates[0], weekEndIso: weekDates[6], weekDates };
        }
        function toMonday(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d; }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function parseIsoDate(iso){ const [y,m,d]=iso.split('-').map(n=>parseInt(n,10)); return new Date(y,m-1,d); }

        function formatMins(mins){ const h=Math.floor(mins/60), m=mins%60; return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`; }
        function deltaString(min){ const sign = min>0?'+':min<0?'-':''; const v=Math.abs(min); const h=Math.floor(v/60), m=v%60; return `${sign}${h}ì‹œê°„${m?` ${m}ë¶„`:''}`; }
        function krw(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }

        // âœ… ê³„íš/ì‹¤ì œ ê³µí†µ normalizer (days ë°°ì—´ -> dateë³„ {segments, minutes})
        function normalizeDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }
        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }

        // âœ… ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹ "ë¶„" ê³„ì‚°
        function calcWeeklyJuhyuMinutes(weeklyMinutes){
            if(!weeklyMinutes || weeklyMinutes < 15*60) return 0;
            return Math.round(weeklyMinutes / 5);
        }

        function chipHtml(color, start, end){
            return `<span class="chip"><span class="legend" style="background:${color};border-color:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function statusClass(s){
            const map = {WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            return map[s] || 'bg-secondary';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        // ë“±ë¡ì¼ í—¬í¼
        function getCreatedAt(m){
            const v = m?.created_at ?? m?.createdAt ?? null;
            if(v==null) return null;
            if(typeof v === 'number'){
                const ms = v < 1e12 ? v * 1000 : v;
                const d = new Date(ms);
                return isNaN(d.getTime()) ? null : d;
            }
            if(typeof v === 'string'){
                const d = new Date(v);
                return isNaN(d.getTime()) ? null : d;
            }
            return null;
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function formatYmdHm(d){
            const y=d.getFullYear();
            const M=pad2(d.getMonth()+1);
            const D=pad2(d.getDate());
            const h=pad2(d.getHours());
            const m=pad2(d.getMinutes());
            return `${y}-${M}-${D} ${h}:${m}`;
        }
    })();
</script>

{{>layouts/footer}}
