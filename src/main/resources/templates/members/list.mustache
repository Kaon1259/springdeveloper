{{>layouts/header}}

<main class="schedule-shell py-4">

    <div class="schedule-layout container">

        <!-- ============ íŒ¨ë„ 1: ìƒíƒœ + ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ (í•œ ì¤„ ì •ë ¬) ============ -->
        <section class="panel panel-filter">
            <header class="panel-header d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">STAFF FILTER</div>
                    <h2 class="title-lg">ì•„ë¥´ë°”ì´íŠ¸ í˜„í™©</h2>
                </div>
                <div class="text-end">
                    <div class="badge-soft">ì£¼ê°„</div>
                    <div class="text-xs text-muted mt-1" id="weekRangeLabel">{{weekRangeLabel}}</div>
                </div>
            </header>

            <div class="panel-body">
                <!-- ìƒíƒœ ì„ íƒ + ì•„ë¥´ë°”ì´íŠ¸ ëª©ë¡ í•œ ì¤„ ì •ë ¬ -->
                <div class="filter-inline-row">
                    <!-- ìƒíƒœ ì„ íƒ (ì™¼ìª½) -->
                    <div class="filter-status-inline d-flex align-items-center gap-2">
                        <label class="form-label text-xs text-muted mb-0" for="statusSelect">ìƒíƒœ ì„ íƒ</label>
                        <select id="statusSelect" class="form-select form-select-sm status-select-inline">
                            <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                            <option value="WAITING">ì‹œì‘ì „</option>
                            <option value="RESTING">íœ´ì‹ì¤‘</option>
                            <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                            <option value="RESIGNED">í‡´ì‚¬</option>
                        </select>
                    </div>

                    <!-- ì•„ë¥´ë°”ì´íŠ¸ ëª©ë¡ (ì˜¤ë¥¸ìª½, ê°™ì€ ë¼ì¸) -->
                    <div class="filter-members-inline d-flex align-items-center flex-wrap gap-2 flex-grow-1">
                        <span class="text-xs text-muted">ì•„ë¥´ë°”ì´íŠ¸ ëª©ë¡</span>
                        <span id="memberCountBadge" class="badge-count">0ëª…</span>
                        <div id="memberList" class="vlist vlist-inline">
                            <!-- JS ë Œë”: .pill -->
                        </div>
                    </div>
                </div>

                <!-- ì„¤ëª… ë¬¸êµ¬ëŠ” í•œ ì¤„ ì•„ë˜ì— ì‘ê²Œ -->
                <p class="text-xs text-muted mt-2 mb-0">
                    â€¢ ìƒíƒœ ì„ íƒì— ë”°ë¼ ì˜¤ë¥¸ìª½ ëª©ë¡ì´ í•„í„°ë§ë©ë‹ˆë‹¤.<br>
                    â€¢ ì´ë¦„ ì˜†ì˜ ìƒ‰ìƒì€ í•´ë‹¹ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ìƒì´ë©°, ì£¼ê°„ í…œí”Œë¦¿/ì›”ê°„ ìº˜ë¦°ë”ì—ë„ ë™ì¼ ìƒ‰ìƒìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </section>

        <!-- ============ íŒ¨ë„ 2: ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´ ì¹´ë“œ ============ -->
        <section class="panel card-info mb-3">
            <header class="panel-header panel-header-compact d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">PROFILE</div>
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <h2 class="title-lg mb-0">ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´</h2>
                        <span id="infoName" class="name-pill">-</span>
                    </div>
                    <div class="text-xs text-muted mt-1">
                        <span id="createdAtLabel">(ë“±ë¡ì¼: -)</span>
                    </div>
                </div>
                <div class="d-flex flex-column align-items-end gap-2">
                    <span id="statusBadge" class="status-badge">-</span>
                </div>
            </header>

            <div class="panel-body">
                <!-- 1ì¤„: ì„±ë³„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ë³´ê±´ì¦ -->
                <div class="info-grid mb-2">
                    <div class="info-item">
                        <div class="label">ì„±ë³„</div>
                        <div id="infoGender" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ì „í™”ë²ˆí˜¸</div>
                        <div id="infoPhone" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ì´ë©”ì¼</div>
                        <div id="infoEmail" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ë³´ê±´ì¦</div>
                        <div id="infoHealth" class="value">-</div>
                    </div>
                </div>

                <!-- 2ì¤„: ì‹œì‘ì¼(ê·¼ë¬´), ì‹œê¸‰, ê¸‰ì—¬ì§€ê¸‰ì¼, ì£¼íœ´ìˆ˜ë‹¹ ì ìš© -->
                <div class="info-grid mb-2">
                    <div class="info-item">
                        <div class="label">ì‹œì‘ì¼(ê·¼ë¬´)</div>
                        <div id="infoStartDate" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ì‹œê¸‰(ì›)</div>
                        <div id="infoHourlyWage" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ê¸‰ì—¬ì§€ê¸‰ì¼</div>
                        <div id="infoPayday" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ì£¼íœ´ìˆ˜ë‹¹ ì ìš©</div>
                        <div id="infoIncludeWeekly" class="value">-</div>
                    </div>
                </div>

                <!-- 3ì¤„: ì€í–‰, ê³„ì¢Œë²ˆí˜¸ -->
                <div class="info-grid">
                    <div class="info-item">
                        <div class="label">ì€í–‰</div>
                        <div id="infoBankName" class="value">-</div>
                    </div>
                    <div class="info-item">
                        <div class="label">ê³„ì¢Œë²ˆí˜¸</div>
                        <div id="infoBankAccount" class="value">-</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============ íŒ¨ë„ 3: íƒ­ + ìŠ¤ì¼€ì¤„ ============ -->
        <section class="panel tabs-panel mb-2 d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="view-tabs" id="viewTabsTop" role="group" aria-label="view switch">
                <button type="button" class="tab-pill" data-view="weekGrid">ì£¼ê°„í…œí”Œë¦¿</button>
                <button type="button" class="tab-pill" data-view="weekSummary">ì£¼ê°„ê·¼ë¬´ì‹œê°„</button>
                <button type="button" class="tab-pill" data-view="monthCalendar">ì›”ê°„ ê·¼ë¬´ì‹œê°„</button>
            </div>

            <!-- ì£¼ê°„ ë‚´ë¹„ (ì£¼ ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
            <div id="navWeek" class="nav-chips">
                <span class="chip-ghost">{{weekRangeLabel}}</span>
                <a class="chip-outline" id="btnWeekPrev" href="{{weekPrevUrl}}">â—€ ì´ì „ ì£¼</a>
                <a class="chip-outline" id="btnWeekNext" href="{{weekNextUrl}}">ë‹¤ìŒ ì£¼ â–¶</a>
            </div>

            <!-- ì›”ê°„ ë‚´ë¹„ (ì›” ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
            <div id="navMonth" class="nav-chips d-none">
                <span id="monthRangeLabel" class="chip-ghost">0000.00.01 ~ 00.00</span>
                <a class="chip-outline" id="btnMonthPrev" href="#">â—€ ì´ì „ ë‹¬</a>
                <a class="chip-outline" id="btnMonthThis" href="#">ì´ë²ˆ ë‹¬</a>
                <a class="chip-outline" id="btnMonthNext" href="#">ë‹¤ìŒ ë‹¬ â–¶</a>
                <span id="monthLabel" class="d-none">0000.00</span>
            </div>
        </section>

        <!-- ============ íŒ¨ë„ 4: ìŠ¤ì¼€ì¤„(ì£¼ê°„í…œí”Œë¦¿ / ìš”ì•½ / ì›”ê°„) ============ -->
        <section class="panel panel-schedule">
            <header class="panel-header d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">SCHEDULE</div>
                    <h3 class="title-md mb-0" id="selectedMemberTitle">ì£¼ê°„ í…œí”Œë¦¿ (ì›”~ì¼)</h3>
                </div>
                <div class="text-end">
                    <button type="button" id="btnSaveTemplate"
                            class="btn btn-sm btn-primary btn-save-template me-2"
                            disabled>
                        ì£¼ê°„ í…œí”Œë¦¿ ì €ì¥
                    </button>
                    <span id="selectedMemberStatus" class="status-chip d-none">-</span>
                    <div class="text-xs text-muted">
                        10ë¶„ ë‹¨ìœ„ Â· ì£¼ê°„ í…œí”Œë¦¿ ë·°ì—ì„œë§Œ ì €ì¥ ê°€ëŠ¥
                    </div>
                </div>

            </header>

            <div class="panel-body">

                <!-- ë·° 1: ì£¼ê°„ í…œí”Œë¦¿ ê·¸ë¦¬ë“œ (Member scheduleë§Œ) -->
                <div id="viewWeekGrid">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-xs text-muted">ìŠ¬ë¡¯ ë‹¨ìœ„</span>
                            <div class="btn-group btn-group-sm slot-btn-group" id="gridSlotButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„ ì„ íƒ">
                                <button type="button" class="btn btn-outline-secondary active" data-grid-slot="10">10ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary" data-grid-slot="60">1ì‹œê°„</button>
                            </div>
                        </div>
                        <div class="text-xs text-muted text-end">
                            ë§ˆìš°ìŠ¤ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ <strong>ì£¼ê°„ í…œí”Œë¦¿(ê³„íš)</strong>ì„ ì„¤ì •í•˜ì„¸ìš”.<br>
                            <span class="text-primary">ì„ íƒëœ ì…€ë§Œ ìƒ‰ì´ ì¹ í•´ì§€ê³ , ë‹¤ì‹œ í´ë¦­í•˜ë©´ í°ìƒ‰ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.</span>
                        </div>
                    </div>

                    <div class="schedule-board">
                        <div class="table-responsive schedule-table-wrap">
                            <table class="table schedule-table text-center" id="tableWeek10m">
                                <thead>
                                <tr id="theadWeek">
                                    <th class="time-col">ì‹œê°„</th>
                                    <th>ì›”</th>
                                    <th>í™”</th>
                                    <th>ìˆ˜</th>
                                    <th>ëª©</th>
                                    <th>ê¸ˆ</th>
                                    <th>í† </th>
                                    <th>ì¼</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeek10m"></tbody>
                            </table>
                        </div>
                        <div class="legend-row text-xs text-muted mt-2">
                            <span class="legend-box legend-plan"></span> ì„ íƒëœ í…œí”Œë¦¿ ì…€
                        </div>
                    </div>
                </div>

                <!-- ë·° 2: ì£¼ê°„ ê·¼ë¬´ì‹œê°„ ìš”ì•½ í‘œ (íƒ€ì„í…Œì´ë¸” ìˆ¨ê¹€ìš© ë˜í¼ë§Œ ìœ ì§€) -->
                <div id="viewWeekSummary" class="d-none">
                    <div class="summary-board">
                        <div class="table-responsive">
                            <table class="table summary-table" id="tableWeekSummary">
                                <thead>
                                <tr>
                                    <th style="width:110px;">ìš”ì¼</th>
                                    <th>ê³„íš ê·¼ë¬´ê¸°ê°„</th>
                                    <th>ì‹¤ ê·¼ë¬´ì‹œê°„</th>
                                    <th style="width:120px;" class="text-end">ì‹¤ í•©ê³„</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeekSummary"></tbody>
                                <tfoot>
                                <tr>
                                    <th>í•©ê³„(ê³„íš)</th>
                                    <td class="text-end fw-semibold" id="weekPlannedTotalCell">0ì‹œê°„</td>
                                    <td class="text-muted">ê³„íš ë¯¸ ë°˜ì˜</td>
                                    <th></th>
                                </tr>
                                <tr class="table-secondary">
                                    <th>í•©ê³„(ì‹¤ì œ)</th>
                                    <td></td>
                                    <td class="text-end fw-semibold" colspan="2" id="weekActualTotalCell">0ì‹œê°„</td>
                                </tr>
                                <tr>
                                    <th>ì‹œê¸‰</th>
                                    <td></td>
                                    <td class="text-end">ê¸°ì¤€ ì‹œê¸‰</td>
                                    <th class="text-end" id="hourlyWageCellW">-</th>
                                </tr>
                                <tr>
                                    <th>ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹</th>
                                    <td></td>
                                    <td class="text-end text-xs text-muted">ì‹¤ê·¼ë¬´ â‰¥ 15ì‹œê°„ì¸ ì£¼ì— í•œí•´<br>(ì£¼ê°„ ì‹¤ê·¼ë¬´ Ã· 5ì‹œê°„)</td>
                                    <th class="text-end" id="weekJuhyuPayCell">-</th>
                                </tr>
                                <tr class="table-secondary">
                                    <th>ì˜ˆìƒ ê¸‰ì—¬</th>
                                    <td></td>
                                    <td class="text-end">ì£¼ê°„ ì‹¤ê·¼ë¬´ + ì£¼íœ´ìˆ˜ë‹¹</td>
                                    <th class="text-end text-primary" id="weekPayCell">-</th>
                                </tr>
                                <tr>
                                    <th>ì‹¤ì œ-ê³„íš</th>
                                    <td></td>
                                    <td class="text-end">í”ŒëŸ¬ìŠ¤ë©´ ì´ˆê³¼ê·¼ë¬´</td>
                                    <th class="text-end" id="weekDeltaCell">0ë¶„</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ë·° 3: ì›”ê°„ ë‹¬ë ¥ (íƒ€ì„í…Œì´ë¸” ìˆ¨ê¹€ìš© ë˜í¼ë§Œ ìœ ì§€) -->
                <div id="viewMonthCalendar" class="d-none">
                    <div class="calendar-board">
                        <div class="calendar-grid" id="calendarGrid"></div>

                        <!-- ì›” í•©ê³„/ê¸‰ì—¬(+ì£¼íœ´) -->
                        <div class="month-summary mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="text-xs text-muted">ì›” í•©ê³„(ì‹¤ê·¼ë¬´)</div>
                                <div class="value" id="monthActualTotalCell">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="text-xs text-muted">ì‹œê¸‰</div>
                                <div class="value" id="hourlyWageCellM">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="text-xs text-muted">ì›” ì£¼íœ´ìˆ˜ë‹¹(ì£¼ë³„ í•©ì‚°)</div>
                                <div class="value" id="monthJuhyuPayCell">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="text-xs text-muted">ì›” ì˜ˆìƒ ê¸‰ì—¬(ì‹¤ê·¼ë¬´+ì£¼íœ´)</div>
                                <div class="value text-primary fw-semibold" id="monthPayCell">-</div>
                            </div>
                        </div>

                        <div class="text-xs text-muted mt-2">
                            â€¢ ë‚ ì§œ ì¹¸ì— ì‹¤ ê·¼ë¬´ êµ¬ê°„ ì¹©ê³¼ ì¼ í•©ê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
                            â€¢ ì›” ì£¼íœ´ìˆ˜ë‹¹ì€ í•´ë‹¹ ì›”ì— í¬í•¨ëœ ê° <strong>ì£¼(ì›”~ì¼)</strong>ì˜ ì‹¤ê·¼ë¬´ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •ë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </div>
</main>

<!-- ===== ë¹ˆ íŒì—…(ëª¨ë‹¬) ì¶”ê°€ ===== -->
<div class="modal fade" id="schedulePopup" tabindex="-1" aria-labelledby="schedulePopupTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedulePopupTitle">ê·¼ë¬´ì‹œê°„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body text-center text-muted py-5">
                í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                (ì£¼ê°„/ì›”ê°„ ê·¼ë¬´ì‹œê°„ íŒì—… ì˜ì—­ Â· ì¶”í›„ êµ¬í˜„ìš©)
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== ì „ì²´ ë°°ê²½/ë ˆì´ì•„ì›ƒ ===== */
    body {
        background:
                radial-gradient(circle at top left, #f5f7ff 0, #eef3ff 36%, transparent 70%),
                radial-gradient(circle at bottom right, #fef6f3 0, #ffe8da 40%, #ffe1f0 75%);
    }
    .schedule-shell {
        min-height: calc(100vh - 80px);
    }

    /* ì„¸ë¡œ í•œ ì¤„ ë ˆì´ì•„ì›ƒ */
    .schedule-layout {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .panel {
        border-radius: 18px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 18px 40px rgba(15,23,42,0.08);
        border: 1px solid rgba(148,163,184,0.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
    }

    .panel-header {
        padding: 1.1rem 1.3rem 0.7rem 1.3rem;
        border-bottom: 1px solid rgba(226,232,240,0.9);
    }
    .panel-header-compact {
        padding-bottom: 0.4rem;
    }
    .panel-body {
        padding: 0.9rem 1.3rem 1.2rem 1.3rem;
    }

    .card-info {
        border-radius: 18px;
    }
    .panel-schedule {
        border-radius: 18px;
    }
    .tabs-panel {
        border-radius: 18px;
        padding: 0.6rem 1rem;
        background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(237,242,255,0.9));
        border: 1px solid rgba(191,219,254,0.7);
    }

    .title-sm {
        font-size: 0.7rem;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: #9ca3af;
        font-weight: 600;
    }
    .title-lg {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }
    .title-md {
        font-size: 0.98rem;
        font-weight: 600;
        color: #111827;
    }
    .text-xs {
        font-size: 0.75rem;
    }

    .badge-soft {
        display:inline-flex;
        align-items:center;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: rgba(59,130,246,0.08);
        color:#2563eb;
        font-size: 0.7rem;
        font-weight: 600;
    }

    /* ===== íŒ¨ë„1: ìƒíƒœ ì„ íƒ + ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ í•œ ì¤„ ì •ë ¬ ===== */
    .filter-inline-row {
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap:1rem;
    }

    .filter-status-inline {
        flex:0 0 auto;
    }

    .status-select-inline {
        min-width: 130px;
        border-radius: 999px;
        border:1px solid rgba(148,163,184,0.7);
        font-size:0.85rem;
        padding-inline:0.9rem;
        padding-block:0.3rem;
        background-color:#f9fafb;
    }

    .filter-members-inline {
        min-width:0;
    }

    .badge-count {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        border-radius:999px;
        padding:0.18rem 0.65rem;
        background:#0f172a;
        color:#f9fafb;
        font-size:0.75rem;
        font-weight:600;
    }

    .vlist {
        display:flex;
        flex-wrap:wrap;
        gap: 8px;
    }
    .vlist-inline {
        align-items:center;
    }

    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:7px 11px;
        border-radius:999px;
        border:1px solid rgba(226,232,240,0.9);
        background:rgba(255,255,255,0.95);
        cursor:pointer;
        font-size:.85rem;
        transition: background .12s, box-shadow .12s, border-color .12s, transform .08s;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:2px solid rgba(255,255,255,0.9);
        box-shadow:0 0 0 1px rgba(148,163,184,0.65);
        flex:0 0 12px;
    }
    .pill .name { font-weight:600; color:#111827; }
    .pill .meta { color:#6b7280; font-size:.78rem; }
    .pill:hover {
        border-color: rgba(59,130,246,0.6);
        box-shadow: 0 10px 18px rgba(15,23,42,0.12);
        transform: translateY(-1px);
    }
    .pill.active {
        border-color: rgba(59,130,246,0.9);
        box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
        background:linear-gradient(120deg, #eff6ff, #e0f2fe);
    }

    /* ===== í”„ë¡œí•„ ì¹´ë“œ ===== */
    .name-pill {
        display:inline-flex;
        align-items:center;
        padding:0.2rem 0.7rem;
        border-radius:999px;
        background:#0f172a;
        color:#f9fafb;
        font-size:0.8rem;
    }
    .status-badge {
        display:inline-flex;
        align-items:center;
        padding:0.18rem 0.65rem;
        border-radius:999px;
        font-size:0.78rem;
        font-weight:600;
        background:#e5e7eb;
        color:#111827;
    }
    .btn-save-template {
        border-radius:999px;
        padding-inline:0.75rem;
        font-size:0.78rem;
    }
    .btn-save-template:disabled {
        opacity:.45;
        cursor:not-allowed;
    }

    .info-grid {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap:0.75rem 1rem;
    }
    .info-item .label {
        font-size:0.7rem;
        text-transform:uppercase;
        letter-spacing:.12em;
        color:#9ca3af;
        margin-bottom:0.15rem;
    }
    .info-item .value {
        font-size:0.9rem;
        font-weight:500;
        color:#111827;
    }

    /* ===== íƒ­ & ë„¤ë¹„ ===== */
    .view-tabs {
        display:flex;
        flex-wrap:wrap;
        gap:0.4rem;
    }
    .tab-pill {
        border-radius:999px;
        border:1px solid transparent;
        font-size:0.8rem;
        padding:0.32rem 0.9rem;
        background:transparent;
        color:#4b5563;
        font-weight:500;
        cursor:pointer;
        transition: all .12s;
    }
    .tab-pill:hover {
        background:rgba(255,255,255,0.7);
        border-color:rgba(148,163,184,0.6);
    }
    .tab-pill.active {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
        box-shadow:0 8px 16px rgba(15,23,42,0.35);
    }

    .nav-chips {
        display:flex;
        flex-wrap:wrap;
        gap:0.4rem;
        align-items:center;
    }
    .chip-ghost {
        padding:0.25rem 0.8rem;
        border-radius:999px;
        background:rgba(15,23,42,0.05);
        font-size:0.75rem;
        color:#374151;
    }
    .chip-outline {
        display:inline-flex;
        align-items:center;
        padding:0.22rem 0.7rem;
        border-radius:999px;
        border:1px solid rgba(148,163,184,0.7);
        font-size:0.75rem;
        color:#374151;
        text-decoration:none;
        background:rgba(255,255,255,0.9);
        transition:all .1s;
    }
    .chip-outline:hover {
        border-color:#2563eb;
        color:#1d4ed8;
        box-shadow:0 8px 16px rgba(37,99,235,0.15);
    }

    .status-chip {
        padding:0.18rem 0.7rem;
        border-radius:999px;
        font-size:0.78rem;
        font-weight:600;
        background:#e5e7eb;
        color:#111827;
    }

    /* ===== ì£¼ê°„ í…œí”Œë¦¿ ê·¸ë¦¬ë“œ ===== */
    .schedule-board {
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.9);
        padding:0.8rem;
        background:linear-gradient(135deg, rgba(248,250,252,0.9), rgba(239,246,255,0.95));
    }
    .schedule-table-wrap {
        max-height: 520px;
        overflow:auto;
    }
    .schedule-table {
        margin-bottom:0;
        border-collapse:separate;
        border-spacing:0;
        font-size:0.78rem;
    }
    .schedule-table thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: linear-gradient(135deg,#e5edff,#f9fafb);
        border-bottom:1px solid rgba(209,213,219,0.9);
        font-size:0.75rem;
        font-weight:600;
        color:#4b5563;
    }
    .schedule-table th, .schedule-table td {
        border:0;
        padding:2px 2px;
        vertical-align:middle;
    }
    .schedule-table .time-col {
        width:70px;
        font-variant-numeric:tabular-nums;
        font-size:0.7rem;
        color:#6b7280;
        background:rgba(15,23,42,0.04);
        position: sticky;
        left:0;
        z-index:2;
    }

    .cell-10m {
        height: 14px;
        border-radius: 4px;
        background: #ffffff;
        cursor: pointer;
        user-select: none;
        border:1px solid rgba(229,231,235,0.85);
        transition: background .08s, border-color .08s, box-shadow .08s, transform .04s;
    }
    .cell-10m:hover {
        box-shadow: 0 0 0 1px rgba(59,130,246,0.45);
        transform: translateY(-0.5px);
    }

    /* ì„ íƒëœ í…œí”Œë¦¿ ì…€ */
    .cell-10m.schedule-on {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
        box-shadow: 0 0 0 1px rgba(248,164,76,0.8);
    }

    tr.hour-start > td, tr.hour-start > th {
        border-top: 1px dashed rgba(148,163,184,0.5) !important;
    }

    .legend-row {
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-wrap:wrap;
    }
    .legend-box {
        display:inline-block;
        width:14px;
        height:14px;
        border-radius:4px;
        border:1px solid rgba(209,213,219,0.9);
        vertical-align:middle;
    }
    .legend-plan {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
    }

    .slot-btn-group .btn {
        border-radius:999px;
        font-size:0.76rem;
        padding-inline:0.6rem;
    }
    .slot-btn-group .btn.active {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
    }

    /* ===== ì£¼ê°„ ìš”ì•½/ì›”ê°„ íƒ€ì„í…Œì´ë¸” ìˆ¨ê¸°ê¸° ===== */
    #viewWeekSummary .summary-board,
    #viewMonthCalendar .calendar-board {
        display: none !important;
    }

    /* ===== ì£¼ê°„ ìš”ì•½ ===== */
    .summary-board {
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.9);
        padding:0.75rem;
        background:rgba(248,250,252,0.9);
    }
    .summary-table {
        font-size:0.8rem;
        margin-bottom:0;
    }
    .summary-table thead th {
        position:sticky;
        top:0;
        z-index:3;
        background:#e5edff;
        border-bottom:1px solid rgba(209,213,219,0.95);
        font-size:0.78rem;
        color:#374151;
    }

    /* ===== ì›”ê°„ ìº˜ë¦°ë” ===== */
    .calendar-board {
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.9);
        padding:0.75rem;
        background:linear-gradient(135deg, #f9fafb, #eef2ff);
    }
    .calendar-grid {
        display:grid;
        grid-template-columns:repeat(7, 1fr);
        gap:6px;
    }
    .calendar-grid .dow {
        text-align:center;
        font-weight:600;
        color:#6b7280;
        padding:4px 0;
        border-bottom:1px dashed rgba(209,213,219,0.9);
        position: sticky;
        top: 0;
        z-index: 5;
        background:rgba(248,250,252,0.98);
        font-size:0.78rem;
    }
    .calendar-grid .cell {
        border-radius:10px;
        padding:6px;
        min-height:100px;
        background:#ffffff;
        border:1px solid rgba(229,231,235,0.9);
        display:flex;
        flex-direction:column;
        gap:4px;
    }
    .cell .date-head {
        display:flex;
        align-items:center;
        justify-content:space-between;
        font-weight:600;
        font-size:.85rem;
        color:#111827;
    }
    .cell .dow-mini {
        color:#9ca3af;
        font-weight:500;
        font-size:.78rem;
    }
    .cell .segments {
        display:flex;
        flex-wrap:wrap;
        gap:4px;
    }
    .cell .day-total {
        margin-top:auto;
        text-align:right;
        font-size:.78rem;
        color:#111827;
    }
    .cell.muted {
        background:#f9fafb;
        color:#9ca3af;
    }
    .cell.today {
        outline:2px solid #22c55e;
        outline-offset:2px;
    }
    .chip {
        display:inline-flex;
        align-items:center;
        gap:4px;
        border:1px solid rgba(229,231,235,0.95);
        border-radius:999px;
        padding:2px 6px;
        background:#ffffff;
        font-size:0.72rem;
    }

    .month-summary .value {
        font-size:0.8rem;
        font-weight:500;
        color:#111827;
    }

    @media (max-width: 768px) {
        .filter-inline-row {
            flex-direction: column;
            align-items:flex-start;
        }
        .vlist {
            flex-direction: column;
        }
        .pill {
            width: 100%;
        }
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const HOUR_START = 6;
        const HOUR_END   = 22;
        const VIEW_PARAM = 'view';
        const VIEW_STORAGE_KEY = 'schedule:view';
        const DEFAULT_VIEW = 'weekGrid';

        const API_BASE_PLAN     = '/api/member';          // ì£¼ê°„ "í…œí”Œë¦¿" GET + POST(update)
        const API_BASE_ACTUAL   = '/api/schedule';        // ì£¼ê°„/ì›”ê°„ "ì‹¤ì œ" GET

        const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
        const DAY_CODES = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

        let schedulePopupInstance = null;

        // DOM
        const statusSelect      = document.getElementById('statusSelect');
        const memberList        = document.getElementById('memberList');
        const memberCountBadge  = document.getElementById('memberCountBadge');

        const statusBadge       = document.getElementById('statusBadge');
        const infoName          = document.getElementById('infoName');
        const infoGender        = document.getElementById('infoGender');
        const infoPhone         = document.getElementById('infoPhone');
        const infoEmail         = document.getElementById('infoEmail');
        const infoStartDate     = document.getElementById('infoStartDate');
        const infoHealth        = document.getElementById('infoHealth');
        const infoHourlyWage    = document.getElementById('infoHourlyWage');
        const infoBankName      = document.getElementById('infoBankName');
        const infoBankAccount   = document.getElementById('infoBankAccount');
        const createdAtLabel    = document.getElementById('createdAtLabel');
        const infoPayday        = document.getElementById('infoPayday');
        const infoIncludeWeekly = document.getElementById('infoIncludeWeekly');

        const tbodyWeek         = document.getElementById('tbodyWeek10m');
        const theadWeek         = document.getElementById('theadWeek');
        const selectedMemberTitle   = document.getElementById('selectedMemberTitle');
        const selectedMemberStatus  = document.getElementById('selectedMemberStatus');

        const weekRangeLabelEl  = document.getElementById('weekRangeLabel');

        const viewTabsTop       = document.getElementById('viewTabsTop');
        const navWeek           = document.getElementById('navWeek');
        const navMonth          = document.getElementById('navMonth');

        const tbodyWeekSummary  = document.getElementById('tbodyWeekSummary');
        const weekPlannedTotalCell = document.getElementById('weekPlannedTotalCell');
        const weekActualTotalCell  = document.getElementById('weekActualTotalCell');
        const weekDeltaCell     = document.getElementById('weekDeltaCell');
        const weekPayCell       = document.getElementById('weekPayCell');
        const weekJuhyuPayCell  = document.getElementById('weekJuhyuPayCell');
        const hourlyWageCellW   = document.getElementById('hourlyWageCellW');

        const calendarGrid      = document.getElementById('calendarGrid');
        const monthLabel        = document.getElementById('monthLabel');
        const monthRangeLabel   = document.getElementById('monthRangeLabel');
        const btnMonthPrev      = document.getElementById('btnMonthPrev');
        const btnMonthThis      = document.getElementById('btnMonthThis');
        const btnMonthNext      = document.getElementById('btnMonthNext');
        const monthActualTotalCell = document.getElementById('monthActualTotalCell');
        const monthJuhyuPayCell = document.getElementById('monthJuhyuPayCell');
        const monthPayCell      = document.getElementById('monthPayCell');
        const hourlyWageCellM   = document.getElementById('hourlyWageCellM');

        const viewWeekGrid      = document.getElementById('viewWeekGrid');
        const viewWeekSummary   = document.getElementById('viewWeekSummary');
        const viewMonthCalendar = document.getElementById('viewMonthCalendar');

        const gridSlotButtonsWrapper = document.getElementById('gridSlotButtons');
        const btnSaveTemplate        = document.getElementById('btnSaveTemplate');

        // ìƒíƒœ
        let currentMember      = null;
        let selectedMemberId   = null;
        let allMembers         = [];
        let gridStepMinutes    = 10;           // 10 / 30 / 60
        let currentWeekDates   = [];           // ["YYYY-MM-DD", ... 7ê°œ]
        let lastPlanMap        = {};           // GETëœ ê³„íš ë°ì´í„° ìºì‹œ (ì›ë³¸ í…œí”Œë¦¿)
        let lastActualMap      = {};           // GETëœ ì‹¤ì œ ë°ì´í„° ìºì‹œ

        // ë“œë˜ê·¸ ì„ íƒ ìƒíƒœ
        let gridDragging       = false;
        let gridDragAdding     = true;

        // ë©¤ë²„ ë°ì´í„° íŒŒì‹±
        try{
            allMembers = JSON.parse(document.getElementById('membersData').textContent||'[]');
        }catch(e){
            allMembers = [];
        }
        if(Array.isArray(allMembers) && allMembers.length>0){
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ˆê¸° ë·°
        const initialView = (() => {
            const url = new URL(window.location.href);
            return url.searchParams.get(VIEW_PARAM) || localStorage.getItem(VIEW_STORAGE_KEY) || DEFAULT_VIEW;
        })();
        setActiveTabButton(initialView);
        switchView(initialView);

        attachMonthHandlers();
        attachGridSlotHandlers();
        if (btnSaveTemplate) {
            btnSaveTemplate.addEventListener('click', onClickSaveTemplate);
        }

        viewTabsTop.addEventListener('click', (e)=>{
            const btn=e.target.closest('button[data-view]');
            if(!btn) return;
            const view=btn.dataset.view;
            setActiveTabButton(view);

            // ğŸ”¹ ì£¼ê°„ê·¼ë¬´ì‹œê°„ í´ë¦­ ì‹œ: íŒì—… ìƒˆ ì°½ìœ¼ë¡œ
            if (view === 'weekSummary') {
                openWeekSummaryPopupWindow();
                return;   // ì•„ë˜ switchView ë“±ì€ ì•ˆ íƒ€ê²Œ ì¢…ë£Œ (í˜ì´ì§€ ì•ˆ íƒ€ì„í…Œì´ë¸”ì€ ì•ˆì”€)
            }

            // ì›”ê°„ ê·¼ë¬´ì‹œê°„ë„ ê°™ì€ ë°©ì‹ìœ¼ë¡œ íŒì—… ì“°ë ¤ë©´ ì—¬ê¸°ì„œ openMonthPopupWindow() í˜¸ì¶œ
            if (view === 'monthCalendar') {
                openMonthSummaryPopupWindow();  // í•„ìš” ì‹œ êµ¬í˜„
                return;
            }

            switchView(view);
            const url=new URL(window.location.href);
            url.searchParams.set(VIEW_PARAM, view);
            window.history.replaceState({}, '', url.toString());
            try{ localStorage.setItem(VIEW_STORAGE_KEY, view); }catch(_){}
            updateSaveButtonByStep();
        });

        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        // ì‹œì‘
        handleStatusChange();
        updateSaveButtonByStep();

        // ===== ìƒíƒœ ë³€ê²½ ì‹œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
        function handleStatusChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            renderMemberList(filtered);

            if(filtered.length){
                const keep = filtered.find(m=>String(m.id)===String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            }else{
                selectedMemberId=null;
                clearRight();
                clearMemberInfo();
            }
        }

        function renderMemberList(members){
            memberList.innerHTML='';
            memberCountBadge.textContent=`${members.length}ëª…`;

            if(!members.length){
                memberList.innerHTML='<span class="text-xs text-muted">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const div=document.createElement('div');
                        div.className='pill';
                        div.dataset.memberId=String(m.id);
                        const color=colorForMember(m);
                        div.innerHTML=`
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        memberList.appendChild(div);
                    });

            updateMemberListActive();
        }

        async function onMemberListClick(e){
            const pill=e.target.closest('.pill');
            if(!pill) return;
            const id=pill.dataset.memberId;
            const m=(allMembers||[]).find(x=>String(x.id)===String(id));
            if(m) selectMember(m);
        }

        async function selectMember(member){
            currentMember=member;
            selectedMemberId=member.id;
            updateMemberListActive();
            await renderAll(member);
        }

        function updateMemberListActive(){
            Array.from(memberList.querySelectorAll('.pill')).forEach(p=>{
                p.classList.toggle('active', p.dataset.memberId===String(selectedMemberId));
            });
        }

        // ===== ë©¤ë²„ ì„ íƒ ì‹œ ì „ì²´ ë Œë” =====
        async function renderAll(member){
            if(!member) return;

            renderMemberInfo(member);
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member?.status || '-';
            selectedMemberStatus.className   = `status-chip ${statusClass(member?.status)}`;

            // ì£¼ê°„ ë²”ìœ„ íŒŒì‹±
            const { weekStartIso, weekEndIso, weekDates } = parseWeekRangeToDates(weekRangeLabelEl?.textContent || '');
            currentWeekDates = weekDates;
            renderWeekHeadDates(weekDates);

            // ê³„íš/ì‹¤ì œ ë°ì´í„° ë¡œë“œ
            lastPlanMap   = {};
            lastActualMap = {};

            try{
                const urlPlan = `${API_BASE_PLAN}/${encodeURIComponent(member.id)}/schedule`;
                const respPlan = await fetch(urlPlan, { headers:{'Accept':'application/json'} });
                if(respPlan.ok){
                    const data = await respPlan.json();
                    lastPlanMap = normalizeWeeklyTemplate(data, currentWeekDates);
                }
            }catch(e){
                console.error('plan fetch error', e);
            }

            try{
                const urlAct = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const respAct = await fetch(urlAct,{headers:{'Accept':'application/json'}});
                if(respAct.ok){
                    const data = await respAct.json();
                    lastActualMap = normalizeDays(data);
                }
            }catch(e){
                console.error('actual fetch error', e);
            }

            // í…œí”Œë¦¿ ê·¸ë¦¬ë“œ(ì£¼ê°„) ì¬êµ¬ì„± + ê³„íšë§Œ ì¹ í•˜ê¸°
            rebuildWeekGridAndPaint();

            // ì£¼ê°„ ìš”ì•½í‘œ (ê³„íš/ì‹¤ì œ ë‘˜ ë‹¤ ì‚¬ìš© - í™”ë©´ì—ì„œëŠ” ìˆ¨ê²¨ì§)
            await renderWeekSummary(member, weekDates, lastPlanMap, lastActualMap);

            // ì›”ê°„ ë‹¬ë ¥ (ì‹¤ì œ ê·¼ë¬´ - í™”ë©´ì—ì„œëŠ” ìˆ¨ê²¨ì§)
            const baseDate = parseIsoDate(weekStartIso);
            await renderMonthCalendar(member, baseDate);

            selectedMemberTitle.textContent = `${member.name ?? '-'} â€” ì£¼ê°„ í…œí”Œë¦¿`;
            const active = getActiveView();
            switchView(active);
            updateSaveButtonByStep();
        }

        function rebuildWeekGridAndPaint(){
            buildWeekGrid();
            paintPlanFromMap(lastPlanMap, currentWeekDates);
            attachCellDragHandlers(); // í…œí”Œë¦¿ ìˆ˜ì •ìš©
        }

        // ===== íƒ­/ë·° ì „í™˜ =====
        function setActiveTabButton(view){
            viewTabsTop.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            const btn=viewTabsTop.querySelector(`button[data-view="${view}"]`) || viewTabsTop.querySelector(`button[data-view="${DEFAULT_VIEW}"]`);
            if(btn) btn.classList.add('active');
        }
        function getActiveView(){
            const activeTab = viewTabsTop.querySelector('button.active');
            return activeTab?.dataset.view || DEFAULT_VIEW;
        }

        function switchView(view){
            const isWeek = (view==='weekGrid' || view==='weekSummary');
            navWeek.classList.toggle('d-none', !isWeek);
            navMonth.classList.toggle('d-none', view!=='monthCalendar');

            viewWeekGrid.classList.toggle('d-none', view!=='weekGrid');
            viewWeekSummary.classList.toggle('d-none', view!=='weekSummary');
            viewMonthCalendar.classList.toggle('d-none', view!=='monthCalendar');
        }

        function openMonthSummaryPopupWindow() {
            if (!currentMember || !currentWeekDates.length) {
                alert('ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ ë˜ëŠ” ì£¼ê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const memberId  = currentMember.id;        // í•„ìˆ˜
            const anchor    = currentWeekDates[0];     // ì˜ˆ: "2025-11-01"

            const url =
                    `/members/showworkmonthdashboardpopup` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&week=${encodeURIComponent(anchor)}` +
                    `&month=${encodeURIComponent(anchor)}`;

            window.open(
                    url,
                    'monthSummaryPopup',
                    'width=1600,height=800,scrollbars=yes,resizable=yes'
            );
        }


        function openWeekSummaryPopupWindow() {
            if (!currentMember || !currentWeekDates.length) {
                alert('ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ ë˜ëŠ” ì£¼ê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const memberId   = currentMember.id;
            const startDate  = currentWeekDates[0];      // "2025-11-01"
            const endDate    = currentWeekDates[6];      // "2025-11-07"

            const url =
                    `/members/showworktimedashboardpopup` +
                    `?memberId=${encodeURIComponent(memberId)}` +
                    `&startDate=${encodeURIComponent(startDate)}` +
                    `&endDate=${encodeURIComponent(endDate)}`;

            // ì‹¤ì œ íŒì—… ì˜¤í”ˆ
            window.open(
                    url,
                    'weekSummaryPopup',
                    'width=1600,height=800,scrollbars=yes,resizable=yes'
            );
        }

        // ===== ì›” ë‚´ë¹„: ë¦¬ë¡œë“œ ì—†ì´ ì‘ë™ =====
        function attachMonthHandlers(){
            if(btnMonthPrev){
                btnMonthPrev.addEventListener('click', (e)=>{
                    e.preventDefault();
                    navigateMonth(-1);
                });
            }
            if(btnMonthNext){
                btnMonthNext.addEventListener('click', (e)=>{
                    e.preventDefault();
                    navigateMonth(+1);
                });
            }
            if(btnMonthThis){
                btnMonthThis.addEventListener('click', (e)=>{
                    e.preventDefault();
                    const today = new Date();
                    const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    if(currentMember){
                        renderMonthCalendar(currentMember, thisMonth);
                    }
                });
            }
        }

        function navigateMonth(offset){
            const curStart = getCurrentMonthStart();
            const target = new Date(curStart.getFullYear(), curStart.getMonth()+offset, 1);
            if(currentMember){
                renderMonthCalendar(currentMember, target);
            }
        }

        // ===== ìŠ¬ë¡¯ ë‹¨ìœ„ ë²„íŠ¼ ì²˜ë¦¬ =====
        function attachGridSlotHandlers(){
            if(!gridSlotButtonsWrapper) return;
            gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const mins = parseInt(btn.dataset.gridSlot, 10);
                    if(!mins || mins === gridStepMinutes) return;

                    gridStepMinutes = mins;

                    gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');

                    // ê·¸ë¦¬ë“œ ì¬êµ¬ì„± + ë‹¤ì‹œ ì¹ í•˜ê¸° (ê³„íšë§Œ)
                    rebuildWeekGridAndPaint();
                    updateSaveButtonByStep();
                });
            });
        }

        function updateSaveButtonByStep(){
            if(!btnSaveTemplate) return;
            const isWeekGridView = (getActiveView() === 'weekGrid');
            const enable = (gridStepMinutes === 10 && !!currentMember && currentWeekDates.length && isWeekGridView);
            btnSaveTemplate.disabled = !enable;
            btnSaveTemplate.title = enable ? '' : 'í…œí”Œë¦¿ ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ Â· ì£¼ê°„ í…œí”Œë¦¿ ë³´ê¸°ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        }

        // ===== ì£¼ê°„ í…œí”Œë¦¿ ê·¸ë¦¬ë“œ =====
        function buildWeekGrid(){
            tbodyWeek.innerHTML='';
            const totalMinutes = (HOUR_END - HOUR_START) * 60;
            const totalRows = totalMinutes / gridStepMinutes;

            for(let idx=0; idx<totalRows; idx++){
                const absMin = HOUR_START*60 + idx*gridStepMinutes;
                const h = Math.floor(absMin/60), m = absMin%60;
                const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('hour-start');
                tr.innerHTML = `
                <th class="timecell time-col" scope="row">${hm}</th>
                <td data-col="1"><div class="cell-10m"></div></td>
                <td data-col="2"><div class="cell-10m"></div></td>
                <td data-col="3"><div class="cell-10m"></div></td>
                <td data-col="4"><div class="cell-10m"></div></td>
                <td data-col="5"><div class="cell-10m"></div></td>
                <td data-col="6"><div class="cell-10m"></div></td>
                <td data-col="7"><div class="cell-10m"></div></td>
            `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDates(weekDates){
            const ths = theadWeek.querySelectorAll('th');
            for(let i=0;i<7;i++){
                const th = ths[i+1];
                if(!th) continue;
                const d = new Date(weekDates[i]);
                th.innerHTML = `${DOW_LABELS[i]}<br><small class="text-muted">(${d.getMonth()+1}/${d.getDate()})</small>`;
            }
        }

        function rowToInterval(rIdx){
            const startMin = HOUR_START*60 + rIdx*gridStepMinutes;
            const endMin   = startMin + gridStepMinutes;
            return { startMin, endMin };
        }

        // ê³„íš ì¹ í•˜ê¸° (schedule-on)
        function paintPlanFromMap(planMap, weekDates){
            if(!tbodyWeek) return;

            // ì „ì²´ ì´ˆê¸°í™”
            tbodyWeek.querySelectorAll('.cell-10m').forEach(c=>{
                c.classList.remove('schedule-on');
            });

            if(!weekDates || !weekDates.length) return;
            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso = weekDates[dayIdx];
                const entry = planMap[iso];
                const segs = entry?.segments || [];
                if(!segs.length) continue;

                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const { startMin, endMin } = rowToInterval(rIdx);

                    const overlaps = segs.some(seg=>{
                        const ss = hmToMin(seg.start);
                        const ee = hmToMin(seg.end);
                        return !(ee <= startMin || ss >= endMin);
                    });
                    if(overlaps){
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        // ===== ë“œë˜ê·¸/í´ë¦­ìœ¼ë¡œ í…œí”Œë¦¿ ì„ íƒ/í•´ì œ (ì´ë²¤íŠ¸ ìœ„ì„, ë‹¨ìˆœ í† ê¸€) =====
        let cellDragHandlersBound = false;

        function attachCellDragHandlers(){
            if (!tbodyWeek || cellDragHandlersBound) return;
            cellDragHandlersBound = true;

            // 1) ë§ˆìš°ìŠ¤ë¥¼ ëˆ„ë¥´ëŠ” ì‹œì ì—: ê¸°ì¤€ ìƒíƒœë¥¼ ì •í•˜ê³  ë°”ë¡œ í† ê¸€ + ë“œë˜ê·¸ ì‹œì‘
            tbodyWeek.addEventListener('mousedown', (e)=>{
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                e.preventDefault();          // í…ìŠ¤íŠ¸ ë“œë˜ê·¸ ë°©ì§€
                gridDragging = true;

                const nowOn  = cell.classList.contains('schedule-on');
                const nextOn = !nowOn;       // í˜„ì¬ì˜ ë°˜ëŒ€ë¡œ í† ê¸€
                gridDragAdding = nextOn;     // ë“œë˜ê·¸ ì¤‘ì—ëŠ” ì´ ìƒíƒœë¡œ ìœ ì§€

                togglePlanCell(cell, nextOn);
            });

            // 2) ë“œë˜ê·¸ ìƒíƒœì—ì„œ ë‹¤ë¥¸ ì…€ ìœ„ë¡œ ì´ë™í•  ë•Œ: ë™ì¼ ìƒíƒœë¡œ ì¹ í•˜ê¸°
            tbodyWeek.addEventListener('mouseover', (e)=>{
                if (!gridDragging) return;

                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                togglePlanCell(cell, gridDragAdding);
            });

            // 3) ë§ˆìš°ìŠ¤ ë²„íŠ¼ì„ ë–¼ë©´ ë“œë˜ê·¸ ì¢…ë£Œ
            window.addEventListener('mouseup', ()=>{
                if (gridDragging){
                    gridDragging = false;
                }
            }, { passive:true });
        }

        // ì„ íƒ í† ê¸€: onì´ë©´ ì£¼í™©ìƒ‰, offë©´ í°ìƒ‰
        function togglePlanCell(cell, on){
            if(on){
                cell.classList.add('schedule-on');
            }else{
                cell.classList.remove('schedule-on');
            }
        }

        async function onClickSaveTemplate(){
            if(gridStepMinutes !== 10){
                alert('í…œí”Œë¦¿ ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìŠ¬ë¡¯ ë‹¨ìœ„ë¥¼ 10ë¶„ìœ¼ë¡œ ë³€ê²½í•´ ì£¼ì„¸ìš”.');
                return;
            }
            if(!currentMember || !currentWeekDates.length){
                alert('ì €ì¥í•  ì•„ë¥´ë°”ì´íŠ¸ì™€ ì£¼ê°„ ë²”ìœ„ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const byDate = collectPlanSegmentsFromGrid();

            const summaryLines = currentWeekDates.map((iso, idx)=>{
                const label = `${DOW_LABELS[idx]} (${iso})`;
                const segs  = byDate[iso] || [];
                if(!segs.length) return `${label}: íœ´ë¬´`;
                return `${label}: ${segs.map(s=>`${s.start}~${s.end}`).join(', ')}`;
            });

            const ok = confirm(
                    `ë‹¤ìŒê³¼ ê°™ì´ ì£¼ê°„ í…œí”Œë¦¿(ê³„íš)ì„ ì €ì¥í•©ë‹ˆë‹¤:\n\n`+
                    summaryLines.join('\n')+
                    `\n\nì´ëŒ€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
            );
            if(!ok) return;

            try{
                // index ë¥¼ ì¨ì•¼ DAY_CODES[idx] ë¥¼ ì“¸ ìˆ˜ ìˆìŒ
                for(let idx = 0; idx < currentWeekDates.length; idx++){
                    const iso = currentWeekDates[idx];          // "2025-11-10" ê°™ì€ ê°’
                    const dayCode = DAY_CODES[idx];             // "MON" ~ "SUN"
                    const segments = byDate[iso] || [];

                    const payload = {
                        memberId: currentMember.id,
                        day: dayCode,           // ìš”ì¼ ì½”ë“œë¡œ ì „ì†¡
                        segments: segments      // [{start:"11:00", end:"14:00"}, ...]
                    };

                    const url = `${API_BASE_PLAN}/${encodeURIComponent(currentMember.id)}/update`;
                    console.log('SAVE TEMPLATE URL:', url, 'payload:', payload);

                    const resp = await fetch(url, {
                        method:'POST',
                        headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if(!resp.ok){
                        const txt = await resp.text().catch(()=> '');
                        alert(`ì €ì¥ ì‹¤íŒ¨ (${iso}): ${resp.status} ${txt}`);
                        return;
                    }
                }

                alert('ì£¼ê°„ í…œí”Œë¦¿(ê³„íš)ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await renderAll(currentMember);   // ì €ì¥ í›„ ë‹¤ì‹œ ë¡œë”©
            }catch(e){
                console.error('í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜ˆì™¸:', e);
                alert('í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e.message || e));
            }
        }

        function collectPlanSegmentsFromGrid(){
            const result = {};
            if(!currentWeekDates.length || !tbodyWeek) return result;

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));
            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const indices = [];
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(cellDiv && cellDiv.classList.contains('schedule-on')){
                        indices.push(rIdx);
                    }
                });
                if(!indices.length) continue;

                const merged = mergeConsecutive(indices);
                const iso    = currentWeekDates[dayIdx];
                result[iso] = merged.map(([sIdx, eIdx])=>{
                    const startMin = HOUR_START*60 + sIdx*gridStepMinutes;
                    const endMin   = HOUR_START*60 + (eIdx+1)*gridStepMinutes;
                    return { start: minToHm(startMin), end: minToHm(endMin) };
                });
            }
            return result;
        }

        function mergeConsecutive(arr){
            if(!arr.length) return [];
            const sorted = arr.slice().sort((a,b)=>a-b);
            const out = [];
            let s = sorted[0], prev = sorted[0];
            for(let i=1;i<sorted.length;i++){
                const v = sorted[i];
                if(v === prev+1){
                    prev = v;
                    continue;
                }
                out.push([s, prev]);
                s = prev = v;
            }
            out.push([s, prev]);
            return out;
        }

        // ===== ì£¼ê°„ ìš”ì•½ (ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹ í¬í•¨) =====
        async function renderWeekSummary(member, weekDates, planMap, actualMap){
            const DOW_KO = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

            let wPlanned = 0, wActual = 0;
            const rows = [];

            for(let i=0;i<7;i++){
                const d = new Date(weekDates[i]);
                const iso = weekDates[i];

                const p = planMap[iso] || {segments:[], minutes:0};
                const a = actualMap[iso] || {segments:[], minutes:0};

                wPlanned += (p.minutes||0);
                wActual  += (a.minutes||0);

                const chipsPlanned = p.segments.length
                        ? p.segments.map(s=>chipHtml('#ff9f43', s.start, s.end)).join(' ')
                        : '<span class="text-muted text-xs">â€”</span>';
                const chipsActual = a.segments.length
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted text-xs">â€”</span>';

                rows.push(`
                <tr>
                    <th scope="row">${DOW_KO[d.getDay()]}</th>
                    <td>${chipsPlanned}</td>
                    <td>${chipsActual}</td>
                    <td class="text-end">${formatMins(a.minutes||0)}</td>
                </tr>
            `);
            }

            if(tbodyWeekSummary){
                tbodyWeekSummary.innerHTML = rows.join('');
            }
            if(weekPlannedTotalCell) weekPlannedTotalCell.textContent = formatMins(wPlanned);
            if(weekActualTotalCell)  weekActualTotalCell.textContent  = formatMins(wActual);
            if(weekDeltaCell)        weekDeltaCell.textContent        = deltaString(wActual - wPlanned);

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            if(hourlyWageCellW){
                hourlyWageCellW.textContent = (wage!=null) ? krw(wage) : '-';
            }

            const juhyuMinutesWeek = calcWeeklyJuhyuMinutes(wActual);
            const juhyuPayWeek = (wage!=null) ? Math.round((juhyuMinutesWeek/60)*wage) : null;
            if(weekJuhyuPayCell){
                weekJuhyuPayCell.textContent = (juhyuPayWeek!=null) ? krw(juhyuPayWeek) : '-';
            }

            const basePayWeek = (wage!=null) ? Math.round((wActual/60)*wage) : null;
            const totalPayWeek = (basePayWeek!=null && juhyuPayWeek!=null) ? basePayWeek + juhyuPayWeek : null;
            if(weekPayCell){
                weekPayCell.textContent = (totalPayWeek!=null) ? krw(totalPayWeek) : '-';
            }
        }

        // ===== ì›”ê°„ ë‹¬ë ¥ (ì‹¤ì œ ê·¼ë¬´ + ì£¼ë³„ ì£¼íœ´ìˆ˜ë‹¹ í•©ì‚°) =====
        async function renderMonthCalendar(member, baseDate){
            const ms = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
            const me = new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 0);
            const monthStartIso = toIso(ms), monthEndIso = toIso(me);

            if(monthLabel){
                monthLabel.textContent = `${ms.getFullYear()}.${String(ms.getMonth()+1).padStart(2,'0')}`;
                monthLabel.dataset.monthStart = monthStartIso;
            }

            const leftY = ms.getFullYear();
            const leftM = String(ms.getMonth()+1).padStart(2,'0');
            const leftD = '01';
            const rightM = String(me.getMonth()+1).padStart(2,'0');
            const rightD = String(me.getDate()).padStart(2,'0');
            if(monthRangeLabel){
                monthRangeLabel.textContent = `${leftY}.${leftM}.${leftD} ~ ${rightM}.${rightD}`;
            }

            let actualMap = {};
            try {
                const url = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (resp.ok) { actualMap = normalizeDays(await resp.json()); }
            } catch (e) { console.error(e); }

            if(calendarGrid){
                calendarGrid.innerHTML = '';
            }
            const DOW_HEAD = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            if(calendarGrid){
                DOW_HEAD.forEach(label=>{
                    const h = document.createElement('div');
                    h.className = 'dow';
                    h.textContent = label;
                    calendarGrid.appendChild(h);
                });
            }

            const todayIso = toIso(new Date());
            const firstDow = ms.getDay();
            if(calendarGrid){
                for (let i=0;i<firstDow;i++){
                    const blank = document.createElement('div');
                    blank.className = 'cell muted';
                    calendarGrid.appendChild(blank);
                }
            }

            let monthMinutes = 0;
            const weeklyMinutesMap = {};

            for (let d = new Date(ms); d <= me; d.setDate(d.getDate()+1)) {
                const iso = toIso(d);
                const dow = d.getDay();
                const a = actualMap[iso] || {segments:[], minutes:0};
                const dayMinutes = a.minutes || 0;
                monthMinutes += dayMinutes;

                if (dayMinutes > 0){
                    const weekStartIsoDate = toMonday(d);
                    const weekIso = toIso(weekStartIsoDate);
                    weeklyMinutesMap[weekIso] = (weeklyMinutesMap[weekIso] || 0) + dayMinutes;
                }

                if(calendarGrid){
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (iso === todayIso) cell.classList.add('today');

                    const chipsHtml = (a.segments?.length)
                            ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                            : '<span class="text-muted text-xs">â€”</span>';

                    cell.innerHTML = `
                    <div class="date-head">
                        <span>${d.getDate()}ì¼</span>
                        <span class="dow-mini">${DOW_HEAD[dow]}</span>
                    </div>
                    <div class="segments">${chipsHtml}</div>
                    <div class="day-total">${formatMins(dayMinutes)}</div>
                `;
                    calendarGrid.appendChild(cell);
                }
            }

            let monthJuhyuMinutes = 0;
            Object.values(weeklyMinutesMap).forEach(weekMinutes=>{
                monthJuhyuMinutes += calcWeeklyJuhyuMinutes(weekMinutes);
            });

            if(monthActualTotalCell){
                monthActualTotalCell.textContent = formatMins(monthMinutes);
            }
            const wage = (typeof member?.hourlyWage==='number') ? member?.hourlyWage : null;
            if(hourlyWageCellM){
                hourlyWageCellM.textContent = (wage!=null) ? krw(wage) : '-';
            }

            let basePay = null, juhyuPay = null, totalPay = null;
            if (wage != null){
                basePay = Math.round((monthMinutes/60)*wage);
                juhyuPay = Math.round((monthJuhyuMinutes/60)*wage);
                totalPay = basePay + juhyuPay;
            }

            if(monthJuhyuPayCell){
                monthJuhyuPayCell.textContent = (juhyuPay!=null) ? krw(juhyuPay) : '-';
            }
            if(monthPayCell){
                monthPayCell.textContent      = (totalPay!=null) ? krw(totalPay) : '-';
            }
        }

        function getCurrentMonthStart(){
            const ds = monthLabel?.dataset?.monthStart;
            if(ds && /^\d{4}-\d{2}-\d{2}$/.test(ds)) return parseIsoDate(ds);
            const t = new Date();
            return new Date(t.getFullYear(), t.getMonth(), 1);
        }

        // ===== Info/Utils =====
        function renderMemberInfo(m){
            infoName.textContent      = m.name ?? '-';
            infoGender.textContent    = m.gender ?? '-';
            infoPhone.textContent     = m.phone ?? '-';
            infoEmail.textContent     = m.email ?? '-';
            infoStartDate.textContent = m.startDate ?? '-';
            infoHealth.textContent = m.hasHealthCertificate
                    ? (m.healthCertExpiry ? `ë³´ìœ  (ìœ íš¨ê¸°ê°„: ${m.healthCertExpiry})` : 'ë³´ìœ ')
                    : 'ë¯¸ë³´ìœ ';
            infoHourlyWage.textContent = (typeof m.hourlyWage==='number') ? krw(m.hourlyWage) : '-';

            infoPayday.textContent        = formatPayday(m.payday);
            infoIncludeWeekly.textContent = yesNoLabel(m.includeWeeklyHolidayAllowance);

            infoBankName.textContent    = m.bankName ?? '-';
            infoBankAccount.textContent = m.bankAccount ?? '-';

            const created = getCreatedAt(m);
            const createdStr = created ? formatYmdHm(created) : '-';
            createdAtLabel.textContent  = `(ë“±ë¡ì¼: ${createdStr})`;

            statusBadge.textContent = m.status || '-';
            statusBadge.className   = `status-badge ${statusClass(m.status)}`;
        }

        function clearMemberInfo(){
            infoName.textContent          = '-';
            infoGender.textContent        = '-';
            infoPhone.textContent         = '-';
            infoEmail.textContent         = '-';
            infoStartDate.textContent     = '-';
            infoHealth.textContent        = '-';
            infoHourlyWage.textContent    = '-';
            infoPayday.textContent        = '-';
            infoIncludeWeekly.textContent = '-';
            infoBankName.textContent      = '-';
            infoBankAccount.textContent   = '-';
            createdAtLabel.textContent    = '(ë“±ë¡ì¼: -)';
            statusBadge.textContent       = '-';
            statusBadge.className         = 'status-badge';
        }

        function clearRight(){
            selectedMemberTitle.textContent   = 'ì£¼ê°„ í…œí”Œë¦¿ (ì›”~ì¼)';
            selectedMemberStatus.textContent  = '-';
            selectedMemberStatus.className    = 'status-chip d-none';

            tbodyWeek.innerHTML               = '';
            if(tbodyWeekSummary) tbodyWeekSummary.innerHTML        = '';
            if(calendarGrid) calendarGrid.innerHTML            = '';

            if(weekPlannedTotalCell) weekPlannedTotalCell.textContent  = '0ì‹œê°„';
            if(weekActualTotalCell)  weekActualTotalCell.textContent   = '0ì‹œê°„';
            if(weekDeltaCell)        weekDeltaCell.textContent         = '0ë¶„';
            if(weekPayCell)          weekPayCell.textContent           = '-';
            if(weekJuhyuPayCell)     weekJuhyuPayCell.textContent      = '-';
            if(hourlyWageCellW)      hourlyWageCellW.textContent       = '-';

            if(monthActualTotalCell) monthActualTotalCell.textContent  = '0ì‹œê°„';
            if(monthJuhyuPayCell)    monthJuhyuPayCell.textContent     = '-';
            if(monthPayCell)         monthPayCell.textContent          = '-';
            if(hourlyWageCellM)      hourlyWageCellM.textContent       = '-';
            if(monthRangeLabel)      monthRangeLabel.textContent       = '0000.00.01 ~ 00.00';

            currentWeekDates = [];
            lastPlanMap = {};
            lastActualMap = {};
            updateSaveButtonByStep();
        }

        function hmToMin(hm){
            const [h,m]=String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60+(m||0);
        }

        function parseWeekRangeToDates(label){
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            let start;
            if(m){ start = new Date(+m[1], +m[2]-1, +m[3]); }
            else { const today = new Date(); start = toMonday(today); }
            const weekDates = Array.from({length:7}, (_,i)=>toIso(addDays(start,i)));
            return { weekStartIso: weekDates[0], weekEndIso: weekDates[6], weekDates };
        }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const off=(d.getDay()+6)%7;
            d.setDate(d.getDate()-off);
            return d;
        }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function parseIsoDate(iso){ const [y,m,d]=iso.split('-').map(n=>parseInt(n,10)); return new Date(y,m-1,d); }

        function formatMins(mins){
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60), m=v%60;
            return m===0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }
        function deltaString(min){
            const sign = min>0?'+':min<0?'-':'';
            const v=Math.abs(min);
            const h=Math.floor(v/60), m=v%60;
            return `${sign}${h}ì‹œê°„${m?` ${m}ë¶„`:''}`;
        }
        function krw(v){
            return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v);
        }

        function normalizeDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        // /member/{id}/schedule â†’ [{day:"MON",start:"06:50:00",end:"10:00:00"}, ...]
        function normalizeWeeklyTemplate(apiRows, weekDates){
            const map = {};
            const arr = Array.isArray(apiRows) ? apiRows : [];

            // weekDates ì•ˆì „ì¥ì¹˜
            const dates = Array.isArray(weekDates) ? weekDates : [];
            const dayOrder = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

            // 1) ìš”ì¼ë³„ë¡œ segment ë¬¶ê¸°
            const byDayCode = {};   // ex) { MON: [{start,end}, ...], TUE: [...], ... }

            arr.forEach(row => {
                const dayCode = String(row.day || '').toUpperCase();  // "MON" / "TUE" / ...
                if(!dayCode) return;

                if(!byDayCode[dayCode]) {
                    byDayCode[dayCode] = [];
                }

                // "06:50:00" -> "06:50"
                const startHm = (row.start || '').slice(0,5);
                const endHm   = (row.end   || '').slice(0,5);

                byDayCode[dayCode].push({
                    start: startHm,
                    end: endHm
                });
            });

            // 2) í˜„ì¬ ì£¼(weekDates: [ì›”~ì¼]) ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œë³„ map êµ¬ì„±
            dates.forEach((iso, idx) => {
                const dayCode = dayOrder[idx];   // ì›”~ì¼ ë§¤í•‘
                const segs    = byDayCode[dayCode] || [];

                const minutes = segs.reduce((acc, s) => {
                    return acc + diffMinutes(s.start, s.end);
                }, 0);

                map[iso] = {
                    segments: segs,
                    minutes: minutes
                };
            });

            return map;
        }

        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }

        function calcWeeklyJuhyuMinutes(weeklyMinutes){
            if(!weeklyMinutes || weeklyMinutes < 15*60) return 0;
            return Math.round(weeklyMinutes / 5);
        }

        function chipHtml(color, start, end){
            return `<span class="chip"><span class="legend-box" style="background:${color};border-color:${color}"></span><span>${start} ~ ${end}</span></span>`;
        }
        function statusClass(s){
            const map = {
                WORKING:'bg-success text-white',
                WAITING:'bg-secondary text-white',
                RESTING:'bg-info text-white',
                PAUSED:'bg-warning text-dark',
                RESIGNED:'bg-danger text-white'
            };
            return map[s] || '';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        function getCreatedAt(m){
            const v = m?.created_at ?? m?.createdAt ?? null;
            if(v==null) return null;
            if(typeof v === 'number'){
                const ms = v < 1e12 ? v * 1000 : v;
                const d = new Date(ms);
                return isNaN(d.getTime()) ? null : d;
            }
            if(typeof v === 'string'){
                const d = new Date(v);
                return isNaN(d.getTime()) ? null : d;
            }
            return null;
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function formatYmdHm(d){
            const y=d.getFullYear();
            const M=pad2(d.getMonth()+1);
            const D=pad2(d.getDate());
            const h=pad2(d.getHours());
            const m=pad2(d.getMinutes());
            return `${y}-${M}-${D} ${h}:${m}`;
        }

        function minToHm(min){
            const h = Math.floor(min/60);
            const m = min%60;
            return `${pad2(h)}:${pad2(m)}`;
        }

        function formatPayday(code){
            if(code == null || String(code).trim() === '') return '-';
            if(String(code).toUpperCase() === 'EOM') return 'ë§ì¼';
            const n = parseInt(code, 10);
            return isNaN(n) ? String(code) : `${n}ì¼`;
        }
        function yesNoLabel(v){
            return Boolean(v) ? 'ì ìš©' : 'ë¯¸ì ìš©';
        }

    })();
</script>

{{>layouts/footer}}
