{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ 왼쪽: 상태/알바생 선택 + 정보(기존 그대로) ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <!-- 상태/알바생 선택 -->
                <div class="card">
                    <div class="card-header fw-bold">아르바이트 선택</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-12">
                                <label class="form-label small text-muted" for="statusSelect">상태</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>근무중</option>
                                    <option value="WAITING">시작전</option>
                                    <option value="RESTING">휴식중</option>
                                    <option value="PAUSED">일시중지</option>
                                    <option value="RESIGNED">퇴사</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted">알바생</label>
                                <div class="input-group">
                                    <select id="memberSelect" class="form-select">
                                        <option value="">상태를 선택하세요</option>
                                    </select>
                                    <button id="detailBtn" class="btn btn-primary" type="button" disabled>정보 수정</button>
                                </div>
                                <div class="form-text">상태를 선택하면 해당 상태의 알바생이 표시됩니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 알바생 정보 -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>아르바이트 정보</span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6"><div class="text-muted">이름</div><div id="infoName" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">성별</div><div id="infoGender" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">전화번호</div><div id="infoPhone" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">이메일</div><div id="infoEmail" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">시작일</div><div id="infoStartDate" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">보건증</div><div id="infoHealth" class="fw-semibold">-</div></div>
                            <div class="col-12"><div class="text-muted">시급(원)</div><div id="infoHourlyWage" class="fw-semibold">-</div></div>
                        </div>
                    </div>
                </div>

                <!-- 간단 범례 -->
                <div class="card">
                    <div class="card-body d-flex gap-3 align-items-center">
                        <span class="legend legend-plan"></span><span class="small">계획</span>
                        <span class="legend legend-actual"></span><span class="small">실제</span>
                        <span class="legend legend-both"></span><span class="small">둘 다</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ 오른쪽: 주간 10분 단위 타임테이블 ============ -->
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span id="selectedMemberTitle">주간 10분 단위 타임테이블 (월~일)</span>
                    <div class="small text-muted">
                        <span id="weekRangeLabel">{{weekRangeLabel}}</span>
                        <a class="ms-2 btn btn-sm btn-outline-secondary" href="{{weekPrevUrl}}">◀ 이전 주</a>
                        <a class="ms-1 btn btn-sm btn-outline-secondary" href="{{weekNextUrl}}">다음 주 ▶</a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center timetable-week-10m mb-2" id="tableWeek10m">
                            <thead>
                            <tr id="theadWeek">
                                <th style="width:80px;">시간</th>
                                <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
                            </tr>
                            </thead>
                            <tbody id="tbodyWeek10m"></tbody>
                        </table>
                    </div>
                    <div class="small text-muted mt-1">
                        * 10분 단위로 칠해집니다. <span class="legend legend-plan"></span> 계획, <span class="legend legend-actual"></span> 실제, <span class="legend legend-both"></span> 겹치면 진한 표시.
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    /* 셀(10분 슬롯) 기본 */
    .cell-10m {
        height: 16px;
        border: 1px solid #eef2f6;
        border-radius: 3px;
        background: #fff;
    }
    /* 계획만 */
    .cell-10m.schedule-on {
        background: rgba(255,159,67,.28);            /* 주황 */
        border-color: rgba(255,159,67,.55);
    }
    /* 실제만 */
    .cell-10m.actual-on {
        background: rgba(25,135,84,.22);             /* 초록 */
        border-color: rgba(25,135,84,.35);
    }
    /* 계획+실제 겹침 */
    .cell-10m.schedule-on.actual-on {
        background:
                linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%);
        border-color: rgba(25,135,84,.5);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,.25);
    }
    /* 매 시 정각 라인 강조 */
    tr.hour-start > td, tr.hour-start > th {
        border-top: 2px solid #dee2e6 !important;
    }
    .timecell { font-variant-numeric: tabular-nums; }

    /* 범례 */
    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(255,159,67,.35); border-color: rgba(255,159,67,.65); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.4); }
    .legend-both { background:
            linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%);
        border-color: rgba(25,135,84,.5);
    }
</style>

<!-- 컨트롤러에서 내려준 JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        // ===== Constants & DOM =====
        const HOUR_START=6, HOUR_END=22, STEP_MIN=10, SLOTS_PER_HOUR=60/STEP_MIN; // 6
        const tbodyWeek=document.getElementById('tbodyWeek10m');
        const theadWeek=document.getElementById('theadWeek');
        const selectedMemberTitle=document.getElementById('selectedMemberTitle');

        const statusSelect=document.getElementById('statusSelect');
        const memberSelect=document.getElementById('memberSelect');
        const detailBtn=document.getElementById('detailBtn');

        const statusBadge=document.getElementById('statusBadge');
        const infoName=document.getElementById('infoName');
        const infoGender=document.getElementById('infoGender');
        const infoPhone=document.getElementById('infoPhone');
        const infoEmail=document.getElementById('infoEmail');
        const infoStartDate=document.getElementById('infoStartDate');
        const infoHealth=document.getElementById('infoHealth');
        const infoHourlyWage=document.getElementById('infoHourlyWage');

        const weekRangeLabelEl=document.getElementById('weekRangeLabel');

        let allMembers=[];
        try{ allMembers=JSON.parse(document.getElementById('membersData').textContent||'[]'); }catch(e){ allMembers=[]; }

        // 초기 상태 보정
        if(Array.isArray(allMembers)&&allMembers.length>0){
            statusSelect.value=allMembers[0].status||'WORKING';
        }

        // 이벤트
        statusSelect.addEventListener('change', handleStatusChange);
        memberSelect.addEventListener('change', handleMemberChange);
        detailBtn.addEventListener('click', openEdit);

        // 시작
        handleStatusChange();

        // ===== Handlers =====
        function handleStatusChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);

            memberSelect.innerHTML='';
            detailBtn.disabled=true;

            if(!filtered.length){
                memberSelect.innerHTML='<option value="">해당 상태의 알바생이 없습니다</option>';
                clearRight();
                return;
            }
            memberSelect.appendChild(new Option('알바생을 선택하세요',''));
            filtered.forEach(m=>memberSelect.appendChild(new Option(`${m.name ?? '-'} (${m.gender ?? '-'})`, String(m.id))));
            memberSelect.value=String(filtered[0].id);
            detailBtn.disabled=false;
            renderAll(filtered[0]);
        }

        function handleMemberChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            const id = Number(memberSelect.value);
            const m = filtered.find(x=>x.id===id);
            detailBtn.disabled=!m;
            if(m) renderAll(m); else clearRight();
        }

        async function renderAll(member){
            renderMemberInfo(member);

            // 주 시작/끝 계산
            const { weekStartIso, weekEndIso, weekDates } = parseWeekRangeToDates(weekRangeLabelEl?.textContent || '');
            renderWeekHeadDates(weekDates);

            // 테이블 골격(96행 × 7컬럼) 생성
            buildWeekGrid10m();

            // 계획 표시
            paintPlan(member, weekDates);

            // 실제 표시 (주간 API)
            try{
                const url=`/api/schedule/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const resp=await fetch(url,{headers:{'Accept':'application/json'}});
                if(resp.ok){
                    const data=await resp.json();
                    paintActualFromApi(data, weekDates);
                }
            }catch(e){ console.error(e); }

            selectedMemberTitle.textContent = `${member.name ?? '-'} — 주간(10분 단위)`;
        }

        // ===== Build & Paint =====
        function buildWeekGrid10m(){
            tbodyWeek.innerHTML='';
            const totalRows = (HOUR_END - HOUR_START) * SLOTS_PER_HOUR; // 16*6=96
            for(let idx=0; idx<totalRows; idx++){
                const minutesFromStart = idx * STEP_MIN;
                const absMin = HOUR_START*60 + minutesFromStart;
                const h = Math.floor(absMin/60), m = absMin%60;
                const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('hour-start');
                tr.innerHTML = `
          <th class="timecell" scope="row">${hm}</th>
          <td data-col="1"><div class="cell-10m"></div></td>
          <td data-col="2"><div class="cell-10m"></div></td>
          <td data-col="3"><div class="cell-10m"></div></td>
          <td data-col="4"><div class="cell-10m"></div></td>
          <td data-col="5"><div class="cell-10m"></div></td>
          <td data-col="6"><div class="cell-10m"></div></td>
          <td data-col="7"><div class="cell-10m"></div></td>
        `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDates(weekDates){
            // thead에 날짜(M/D) 라벨 표시
            const ths = theadWeek.querySelectorAll('th');
            for(let i=0;i<7;i++){
                const th = ths[i+1]; // 0=시간
                if(!th) continue;
                const d = new Date(weekDates[i]);
                th.innerHTML = `${['월','화','수','목','금','토','일'][i]}<br><small class="text-muted">(${d.getMonth()+1}/${d.getDate()})</small>`;
            }
        }

        function paintPlan(member, weekDates){
            const schedules = getSchedules(member); // [{day:'MON', start:'HH:mm', end:'HH:mm'}]
            // 요일 → js day (0=Sun..6=Sat)
            const mapToJS={'SUN':0,'MON':1,'TUE':2,'WED':3,'THU':4,'FRI':5,'SAT':6};

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const jsDay = (dayIdx+1)%7; // 월=1 … 일=0
                const daySegs = schedules.filter(s=>mapToJS[s.day]===jsDay);
                if(!daySegs.length) continue;

                // 각 10분 슬롯에 대해 on 판정
                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;

                    const absMin = HOUR_START*60 + rIdx*STEP_MIN;
                    const hm = `${String(Math.floor(absMin/60)).padStart(2,'0')}:${String(absMin%60).padStart(2,'0')}`;

                    if(daySegs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        function paintActualFromApi(apiData, weekDates){
            const days = Array.isArray(apiData?.days) ? apiData.days : [];
            // date → segments[]
            const byDate = new Map(days.map(d=>[String(d.date), Array.isArray(d.segments)?d.segments:[]]));

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso = weekDates[dayIdx];
                const segs = byDate.get(iso) || [];
                if(!segs.length) continue;

                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;

                    const absMin = HOUR_START*60 + rIdx*STEP_MIN;
                    const hm = `${String(Math.floor(absMin/60)).padStart(2,'0')}:${String(absMin%60).padStart(2,'0')}`;

                    if(segs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('actual-on');
                    }
                });
            }
        }

        // ===== Member / Info =====
        function renderMemberInfo(m){
            infoName.textContent=m.name ?? '-';
            infoGender.textContent=m.gender ?? '-';
            infoPhone.textContent=m.phone ?? '-';
            infoEmail.textContent=m.email ?? '-';
            infoStartDate.textContent=m.startDate ?? '-';
            infoHealth.textContent = m.hasHealthCertificate ? (m.healthCertExpiry ? `보유 (유효기간: ${m.healthCertExpiry})` : '보유') : '미보유';
            infoHourlyWage.textContent=(typeof m.hourlyWage==='number')
                    ? new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(m.hourlyWage)
                    : '-';
            const badgeMap={WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            statusBadge.textContent=m.status || '-';
            statusBadge.className=`badge ${badgeMap[m.status]||'bg-secondary'}`;
        }

        // ===== Utils =====
        function getSchedules(m){ return Array.isArray(m?.schedules)?m.schedules : Array.isArray(m?.schedule)?m.schedule : []; }
        function slotInside(hm, s, e){ const t=hmToMin(hm), ss=hmToMin(s), ee=hmToMin(e); return t>=ss && t<ee; }
        function hmToMin(hm){ const [h,m]=String(hm).split(':').map(Number); return h*60+(m||0); }

        function parseWeekRangeToDates(label){
            // label 예: "2025.11.03 ~ 11.09"
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            let start;
            if(m){ start = new Date(+m[1], +m[2]-1, +m[3]); }
            else { const today = new Date(); start = toMonday(today); }
            const weekDates = Array.from({length:7}, (_,i)=>toIso(addDays(start,i)));
            return { weekStartIso: weekDates[0], weekEndIso: weekDates[6], weekDates };
        }
        function toMonday(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d; }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function openEdit(){
            const id = Number(memberSelect.value||0);
            if(!id){ alert('알바생을 선택하세요.'); return; }
            window.location.assign(`/members/${id}/edit`);
        }

        function clearRight(){
            selectedMemberTitle.textContent='주간 10분 단위 타임테이블 (월~일)';
            tbodyWeek.innerHTML='';
            statusBadge.textContent='-'; statusBadge.className='badge bg-secondary';
            infoName.textContent='-'; infoGender.textContent='-'; infoPhone.textContent='-'; infoEmail.textContent='-';
            infoStartDate.textContent='-'; infoHealth.textContent='-'; infoHourlyWage.textContent='-';
        }
    })();
</script>

{{>layouts/footer}}
