{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ ì™¼ìª½: ìƒíƒœ/ì•Œë°”ìƒ ì„ íƒ + ì •ë³´ ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <!-- ìƒíƒœ/ì•Œë°”ìƒ ì„ íƒ -->
                <div class="card">
                    <div class="card-header fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ì„ íƒ</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-12">
                                <label class="form-label small text-muted" for="statusSelect">ìƒíƒœ</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                                    <option value="WAITING">ì‹œì‘ì „</option>
                                    <option value="RESTING">íœ´ì‹ì¤‘</option>
                                    <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                    <option value="RESIGNED">í‡´ì‚¬</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted">ì•Œë°”ìƒ</label>
                                <div class="input-group">
                                    <select id="memberSelect" class="form-select">
                                        <option value="">ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                    </select>
                                    <button id="detailBtn" class="btn btn-primary" type="button" disabled>ì •ë³´ ìˆ˜ì •</button>
                                </div>
                                <div class="form-text">ìƒíƒœë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì•Œë°”ìƒ ì •ë³´ -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´</span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6"><div class="text-muted">ì´ë¦„</div><div id="infoName" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">ì„±ë³„</div><div id="infoGender" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">ì „í™”ë²ˆí˜¸</div><div id="infoPhone" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">ì´ë©”ì¼</div><div id="infoEmail" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">ì‹œì‘ì¼</div><div id="infoStartDate" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">ë³´ê±´ì¦</div><div id="infoHealth" class="fw-semibold">-</div></div>
                            <div class="col-12"><div class="text-muted">ì‹œê¸‰(ì›)</div><div id="infoHourlyWage" class="fw-semibold">-</div></div>
                        </div>
                    </div>
                </div>

                <!-- ë²”ë¡€ -->
                <div class="card">
                    <div class="card-body d-flex gap-3 align-items-center">
                        <span class="legend legend-plan"></span><span class="small">ê³„íš</span>
                        <span class="legend legend-actual"></span><span class="small">ì‹¤ì œ</span>
                        <span class="legend legend-both"></span><span class="small">ë‘˜ ë‹¤</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ ì˜¤ë¥¸ìª½ ============ -->
        <div class="col-12 col-lg-7">

            <!-- ğŸ”¼ ìƒë‹¨(ì¹´ë“œ ë°”ê¹¥): ë·° ì „í™˜ íƒ­ + ì£¼/ì›” ë‚´ë¹„ -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                <div id="viewTabsTop" class="btn-group btn-group-sm" role="group" aria-label="view switch">
                    <button type="button" class="btn btn-outline-primary active" data-view="weekGrid">ì£¼ê°„ìŠ¤ì¼€ì¤„</button>
                    <button type="button" class="btn btn-outline-primary" data-view="weekSummary">ì£¼ê°„ê·¼ë¬´ì‹œê°„</button>
                    <button type="button" class="btn btn-outline-primary" data-view="monthCalendar">ì›”ê°„ ê·¼ë¬´ì‹œê°„</button>
                </div>

                <!-- ì£¼ê°„ ë‚´ë¹„ (ì£¼ ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
                <div id="navWeek" class="d-flex align-items-center small text-muted gap-2">
                    <span id="weekRangeLabel">{{weekRangeLabel}}</span>
                    <a class="btn btn-sm btn-outline-secondary" id="btnWeekPrev" href="{{weekPrevUrl}}">â—€ ì´ì „ ì£¼</a>
                    <a class="btn btn-sm btn-outline-secondary" id="btnWeekNext" href="{{weekNextUrl}}">ë‹¤ìŒ ì£¼ â–¶</a>
                </div>

                <!-- ì›”ê°„ ë‚´ë¹„ (ì›” ë³´ê¸°ì—ë§Œ í‘œì‹œ) -->
                <div id="navMonth" class="d-none align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">â—€ ì´ì „ ë‹¬</button>
                    <div class="fw-semibold" id="monthLabel">0000.00</div>
                    <button class="btn btn-sm btn-outline-secondary" id="btnMonthNext">ë‹¤ìŒ ë‹¬ â–¶</button>
                    <button class="btn btn-sm btn-outline-secondary" id="btnMonthThis">ì´ë²ˆ ë‹¬</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span id="selectedMemberTitle">ì£¼ê°„ 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</span>
                    <span id="selectedMemberStatus" class="badge bg-secondary d-none">-</span>
                </div>

                <div class="card-body">
                    <!-- ë·° 1: ì£¼ê°„ 10ë¶„ ê·¸ë¦¬ë“œ -->
                    <div id="viewWeekGrid">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle text-center timetable-week-10m mb-2" id="tableWeek10m">
                                <thead>
                                <tr id="theadWeek">
                                    <th style="width:80px;">ì‹œê°„</th>
                                    <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeek10m"></tbody>
                            </table>
                        </div>
                        <div class="small text-muted mt-1">
                            * 10ë¶„ ë‹¨ìœ„ë¡œ ì¹ í•´ì§‘ë‹ˆë‹¤. <span class="legend legend-plan"></span> ê³„íš,
                            <span class="legend legend-actual"></span> ì‹¤ì œ, <span class="legend legend-both"></span> ê²¹ì¹˜ë©´ ì§„í•œ í‘œì‹œ.
                        </div>
                    </div>

                    <!-- ë·° 2: ì£¼ê°„ ê·¼ë¬´ì‹œê°„ ìš”ì•½ í‘œ -->
                    <div id="viewWeekSummary" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle" id="tableWeekSummary">
                                <thead class="table-light">
                                <tr>
                                    <th style="width:110px;">ìš”ì¼</th>
                                    <th>ê³„íš ê·¼ë¬´ê¸°ê°„</th>
                                    <th>ì‹¤ ê·¼ë¬´ì‹œê°„</th>
                                    <th style="width:120px;" class="text-end">ì‹¤ í•©ê³„</th>
                                </tr>
                                </thead>
                                <tbody id="tbodyWeekSummary"></tbody>
                                <tfoot>
                                <tr>
                                    <th>í•©ê³„(ê³„íš)</th>
                                    <td class="text-end fw-semibold" id="weekPlannedTotalCell">0ì‹œê°„</td>
                                    <td class="text-muted">ê³„íš ë¯¸ ë°˜ì˜</td>
                                    <th></th>
                                </tr>
                                <tr class="table-secondary">
                                    <th>í•©ê³„(ì‹¤ì œ)</th>
                                    <td></td>
                                    <td class="text-end fw-semibold" colspan="2" id="weekActualTotalCell">0ì‹œê°„</td>
                                </tr>
                                <tr>
                                    <th>ì‹œê¸‰</th>
                                    <td></td>
                                    <td class="text-end">ê¸°ì¤€ ì‹œê¸‰</td>
                                    <th class="text-end" id="hourlyWageCellW">-</th>
                                </tr>
                                <tr class="table-secondary">
                                    <th>ì˜ˆìƒ ê¸‰ì—¬</th>
                                    <td></td>
                                    <td class="text-end">ì£¼ê°„ ì‹¤ê·¼ë¬´ Ã— ì‹œê¸‰</td>
                                    <th class="text-end text-primary" id="weekPayCell">-</th>
                                </tr>
                                <tr>
                                    <th>ì‹¤ì œ-ê³„íš</th>
                                    <td></td>
                                    <td class="text-end">í”ŒëŸ¬ìŠ¤ë©´ ì´ˆê³¼ê·¼ë¬´</td>
                                    <th class="text-end" id="weekDeltaCell">0ë¶„</th>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- ë·° 3: ì›”ê°„ ë‹¬ë ¥ -->
                    <div id="viewMonthCalendar" class="d-none">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- JS ë Œë”: ìš”ì¼ í—¤ë” + ë‚ ì§œ ì…€ -->
                        </div>

                        <!-- ì›” í•©ê³„/ê¸‰ì—¬ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” í•©ê³„(ì‹¤ê·¼ë¬´)</div>
                                <div class="fw-semibold" id="monthActualTotalCell">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì‹œê¸‰</div>
                                <div id="hourlyWageCellM">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ì˜ˆìƒ ê¸‰ì—¬</div>
                                <div class="text-primary fw-semibold" id="monthPayCell">-</div>
                            </div>
                        </div>

                        <div class="small text-muted mt-2">
                            * ë‚ ì§œ ì¹¸ì— ì‹¤ ê·¼ë¬´ êµ¬ê°„ ì¹©ê³¼ ì¼ í•©ê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .cell-10m { height: 16px; border: 1px solid #eef2f6; border-radius: 3px; background: #fff; }
    .cell-10m.schedule-on { background: rgba(255,159,67,.28); border-color: rgba(255,159,67,.55); }
    .cell-10m.actual-on { background: rgba(25,135,84,.22); border-color: rgba(25,135,84,.35); }
    .cell-10m.schedule-on.actual-on {
        background: linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%);
        border-color: rgba(25,135,84,.5);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,.25);
    }
    tr.hour-start > td, tr.hour-start > th { border-top: 2px solid #dee2e6 !important; }
    .timecell { font-variant-numeric: tabular-nums; }

    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(255,159,67,.35); border-color: rgba(255,159,67,.65); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.4); }
    .legend-both { background: linear-gradient(135deg, rgba(255,159,67,.40) 0%, rgba(255,159,67,.40) 50%, rgba(25,135,84,.40) 50%, rgba(25,135,84,.40) 100%); border-color: rgba(25,135,84,.5); }

    /* ë‹¬ë ¥ */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* ì¼~í†  */
        gap: 8px;
    }
    .calendar-grid .dow {
        text-align: center;
        font-weight: 600;
        color: #6c757d;
        padding: 6px 0;
        border-bottom: 1px dashed #e9ecef;
    }
    .calendar-grid .cell {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 8px;
        min-height: 120px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .cell .date-head {
        display:flex; align-items:center; justify-content:space-between;
        font-weight:600; font-size:.95rem;
    }
    .cell .date-head .dow-mini { color:#6c757d; font-weight:500; font-size:.85rem; }
    .cell .segments { display:flex; flex-wrap:wrap; gap:6px; }
    .cell .day-total { margin-top:auto; text-align:right; font-size:.875rem; color:#212529; }
    .cell.muted { background:#fcfcfc; color:#96a0aa; }
    .cell.today { outline: 2px solid #51cf66; outline-offset: 2px; }
</style>

<!-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‚´ë ¤ì¤€ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        // ===== Constants & DOM =====
        const HOUR_START=6, HOUR_END=22, STEP_MIN=10, SLOTS_PER_HOUR=60/STEP_MIN;

        const tbodyWeek=document.getElementById('tbodyWeek10m');
        const theadWeek=document.getElementById('theadWeek');
        const selectedMemberTitle=document.getElementById('selectedMemberTitle');

        const statusSelect=document.getElementById('statusSelect');
        const memberSelect=document.getElementById('memberSelect');
        const detailBtn=document.getElementById('detailBtn');

        const statusBadge=document.getElementById('statusBadge');
        const infoName=document.getElementById('infoName');
        const infoGender=document.getElementById('infoGender');
        const infoPhone=document.getElementById('infoPhone');
        const infoEmail=document.getElementById('infoEmail');
        const infoStartDate=document.getElementById('infoStartDate');
        const infoHealth=document.getElementById('infoHealth');
        const infoHourlyWage=document.getElementById('infoHourlyWage');

        const weekRangeLabelEl=document.getElementById('weekRangeLabel');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');

        // ìƒë‹¨ íƒ­ & ë‚´ë¹„
        const viewTabsTop=document.getElementById('viewTabsTop');
        const navWeek=document.getElementById('navWeek');
        const navMonth=document.getElementById('navMonth');

        // ì£¼ê°„ ìš”ì•½ DOM
        const tbodyWeekSummary=document.getElementById('tbodyWeekSummary');
        const weekPlannedTotalCell=document.getElementById('weekPlannedTotalCell');
        const weekActualTotalCell=document.getElementById('weekActualTotalCell');
        const weekDeltaCell=document.getElementById('weekDeltaCell');
        const weekPayCell=document.getElementById('weekPayCell');
        const hourlyWageCellW=document.getElementById('hourlyWageCellW');

        // ì›”ê°„ ë‹¬ë ¥ DOM
        const calendarGrid=document.getElementById('calendarGrid');
        const monthLabel=document.getElementById('monthLabel');
        const btnMonthPrev=document.getElementById('btnMonthPrev');
        const btnMonthNext=document.getElementById('btnMonthNext');
        const btnMonthThis=document.getElementById('btnMonthThis');
        const monthActualTotalCell=document.getElementById('monthActualTotalCell');
        const monthPayCell=document.getElementById('monthPayCell');
        const hourlyWageCellM=document.getElementById('hourlyWageCellM');

        // ë·° ì»¨í…Œì´ë„ˆ
        const viewWeekGrid=document.getElementById('viewWeekGrid');
        const viewWeekSummary=document.getElementById('viewWeekSummary');
        const viewMonthCalendar=document.getElementById('viewMonthCalendar');

        let allMembers=[];
        try{ allMembers=JSON.parse(document.getElementById('membersData').textContent||'[]'); }catch(e){ allMembers=[]; }
        if(Array.isArray(allMembers)&&allMembers.length>0){ statusSelect.value=allMembers[0].status||'WORKING'; }

        // íƒ­ ì´ë²¤íŠ¸
        viewTabsTop.addEventListener('click', (e)=>{
            const btn = e.target.closest('button[data-view]');
            if(!btn) return;
            viewTabsTop.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            switchView(btn.dataset.view);
        });

        // ìƒíƒœ/ë©¤ë²„/ì •ë³´ ì´ë²¤íŠ¸
        statusSelect.addEventListener('change', handleStatusChange);
        memberSelect.addEventListener('change', handleMemberChange);
        detailBtn.addEventListener('click', openEdit);

        // ì›” ë‚´ë¹„ ì´ë²¤íŠ¸(í´ë¼ì´ì–¸íŠ¸ì—ì„œ ?week=YYYY-MM-DDë¡œ ì´ë™)
        btnMonthPrev.addEventListener('click', ()=>jumpMonth(-1));
        btnMonthNext.addEventListener('click', ()=>jumpMonth(+1));
        btnMonthThis.addEventListener('click', ()=>jumpToMonth(new Date()));

        // ì‹œì‘
        handleStatusChange();

        function handleStatusChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            memberSelect.innerHTML='';
            detailBtn.disabled=true;

            if(!filtered.length){
                memberSelect.innerHTML='<option value="">í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤</option>';
                clearRight();
                return;
            }
            memberSelect.appendChild(new Option('ì•Œë°”ìƒì„ ì„ íƒí•˜ì„¸ìš”',''));
            filtered.forEach(m=>memberSelect.appendChild(new Option(`${m.name ?? '-'} (${m.gender ?? '-'})`, String(m.id))));
            memberSelect.value=String(filtered[0].id);
            detailBtn.disabled=false;
            renderAll(filtered[0]);
        }

        function handleMemberChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            const id = Number(memberSelect.value);
            const m = filtered.find(x=>x.id===id);
            detailBtn.disabled=!m;
            if(m) renderAll(m); else clearRight();
        }

        async function renderAll(member){
            renderMemberInfo(member);
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member?.status || '-';
            selectedMemberStatus.className = `badge ${statusClass(member?.status)}`;

            const { weekStartIso, weekEndIso, weekDates } = parseWeekRangeToDates(weekRangeLabelEl?.textContent || '');
            renderWeekHeadDates(weekDates);

            // ê¸°ë³¸: ì£¼ê°„ ìŠ¤ì¼€ì¤„(10ë¶„)
            buildWeekGrid10m();
            paintPlan(member, weekDates);

            try{
                const url=`/api/schedule/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const resp=await fetch(url,{headers:{'Accept':'application/json'}});
                if(resp.ok){
                    const data=await resp.json();
                    paintActualFromApi(data, weekDates);
                    await renderWeekSummary(member, weekDates, data);

                    // ì›” ë Œë”: ì£¼ ì‹œì‘ì´ í¬í•¨ëœ ë‹¬ ê¸°ì¤€
                    const baseDate = parseIsoDate(weekStartIso);
                    await renderMonthCalendar(member, baseDate);
                }
            }catch(e){ console.error(e); }

            selectedMemberTitle.textContent = `${member.name ?? '-'} â€” ë³´ê¸° ì „í™˜`;
            // í˜„ì¬ í™œì„± íƒ­ì— ë§ì¶° ë‚´ë¹„ í‘œì‹œ í† ê¸€
            const active = viewTabsTop.querySelector('button.active')?.dataset.view || 'weekGrid';
            switchView(active);
        }

        function switchView(view){
            const isWeek = (view==='weekGrid' || view==='weekSummary');
            navWeek.classList.toggle('d-none', !isWeek);
            navMonth.classList.toggle('d-none', view!=='monthCalendar');

            viewWeekGrid.classList.toggle('d-none', view!=='weekGrid');
            viewWeekSummary.classList.toggle('d-none', view!=='weekSummary');
            viewMonthCalendar.classList.toggle('d-none', view!=='monthCalendar');
        }

        // ===== ì£¼ê°„ 10ë¶„ ê·¸ë¦¬ë“œ =====
        function buildWeekGrid10m(){
            tbodyWeek.innerHTML='';
            const totalRows = (HOUR_END - HOUR_START) * SLOTS_PER_HOUR;
            for(let idx=0; idx<totalRows; idx++){
                const minutesFromStart = idx * STEP_MIN;
                const absMin = HOUR_START*60 + minutesFromStart;
                const h = Math.floor(absMin/60), m = absMin%60;
                const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('hour-start');
                tr.innerHTML = `
        <th class="timecell" scope="row">${hm}</th>
        <td data-col="1"><div class="cell-10m"></div></td>
        <td data-col="2"><div class="cell-10m"></div></td>
        <td data-col="3"><div class="cell-10m"></div></td>
        <td data-col="4"><div class="cell-10m"></div></td>
        <td data-col="5"><div class="cell-10m"></div></td>
        <td data-col="6"><div class="cell-10m"></div></td>
        <td data-col="7"><div class="cell-10m"></div></td>
      `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDates(weekDates){
            const ths = theadWeek.querySelectorAll('th');
            for(let i=0;i<7;i++){
                const th = ths[i+1];
                if(!th) continue;
                const d = new Date(weekDates[i]);
                th.innerHTML = `${['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]}<br><small class="text-muted">(${d.getMonth()+1}/${d.getDate()})</small>`;
            }
        }

        function paintPlan(member){
            const schedules = getSchedules(member); // [{day:'MON', start:'HH:mm', end:'HH:mm'}]
            const mapToJS={'SUN':0,'MON':1,'TUE':2,'WED':3,'THU':4,'FRI':5,'SAT':6};

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const jsDay = (dayIdx+1)%7; // ì›”=1 â€¦ ì¼=0
                const daySegs = schedules.filter(s=>mapToJS[s.day]===jsDay);
                if(!daySegs.length) continue;

                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const absMin = HOUR_START*60 + rIdx*STEP_MIN;
                    const hm = `${String(Math.floor(absMin/60)).padStart(2,'0')}:${String(absMin%60).padStart(2,'0')}`;
                    if(daySegs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        function paintActualFromApi(apiData, weekDates){
            const days = Array.isArray(apiData?.days) ? apiData.days : [];
            const byDate = new Map(days.map(d=>[String(d.date), Array.isArray(d.segments)?d.segments:[]]));

            for(let dayIdx=0; dayIdx<7; dayIdx++){
                const iso = weekDates[dayIdx];
                const segs = byDate.get(iso) || [];
                if(!segs.length) continue;

                const rows = tbodyWeek.querySelectorAll('tr');
                rows.forEach((tr, rIdx)=>{
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if(!cellDiv) return;
                    const absMin = HOUR_START*60 + rIdx*STEP_MIN;
                    const hm = `${String(Math.floor(absMin/60)).padStart(2,'0')}:${String(absMin%60).padStart(2,'0')}`;
                    if(segs.some(seg=>slotInside(hm, seg.start, seg.end))){
                        cellDiv.classList.add('actual-on');
                    }
                });
            }
        }

        // ===== ì£¼ê°„ ìš”ì•½ =====
        async function renderWeekSummary(member, weekDates, apiData){
            const DOW = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            const DOW_KEY = ['SUN','MON','TUE','WED','THU','FRI','SAT'];

            const plannedByDate = (() => {
                const list = getSchedules(member);
                const result = {};
                for(let i=0;i<7;i++){
                    const d = new Date(weekDates[i]);
                    const key = DOW_KEY[d.getDay()];
                    const segs = list.filter(s=>s.day===key).map(s=>({start:s.start, end:s.end}));
                    const minutes = segs.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                    result[weekDates[i]] = { segments: segs, minutes };
                }
                return result;
            })();

            const actualMap = normalizeActualDays(apiData);

            let wPlanned = 0, wActual = 0;
            const rows = [];
            for(let i=0;i<7;i++){
                const d = new Date(weekDates[i]);
                const iso = weekDates[i];
                const dayLabel = DOW[d.getDay()];
                const p = plannedByDate[iso] || {segments:[], minutes:0};
                const a = actualMap[iso] || {segments:[], minutes:0};
                wPlanned += (p.minutes||0);
                wActual  += (a.minutes||0);

                const chipsPlanned = p.segments.length
                        ? p.segments.map(s=>chipHtml('#0d6efd', s.start, s.end)).join(' ')
                        : '<span class="text-muted">â€”</span>';
                const chipsActual = a.segments.length
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted">â€”</span>';

                rows.push(`
        <tr>
          <th scope="row">${dayLabel}</th>
          <td>${chipsPlanned}</td>
          <td>${chipsActual}</td>
          <td class="text-end">${formatMins(a.minutes||0)}</td>
        </tr>
      `);
            }

            tbodyWeekSummary.innerHTML = rows.join('');
            weekPlannedTotalCell.textContent = formatMins(wPlanned);
            weekActualTotalCell.textContent  = formatMins(wActual);
            weekDeltaCell.textContent        = deltaString(wActual - wPlanned);

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            hourlyWageCellW.textContent = (wage!=null) ? krw(wage) : '-';
            const pay = (wage!=null) ? Math.round((wActual/60)*wage) : null;
            weekPayCell.textContent = (pay!=null) ? krw(pay) : '-';
        }

        // ===== ì›”ê°„ ë‹¬ë ¥ =====
        async function renderMonthCalendar(member, baseDate){
            // baseDateê°€ ì†í•œ ë‹¬ì˜ 1ì¼/ë§ì¼
            const ms = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
            const me = new Date(baseDate.getFullYear(), baseDate.getMonth()+1, 0);
            const monthStartIso = toIso(ms), monthEndIso = toIso(me);

            // ë¼ë²¨/ë‚´ë¹„ ì¤€ë¹„
            monthLabel.textContent = `${ms.getFullYear()}.${String(ms.getMonth()+1).padStart(2,'0')}`;
            monthLabel.dataset.monthStart = monthStartIso; // ë‚´ë¹„ ê³„ì‚°ìš© ì €ì¥

            // fetch
            let actualMap = {};
            try {
                const url = `/api/schedule/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (resp.ok) { actualMap = normalizeActualDays(await resp.json()); }
            } catch (e) { console.error(e); }

            // ë Œë”
            calendarGrid.innerHTML = '';
            const DOW_HEAD = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            DOW_HEAD.forEach(label=>{
                const h = document.createElement('div');
                h.className = 'dow';
                h.textContent = label;
                calendarGrid.appendChild(h);
            });

            const todayIso = toIso(new Date());
            const firstDow = ms.getDay(); // 0=ì¼
            for (let i=0;i<firstDow;i++){
                const blank = document.createElement('div');
                blank.className = 'cell muted';
                calendarGrid.appendChild(blank);
            }

            let monthMinutes = 0;
            for (let d = new Date(ms); d <= me; d.setDate(d.getDate()+1)) {
                const iso = toIso(d);
                const dow = d.getDay();
                const a = actualMap[iso] || {segments:[], minutes:0};
                monthMinutes += (a.minutes||0);

                const cell = document.createElement('div');
                cell.className = 'cell';
                if (iso === todayIso) cell.classList.add('today');

                const chipsHtml = (a.segments?.length)
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted small">â€”</span>';

                cell.innerHTML = `
        <div class="date-head">
          <span>${d.getDate()}ì¼</span>
          <span class="dow-mini">${DOW_HEAD[dow]}</span>
        </div>
        <div class="segments">${chipsHtml}</div>
        <div class="day-total">${formatMins(a.minutes||0)}</div>
      `;
                calendarGrid.appendChild(cell);
            }

            monthActualTotalCell.textContent = formatMins(monthMinutes);
            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            hourlyWageCellM.textContent = (wage!=null) ? krw(wage) : '-';
            const monthPay = (wage!=null) ? Math.round((monthMinutes/60)*wage) : null;
            monthPayCell.textContent = (monthPay!=null) ? krw(monthPay) : '-';
        }

        // ===== ì›” ë‚´ë¹„ê²Œì´ì…˜ (ì¿¼ë¦¬: ?week=YYYY-MM-DD ë¡œ ì„œë²„ ì´ë™) =====
        function jumpMonth(offset){
            const msIso = monthLabel.dataset.monthStart; // YYYY-MM-01
            const d = parseIsoDate(msIso);
            const target = new Date(d.getFullYear(), d.getMonth()+offset, 1);
            jumpToMonth(target);
        }
        function jumpToMonth(dateObj){
            // ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” week(ì›”ìš”ì¼) íŒŒë¼ë¯¸í„°ë¥¼ ë°›ìœ¼ë¯€ë¡œ, í•´ë‹¹ ì›” 1ì¼ ê¸°ì¤€ì˜ ì›”ìš”ì¼ë¡œ ë³´ì •
            const monthMonday = toMonday(new Date(dateObj.getFullYear(), dateObj.getMonth(), 1));
            const iso = toIso(monthMonday);
            const url = new URL(window.location.href);
            url.searchParams.set('week', iso);
            window.location.assign(url.toString());
        }

        // ===== Info/Utils =====
        function renderMemberInfo(m){
            infoName.textContent=m.name ?? '-';
            infoGender.textContent=m.gender ?? '-';
            infoPhone.textContent=m.phone ?? '-';
            infoEmail.textContent=m.email ?? '-';
            infoStartDate.textContent=m.startDate ?? '-';
            infoHealth.textContent = m.hasHealthCertificate ? (m.healthCertExpiry ? `ë³´ìœ  (ìœ íš¨ê¸°ê°„: ${m.healthCertExpiry})` : 'ë³´ìœ ') : 'ë¯¸ë³´ìœ ';
            infoHourlyWage.textContent=(typeof m.hourlyWage==='number') ? krw(m.hourlyWage) : '-';
            const badgeMap={WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            statusBadge.textContent=m.status || '-';
            statusBadge.className=`badge ${badgeMap[m.status]||'bg-secondary'}`;
        }
        function openEdit(){
            const id = Number(memberSelect.value||0);
            if(!id){ alert('ì•Œë°”ìƒì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            window.location.assign(`/members/${id}/edit`);
        }

        function clearRight(){
            selectedMemberTitle.textContent='ì£¼ê°„ 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)';
            tbodyWeek.innerHTML='';
            tbodyWeekSummary.innerHTML='';
            calendarGrid.innerHTML='';
            monthActualTotalCell.textContent='0ì‹œê°„';
            monthPayCell.textContent='-';
            hourlyWageCellM.textContent='-';
            statusBadge.textContent='-'; statusBadge.className='badge bg-secondary';
            infoName.textContent='-'; infoGender.textContent='-'; infoPhone.textContent='-'; infoEmail.textContent='-';
            infoStartDate.textContent='-'; infoHealth.textContent='-'; infoHourlyWage.textContent='-';
        }

        function getSchedules(m){ return Array.isArray(m?.schedules)?m.schedules : Array.isArray(m?.schedule)?m.schedule : []; }
        function slotInside(hm, s, e){ const t=hmToMin(hm), ss=hmToMin(s), ee=hmToMin(e); return t>=ss && t<ee; }
        function hmToMin(hm){ const [h,m]=String(hm).split(':').map(Number); return h*60+(m||0); }

        function parseWeekRangeToDates(label){
            // label ì˜ˆ: "2025.11.03 ~ 11.09"
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            let start;
            if(m){ start = new Date(+m[1], +m[2]-1, +m[3]); }
            else { const today = new Date(); start = toMonday(today); }
            const weekDates = Array.from({length:7}, (_,i)=>toIso(addDays(start,i)));
            return { weekStartIso: weekDates[0], weekEndIso: weekDates[6], weekDates };
        }
        function toMonday(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d; }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function parseIsoDate(iso){ const [y,m,d]=iso.split('-').map(n=>parseInt(n,10)); return new Date(y,m-1,d); }

        function formatMins(mins){ const h=Math.floor(mins/60), m=mins%60; return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`; }
        function deltaString(min){ const sign = min>0?'+':min<0?'-':''; const v=Math.abs(min); const h=Math.floor(v/60), m=v%60; return `${sign}${h}ì‹œê°„${m?` ${m}ë¶„`:''}`; }
        function krw(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }

        function normalizeActualDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }
        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="legend" style="background:${color};border-color:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function statusClass(s){
            const map = {WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            return map[s] || 'bg-secondary';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
    })();
</script>

{{>layouts/footer}}
