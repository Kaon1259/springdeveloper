{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ ì™¼ìª½: ìƒíƒœ ì„ íƒ + ì•Œë°”ìƒ ì„ íƒ + ì •ë³´ + ì˜ˆìƒê¸‰ì—¬ ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top: 12px;">

                <!-- ìƒíƒœ/ì•Œë°”ìƒ ì„ íƒ -->
                <div class="card">
                    <div class="card-header fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ì„ íƒ</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">

                            <!-- ìƒíƒœ -->
                            <div class="col-12">
                                <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                                    <option value="WAITING">ì‹œì‘ì „</option>
                                    <option value="RESTING">íœ´ì‹ì¤‘</option>
                                    <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                    <option value="RESIGNED">í‡´ì‚¬</option>
                                </select>
                            </div>

                            <!-- ì•Œë°”ìƒ ë“œë¡­ë‹¤ìš´ + ìˆ˜ì • ë²„íŠ¼ -->
                            <div class="col-12">
                                <label class="form-label small text-muted">ì•Œë°”ìƒ</label>
                                <div class="input-group">
                                    <select id="memberSelect" class="form-select">
                                        <option value="">ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                    </select>
                                    <button id="detailBtn" class="btn btn-primary" type="button" disabled>ì •ë³´ ìˆ˜ì •</button>
                                </div>
                                <div class="form-text" id="memberSelectHelp">ìƒíƒœë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì•Œë°”ìƒ ì •ë³´ -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´</span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6">
                                <div class="text-muted">ì´ë¦„</div>
                                <div id="infoName" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ì„±ë³„</div>
                                <div id="infoGender" class="fw-semibold">-</div>
                            </div>

                            <!-- ğŸ”¹ ì¶”ê°€: ì „í™”ë²ˆí˜¸ -->
                            <div class="col-6">
                                <div class="text-muted">ì „í™”ë²ˆí˜¸</div>
                                <div id="infoPhone" class="fw-semibold">-</div>
                            </div>
                            <!-- ğŸ”¹ ì¶”ê°€: ì´ë©”ì¼ -->
                            <div class="col-6">
                                <div class="text-muted">ì´ë©”ì¼</div>
                                <div id="infoEmail" class="fw-semibold">-</div>
                            </div>

                            <div class="col-6">
                                <div class="text-muted">ì•„ë¥´ë°”ì´íŠ¸ ì‹œì‘ì¼</div>
                                <div id="infoStartDate" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">ë³´ê±´ì¦</div>
                                <div id="infoHealth" class="fw-semibold">-</div>
                            </div>
                            <!-- ì‹œê¸‰ -->
                            <div class="col-12">
                                <div class="text-muted">ì‹œê¸‰(ì›)</div>
                                <div id="infoHourlyWage" class="fw-semibold">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì˜ˆìƒê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="card shadow-sm">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center" style="background:#198754;color:#fff;">
                        <span>ì˜ˆìƒê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸°</span>
                        <small class="text-white-50">ìŠ¤ì¼€ì¤„Â·ì‹œê¸‰ ê¸°ë°˜ ê³„ì‚°</small>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-6">
                                <label for="wageInput" class="form-label small text-muted">ì‹œê¸‰(ì›)</label>
                                <input type="number" class="form-control" id="wageInput" placeholder="ì˜ˆ: 12000" min="0" step="100">
                            </div>
                            <div class="col-6">
                                <label for="daysPerWeekInput" class="form-label small text-muted">ì£¼ë‹¹ ê·¼ë¬´ì¼ìˆ˜(ìë™/ìˆ˜ì •ê°€ëŠ¥)</label>
                                <input type="number" class="form-control" id="daysPerWeekInput" min="0" step="1">
                            </div>
                            <div class="col-6">
                                <label for="hoursPerDayInput" class="form-label small text-muted">í•˜ë£¨ í‰ê· ì‹œê°„(ìë™/ìˆ˜ì •ê°€ëŠ¥)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="hoursPerDayInput" min="0" step="0.5">
                                    <span class="input-group-text">ì‹œê°„</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <label for="weeksPerMonthInput" class="form-label small text-muted">ì›” í™˜ì‚° ì£¼ì°¨(ë¯¸ì‚¬ìš©)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weeksPerMonthInput" min="0" step="0.001" value="4.345" disabled>
                                    <span class="input-group-text">ì£¼</span>
                                </div>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="row g-3 text-center">
                            <div class="col-6">
                                <div class="text-muted small">ì£¼ê°„ ê·¼ë¬´ì‹œê°„</div>
                                <div id="weeklyHours" class="display-6">0h</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small d-flex justify-content-center align-items-center gap-2">
                                    <span>ì›”ê°„ ê·¼ë¬´ì‹œê°„</span>
                                    <span id="monthLabel" class="badge bg-light text-dark"></span>
                                </div>
                                <div id="monthlyHours" class="display-6">0h</div>
                                <div id="monthlyDays" class="small text-muted">(ê·¼ë¬´ì¼ 0ì¼)</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">ì£¼ê°„ ì˜ˆìƒê¸‰ì—¬</div>
                                <div id="weeklyWage" class="display-6">0ì›</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small">ì›”ê°„ ì˜ˆìƒê¸‰ì—¬</div>
                                <div id="monthlyWage" class="display-6 text-success">0ì›</div>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">* ì›”ê°„ ê³„ì‚°ì€ <b>í•´ë‹¹ ë‹¬ì˜ ì‹¤ì œ ìš”ì¼ ê°œìˆ˜</b>ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ============ ì˜¤ë¥¸ìª½: ì£¼ê°„ íƒ€ì„í…Œì´ë¸”ë§Œ ============ -->
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-header fw-bold">ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center timetable" id="timetable">
                            <thead>
                            <tr>
                                <th style="width:80px;">ì‹œê°„</th>
                                <th>ì›”</th><th>í™”</th><th>ìˆ˜</th>
                                <th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
                            </tr>
                            </thead>
                            <tbody id="timetableBody">
                            <!-- JSê°€ 06:00~22:00 ì‹œê°„ ìŠ¬ë¡¯ì„ ì±„ì›ë‹ˆë‹¤. -->
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted">* ì§„í•œ ì…€ì€ í•´ë‹¹ ì‹œê°„ì— ê·¼ë¬´í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .timetable th, .timetable td { vertical-align: middle; }
    .timetable td.active { background: rgba(25,135,84,.15); }
</style>

<!-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‚´ë ¤ì¤€ JSON: membersJson (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´) -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    // JSON íŒŒì‹±
    let allMembers = [];
    try {
        allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
    } catch(e) { allMembers = []; }
</script>

<script>
    (function() {
        // ìƒìˆ˜/DOM
        const HOUR_START = 6, HOUR_END = 22;
        const statusSelect = document.getElementById('statusSelect');
        const memberSelect = document.getElementById('memberSelect');
        const detailBtn = document.getElementById('detailBtn');

        const statusBadge  = document.getElementById('statusBadge');
        const infoName = document.getElementById('infoName');
        const infoGender = document.getElementById('infoGender');
        const infoPhone = document.getElementById('infoPhone');   /* ğŸ”¹ ì¶”ê°€ */
        const infoEmail = document.getElementById('infoEmail');   /* ğŸ”¹ ì¶”ê°€ */
        const infoStartDate = document.getElementById('infoStartDate');
        const infoHealth = document.getElementById('infoHealth');
        const infoHourlyWage = document.getElementById('infoHourlyWage');
        const timetableBody = document.getElementById('timetableBody');

        // ê¸‰ì—¬ ê³„ì‚° ì˜ì—­
        const wageInput = document.getElementById('wageInput');
        const daysPerWeekInput = document.getElementById('daysPerWeekInput');
        const hoursPerDayInput = document.getElementById('hoursPerDayInput');
        const weeksPerMonthInput = document.getElementById('weeksPerMonthInput'); // ë¯¸ì‚¬ìš©(ë¹„í™œì„±í™”)

        const weeklyHoursEl = document.getElementById('weeklyHours');
        const weeklyWageEl  = document.getElementById('weeklyWage');
        const monthlyHoursEl = document.getElementById('monthlyHours');
        const monthlyDaysEl  = document.getElementById('monthlyDays');
        const monthlyWageEl  = document.getElementById('monthlyWage');
        const monthLabelEl   = document.getElementById('monthLabel');

        // ë‹¬ í‘œê¸° (í´ë¼ì´ì–¸íŠ¸ í˜„ì¬ ì›”)
        const now = new Date();
        const THIS_YEAR = now.getFullYear();
        const THIS_MONTH0 = now.getMonth(); // 0~11
        monthLabelEl.textContent = `${THIS_YEAR}-${String(THIS_MONTH0+1).padStart(2,'0')}`;

        // ìµœì´ˆ ê·¸ë¦¬ë“œ ìƒì„±
        renderTimeGrid();

        // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìƒíƒœë¥¼ ì²« ë©¤ë²„ ìƒíƒœë¡œ ë³´ì •
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ë²¤íŠ¸
        statusSelect.addEventListener('change', handleStatusChange);
        memberSelect.addEventListener('change', handleMemberChange);
        detailBtn.addEventListener('click', openEditPage);

        [wageInput, daysPerWeekInput, hoursPerDayInput].forEach(el => {
            el.addEventListener('input', recalcWage);
        });

        // ì´ˆê¸° ìƒíƒœì— ë§ì¶° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
        handleStatusChange();

        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            memberSelect.innerHTML = '';
            detailBtn.disabled = true;

            if (!filtered.length) {
                memberSelect.innerHTML = '<option value="">í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤</option>';
                clearRightPanels();
                return;
            }
            memberSelect.appendChild(new Option('ì•Œë°”ìƒì„ ì„ íƒí•˜ì„¸ìš”', ''));
            filtered.forEach(m => {
                const opt = new Option(`${m.name ?? '-'} (${m.gender ?? '-'})`, String(m.id));
                memberSelect.appendChild(opt);
            });

            // ì²« ëª…ë‹¨ ìë™ ì„ íƒ + ë Œë”ë§
            memberSelect.value = String(filtered[0].id);
            detailBtn.disabled = false;
            renderAll(filtered[0]);
        }

        function handleMemberChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);
            const id = Number(memberSelect.value);
            const member = filtered.find(m => m.id === id);
            detailBtn.disabled = !member;
            if (member) renderAll(member);
            else clearRightPanels();
        }

        function renderAll(member) {
            renderMemberInfo(member);
            renderMemberSchedule(member);
            autoFillWageForm(member);
            recalcWage(member); // â† ë©¤ë²„ ì „ë‹¬(ì›”ê°„ ê³„ì‚°ì—ì„œ ì‹œê¸‰ ìë™ ë°˜ì˜ì— ì‚¬ìš©)
        }

        function renderMemberInfo(m) {
            infoName.textContent = m.name ?? '-';
            infoGender.textContent = m.gender ?? '-';
            infoPhone.textContent = m.phone ?? '-';   /* ğŸ”¹ ì¶”ê°€ */
            infoEmail.textContent = m.email ?? '-';   /* ğŸ”¹ ì¶”ê°€ */
            infoStartDate.textContent = m.startDate ?? '-';

            if (m.hasHealthCertificate) {
                infoHealth.textContent = m.healthCertExpiry ? `ë³´ìœ  (ìœ íš¨ê¸°ê°„: ${m.healthCertExpiry})` : 'ë³´ìœ ';
            } else {
                infoHealth.textContent = 'ë¯¸ë³´ìœ ';
            }

            infoHourlyWage.textContent = (typeof m.hourlyWage === 'number')
                    ? new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(m.hourlyWage)
                    : '-';

            const badgeMap = {
                WORKING: 'bg-success', WAITING: 'bg-secondary', RESTING: 'bg-info',
                PAUSED: 'bg-warning', RESIGNED: 'bg-danger'
            };
            statusBadge.textContent = m.status || '-';
            statusBadge.className = `badge ${badgeMap[m.status] || 'bg-secondary'}`;
        }

        // schedule/schedules í˜¸í™˜
        function getSchedules(m) {
            if (Array.isArray(m?.schedule)) return m.schedule;
            if (Array.isArray(m?.schedules)) return m.schedules;
            return [];
        }

        function renderMemberSchedule(m) {
            timetableBody.querySelectorAll('td').forEach(td => td.classList.remove('active'));
            const schedules = getSchedules(m);
            schedules.forEach(s => {
                const start = parseHm(s.start);
                const end   = parseHm(s.end);
                for (let h = start.h; h < end.h; h++) {
                    if (h < HOUR_START || h > HOUR_END) continue;
                    const row = timetableBody.querySelector(`tr[data-hour="${h}"]`);
                    if (!row) continue;
                    const cell = row.querySelector(`td[data-day="${s.day}"]`);
                    if (cell) cell.classList.add('active');
                }
            });
        }

        function renderTimeGrid() {
            const rows = [];
            for (let h = HOUR_START; h <= HOUR_END; h++) {
                const label = `${String(h).padStart(2,'0')}:00`;
                rows.push(`
                <tr data-hour="${h}">
                  <th scope="row">${label}</th>
                  <td data-day="MON"></td>
                  <td data-day="TUE"></td>
                  <td data-day="WED"></td>
                  <td data-day="THU"></td>
                  <td data-day="FRI"></td>
                  <td data-day="SAT"></td>
                  <td data-day="SUN"></td>
                </tr>
            `);
            }
            timetableBody.innerHTML = rows.join('');
        }

        function clearRightPanels() {
            statusBadge.textContent = '-';
            statusBadge.className = 'badge bg-secondary';
            infoName.textContent = '-';
            infoGender.textContent = '-';
            infoPhone.textContent = '-';   /* ğŸ”¹ ì¶”ê°€ */
            infoEmail.textContent = '-';   /* ğŸ”¹ ì¶”ê°€ */
            infoStartDate.textContent = '-';
            infoHealth.textContent = '-';
            infoHourlyWage.textContent = '-';
            renderTimeGrid();
            setText(weeklyHoursEl,'0h'); setText(monthlyHoursEl,'0h');
            setText(weeklyWageEl,'0ì›'); setText(monthlyWageEl,'0ì›');
            monthlyDaysEl.textContent = '(ê·¼ë¬´ì¼ 0ì¼)';
            detailBtn.disabled = true;
        }

        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n => parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        // ---- ë“±ë¡ì •ë³´ í˜ì´ì§€ ì´ë™ ----
        function openEditPage() {
            const id = Number(memberSelect.value || 0);
            if (!id) { alert('ì•Œë°”ìƒì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            window.location.assign(`/members/${id}/edit`);
        }

        // ---- ìë™ ì±„ì›€(ì£¼ê°„ ìˆ˜ì¹˜ ì¶”ë¡ ) ----
        function autoFillWageForm(m) {
            const schedules = getSchedules(m);
            const uniqueDays = new Set(schedules.map(s => s.day));
            const totalMins = schedules.reduce((acc, s) => {
                const st = parseHm(s.start), ed = parseHm(s.end);
                return acc + Math.max(0, (ed.h*60+ed.m) - (st.h*60+st.m));
            }, 0);
            const weeklyHours = Math.round(totalMins/60 * 10)/10;

            if (!wageInput.value && typeof m.hourlyWage === 'number') {
                wageInput.value = String(m.hourlyWage);
            }
            daysPerWeekInput.value = uniqueDays.size || '';
            hoursPerDayInput.value = uniqueDays.size ? Math.round((weeklyHours/uniqueDays.size)*10)/10 : '';
        }

        // ---- ê¸‰ì—¬ ê³„ì‚°(ì£¼ê°„/ì›”ê°„) ----
        function recalcWage(currentMember) {
            // í˜„ì¬ ì„ íƒ ë©¤ë²„
            let member = currentMember;
            if (!member) {
                const status = statusSelect.value;
                const id = Number(memberSelect.value);
                member = (allMembers || []).filter(m => m.status === status).find(m => m.id === id);
            }
            if (!member) return;

            const schedules = getSchedules(member);
            const wage = Number(wageInput.value) || 0;

            // 1) ì£¼ê°„ ì´ ì‹œê°„
            const weeklyMinutes = schedules.reduce((acc, s) => {
                const st = parseHm(s.start), ed = parseHm(s.end);
                return acc + Math.max(0, (ed.h*60+ed.m) - (st.h*60+st.m));
            }, 0);
            const weeklyHours = Math.round((weeklyMinutes/60) * 10)/10;
            setText(weeklyHoursEl, `${weeklyHours}h`);
            setText(weeklyWageEl, toKRW(Math.round(weeklyHours * wage)));

            // 2) ì›”ê°„ ê³„ì‚°(í•´ë‹¹ ë‹¬ì˜ ì‹¤ì œ ìš”ì¼ ê°œìˆ˜ ë°˜ì˜)
            const {monthlyMinutes, monthlyDaysCount} = computeMonthlyFromSchedules(schedules, THIS_YEAR, THIS_MONTH0);
            const monthlyHours = Math.round((monthlyMinutes/60) * 10)/10;

            setText(monthlyHoursEl, `${monthlyHours}h`);
            monthlyDaysEl.textContent = `(ê·¼ë¬´ì¼ ${monthlyDaysCount}ì¼)`;
            setText(monthlyWageEl, toKRW(Math.round((monthlyMinutes/60) * wage)));
        }

        // ì›”ê°„: ì´ë²ˆ ë‹¬ì—ì„œ ê° ìš”ì¼ì˜ ë°œìƒ íšŸìˆ˜ Ã— í•´ë‹¹ ìš”ì¼ ìŠ¤ì¼€ì¤„ ì‹œê°„
        function computeMonthlyFromSchedules(schedules, year, month0) {
            // ìš”ì¼ ë¬¸ìì—´ â†’ JS getDay() (0=Sun..6=Sat)
            const mapToJS = { 'SUN':0, 'MON':1, 'TUE':2, 'WED':3, 'THU':4, 'FRI':5, 'SAT':6 };
            const byWeekday = new Map(); // jsDay -> perDayMinutes
            schedules.forEach(s => {
                const jsDay = mapToJS[s.day];
                if (jsDay == null) return;
                const st = parseHm(s.start), ed = parseHm(s.end);
                const minutes = Math.max(0, (ed.h*60+ed.m) - (st.h*60+st.m));
                const prev = byWeekday.get(jsDay) || 0;
                byWeekday.set(jsDay, prev + minutes);
            });

            let totalMinutes = 0;
            let totalDays = 0;
            byWeekday.forEach((perDayMinutes, jsDay) => {
                const occ = countWeekdayInMonth(year, month0, jsDay);
                totalMinutes += perDayMinutes * occ;
                if (perDayMinutes > 0) totalDays += occ;
            });
            return { monthlyMinutes: totalMinutes, monthlyDaysCount: totalDays };
        }

        function countWeekdayInMonth(year, month0, jsDay) {
            const lastDay = new Date(year, month0 + 1, 0).getDate();
            let count = 0;
            for (let d = 1; d <= lastDay; d++) {
                const day = new Date(year, month0, d).getDay();
                if (day === jsDay) count++;
            }
            return count;
        }

        function toKRW(n) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(n||0);
        }
        function setText(el, txt){ if (el) el.textContent = txt; }

    })();
</script>

{{>layouts/footer}}
