{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ ì™¼ìª½: ìƒíƒœë³„ ê·¼ë¬´ì ë¦¬ìŠ¤íŠ¸ ============ -->
        <div class="col-12 col-lg-4">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ìƒíƒœë³„ ê·¼ë¬´ì</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">ì¶”ê°€ë“±ë¡</a>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                            <select id="statusSelect" class="form-select">
                                <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                                <option value="WAITING">ì‹œì‘ì „</option>
                                <option value="RESTING">íœ´ì‹ì¤‘</option>
                                <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                <option value="RESIGNED">í‡´ì‚¬</option>
                            </select>
                            <div class="form-text">ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ì™€ ìš°ì¸¡ ê¸‰ì—¬ í…Œì´ë¸”ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
                        </div>

                        <hr>

                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">ê·¼ë¬´ì ëª©ë¡</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0ëª…</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS ë Œë” -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ ì˜¤ë¥¸ìª½: ì›”ë‹¨ìœ„ ê¸‰ì—¬ í…Œì´ë¸” ============ -->
        <div class="col-12 col-lg-8">
            <div class="pay-right-wrapper">

                <!-- ğŸ”¼ ìƒë‹¨: ì œëª© + ì›” ë‚´ë¹„ (ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ê³ ì •) -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 sticky-pay-header">
                    <div>
                        <span class="fw-bold h5 mb-0" id="pageTitle">ê¸‰ì—¬ ê´€ë¦¬</span>
                        <span id="selectedMemberName" class="ms-2 text-primary fw-semibold"></span>
                        <span id="selectedMemberStatus" class="badge bg-secondary ms-2 d-none">-</span>
                    </div>

                    <!-- ì›”ë‹¨ìœ„ ë‚´ë¹„ -->
                    <div id="monthNav" class="d-flex align-items-center small text-muted gap-2">
                        <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">â—€ ì´ì „ ë‹¬</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthThis">ì´ë²ˆ ë‹¬</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthNext">ë‹¤ìŒ ë‹¬ â–¶</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header fw-bold">
                        <span>ì›”ë‹¨ìœ„ ê¸‰ì—¬ í…Œì´ë¸”</span>
                    </div>
                    <div class="card-body">

                        <!-- ì•ˆë‚´ -->
                        <div class="small text-muted mb-2">
                            ì¢Œì¸¡ì—ì„œ ê·¼ë¬´ìë¥¼ ì„ íƒí•˜ë©´, í•´ë‹¹ ê·¼ë¬´ìì˜
                            <b>ì›”ë‹¨ìœ„ ì‹¤ì œ ê·¼ë¬´ì‹œê°„</b>ê³¼ <b>ì£¼ë³„ í•©ê³„ / ì£¼íœ´ìˆ˜ë‹¹ / ê·¼ë¬´ìˆ˜ë‹¹</b>,
                            <b>ì›” í•©ê³„ / ì‹¤ìˆ˜ë ¹ì•¡</b>ì´ ê³„ì‚°ë©ë‹ˆë‹¤.
                        </div>

                        <!-- ì›”ë‹¨ìœ„ ìº˜ë¦°ë” ëª¨ì–‘ í…Œì´ë¸” -->
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle text-center" id="monthPayTable">
                                <thead class="table-light">
                                <tr>
                                    <th style="width:90px;">ì£¼ì°¨</th>
                                    <th>ì›”</th>
                                    <th>í™”</th>
                                    <th>ìˆ˜</th>
                                    <th>ëª©</th>
                                    <th>ê¸ˆ</th>
                                    <th class="bg-light">í† </th>
                                    <th class="bg-light">ì¼</th>
                                    <th style="width:120px;" class="text-end">ì£¼ ì‹¤ê·¼ë¬´</th>
                                    <th style="width:170px;" class="text-end">ì£¼ ì£¼íœ´ìˆ˜ë‹¹<br>(ê·¼ë¬´ì‹œê°„/5)</th>
                                    <th style="width:130px;" class="text-end">ì£¼ ê·¼ë¬´ìˆ˜ë‹¹</th>
                                </tr>
                                </thead>
                                <tbody id="monthPayBody">
                                <!-- JS ë Œë” -->
                                </tbody>
                            </table>
                        </div>

                        <!-- ì›” í•˜ë‹¨ ìš”ì•½ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì‹œê¸‰</div>
                                <div id="summaryHourlyWage">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ì‹¤ê·¼ë¬´ í•©ê³„</div>
                                <div id="summaryMonthWorkTime">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ê·¼ë¬´ìˆ˜ë‹¹ (ì‹¤ê·¼ë¬´ Ã— ì‹œê¸‰)</div>
                                <div id="summaryMonthWorkPay">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì›” ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„</div>
                                <div id="summaryMonthJuhyuPay">-</div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="small fw-bold">ì‹¤ ìˆ˜ë ¹ ì˜ˆìƒì•¡ (ê·¼ë¬´ìˆ˜ë‹¹ + ì£¼íœ´ìˆ˜ë‹¹)</div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="fw-bold text-primary" id="summaryMonthTotal">-</div>
                                </div>
                            </div>

                            <!-- âœ… ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼ë“¤ -->
                            <div class="d-flex justify-content-end gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSaveDraft">
                                    ì„ì‹œì €ì¥
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btnConfirm">
                                    í™•ì •
                                </button>
                                <button type="button" class="btn btn-sm btn-success" id="btnMarkPaid">
                                    ì§€ê¸‰ì™„ë£Œ
                                </button>
                            </div>
                        </div>

                        <div class="small text-muted mt-3">
                            * 1ì£¼ ì‹¤ê·¼ë¬´ì‹œê°„ì´ <b>15ì‹œê°„ ì´ìƒ</b>ì¸ ê²½ìš°ì—ë§Œ í•´ë‹¹ ì£¼ì˜ ì£¼íœ´ìˆ˜ë‹¹ì´ ë°œìƒí•©ë‹ˆë‹¤.<br>
                            * ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„ = <code>ì£¼ ì‹¤ê·¼ë¬´ì‹œê°„ Ã· 5</code> ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. (ì˜ˆ: 30ì‹œê°„ â†’ 6ì‹œê°„ ë¶„ ì£¼íœ´ìˆ˜ë‹¹)<br>
                            * ì›” ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„ëŠ” í•´ë‹¹ ì›”ì— í¬í•¨ëœ ê° ì£¼(ì›”~ì¼)ì˜ ì£¼íœ´ìˆ˜ë‹¹ì„ ëª¨ë‘ í•©ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>

<style>
    /* ì¢Œì¸¡ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ chip ìŠ¤íƒ€ì¼ */
    .member-chip {
        display:flex; align-items:center; justify-content:space-between;
        gap:8px; padding:8px 10px; border-radius:10px;
        background:#fff; border:1px solid #eee; margin-bottom:6px; cursor:pointer;
        transition: background .15s, border-color .15s, box-shadow .15s;
    }
    .member-chip:hover { background:#f8f9fa; }
    .member-chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
    }
    .member-chip.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ìš°ì¸¡ ì „ì²´ ë˜í¼ â€“ sticky ê¸°ì¤€ ì»¨í…Œì´ë„ˆ */
    .pay-right-wrapper {
        position: relative;
    }

    /* âœ… ê¸‰ì—¬ê´€ë¦¬(ì´ë¦„) + ì›” ë‚´ë¹„ ìƒë‹¨ ê³ ì • â€“ í•­ìƒ í”Œë¡œíŒ… */
    .sticky-pay-header {
        position: sticky;
        top: 70px;              /* ìƒë‹¨ navbar(ì•½ 56px) + ì—¬ìœ  */
        z-index: 1030;
        background:#ffffff;
        padding-top: .25rem;
        padding-bottom: .25rem;
    }

    /* âœ… ì£¼ì°¨ í–‰: ìœ„ í–‰ = ë‚ ì§œ(ì—°íšŒìƒ‰), ì•„ë˜ í–‰ = ê·¼ë¬´ì‹œê°„ */
    .day-cell-date,
    .day-cell-time {
        font-size:.8rem;
        padding:4px 2px;
    }

    /* ë‚ ì§œ ì¹¸: í•­ìƒ ì—°íšŒìƒ‰ ë°°ê²½ + í•˜ë‹¨ ê²½ê³„ì„  */
    .day-cell-date {
        font-weight:600;
        background:#f8f9fa;          /* ì—°íšŒìƒ‰ */
        border-bottom:1px solid #dee2e6;
    }

    /* ê·¼ë¬´ì‹œê°„ ì¹¸(ì•„ë˜ì¤„) ê¸°ë³¸ */
    .day-cell-time {
        background:#ffffff;
    }

    /* ë‹¬ ë°–(ì´ì „/ë‹¤ìŒë‹¬) - ë‚ ì§œì¤„/ì‹œê°„ì¤„ ê³µí†µ ê¸€ììƒ‰ë§Œ íë¦¬ê²Œ */
    .day-outside {
        color:#adb5bd;
    }
    /* ë‹¬ ë°– + ê·¼ë¬´ì‹œê°„ì¤„ë§Œ ì‚´ì§ íšŒìƒ‰ ë°°ê²½ */
    .day-cell-time.day-outside {
        background:#fcfcfc;
    }

    /* ì£¼ë§ ê°•ì¡°ëŠ” "ê·¼ë¬´ì‹œê°„ ì¤„"ì—ë§Œ ì ìš© */
    .day-cell-time.day-weekend {
        background:#fff8f0;
    }

    /* ìš”ì•½ ìˆ«ì ì˜¤ë¥¸ìª½ ì •ë ¬ */
    #summaryHourlyWage,
    #summaryMonthWorkTime,
    #summaryMonthWorkPay,
    #summaryMonthJuhyuPay,
    #summaryMonthTotal {
        text-align:right;
    }
</style>

<!-- âœ… ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ì˜ì—­ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <div id="mainToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">
                ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function() {
        const API_BASE_ACTUAL = '/api/schedule';   // GET /{memberId}/{startIso}/{endIso}
        const PAYROLL_SAVE_API = '/api/payroll/month'; // ê¸‰ì—¬ ì €ì¥/í™•ì •/ì§€ê¸‰ API

        // ì¢Œì¸¡
        const statusSelect         = document.getElementById('statusSelect');
        const memberList           = document.getElementById('memberList');
        const memberCountBadge     = document.getElementById('memberCountBadge');

        // ìš°ì¸¡ ìƒë‹¨
        const pageTitle            = document.getElementById('pageTitle');
        const selectedMemberNameEl = document.getElementById('selectedMemberName');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');
        const monthRangeLabel      = document.getElementById('monthRangeLabel');
        const btnMonthPrev         = document.getElementById('btnMonthPrev');
        const btnMonthThis         = document.getElementById('btnMonthThis');
        const btnMonthNext         = document.getElementById('btnMonthNext');

        // ìš°ì¸¡ í…Œì´ë¸”
        const monthPayBody         = document.getElementById('monthPayBody');

        // ì›” í•˜ë‹¨ ìš”ì•½
        const summaryHourlyWage    = document.getElementById('summaryHourlyWage');
        const summaryMonthWorkTime = document.getElementById('summaryMonthWorkTime');
        const summaryMonthWorkPay  = document.getElementById('summaryMonthWorkPay');
        const summaryMonthJuhyuPay = document.getElementById('summaryMonthJuhyuPay');
        const summaryMonthTotal    = document.getElementById('summaryMonthTotal');

        // ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼
        const btnSaveDraft         = document.getElementById('btnSaveDraft');
        const btnConfirm           = document.getElementById('btnConfirm');
        const btnMarkPaid          = document.getElementById('btnMarkPaid');

        // í† ìŠ¤íŠ¸
        const toastEl              = document.getElementById('mainToast');
        const toastBodyEl          = document.getElementById('mainToastBody');

        // ìƒíƒœ
        let allMembers = [];
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        let currentMember = null;
        let selectedMemberId = null;
        let currentMonthStart = firstDayOfMonth(new Date()); // í˜„ì¬ ë‹¬ 1ì¼

        // ìµœê·¼ ê³„ì‚°ëœ ì›” ê¸‰ì—¬ ë°ì´í„° (API ì „ì†¡ìš©)
        let lastPayrollPayload = null;

        // ìƒíƒœ ì´ˆê¸°ê°’
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        btnMonthPrev.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() - 1, 1);
            reloadForCurrentMember();
        });
        btnMonthThis.addEventListener('click', function() {
            currentMonthStart = firstDayOfMonth(new Date());
            reloadForCurrentMember();
        });
        btnMonthNext.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() + 1, 1);
            reloadForCurrentMember();
        });

        // ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        btnSaveDraft.addEventListener('click', function () {
            savePayrollWithStatus('DRAFT', 'ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        btnConfirm.addEventListener('click', function () {
            savePayrollWithStatus('CONFIRMED', 'ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        btnMarkPaid.addEventListener('click', function () {
            savePayrollWithStatus('PAID', 'ì§€ê¸‰ì™„ë£Œë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });

        // ì´ˆê¸° ì‹¤í–‰
        handleStatusChange();

        // ===== ìƒíƒœ ë³€ê²½ ì‹œ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  =====
        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered.length) {
                const keep = filtered.find(m => String(m.id) === String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            } else {
                selectedMemberId = null;
                currentMember = null;
                clearRight();
            }
        }

        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = members.length + 'ëª…';

            members
                    .slice()
                    .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item member-chip';
                        li.dataset.memberId = String(m.id);
                        const color = colorForMember(m);

                        li.innerHTML = `
                    <span class="left d-inline-flex align-items-center gap-2">
                        <span class="dot" style="background:${color}"></span>
                        <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
                        <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
                    </span>
                    <button type="button"
                            class="btn btn-sm btn-outline-primary view-btn"
                            data-id="${String(m.id)}">ìƒì„¸</button>
                `;
                        memberList.appendChild(li);
                    });

            if (!members.length) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = 'í•´ë‹¹ ìƒíƒœì˜ ê·¼ë¬´ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                memberList.appendChild(li);
            }

            updateMemberListActive();
        }

        function onMemberListClick(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                const id = btn.getAttribute('data-id');
                if (id) window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
                return;
            }

            const li = e.target.closest('li.member-chip');
            if (!li) return;
            const id = li.dataset.memberId;
            const members = (allMembers || []).filter(m => m.status === statusSelect.value);
            const target = members.find(m => String(m.id) === String(id));
            if (target) selectMember(target);
        }

        function selectMember(member) {
            currentMember = member;
            selectedMemberId = member.id;
            updateMemberListActive();
            renderMemberHeader(member);
            reloadForCurrentMember();
        }

        function updateMemberListActive() {
            Array.from(memberList.querySelectorAll('.member-chip')).forEach(li => {
                li.classList.toggle('active', li.dataset.memberId === String(selectedMemberId));
            });
        }

        function renderMemberHeader(member) {
            if (!member) {
                pageTitle.textContent = 'ê¸‰ì—¬ ê´€ë¦¬';
                selectedMemberNameEl.textContent = '';
                selectedMemberStatus.classList.add('d-none');
                selectedMemberStatus.textContent = '-';
                selectedMemberStatus.className = 'badge bg-secondary d-none';
                return;
            }
            pageTitle.textContent = 'ê¸‰ì—¬ ê´€ë¦¬';
            selectedMemberNameEl.textContent = `(${member.name ?? '-'})`;
            const badgeMap = {
                WORKING: 'bg-success',
                WAITING: 'bg-secondary',
                RESTING: 'bg-info',
                PAUSED: 'bg-warning',
                RESIGNED: 'bg-danger'
            };
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member.status || '-';
            selectedMemberStatus.className = `badge ${badgeMap[member.status] || 'bg-secondary'} ms-2`;
        }

        function clearRight() {
            monthPayBody.innerHTML = '';
            monthRangeLabel.textContent = '0000.00.01 ~ 00.00';
            summaryHourlyWage.textContent    = '-';
            summaryMonthWorkTime.textContent = '0ì‹œê°„';
            summaryMonthWorkPay.textContent  = '-';
            summaryMonthJuhyuPay.textContent = '-';
            summaryMonthTotal.textContent    = '-';
            lastPayrollPayload = null;
            renderMemberHeader(null);
        }

        function reloadForCurrentMember() {
            if (!currentMember) {
                clearRight();
                return;
            }
            loadMonthData(currentMember, currentMonthStart);
        }

        // ===== ì›” ë°ì´í„° ë¡œë”© & í…Œì´ë¸” ë Œë” =====
        async function loadMonthData(member, monthStartDate) {
            const ms   = firstDayOfMonth(monthStartDate);
            const me   = lastDayOfMonth(monthStartDate);
            const msIso = toIso(ms);
            const meIso = toIso(me);

            // ìƒë‹¨ ë¼ë²¨: 2025.03.01 ~ 03.31
            const leftY = ms.getFullYear();
            const leftM = pad2(ms.getMonth()+1);
            const leftD = '01';
            const rightM = pad2(me.getMonth()+1);
            const rightD = pad2(me.getDate());
            monthRangeLabel.textContent = `${leftY}.${leftM}.${leftD} ~ ${rightM}.${rightD}`;

            // ì‹¤ì œ ê·¼ë¬´ ë°ì´í„° í˜¸ì¶œ
            let dayMap = {};
            try {
                const url = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${msIso}/${meIso}`;
                const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                if (resp.ok) {
                    const data = await resp.json();
                    dayMap = normalizeDays(data);  // 'YYYY-MM-DD' -> {segments, minutes}
                }
            } catch (e) {
                console.error('loadMonthData error', e);
                dayMap = {};
            }

            renderMonthPayTable(member, ms, me, dayMap);
        }

        function renderMonthPayTable(member, ms, me, dayMap) {
            monthPayBody.innerHTML = '';

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            summaryHourlyWage.textContent =
                    (wage != null) ? krw(wage) : '-';

            let monthMinutes = 0;
            let monthJuhyuMinutes = 0;

            // ì´ ë‹¬ 1ì¼ì´ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ë¶€í„°, ì´ ë‹¬ ë§ˆì§€ë§‰ ë‚ ì´ ì†í•œ ì£¼ê¹Œì§€
            const weeks = [];
            let wStart = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd) {
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate() + 7);
            }

            let weekIndex = 0;

            weeks.forEach(weekStart => {
                const weekEnd = addDays(weekStart, 6);

                const dateTds = [];
                const timeTds = [];
                let weekMinutes = 0;

                for (let i=0;i<7;i++){
                    const dayDate = addDays(weekStart, i);
                    const iso     = toIso(dayDate);
                    const inMonth = (dayDate >= ms && dayDate <= me);
                    const info    = inMonth ? (dayMap[iso] || { segments:[], minutes:0 }) : { segments:[], minutes:0 };
                    const dayMinutes = info.minutes || 0;

                    if (inMonth) {
                        weekMinutes  += dayMinutes;
                        monthMinutes += dayMinutes;
                    }

                    const dayNum    = dayDate.getDate();
                    const isWeekend = (i >= 5); // í† ,ì¼
                    const cls = [
                        !inMonth ? 'day-outside' : '',
                        inMonth && isWeekend ? 'day-weekend' : ''
                    ].filter(Boolean).join(' ');

                    const timeLabel = inMonth && dayMinutes > 0
                            ? formatMins(dayMinutes)
                            : (inMonth ? '-' : '');

                    dateTds.push(`<td class="day-cell-date ${cls}">${inMonth ? dayNum : ''}</td>`);
                    timeTds.push(`<td class="day-cell-time ${cls}">${timeLabel}</td>`);
                }

                // ì´ ì£¼ì˜ ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„(ë¶„)
                const juhyuMinutes = calcWeeklyJuhyuMinutes(weekMinutes);
                monthJuhyuMinutes += juhyuMinutes;

                // ì£¼ë³„ ê¸ˆì•¡
                let weekWorkPay = null;
                let weekJuhyuPay = null;
                if (wage != null) {
                    weekWorkPay  = Math.round((weekMinutes/60)   * wage);
                    weekJuhyuPay = Math.round((juhyuMinutes/60)  * wage);
                }

                const weekWorkLabel = formatMins(weekMinutes);

                // ì£¼ì°¨ ë¼ë²¨: 1ì£¼ì°¨ (MM.DD ~ MM.DD)
                const weekLabelRange =
                        `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())}` +
                        ` ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                // ì£¼íœ´ìˆ˜ë‹¹ ì…€ ë‚´ìš©
                let weekJuhyuCellHtml = '-';
                if (juhyuMinutes > 0 && weekJuhyuPay != null) {
                    const juhyuTimeLabel = formatMins(juhyuMinutes);
                    const weekTimeLabel  = formatMins(weekMinutes);
                    const juhyuMoneyLabel = krw(weekJuhyuPay);
                    weekJuhyuCellHtml =
                            `(${weekTimeLabel}/5) <br>= ${juhyuTimeLabel}<br>${juhyuMoneyLabel}`;
                }

                const weekPayLabel = (weekWorkPay != null) ? krw(weekWorkPay) : '-';

                // ë‘ ì¤„ì§œë¦¬ ì£¼ì°¨ ë¸”ë¡
                const trDates = document.createElement('tr');
                trDates.innerHTML = `
                <th scope="row" rowspan="2">
                    ${++weekIndex}ì£¼ì°¨<br>
                    <small class="text-muted">(${weekLabelRange})</small>
                </th>
                ${dateTds.join('')}
                <td class="text-end" rowspan="2">${weekWorkLabel}</td>
                <td class="text-end" rowspan="2">${weekJuhyuCellHtml}</td>
                <td class="text-end" rowspan="2">${weekPayLabel}</td>
            `;

                const trTimes = document.createElement('tr');
                trTimes.innerHTML = timeTds.join('');

                monthPayBody.appendChild(trDates);
                monthPayBody.appendChild(trTimes);
            });

            // ì›” í•©ê³„/ê¸ˆì•¡
            summaryMonthWorkTime.textContent = formatMins(monthMinutes);

            let monthWorkPay = null;
            let monthJuhyuPay = null;
            let monthTotal = null;

            if (wage != null) {
                monthWorkPay  = Math.round((monthMinutes/60)      * wage);
                monthJuhyuPay = Math.round((monthJuhyuMinutes/60) * wage);
                monthTotal    = monthWorkPay + monthJuhyuPay;
            }

            summaryMonthWorkPay.textContent  = (monthWorkPay  != null) ? krw(monthWorkPay)  : '-';
            summaryMonthJuhyuPay.textContent = (monthJuhyuPay != null) ? krw(monthJuhyuPay) : '-';
            summaryMonthTotal.textContent    = (monthTotal    != null) ? krw(monthTotal)    : '-';

            // API ì „ì†¡ìš© í˜ì´ë¡œë“œ ë³´ê´€
            if (currentMember && wage != null && monthWorkPay != null && monthJuhyuPay != null && monthTotal != null) {
                lastPayrollPayload = {
                    memberId: currentMember.id,
                    payYear: ms.getFullYear(),
                    payMonth: ms.getMonth() + 1,
                    hourlyWage: wage,
                    monthWorkMinutes: monthMinutes,
                    monthJuhyuMinutes: monthJuhyuMinutes,
                    monthWorkPay: monthWorkPay,
                    monthJuhyuPay: monthJuhyuPay,
                    monthTotalPay: monthTotal
                };
            } else {
                lastPayrollPayload = null;
            }
        }

        // ===== ê¸‰ì—¬ ì €ì¥/í™•ì •/ì§€ê¸‰ API í˜¸ì¶œ =====
        async function savePayrollWithStatus(status, successMessage) {
            if (!currentMember) {
                showToast('ë¨¼ì € ê·¼ë¬´ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            if (!lastPayrollPayload) {
                showToast('ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì›” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            const payload = {
                ...lastPayrollPayload,
                status: status   // DRAFT / CONFIRMED / PAID
            };

            try {
                const resp = await fetch(PAYROLL_SAVE_API, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    console.error('payroll save error', resp.status, text);
                    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }

                showToast(successMessage || 'ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (e) {
                console.error('payroll save fetch error', e);
                showToast('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ===== í† ìŠ¤íŠ¸ í—¬í¼ =====
        function showToast(message, type) {
            if (!toastEl || !toastBodyEl) return;
            toastBodyEl.textContent = message;

            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            if (type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            } else if (type === 'info') {
                toastEl.classList.add('text-bg-info');
            } else {
                toastEl.classList.add('text-bg-success');
            }

            if (window.bootstrap && bootstrap.Toast) {
                const t = bootstrap.Toast.getOrCreateInstance(toastEl);
                t.show();
            } else {
                toastEl.style.display = 'block';
                setTimeout(() => { toastEl.style.display = 'none'; }, 2000);
            }
        }

        // ===== ìœ í‹¸ í•¨ìˆ˜ë“¤ =====
        function firstDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth(), 1);
        }
        function lastDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth()+1, 0);
        }
        function toIso(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        function pad2(n) {
            return String(n).padStart(2,'0');
        }
        function addDays(d, n) {
            const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            x.setDate(x.getDate()+n);
            return x;
        }
        function toMonday(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const w = d.getDay();         // 0=ì¼, 1=ì›”, ..., 6=í† 
            const offset = (w + 6) % 7;   // ì›”ìš”ì¼ ê¸°ì¤€
            d.setDate(d.getDate() - offset);
            return d;
        }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60);
            const m = v % 60;
            return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function krw(v) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        // API ì‘ë‹µ -> dateë³„ {segments, minutes}
        function normalizeDays(apiData) {
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d => {
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes === 'number')
                        ? d.minutes
                        : segments.reduce((acc,s)=> acc + diffMinutes(s.start, s.end), 0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function diffMinutes(start, end) {
            const s = parseHm(start);
            const e = parseHm(end);
            return (e.h*60 + e.m) - (s.h*60 + s.m);
        }
        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        // ì£¼ê°„ ì£¼íœ´ìˆ˜ë‹¹ "ë¶„" ê³„ì‚°
        function calcWeeklyJuhyuMinutes(weeklyMinutes) {
            if (!weeklyMinutes || weeklyMinutes < 15*60) return 0;
            return Math.round(weeklyMinutes / 5);
        }

        function colorForMember(m) {
            const key = (m?.id != null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key) % 360, s = 65, l = 55;
            return hslToHex(h, s, l);
        }
        function seededHash(str) {
            let h = 2166136261 >>> 0;
            for (let i=0;i<str.length;i++) {
                h ^= str.charCodeAt(i);
                h = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }
        function hslToHex(h,s,l) {
            s/=100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1-l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer}}
