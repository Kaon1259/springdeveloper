{{>layouts/header}}

<main class="container my-4">

    <!-- ============ ìƒë‹¨: ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸° (ì¹© ë¦¬ìŠ¤íŠ¸) ============ -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</span>
            <a href="/members/new" class="btn btn-sm btn-primary">ì¶”ê°€ë“±ë¡</a>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- ìƒíƒœ ì„ íƒ -->
                <div class="col-12 col-md-4">
                    <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>
                    <div class="form-text">
                        ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì•„ë˜ ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ì™€ ê¸‰ì—¬ í…Œì´ë¸”ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ (ì¹© UI) -->
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">ì•„ë¥´ë°”ì´íŠ¸ ëª©ë¡</div>
                        <span id="memberCountBadge" class="badge bg-light text-dark">0ëª…</span>
                    </div>

                    <!-- ì¹© ë¦¬ìŠ¤íŠ¸ -->
                    <div id="memberPills" class="vlist">
                        <!-- JS ë Œë” -->
                    </div>

                    <div class="small text-muted mt-2">
                        * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤. (ê¸‰ì—¬ í…Œì´ë¸”ê³¼ ë‹¤ë¥¸ í™”ë©´ì—ì„œë„ ë™ì¼ ìƒ‰ìƒ ì‚¬ìš© ì˜ˆì •)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ í•˜ë‹¨: ì›”ë‹¨ìœ„ ê¸‰ì—¬ í…Œì´ë¸” ============ -->
    <div class="pay-right-wrapper">

        <!-- ğŸ”¼ ìƒë‹¨: ì œëª© + ì›” ë‚´ë¹„ (ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ê³ ì •) -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 sticky-pay-header">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <div>
                    <span class="fw-bold h5 mb-0" id="pageTitle">ê¸‰ì—¬ ê´€ë¦¬</span>
                    <span id="selectedMemberName" class="ms-2 text-primary fw-semibold"></span>
                    <span id="selectedMemberStatus" class="badge bg-secondary ms-2 d-none">-</span>
                </div>
                <!-- âœ… ê¸‰ì—¬ ì €ì¥ ìƒíƒœ ë°°ì§€ -->
                <span id="payrollStatusBadge" class="badge ms-2 d-none">-</span>
            </div>

            <!-- ì›”ë‹¨ìœ„ ë‚´ë¹„ -->
            <div id="monthNav" class="d-flex align-items-center small text-muted gap-2">
                <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">â—€ ì´ì „ ë‹¬</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthThis">ì´ë²ˆ ë‹¬</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthNext">ë‹¤ìŒ ë‹¬ â–¶</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header fw-bold">
                <span>ì›”ë‹¨ìœ„ ê¸‰ì—¬ í…Œì´ë¸”</span>
            </div>
            <div class="card-body">

                <!-- ì•ˆë‚´ -->
                <div class="small text-muted mb-2">
                    ìœ„ì—ì„œ ê·¼ë¬´ìë¥¼ ì„ íƒí•˜ë©´, í•´ë‹¹ ê·¼ë¬´ìì˜
                    <b>ì›”ë‹¨ìœ„ ì‹¤ì œ ê·¼ë¬´ì‹œê°„</b>ê³¼ <b>ì£¼ë³„ í•©ê³„ / ì£¼íœ´ìˆ˜ë‹¹ / ê·¼ë¬´ìˆ˜ë‹¹</b>,
                    <b>ì›” í•©ê³„ / ì‹¤ìˆ˜ë ¹ì•¡</b>ì´ ê³„ì‚°ë©ë‹ˆë‹¤.
                </div>

                <!-- ì›”ë‹¨ìœ„ ìº˜ë¦°ë” ëª¨ì–‘ í…Œì´ë¸” -->
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center" id="monthPayTable">
                        <thead class="table-light">
                        <tr>
                            <th style="width:90px;">ì£¼ì°¨</th>
                            <th>ì›”</th>
                            <th>í™”</th>
                            <th>ìˆ˜</th>
                            <th>ëª©</th>
                            <th>ê¸ˆ</th>
                            <th class="bg-light">í† </th>
                            <th class="bg-light">ì¼</th>
                            <th style="width:120px;" class="text-end">ì£¼ ì‹¤ê·¼ë¬´</th>
                            <th style="width:170px;" class="text-end">ì£¼ ì£¼íœ´ìˆ˜ë‹¹<br>(ê·¼ë¬´ì‹œê°„/5)</th>
                            <th style="width:130px;" class="text-end">ì£¼ ê·¼ë¬´ìˆ˜ë‹¹</th>
                        </tr>
                        </thead>
                        <tbody id="monthPayBody">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>

                <!-- ì›” í•˜ë‹¨ ìš”ì•½ -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between">
                        <div class="small text-muted">ì‹œê¸‰</div>
                        <div id="summaryHourlyWage">-</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="small text-muted">ì›” ì‹¤ê·¼ë¬´ í•©ê³„</div>
                        <div id="summaryMonthWorkTime">0ì‹œê°„</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="small text-muted">ì›” ê·¼ë¬´ìˆ˜ë‹¹ (ì‹¤ê·¼ë¬´ Ã— ì‹œê¸‰)</div>
                        <div id="summaryMonthWorkPay">-</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="small text-muted">ì›” ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„</div>
                        <div id="summaryMonthJuhyuPay">-</div>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small fw-bold">ì‹¤ ìˆ˜ë ¹ ì˜ˆìƒì•¡ (ê·¼ë¬´ìˆ˜ë‹¹ + ì£¼íœ´ìˆ˜ë‹¹)</div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="fw-bold text-primary" id="summaryMonthTotal">-</div>
                        </div>
                    </div>

                    <!-- ğŸ”½ ì€í–‰ì •ë³´ + ë²„íŠ¼ í•œ ì¤„ -->
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <!-- ì™¼ìª½: ì€í–‰ / ê³„ì¢Œ / (ì§€ê¸‰ì™„ë£Œì¼) -->
                        <div class="small text-muted" id="bankInfoArea">
                            ì€í–‰:
                            <span id="bankName">-</span>
                            &nbsp;ê³„ì¢Œë²ˆí˜¸:
                            <span id="bankAccount">-</span>
                            <span id="paidDateLabel" class="ms-2 text-success d-none">
                                (ì§€ê¸‰ì™„ë£Œì¼:
                                <span id="paidDateValue"></span>
                                )
                            </span>
                        </div>

                        <!-- ì˜¤ë¥¸ìª½: ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼ë“¤ -->
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSaveDraft">
                                ì„ì‹œì €ì¥
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnConfirm">
                                í™•ì •
                            </button>
                            <button type="button" class="btn btn-sm btn-success" id="btnMarkPaid">
                                ì§€ê¸‰ì™„ë£Œ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="small text-muted mt-3">
                    * 1ì£¼ ì‹¤ê·¼ë¬´ì‹œê°„ì´ <b>15ì‹œê°„ ì´ìƒ</b>ì¸ ê²½ìš°ì—ë§Œ í•´ë‹¹ ì£¼ì˜ ì£¼íœ´ìˆ˜ë‹¹ì´ ë°œìƒí•©ë‹ˆë‹¤.<br>
                    * ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„ = <code>ì£¼ ì‹¤ê·¼ë¬´ì‹œê°„ Ã· 5</code> ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. (ì˜ˆ: 30ì‹œê°„ â†’ 6ì‹œê°„ ë¶„ ì£¼íœ´ìˆ˜ë‹¹)<br>
                    * ì›” ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„ëŠ” í•´ë‹¹ ì›”ì— í¬í•¨ëœ ê° ì£¼(ì›”~ì¼)ì˜ ì£¼íœ´ìˆ˜ë‹¹ì„ ëª¨ë‘ í•©ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    /* ===== ìƒë‹¨ ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸: ì¹© ìŠ¤íƒ€ì¼ ===== */
    .vlist {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .pill:hover {
        background:#fafafa;
        border-color:#dee2e6;
    }
    .pill.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name {
        font-weight:600;
    }
    .pill .meta {
        color:#6c757d;
        font-size:.8rem;
    }

    /* ê¸‰ì—¬ í…Œì´ë¸” ë˜í¼ â€“ sticky ê¸°ì¤€ ì»¨í…Œì´ë„ˆ */
    .pay-right-wrapper {
        position: relative;
    }

    /* âœ… ê¸‰ì—¬ê´€ë¦¬(ì´ë¦„) + ì›” ë‚´ë¹„ ìƒë‹¨ ê³ ì • */
    .sticky-pay-header {
        position: sticky;
        top: 70px;
        z-index: 1030;
        background:#ffffff;
        padding-top: .25rem;
        padding-bottom: .25rem;
    }

    /* âœ… ì£¼ì°¨ í–‰: ìœ„ í–‰ = ë‚ ì§œ(ì—°íšŒìƒ‰), ì•„ë˜ í–‰ = ê·¼ë¬´ì‹œê°„ */
    .day-cell-date,
    .day-cell-time {
        font-size:.8rem;
        padding:4px 2px;
    }

    .day-cell-date {
        font-weight:600;
        background:#f8f9fa;
        border-bottom:1px solid #dee2e6;
    }

    .day-cell-time {
        background:#ffffff;
    }

    .day-outside {
        color:#adb5bd;
    }
    .day-cell-time.day-outside {
        background:#fcfcfc;
    }

    .day-cell-time.day-weekend {
        background:#fff8f0;
    }

    #summaryHourlyWage,
    #summaryMonthWorkTime,
    #summaryMonthWorkPay,
    #summaryMonthJuhyuPay,
    #summaryMonthTotal {
        text-align:right;
    }

    /* âœ… ë‹¤ìŒ ì•¡ì…˜ í•˜ì´ë¼ì´íŠ¸ìš© */
    .pay-action-next {
        box-shadow: 0 0 0 2px rgba(13,110,253,.35);
        transform: translateY(-1px);
    }
</style>

<!-- âœ… ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ì˜ì—­ -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <div id="mainToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">
                ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- âœ… ì§€ê¸‰ì™„ë£Œ ì¼ì ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="paidDateModal" tabindex="-1" aria-labelledby="paidDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paidDateModalLabel">ì§€ê¸‰ì™„ë£Œ ì¼ì</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <label for="paidDateInput" class="form-label small">ì§€ê¸‰ì™„ë£Œ ì¼ì</label>
                <input type="date" class="form-control" id="paidDateInput">
                <div class="invalid-feedback">
                    ì§€ê¸‰ì™„ë£Œ ì¼ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
                </div>
                <div class="form-text">
                    ê¸°ë³¸ê°’ì€ ì˜¤ëŠ˜ì…ë‹ˆë‹¤.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-sm btn-primary" id="btnPaidDateConfirm">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function() {
        const API_BASE_ACTUAL = '/api/schedule';   // GET /{memberId}/{startIso}/{endIso}
        const PAYROLL_SAVE_API = '/api/payroll/month';

        // ìƒë‹¨ ìƒíƒœ/ë¦¬ìŠ¤íŠ¸
        const statusSelect         = document.getElementById('statusSelect');
        const memberPills          = document.getElementById('memberPills');
        const memberCountBadge     = document.getElementById('memberCountBadge');

        // ìš°ì¸¡ ìƒë‹¨
        const pageTitle            = document.getElementById('pageTitle');
        const selectedMemberNameEl = document.getElementById('selectedMemberName');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');
        const payrollStatusBadge   = document.getElementById('payrollStatusBadge');
        const monthRangeLabel      = document.getElementById('monthRangeLabel');
        const btnMonthPrev         = document.getElementById('btnMonthPrev');
        const btnMonthThis         = document.getElementById('btnMonthThis');
        const btnMonthNext         = document.getElementById('btnMonthNext');

        // ìš°ì¸¡ í…Œì´ë¸”
        const monthPayBody         = document.getElementById('monthPayBody');

        // ì›” í•˜ë‹¨ ìš”ì•½
        const summaryHourlyWage    = document.getElementById('summaryHourlyWage');
        const summaryMonthWorkTime = document.getElementById('summaryMonthWorkTime');
        const summaryMonthWorkPay  = document.getElementById('summaryMonthWorkPay');
        const summaryMonthJuhyuPay = document.getElementById('summaryMonthJuhyuPay');
        const summaryMonthTotal    = document.getElementById('summaryMonthTotal');

        // ì€í–‰/ê³„ì¢Œ/ì§€ê¸‰ì™„ë£Œì¼ UI
        const bankNameEl           = document.getElementById('bankName');
        const bankAccountEl        = document.getElementById('bankAccount');
        const paidDateLabelEl      = document.getElementById('paidDateLabel');
        const paidDateValueEl      = document.getElementById('paidDateValue');

        // ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼
        const btnSaveDraft         = document.getElementById('btnSaveDraft');
        const btnConfirm           = document.getElementById('btnConfirm');
        const btnMarkPaid          = document.getElementById('btnMarkPaid');

        // ì§€ê¸‰ì™„ë£Œ ëª¨ë‹¬
        const paidDateModalEl      = document.getElementById('paidDateModal');
        const paidDateInput        = document.getElementById('paidDateInput');
        const btnPaidDateConfirm   = document.getElementById('btnPaidDateConfirm');

        // í† ìŠ¤íŠ¸
        const toastEl              = document.getElementById('mainToast');
        const toastBodyEl          = document.getElementById('mainToastBody');

        // ìƒíƒœ
        let allMembers = [];
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        let currentMember = null;
        let selectedMemberId = null;
        let currentMonthStart = firstDayOfMonth(new Date()); // í˜„ì¬ ë‹¬ 1ì¼

        // ìµœê·¼ ê³„ì‚°ëœ ì›” ê¸‰ì—¬ ë°ì´í„° (API ì „ì†¡ìš©)
        let lastPayrollPayload = null;

        // í˜„ì¬ ì €ì¥ëœ ê¸‰ì—¬ ìƒíƒœ (ì„œë²„ ê¸°ì¤€) : null / 'DRAFT' / 'CONFIRMED' / 'PAID'
        let currentPayrollStatus = null;
        // í˜„ì¬ ì €ì¥ëœ ì§€ê¸‰ì™„ë£Œì¼ (ì„œë²„ ê¸°ì¤€)
        let currentPaidDate = null;

        // ìƒíƒœ ì´ˆê¸°ê°’
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        statusSelect.addEventListener('change', handleStatusChange);

        btnMonthPrev.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() - 1, 1);
            reloadForCurrentMember();
        });
        btnMonthThis.addEventListener('click', function() {
            currentMonthStart = firstDayOfMonth(new Date());
            reloadForCurrentMember();
        });
        btnMonthNext.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() + 1, 1);
            reloadForCurrentMember();
        });

        // ê¸‰ì—¬ ìƒíƒœ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        btnSaveDraft.addEventListener('click', function () {
            savePayrollWithStatus('DRAFT', 'ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        btnConfirm.addEventListener('click', function () {
            savePayrollWithStatus('CONFIRMED', 'ê¸‰ì—¬ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        btnMarkPaid.addEventListener('click', onMarkPaidClick);

        // ì§€ê¸‰ì™„ë£Œ ëª¨ë‹¬ì—ì„œ "ì €ì¥" í´ë¦­
        if (btnPaidDateConfirm) {
            btnPaidDateConfirm.addEventListener('click', function () {
                if (!paidDateInput) return;
                const dateValue = paidDateInput.value;
                if (!dateValue) {
                    paidDateInput.classList.add('is-invalid');
                    return;
                }
                paidDateInput.classList.remove('is-invalid');

                // ì„ íƒí•œ ë‚ ì§œë¡œ ì§€ê¸‰ì™„ë£Œ ì €ì¥
                savePayrollWithStatus('PAID', 'ì§€ê¸‰ì™„ë£Œë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', dateValue);

                if (window.bootstrap && bootstrap.Modal && paidDateModalEl) {
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(paidDateModalEl);
                    modalInstance.hide();
                }
            });
        }

        // ì´ˆê¸° ì‹¤í–‰
        handleStatusChange();

        // ===== ì§€ê¸‰ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ: ëª¨ë‹¬ ë„ìš°ê¸° =====
        function onMarkPaidClick() {
            if (!currentMember) {
                showToast('ë¨¼ì € ê·¼ë¬´ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            if (!lastPayrollPayload) {
                showToast('ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì›” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            if (!paidDateModalEl || !paidDateInput || !window.bootstrap || !bootstrap.Modal) {
                savePayrollWithStatus('PAID', 'ì§€ê¸‰ì™„ë£Œë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const today = new Date();
            paidDateInput.value = toIso(today); // yyyy-MM-dd
            paidDateInput.classList.remove('is-invalid');

            const modalInstance = bootstrap.Modal.getOrCreateInstance(paidDateModalEl);
            modalInstance.show();
        }

        // ===== ìƒíƒœ ë³€ê²½ ì‹œ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸(ì¹©) ê°±ì‹  =====
        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);
            renderMembersByStatus(filtered);
        }

        function renderMembersByStatus(members) {
            memberPills.innerHTML = '';
            memberCountBadge.textContent = members.length + 'ëª…';

            if (!members.length) {
                memberPills.innerHTML = `<span class="text-muted small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                selectedMemberId = null;
                currentMember = null;
                clearRight();
                return;
            }

            // í˜„ì¬ ì„ íƒ ìœ ì§€ or ì²« ë²ˆì§¸
            let toSelect = null;
            if (currentMember && members.some(m => String(m.id) === String(currentMember.id))) {
                toSelect = members.find(m => String(m.id) === String(currentMember.id));
            } else {
                toSelect = members[0];
            }

            members
                    .slice()
                    .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'pill';
                        btn.dataset.memberId = String(m.id);

                        const color = colorForMember(m);
                        btn.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;

                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            selectMember(m);
                        });

                        memberPills.appendChild(btn);
                    });

            // ì„ íƒ ë°˜ì˜
            selectMember(toSelect);
        }

        function selectMember(member) {
            currentMember = member;
            selectedMemberId = member.id;
            currentPayrollStatus = null;
            currentPaidDate = null;
            updateMemberListActive();
            renderMemberHeader(member);
            setBankInfo(member);
            reloadForCurrentMember();
        }

        function updateMemberListActive() {
            Array.from(memberPills.querySelectorAll('.pill')).forEach(el => {
                el.classList.toggle('active', el.dataset.memberId === String(selectedMemberId));
            });
        }

        function renderMemberHeader(member) {
            if (!member) {
                pageTitle.textContent = 'ê¸‰ì—¬ ê´€ë¦¬';
                selectedMemberNameEl.textContent = '';
                selectedMemberStatus.classList.add('d-none');
                selectedMemberStatus.textContent = '-';
                selectedMemberStatus.className = 'badge bg-secondary d-none';
                updatePayrollStatusUI(null);
                return;
            }
            pageTitle.textContent = 'ê¸‰ì—¬ ê´€ë¦¬';
            selectedMemberNameEl.textContent = `(${member.name ?? '-'})`;
            const badgeMap = {
                WORKING: 'bg-success',
                WAITING: 'bg-secondary',
                RESTING: 'bg-info',
                PAUSED: 'bg-warning',
                RESIGNED: 'bg-danger'
            };
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member.status || '-';
            selectedMemberStatus.className = `badge ${badgeMap[member.status] || 'bg-secondary'} ms-2`;

            updatePayrollStatusUI(currentPayrollStatus);
        }

        function setBankInfo(member) {
            const bankName = member?.bankName?.trim() || 'í•œêµ­ì€í–‰';
            const bankAccount = member?.bankAccount?.trim() || '1234567';

            if (bankNameEl) bankNameEl.textContent = bankName;
            if (bankAccountEl) bankAccountEl.textContent = bankAccount;
        }

        function clearRight() {
            monthPayBody.innerHTML = '';
            monthRangeLabel.textContent = '0000.00.01 ~ 00.00';
            summaryHourlyWage.textContent    = '-';
            summaryMonthWorkTime.textContent = '0ì‹œê°„';
            summaryMonthWorkPay.textContent  = '-';
            summaryMonthJuhyuPay.textContent = '-';
            summaryMonthTotal.textContent    = '-';
            lastPayrollPayload = null;
            currentPayrollStatus = null;
            currentPaidDate = null;

            if (paidDateLabelEl) {
                paidDateLabelEl.classList.add('d-none');
            }
            if (paidDateValueEl) {
                paidDateValueEl.textContent = '';
            }

            renderMemberHeader(null);
        }

        function reloadForCurrentMember() {
            if (!currentMember) {
                clearRight();
                return;
            }
            loadMonthData(currentMember, currentMonthStart);
        }

        // ===== ì›” ë°ì´í„° ë¡œë”© & í…Œì´ë¸” ë Œë” =====
        async function loadMonthData(member, monthStartDate) {
            const ms   = firstDayOfMonth(monthStartDate);
            const me   = lastDayOfMonth(monthStartDate);
            const msIso = toIso(ms);
            const meIso = toIso(me);

            const leftY = ms.getFullYear();
            const leftM = pad2(ms.getMonth()+1);
            const leftD = '01';
            const rightM = pad2(me.getMonth()+1);
            const rightD = pad2(me.getDate());
            monthRangeLabel.textContent = `${leftY}.${leftM}.${leftD} ~ ${rightM}.${rightD}`;

            let dayMap = {};
            try {
                const url = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${msIso}/${meIso}`;
                const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                if (resp.ok) {
                    const data = await resp.json();
                    dayMap = normalizeDays(data);
                }
            } catch (e) {
                console.error('loadMonthData error', e);
                dayMap = {};
            }

            renderMonthPayTable(member, ms, me, dayMap);
            await loadPayrollStatus(member, ms);
        }

        // âœ… ì„œë²„ ì €ì¥ ê¸‰ì—¬ ìƒíƒœ ì¡°íšŒ
        async function loadPayrollStatus(member, monthStartDate) {
            const year  = monthStartDate.getFullYear();
            const month = monthStartDate.getMonth() + 1;

            try {
                const url = `${PAYROLL_SAVE_API}/${encodeURIComponent(member.id)}/${year}/${month}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });

                if (!resp.ok) {
                    currentPayrollStatus = null;
                    currentPaidDate = null;
                    updatePayrollStatusUI(null);
                    return;
                }

                const data = await resp.json();
                const status = (data && data.status) ? String(data.status).toUpperCase() : null;
                currentPayrollStatus = status || null;

                const paidRaw = data && (data.paidDate || data.paidAt) ? String(data.paidDate || data.paidAt) : null;
                currentPaidDate = paidRaw;

                updatePayrollStatusUI(currentPayrollStatus);
            } catch (e) {
                console.error('loadPayrollStatus error', e);
                currentPayrollStatus = null;
                currentPaidDate = null;
                updatePayrollStatusUI(null);
            }
        }

        function renderMonthPayTable(member, ms, me, dayMap) {
            monthPayBody.innerHTML = '';

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            summaryHourlyWage.textContent = (wage != null) ? krw(wage) : '-';

            let monthMinutes = 0;
            let monthJuhyuMinutes = 0;

            const weeks = [];
            let wStart = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd) {
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate() + 7);
            }

            let weekIndex = 0;

            weeks.forEach(weekStart => {
                const weekEnd = addDays(weekStart, 6);

                const dateTds = [];
                const timeTds = [];
                let weekMinutes = 0;

                for (let i=0;i<7;i++){
                    const dayDate = addDays(weekStart, i);
                    const iso     = toIso(dayDate);
                    const inMonth = (dayDate >= ms && dayDate <= me);
                    const info    = inMonth ? (dayMap[iso] || { segments:[], minutes:0 }) : { segments:[], minutes:0 };
                    const dayMinutes = info.minutes || 0;

                    if (inMonth) {
                        weekMinutes  += dayMinutes;
                        monthMinutes += dayMinutes;
                    }

                    const dayNum    = dayDate.getDate();
                    const isWeekend = (i >= 5);
                    const cls = [
                        !inMonth ? 'day-outside' : '',
                        inMonth && isWeekend ? 'day-weekend' : ''
                    ].filter(Boolean).join(' ');

                    const timeLabel = inMonth && dayMinutes > 0
                            ? formatMins(dayMinutes)
                            : (inMonth ? '-' : '');

                    dateTds.push(`<td class="day-cell-date ${cls}">${inMonth ? dayNum : ''}</td>`);
                    timeTds.push(`<td class="day-cell-time ${cls}">${timeLabel}</td>`);
                }

                const juhyuMinutes = calcWeeklyJuhyuMinutes(weekMinutes);
                monthJuhyuMinutes += juhyuMinutes;

                let weekWorkPay = null;
                let weekJuhyuPay = null;
                if (wage != null) {
                    weekWorkPay  = Math.round((weekMinutes/60)   * wage);
                    weekJuhyuPay = Math.round((juhyuMinutes/60)  * wage);
                }

                const weekWorkLabel = formatMins(weekMinutes);

                const weekLabelRange =
                        `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())}` +
                        ` ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                let weekJuhyuCellHtml = '-';
                if (juhyuMinutes > 0 && weekJuhyuPay != null) {
                    const juhyuTimeLabel = formatMins(juhyuMinutes);
                    const weekTimeLabel  = formatMins(weekMinutes);
                    const juhyuMoneyLabel = krw(weekJuhyuPay);
                    weekJuhyuCellHtml =
                            `(${weekTimeLabel}/5) <br>= ${juhyuTimeLabel}<br>${juhyuMoneyLabel}`;
                }

                const weekPayLabel = (weekWorkPay != null) ? krw(weekWorkPay) : '-';

                const trDates = document.createElement('tr');
                trDates.innerHTML = `
                    <th scope="row" rowspan="2">
                        ${++weekIndex}ì£¼ì°¨<br>
                        <small class="text-muted">(${weekLabelRange})</small>
                    </th>
                    ${dateTds.join('')}
                    <td class="text-end" rowspan="2">${weekWorkLabel}</td>
                    <td class="text-end" rowspan="2">${weekJuhyuCellHtml}</td>
                    <td class="text-end" rowspan="2">${weekPayLabel}</td>
                `;

                const trTimes = document.createElement('tr');
                trTimes.innerHTML = timeTds.join('');

                monthPayBody.appendChild(trDates);
                monthPayBody.appendChild(trTimes);
            });

            summaryMonthWorkTime.textContent = formatMins(monthMinutes);

            let monthWorkPay = null;
            let monthJuhyuPay = null;
            let monthTotal = null;

            if (wage != null) {
                monthWorkPay  = Math.round((monthMinutes/60)      * wage);
                monthJuhyuPay = Math.round((monthJuhyuMinutes/60) * wage);
                monthTotal    = monthWorkPay + monthJuhyuPay;
            }

            summaryMonthWorkPay.textContent  = (monthWorkPay  != null) ? krw(monthWorkPay)  : '-';
            summaryMonthJuhyuPay.textContent = (monthJuhyuPay != null) ? krw(monthJuhyuPay) : '-';
            summaryMonthTotal.textContent    = (monthTotal    != null) ? krw(monthTotal)    : '-';

            if (currentMember && wage != null && monthWorkPay != null && monthJuhyuPay != null && monthTotal != null) {
                lastPayrollPayload = {
                    memberId: currentMember.id,
                    payYear: ms.getFullYear(),
                    payMonth: ms.getMonth() + 1,
                    hourlyWage: wage,
                    monthWorkMinutes: monthMinutes,
                    monthJuhyuMinutes: monthJuhyuMinutes,
                    monthWorkPay: monthWorkPay,
                    monthJuhyuPay: monthJuhyuPay,
                    monthTotalPay: monthTotal
                };
            } else {
                lastPayrollPayload = null;
            }
        }

        // ===== ê¸‰ì—¬ ì €ì¥/í™•ì •/ì§€ê¸‰ API í˜¸ì¶œ =====
        async function savePayrollWithStatus(status, successMessage, paidDate) {
            if (!currentMember) {
                showToast('ë¨¼ì € ê·¼ë¬´ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            if (!lastPayrollPayload) {
                showToast('ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì›” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            const payload = {
                ...lastPayrollPayload,
                status: status
            };

            if (status === 'PAID' && paidDate) {
                payload.paidDate = paidDate;
            }

            try {
                const resp = await fetch(PAYROLL_SAVE_API, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    console.error('payroll save error', resp.status, text);
                    showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    return;
                }

                await loadPayrollStatus(currentMember, currentMonthStart);
                showToast(successMessage || 'ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (e) {
                console.error('payroll save fetch error', e);
                showToast('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ===== ê¸‰ì—¬ ìƒíƒœ ë°°ì§€ + ë²„íŠ¼ ìƒíƒœ + ì§€ê¸‰ì™„ë£Œì¼ í‘œì‹œ =====
        function updatePayrollStatusUI(status) {
            if (!payrollStatusBadge) return;

            const upper = status ? String(status).toUpperCase() : null;

            const labelMap = {
                DRAFT: 'ì„ì‹œì €ì¥',
                CONFIRMED: 'í™•ì •',
                PAID: 'ì§€ê¸‰ì™„ë£Œ'
            };
            const classMap = {
                DRAFT: 'bg-secondary',
                CONFIRMED: 'bg-info',
                PAID: 'bg-success'
            };

            if (!upper) {
                payrollStatusBadge.className = 'badge ms-2 bg-light text-muted';
                payrollStatusBadge.textContent = 'ë¯¸ì €ì¥';
                payrollStatusBadge.classList.remove('d-none');
            } else {
                payrollStatusBadge.className = `badge ms-2 ${classMap[upper] || 'bg-secondary'}`;
                payrollStatusBadge.textContent = labelMap[upper] || upper;
                payrollStatusBadge.classList.remove('d-none');
            }

            btnSaveDraft.disabled = false;
            btnConfirm.disabled   = false;
            btnMarkPaid.disabled  = false;

            if (!upper) {
                btnSaveDraft.disabled = false;
                btnConfirm.disabled   = true;
                btnMarkPaid.disabled  = true;
            } else if (upper === 'DRAFT') {
                btnSaveDraft.disabled = false;
                btnConfirm.disabled   = false;
                btnMarkPaid.disabled  = true;
            } else if (upper === 'CONFIRMED') {
                btnSaveDraft.disabled = true;
                btnConfirm.disabled   = true;
                btnMarkPaid.disabled  = false;
            } else if (upper === 'PAID') {
                btnSaveDraft.disabled = true;
                btnConfirm.disabled   = true;
                btnMarkPaid.disabled  = true;
            }

            [btnSaveDraft, btnConfirm, btnMarkPaid].forEach(btn => {
                btn.classList.remove('pay-action-next');
            });

            if (!upper) {
                btnSaveDraft.classList.add('pay-action-next');
            } else if (upper === 'DRAFT') {
                btnConfirm.classList.add('pay-action-next');
            } else if (upper === 'CONFIRMED') {
                btnMarkPaid.classList.add('pay-action-next');
            }

            if (paidDateLabelEl && paidDateValueEl) {
                if (upper === 'PAID' && currentPaidDate) {
                    const displayDate = String(currentPaidDate).substring(0, 10);
                    paidDateValueEl.textContent = displayDate;
                    paidDateLabelEl.classList.remove('d-none');
                } else {
                    paidDateValueEl.textContent = '';
                    paidDateLabelEl.classList.add('d-none');
                }
            }
        }

        // ===== í† ìŠ¤íŠ¸ í—¬í¼ =====
        function showToast(message, type) {
            if (!toastEl || !toastBodyEl) return;
            toastBodyEl.textContent = message;

            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            if (type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            } else if (type === 'info') {
                toastEl.classList.add('text-bg-info');
            } else {
                toastEl.classList.add('text-bg-success');
            }

            if (window.bootstrap && bootstrap.Toast) {
                const t = bootstrap.Toast.getOrCreateInstance(toastEl);
                t.show();
            } else {
                toastEl.style.display = 'block';
                setTimeout(() => { toastEl.style.display = 'none'; }, 2000);
            }
        }

        // ===== ìœ í‹¸ =====
        function firstDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth(), 1);
        }
        function lastDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth()+1, 0);
        }
        function toIso(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        function pad2(n) {
            return String(n).padStart(2,'0');
        }
        function addDays(d, n) {
            const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            x.setDate(x.getDate()+n);
            return x;
        }
        function toMonday(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const w = d.getDay();         // 0=ì¼, 1=ì›”, ..., 6=í† 
            const offset = (w + 6) % 7;   // ì›”ìš”ì¼ ê¸°ì¤€
            d.setDate(d.getDate() - offset);
            return d;
        }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60);
            const m = v % 60;
            return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function krw(v) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        function normalizeDays(apiData) {
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d => {
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes === 'number')
                        ? d.minutes
                        : segments.reduce((acc,s)=> acc + diffMinutes(s.start, s.end), 0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function diffMinutes(start, end) {
            const s = parseHm(start);
            const e = parseHm(end);
            return (e.h*60 + e.m) - (s.h*60 + s.m);
        }
        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        function calcWeeklyJuhyuMinutes(weeklyMinutes) {
            if (!weeklyMinutes || weeklyMinutes < 15*60) return 0;
            return Math.round(weeklyMinutes / 5);
        }

        function colorForMember(m) {
            const key = (m?.id != null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key) % 360, s = 65, l = 55;
            return hslToHex(h, s, l);
        }
        function seededHash(str) {
            let h = 2166136261 >>> 0;
            for (let i=0;i<str.length;i++) {
                h ^= str.charCodeAt(i);
                h = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }
        function hslToHex(h,s,l) {
            s/=100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1-l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer}}
