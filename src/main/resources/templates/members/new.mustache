{{>layouts/header}}

<!-- ê°„ë‹¨ ìŠ¤íƒ€ì¼ -->
<style>
    .text-mono { font-variant-numeric: tabular-nums; letter-spacing:-0.01em; }
    .wage-preview-header { background: linear-gradient(135deg, #198754 0%, #20c997 100%); color:#fff; border-bottom:none; }
    .wage-preview-card .table > :not(caption) > * > * { padding: 0.9rem 1rem; }
    .wage-preview-table thead th { background:#f6f9fb; color:#6c757d; font-weight:600; border-bottom:1px solid #e9ecef; }
    .wage-preview-table tbody tr:not(.table-subtle) td { border-top: 1px dashed #eef2f6; }
    .wage-preview-table .table-subtle td { background:#fafcfd; color:#7a8a99; }
    @media (min-width: 992px){ .sticky-side { position: sticky; top: 12px; } }

    /* ==== ëª¨ë‹¬ ë‚´ ì£¼ê°„ íƒ€ì„í…Œì´ë¸” ì„ íƒ ìŠ¤íƒ€ì¼ ==== */
    .week-grid {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        user-select: none;
    }
    .week-grid table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
        background: #fff;
    }
    .week-grid thead th {
        background: #f8fafc;
        color:#64748b;
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: center;
        padding: .6rem .4rem;
        position: sticky; top: 0; z-index: 2;
    }
    .week-grid tbody th {
        background: #fafafa;
        color:#6b7280;
        font-weight: 600;
        width: 70px;
        border-right: 1px solid #e5e7eb;
        text-align: center;
        padding: .45rem .25rem;
        font-size: .9rem;
    }
    .slot {
        border-bottom: 1px dashed #eef2f6;
        border-right: 1px dashed #eef2f6;
        height: 34px;
        cursor: pointer;
        position: relative;
        background: #ffffff;
    }
    .slot:hover { background: #f8fbff; }
    .slot.selected {
        background: rgba(25,135,84,.18);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,.25);
    }
    .grid-toolbar {
        display: flex; gap: 8px; align-items: center; justify-content: space-between;
        margin-bottom: .5rem;
    }
    .grid-toolbar .left, .grid-toolbar .right { display: flex; gap: 8px; align-items: center; }
    .modal { background: rgba(0,0,0,.35); position: fixed; inset: 0; display:none; }
    .modal-dialog { margin: 50px auto; max-width: 980px; }
    .modal-content { background:#fff; border-radius: 12px; }
</style>

<main class="container my-4">
    <h2 class="mb-3">ğŸ‘¤ ì•„ë¥´ë°”ì´íŠ¸ íšŒì› ë“±ë¡</h2>

    <form class="container px-0" action="/members/create" method="post" id="memberForm">
        <!-- (ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì‚¬ìš© ì‹œ) CSRF: ëª¨ë¸ì— ìˆì„ ë•Œë§Œ ë Œë” -->
        {{#_csrf}}
            <input type="hidden" name="{{parameterName}}" value="{{token}}">
        {{/_csrf}}

        <div class="row g-3">
            <!-- ============ ì¢Œì¸¡: ê¸°ë³¸ ì •ë³´/ë³´ê±´ì¦/ì…ê¸ˆê³„ì¢Œ ============ -->
            <div class="col-12 col-lg-6">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ê¸°ë³¸ ì •ë³´</span>
                        <select class="form-select form-select-sm w-auto" name="status" required>
                            <option value="">ìƒíƒœ</option>
                            <option value="WAITING" selected>ì‹œì‘ì „</option>
                            <option value="WORKING">ê·¼ë¬´ì¤‘</option>
                            <option value="RESTING">íœ´ì‹ì¤‘</option>
                            <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                            <option value="RESIGNED">í‡´ì‚¬</option>
                        </select>
                    </div>

                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ì´ë¦„</label>
                            <input class="form-input form-control" type="text" name="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì„±ë³„</label>
                            <select class="form-select" name="gender" required>
                                <option value="">ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input
                                    class="form-input form-control"
                                    type="tel"
                                    name="phone"
                                    id="phone"
                                    placeholder="010-1234-5678"
                                    pattern="^0\d{1,2}-\d{3,4}-\d{4}$"
                                    autocomplete="tel"
                                    inputmode="tel"
                                    required>
                            <div class="form-text">ìˆ«ìë§Œ ì…ë ¥í•´ë„ ìë™ìœ¼ë¡œ <code>010-1234-5678</code> í˜•íƒœë¡œ í¬ë§·íŒ…ë©ë‹ˆë‹¤.</div>
                        </div>

                        <div class="mb-0">
                            <label class="form-label">ì´ë©”ì¼</label>
                            <input class="form-input form-control" type="email" name="email" id="email" placeholder="name@example.com">
                            <div class="form-text">ì„ íƒ ì…ë ¥ì…ë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>

                <!-- ë³´ê±´ì¦ -->
                <div class="card mb-3">
                    <div class="card-header fw-bold">ë³´ê±´ì¦</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label d-block">ë³´ê±´ì¦ ë³´ìœ </label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="hasHealthCertificate" value="true" id="healthYes">
                                <label class="form-check-label" for="healthYes">ë³´ìœ </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="hasHealthCertificate" value="false" id="healthNo" checked>
                                <label class="form-check-label" for="healthNo">ë¯¸ë³´ìœ </label>
                            </div>
                        </div>

                        <div id="healthExpiryPanel" class="mt-2" style="display:none;">
                            <div class="d-flex align-items-end gap-2">
                                <div>
                                    <label class="form-label mb-1">ìœ íš¨ê¸°ê°„(ë§Œë£Œì¼)</label>
                                    <input type="date" class="form-input form-control" id="healthExpiryDate">
                                </div>
                                <div class="mb-2">
                                    <button type="button" class="btn btn-success btn-sm" id="applyHealthExpiry">ì ìš©</button>
                                    <button type="button" class="btn btn-secondary btn-sm" id="cancelHealthExpiry">ì·¨ì†Œ</button>
                                </div>
                            </div>
                            <div id="healthExpiryPreview" class="text-muted mt-2">ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• ê¸‰ì—¬ ì…ê¸ˆ ê³„ì¢Œ (ë³´ê±´ì¦ì²˜ëŸ¼ ë¶„ë¦¬) -->
                <div class="card mb-3">
                    <div class="card-header fw-bold">ê¸‰ì—¬ ì…ê¸ˆ ê³„ì¢Œ</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ì€í–‰</label>
                            <select class="form-select" name="bankName" id="bankName" required>
                                <option value="">ì€í–‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option>KBêµ­ë¯¼</option>
                                <option>ì‹ í•œ</option>
                                <option>ìš°ë¦¬</option>
                                <option>í•˜ë‚˜</option>
                                <option>ë†í˜‘</option>
                                <option>IBKê¸°ì—…</option>
                                <option>ì¹´ì¹´ì˜¤ë±…í¬</option>
                                <option>í† ìŠ¤ë±…í¬</option>
                                <option>SCì œì¼</option>
                                <option>ì”¨í‹°</option>
                                <option>ë¶€ì‚°</option>
                                <option>ëŒ€êµ¬</option>
                                <option>ê²½ë‚¨</option>
                                <option>ê´‘ì£¼</option>
                                <option>ì „ë¶</option>
                                <option>ìˆ˜í˜‘</option>
                                <option>ìƒˆë§ˆì„</option>
                                <option>ìš°ì²´êµ­</option>
                            </select>
                        </div>
                        <div class="mb-0">
                            <label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
                            <input
                                    class="form-input form-control"
                                    type="text"
                                    name="bankAccount"
                                    id="bankAccount"
                                    inputmode="numeric"
                                    placeholder="ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 110123456789)"
                                    required>
                            <div class="form-text">ìˆ«ìë§Œ í—ˆìš© Â· 8~20ìë¦¬. í•˜ì´í”ˆ ì—†ì´ ì…ë ¥í•˜ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============ ìš°ì¸¡: ê·¼ë¬´ ì¡°ê±´/ìŠ¤ì¼€ì¤„/ì˜ˆìƒê¸‰ì—¬ ============ -->
            <div class="col-12 col-lg-6">
                <div class="sticky-side d-grid gap-3">

                    <!-- ê·¼ë¬´ ì¡°ê±´ -->
                    <div class="card">
                        <div class="card-header fw-bold">ê·¼ë¬´ ì¡°ê±´</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">ì•„ë¥´ë°”ì´íŠ¸ ì‹œì‘ì¼</label>
                                <input class="form-input form-control" type="date" name="startDate" required>
                            </div>

                            <div class="mb-0">
                                <label class="form-label">ì‹œê¸‰(ì›)</label>
                                <input
                                        class="form-input form-control"
                                        type="number"
                                        name="hourlyWage"
                                        id="hourlyWage"
                                        min="0"
                                        step="100"
                                        placeholder="12000"
                                        required>
                                <div class="form-text">ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 12000). ì„œë²„ì—ì„œëŠ” ì •ìˆ˜(ì›)ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>
                    </div>

                    <!-- ê·¼ë¬´ì‹œê°„ -->
                    <div class="card">
                        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                            <span>ê·¼ë¬´ì‹œê°„(ìš”ì¼/ì‹œê°„)</span>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="openScheduleModal">ë“±ë¡/ìˆ˜ì •</button>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0" id="scheduleTableView">
                                <thead>
                                <tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th></tr>
                                </thead>
                                <tbody>
                                <tr class="placeholder">
                                    <td colspan="3" class="text-muted">ì•„ì§ ë“±ë¡ëœ ìš”ì¼/ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. â€œë“±ë¡/ìˆ˜ì •â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ì˜ˆìƒ ê¸‰ì—¬ -->
                    <div class="card wage-preview-card shadow-sm">
                        <div class="card-header wage-preview-header d-flex justify-content-between align-items-center">
                            <span class="fw-bold">ì˜ˆìƒ ê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸°</span>
                            <small class="text-white-50">ìŠ¤ì¼€ì¤„/ì‹œê¸‰ ë³€ê²½ ì‹œ ìë™ ë°˜ì˜</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-borderless table-hover align-middle mb-0 wage-preview-table">
                                    <thead>
                                    <tr>
                                        <th class="w-50">í•­ëª©</th>
                                        <th class="text-end w-50">ê°’</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td class="text-muted">ì£¼ê°„ ì´ ê·¼ë¬´ì‹œê°„</td>
                                        <td class="text-end text-mono fw-semibold" id="previewWeeklyHours">0ì‹œê°„ 0ë¶„</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">ì£¼ê°„ ì˜ˆìƒ ê¸‰ì—¬</td>
                                        <td class="text-end text-mono fw-bold" id="previewWeeklyPay">â‚©0</td>
                                    </tr>
                                    <tr class="table-subtle">
                                        <td class="text-muted">ì›” í™˜ì‚° ì£¼ì°¨</td>
                                        <td class="text-end text-mono">Ã— 4.345</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">ì›”ê°„ ì˜ˆìƒ ê¸‰ì—¬</td>
                                        <td class="text-end text-mono fw-bold text-success" id="previewMonthlyPay">â‚©0</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="px-3 pb-3 pt-2 small text-muted">* ì›” í™˜ì‚°ì€ í‰ê·  1ê°œì›” â‰ˆ 4.345ì£¼ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</main>

<!-- ëª¨ë‹¬: ìš”ì¼/ì‹œê°„ ë“±ë¡ (ì£¼ê°„ íƒ€ì„í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì„ íƒ) -->
<div class="modal" id="scheduleModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="mb-0">ìš”ì¼/ì‹œê°„ ë“±ë¡</h3>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="closeScheduleModal">ë‹«ê¸°</button>
            </div>

            <!-- íˆ´ë°” -->
            <div class="grid-toolbar">
                <div class="left">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAll">ì „ì²´ ì´ˆê¸°í™”</button>
                    <div class="input-group input-group-sm">
                        <label class="input-group-text">ìš”ì¼ ì´ˆê¸°í™”</label>
                        <select id="clearDaySelect" class="form-select">
                            <option value="">ì„ íƒâ€¦</option>
                            <option value="MON">ì›”</option><option value="TUE">í™”</option><option value="WED">ìˆ˜</option>
                            <option value="THU">ëª©</option><option value="FRI">ê¸ˆ</option><option value="SAT">í† </option><option value="SUN">ì¼</option>
                        </select>
                        <button class="btn btn-outline-danger" type="button" id="clearDayBtn">ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="right small text-muted">
                    ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ ì¹¸ ì„ íƒ Â· ë‹¤ì‹œ ë“œë˜ê·¸í•˜ë©´ í•´ì œ
                </div>
            </div>

            <!-- ì£¼ê°„ ê·¸ë¦¬ë“œ -->
            <div class="week-grid mb-3">
                <table id="weekGridTable">
                    <thead>
                    <tr>
                        <th style="width:70px;">ì‹œê°„</th>
                        <th data-day="MON">ì›”</th>
                        <th data-day="TUE">í™”</th>
                        <th data-day="WED">ìˆ˜</th>
                        <th data-day="THU">ëª©</th>
                        <th data-day="FRI">ê¸ˆ</th>
                        <th data-day="SAT">í† </th>
                        <th data-day="SUN">ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="weekGridBody">
                    <!-- JSë¡œ 06~22ì‹œ í•œ ì‹œê°„ ë‹¨ìœ„ ìŠ¬ë¡¯ ìƒì„± -->
                    </tbody>
                </table>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸°(ì„ íƒì„ êµ¬ê°„ìœ¼ë¡œ ë³‘í•©) -->
            <div class="mb-2">
                <table class="table table-sm mb-0" id="schedulePreviewTable">
                    <thead><tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-success" id="applySchedule">ì ìš©</button>
                <button type="button" class="btn btn-secondary" id="cancelSchedule">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

{{>layouts/footer}}

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    (function() {
        const form = document.getElementById('memberForm');

        /* ===== ì „í™”ë²ˆí˜¸ ìë™ í¬ë§· ===== */
        const phone = document.getElementById('phone');
        function formatPhone(raw) {
            let v = String(raw || '').replace(/\D/g, '');
            if (!v) return '';
            if (v.startsWith('02')) {
                if (v.length <= 2) return v;
                if (v.length <= 6) return v.replace(/(02)(\d{0,4})/, '$1-$2');
                return v.replace(/(02)(\d{3,4})(\d{0,4}).*/, '$1-$2-$3');
            } else {
                if (v.length <= 3) return v;
                if (v.length <= 7) return v.replace(/(0\d{2})(\d{0,4})/, '$1-$2');
                return v.replace(/(0\d{2})(\d{3,4})(\d{0,4}).*/, '$1-$2-$3');
            }
        }
        function isValidPhone(s){ return /^(0\d{1,2})-\d{3,4}-\d{4}$/.test(s); }

        phone.addEventListener('input', () => {
            const pos = phone.selectionStart ?? 0;
            const before = phone.value.length;
            phone.value = formatPhone(phone.value);
            const after = phone.value.length;
            const delta = after - before;
            const next = Math.max(0, pos + delta);
            phone.setSelectionRange(next, next);
            phone.setCustomValidity('');
        });
        phone.addEventListener('blur', () => {
            phone.value = formatPhone(phone.value);
            if (phone.value && !isValidPhone(phone.value)) {
                phone.setCustomValidity('ì˜ˆ: 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
            } else {
                phone.setCustomValidity('');
            }
        });

        /* ===== ğŸ†• ê³„ì¢Œë²ˆí˜¸: ìˆ«ìë§Œ í—ˆìš© + ê¸¸ì´ ì œí•œ ===== */
        const bankAccount = document.getElementById('bankAccount');
        bankAccount.addEventListener('input', () => {
            const pos = bankAccount.selectionStart ?? 0;
            const before = bankAccount.value.length;
            bankAccount.value = bankAccount.value.replace(/\D/g, '').slice(0, 20);
            const after = bankAccount.value.length;
            const delta = after - before;
            const next = Math.max(0, pos + delta);
            bankAccount.setSelectionRange(next, next);
            bankAccount.setCustomValidity('');
        });

        /* ===== ì‹œê¸‰ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  ===== */
        const hourlyWage = document.getElementById('hourlyWage');
        hourlyWage.addEventListener('blur', updatePreview);
        hourlyWage.addEventListener('input', updatePreview);

        /* ===== ìŠ¤ì¼€ì¤„ ë·° í…Œì´ë¸” ===== */
        const viewTableBody = document.querySelector('#scheduleTableView tbody');

        /* ===== ëª¨ë‹¬ ìš”ì†Œ ===== */
        const modal = document.getElementById('scheduleModal');
        const openBtn = document.getElementById('openScheduleModal');
        const closeBtn = document.getElementById('closeScheduleModal');
        const applyBtn = document.getElementById('applySchedule');
        const cancelBtn = document.getElementById('cancelSchedule');

        const weekGridBody = document.getElementById('weekGridBody');
        const schedulePreviewBody = document.querySelector('#schedulePreviewTable tbody');
        const clearAllBtn = document.getElementById('clearAll');
        const clearDayBtn = document.getElementById('clearDayBtn');
        const clearDaySelect = document.getElementById('clearDaySelect');

        const dayMap = { MON:'ì›”', TUE:'í™”', WED:'ìˆ˜', THU:'ëª©', FRI:'ê¸ˆ', SAT:'í† ', SUN:'ì¼' };
        const daysOrder = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

        const HOUR_START = 6, HOUR_END = 22; // [6,22) ì…€ 1ì¹¸ = 1ì‹œê°„

        /* ===== ëª¨ë‹¬ ì—´ê¸°: ê·¸ë¦¬ë“œ ë§Œë“¤ê³  ê¸°ì¡´ ë·° ë°˜ì˜ ===== */
        openBtn.addEventListener('click', () => {
            buildWeekGrid();
            hydrateGridFromView();
            rebuildPreviewFromGrid();
            modal.style.display = 'block';
        });
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        cancelBtn.addEventListener('click', () => modal.style.display = 'none');

        /* ===== ê·¸ë¦¬ë“œ êµ¬ì„± ===== */
        function buildWeekGrid() {
            weekGridBody.innerHTML = '';
            for (let h = HOUR_START; h < HOUR_END; h++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.textContent = `${String(h).padStart(2,'0')}:00`;
                tr.appendChild(th);

                daysOrder.forEach(d => {
                    const td = document.createElement('td');
                    td.className = 'slot';
                    td.dataset.day = d;
                    td.dataset.hour = String(h); // ì •ì‹œ ì‹œì‘
                    tr.appendChild(td);
                });
                weekGridBody.appendChild(tr);
            }
            attachGridSelectionHandlers();
        }

        /* ===== ë“œë˜ê·¸ ì„ íƒ/í•´ì œ ===== */
        let dragging = false;
        let dragAdding = true;
        function attachGridSelectionHandlers() {
            weekGridBody.querySelectorAll('.slot').forEach(slot => {
                slot.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    dragging = true;
                    dragAdding = !slot.classList.contains('selected');
                    toggleSlot(slot, dragAdding);
                });
                slot.addEventListener('mouseenter', () => {
                    if (!dragging) return;
                    toggleSlot(slot, dragAdding);
                });
            });
            window.addEventListener('mouseup', () => {
                if (dragging) {
                    dragging = false;
                    rebuildPreviewFromGrid();
                }
            });
        }
        function toggleSlot(slot, select) {
            if (select) slot.classList.add('selected');
            else slot.classList.remove('selected');
        }

        /* ===== ì´ˆê¸°í™” ë²„íŠ¼ ===== */
        clearAllBtn.addEventListener('click', () => {
            weekGridBody.querySelectorAll('.slot.selected').forEach(s => s.classList.remove('selected'));
            rebuildPreviewFromGrid();
        });
        clearDayBtn.addEventListener('click', () => {
            const d = clearDaySelect.value;
            if (!d) return;
            weekGridBody.querySelectorAll(`.slot[data-day="${d}"]`).forEach(s => s.classList.remove('selected'));
            rebuildPreviewFromGrid();
        });

        /* ===== ê¸°ì¡´ ë·° â†’ ê·¸ë¦¬ë“œ ë°˜ì˜ ===== */
        function hydrateGridFromView() {
            const rows = Array.from(viewTableBody.querySelectorAll('tr'))
                    .filter(tr => !tr.classList.contains('placeholder'));
            rows.forEach(r => {
                const day = r.querySelector('td:nth-child(1)').getAttribute('data-day');
                const start = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                const end   = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                if (!day || !start || !end) return;
                const [sh] = start.split(':').map(n=>parseInt(n,10));
                const [eh] = end.split(':').map(n=>parseInt(n,10));
                for (let h = sh; h < eh; h++) {
                    const slot = weekGridBody.querySelector(`.slot[data-day="${day}"][data-hour="${h}"]`);
                    if (slot) slot.classList.add('selected');
                }
            });
        }

        /* ===== ê·¸ë¦¬ë“œ â†’ ë¯¸ë¦¬ë³´ê¸°(ë³‘í•©) ===== */
        function rebuildPreviewFromGrid() {
            schedulePreviewBody.innerHTML = '';
            daysOrder.forEach(d => {
                const hours = [];
                for (let h = HOUR_START; h < HOUR_END; h++) {
                    const slot = weekGridBody.querySelector(`.slot[data-day="${d}"][data-hour="${h}"]`);
                    if (slot && slot.classList.contains('selected')) hours.push(h);
                }
                const merged = mergeConsecutiveHours(hours);
                merged.forEach(([st, ed]) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-day="${d}">${dayMap[d]}(${d})</td>
                        <td data-start="${pad(st)}:00">${pad(st)}:00</td>
                        <td data-end="${pad(ed)}:00">${pad(ed)}:00</td>
                    `;
                    schedulePreviewBody.appendChild(tr);
                });
            });
            if (!schedulePreviewBody.children.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="3" class="text-muted">ì„ íƒëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
                schedulePreviewBody.appendChild(tr);
            }
        }
        function mergeConsecutiveHours(arr) {
            // arr: [6,7,8,10,11] -> [[6,9],[10,12]]  (endëŠ” ë¯¸í¬í•¨)
            const out = [];
            if (!arr.length) return out;
            arr.sort((a,b)=>a-b);
            let s = arr[0], prev = arr[0];
            for (let i=1;i<arr.length;i++){
                if (arr[i] === prev + 1) { prev = arr[i]; continue; }
                out.push([s, prev+1]);
                s = prev = arr[i];
            }
            out.push([s, prev+1]);
            return out;
        }
        function pad(n){ return String(n).padStart(2,'0'); }

        /* ===== ì ìš©: ë¯¸ë¦¬ë³´ê¸° â†’ ë·° í…Œì´ë¸”/íˆë“  ì¸í’‹ ===== */
        applyBtn.addEventListener('click', () => {
            const previewRows = Array.from(schedulePreviewBody.querySelectorAll('tr'))
                    .filter(tr => tr.querySelector('td[data-day]'));
            viewTableBody.innerHTML = '';
            if (!previewRows.length) {
                addViewPlaceholder();
            } else {
                previewRows.forEach(r => {
                    const d = r.querySelector('td:nth-child(1)').getAttribute('data-day');
                    const s = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                    const e = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                    appendViewRow(d, s, e);
                });
            }
            rebuildHiddenInputsFromView();
            updatePreview();
            modal.style.display = 'none';
        });

        /* ===== ë·° í…Œì´ë¸” ì¡°ì‘ í•¨ìˆ˜ ===== */
        function appendViewRow(day, start, end) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-day="${day}">${dayMap[day]}(${day})</td>
                <td data-start="${start}">${start}</td>
                <td data-end="${end}">${end}</td>`;
            viewTableBody.appendChild(tr);
        }
        function addViewPlaceholder() {
            const tr = document.createElement('tr');
            tr.className = 'placeholder';
            tr.innerHTML = `<td colspan="3" class="text-muted">ì•„ì§ ë“±ë¡ëœ ìš”ì¼/ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
            viewTableBody.appendChild(tr);
        }
        function rebuildHiddenInputsFromView() {
            form.querySelectorAll('input[data-schedule="1"]').forEach(n => n.remove());
            const rows = Array.from(viewTableBody.querySelectorAll('tr'))
                    .filter(tr => !tr.classList.contains('placeholder'));
            rows.forEach((r, i) => {
                const day = r.querySelector('td:nth-child(1)').getAttribute('data-day');
                const start = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                const end = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                addHidden(`schedule[${i}].day`, day);
                addHidden(`schedule[${i}].start`, start);
                addHidden(`schedule[${i}].end`, end);
            });
        }
        function addHidden(name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            input.setAttribute('data-schedule', '1');
            form.appendChild(input);
        }

        /* ===== ë³´ê±´ì¦ ì¸ë¼ì¸ í¼ ===== */
        const healthYes = document.getElementById('healthYes');
        const healthNo  = document.getElementById('healthNo');
        const panel     = document.getElementById('healthExpiryPanel');
        const dateInput = document.getElementById('healthExpiryDate');
        const applyHealthBtn  = document.getElementById('applyHealthExpiry');
        const cancelHealthBtn = document.getElementById('cancelHealthExpiry');
        const previewText   = document.getElementById('healthExpiryPreview');
        const HIDDEN_FLAG = 'data-health-expiry';

        function onHealthRadioChange() {
            if (healthYes.checked) {
                panel.style.display = 'block';
                const existing = form.querySelector('input[type="hidden"][name="healthCertExpiry"]');
                if (existing && existing.value) {
                    dateInput.value = existing.value;
                    previewText.textContent = `ìœ íš¨ê¸°ê°„: ${existing.value}`;
                    previewText.classList.remove('text-muted');
                } else {
                    dateInput.value = '';
                    previewText.textContent = 'ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.';
                    previewText.classList.add('text-muted');
                }
            } else {
                panel.style.display = 'none';
                removeHealthExpiryHidden();
                dateInput.value = '';
                previewText.textContent = 'ë³´ìœ  ì„ íƒ ì‹œ ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                previewText.classList.add('text-muted');
            }
        }
        healthYes.addEventListener('change', onHealthRadioChange);
        healthNo.addEventListener('change', onHealthRadioChange);

        applyHealthBtn.addEventListener('click', () => {
            const val = dateInput.value;
            if (!val) { alert('ìœ íš¨ê¸°ê°„(ë§Œë£Œì¼)ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const today = new Date().toISOString().slice(0,10);
            if (val < today && !confirm('ì„ íƒí•œ ë‚ ì§œê°€ ì´ë¯¸ ì§€ë‚¬ìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì ìš©í• ê¹Œìš”?')) return;

            removeHealthExpiryHidden();
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'healthCertExpiry';
            hidden.value = val;
            hidden.setAttribute(HIDDEN_FLAG, '1');
            form.appendChild(hidden);

            previewText.textContent = `ìœ íš¨ê¸°ê°„: ${val}`;
            previewText.classList.remove('text-muted');
        });

        cancelHealthBtn.addEventListener('click', () => {
            const existing = form.querySelector('input[type="hidden"][name="healthCertExpiry"]');
            if (existing && existing.value) {
                dateInput.value = existing.value;
                previewText.textContent = `ìœ íš¨ê¸°ê°„: ${existing.value}`;
                previewText.classList.remove('text-muted');
            } else {
                dateInput.value = '';
                previewText.textContent = 'ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.';
                previewText.classList.add('text-muted');
            }
        });
        function removeHealthExpiryHidden() {
            form.querySelectorAll(`input[${HIDDEN_FLAG}="1"]`).forEach(n => n.remove());
        }

        /* ===== ì œì¶œ ì „ ìµœì¢… ê²€ì¦ ===== */
        form.addEventListener('submit', (e) => {
            // ì „í™”ë²ˆí˜¸ ìµœì¢… ë³´ì • ë° í™•ì¸
            phone.value = formatPhone(phone.value);
            if (!isValidPhone(phone.value)) {
                e.preventDefault();
                phone.setCustomValidity('ì˜ˆ: 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
                phone.reportValidity();
                return;
            } else {
                phone.setCustomValidity('');
            }

            // ê³„ì¢Œ ê²€ì¦: ìˆ«ì 8~20ìë¦¬
            const acct = (bankAccount.value || '').replace(/\D/g, '');
            if (acct.length < 8 || acct.length > 20) {
                e.preventDefault();
                bankAccount.setCustomValidity('ê³„ì¢Œë²ˆí˜¸ëŠ” ìˆ«ì 8~20ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš” (í•˜ì´í”ˆ ì—†ì´).');
                bankAccount.reportValidity();
                return;
            } else {
                bankAccount.setCustomValidity('');
                // ì„œë²„ì— ìˆ«ìë§Œ ì „ë‹¬í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // bankAccount.value = acct;
            }

            // ë³´ê±´ì¦ ìœ íš¨ê¸°ê°„ ê²½ê³ 
            if (document.getElementById('healthYes').checked) {
                const hidden = form.querySelector('input[name="healthCertExpiry"]');
                if (!hidden && !confirm('ë³´ê±´ì¦ â€œë³´ìœ â€ë¡œ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ìœ íš¨ê¸°ê°„ ì—†ì´ ê³„ì† ì§„í–‰í• ê¹Œìš”?')) {
                    e.preventDefault();
                    return;
                }
            }
            // ìŠ¤ì¼€ì¤„ ìµœì‹ í™”
            rebuildHiddenInputsFromView();
        });

        onHealthRadioChange();

        /* ======== â–¶ ì˜ˆìƒ ê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸° ê³„ì‚° ë¡œì§ â—€ ======== */
        const weeklyHoursEl  = document.getElementById('previewWeeklyHours');
        const weeklyPayEl    = document.getElementById('previewWeeklyPay');
        const monthlyPayEl   = document.getElementById('previewMonthlyPay');

        const viewObserver = new MutationObserver(() => updatePreview());
        viewObserver.observe(viewTableBody, { childList: true });

        function updatePreview() {
            const totalMin = computeWeeklyMinutesFromView();
            const wage = parseInt(String(hourlyWage.value || '0').replace(/,/g,''), 10) || 0;

            const hours = Math.floor(totalMin / 60);
            const mins  = totalMin % 60;
            weeklyHoursEl.textContent = `${hours}ì‹œê°„ ${mins}ë¶„`;

            const weeklyPay = Math.round((totalMin / 60) * wage);
            weeklyPayEl.textContent  = formatKRW(weeklyPay);

            const monthlyPay = Math.round(weeklyPay * 4.345); // í‰ê·  1ê°œì›” â‰ˆ 4.345ì£¼
            monthlyPayEl.textContent = formatKRW(monthlyPay);
        }

        function computeWeeklyMinutesFromView() {
            const rows = Array.from(viewTableBody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('placeholder'));
            let total = 0;
            rows.forEach(r => {
                const start = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                const end   = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                total += diffMinutes(start, end);
            });
            return total;
        }

        function diffMinutes(start, end) {
            if (!start || !end) return 0;
            const [sh, sm] = start.split(':').map(n => parseInt(n,10));
            const [eh, em] = end.split(':').map(n => parseInt(n,10));
            return (eh*60 + em) - (sh*60 + sm);
        }

        function formatKRW(n) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(n || 0);
        }

        // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        updatePreview();
    })();
</script>
