{{>layouts/header}}

<main class="container my-4">

    <!-- ============ ìƒë‹¨: ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸° (í—¤ë” í¬í•¨ ì „ì²´ íŒŒë€ íŒ¨ë„) ============ -->
    <div class="card mb-3">
        <div class="card-body p-0">
            <!-- ğŸ”µ í—¤ë”ê¹Œì§€ ëª¨ë‘ í¬í•¨í•˜ëŠ” íŒŒë€ ë¼ìš´ë“œ íŒ¨ë„ -->
            <div class="status-panel-blue">
                <!-- íƒ€ì´í‹€ + ê¸°ê°„ -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="status-title">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</div>
                        <div class="status-subtitle-small">
                            ìƒíƒœë³„ë¡œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ í•„í„°ë§í•˜ê³ , ì„ íƒí•œ ìƒíƒœì˜ ì›”ê°„ ì¼ì •ì„ í•¨ê»˜ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <span class="status-period-label-caption">ì¡°íšŒ ê¸°ê°„</span>
                        <span id="statusPeriodLabel" class="status-period-label-value">0000.00.01 ~ 00.00</span>
                    </div>
                </div>

                <!-- ë³¸ë¬¸: ìƒíƒœ ì„ íƒ + ì¹© ë¦¬ìŠ¤íŠ¸ -->
                <div class="row g-3 align-items-start">
                    <!-- ì™¼ìª½: ìƒíƒœ ì„ íƒ -->
                    <div class="col-12 col-md-4">
                        <label class="form-label small status-label" for="statusSelect">ìƒíƒœ</label>
                        <select id="statusSelect" class="form-select status-select">
                            <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                            <option value="WAITING">ì‹œì‘ì „</option>
                            <option value="RESTING">íœ´ì‹ì¤‘</option>
                            <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                            <option value="RESIGNED">í‡´ì‚¬</option>
                        </select>
                        <div class="form-text status-help-text">
                            ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ì™€ ì•„ë˜ ì›”ê°„ ì¼ì •ì´ í•¨ê»˜ ë°”ë€ë‹ˆë‹¤.
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ ìƒ ì¹© ë¦¬ìŠ¤íŠ¸ -->
                    <div class="col-12 col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small status-subtitle">í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ</span>
                            <!-- â–· ì˜¤ë¥¸ìª½ ë ì¸ì› ë°°ì§€ -->
                            <span id="statusCountBadgeTop" class="badge bg-light text-dark status-count-badge">0ëª…</span>
                        </div>

                        <!-- ì¹©( pill ) ë¦¬ìŠ¤íŠ¸ -->
                        <div id="memberPills" class="vlist status-pill-list"></div>

                        <div class="small status-caption mt-2">
                            * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤. (ë‹¬ë ¥ ì¼ì •ì—ë„ ë™ì¼ ìƒ‰ìƒ ì‚¬ìš©)
                        </div>

                        <div class="mt-2 d-flex align-items-center gap-3">
                            <span class="legend legend-plan"></span><span class="small status-legend-text">ê³„íš(ì£¼ê°„ í…œí”Œë¦¿)</span>
                            <span class="legend legend-actual"></span><span class="small status-legend-text">ì €ì¥ëœ ì¼ì •</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- // status-panel-blue -->
        </div>
    </div>

    <!-- ============ í•˜ë‹¨: ì›”ê°„ íƒ€ì„í…Œì´ë¸” (ëª¨ë“  ê·¼ë¡œì í‘œì‹œ) ============ -->
    <div class="card">
        <div id="monthCardHeader"
             class="card-header fw-bold d-flex align-items-center justify-content-between">
      <span>
        ì„ íƒ ì›” ì‹¤ì œ ì¼ì • (ëª¨ë“  ê·¼ë¡œì)
        <small id="selectedMemberNameRight" class="text-muted ms-2">[í•˜ì´ë¼ì´íŠ¸: ì „ì²´]</small>
        <span id="selectedMemberStatusRight" class="badge bg-secondary ms-2 d-none">-</span>
      </span>
            <div class="d-flex align-items-center gap-2">
                <button id="btnMonthPrev" class="btn btn-sm btn-outline-secondary">â—€ ì´ì „ ë‹¬</button>
                <span id="monthRangeLabel" class="small text-muted">0000.00.01 ~ 00.00</span>
                <button id="btnMonthThis" class="btn btn-sm btn-outline-secondary">ì´ë²ˆ ë‹¬</button>
                <button id="btnMonthNext" class="btn btn-sm btn-outline-secondary">ë‹¤ìŒ ë‹¬ â–¶</button>
            </div>
        </div>

        <div class="card-body">

            <!-- âœ… ë¹„ì–´ìˆìŒ/ìƒì„± ìœ ë„ ìƒíƒœ -->
            <div id="emptyState" class="text-center py-4 d-none">
                <div id="emptyTitle" class="mb-2 text-muted">ì´ ë‹¬ì—ëŠ” ì €ì¥ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                <button id="btnCreateFromEmpty" class="btn btn-primary btn-sm">ì¼ì • ìƒì„±í•˜ê¸°</button>
                <div id="emptyHint" class="small text-muted mt-2">* ìƒë‹¨ ì¹©ì—ì„œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ ì„ íƒí•œ í›„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            </div>

            <!-- âœ… ìš”ì¼ í—¤ë” (sticky ëŒ€ìƒ) -->
            <div class="calendar-dow-row d-none" id="calendarDowRow"></div>

            <!-- ë‚ ì§œ ì¹¸ ê·¸ë¦¬ë“œ: ëª¨ë“  ê·¼ë¡œì ë°°ì§€ í‘œì‹œ -->
            <div class="calendar-grid d-none" id="calendarGrid"></div>

            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">
                        ì›” í•©ê³„(ì „ì²´)
                        <span id="monthSelectedMemberTotalWrap" class="ms-2 d-none">Â· ì„ íƒ <span id="monthSelectedMemberNameLabel"></span>: <span id="monthSelectedMemberTotal"></span></span>
                    </div>
                    <div class="fw-semibold" id="monthActualTotalCell">0ì‹œê°„</div>
                </div>
            </div>
            <div class="small text-muted mt-2">
                * ë‚ ì§œ ì…€ì˜ <b>ì‚¬ëŒë³„ ë°°ì§€</b>ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ê·¼ë¡œìë¥¼ ì„ íƒ(ë°°ì§€ í…Œë‘ë¦¬ í‘œì‹œ)í•©ë‹ˆë‹¤.
                * <b>ìƒë‹¨ ì¹©ìœ¼ë¡œ ê·¼ë¡œìë¥¼ í•˜ì´ë¼ì´íŠ¸í•œ ê²½ìš°ì—ë§Œ</b> ì„ íƒëœ ë°°ì§€ ìœ„ì— <b>â€˜ê·¼ë¬´ì¼ì • ìˆ˜ì •â€™</b> ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                * <b>í•˜ì´ë¼ì´íŠ¸í•œ ê·¼ë¡œìì˜ ì¼ì •ì´ ì—†ëŠ” ë‚ ì§œ ì…€ì„ í´ë¦­</b>í•˜ë©´ ìš°ìƒë‹¨ì— <b>â€˜ì¼ì • ìƒì„±í•˜ê¸°â€™</b> ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
            </div>
            <span id="monthLabel" class="d-none">0000-00-01</span>
        </div>
    </div>
</main>

<!-- ===== í¸ì§‘ ëª¨ë‹¬ (ì¢Œ: ìš”ì•½ / ìš°: ê·¸ë¦¬ë“œ, 10/30/60, ê¸°ë³¸ 30 / ì €ì¥ì€ 10ë¶„ì—ì„œë§Œ) ===== -->
<div class="modal" id="editModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <div class="d-flex justify-content-between align-items-center mb-2 edit-modal-header">
                <div class="fw-bold">
                    <span id="editTitleDate">0000-00-00</span>
                    <span class="text-muted">/</span>
                    <span id="editTitleMember">ì•Œë°”ìƒ ì´ë¦„</span>
                </div>
                <div class="d-flex gap-2">
                    <!-- ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥ -->
                    <button id="btnSaveEdit" class="btn btn-sm btn-primary" disabled>ì €ì¥</button>
                    <button id="btnCancelEdit" class="btn btn-sm btn-outline-secondary">ì·¨ì†Œ</button>
                    <button id="btnCloseModal" class="btn btn-sm btn-outline-dark">ë‹«ê¸°</button>
                </div>
            </div>

            <div class="edit-modal-body">
                <div class="row g-3">
                    <!-- ì¢Œ: ì¼ì • ìš”ì•½ -->
                    <div class="col-12 col-md-5">
                        <div class="summary-box p-2 border rounded-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="small text-muted">ì¼ì • ìš”ì•½</div>
                                <span class="badge bg-light text-dark" id="summaryStepBadge">ìŠ¬ë¡¯: 30ë¶„</span>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">ì €ì¥ëœ ì¼ì •</div>
                                <div id="summaryOriginal" class="d-flex flex-wrap gap-2 small text-muted">
                                    <!-- ì›ë³¸ ì„¸ê·¸ë¨¼íŠ¸ ì¹© -->
                                </div>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">ìˆ˜ì •ì•ˆ(í˜„ì¬ ì„ íƒ)</div>
                                <div id="summaryCurrent" class="d-flex flex-wrap gap-2 small">
                                    <!-- í˜„ì¬ ì„ íƒ ì„¸ê·¸ë¨¼íŠ¸ ì¹© -->
                                </div>
                            </div>

                            <div class="mt-2 small">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ì›ë³¸ ì´ ì‹œê°„</span>
                                    <span id="summaryOriginalTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ìˆ˜ì •ì•ˆ ì´ ì‹œê°„</span>
                                    <span id="summaryCurrentTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ì¦ê°(ìˆ˜ì •ì•ˆ - ì›ë³¸)</span>
                                    <span id="summaryDiffTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                            </div>

                            <div class="mt-2 small">
                                <span class="legend legend-actual"></span> ì›ë³¸ ìœ ì§€ ë¸”ë¡
                                &nbsp;Â·&nbsp;
                                <span class="legend legend-plan" style="background: rgba(13,110,253,.16); border-color: rgba(13,110,253,.45)"></span> ìƒˆë¡œ ì¶”ê°€ëœ ë¸”ë¡(íŒŒë€ìƒ‰)
                            </div>
                        </div>
                    </div>

                    <!-- ìš°: í¸ì§‘ ê·¸ë¦¬ë“œ -->
                    <div class="col-12 col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" id="slotStepButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„">
                                <button type="button" class="btn btn-outline-secondary" data-step="10">10ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary active" data-step="30">30ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary" data-step="60">1ì‹œê°„</button>
                            </div>
                            <div class="small text-muted">ì‹œê°„ ìŠ¬ë¡¯ì„ ë“œë˜ê·¸ë¡œ ì„ íƒ/í•´ì œí•©ë‹ˆë‹¤. (06:00 ~ 22:00)</div>
                        </div>

                        <div class="day-grid mb-2">
                            <table id="dayGridTable">
                                <thead>
                                <tr>
                                    <th style="width:74px;">ì‹œê°„</th>
                                    <th>ì„ íƒ</th>
                                </tr>
                                </thead>
                                <tbody id="dayGridBody">
                                <!-- JS ë Œë” -->
                                </tbody>
                            </table>
                        </div>

                        <div class="text-end small">
                            ì´ ì„ íƒ: <span id="selectedMinutes" class="fw-bold">0</span>ë¶„
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    :root { --month-header-height: 80px; }

    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(13,110,253,.25); border-color: rgba(13,110,253,.45); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.40); }

    /* ===== ğŸ”µ ìƒë‹¨ ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœ íŒ¨ë„ (í—¤ë” í¬í•¨ ì „ì²´ íŒŒë€ ë°°ê²½ + ë¼ìš´ë“œ ì§ì‚¬ê°í˜•) ===== */
    .status-panel-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        border-radius: 18px;
        padding: 16px 20px 18px;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
        color: #e5eeff;
    }
    .status-title {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: .02em;
    }
    .status-subtitle-small {
        font-size: .8rem;
        margin-top: 2px;
        color: rgba(226, 232, 255, 0.78);
    }
    .status-period-label-caption {
        font-size: .75rem;
        color: rgba(226, 232, 255, 0.7);
    }
    .status-period-label-value {
        font-size: .85rem;
        font-weight: 600;
        margin-top: 1px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.32);
        border: 1px solid rgba(191, 219, 254, 0.6);
    }
    .status-label {
        color: rgba(226, 232, 255, 0.9) !important;
    }
    .status-help-text {
        color: rgba(226, 232, 255, 0.85) !important;
    }
    .status-subtitle {
        color: rgba(226, 232, 255, 0.9);
    }
    .status-caption {
        color: rgba(226, 232, 255, 0.8);
    }
    .status-legend-text {
        color: rgba(226, 232, 255, 0.85);
    }
    .status-count-badge {
        border-radius: 999px;
        padding: 3px 10px;
        font-weight: 600;
    }
    .status-select {
        background: rgba(15, 23, 42, 0.25);
        border-color: rgba(191, 219, 254, 0.6);
        color: #e5eeff;
    }
    .status-select:focus {
        background: rgba(15, 23, 42, 0.35);
        border-color: #bfdbfe;
        box-shadow: 0 0 0 0.2rem rgba(191, 219, 254, 0.45);
        color: #f9fbff;
    }
    .status-select option {
        color: #111827;
    }
    .status-pill-list {
        margin-top: 2px;
    }

    /* ===== ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸: ì¹© ìŠ¤íƒ€ì¼ (íŒŒë€ ë°°ê²½ì— ì–´ìš¸ë¦¬ê²Œ ì¡°ì •) ===== */
    .vlist { display:flex; flex-wrap:wrap; gap:8px; }
    .pill {
        display:flex; align-items:center; gap:8px; padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(191, 219, 254, 0.7);
        background: rgba(15, 23, 42, 0.18);
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s, transform .08s;
        color:#e5eeff;
    }
    .pill:hover {
        background: rgba(15, 23, 42, 0.28);
        border-color: rgba(248, 250, 252, 0.95);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.45);
    }
    .pill.active {
        border-color: rgba(191, 219, 254, 0.95);
        box-shadow: 0 0 0 2px rgba(191, 219, 254, 0.7), 0 10px 25px rgba(15, 23, 42, 0.55);
        background: rgba(15, 23, 42, 0.4);
        transform: translateY(-1px);
    }
    .pill .dot {
        width:12px; height:12px; border-radius:50%;
        border:1px solid rgba(15, 23, 42,.15);
        flex:0 0 12px;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:rgba(226, 232, 255, 0.8); font-size:.8rem; }

    /* âœ… ì¹´ë“œ í—¤ë” sticky (ë„¤ë¹„ ë†’ì´ ë°˜ì˜) */
    #monthCardHeader { position: sticky; top: 0; z-index: 30; background: #fff; }

    /* âœ… ìš”ì¼ ì¤„ sticky */
    .calendar-dow-row {
        display:grid; grid-template-columns:repeat(7,1fr);
        gap:8px; position: sticky; top: var(--month-header-height);
        z-index:25; background:#fff; padding-bottom:4px;
    }
    .calendar-dow-row .dow {
        text-align:center; font-weight:600; color:#6c757d;
        padding:6px 0; border-bottom:1px dashed #e9ecef;
    }

    /* ë‚ ì§œ ê·¸ë¦¬ë“œ */
    .calendar-grid {
        display:grid; grid-template-columns:repeat(7,1fr);
        gap:16px; margin-top:4px;
    }
    .calendar-grid .cell {
        border:1px solid #e9ecef; border-radius:10px; padding:10px;
        min-height:200px; background:#fff; display:flex; flex-direction:column;
        gap:8px; position:relative;
    }
    .cell .date-head { display:flex; align-items:center; justify-content:space-between; font-weight:600; font-size:.95rem; gap:8px; }
    .cell .segments { display:flex; flex-direction:column; gap:6px; }
    .cell .day-total { margin-top:auto; text-align:right; font-size:.875rem; color:#212529; }

    .cell.muted { background:#fcfcfc; color:#96a0aa; }
    .cell.today { outline:2px solid #51cf66; outline-offset:2px; }

    /* ì‚¬ëŒë³„ ë°°ì§€(ë¼ìš´ë“œ ì§ì‚¬ê°í˜•) + ì„ íƒ ìƒíƒœ + ìƒë‹¨ ë²„íŠ¼ */
    .member-badge {
        position: relative;
        display:flex; align-items:center; gap:8px;
        border-radius:10px; padding:6px 8px; line-height:1.1;
        border:1px solid rgba(0,0,0,.06); background:#f8f9fa; cursor:pointer;
        transition: transform .05s ease-in-out, box-shadow .1s ease-in-out, opacity .1s ease-in-out;
        font-size:.88rem;
    }
    .member-badge:hover { transform: translateY(-1px); box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .member-badge .color { width:12px; height:12px; border-radius:4px; border:1px solid rgba(0,0,0,.08); flex:0 0 12px; }
    .member-badge .label { font-weight:600; }
    .member-badge .times { color:#495057; font-size:.82rem; }
    .member-badge.selected { box-shadow: 0 0 0 2px rgba(13,110,253,.25); }

    .seg-edit-btn {
        position: absolute; top: -6px; right: -6px;
        transform: translateY(-100%);
        font-size: .7rem; line-height: 1.2; padding: 2px 6px;
    }

    /* í•˜ì´ë¼ì´íŠ¸(ì„ íƒ ê·¼ë¡œì ê°•ì¡° / íƒ€ì¸ íë¦¬ê²Œ) */
    .calendarGrid-hasHighlight .member-badge.dimmed { opacity:.35; }
    .calendarGrid-hasHighlight .member-badge.highlight { opacity:1; outline:2px solid rgba(13,110,253,.25); outline-offset:1px; }

    /* ===== ëª¨ë‹¬ ê³µí†µ ===== */
    .modal { background:rgba(0,0,0,.35); position:fixed; inset:0; display:none; z-index:1055; }
    .modal-dialog { margin:50px auto; max-width:980px; }
    .modal-content { background:#fff; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
    .edit-modal-header { padding-bottom:4px; border-bottom:1px solid #e9ecef; }
    .edit-modal-body { padding-top:8px; }

    .summary-box .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e9ecef; border-radius:14px; background:#fff; }
    .chip .dot { width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.08); }

    /* í•˜ë£¨ í¸ì§‘ ê·¸ë¦¬ë“œ */
    .day-grid {
        width:100%; border:1px solid #e5e7eb; border-radius:10px;
        overflow:hidden; user-select:none; background:#fff;
        max-height:70vh; overflow-y:auto;
    }
    .day-grid table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .day-grid thead th {
        background:#f8fafc; color:#64748b; font-weight:600; font-size:.95rem;
        border-bottom:1px solid #e5e7eb; text-align:center; padding:.6rem .4rem;
        position:sticky; top:0; z-index:2;
    }
    .day-grid tbody th.timecell {
        background:#fafafa; color:#6b7280; font-weight:600; width:74px;
        border-right:1px solid #e5e7eb; text-align:center; padding:.25rem .25rem;
        font-size:.85rem; position:sticky; left:0; z-index:1; font-variant-numeric:tabular-nums;
    }
    .row-hour-start td, .row-hour-start th { border-top:2px solid #e5e7eb!important; }

    .slot-cell { border-bottom:1px dashed #eef2f6; height:18px; cursor:pointer; background:#ffffff; transition: background .12s; }
    .slot-cell:hover { background:#f8fbff; }
    .slot-cell.selected { background:rgba(25,135,84,.18); box-shadow:inset 0 0 0 1px rgba(25,135,84,.25); }
    /* âœ… ì›ë³¸ ì¼ì •ì— ì—†ëŠ”ë° ìƒˆë¡œ ì„ íƒëœ ë¸”ë¡ì€ íŒŒë€ìƒ‰ */
    .slot-cell.selected.selected-diff { background:rgba(13,110,253,0.16); box-shadow:inset 0 0 0 1px rgba(13,110,253,0.45); border-color:rgba(13,110,253,0.55); }

    /* âœ… ë¹ˆ ì…€ì—ì„œ ì“°ëŠ” â€˜ì¼ì • ìƒì„±í•˜ê¸°â€™ ë²„íŠ¼ (ì…€ ìš°ìƒë‹¨ ê³ ì •) */
    .seg-create-btn{
        position:absolute; top:6px; right:6px;
        font-size:.7rem; line-height:1.2; padding:2px 6px;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        // ===== DOM =====
        const statusSelect = document.getElementById('statusSelect');
        const memberPills = document.getElementById('memberPills');

        const selectedMemberNameRight = document.getElementById('selectedMemberNameRight');
        const selectedMemberStatusRight = document.getElementById('selectedMemberStatusRight');

        const calendarDowRow = document.getElementById('calendarDowRow');
        const calendarGrid   = document.getElementById('calendarGrid');
        const emptyState     = document.getElementById('emptyState');
        const emptyTitle     = document.getElementById('emptyTitle');
        const emptyHint      = document.getElementById('emptyHint');
        const btnCreateFromEmpty = document.getElementById('btnCreateFromEmpty');

        const monthLabel = document.getElementById('monthLabel');
        const monthRangeLabel = document.getElementById('monthRangeLabel');
        const btnMonthPrev = document.getElementById('btnMonthPrev');
        const btnMonthThis = document.getElementById('btnMonthThis');
        const btnMonthNext = document.getElementById('btnMonthNext');
        const monthActualTotalCell = document.getElementById('monthActualTotalCell');

        const monthSelectedMemberTotalWrap = document.getElementById('monthSelectedMemberTotalWrap');
        const monthSelectedMemberNameLabel = document.getElementById('monthSelectedMemberNameLabel');
        const monthSelectedMemberTotal = document.getElementById('monthSelectedMemberTotal');

        const monthCardHeader = document.getElementById('monthCardHeader');

        // â–· ìƒë‹¨ í—¤ë”(â€œì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°â€ ìš°ì¸¡) ê¸°ê°„ í‘œì‹œ ì—˜ë¦¬ë¨¼íŠ¸
        const statusPeriodLabel = document.getElementById('statusPeriodLabel');

        // â–· â€œí•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒâ€ ì¤„ ì˜¤ë¥¸ìª½ ì¸ì›ìˆ˜ ë°°ì§€
        const statusCountBadgeTop = document.getElementById('statusCountBadgeTop');

        // ===== í¸ì§‘ ëª¨ë‹¬ =====
        const editModal = document.getElementById('editModal');
        const editTitleDate = document.getElementById('editTitleDate');
        const editTitleMember = document.getElementById('editTitleMember');
        const btnSaveEdit = document.getElementById('btnSaveEdit');
        const btnCancelEdit = document.getElementById('btnCancelEdit');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const slotStepButtons = document.getElementById('slotStepButtons');
        const dayGridBody = document.getElementById('dayGridBody');
        const selectedMinutesEl = document.getElementById('selectedMinutes');

        const summaryStepBadge = document.getElementById('summaryStepBadge');
        const summaryOriginal = document.getElementById('summaryOriginal');
        const summaryCurrent = document.getElementById('summaryCurrent');
        const summaryOriginalTotal = document.getElementById('summaryOriginalTotal');
        const summaryCurrentTotal = document.getElementById('summaryCurrentTotal');
        const summaryDiffTotal = document.getElementById('summaryDiffTotal');

        // ===== API =====
        const API_ENDPOINT = '/api/schedule/work';
        const API_UPDATE_ENDPOINT = '/api/schedule/work/update';

        // ===== ìƒíƒœ =====
        let allMembers = [];
        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); } catch(e){ allMembers = []; }
        if(Array.isArray(allMembers) && allMembers.length>0){
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        let currentMember = null;         // ìƒë‹¨ ì¹© í•˜ì´ë¼ì´íŠ¸(í¸ì§‘ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ê²°ì •)
        let currentMonthStart = firstDayOfMonth(new Date());
        let currentStatusMembers = [];

        // ì›” ë°ì´í„° ìºì‹œ & í•©ê³„
        let monthAllMembersDayMap = {};
        let lastMonthTotalByMember = {}; // { memberId: minutes }
        let lastMonthTotalAll = 0;

        // ë‹¬ë ¥ì—ì„œ "ì„ íƒëœ ë°°ì§€" (ë²„íŠ¼ ë…¸ì¶œìš©)
        let selectedBadge = null; // { dateIso, memberId } | null

        // âœ… í•˜ì´ë¼ì´íŠ¸ëœ ê·¼ë¡œìì˜ "ë¹ˆ ë‚ ì§œ ì…€" ì„ íƒ ìƒíƒœ (ì¼ì • ìƒì„± ë²„íŠ¼ í‘œì‹œìš©)
        let selectedEmptyDateIso = null;

        // ===== ëª¨ë‹¬/í¸ì§‘ ìƒíƒœ =====
        const START_HOUR = 6;
        const END_HOUR   = 22; // exclusive
        const START_MIN  = START_HOUR * 60;
        const END_MIN    = END_HOUR * 60;

        let stepMinutes  = 30;  // ê¸°ë³¸ 30ë¶„
        let totalRows    = (END_MIN - START_MIN) / stepMinutes;

        let originalSegments = [];        // ì„œë²„ì—ì„œ ë°›ì€ ì €ì¥ëœ ì¼ì •
        let originalSlotSet  = new Set(); // í˜„ì¬ step ê¸°ì¤€ ì›ë³¸ ìŠ¬ë¡¯ì…‹
        let slotState        = new Set(); // í˜„ì¬ ê·¸ë¦¬ë“œì—ì„œ ì„ íƒëœ ìŠ¬ë¡¯
        let dragging = false;
        let dragAdding = true;

        function updateMonthHeaderOffset() {
            if (!monthCardHeader) return;
            const fixedHeader = document.querySelector('.navbar.fixed-top, .fixed-top, header.sticky-top');
            const navH = fixedHeader ? fixedHeader.getBoundingClientRect().height : 0;
            const headerH = monthCardHeader.getBoundingClientRect().height || 0;
            monthCardHeader.style.top = navH + 'px';
            const dowOffset = navH + headerH;
            document.documentElement.style.setProperty('--month-header-height', dowOffset + 'px');
        }
        updateMonthHeaderOffset();
        window.addEventListener('resize', updateMonthHeaderOffset);

        // ì´ˆê¸°
        attachHandlers();
        renderMembersByStatus();

        function attachHandlers(){
            statusSelect.addEventListener('change', ()=> renderMembersByStatus());
            btnMonthPrev.addEventListener('click', (e)=>{ e.preventDefault(); shiftMonth(-1); });
            btnMonthNext.addEventListener('click', (e)=>{ e.preventDefault(); shiftMonth(+1); });
            btnMonthThis.addEventListener('click', (e)=>{ e.preventDefault(); goToThisMonth(); });

            // ì¼ì • ìƒì„±í•˜ê¸°(ë¹ˆ ìƒíƒœ): ì„ íƒ ë©¤ë²„ ê¸°ì¤€ íŒì—…
            if(btnCreateFromEmpty){
                btnCreateFromEmpty.addEventListener('click', ()=>{
                    if(!currentMember){
                        alert('ë¨¼ì € ìƒë‹¨ ì¹©ì—ì„œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ ì„ íƒí•˜ì„¸ìš”.');
                        return;
                    }
                    const baseMonthIso = (monthLabel.textContent || '').trim() || toIso(currentMonthStart);
                    const url = `/schedules/generator?memberId=${encodeURIComponent(currentMember.id)}&baseMonth=${encodeURIComponent(baseMonthIso)}`;
                    window.open(url, 'scheduleGenerator', 'width=1200,height=800,top=80,left=80,scrollbars=yes,resizable=yes');
                });
            }

            btnSaveEdit.addEventListener('click', onSaveEdit);
            btnCancelEdit.addEventListener('click', onCancelEdit);
            btnCloseModal.addEventListener('click', closeEditModal);
            editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });

            // ëª¨ë‹¬ ìŠ¬ë¡¯ ë‹¨ìœ„ ë²„íŠ¼
            if (slotStepButtons) {
                slotStepButtons.querySelectorAll('button[data-step]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        const newStep = parseInt(btn.dataset.step, 10);
                        if(!newStep || newStep === stepMinutes) {
                            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                            btn.classList.add('active');
                            updateSaveButton();
                            return;
                        }
                        stepMinutes = newStep;
                        totalRows = (END_MIN - START_MIN) / stepMinutes;
                        slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');

                        // step ë³€ê²½ ì‹œ ìš”ì•½ ë°°ì§€ í‘œì‹œ, ì›ë³¸/í˜„ì¬ ì¬ê³„ì‚°
                        summaryStepBadge.textContent = `ìŠ¬ë¡¯: ${stepMinutes===60?'1ì‹œê°„':(stepMinutes+'ë¶„')}`;

                        // ì›ë³¸ì„ ìƒˆ step ê¸°ì¤€ìœ¼ë¡œ ìŠ¬ë¡¯ì„¸íŠ¸í™”
                        originalSlotSet = segmentsToSlotSet(originalSegments, stepMinutes);
                        // í˜„ì¬ ì„ íƒë„ ì›ë³¸ ê¸°ì¤€ìœ¼ë¡œ ì´ˆê¸°í™”(í•„ìš” ì‹œ ìµœê·¼ ì„ íƒ ìœ ì§€í•˜ë ¤ë©´ ì£¼ì„ ì²˜ë¦¬)
                        slotState = new Set([...originalSlotSet]);

                        buildDayGrid();
                        updateSelectedMinutes();
                        renderLeftSummary();
                        updateSaveButton();
                    });
                });
            }

            window.addEventListener('mouseup', ()=>{ if(dragging){ dragging = false; }});
        }

        function updateSaveButton(){
            // ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥
            btnSaveEdit.disabled = (stepMinutes !== 10);

            // âœ… ëª¨ë‹¬ ëª¨ë“œì— ë”°ë¼ ë¼ë²¨ ë³€ê²½
            const mode = editModal.dataset.mode || 'edit';
            btnSaveEdit.textContent = (mode === 'create') ? 'ì¼ì • ìƒì„±' : 'ì €ì¥';
        }

        function renderMembersByStatus(){
            const status = statusSelect.value;
            const filtered = (allMembers||[]).filter(m=>m.status===status);
            currentStatusMembers = filtered;

            // â–· ì˜¤ë¥¸ìª½ ì¸ì› ë°°ì§€ ê°±ì‹ 
            if(statusCountBadgeTop){
                statusCountBadgeTop.textContent = `${filtered.length}ëª…`;
            }

            memberPills.innerHTML = '';

            if(!filtered.length){
                memberPills.innerHTML = `<span class="text-light small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                setHighlight(null);
                clearCalendarOnly();
                // ê¸°ê°„ ë¼ë²¨ì€ ìœ ì§€
                syncStatusPeriodWithMonthRange();
                return;
            }

            // ì¹© ë Œë”
            filtered
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m=>{
                        const color = colorForMember(m);
                        const row = document.createElement('button');
                        row.type = 'button';
                        row.className = 'pill';
                        row.dataset.memberId = String(m.id);
                        row.setAttribute('title','í•˜ì´ë¼ì´íŠ¸ í† ê¸€');
                        row.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        row.addEventListener('click', (evt)=>{
                            evt.preventDefault();
                            evt.stopPropagation();
                            if(currentMember && String(currentMember.id)===String(m.id)){
                                setHighlight(null);
                            }else{
                                setHighlight(m);
                            }
                        });
                        memberPills.appendChild(row);
                    });

            // ê¸°ë³¸: ì „ì²´ ë³´ê¸°
            setHighlight(null);
            renderAllMembersMonth(currentMonthStart);
        }

        function setHighlight(member){
            currentMember = member || null;

            // ì¹© active ì²˜ë¦¬
            Array.from(memberPills.querySelectorAll('.pill')).forEach(el=>el.classList.remove('active'));
            if(currentMember){
                const active = memberPills.querySelector(`.pill[data-member-id="${currentMember.id}"]`);
                if(active) active.classList.add('active');
                selectedMemberNameRight.textContent = `(í•˜ì´ë¼ì´íŠ¸: ${currentMember.name ?? '-'})`;
                selectedMemberStatusRight.classList.remove('d-none');
                const badgeMap={WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
                selectedMemberStatusRight.textContent = currentMember.status || '-';
                selectedMemberStatusRight.className = `badge ${badgeMap[currentMember.status]||'bg-secondary'} ms-2`;
                monthSelectedMemberNameLabel.textContent = currentMember.name ?? '-';
                monthSelectedMemberTotalWrap.classList.remove('d-none');
            }else{
                selectedMemberNameRight.textContent = '[í•˜ì´ë¼ì´íŠ¸: ì „ì²´]';
                selectedMemberStatusRight.classList.add('d-none');
                selectedMemberStatusRight.textContent = '-';
                selectedMemberStatusRight.className = 'badge bg-secondary ms-2 d-none';
                monthSelectedMemberTotalWrap.classList.add('d-none');
            }

            // í•˜ì´ë¼ì´íŠ¸ ë³€ê²½ ì‹œ ë‹¬ë ¥ ë°°ì§€ ì„ íƒ ë° ë¹ˆ ì…€ ì„ íƒ ì´ˆê¸°í™”
            selectedBadge = null;
            selectedEmptyDateIso = null;

            // ìº˜ë¦°ë” í•˜ì´ë¼ì´íŠ¸ & ë¹ˆìƒíƒœ ì²˜ë¦¬
            applyCalendarHighlight();
            updateSelectedMemberMonthTotal();
            applyEmptyStateAccordingToSelection();
            // ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ë²„íŠ¼ ë…¸ì¶œ ì¡°ê±´ ë°˜ì˜
            renderAllMembersMonth(currentMonthStart);
        }

        function clearCalendarOnly(){
            calendarGrid.innerHTML='';
            calendarDowRow.innerHTML='';
            monthRangeLabel.textContent='0000.00.01 ~ 00.00';
            monthActualTotalCell.textContent='0ì‹œê°„';
            emptyTitle.textContent = 'ì´ ë‹¬ì—ëŠ” ì €ì¥ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
            emptyHint.textContent = '* ìƒë‹¨ ì¹©ì—ì„œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ ì„ íƒí•œ í›„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            emptyState.classList.remove('d-none');
            calendarGrid.classList.add('d-none');
            calendarDowRow.classList.add('d-none');
        }

        function shiftMonth(offset){
            currentMonthStart = firstDayOfMonth(new Date(
                    currentMonthStart.getFullYear(),
                    currentMonthStart.getMonth()+offset,
                    1
            ));
            // ë‹¤ë¥¸ ë‹¬ë¡œ ë„˜ì–´ê°€ë©´ ë°°ì§€ ì„ íƒ/ë¹ˆì…€ ì„ íƒ í•´ì œ
            selectedBadge = null;
            selectedEmptyDateIso = null;
            renderAllMembersMonth(currentMonthStart);
        }
        function goToThisMonth(){
            currentMonthStart = firstDayOfMonth(new Date());
            selectedBadge = null;
            selectedEmptyDateIso = null;
            renderAllMembersMonth(currentMonthStart);
        }

        async function renderAllMembersMonth(baseDate){
            const ms = firstDayOfMonth(baseDate);
            const me = lastDayOfMonth(baseDate);
            currentMonthStart = ms;

            const monthStartIso = toIso(ms), monthEndIso = toIso(me);
            monthLabel.textContent = monthStartIso;
            const rangeText = `${ms.getFullYear()}.${pad2(ms.getMonth()+1)}.01 ~ ${pad2(me.getMonth()+1)}.${pad2(me.getDate())}`;
            monthRangeLabel.textContent = rangeText;

            // â–· ìƒë‹¨ í—¤ë” ìš°ì¸¡ ê¸°ê°„ ë¼ë²¨ ë™ê¸°í™”
            syncStatusPeriodWithMonthRange(rangeText);

            // ëª¨ë“  ê·¼ë¡œì í•´ë‹¹ ì›” ë°ì´í„° ë¡œë”©
            monthAllMembersDayMap = {};
            await Promise.all((currentStatusMembers||[]).map(async m=>{
                try{
                    const url = `${API_ENDPOINT}/${encodeURIComponent(m.id)}/${monthStartIso}/${monthEndIso}`;
                    const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                    if(!resp.ok) return;
                    const data = await resp.json();
                    monthAllMembersDayMap[m.id] = normalizeActualDays(data);
                }catch(e){ console.error(e); }
            }));

            // ìš”ì¼ í—¤ë”
            const DOW_HEAD = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            calendarDowRow.innerHTML = '';
            DOW_HEAD.forEach(label=>{
                const h = document.createElement('div');
                h.className = 'dow';
                h.textContent = label;
                calendarDowRow.appendChild(h);
            });

            // ë‚ ì§œ ê·¸ë¦¬ë“œ ë¹Œë“œ
            calendarGrid.innerHTML = '';
            const firstDow = ms.getDay();
            for(let i=0;i<firstDow;i++){
                const blank = document.createElement('div');
                blank.className = 'cell muted';
                calendarGrid.appendChild(blank);
            }

            const todayIso = toIso(new Date());

            // ì›” ì „ì²´ í•©ê³„/ì„ íƒ í•©ê³„
            lastMonthTotalAll = 0;
            const monthTotalByMember = {};
            lastMonthTotalByMember = monthTotalByMember; // ì°¸ì¡° ì €ì¥

            // ë‚ ì§œë³„ ë Œë”
            for(let d=new Date(ms); d<=me; d.setDate(d.getDate()+1)){
                const iso = toIso(d);
                const dow = d.getDay();

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.date = iso;
                if(iso===todayIso) cell.classList.add('today');

                // í•´ë‹¹ ë‚ ì§œì— ê·¼ë¬´ ìˆëŠ” ë©¤ë²„ ìˆ˜ì§‘
                const dayBadges = [];
                (currentStatusMembers||[]).forEach(m=>{
                    const day = (monthAllMembersDayMap[m.id]||{})[iso];
                    if(day && (day.minutes||0) > 0){
                        lastMonthTotalAll += (day.minutes||0);
                        monthTotalByMember[m.id] = (monthTotalByMember[m.id]||0) + (day.minutes||0);
                        dayBadges.push({member:m, day});
                    }
                });

                const segmentsWrap = document.createElement('div');
                segmentsWrap.className = 'segments';
                if(dayBadges.length===0){
                    segmentsWrap.innerHTML = `<span class="text-muted small">â€”</span>`;
                }else{
                    dayBadges
                            .sort((a,b)=> (a.member.name||'').localeCompare(b.member.name||'', 'ko'))
                            .forEach(({member, day})=>{
                                const color = colorForMember(member);
                                const isSelected = !!(selectedBadge && selectedBadge.dateIso===iso && String(selectedBadge.memberId)===String(member.id));
                                const isHighlightTarget = !!(currentMember && String(currentMember.id)===String(member.id));

                                const badge = document.createElement('div');
                                badge.className = `member-badge ${isSelected ? 'selected' : ''} ${isHighlightTarget ? 'highlight' : (currentMember?'dimmed':'')}`;
                                badge.dataset.memberId = String(member.id);
                                badge.dataset.date = iso;
                                badge.innerHTML = `
                                <span class="color" style="background:${color}; border-color:${color}"></span>
                                <span class="label">${escapeHtml(member.name ?? '-')}</span>
                                <span class="times">${segmentsToLabel(day.segments||[])}</span>
                                ${
                                        (isSelected && isHighlightTarget)
                                                ? `<button type="button" class="btn btn-xs btn-primary seg-edit-btn" data-date="${iso}" data-member="${member.id}">ê·¼ë¬´ì¼ì • ìˆ˜ì •</button>`
                                                : ``
                                }
                            `;

                                // ë°°ì§€ í´ë¦­: ì„ íƒ í† ê¸€(ë²„íŠ¼ ë…¸ì¶œ ì¡°ê±´ ì¶©ì¡± ì‹œì—ë§Œ ë²„íŠ¼ì´ ë³´ì„)
                                badge.addEventListener('click', (evt)=>{
                                    evt.stopPropagation();
                                    const already = selectedBadge && selectedBadge.dateIso===iso && String(selectedBadge.memberId)===String(member.id);
                                    selectedBadge = already ? null : { dateIso: iso, memberId: member.id };
                                    // ë¹ˆ ì…€ ì„ íƒì€ ìœ ì§€í•˜ì§€ ì•ŠìŒ
                                    selectedEmptyDateIso = null;
                                    renderAllMembersMonth(currentMonthStart);
                                });

                                segmentsWrap.appendChild(badge);
                            });
                }

                cell.innerHTML = `
                    <div class="date-head">
                      <span class="date-text">${d.getDate()}ì¼</span>
                      <span class="dow-mini">${DOW_HEAD[dow]}</span>
                    </div>
                `;
                cell.appendChild(segmentsWrap);

                // ë‚ ì§œ í•˜ë‹¨ í•©ê³„(í•´ë‹¹ ë‚ ì§œ ì „ì²´ í•©ê³„)
                const dayTotal = (dayBadges||[]).reduce((acc, x)=> acc + (x.day.minutes||0), 0);
                const totalEl = document.createElement('div');
                totalEl.className = 'day-total';
                totalEl.textContent = formatMins(dayTotal);
                cell.appendChild(totalEl);

                // âœ… ë¹ˆ ì…€ í´ë¦­ ì‹œ â€˜ì¼ì • ìƒì„±í•˜ê¸°â€™ ë²„íŠ¼ í† ê¸€
                cell.addEventListener('click', ()=>{
                    if(!currentMember) return;
                    const curDay = (monthAllMembersDayMap[currentMember.id]||{})[iso];
                    const hasAny = !!(curDay && (curDay.minutes||0) > 0);
                    if(hasAny) {
                        // ì¼ì •ì´ ìˆìœ¼ë©´ ë¹ˆì…€ ìƒì„±ë²„íŠ¼ì€ ì˜ë¯¸ ì—†ìŒ
                        selectedEmptyDateIso = null;
                        renderAllMembersMonth(currentMonthStart);
                        return;
                    }
                    // ë¹ˆ ì…€ í† ê¸€
                    selectedEmptyDateIso = (selectedEmptyDateIso === iso) ? null : iso;
                    // ë°°ì§€ ì„ íƒ í•´ì œ
                    selectedBadge = null;
                    renderAllMembersMonth(currentMonthStart);
                });

                // âœ… í˜„ì¬ ì…€ì— â€˜ì¼ì • ìƒì„±í•˜ê¸°â€™ ë²„íŠ¼ì´ ë– ì•¼ í•˜ëŠ”ì§€ ì²´í¬
                if(currentMember){
                    const curDay = (monthAllMembersDayMap[currentMember.id]||{})[iso];
                    const hasAny = !!(curDay && (curDay.minutes||0) > 0);
                    if(!hasAny && selectedEmptyDateIso === iso){
                        const createBtn = document.createElement('button');
                        createBtn.type = 'button';
                        createBtn.className = 'btn btn-xs btn-success seg-create-btn';
                        createBtn.dataset.date = iso;
                        createBtn.textContent = 'ì¼ì • ìƒì„±í•˜ê¸°';
                        cell.appendChild(createBtn);
                    }
                }

                calendarGrid.appendChild(cell);
            }

            // â€œê·¼ë¬´ì¼ì • ìˆ˜ì •â€ ë²„íŠ¼ ì´ë²¤íŠ¸(í•˜ì´ë¼ì´íŠ¸+ì„ íƒ ì¡°ê±´ ë§Œì¡±í•˜ëŠ” ê²½ìš°ì—ë§Œ ì¡´ì¬)
            calendarGrid.querySelectorAll('.seg-edit-btn').forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    const iso = btn.dataset.date;
                    const mid = btn.dataset.member;
                    const member = (currentStatusMembers||[]).find(m=> String(m.id)===String(mid));
                    const dayObj = (monthAllMembersDayMap[mid]||{})[iso] || {segments:[]};
                    openEditModal(iso, member, dayObj.segments||[], 'edit'); // âœ… í¸ì§‘ ëª¨ë“œ
                });
            });

            // âœ… â€œì¼ì • ìƒì„±í•˜ê¸°â€ ë²„íŠ¼ ì´ë²¤íŠ¸(ë¹ˆ ì…€ ì„ íƒ ì‹œ)
            calendarGrid.querySelectorAll('.seg-create-btn').forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    const iso = btn.dataset.date;
                    if(!currentMember) return;
                    openEditModal(iso, currentMember, [], 'create'); // âœ… ìƒì„± ëª¨ë“œ
                });
            });

            // ì›” í•©ê³„(ì „ì²´)
            monthActualTotalCell.textContent = formatMins(lastMonthTotalAll);

            // ì„ íƒëœ ê·¼ë¡œì í•©ê³„(ìˆë‹¤ë©´)
            updateSelectedMemberMonthTotal(monthTotalByMember);

            // ë¹„ì–´ìˆìŒ/í‘œì‹œ ì œì–´ (ì„ íƒì ìš°ì„ )
            applyEmptyStateAccordingToSelection();

            // ìº˜ë¦°ë” í•˜ì´ë¼ì´íŠ¸ ë°˜ì˜
            applyCalendarHighlight();
        }

        // â˜… ì„ íƒ ë©¤ë²„ ë¬´ì¼ì •ì´ë©´ ìº˜ë¦°ë” ìˆ¨ê¸°ê³  ë²„íŠ¼ë§Œ ë…¸ì¶œ
        function applyEmptyStateAccordingToSelection(){
            const ms = currentMonthStart;
            const monthStr = `${ms.getFullYear()}.${pad2(ms.getMonth()+1)}`;

            if(currentMember){
                const selTotal = (lastMonthTotalByMember && lastMonthTotalByMember[currentMember.id]) || 0;
                if(selTotal === 0){
                    emptyTitle.textContent = `${currentMember.name ?? 'ì„ íƒí•œ ê·¼ë¡œì'}ì˜ ${monthStr} ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.`;
                    emptyHint.textContent  = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¼ì • í…œí”Œë¦¿ì—ì„œ ìƒì„±í•˜ì„¸ìš”.';
                    emptyState.classList.remove('d-none');
                    calendarGrid.classList.add('d-none');
                    calendarDowRow.classList.add('d-none');
                    return;
                }
                // ì„ íƒ ë©¤ë²„ ì¼ì •ì´ ìˆìœ¼ë©´ ì •ìƒ ë…¸ì¶œ
                emptyState.classList.add('d-none');
                calendarGrid.classList.remove('d-none');
                calendarDowRow.classList.remove('d-none');
                return;
            }

            // ì„ íƒ ë©¤ë²„ê°€ ì—†ëŠ” ê²½ìš°: ì „ì²´ í•©ê³„ë¡œ íŒë‹¨
            if(lastMonthTotalAll === 0){
                emptyTitle.textContent = 'ì´ ë‹¬ì—ëŠ” ì €ì¥ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
                emptyHint.textContent  = '* ìƒë‹¨ ì¹©ì—ì„œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ ì„ íƒí•œ í›„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                emptyState.classList.remove('d-none');
                calendarGrid.classList.add('d-none');
                calendarDowRow.classList.add('d-none');
            }else{
                emptyState.classList.add('d-none');
                calendarGrid.classList.remove('d-none');
                calendarDowRow.classList.remove('d-none');
            }
        }

        function updateSelectedMemberMonthTotal(preComputed){
            const map = preComputed || (()=>{
                const acc = {};
                for (const m of (currentStatusMembers||[])) acc[m.id]=0;
                Object.entries(monthAllMembersDayMap||{}).forEach(([mid, dayMap])=>{
                    Object.values(dayMap||{}).forEach(v=>{
                        acc[mid] = (acc[mid]||0) + (v.minutes||0);
                    });
                });
                return acc;
            })();

            lastMonthTotalByMember = map;
            if(currentMember){
                const v = map[currentMember.id]||0;
                monthSelectedMemberTotal.textContent = formatMins(v);
            }
        }

        function applyCalendarHighlight(){
            if(!calendarGrid) return;
            const badges = calendarGrid.querySelectorAll('.member-badge');
            calendarGrid.classList.toggle('calendarGrid-hasHighlight', !!currentMember);
            badges.forEach(b=>{
                b.classList.remove('dimmed','highlight');
                if(currentMember){
                    const mid = b.dataset.memberId;
                    if(String(mid) === String(currentMember.id)) b.classList.add('highlight');
                    else b.classList.add('dimmed');
                }
            });
        }

        // ===== í¸ì§‘ ëª¨ë‹¬ ë¡œì§ =====
        function openEditModal(dateIso, member, segments, mode){
            if(!member) return;
            editTitleDate.textContent = dateIso;
            editTitleMember.textContent = member.name ?? '-';

            // ëª¨ë‹¬ ì´ˆê¸° ìƒíƒœ: ê¸°ë³¸ 30ë¶„
            stepMinutes = 30;
            totalRows = (END_MIN - START_MIN) / stepMinutes;
            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
            slotStepButtons.querySelector('button[data-step="30"]').classList.add('active');
            summaryStepBadge.textContent = 'ìŠ¬ë¡¯: 30ë¶„';

            // ì›ë³¸ ì„¸ê·¸ë¨¼íŠ¸ ì €ì¥ + í˜„ì¬ step ê¸°ì¤€ ìŠ¬ë¡¯ì…‹ ê³„ì‚°
            originalSegments = Array.isArray(segments) ? segments.slice() : [];
            originalSlotSet  = segmentsToSlotSet(originalSegments, stepMinutes);
            slotState        = new Set([...originalSlotSet]); // ê¸°ë³¸ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ

            // âœ… ëª¨ë‹¬ ëª¨ë“œ ì„¸íŒ… (edit | create)
            editModal.dataset.mode = (mode === 'create') ? 'create' : 'edit';

            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
            updateSaveButton(); // ì €ì¥ ë²„íŠ¼ì€ 10ë¶„ì—ì„œë§Œ í™œì„±í™” + ë¼ë²¨ ë™ê¸°

            editModal.dataset.memberId = String(member.id);
            editModal.dataset.dateIso = dateIso;

            editModal.style.display = 'block';
        }
        function closeEditModal(){ editModal.style.display = 'none'; }
        function onCancelEdit(){
            slotState = new Set([...originalSlotSet]);
            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
        }
        async function onSaveEdit(){
            if(stepMinutes !== 10){
                alert('ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            const mid = editModal.dataset.memberId;
            const dateIso = editModal.dataset.dateIso;
            if(!mid || !dateIso) return;

            const segments = slotSetToSegments(slotState, stepMinutes);
            try{
                const body = { memberId: mid, date: dateIso, segments };
                const resp = await fetch(API_UPDATE_ENDPOINT, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Accept':'application/json'},
                    body: JSON.stringify(body)
                });
                if(!resp.ok){
                    const text = await resp.text().catch(()=> '');
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${resp.status} ${text}`);
                    return;
                }
                closeEditModal();
                // ì €ì¥ í›„ ë‹¤ì‹œ ì›” ë Œë” (ì„ íƒ ìƒíƒœ ìœ ì§€)
                // ìƒì„± ëª¨ë“œì˜€ìœ¼ë©´ ë¹ˆì…€ ì„ íƒ í•´ì œ
                if((editModal.dataset.mode||'edit') === 'create'){
                    selectedEmptyDateIso = null;
                }
                renderAllMembersMonth(currentMonthStart);
            }catch(e){
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ===== í•˜ë£¨ ê²©ì =====
        function buildDayGrid(){
            dayGridBody.innerHTML = '';
            for(let idx=0; idx<totalRows; idx++){
                const tMin = START_MIN + idx*stepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                // 30ë¶„ ê°„ê²© ë ˆì´ë¸”
                th.textContent = (m%30===0) ? hmLabel : '';
                tr.appendChild(th);

                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = 'slot-cell';
                div.dataset.hm = hmLabel;

                if(slotState.has(hmLabel)){
                    div.classList.add('selected');
                    // ì›ë³¸ì— ì—†ë˜ ìŠ¬ë¡¯ì´ë©´(=ì‹ ê·œ ì¶”ê°€ ë¸”ë¡) íŒŒë€ìƒ‰ ê°•ì¡°
                    if(!originalSlotSet.has(hmLabel)){
                        div.classList.add('selected-diff');
                    }
                }
                td.appendChild(div);
                tr.appendChild(td);

                dayGridBody.appendChild(tr);
            }
            attachDragHandlers();
        }

        function attachDragHandlers(){
            dragging = false;
            dayGridBody.querySelectorAll('.slot-cell').forEach(div=>{
                div.addEventListener('mousedown', (e)=>{
                    e.preventDefault();
                    const hm = div.dataset.hm;
                    dragging = true;
                    const has = slotState.has(hm);
                    dragAdding = !has;
                    toggleSlot(div, dragAdding);
                });
                div.addEventListener('mouseenter', ()=>{
                    if(!dragging) return;
                    toggleSlot(div, dragAdding);
                });
            });
            window.addEventListener('mouseup', ()=> dragging=false);
        }

        function toggleSlot(el, on){
            const hm = el.dataset.hm;
            if(on){
                if(!slotState.has(hm)){
                    slotState.add(hm);
                    el.classList.add('selected');
                    if(!originalSlotSet.has(hm)) el.classList.add('selected-diff');
                }
            }else{
                if(slotState.has(hm)){
                    slotState.delete(hm);
                    el.classList.remove('selected');
                    el.classList.remove('selected-diff');
                }
            }
            updateSelectedMinutes();
            renderLeftSummary();
        }
        function updateSelectedMinutes(){ selectedMinutesEl.textContent = (slotState.size * stepMinutes)|0; }

        // ===== ì¢Œì¸¡ ìš”ì•½ =====
        function renderLeftSummary(){
            // ì›ë³¸ ëª©ë¡
            summaryOriginal.innerHTML = originalSegments.length
                    ? originalSegments.map(s => chipHtml('#198754', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const currentSegments = slotSetToSegments(slotState, stepMinutes);

            // í˜„ì¬ ëª©ë¡(ì¶”ê°€/ìœ ì§€ êµ¬ë¶„ì€ ì¹© ìƒ‰ìœ¼ë¡œëŠ” ë‹¨ìˆœ í‘œì‹œ, ìƒì„¸ëŠ” ì˜¤ë¥¸ìª½ ê·¸ë¦¬ë“œ íŒŒë€ìƒ‰)
            summaryCurrent.innerHTML = currentSegments.length
                    ? currentSegments.map(s => chipHtml('#0d6efd', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const orgMin = segmentsMinutes(originalSegments);
            const curMin = segmentsMinutes(currentSegments);
            summaryOriginalTotal.textContent = `${orgMin}ë¶„`;
            summaryCurrentTotal.textContent = `${curMin}ë¶„`;
            const diff = curMin - orgMin;
            summaryDiffTotal.textContent = (diff>=0?'+':'') + `${diff}ë¶„`;
            summaryDiffTotal.classList.toggle('text-primary', diff>0);
            summaryDiffTotal.classList.toggle('text-danger', diff<0);
        }

        // ===== ìœ í‹¸ =====
        function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
        function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        function displayHm(value){
            if(!value) return '';
            const parts = String(value).split(':');
            const h = parseInt(parts[0], 10) || 0;
            const m = parseInt(parts[1], 10) || 0;
            return `${pad2(h)}:${pad2(m)}`;
        }
        function segmentsToLabel(segments){
            if(!segments || !segments.length) return '';
            return segments.map(s=> `${displayHm(s.start)}~${displayHm(s.end)}`).join(', ');
        }

        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; } return h>>>0; }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        function formatMins(mins){
            const v = Math.max(0, mins|0);
            const h=Math.floor(v/60), m=v%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }

        function normalizeActualDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=> acc + (hmToMin(s.end) - hmToMin(s.start)), 0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const parts = String(hm).split(':').map(n=>parseInt(n,10));
            const h = parts[0] || 0;
            const m = parts[1] || 0;
            return h*60 + m;
        }
        function minToHm(min){
            const h=Math.floor(min/60), m=min%60;
            return `${pad2(h)}:${pad2(m)}`;
        }

        function segmentsToSlotSet(segments, step){
            const set = new Set();
            const startMin = START_HOUR*60;
            const endMin = END_HOUR*60;
            (segments||[]).forEach(seg=>{
                let s = Math.max(hmToMin(seg.start), startMin);
                let e = Math.min(hmToMin(seg.end), endMin);
                for(let t=s; t<e; t+=step){
                    set.add(minToHm(t));
                }
            });
            return set;
        }

        function slotSetToSegments(set, step){
            const sorted = Array.from(set).map(hmToMin).sort((a,b)=>a-b);
            const res = [];
            let i=0;
            while(i<sorted.length){
                let s = sorted[i], t = s + step; i++;
                while(i<sorted.length && sorted[i]===t){ t += step; i++; }
                res.push({start:minToHm(s), end:minToHm(t)});
            }
            return res;
        }

        function chipHtml(color, start, end){
            return `<span class="chip"><span class="dot" style="background:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }

        function segmentsMinutes(segs){
            return (segs||[]).reduce((acc,s)=> acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
        }

        // â–· ìƒë‹¨ ê¸°ê°„ ë¼ë²¨ ë™ê¸°í™” ìœ í‹¸
        function syncStatusPeriodWithMonthRange(overrideText){
            const text = overrideText || monthRangeLabel.textContent || '';
            if(statusPeriodLabel) statusPeriodLabel.textContent = text;
        }
    })();
</script>

{{>layouts/footer}}
