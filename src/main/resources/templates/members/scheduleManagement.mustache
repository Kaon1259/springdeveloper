{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ 왼쪽: 근로자 선택 + 정보 ============ -->
        <div class="col-12 col-lg-4">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <!-- 근로자 선택 -->
                <div class="card">
                    <div class="card-header fw-bold">시간제 근로자 선택</div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-12">
                                <label class="form-label small text-muted" for="statusSelect">상태</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>근무중</option>
                                    <option value="WAITING">시작전</option>
                                    <option value="RESTING">휴식중</option>
                                    <option value="PAUSED">일시중지</option>
                                    <option value="RESIGNED">퇴사</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted">근로자</label>
                                <div class="input-group">
                                    <select id="memberSelect" class="form-select">
                                        <option value="">상태를 선택하세요</option>
                                    </select>
                                    <button id="detailBtn" class="btn btn-primary" type="button" disabled>정보 수정</button>
                                </div>
                                <div class="form-text">상태를 선택하면 해당 상태의 근로자가 표시됩니다.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 근로자 정보 -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>
                          시간제 근로자 정보
                          <small id="createdAtLabel" class="text-muted ms-2">(등록일: -)</small>
                          <small id="updatedAtLabel" class="text-muted ms-2">(마지막수정일: -)</small>
                        </span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6"><div class="text-muted">이름</div><div id="infoName" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">성별</div><div id="infoGender" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">전화번호</div><div id="infoPhone" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">이메일</div><div id="infoEmail" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">시작일</div><div id="infoStartDate" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">보건증</div><div id="infoHealth" class="fw-semibold">-</div></div>
                            <div class="col-12"><div class="text-muted">시급(원)</div><div id="infoHourlyWage" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">은행</div><div id="infoBank" class="fw-semibold">-</div></div>
                            <div class="col-6"><div class="text-muted">계좌번호</div><div id="infoAccount" class="fw-semibold">-</div></div>
                        </div>
                    </div>
                </div>

                <!-- 범례 -->
                <div class="card">
                    <div class="card-body d-flex gap-3 align-items-center">
                        <span class="legend legend-plan"></span><span class="small">계획(주간 템플릿)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ 오른쪽: 생성/미리보기/저장 ============ -->
        <div class="col-12 col-lg-8">
            <div class="card mb-2">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>일정 생성(주간 템플릿 → 월별 일정)</span>
                    <span id="selectedMemberStatus" class="badge bg-secondary d-none">-</span>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label small text-muted">시작 월</label>
                            <input id="startMonth" type="month" class="form-control" />
                            <div class="form-text">기본값: 오늘이 속한 달</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small text-muted">개월 수</label>
                            <select id="monthsCount" class="form-select">
                                <option value="1">1개월</option>
                                <option value="2">2개월</option>
                                <option value="3" selected>3개월</option>
                                <option value="4">4개월</option>
                                <option value="5">5개월</option>
                                <option value="6">6개월</option>
                                <option value="12">12개월</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-4 d-flex align-items-end gap-2">
                            <button id="btnPreview" class="btn btn-outline-primary w-50" type="button">미리보기</button>
                            <button id="btnSave" class="btn btn-primary w-50" type="button" disabled>저장</button>
                        </div>
                    </div>
                    <div id="alertArea" class="mt-3"></div>
                </div>
            </div>

            <!-- N개월 달력 미리보기 -->
            <div class="card">
                <div class="card-header fw-bold">생성 미리보기</div>
                <div class="card-body">
                    <div id="previewContainer" class="d-grid gap-4"></div>
                    <div class="small text-muted mt-2">
                        * 근로자의 주간 템플릿을 기준으로 각 날짜에 “계획” 칩이 채워집니다. 저장하면 실제 일정으로 등록됩니다.
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .calendar-grid .dow { text-align:center; font-weight:600; color:#6c757d; padding:6px 0; border-bottom:1px dashed #e9ecef; }
    .calendar-grid .cell { border:1px solid #e9ecef; border-radius:10px; padding:8px; min-height:120px; background:#fff; display:flex; flex-direction:column; gap:6px; }
    .cell .date-head { display:flex; align-items:center; justify-content:space-between; font-weight:600; font-size:.95rem; }
    .cell .date-head .dow-mini { color:#6c757d; font-weight:500; font-size:.85rem; }
    .cell .segments { display:flex; flex-wrap:wrap; gap:6px; }
    .cell .day-total { margin-top:auto; text-align:right; font-size:.875rem; color:#212529; }
    .cell.muted { background:#fcfcfc; color:#96a0aa; }
    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(13,110,253,.25); border-color: rgba(13,110,253,.45); }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border:1px solid #dee2e6; border-radius:999px; }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        // ===== DOM =====
        const statusSelect = document.getElementById('statusSelect');
        const memberSelect = document.getElementById('memberSelect');
        const detailBtn = document.getElementById('detailBtn');

        const statusBadge = document.getElementById('statusBadge');
        const createdAtLabel = document.getElementById('createdAtLabel');
        const updatedAtLabel = document.getElementById('updatedAtLabel');

        const infoName = document.getElementById('infoName');
        const infoGender = document.getElementById('infoGender');
        const infoPhone = document.getElementById('infoPhone');
        const infoEmail = document.getElementById('infoEmail');
        const infoStartDate = document.getElementById('infoStartDate');
        const infoHealth = document.getElementById('infoHealth');
        const infoHourlyWage = document.getElementById('infoHourlyWage');
        const infoBank = document.getElementById('infoBank');
        const infoAccount = document.getElementById('infoAccount');

        const selectedMemberStatus = document.getElementById('selectedMemberStatus');

        const startMonth = document.getElementById('startMonth');
        const monthsCount = document.getElementById('monthsCount');
        const btnPreview = document.getElementById('btnPreview');
        const btnSave = document.getElementById('btnSave');
        const alertArea = document.getElementById('alertArea');
        const previewContainer = document.getElementById('previewContainer');

        // ===== 데이터 =====
        let allMembers = [];
        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); } catch(e){ allMembers = []; }
        if(Array.isArray(allMembers) && allMembers.length>0){
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        let currentMember = null;
        let generatedItems = []; // [{date, start, end, note?}, ...]

        // 기본 시작월: 오늘 달
        const today = new Date();
        startMonth.value = `${today.getFullYear()}-${pad2(today.getMonth()+1)}`;

        // 초기 렌더
        handleStatusChange();

        // ===== 이벤트 =====
        statusSelect.addEventListener('change', handleStatusChange);
        memberSelect.addEventListener('change', handleMemberChange);
        detailBtn.addEventListener('click', openEdit);
        btnPreview.addEventListener('click', onPreview);
        btnSave.addEventListener('click', onSave);

        async function onPreview(){
            clearAlert();
            if(!currentMember){
                showAlert('근로자를 먼저 선택하세요.', 'warning');
                return;
            }

            const {fromDate, toDate} = getRange();

            // 템플릿 → 날짜별 분해 (+유효성 검증, 중복 제거)
            generatedItems = buildItemsFromWeeklyTemplate(currentMember, fromDate, toDate);

            // 미리보기 렌더
            renderPreviewCalendars(fromDate, toDate, currentMember, generatedItems);

            btnSave.disabled = generatedItems.length === 0;
            if(generatedItems.length === 0){
                showAlert('생성된 일정이 없습니다. (주간 템플릿이 없거나, 범위 내 매칭이 없음)', 'secondary');
            }else{
                showAlert(`미리보기 완료: 총 ${generatedItems.length}개 구간이 생성됩니다.`, 'info');
            }
        }

        async function onSave(){
            clearAlert();
            if(!currentMember){
                showAlert('근로자를 먼저 선택하세요.', 'warning');
                return;
            }
            if(!generatedItems || generatedItems.length===0){
                showAlert('저장할 일정이 없습니다. 먼저 미리보기를 실행하세요.', 'warning');
                return;
            }
            const {fromDate, toDate} = getRange();

            const payload = {
                memberId: currentMember.id,
                from: toIso(fromDate),
                to: toIso(toDate),
                items: generatedItems
                // overwrite: 필요 시 true/false 추가 가능
            };

            try{
                const resp = await fetch('/api/schedule/generate', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Accept':'application/json'},
                    body: JSON.stringify(payload)
                });
                if(!resp.ok){
                    const text = await resp.text();
                    showAlert(`저장 실패: ${resp.status} ${text}`, 'danger');
                    return;
                }
                await resp.json().catch(()=>({}));
                showAlert('저장 완료!', 'success');
                // TODO: 저장 후 조회/새로고침 로직 필요 시 추가
            }catch(e){
                console.error(e);
                showAlert('저장 중 오류가 발생했습니다.', 'danger');
            }
        }

        function getRange(){
            const [y,m] = String(startMonth.value||'').split('-').map(n=>parseInt(n,10));
            const count = parseInt(monthsCount.value,10)||1;
            const fromDate = new Date(isNaN(y)?today.getFullYear():y, isNaN(m)?today.getMonth():m-1, 1);
            const toDate = new Date(fromDate.getFullYear(), fromDate.getMonth()+count, 0); // count개월 말일
            return { fromDate, toDate };
        }

        // 주간 템플릿 → 날짜별 아이템 생성
        function buildItemsFromWeeklyTemplate(member, fromDate, toDate){
            const weekly = getSchedules(member); // [{day:'MON', start:'10:00', end:'14:00'}, ...]
            if(!Array.isArray(weekly) || weekly.length===0) return [];

            const mapToJS={'SUN':0,'MON':1,'TUE':2,'WED':3,'THU':4,'FRI':5,'SAT':6};
            const dedupe = new Set();
            const items = [];

            for(let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate()+1)){
                const dow = d.getDay(); // 0~6
                const segs = weekly.filter(s => mapToJS[s.day] === dow);
                if(!segs.length) continue;
                const iso = toIso(d);

                segs.forEach(s=>{
                    const start = hmStr(s.start);
                    const end   = hmStr(s.end);

                    // 유효성: 시작<종료
                    if(!isValidRange(start, end)) return;

                    // 중복 제거(같은 날짜, 같은 구간)
                    const key = `${iso}|${start}|${end}`;
                    if(dedupe.has(key)) return;
                    dedupe.add(key);

                    items.push({date: iso, start, end, note: '자동 생성'});
                });
            }

            // 정렬(날짜, 시작시간)
            items.sort((a,b)=>{
                if(a.date !== b.date) return a.date < b.date ? -1 : 1;
                return a.start < b.start ? -1 : (a.start > b.start ? 1 : 0);
            });
            return items;
        }

        // 달력 미리보기(N개월)
        function renderPreviewCalendars(fromDate, toDate, member, items){
            previewContainer.innerHTML = '';

            // date→segments 맵
            const byDate = new Map();
            items.forEach(it=>{
                if(!byDate.has(it.date)) byDate.set(it.date, []);
                byDate.get(it.date).push({start: it.start, end: it.end});
            });

            // 월 단위로 분할 렌더
            let cur = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
            const endMonth = new Date(toDate.getFullYear(), toDate.getMonth(), 1);

            while(cur <= endMonth){
                const ms = new Date(cur.getFullYear(), cur.getMonth(), 1);
                const me = new Date(cur.getFullYear(), cur.getMonth()+1, 0);

                const section = document.createElement('section');
                section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="fw-semibold">${ms.getFullYear()}.${pad2(ms.getMonth()+1)}</div>
                  <div class="small text-muted">${ms.getFullYear()}.${pad2(ms.getMonth()+1)}.01 ~ ${pad2(me.getMonth()+1)}.${pad2(me.getDate())}</div>
                </div>
                <div class="calendar-grid"></div>
                <div class="mt-2 d-flex justify-content-between">
                  <div class="small text-muted">월 합계(계획)</div>
                  <div class="fw-semibold month-total">0시간</div>
                </div>
            `;
                const grid = section.querySelector('.calendar-grid');

                // 요일 헤더
                const DOW_HEAD = ['일','월','화','수','목','금','토'];
                DOW_HEAD.forEach(label=>{
                    const h = document.createElement('div');
                    h.className = 'dow';
                    h.textContent = label;
                    grid.appendChild(h);
                });

                const firstDow = ms.getDay(); // 0=일
                for(let i=0;i<firstDow;i++){
                    const blank = document.createElement('div');
                    blank.className = 'cell muted';
                    grid.appendChild(blank);
                }

                let monthMinutes = 0;
                for(let d=new Date(ms); d<=me; d.setDate(d.getDate()+1)){
                    const iso = toIso(d);
                    const segs = byDate.get(iso) || [];
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const chips = segs.length
                            ? segs.map(s=>chipHtml('#0d6efd', s.start, s.end)).join(' ')
                            : '<span class="text-muted small">—</span>';

                    const minutes = segs.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                    monthMinutes += minutes;

                    cell.innerHTML = `
                    <div class="date-head">
                      <span>${d.getDate()}일</span>
                      <span class="dow-mini">${DOW_HEAD[d.getDay()]}</span>
                    </div>
                    <div class="segments">${chips}</div>
                    <div class="day-total">${formatMins(minutes)}</div>
                `;
                    grid.appendChild(cell);
                }

                section.querySelector('.month-total').textContent = formatMins(monthMinutes);
                previewContainer.appendChild(section);

                // 다음 달
                cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1);
            }
        }

        // ===== 멤버/정보 렌더 =====
        function handleStatusChange(){
            const status = statusSelect.value;
            const filtered = (allMembers||[]).filter(m=>m.status===status);
            memberSelect.innerHTML = '';
            detailBtn.disabled = true;

            if(!filtered.length){
                memberSelect.innerHTML='<option value="">해당 상태의 근로자가 없습니다</option>';
                clearInfo();
                return;
            }
            memberSelect.appendChild(new Option('근로자를 선택하세요',''));
            filtered.forEach(m=>memberSelect.appendChild(new Option(`${m.name ?? '-'} (${m.gender ?? '-'})`, String(m.id))));
            memberSelect.value = String(filtered[0].id);
            detailBtn.disabled = false;
            renderMember(filtered[0]);
        }
        function handleMemberChange(){
            const status=statusSelect.value;
            const filtered=(allMembers||[]).filter(m=>m.status===status);
            const id = Number(memberSelect.value);
            const m = filtered.find(x=>x.id===id);
            detailBtn.disabled=!m;
            if(m) renderMember(m); else clearInfo();
        }
        function renderMember(m){
            currentMember = m;
            infoName.textContent=m.name ?? '-';
            infoGender.textContent=m.gender ?? '-';
            infoPhone.textContent=m.phone ?? '-';
            infoEmail.textContent=m.email ?? '-';
            infoStartDate.textContent=m.startDate ?? '-';
            infoHealth.textContent = m.hasHealthCertificate ? (m.healthCertExpiry ? `보유 (유효기간: ${m.healthCertExpiry})` : '보유') : '미보유';
            infoHourlyWage.textContent=(typeof m.hourlyWage==='number') ? krw(m.hourlyWage) : '-';
            infoBank.textContent = m.bankName ?? '-';
            infoAccount.textContent = m.bankAccount ?? '-';

            // 등록/수정일 라벨
            createdAtLabel.textContent = `(등록일: ${fmtDateTime(m?.createdAt ?? m?.created_at)})`;
            updatedAtLabel.textContent = `(마지막수정일: ${fmtDateTime(m?.updatedAt ?? m?.updated_at)})`;

            const badgeMap={WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            statusBadge.textContent=m.status || '-';
            statusBadge.className=`badge ${badgeMap[m.status]||'bg-secondary'}`;

            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = m?.status || '-';
            selectedMemberStatus.className = `badge ${badgeMap[m.status]||'bg-secondary'}`;

            // 미리보기 초기화
            previewContainer.innerHTML='';
            generatedItems = [];
            btnSave.disabled = true;
            clearAlert();
        }
        function clearInfo(){
            currentMember = null;
            [infoName,infoGender,infoPhone,infoEmail,infoStartDate,infoHealth,infoHourlyWage,infoBank,infoAccount].forEach(el=>el.textContent='-');
            statusBadge.textContent='-'; statusBadge.className='badge bg-secondary';
            createdAtLabel.textContent='(등록일: -)';
            updatedAtLabel.textContent='(마지막수정일: -)';
            selectedMemberStatus.classList.add('d-none');
            previewContainer.innerHTML='';
            generatedItems = [];
            btnSave.disabled = true;
            clearAlert();
        }
        function openEdit(){
            const id = Number(memberSelect.value||0);
            if(!id){ alert('근로자를 선택하세요.'); return; }
            window.location.assign(`/members/${id}/edit`);
        }

        // ===== 공통 유틸 =====
        function getSchedules(m){
            // 기존 구조 호환: schedules | schedule
            return Array.isArray(m?.schedules) ? m.schedules
                    : Array.isArray(m?.schedule)  ? m.schedule
                            : [];
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function hmStr(v){
            // "HH:mm" or Date-like → "HH:mm"
            if(typeof v === 'string' && /^\d{2}:\d{2}$/.test(v)) return v;
            if(typeof v === 'string' && /^\d{2}:\d{2}:\d{2}$/.test(v)) return v.slice(0,5); // "HH:mm:ss" -> "HH:mm"
            if(v && typeof v === 'object' && 'hour' in v && 'minute' in v) return `${pad2(v.hour)}:${pad2(v.minute)}`;
            try{
                const s = String(v);
                if(/^\d{1,2}:\d{1,2}/.test(s)){
                    const [h,m] = s.split(':').map(n=>parseInt(n,10));
                    return `${pad2(h)}:${pad2(m||0)}`;
                }
            }catch(_){}
            return '00:00';
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function isValidRange(start, end){
            const s = parseHm(start), e = parseHm(end);
            const diff = (e.h*60+e.m) - (s.h*60+s.m);
            return diff > 0;
        }
        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function formatMins(mins){
            const h=Math.floor(mins/60), m=mins%60;
            return m===0?`${h}시간`:`${h}시간 ${m}분`;
        }
        function krw(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="legend legend-plan" style="background:${color};border-color:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function fmtDateTime(v){
            if(!v) return '-';
            if(typeof v === 'number'){
                const ms = v < 1e12 ? v*1000 : v;
                const d = new Date(ms);
                return isNaN(d.getTime())?'-':`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
            }
            const d = new Date(v);
            return isNaN(d.getTime())?'-':`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }

        // 알림
        function showAlert(msg, type='info'){
            alertArea.innerHTML = `<div class="alert alert-${type} py-2 px-3" role="alert">${escapeHtml(msg)}</div>`;
        }
        function clearAlert(){ alertArea.innerHTML=''; }
        function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    })();
</script>

{{>layouts/footer}}
