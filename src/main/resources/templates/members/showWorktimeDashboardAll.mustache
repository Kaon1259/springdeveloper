{{>layouts/header_}}

<main class="container my-4">
    <!-- í•˜ë‹¨: ì£¼ê°„ ìº˜ë¦°ë” (ì›”~ì¼, ê°€ë¡œ 7ì»¬ëŸ¼) + ì¢Œì¸¡ì— ì•„ë¥´ë°”ì´íŠ¸ìƒ ì´ë¦„ + ë§ˆì§€ë§‰ ì£¼ê°„í•©ê³„ ì»¬ëŸ¼ -->
    <div class="card">
        <div class="card-header week-card-header-blue fw-bold d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <span>ì£¼ê°„ ìº˜ë¦°ë” (ì›”~ì¼)</span>

                <!-- ğŸ”¹ ìƒíƒœ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                <select id="statusSelect" class="form-select status-header-select">
                    <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                    <option value="WAITING">ì‹œì‘ì „</option>
                    <option value="RESTING">íœ´ì‹ì¤‘</option>
                    <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                    <option value="RESIGNED">í‡´ì‚¬</option>
                </select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-light">â—€ ì§€ë‚œì£¼</button>
                <span id="weekRangeLabelRight" class="small text-light px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-light">ê¸ˆì£¼</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-light">ë‹¤ìŒì£¼ â–¶</button>
            </div>
        </div>
        <div class="card-body">
            <div id="noMemberState" class="text-muted small d-none">
                í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </div>

            <div id="weekCalendarWrapper">
                <!-- ì£¼ê°„ ë©¤ë²„ Ã— ìš”ì¼ í…Œì´ë¸” -->
                <div class="week-calendar-grid" id="weekCalendarGrid">
                    <!-- JSì—ì„œ table ìƒì„± -->
                </div>
            </div>

            <div class="small text-muted mt-2">
                * ê° ì¹¸ì˜ ìƒë‹¨ì—ëŠ” <strong>ê³„íš ì¼ì •</strong>, í•˜ë‹¨ì—ëŠ” <strong>ì‹¤ì œ ê·¼ë¬´ êµ¬ê°„</strong> ì¹©ì´ í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ì¢Œì¸¡ì—ëŠ” ìƒíƒœ í•„í„°ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ì•„ë¥´ë°”ì´íŠ¸ìƒ ì´ë¦„ì´ í‘œì‹œë˜ë©°,<br>
                &nbsp;&nbsp;ê° í–‰ì€ í•´ë‹¹ ì•„ë¥´ë°”ì´íŠ¸ìƒì˜ ì£¼ê°„ ê·¼ë¬´ê³„íš / ì‹¤ì œ ê·¼ë¬´ì‹œê°„ì…ë‹ˆë‹¤.<br>
                * ê° ë¼ìš´ë“œë ‰íŠ¸ ì¹¸ í•˜ë‹¨ì—ëŠ” í•´ë‹¹ ì¼ìì˜ ì‹¤ì œ ê·¼ë¬´ì‹œê°„ í•©ê³„ê°€ í‘œì‹œë˜ê³ ,<br>
                &nbsp;&nbsp;í…Œì´ë¸” ë§ˆì§€ë§‰ í–‰ì—ëŠ” ìš”ì¼ë³„ ì „ì²´ ì‹¤ì œ í•©ê³„ê°€, ë§ˆì§€ë§‰ ì»¬ëŸ¼ì—ëŠ”<br>
                &nbsp;&nbsp;ê° ì•„ë¥´ë°”ì´íŠ¸ìƒ/ì „ì²´ì˜ <strong>ì£¼ê°„ ê³„íš ë° ì‹¤ì œ ê·¼ë¬´ì‹œê°„ í•©ê³„</strong>ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</main>

<style>
    /* ==== ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœ íŒ¨ë„ ê³µí†µ (í˜„ì¬ í™”ë©´ì—ëŠ” ë¯¸ì‚¬ìš©ì¼ ìˆ˜ ìˆìŒ) ==== */
    .status-panel-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        border-radius: 18px;
        padding: 16px 18px 18px;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
        color: #e5eeff;
    }
    .status-panel-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 10px;
    }
    .status-panel-title {
        font-weight: 700;
        font-size: 1rem;
        color:#f9fbff;
    }
    .status-panel-period {
        font-size:.85rem;
        opacity:.9;
    }
    .status-panel-body { margin-top: 4px; }

    .status-panel-blue .form-label,
    .status-panel-blue .form-text,
    .status-panel-blue .small.text-muted {
        color: #dbeafe !important;
    }
    .status-panel-blue .badge.bg-light {
        background:#e5eeff !important;
        color:#0f172a !important;
    }

    .status-panel-blue .vlist {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
    }
    .status-panel-blue .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(191,219,254,0.55);
        background: rgba(15,23,42,0.20);
        font-size:.9rem;
        color:#e5eeff;
    }
    .status-panel-blue .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(15,23,42,.5);
        flex:0 0 12px;
    }
    .status-panel-blue .pill .name { font-weight:600; }
    .status-panel-blue .pill .meta {
        color:#cbd5f5;
        font-size:.8rem;
    }

    /* ê³µí†µ ì¹© ëª¨ì–‘ */
    .chip {
        display:inline-flex;
        align-items:center;
        gap:6px;
        border:1px solid #e9ecef;
        border-radius:14px;
        padding:4px 8px;
        background:#fff;
        font-size:.8rem;
    }

    /* ìƒë‹¨ ë¦¬ìŠ¤íŠ¸(ê¸°ë³¸ ìŠ¤íƒ€ì¼) */
    .vlist {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        font-size:.9rem;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:#6c757d; font-size:.8rem; }

    /* ===== ì£¼ê°„ ìº˜ë¦°ë” ì¹´ë“œ í—¤ë” íŒŒë€ìƒ‰ ===== */
    .week-card-header-blue {
        background: #1d4ed8;
        color:#f9fbff;
    }
    .week-card-header-blue .form-select.status-header-select {
        height: 32px;
        padding: 2px 32px 2px 8px;
        font-size: .85rem;
        border-radius: 999px;
        border: 1px solid rgba(191,219,254,0.85);
        background: rgba(15,23,42,0.22);
        color: #e5eeff;
    }
    .week-card-header-blue .form-select.status-header-select:focus {
        background: rgba(15,23,42,0.30);
        border-color:#bfdbfe;
        box-shadow:0 0 0 0.12rem rgba(191,219,254,0.6);
        color:#f9fbff;
    }

    .week-card-header-blue .btn-outline-light {
        border-color: rgba(226,232,240,0.8);
        color:#e2e8f0;
    }
    .week-card-header-blue .btn-outline-light:hover {
        background:#e2e8f0;
        color:#1e293b;
    }

    /* ===== ì£¼ê°„ ìº˜ë¦°ë” ===== */

    .week-calendar-grid {
        overflow-x: auto;
        padding: 4px;
    }

    .week-calendar-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 900px;
        font-size: .9rem;

        /* ğŸ”¹ ë‚´ë¶€ í…Œì´ë¸”ì„ ë¼ìš´ë“œë ‰íŠ¸ë¡œ */
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 8px 20px rgba(15,23,42,0.06);
        background: #ffffff;
        overflow: hidden;
    }
    .week-calendar-table thead th {
        background: #f8fafc;
        border: 1px solid #e9ecef;
        text-align: center;
        padding: 6px 4px;
        font-weight: 600;
        vertical-align: middle;
    }
    /* ğŸ”¹ ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ (ì²«/ë§ˆì§€ë§‰ ì…€) */
    .week-calendar-table thead th:first-child {
        border-top-left-radius: 14px;
    }
    .week-calendar-table thead th:last-child {
        border-top-right-radius: 14px;
    }
    .week-calendar-table tbody tr:last-child td:first-child {
        border-bottom-left-radius: 14px;
    }
    .week-calendar-table tbody tr:last-child td:last-child {
        border-bottom-right-radius: 14px;
    }

    /* ğŸ”¹ ì•„ë¥´ë°”ì´íŠ¸ìƒ ì»¬ëŸ¼: ì—°í•œ í•˜ëŠ˜ìƒ‰ í†¤ */
    .week-calendar-table thead th.member-header-cell {
        min-width: 140px;
        width: 160px;
        text-align: left;
        background:#dbeafe;   /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
        color:#0f172a;
    }
    .week-calendar-table thead th.week-total-header {
        min-width: 140px;
        width: 160px;
    }
    .week-calendar-table thead th.today-col {
        outline: 2px solid #51cf66;
        outline-offset: -2px;
    }
    .week-calendar-table tbody td {
        border: 1px solid #e9ecef;
        padding: 6px;
        vertical-align: top;
        background:#fff;
    }
    .week-calendar-table tbody td.member-cell {
        white-space: nowrap;
        font-weight: 600;
        background:#dbeafe;   /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
        color:#0f172a;
    }
    .week-calendar-table tbody td.member-total-cell {
        background:#f8fafc;
        text-align:right;
    }
    .week-calendar-table tbody tr.summary-row td {
        background:#f1f3f5;
        font-weight:600;
        text-align:right;
    }
    .week-calendar-table tbody tr.summary-row td.member-cell {
        background:#dbeafe;   /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
        color:#0f172a;
        text-align:left;
    }

    .member-dot {
        display:inline-block;
        width:10px;
        height:10px;
        border-radius:50%;
        margin-right:4px;
        border:1px solid rgba(15,23,42,0.2);
        background:#fff;
    }
    .member-name-wrap {
        display:block;
    }

    .member-week-total-strong {
        font-size:.8rem;
        color:#495057;
    }

    .dow-mini {
        display:inline-block;
        font-size:.75rem;
        color:#6c757d;
    }

    .week-cell {
        border-radius: 10px;
        background:#fff;
        display:flex;
        flex-direction:column;
        gap:4px;
    }
    .week-cell-rect {
        border-radius: 8px;
        padding: 4px 6px;
        min-height: 32px;
    }
    .week-cell-rect-bottom {
        border: 1px solid #e9ecef;
        background: #fcfcfc;
    }
    .week-cell-rect-top {
        border: 1px solid rgba(25,135,84,0.5);
        background: rgba(25,135,84,0.04);
    }
    .week-cell-rect-top .segments { color:#198754; }

    .week-cell .segments {
        display:flex;
        flex-wrap:wrap;
        gap:4px;
        align-items:flex-start;
    }

    .day-total {
        margin-top: 2px;
        font-size: .75rem;
        color:#495057;
        text-align:right;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function () {
        const API_WORK   = '/api/schedule';        // ì‹¤ì œ: GET /{memberId}/{start}/{end}
        const API_PLAN   = '/api/schedule/work';   // ê³„íš: GET /{memberId}/{start}/{end}
        const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

        // DOM
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');

        const noMemberState       = document.getElementById('noMemberState');
        const weekCalendarWrapper = document.getElementById('weekCalendarWrapper');
        const weekCalendarGrid    = document.getElementById('weekCalendarGrid');

        const btnPrevWeek         = document.getElementById('btnPrevWeek');
        const btnThisWeek         = document.getElementById('btnThisWeek');
        const btnNextWeek         = document.getElementById('btnNextWeek');

        // ìƒíƒœ
        let allMembers = [];
        let currentStatusMembers = [];
        let currentWeekStart = toMonday(new Date());

        // memberId -> { dateIso -> { segments, minutes } }
        let weekPlanByMember   = {};
        let weekActualByMember = {};

        // membersJson íŒŒì‹±
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch (e) {
            allMembers = [];
        }

        attachHandlers();
        handleStatusChange();

        function attachHandlers() {
            statusSelect.addEventListener('change', handleStatusChange);

            if (btnPrevWeek) btnPrevWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, -7);
                handleStatusChange();
            });
            if (btnThisWeek) btnThisWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = toMonday(new Date());
                handleStatusChange();
            });
            if (btnNextWeek) btnNextWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, +7);
                handleStatusChange();
            });
        }

        /* ===== ìƒíƒœ ë³€ê²½ ì‹œ ì „ì²´ íë¦„ ===== */
        function handleStatusChange() {
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            renderMemberList(currentStatusMembers);
            renderWeekRangeLabel(currentWeekStart);

            if (currentStatusMembers.length === 0) {
                if (noMemberState) noMemberState.classList.remove('d-none');
                if (weekCalendarWrapper) weekCalendarWrapper.classList.add('d-none');
                if (weekCalendarGrid) weekCalendarGrid.innerHTML = '';
                return;
            }

            if (noMemberState) noMemberState.classList.add('d-none');
            if (weekCalendarWrapper) weekCalendarWrapper.classList.remove('d-none');

            loadWeekForCurrentStatusMembers();
        }

        /* ===== ìƒë‹¨ í•„í„°ëœ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ (ì§€ê¸ˆì€ d-none ì˜ì—­ì´ì§€ë§Œ ë°ì´í„°ëŠ” ìœ ì§€) ===== */
        function renderMemberList(members) {
            if (!memberList || !memberCountBadge) return;

            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if (members.length === 0) {
                memberList.innerHTML = `<span class="text-muted small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const color = colorForMember(m);
                        const pill = document.createElement('div');
                        pill.className = 'pill';
                        pill.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        memberList.appendChild(pill);
                    });
        }

        /* ===== ì£¼ê°„ ë²”ìœ„ ë¼ë²¨ ===== */
        function renderWeekRangeLabel(weekStart) {
            const weekEnd = addDays(weekStart, 6);
            const sY = weekStart.getFullYear();
            const sM = pad2(weekStart.getMonth()+1);
            const sD = pad2(weekStart.getDate());
            const eM = pad2(weekEnd.getMonth()+1);
            const eD = pad2(weekEnd.getDate());
            const label = `${sY}.${sM}.${sD} ~ ${eM}.${eD}`;
            if (weekRangeLabel) weekRangeLabel.textContent = label;
            if (weekRangeLabelRight) weekRangeLabelRight.textContent = label;
        }

        /* ===== í•„í„°ëœ ëª¨ë“  ë©¤ë²„ì— ëŒ€í•œ ì£¼ê°„ ê³„íš/ì‹¤ì œ ë°ì´í„° ë¡œë”© ===== */
        async function loadWeekForCurrentStatusMembers() {
            weekPlanByMember   = {};
            weekActualByMember = {};

            const weekStart = currentWeekStart;
            const weekEnd   = addDays(weekStart, 6);
            const startIso  = toIso(weekStart);
            const endIso    = toIso(weekEnd);

            const members = currentStatusMembers.slice();

            await Promise.all(members.map(async (m) => {
                const memberId = m.id;
                weekPlanByMember[memberId]   = {};
                weekActualByMember[memberId] = {};
                try {
                    const [planResp, workResp] = await Promise.all([
                        fetch(`${API_PLAN}/${encodeURIComponent(memberId)}/${startIso}/${endIso}`, { headers: { 'Accept':'application/json' }}),
                        fetch(`${API_WORK}/${encodeURIComponent(memberId)}/${startIso}/${endIso}`, { headers: { 'Accept':'application/json' }}),
                    ]);

                    if (planResp.ok) {
                        const planData = await planResp.json();
                        weekPlanByMember[memberId] = normalizeDays(planData, false);
                    }
                    if (workResp.ok) {
                        const workData = await workResp.json();
                        weekActualByMember[memberId] = normalizeDays(workData, true);
                    }
                } catch (e) {
                    console.error('ì£¼ê°„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (memberId=', memberId, ')', e);
                }
            }));

            renderWeekCalendar();
        }

        /* ===== ë©¤ë²„ Ã— ìš”ì¼ ì£¼ê°„ ìº˜ë¦°ë” ë Œë” ===== */
        function renderWeekCalendar() {
            if (!weekCalendarGrid) return;

            weekCalendarGrid.innerHTML = '';

            const weekStart = currentWeekStart;
            const todayIso  = toIso(new Date());

            const weekDates = [];
            for (let i=0;i<7;i++) {
                weekDates.push(addDays(weekStart, i));
            }

            const table = document.createElement('table');
            table.className = 'week-calendar-table';

            // í—¤ë”
            const thead = document.createElement('thead');
            const headTr = document.createElement('tr');

            const thName = document.createElement('th');
            thName.className = 'member-header-cell';
            thName.textContent = 'ì•„ë¥´ë°”ì´íŠ¸ìƒ';
            headTr.appendChild(thName);

            weekDates.forEach((date, idx) => {
                const th = document.createElement('th');
                const iso = toIso(date);
                const labelDate = `${pad2(date.getMonth()+1)}/${pad2(date.getDate())}`;
                const dow = DOW_LABELS[idx] || '';
                th.innerHTML = `${labelDate}<br><span class="dow-mini">${dow}</span>`;
                if (iso === todayIso) {
                    th.classList.add('today-col');
                }
                headTr.appendChild(th);
            });

            // ğŸ”¹ ë§ˆì§€ë§‰ ì»¬ëŸ¼: ì£¼ê°„ í•©ê³„
            const thWeek = document.createElement('th');
            thWeek.className = 'week-total-header';
            thWeek.textContent = 'ì£¼ê°„ í•©ê³„';
            headTr.appendChild(thWeek);

            thead.appendChild(headTr);
            table.appendChild(thead);

            // ë°”ë””: ë©¤ë²„ë³„ í–‰
            const tbody = document.createElement('tbody');

            // ìš”ì¼ë³„ ì „ì²´ ì‹¤ì œ í•©ê³„
            const dayActualTotals = new Array(7).fill(0);
            // ì „ì²´(ëª¨ë“  ë©¤ë²„) ì£¼ê°„ ê³„íš/ì‹¤ì œ í•©ê³„
            let allMembersWeeklyPlanTotal   = 0;
            let allMembersWeeklyActualTotal = 0;

            currentStatusMembers.forEach((member) => {
                const tr = document.createElement('tr');

                // ì¢Œì¸¡ ì´ë¦„ ì…€
                const nameTd = document.createElement('td');
                nameTd.className = 'member-cell';
                const color = colorForMember(member);
                nameTd.innerHTML = `
                    <span class="member-name-wrap">
                        <span class="member-dot" style="background:${color}"></span>
                        <span>${escapeHtml(member.name || '-')}</span>
                    </span>
                `;
                tr.appendChild(nameTd);

                let memberPlanTotalMins   = 0; // ğŸ”¹ ì•„ë¥´ë°”ì´íŠ¸ í•œ ì£¼ ê³„íš í•©ê³„
                let memberActualTotalMins = 0; // ğŸ”¹ ì•„ë¥´ë°”ì´íŠ¸ í•œ ì£¼ ì‹¤ì œ í•©ê³„

                // 7ì¼ ì¹¸
                weekDates.forEach((date, idx) => {
                    const iso = toIso(date);
                    const planMap   = weekPlanByMember[member.id]   || {};
                    const actualMap = weekActualByMember[member.id] || {};

                    const planDay   = planMap[iso]   || { segments: [] };
                    const actualDay = actualMap[iso] || { segments: [], minutes: 0 };

                    const planSegs   = Array.isArray(planDay.segments)   ? planDay.segments   : [];
                    const actualSegs = Array.isArray(actualDay.segments) ? actualDay.segments : [];
                    const minutes    = typeof actualDay.minutes === 'number' ? actualDay.minutes : 0;

                    // ğŸ”¹ ê³„íš ì‹œê°„(ë¶„) ê³„ì‚°
                    const planMinutes = planSegs.reduce((acc, s) => {
                        return acc + (hmToMin(s.end) - hmToMin(s.start));
                    }, 0);

                    dayActualTotals[idx]   += minutes;
                    memberActualTotalMins  += minutes;
                    memberPlanTotalMins    += planMinutes;

                    const plansHtml = planSegs.length
                            ? planSegs.map(s => chipHtml(color, s.start, s.end)).join(' ')
                            : '<span class="text-muted small"></span>';

                    const actualHtml = actualSegs.length
                            ? actualSegs.map(s => chipHtml(color, s.start, s.end)).join(' ')
                            : '<span class="text-muted small"></span>';

                    const dayTotalHtml = minutes > 0
                            ? `<div class="day-total">${formatMins(minutes)}</div>`
                            : `<div class="day-total text-muted">-</div>`;

                    const td = document.createElement('td');
                    td.innerHTML = `
                        <div class="week-cell">
                            <div class="week-cell-rect week-cell-rect-bottom">
                                <div class="segments">${plansHtml}</div>
                            </div>
                            <div class="week-cell-rect week-cell-rect-top">
                                <div class="segments">${actualHtml}</div>
                                ${dayTotalHtml}
                            </div>
                        </div>
                    `;
                    tr.appendChild(td);
                });

                allMembersWeeklyPlanTotal   += memberPlanTotalMins;
                allMembersWeeklyActualTotal += memberActualTotalMins;

                // ğŸ”¹ ë§ˆì§€ë§‰ ì»¬ëŸ¼: í•´ë‹¹ ì•„ë¥´ë°”ì´íŠ¸ìƒì˜ ì£¼ê°„ ê³„íš/ì‹¤ì œ í•©ê³„
                const weekPlanLabel   = memberPlanTotalMins   > 0 ? formatMins(memberPlanTotalMins)   : '-';
                const weekActualLabel = memberActualTotalMins > 0 ? formatMins(memberActualTotalMins) : '-';

                const totalTd = document.createElement('td');
                totalTd.className = 'member-total-cell';
                totalTd.innerHTML = `
                    <div class="member-week-total-strong">
                        <div class="small text-muted">ê³„íš: <strong>${weekPlanLabel}</strong></div>
                        <div class="small text-muted">ì‹¤ì œ: <strong>${weekActualLabel}</strong></div>
                    </div>
                `;
                tr.appendChild(totalTd);

                tbody.appendChild(tr);
            });

            // ===== ë§ˆì§€ë§‰ ìš”ì•½ í–‰: ìš”ì¼ë³„ ì „ì²´ ì‹¤ì œ í•©ê³„ + ì£¼ê°„ ì „ì²´ í•©ê³„(ê³„íš/ì‹¤ì œ) =====
            const summaryTr = document.createElement('tr');
            summaryTr.className = 'summary-row';

            const sumNameTd = document.createElement('td');
            sumNameTd.className = 'member-cell';
            sumNameTd.textContent = 'í•©ê³„';
            summaryTr.appendChild(sumNameTd);

            dayActualTotals.forEach((mins) => {
                const td = document.createElement('td');
                td.textContent = mins > 0 ? formatMins(mins) : '-';
                summaryTr.appendChild(td);
            });

            // ğŸ”¹ ë§ˆì§€ë§‰ ìš”ì•½ ì»¬ëŸ¼: ì „ì²´(ëª¨ë“  ë©¤ë²„) ì£¼ê°„ ê³„íš/ì‹¤ì œ í•©ê³„
            const totalSummaryTd = document.createElement('td');
            const totalPlanLabel   = allMembersWeeklyPlanTotal   > 0 ? formatMins(allMembersWeeklyPlanTotal)   : '-';
            const totalActualLabel = allMembersWeeklyActualTotal > 0 ? formatMins(allMembersWeeklyActualTotal) : '-';
            totalSummaryTd.innerHTML = `
                ê³„íš: <strong>${totalPlanLabel}</strong><br>
                ì‹¤ì œ: <strong>${totalActualLabel}</strong>
            `;
            summaryTr.appendChild(totalSummaryTd);

            tbody.appendChild(summaryTr);

            table.appendChild(tbody);
            weekCalendarGrid.appendChild(table);
        }

        /* ===== Utils ===== */
        function toMonday(date){
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            return d;
        }
        function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        function normalizeDays(apiData, needMinutes){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                let minutes = d.minutes;
                if (needMinutes) {
                    minutes = (typeof d.minutes==='number')
                            ? d.minutes
                            : segments.reduce((acc,s)=> acc + (hmToMin(s.end) - hmToMin(s.start)), 0);
                }
                map[date] = needMinutes ? { segments, minutes } : { segments };
            });
            return map;
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const [h,m]=String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60+(m||0);
        }

        function formatMins(mins){
            const v=Math.max(0, mins|0);
            const h=Math.floor(v/60), m=v%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }

        // HH:mm:ss â†’ HH:mm ìœ¼ë¡œ ë§ì¶°ì£¼ëŠ” í•¨ìˆ˜ (ê³„íš/ì‹¤ê·¼ë¬´ ëª¨ë‘ ì‚¬ìš©)
        function formatHmLabel(raw){
            if (!raw) return '';
            const parts = String(raw).split(':');
            if (parts.length >= 2) {
                return `${pad2(parseInt(parts[0],10)||0)}:${pad2(parseInt(parts[1],10)||0)}`;
            }
            return raw;
        }

        function chipHtml(color, start, end){
            const startLabel = formatHmLabel(start);
            const endLabel   = formatHmLabel(end);
            return `<span class="chip">
                        <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};"></span>
                        <span>${startLabel} ~ ${endLabel}</span>
                    </span>`;
        }

        function colorForMember(m){
            const key = (m?.id!=null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer_}}
