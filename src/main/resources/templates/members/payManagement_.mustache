{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ 왼쪽: 상태별 근무자 리스트 ============ -->
        <div class="col-12 col-lg-4">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">상태별 근무자</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">추가등록</a>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label small text-muted">상태</label>
                            <select id="statusSelect" class="form-select">
                                <option value="WORKING" selected>근무중</option>
                                <option value="WAITING">시작전</option>
                                <option value="RESTING">휴식중</option>
                                <option value="PAUSED">일시중지</option>
                                <option value="RESIGNED">퇴사</option>
                            </select>
                            <div class="form-text">상태를 바꾸면 좌측 리스트와 우측 급여 테이블이 함께 갱신됩니다.</div>
                        </div>

                        <hr>

                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">근무자 목록</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0명</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS 렌더 -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ 오른쪽: 월단위 급여 테이블 ============ -->
        <div class="col-12 col-lg-8">

            <!-- 상단: 제목 + 월 내비 -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                <div>
                    <span class="fw-bold h5 mb-0" id="pageTitle">급여 관리</span>
                    <span id="selectedMemberName" class="ms-2 text-primary fw-semibold"></span>
                    <span id="selectedMemberStatus" class="badge bg-secondary ms-2 d-none">-</span>
                </div>

                <!-- 월단위 내비 -->
                <div id="monthNav" class="d-flex align-items-center small text-muted gap-2">
                    <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">◀ 이전 달</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthThis">이번 달</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthNext">다음 달 ▶</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header fw-bold">
                    <span>월단위 급여 테이블</span>
                </div>
                <div class="card-body">

                    <!-- 안내 -->
                    <div class="small text-muted mb-2">
                        좌측에서 근무자를 선택하면, 해당 근무자의
                        <b>월단위 실제 근무시간</b>과 <b>주별 합계 / 주휴수당 / 근무수당</b>,
                        <b>월 합계 / 실수령액</b>이 계산됩니다.
                    </div>

                    <!-- 월단위 캘린더 모양 테이블 -->
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center" id="monthPayTable">
                            <thead class="table-light">
                            <tr>
                                <th style="width:90px;">주차</th>
                                <th>월</th>
                                <th>화</th>
                                <th>수</th>
                                <th>목</th>
                                <th>금</th>
                                <th class="bg-light">토</th>
                                <th class="bg-light">일</th>
                                <th style="width:120px;" class="text-end">주 실근무</th>
                                <th style="width:170px;" class="text-end">주 주휴수당<br>(근무시간/5)</th>
                                <th style="width:130px;" class="text-end">주 근무수당</th>
                            </tr>
                            </thead>
                            <tbody id="monthPayBody">
                            <!-- JS 렌더 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 월 하단 요약 -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted">시급</div>
                            <div id="summaryHourlyWage">-</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted">월 실근무 합계</div>
                            <div id="summaryMonthWorkTime">0시간</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted">월 근무수당 (실근무 × 시급)</div>
                            <div id="summaryMonthWorkPay">-</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="small text-muted">월 주휴수당 합계</div>
                            <div id="summaryMonthJuhyuPay">-</div>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="small fw-bold">실 수령 예상액 (근무수당 + 주휴수당)</div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="fw-bold text-primary" id="summaryMonthTotal">-</div>
                            </div>
                        </div>

                        <!-- ✅ 급여 상태 버튼들 -->
                        <div class="d-flex justify-content-end gap-2 mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSaveDraft">
                                임시저장
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnConfirm">
                                확정
                            </button>
                            <button type="button" class="btn btn-sm btn-success" id="btnMarkPaid">
                                지급완료
                            </button>
                        </div>
                    </div>

                    <div class="small text-muted mt-3">
                        * 1주 실근무시간이 <b>15시간 이상</b>인 경우에만 해당 주의 주휴수당이 발생합니다.<br>
                        * 주휴수당 시간 = <code>주 실근무시간 ÷ 5</code> 로 계산됩니다. (예: 30시간 → 6시간 분 주휴수당)<br>
                        * 월 주휴수당 합계는 해당 월에 포함된 각 주(월~일)의 주휴수당을 모두 합산한 값입니다.
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    /* 좌측 멤버 리스트 chip 스타일 */
    .member-chip {
        display:flex; align-items:center; justify-content:space-between;
        gap:8px; padding:8px 10px; border-radius:10px;
        background:#fff; border:1px solid #eee; margin-bottom:6px; cursor:pointer;
        transition: background .15s, border-color .15s, box-shadow .15s;
    }
    .member-chip:hover { background:#f8f9fa; }
    .member-chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
    }
    .member-chip.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ✅ 주차 행: 위 행 = 날짜(연회색), 아래 행 = 근무시간 */
    .day-cell-date,
    .day-cell-time {
        font-size:.8rem;
        padding:4px 2px;
    }

    /* 날짜 칸: 항상 연회색 배경 + 하단 경계선 */
    .day-cell-date {
        font-weight:600;
        background:#f8f9fa;          /* 연회색 */
        border-bottom:1px solid #dee2e6;
    }

    /* 근무시간 칸(아래줄) 기본 */
    .day-cell-time {
        background:#ffffff;
    }

    /* 달 밖(이전/다음달) - 날짜줄/시간줄 공통 글자색만 흐리게 */
    .day-outside {
        color:#adb5bd;
    }
    /* 달 밖 + 근무시간줄만 살짝 회색 배경 */
    .day-cell-time.day-outside {
        background:#fcfcfc;
    }

    /* 주말 강조는 "근무시간 줄"에만 적용 */
    .day-cell-time.day-weekend {
        background:#fff8f0;
    }

    /* 요약 숫자 오른쪽 정렬 */
    #summaryHourlyWage,
    #summaryMonthWorkTime,
    #summaryMonthWorkPay,
    #summaryMonthJuhyuPay,
    #summaryMonthTotal {
        text-align:right;
    }
</style>

<!-- ✅ 부트스트랩 토스트 영역 -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <div id="mainToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">
                처리되었습니다.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- 서버에서 내려준 멤버 JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function() {
        const API_BASE_ACTUAL = '/api/schedule';   // GET /{memberId}/{startIso}/{endIso}
        const PAYROLL_SAVE_API = '/api/payroll/month'; // ✅ 급여 저장/확정/지급 API (원하면 여기만 변경)

        // 좌측
        const statusSelect         = document.getElementById('statusSelect');
        const memberList           = document.getElementById('memberList');
        const memberCountBadge     = document.getElementById('memberCountBadge');

        // 우측 상단
        const pageTitle            = document.getElementById('pageTitle');
        const selectedMemberNameEl = document.getElementById('selectedMemberName');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');
        const monthRangeLabel      = document.getElementById('monthRangeLabel');
        const btnMonthPrev         = document.getElementById('btnMonthPrev');
        const btnMonthThis         = document.getElementById('btnMonthThis');
        const btnMonthNext         = document.getElementById('btnMonthNext');

        // 우측 테이블
        const monthPayBody         = document.getElementById('monthPayBody');

        // 월 하단 요약
        const summaryHourlyWage    = document.getElementById('summaryHourlyWage');
        const summaryMonthWorkTime = document.getElementById('summaryMonthWorkTime');
        const summaryMonthWorkPay  = document.getElementById('summaryMonthWorkPay');
        const summaryMonthJuhyuPay = document.getElementById('summaryMonthJuhyuPay');
        const summaryMonthTotal    = document.getElementById('summaryMonthTotal');

        // ✅ 급여 상태 버튼
        const btnSaveDraft         = document.getElementById('btnSaveDraft');
        const btnConfirm           = document.getElementById('btnConfirm');
        const btnMarkPaid          = document.getElementById('btnMarkPaid');

        // ✅ 토스트 DOM
        const toastEl              = document.getElementById('mainToast');
        const toastBodyEl          = document.getElementById('mainToastBody');

        // 상태
        let allMembers = [];
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        let currentMember = null;
        let selectedMemberId = null;
        let currentMonthStart = firstDayOfMonth(new Date()); // 현재 달 1일

        // ✅ 최근 계산된 월 급여 데이터 (API 전송용)
        let lastPayrollPayload = null;

        // 상태 초기값
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // 이벤트 바인딩
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        btnMonthPrev.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() - 1, 1);
            reloadForCurrentMember();
        });
        btnMonthThis.addEventListener('click', function() {
            currentMonthStart = firstDayOfMonth(new Date());
            reloadForCurrentMember();
        });
        btnMonthNext.addEventListener('click', function() {
            currentMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() + 1, 1);
            reloadForCurrentMember();
        });

        // ✅ 급여 상태 버튼 클릭 이벤트
        btnSaveDraft.addEventListener('click', function () {
            savePayrollWithStatus('DRAFT', '임시저장 되었습니다.');
        });
        btnConfirm.addEventListener('click', function () {
            savePayrollWithStatus('CONFIRMED', '급여가 확정되었습니다.');
        });
        btnMarkPaid.addEventListener('click', function () {
            savePayrollWithStatus('PAID', '지급완료로 처리되었습니다.');
        });

        // 초기 실행
        handleStatusChange();

        // ===== 상태 변경 시 멤버 리스트 갱신 =====
        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered.length) {
                const keep = filtered.find(m => String(m.id) === String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            } else {
                selectedMemberId = null;
                currentMember = null;
                clearRight();
            }
        }

        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = members.length + '명';

            members
                    .slice()
                    .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item member-chip';
                        li.dataset.memberId = String(m.id);
                        const color = colorForMember(m);

                        li.innerHTML = `
                    <span class="left d-inline-flex align-items-center gap-2">
                        <span class="dot" style="background:${color}"></span>
                        <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
                        <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
                    </span>
                    <button type="button"
                            class="btn btn-sm btn-outline-primary view-btn"
                            data-id="${String(m.id)}">상세</button>
                `;
                        memberList.appendChild(li);
                    });

            if (!members.length) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = '해당 상태의 근무자가 없습니다.';
                memberList.appendChild(li);
            }

            updateMemberListActive();
        }

        function onMemberListClick(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                const id = btn.getAttribute('data-id');
                if (id) window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
                return;
            }

            const li = e.target.closest('li.member-chip');
            if (!li) return;
            const id = li.dataset.memberId;
            const members = (allMembers || []).filter(m => m.status === statusSelect.value);
            const target = members.find(m => String(m.id) === String(id));
            if (target) selectMember(target);
        }

        function selectMember(member) {
            currentMember = member;
            selectedMemberId = member.id;
            updateMemberListActive();
            renderMemberHeader(member);
            reloadForCurrentMember();
        }

        function updateMemberListActive() {
            Array.from(memberList.querySelectorAll('.member-chip')).forEach(li => {
                li.classList.toggle('active', li.dataset.memberId === String(selectedMemberId));
            });
        }

        function renderMemberHeader(member) {
            if (!member) {
                pageTitle.textContent = '급여 관리';
                selectedMemberNameEl.textContent = '';
                selectedMemberStatus.classList.add('d-none');
                selectedMemberStatus.textContent = '-';
                selectedMemberStatus.className = 'badge bg-secondary d-none';
                return;
            }
            pageTitle.textContent = '급여 관리';
            selectedMemberNameEl.textContent = `(${member.name ?? '-'})`;
            const badgeMap = {
                WORKING: 'bg-success',
                WAITING: 'bg-secondary',
                RESTING: 'bg-info',
                PAUSED: 'bg-warning',
                RESIGNED: 'bg-danger'
            };
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member.status || '-';
            selectedMemberStatus.className = `badge ${badgeMap[member.status] || 'bg-secondary'} ms-2`;
        }

        function clearRight() {
            monthPayBody.innerHTML = '';
            monthRangeLabel.textContent = '0000.00.01 ~ 00.00';
            summaryHourlyWage.textContent    = '-';
            summaryMonthWorkTime.textContent = '0시간';
            summaryMonthWorkPay.textContent  = '-';
            summaryMonthJuhyuPay.textContent = '-';
            summaryMonthTotal.textContent    = '-';
            lastPayrollPayload = null;
            renderMemberHeader(null);
        }

        function reloadForCurrentMember() {
            if (!currentMember) {
                clearRight();
                return;
            }
            loadMonthData(currentMember, currentMonthStart);
        }

        // ===== 월 데이터 로딩 & 테이블 렌더 =====
        async function loadMonthData(member, monthStartDate) {
            const ms   = firstDayOfMonth(monthStartDate);
            const me   = lastDayOfMonth(monthStartDate);
            const msIso = toIso(ms);
            const meIso = toIso(me);

            // 상단 라벨: 2025.03.01 ~ 03.31
            const leftY = ms.getFullYear();
            const leftM = pad2(ms.getMonth()+1);
            const leftD = '01';
            const rightM = pad2(me.getMonth()+1);
            const rightD = pad2(me.getDate());
            monthRangeLabel.textContent = `${leftY}.${leftM}.${leftD} ~ ${rightM}.${rightD}`;

            // 실제 근무 데이터 호출
            let dayMap = {};
            try {
                const url = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${msIso}/${meIso}`;
                const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                if (resp.ok) {
                    const data = await resp.json();
                    dayMap = normalizeDays(data);  // 'YYYY-MM-DD' -> {segments, minutes}
                }
            } catch (e) {
                console.error('loadMonthData error', e);
                dayMap = {};
            }

            renderMonthPayTable(member, ms, me, dayMap);
        }

        function renderMonthPayTable(member, ms, me, dayMap) {
            monthPayBody.innerHTML = '';

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            summaryHourlyWage.textContent =
                    (wage != null) ? krw(wage) : '-';

            let monthMinutes = 0;
            let monthJuhyuMinutes = 0;

            // 이 달 1일이 속한 주의 월요일부터, 이 달 마지막 날이 속한 주까지
            const weeks = [];
            let wStart = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd) {
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate() + 7);
            }

            let weekIndex = 0;

            weeks.forEach(weekStart => {
                const weekEnd = addDays(weekStart, 6);

                const dateTds = [];
                const timeTds = [];
                let weekMinutes = 0;

                for (let i=0;i<7;i++){
                    const dayDate = addDays(weekStart, i);
                    const iso     = toIso(dayDate);
                    const inMonth = (dayDate >= ms && dayDate <= me);
                    const info    = inMonth ? (dayMap[iso] || { segments:[], minutes:0 }) : { segments:[], minutes:0 };
                    const dayMinutes = info.minutes || 0;

                    if (inMonth) {
                        weekMinutes  += dayMinutes;
                        monthMinutes += dayMinutes;
                    }

                    const dayNum    = dayDate.getDate();
                    const isWeekend = (i >= 5); // 토,일
                    const cls = [
                        !inMonth ? 'day-outside' : '',
                        inMonth && isWeekend ? 'day-weekend' : ''
                    ].filter(Boolean).join(' ');

                    const timeLabel = inMonth && dayMinutes > 0
                            ? formatMins(dayMinutes)
                            : (inMonth ? '-' : '');

                    dateTds.push(`<td class="day-cell-date ${cls}">${inMonth ? dayNum : ''}</td>`);
                    timeTds.push(`<td class="day-cell-time ${cls}">${timeLabel}</td>`);
                }

                // 이 주의 주휴수당 시간(분)
                const juhyuMinutes = calcWeeklyJuhyuMinutes(weekMinutes);
                monthJuhyuMinutes += juhyuMinutes;

                // 주별 금액
                let weekWorkPay = null;
                let weekJuhyuPay = null;
                if (wage != null) {
                    weekWorkPay  = Math.round((weekMinutes/60)   * wage);
                    weekJuhyuPay = Math.round((juhyuMinutes/60)  * wage);
                }

                const weekWorkLabel = formatMins(weekMinutes);

                // 주차 라벨: 1주차 (MM.DD ~ MM.DD)
                const weekLabelRange =
                        `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())}` +
                        ` ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                // 주휴수당 셀 내용
                let weekJuhyuCellHtml = '-';
                if (juhyuMinutes > 0 && weekJuhyuPay != null) {
                    const juhyuTimeLabel = formatMins(juhyuMinutes);
                    const weekTimeLabel  = formatMins(weekMinutes);
                    const juhyuMoneyLabel = krw(weekJuhyuPay);
                    weekJuhyuCellHtml =
                            `(${weekTimeLabel}/5) <br>= ${juhyuTimeLabel}<br>${juhyuMoneyLabel}`;
                }

                const weekPayLabel = (weekWorkPay != null) ? krw(weekWorkPay) : '-';

                // ====== 두 줄짜리 주차 블록 생성 ======
                const trDates = document.createElement('tr');
                trDates.innerHTML = `
                <th scope="row" rowspan="2">
                    ${++weekIndex}주차<br>
                    <small class="text-muted">(${weekLabelRange})</small>
                </th>
                ${dateTds.join('')}
                <td class="text-end" rowspan="2">${weekWorkLabel}</td>
                <td class="text-end" rowspan="2">${weekJuhyuCellHtml}</td>
                <td class="text-end" rowspan="2">${weekPayLabel}</td>
            `;

                const trTimes = document.createElement('tr');
                trTimes.innerHTML = timeTds.join('');

                monthPayBody.appendChild(trDates);
                monthPayBody.appendChild(trTimes);
            });

            // 월 합계/금액
            summaryMonthWorkTime.textContent = formatMins(monthMinutes);

            let monthWorkPay = null;
            let monthJuhyuPay = null;
            let monthTotal = null;

            if (wage != null) {
                monthWorkPay  = Math.round((monthMinutes/60)      * wage);
                monthJuhyuPay = Math.round((monthJuhyuMinutes/60) * wage);
                monthTotal    = monthWorkPay + monthJuhyuPay;
            }

            summaryMonthWorkPay.textContent  = (monthWorkPay  != null) ? krw(monthWorkPay)  : '-';
            summaryMonthJuhyuPay.textContent = (monthJuhyuPay != null) ? krw(monthJuhyuPay) : '-';
            summaryMonthTotal.textContent    = (monthTotal    != null) ? krw(monthTotal)    : '-';

            // ✅ API 전송용 페이로드 보관
            if (currentMember && wage != null && monthWorkPay != null && monthJuhyuPay != null && monthTotal != null) {
                lastPayrollPayload = {
                    memberId: currentMember.id,
                    payYear: ms.getFullYear(),
                    payMonth: ms.getMonth() + 1,
                    hourlyWage: wage,
                    monthWorkMinutes: monthMinutes,
                    monthJuhyuMinutes: monthJuhyuMinutes,
                    monthWorkPay: monthWorkPay,
                    monthJuhyuPay: monthJuhyuPay,
                    monthTotalPay: monthTotal
                };
            } else {
                lastPayrollPayload = null;
            }
        }

        // ===== 급여 저장/확정/지급 API 호출 =====
        async function savePayrollWithStatus(status, successMessage) {
            if (!currentMember) {
                showToast('먼저 근무자를 선택해주세요.', 'danger');
                return;
            }
            if (!lastPayrollPayload) {
                showToast('급여 데이터가 없습니다. 먼저 월 데이터를 불러와주세요.', 'warning');
                return;
            }

            const payload = {
                ...lastPayrollPayload,
                status: status   // DRAFT / CONFIRMED / PAID
            };

            try {
                const resp = await fetch(PAYROLL_SAVE_API, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    console.error('payroll save error', resp.status, text);
                    showToast('저장 중 오류가 발생했습니다.', 'danger');
                    return;
                }

                // 서버에서 status / id 를 돌려준다면 여기서 UI 업데이트해도 됨.
                showToast(successMessage || '처리되었습니다.', 'success');
            } catch (e) {
                console.error('payroll save fetch error', e);
                showToast('통신 오류가 발생했습니다.', 'danger');
            }
        }

        // ===== 토스트 헬퍼 =====
        function showToast(message, type) {
            if (!toastEl || !toastBodyEl) return;
            toastBodyEl.textContent = message;

            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            if (type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            } else if (type === 'info') {
                toastEl.classList.add('text-bg-info');
            } else {
                toastEl.classList.add('text-bg-success');
            }

            if (window.bootstrap && bootstrap.Toast) {
                const t = bootstrap.Toast.getOrCreateInstance(toastEl);
                t.show();
            } else {
                // 혹시 bootstrap JS가 없는 경우 fallback
                toastEl.style.display = 'block';
                setTimeout(() => { toastEl.style.display = 'none'; }, 2000);
            }
        }

        // ===== 유틸 함수들 =====
        function firstDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth(), 1);
        }
        function lastDayOfMonth(d) {
            return new Date(d.getFullYear(), d.getMonth()+1, 0);
        }
        function toIso(d) {
            return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }
        function pad2(n) {
            return String(n).padStart(2,'0');
        }
        function addDays(d, n) {
            const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            x.setDate(x.getDate()+n);
            return x;
        }
        function toMonday(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const w = d.getDay();         // 0=일, 1=월, ..., 6=토
            const offset = (w + 6) % 7;   // 월요일 기준
            d.setDate(d.getDate() - offset);
            return d;
        }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60);
            const m = v % 60;
            return m === 0 ? `${h}시간` : `${h}시간 ${m}분`;
        }

        function krw(v) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        // API 응답 -> date별 {segments, minutes}
        function normalizeDays(apiData) {
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d => {
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes === 'number')
                        ? d.minutes
                        : segments.reduce((acc,s)=> acc + diffMinutes(s.start, s.end), 0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function diffMinutes(start, end) {
            const s = parseHm(start);
            const e = parseHm(end);
            return (e.h*60 + e.m) - (s.h*60 + s.m);
        }
        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        // ✅ 주간 주휴수당 "분" 계산: 1주 실근무가 15시간(900분) 이상일 때만, 주휴시간 = 주간 실근무 ÷ 5
        function calcWeeklyJuhyuMinutes(weeklyMinutes) {
            if (!weeklyMinutes || weeklyMinutes < 15*60) return 0;
            return Math.round(weeklyMinutes / 5);
        }

        function colorForMember(m) {
            const key = (m?.id != null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key) % 360, s = 65, l = 55;
            return hslToHex(h, s, l);
        }
        function seededHash(str) {
            let h = 2166136261 >>> 0;
            for (let i=0;i<str.length;i++) {
                h ^= str.charCodeAt(i);
                h = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }
        function hslToHex(h,s,l) {
            s/=100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1-l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer}}
