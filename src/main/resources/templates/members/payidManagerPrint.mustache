{{>layouts/header_}}

<main class="container my-4">

    <!-- ============ ìƒë‹¨: ì¶œë ¥ìš© í—¤ë” (ìƒíƒœ/ì´ë¦„ ê³ ì •) ============ -->
    <div class="card mb-3 state-card-blue">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ì§€ê¸‰ë‚´ì—­ (ì¶œë ¥ìš©)</span>
            <span class="small">
                ìƒíƒœ: <strong>{{statusLabel}}</strong>
            </span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- ìƒíƒœ / ì´ë¦„ ê³ ì • í‘œì‹œ -->
                <div class="col-12 col-md-4">
                    <div class="form-label small text-muted">ê·¼ë¬´ì</div>
                    <div class="fs-5 fw-bold">
                        {{member.name}}
                    </div>
                    <div class="form-text">
                        ì´ í˜ì´ì§€ëŠ” ì„ íƒí•œ ê·¼ë¬´ìì˜ ì§€ê¸‰ë‚´ì—­ì„ ê³ ì •í•œ ì¶œë ¥ìš© í™”ë©´ì…ë‹ˆë‹¤.
                    </div>
                    <div class="mt-2 small">
                        <span class="badge bg-secondary">{{statusLabel}}</span>
                    </div>
                </div>

                <!-- (ì˜µì…˜) ê¸°íƒ€ ì •ë³´ -->
                <div class="col-12 col-md-8">
                    <div class="small text-muted mb-1">ê¸°ë³¸ ì •ë³´</div>
                    <div class="row small">
                        <div class="col-6">
                            <div><strong>ì—°ë½ì²˜</strong> : {{member.phone}}</div>
                        </div>
                        <div class="col-6">
                            <div><strong>í˜„ì¬ ì‹œê¸‰</strong> :
                                {{#member.hourlyWage}}
                                    {{member.hourlyWage}}
                                {{/member.hourlyWage}}
                            </div>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">
                        * ì‹¤ì œ ì§€ê¸‰ ì‹œì ì˜ ì‹œê¸‰ì€ ì§€ê¸‰ë‚´ì—­ì—ì„œ ë³„ë„ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ì§€ê¸‰ëœ ê¸‰ì—¬ ë‚´ì—­ (ì›”ë³„ / ì—°ë„ë³„ íƒ­) ============ -->
    <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <span>ì§€ê¸‰ëœ ê¸‰ì—¬ ë‚´ì—­</span>
            <div class="d-flex align-items-center gap-3">
                <span id="payHistoryCount" class="badge bg-light text-dark">0ê±´</span>

                <!-- ğŸ” ì›”ë³„ / ì—°ë„ë³„ íƒ­ -->
                <ul class="nav nav-pills nav-pills-sm" id="payViewTabs">
                    <li class="nav-item">
                        <button class="nav-link active" type="button" data-view="MONTH">ì›”ë³„</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" type="button" data-view="YEAR">ì—°ë„ë³„</button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card-body">

            <div class="small text-muted mb-2">
                ì„ íƒëœ ê·¼ë¬´ìì— ëŒ€í•´ <b>ì§€ê¸‰ì™„ë£Œëœ ì›”ê¸‰ ë‚´ì—­</b>ê³¼ <b>ì—°ë„ë³„ í•©ì‚° ë‚´ì—­</b>ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
            </div>

            <!-- ğŸ“Š ì›”ë³„ / ì—°ë„ë³„ ì§€ê¸‰ë‚´ì—­ í…Œì´ë¸” -->
            <div class="table-responsive">

                <!-- ğŸ“… ì›”ë³„ ë·° -->
                <div id="payViewMonth">
                    <table class="table table-bordered align-middle text-center" id="payHistoryTableMonth">
                        <thead class="pay-table-header">
                        <tr>
                            <th style="width:90px;">ì—°ë„-ì›”</th>
                            <th style="width:160px;">ì§€ê¸‰ì¼</th>
                            <th style="width:80px;">ìƒíƒœ</th>
                            <th style="width:110px;">ì‹œê¸‰</th>
                            <th style="width:120px;">ì‹¤ê·¼ë¬´</th>
                            <th style="width:120px;">ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</th>
                            <th style="width:140px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹</th>
                            <th style="width:140px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹</th>
                            <th style="width:160px;" class="text-end">ì´ ì§€ê¸‰ì•¡</th>
                        </tr>
                        </thead>
                        <tbody id="payHistoryBodyMonth">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>

                <!-- ğŸ“† ì—°ë„ë³„ ë·° -->
                <div id="payViewYear" class="d-none">
                    <table class="table table-bordered align-middle text-center" id="payHistoryTableYear">
                        <thead class="pay-table-header">
                        <tr>
                            <th style="width:100px;">ì—°ë„</th>
                            <th style="width:140px;">ì‹¤ê·¼ë¬´ì‹œê°„ í•©ê³„</th>
                            <th style="width:150px;">ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„ í•©ê³„</th>
                            <th style="width:150px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹ í•©ê³„</th>
                            <th style="width:150px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„</th>
                            <th style="width:180px;" class="text-end">ì´ ì§€ê¸‰ì•¡ í•©ê³„</th>
                        </tr>
                        </thead>
                        <tbody id="payHistoryBodyYear">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- í•©ê³„ ì˜ì—­ -->
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì´ ì‹¤ê·¼ë¬´ ì‹œê°„</div>
                    <div class="fw-semibold" id="summaryTotalWorkTime">0ì‹œê°„</div>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì´ ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</div>
                    <div class="fw-semibold" id="summaryTotalJuhyuTime">0ì‹œê°„</div>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì´ ê·¼ë¬´ìˆ˜ë‹¹</div>
                    <div class="fw-semibold" id="summaryTotalWorkPay">-</div>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì´ ì£¼íœ´ìˆ˜ë‹¹</div>
                    <div class="fw-semibold" id="summaryTotalJuhyuPay">-</div>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="small fw-bold">ì´ ì§€ê¸‰ì•¡ (ê·¼ë¬´ìˆ˜ë‹¹ + ì£¼íœ´ìˆ˜ë‹¹)</div>
                    <div class="fw-bold text-primary" id="summaryTotalPay">-</div>
                </div>
            </div>

            <div class="small text-muted mt-3">
                * "ê¸‰ì—¬ ê´€ë¦¬" í™”ë©´ì—ì„œ <b>ì§€ê¸‰ì™„ë£Œ</b>ë¡œ ì²˜ë¦¬ëœ ì›”ê¸‰ë§Œ ì´ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ì—°ë„ë³„ ë‚´ì—­ì€ ì›”ë³„ ì§€ê¸‰ ë‚´ì—­ì„ ì—°ë„ ë‹¨ìœ„ë¡œ í•©ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ============ í•˜ë‹¨: PDF ì¶œë ¥ ë²„íŠ¼ ============ -->
    <div class="mt-4 text-end no-print">
        <button type="button" class="btn btn-primary" onclick="window.print()">
            PDF ì¶œë ¥
        </button>
    </div>
</main>

<style>
    .state-card-blue{
        border-radius:1rem;
        overflow:hidden;
        background:#0d6efd;
        color:#fff;
        border:none;
    }
    .state-card-blue .card-header{
        background:rgba(255,255,255,0.08);
        border-bottom:1px solid rgba(255,255,255,0.25);
    }
    .state-card-blue .card-body{
        background:transparent;
    }
    .state-card-blue .form-label,
    .state-card-blue .form-text,
    .state-card-blue .text-muted{
        color:rgba(255,255,255,0.85) !important;
    }

    /* í—¤ë” íŒŒë€ìƒ‰ + ìƒë‹¨ ë¼ìš´ë“œ */
    .pay-table-header th{
        background:#0d6efd !important;
        color:#fff !important;
        border-color:#0b5ed7 !important;
        vertical-align:middle;
    }
    .pay-table-header th:first-child{
        border-top-left-radius:0.75rem;
    }
    .pay-table-header th:last-child{
        border-top-right-radius:0.75rem;
    }
    #payHistoryTableMonth,
    #payHistoryTableYear{
        border-collapse:separate;
        border-spacing:0;
        border-radius:0.75rem;
        overflow:hidden;
    }

    /* âœ… í—¤ë” ì•„ë˜ ì„ (ì²« í–‰), ê° í–‰ ì‚¬ì´ ì„ , ë§ˆì§€ë§‰ í–‰ ì•„ë˜ ì„ ê¹Œì§€ ë˜ë ·í•˜ê²Œ */
    /* í—¤ë” â†” ì²« ë°ì´í„° í–‰ êµ¬ë¶„ì„  */
    #payHistoryTableMonth tbody tr:first-child td,
    #payHistoryTableYear tbody tr:first-child td{
        border-top:2px solid #495057 !important;
    }
    /* ê° ì›”(ê° í–‰) ì‚¬ì´ êµ¬ë¶„ì„  */
    #payHistoryTableMonth tbody tr:not(:first-child) td,
    #payHistoryTableYear tbody tr:not(:first-child) td{
        border-top:2px solid #adb5bd !important;
    }
    /* í…Œì´ë¸” ë§ˆì§€ë§‰ í•˜ë‹¨ êµ¬ë¶„ì„  */
    #payHistoryTableMonth tbody tr:last-child td,
    #payHistoryTableYear tbody tr:last-child td{
        border-bottom:2px solid #495057 !important;
    }

    @media print {
        .no-print { display:none !important; }
    }
</style>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON (ë‹¨ì¼ ë©¤ë²„) -->
<script id="memberData" type="application/json">
{{{memberJson}}}
</script>

<script>
    (function(){
        const PAYROLL_MEMBER_API = '/api/payroll/member';

        const payViewTabs          = document.querySelectorAll('#payViewTabs .nav-link');
        const payViewMonthEl       = document.getElementById('payViewMonth');
        const payViewYearEl        = document.getElementById('payViewYear');

        const payHistoryBodyMonth  = document.getElementById('payHistoryBodyMonth');
        const payHistoryBodyYear   = document.getElementById('payHistoryBodyYear');
        const payHistoryCount      = document.getElementById('payHistoryCount');

        const summaryTotalWorkTime = document.getElementById('summaryTotalWorkTime');
        const summaryTotalJuhyuTime= document.getElementById('summaryTotalJuhyuTime');
        const summaryTotalWorkPay  = document.getElementById('summaryTotalWorkPay');
        const summaryTotalJuhyuPay = document.getElementById('summaryTotalJuhyuPay');
        const summaryTotalPay      = document.getElementById('summaryTotalPay');

        let member = null;
        let memberId = null;
        let currentPayView = 'MONTH';
        let lastMonthlyCount = 0;
        let lastYearlyCount  = 0;

        // ë©¤ë²„ ë°ì´í„° íŒŒì‹±
        try {
            member = JSON.parse(document.getElementById('memberData').textContent || '{}');
            memberId = member.id;
        } catch (e) {
            console.error('memberData parse error', e);
        }

        // íƒ­ ì´ë²¤íŠ¸
        payViewTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                if (!view) return;
                currentPayView = view;

                payViewTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (view === 'MONTH') {
                    payViewMonthEl.classList.remove('d-none');
                    payViewYearEl.classList.add('d-none');
                    payHistoryCount.textContent = `${lastMonthlyCount}ê±´`;
                } else {
                    payViewYearEl.classList.remove('d-none');
                    payViewMonthEl.classList.add('d-none');
                    payHistoryCount.textContent = `${lastYearlyCount}ê±´`;
                }
            });
        });

        if (memberId != null) {
            loadPaidPayroll(member);
        } else {
            payHistoryBodyMonth.innerHTML = `
                <tr><td colspan="9" class="text-muted text-center">
                    ë©¤ë²„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                </td></tr>`;
        }

        async function loadPaidPayroll(member) {
            payHistoryBodyMonth.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
            `;
            payHistoryBodyYear.innerHTML = '';
            payHistoryCount.textContent = '0ê±´';
            lastMonthlyCount = 0;
            lastYearlyCount  = 0;

            let list = [];
            try {
                const url = `${PAYROLL_MEMBER_API}/${encodeURIComponent(member.id)}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) {
                    const text = await resp.text().catch(()=> '');
                    console.error('loadPaidPayroll error', resp.status, text);
                    renderEmpty();
                    return;
                }
                list = await resp.json();
                if (!Array.isArray(list)) list = [];
            } catch (e) {
                console.error('loadPaidPayroll fetch error', e);
                renderEmpty();
                return;
            }

            renderPayrollList(member, list);
        }

        function renderEmpty() {
            payHistoryBodyMonth.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        ì§€ê¸‰ì™„ë£Œëœ ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
            payHistoryBodyYear.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        ì—°ë„ë³„ë¡œ ì§‘ê³„í•  ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            `;
            payHistoryCount.textContent = '0ê±´';
            summaryTotalWorkTime.textContent  = '0ì‹œê°„';
            summaryTotalJuhyuTime.textContent = '0ì‹œê°„';
            summaryTotalWorkPay.textContent   = '-';
            summaryTotalJuhyuPay.textContent  = '-';
            summaryTotalPay.textContent       = '-';
        }

        function renderPayrollList(member, list) {
            if (!Array.isArray(list) || list.length === 0) {
                renderEmpty();
                return;
            }

            list.sort((a, b) => {
                const ay = a.payYear || 0, by = b.payYear || 0;
                const am = a.payMonth || 0, bm = b.payMonth || 0;
                if (ay !== by) return by - ay;
                return bm - am;
            });

            let totalWorkMinutes = 0;
            let totalJuhyuMinutes = 0;
            let totalWorkPay = 0;
            let totalJuhyuPay = 0;
            let totalPay = 0;

            const yearMap = {};

            const monthRows = list.map(item => {
                const year  = item.payYear ?? '-';
                const month = item.payMonth != null ? pad2(item.payMonth) : '--';

                const rawPaidDate = item.paidDate;
                const paidDate = rawPaidDate ? formatDateTime(rawPaidDate) : '-';

                const status = (item.status || 'PAID').toUpperCase();

                const workMinutes  = item.monthWorkMinutes  || 0;
                const juhyuMinutes = item.monthJuhyuMinutes || 0;
                const workPay      = item.monthWorkPay      || 0;
                const juhyuPay     = item.monthJuhyuPay     || 0;
                const total        = item.monthTotalPay     || (workPay + juhyuPay);

                totalWorkMinutes  += workMinutes;
                totalJuhyuMinutes += juhyuMinutes;
                totalWorkPay      += workPay;
                totalJuhyuPay     += juhyuPay;
                totalPay          += total;

                if (item.payYear != null) {
                    const y = item.payYear;
                    if (!yearMap[y]) {
                        yearMap[y] = {
                            workMinutes: 0,
                            juhyuMinutes: 0,
                            workPay: 0,
                            juhyuPay: 0,
                            totalPay: 0
                        };
                    }
                    yearMap[y].workMinutes  += workMinutes;
                    yearMap[y].juhyuMinutes += juhyuMinutes;
                    yearMap[y].workPay      += workPay;
                    yearMap[y].juhyuPay     += juhyuPay;
                    yearMap[y].totalPay     += total;
                }

                const hourly = (typeof item.hourlyWage === 'number')
                        ? krw(item.hourlyWage)
                        : ((typeof member?.hourlyWage === 'number') ? krw(member.hourlyWage) : '-');

                const statusLabelMap = { DRAFT:'ì„ì‹œì €ì¥', CONFIRMED:'í™•ì •', PAID:'ì§€ê¸‰ì™„ë£Œ' };
                const statusBadgeMap = { DRAFT:'bg-secondary', CONFIRMED:'bg-info', PAID:'bg-success' };
                const statusLabel = statusLabelMap[status] || status;
                const statusClass = statusBadgeMap[status] || 'bg-secondary';

                return `
                    <tr>
                        <td>${year}-${month}</td>
                        <td>${paidDate}</td>
                        <td>
                            <span class="badge ${statusClass}">${statusLabel}</span>
                        </td>
                        <td class="text-end">${hourly}</td>
                        <td>${formatMins(workMinutes)}</td>
                        <td>${formatMins(juhyuMinutes)}</td>
                        <td class="text-end">${workPay ? krw(workPay) : '-'}</td>
                        <td class="text-end">${juhyuPay ? krw(juhyuPay) : '-'}</td>
                        <td class="text-end fw-semibold">${total ? krw(total) : '-'}</td>
                    </tr>
                `;
            });

            payHistoryBodyMonth.innerHTML = monthRows.join('');
            lastMonthlyCount = list.length;

            const years = Object.keys(yearMap).map(y => Number(y)).sort((a,b) => b - a);
            if (years.length === 0) {
                payHistoryBodyYear.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            ì—°ë„ë³„ë¡œ ì§‘ê³„í•  ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                lastYearlyCount = 0;
            } else {
                const yearRows = years.map(y => {
                    const aggr = yearMap[y];
                    return `
                        <tr>
                            <td>${y}</td>
                            <td>${formatMins(aggr.workMinutes)}</td>
                            <td>${formatMins(aggr.juhyuMinutes)}</td>
                            <td class="text-end">${aggr.workPay ? krw(aggr.workPay) : '-'}</td>
                            <td class="text-end">${aggr.juhyuPay ? krw(aggr.juhyuPay) : '-'}</td>
                            <td class="text-end fw-semibold">${aggr.totalPay ? krw(aggr.totalPay) : '-'}</td>
                        </tr>
                    `;
                });
                payHistoryBodyYear.innerHTML = yearRows.join('');
                lastYearlyCount = years.length;
            }

            if (currentPayView === 'MONTH') {
                payHistoryCount.textContent = `${lastMonthlyCount}ê±´`;
            } else {
                payHistoryCount.textContent = `${lastYearlyCount}ê±´`;
            }

            summaryTotalWorkTime.textContent  = formatMins(totalWorkMinutes);
            summaryTotalJuhyuTime.textContent = formatMins(totalJuhyuMinutes);
            summaryTotalWorkPay.textContent   = totalWorkPay  ? krw(totalWorkPay)  : '-';
            summaryTotalJuhyuPay.textContent  = totalJuhyuPay ? krw(totalJuhyuPay) : '-';
            summaryTotalPay.textContent       = totalPay      ? krw(totalPay)      : '-';
        }

        function pad2(n) { return String(n).padStart(2,'0'); }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60);
            const m = v % 60;
            return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function krw(v) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        function formatDateTime(value) {
            if (!value) return '-';
            let d;
            if (value instanceof Date) {
                d = value;
            } else if (typeof value === 'number') {
                d = new Date(value < 1e12 ? value * 1000 : value);
            } else {
                const s = String(value).replace(' ', 'T');
                const parsed = new Date(s);
                if (isNaN(parsed.getTime())) {
                    return String(value);
                }
                d = parsed;
            }
            const y  = d.getFullYear();
            const M  = pad2(d.getMonth() + 1);
            const D  = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mm = pad2(d.getMinutes());
            return `${y}-${M}-${D} ${hh}:${mm}`;
        }
    })();
</script>

{{>layouts/footer}}
