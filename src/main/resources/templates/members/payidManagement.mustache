{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ ì™¼ìª½: ìƒíƒœë³„ ê·¼ë¬´ì ë¦¬ìŠ¤íŠ¸ ============ -->
        <div class="col-12 col-lg-4">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ìƒíƒœë³„ ê·¼ë¬´ì</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">ì¶”ê°€ë“±ë¡</a>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                            <select id="statusSelect" class="form-select">
                                <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                                <option value="WAITING">ì‹œì‘ì „</option>
                                <option value="RESTING">íœ´ì‹ì¤‘</option>
                                <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                <option value="RESIGNED">í‡´ì‚¬</option>
                            </select>
                            <div class="form-text">ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ì™€ ìš°ì¸¡ ì§€ê¸‰ë‚´ì—­ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.</div>
                        </div>

                        <hr>

                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">ê·¼ë¬´ì ëª©ë¡</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0ëª…</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS ë Œë” -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ ì˜¤ë¥¸ìª½: ì§€ê¸‰ëœ ê¸‰ì—¬ ë‚´ì—­ (ì›”ë³„ / ì—°ë„ë³„ íƒ­) ============ -->
        <div class="col-12 col-lg-8">
            <div class="pay-right-wrapper">

                <!-- ğŸ”¼ ìƒë‹¨: ì œëª© (ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ê³ ì •) -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 sticky-pay-header">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <div>
                            <span class="fw-bold h5 mb-0" id="pageTitle">ê¸‰ì—¬ ì§€ê¸‰ê´€ë¦¬</span>
                            <span id="selectedMemberName" class="ms-2 text-primary fw-semibold"></span>
                            <span id="selectedMemberStatus" class="badge bg-secondary ms-2 d-none">-</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>ì§€ê¸‰ëœ ê¸‰ì—¬ ë‚´ì—­</span>
                        <div class="d-flex align-items-center gap-3">
                            <span id="payHistoryCount" class="badge bg-light text-dark">0ê±´</span>

                            <!-- ğŸ” ì›”ë³„ / ì—°ë„ë³„ íƒ­ -->
                            <ul class="nav nav-pills nav-pills-sm" id="payViewTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" type="button" data-view="MONTH">ì›”ë³„</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" type="button" data-view="YEAR">ì—°ë„ë³„</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">

                        <!-- ì•ˆë‚´ -->
                        <div class="small text-muted mb-2">
                            ì¢Œì¸¡ì—ì„œ ê·¼ë¬´ìë¥¼ ì„ íƒí•˜ë©´, <b>ì§€ê¸‰ì™„ë£Œëœ ì›”ê¸‰ ë‚´ì—­</b>ê³¼ <b>ì—°ë„ë³„ í•©ì‚° ë‚´ì—­</b>ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                            í•˜ë‹¨ì—ëŠ” ì§€ê¸ˆê¹Œì§€ ì§€ê¸‰í•œ <b>ì‹¤ê·¼ë¬´ì‹œê°„ / ì£¼íœ´ìˆ˜ë‹¹ì‹œê°„ / ê·¼ë¬´ìˆ˜ë‹¹ / ì£¼íœ´ìˆ˜ë‹¹ / ì´ ì§€ê¸‰ì•¡</b>ì´ í•©ì‚°ë©ë‹ˆë‹¤.
                        </div>

                        <!-- ğŸ“Š ì›”ë³„ / ì—°ë„ë³„ ì§€ê¸‰ë‚´ì—­ í…Œì´ë¸” -->
                        <div class="table-responsive">

                            <!-- ğŸ“… ì›”ë³„ ë·° -->
                            <div id="payViewMonth">
                                <table class="table table-bordered align-middle text-center" id="payHistoryTableMonth">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width:90px;">ì—°ë„-ì›”</th>
                                        <th style="width:160px;">ì§€ê¸‰ì¼</th>
                                        <th style="width:80px;">ìƒíƒœ</th>
                                        <th style="width:110px;">ì‹œê¸‰</th>
                                        <th style="width:120px;">ì‹¤ê·¼ë¬´</th>
                                        <th style="width:120px;">ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</th>
                                        <th style="width:140px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹</th>
                                        <th style="width:140px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹</th>
                                        <th style="width:160px;" class="text-end">ì´ ì§€ê¸‰ì•¡</th>
                                    </tr>
                                    </thead>
                                    <tbody id="payHistoryBodyMonth">
                                    <!-- JS ë Œë” -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- ğŸ“† ì—°ë„ë³„ ë·° -->
                            <div id="payViewYear" class="d-none">
                                <table class="table table-bordered align-middle text-center" id="payHistoryTableYear">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width:100px;">ì—°ë„</th>
                                        <th style="width:140px;">ì‹¤ê·¼ë¬´ì‹œê°„ í•©ê³„</th>
                                        <th style="width:150px;">ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„ í•©ê³„</th>
                                        <th style="width:150px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹ í•©ê³„</th>
                                        <th style="width:150px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„</th>
                                        <th style="width:180px;" class="text-end">ì´ ì§€ê¸‰ì•¡ í•©ê³„</th>
                                    </tr>
                                    </thead>
                                    <tbody id="payHistoryBodyYear">
                                    <!-- JS ë Œë” -->
                                    </tbody>
                                </table>
                            </div>

                        </div>

                        <!-- í•©ê³„ ì˜ì—­ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì´ ì‹¤ê·¼ë¬´ ì‹œê°„</div>
                                <div class="fw-semibold" id="summaryTotalWorkTime">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì´ ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</div>
                                <div class="fw-semibold" id="summaryTotalJuhyuTime">0ì‹œê°„</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì´ ê·¼ë¬´ìˆ˜ë‹¹</div>
                                <div class="fw-semibold" id="summaryTotalWorkPay">-</div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div class="small text-muted">ì´ ì£¼íœ´ìˆ˜ë‹¹</div>
                                <div class="fw-semibold" id="summaryTotalJuhyuPay">-</div>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="small fw-bold">ì´ ì§€ê¸‰ì•¡ (ê·¼ë¬´ìˆ˜ë‹¹ + ì£¼íœ´ìˆ˜ë‹¹)</div>
                                <div class="fw-bold text-primary" id="summaryTotalPay">-</div>
                            </div>
                        </div>

                        <div class="small text-muted mt-3">
                            * "ê¸‰ì—¬ ê´€ë¦¬" í™”ë©´ì—ì„œ <b>ì§€ê¸‰ì™„ë£Œ</b>ë¡œ ì²˜ë¦¬ëœ ì›”ê¸‰ë§Œ ì´ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤.<br>
                            * ì—°ë„ë³„ ë‚´ì—­ì€ ì›”ë³„ ì§€ê¸‰ ë‚´ì—­ì„ ì—°ë„ ë‹¨ìœ„ë¡œ í•©ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</main>

<style>
    /* ì¢Œì¸¡ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ chip ìŠ¤íƒ€ì¼ */
    .member-chip {
        display:flex; align-items:center; justify-content:space-between;
        gap:8px; padding:8px 10px; border-radius:10px;
        background:#fff; border:1px solid #eee; margin-bottom:6px; cursor:pointer;
        transition: background .15s, border-color .15s, box-shadow .15s;
    }
    .member-chip:hover { background:#f8f9fa; }
    .member-chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
    }
    .member-chip.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ìš°ì¸¡ ì „ì²´ ë˜í¼ â€“ sticky ê¸°ì¤€ ì»¨í…Œì´ë„ˆ */
    .pay-right-wrapper {
        position: relative;
    }

    /* âœ… ìƒë‹¨ íƒ€ì´í‹€ + ì„ íƒí•œ ê·¼ë¬´ì ì •ë³´ sticky */
    .sticky-pay-header {
        position: sticky;
        top: 70px;              /* ìƒë‹¨ navbar ë†’ì´ì— ë§ì¶° ì¡°ì • */
        z-index: 1030;
        background:#ffffff;
        padding-top: .25rem;
        padding-bottom: .25rem;
    }

    /* í•©ê³„ ìˆ«ì ì˜¤ë¥¸ìª½ ì •ë ¬ */
    #summaryTotalWorkTime,
    #summaryTotalJuhyuTime,
    #summaryTotalWorkPay,
    #summaryTotalJuhyuPay,
    #summaryTotalPay {
        text-align:right;
    }

    .toast-top-center {
        margin-top: 70px; /* ìƒë‹¨ ë„¤ë¹„ë°” ì•„ë˜ìª½ ì—¬ë°± */
    }
</style>

<!-- âœ… ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ì˜ì—­ -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3 toast-top-center" style="z-index:1080;">
    <div id="mainToast" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="mainToastBody">
                ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function() {
        // ê¸‰ì—¬ ë‚´ì—­ ì¡°íšŒ API
        // GET /api/payroll/member/{memberId}
        const PAYROLL_MEMBER_API = '/api/payroll/member';

        // ì¢Œì¸¡
        const statusSelect         = document.getElementById('statusSelect');
        const memberList           = document.getElementById('memberList');
        const memberCountBadge     = document.getElementById('memberCountBadge');

        // ìš°ì¸¡ ìƒë‹¨
        const pageTitle            = document.getElementById('pageTitle');
        const selectedMemberNameEl = document.getElementById('selectedMemberName');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');

        // ìš°ì¸¡ íƒ­
        const payViewTabs          = document.querySelectorAll('#payViewTabs .nav-link');
        const payViewMonthEl       = document.getElementById('payViewMonth');
        const payViewYearEl        = document.getElementById('payViewYear');

        // ì§€ê¸‰ ë‚´ì—­ í…Œì´ë¸”
        const payHistoryBodyMonth  = document.getElementById('payHistoryBodyMonth');
        const payHistoryBodyYear   = document.getElementById('payHistoryBodyYear');
        const payHistoryCount      = document.getElementById('payHistoryCount');

        // í•©ê³„ ì˜ì—­
        const summaryTotalWorkTime = document.getElementById('summaryTotalWorkTime');
        const summaryTotalJuhyuTime= document.getElementById('summaryTotalJuhyuTime');
        const summaryTotalWorkPay  = document.getElementById('summaryTotalWorkPay');
        const summaryTotalJuhyuPay = document.getElementById('summaryTotalJuhyuPay');
        const summaryTotalPay      = document.getElementById('summaryTotalPay');

        // í† ìŠ¤íŠ¸
        const toastEl              = document.getElementById('mainToast');
        const toastBodyEl          = document.getElementById('mainToastBody');

        // ìƒíƒœ
        let allMembers = [];
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        let currentMember = null;
        let selectedMemberId = null;
        let currentPayView = 'MONTH'; // 'MONTH' | 'YEAR'
        let lastMonthlyCount = 0;
        let lastYearlyCount  = 0;

        // ìƒíƒœ ì´ˆê¸°ê°’
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        // ìš°ì¸¡ íƒ­ í´ë¦­
        payViewTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view; // MONTH | YEAR
                if (!view) return;
                currentPayView = view;

                payViewTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (view === 'MONTH') {
                    payViewMonthEl.classList.remove('d-none');
                    payViewYearEl.classList.add('d-none');
                    payHistoryCount.textContent = `${lastMonthlyCount}ê±´`;
                } else {
                    payViewYearEl.classList.remove('d-none');
                    payViewMonthEl.classList.add('d-none');
                    payHistoryCount.textContent = `${lastYearlyCount}ê±´`;
                }
            });
        });

        // ì´ˆê¸° ì‹¤í–‰
        handleStatusChange();

        // ===== ìƒíƒœ ë³€ê²½ ì‹œ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  =====
        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered.length) {
                const keep = filtered.find(m => String(m.id) === String(selectedMemberId)) || filtered[0];
                selectMember(keep);
            } else {
                selectedMemberId = null;
                currentMember = null;
                clearRight();
            }
        }

        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = members.length + 'ëª…';

            members
                    .slice()
                    .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item member-chip';
                        li.dataset.memberId = String(m.id);
                        const color = colorForMember(m);

                        li.innerHTML = `
                        <span class="left d-inline-flex align-items-center gap-2">
                            <span class="dot" style="background:${color}"></span>
                            <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
                            <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
                        </span>
                        <button type="button"
                                class="btn btn-sm btn-outline-primary view-btn"
                                data-id="${String(m.id)}">ìƒì„¸</button>
                    `;
                        memberList.appendChild(li);
                    });

            if (!members.length) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = 'í•´ë‹¹ ìƒíƒœì˜ ê·¼ë¬´ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                memberList.appendChild(li);
            }

            updateMemberListActive();
        }

        function onMemberListClick(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                const id = btn.getAttribute('data-id');
                if (id) window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
                return;
            }

            const li = e.target.closest('li.member-chip');
            if (!li) return;
            const id = li.dataset.memberId;
            const members = (allMembers || []).filter(m => m.status === statusSelect.value);
            const target = members.find(m => String(m.id) === String(id));
            if (target) selectMember(target);
        }

        function selectMember(member) {
            currentMember = member;
            selectedMemberId = member.id;
            updateMemberListActive();
            renderMemberHeader(member);
            loadPaidPayroll(member);
        }

        function updateMemberListActive() {
            Array.from(memberList.querySelectorAll('.member-chip')).forEach(li => {
                li.classList.toggle('active', li.dataset.memberId === String(selectedMemberId));
            });
        }

        function renderMemberHeader(member) {
            if (!member) {
                pageTitle.textContent = 'ê¸‰ì—¬ ì§€ê¸‰ê´€ë¦¬';
                selectedMemberNameEl.textContent = '';
                selectedMemberStatus.classList.add('d-none');
                selectedMemberStatus.textContent = '-';
                selectedMemberStatus.className = 'badge bg-secondary d-none';
                return;
            }
            pageTitle.textContent = 'ê¸‰ì—¬ ì§€ê¸‰ê´€ë¦¬';
            selectedMemberNameEl.textContent = `(${member.name ?? '-'})`;
            const badgeMap = {
                WORKING: 'bg-success',
                WAITING: 'bg-secondary',
                RESTING: 'bg-info',
                PAUSED: 'bg-warning',
                RESIGNED: 'bg-danger'
            };
            selectedMemberStatus.classList.remove('d-none');
            selectedMemberStatus.textContent = member.status || '-';
            selectedMemberStatus.className = `badge ${badgeMap[member.status] || 'bg-secondary'} ms-2`;
        }

        function clearRight() {
            payHistoryBodyMonth.innerHTML = '';
            payHistoryBodyYear.innerHTML  = '';
            payHistoryCount.textContent   = '0ê±´';
            lastMonthlyCount = 0;
            lastYearlyCount  = 0;

            summaryTotalWorkTime.textContent = '0ì‹œê°„';
            summaryTotalJuhyuTime.textContent = '0ì‹œê°„';
            summaryTotalWorkPay.textContent  = '-';
            summaryTotalJuhyuPay.textContent = '-';
            summaryTotalPay.textContent      = '-';

            renderMemberHeader(null);
        }

        // ===== ì§€ê¸‰ì™„ë£Œ ê¸‰ì—¬ ë‚´ì—­ ë¡œë”© =====
        async function loadPaidPayroll(member) {
            if (!member) {
                clearRight();
                return;
            }

            payHistoryBodyMonth.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
            `;
            payHistoryBodyYear.innerHTML = '';
            payHistoryCount.textContent = '0ê±´';
            lastMonthlyCount = 0;
            lastYearlyCount  = 0;

            let list = [];
            try {
                const url = `${PAYROLL_MEMBER_API}/${encodeURIComponent(member.id)}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) {
                    const text = await resp.text().catch(()=> '');
                    console.error('loadPaidPayroll error', resp.status, text);
                    showToast('ì§€ê¸‰ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    clearRight();
                    renderMemberHeader(member);
                    return;
                }
                list = await resp.json();
                if (!Array.isArray(list)) list = [];
            } catch (e) {
                console.error('loadPaidPayroll fetch error', e);
                showToast('ì§€ê¸‰ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                clearRight();
                renderMemberHeader(member);
                return;
            }

            renderPayrollList(member, list);
        }

        // ===== ì§€ê¸‰ë‚´ì—­ í…Œì´ë¸” + í•©ê³„ ë Œë” =====
        function renderPayrollList(member, list) {
            payHistoryBodyMonth.innerHTML = '';
            payHistoryBodyYear.innerHTML  = '';

            if (!Array.isArray(list) || list.length === 0) {
                const emptyMonth = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            ì§€ê¸‰ì™„ë£Œëœ ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                const emptyYear = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            ì—°ë„ë³„ë¡œ ì§‘ê³„í•  ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                payHistoryBodyMonth.innerHTML = emptyMonth;
                payHistoryBodyYear.innerHTML  = emptyYear;

                payHistoryCount.textContent = '0ê±´';
                lastMonthlyCount = 0;
                lastYearlyCount  = 0;

                summaryTotalWorkTime.textContent = '0ì‹œê°„';
                summaryTotalJuhyuTime.textContent = '0ì‹œê°„';
                summaryTotalWorkPay.textContent  = '-';
                summaryTotalJuhyuPay.textContent = '-';
                summaryTotalPay.textContent      = '-';

                return;
            }

            // payYear, payMonth ê¸°ì¤€ ìµœì‹ ìˆœ ì •ë ¬ (ìµœê·¼ ì§€ê¸‰ì´ ìœ„ë¡œ ì˜¤ë„ë¡)
            list.sort((a, b) => {
                const ay = a.payYear || 0, by = b.payYear || 0;
                const am = a.payMonth || 0, bm = b.payMonth || 0;
                if (ay !== by) return by - ay;
                return bm - am;
            });

            let totalWorkMinutes = 0;
            let totalJuhyuMinutes = 0;
            let totalWorkPay = 0;
            let totalJuhyuPay = 0;
            let totalPay = 0;

            // ì—°ë„ë³„ í•©ê³„ë¥¼ ìœ„í•œ ë§µ
            const yearMap = {}; // { [year]: { workMinutes, juhyuMinutes, workPay, juhyuPay, totalPay } }

            const monthRows = list.map(item => {
                const year  = item.payYear ?? '-';
                const month = item.payMonth != null ? pad2(item.payMonth) : '--';

                // ì§€ê¸‰ì¼
                const rawPaidDate = item.paidDate;
                const paidDate = rawPaidDate ? formatDateTime(rawPaidDate) : '-';

                const status = (item.status || 'PAID').toUpperCase();

                const workMinutes  = item.monthWorkMinutes  || 0;
                const juhyuMinutes = item.monthJuhyuMinutes || 0;
                const workPay      = item.monthWorkPay      || 0;
                const juhyuPay     = item.monthJuhyuPay     || 0;
                const total        = item.monthTotalPay     || (workPay + juhyuPay);

                totalWorkMinutes  += workMinutes;
                totalJuhyuMinutes += juhyuMinutes;
                totalWorkPay      += workPay;
                totalJuhyuPay     += juhyuPay;
                totalPay          += total;

                // ì—°ë„ë³„ í•©ì‚°
                if (item.payYear != null) {
                    const y = item.payYear;
                    if (!yearMap[y]) {
                        yearMap[y] = {
                            workMinutes: 0,
                            juhyuMinutes: 0,
                            workPay: 0,
                            juhyuPay: 0,
                            totalPay: 0
                        };
                    }
                    yearMap[y].workMinutes  += workMinutes;
                    yearMap[y].juhyuMinutes += juhyuMinutes;
                    yearMap[y].workPay      += workPay;
                    yearMap[y].juhyuPay     += juhyuPay;
                    yearMap[y].totalPay     += total;
                }

                const hourly = (typeof item.hourlyWage === 'number')
                        ? krw(item.hourlyWage)
                        : ((typeof member?.hourlyWage === 'number') ? krw(member.hourlyWage) : '-');

                const statusLabelMap = { DRAFT:'ì„ì‹œì €ì¥', CONFIRMED:'í™•ì •', PAID:'ì§€ê¸‰ì™„ë£Œ' };
                const statusBadgeMap = { DRAFT:'bg-secondary', CONFIRMED:'bg-info', PAID:'bg-success' };
                const statusLabel = statusLabelMap[status] || status;
                const statusClass = statusBadgeMap[status] || 'bg-secondary';

                return `
                    <tr>
                        <td>${year}-${month}</td>
                        <td>${paidDate}</td>
                        <td>
                            <span class="badge ${statusClass}">${statusLabel}</span>
                        </td>
                        <td class="text-end">${hourly}</td>
                        <td>${formatMins(workMinutes)}</td>
                        <td>${formatMins(juhyuMinutes)}</td>
                        <td class="text-end">${workPay ? krw(workPay) : '-'}</td>
                        <td class="text-end">${juhyuPay ? krw(juhyuPay) : '-'}</td>
                        <td class="text-end fw-semibold">${total ? krw(total) : '-'}</td>
                    </tr>
                `;
            });

            payHistoryBodyMonth.innerHTML = monthRows.join('');
            lastMonthlyCount = list.length;

            // ì—°ë„ë³„ í…Œì´ë¸” ë Œë”ë§
            const years = Object.keys(yearMap).map(y => Number(y)).sort((a,b) => b - a); // ìµœì‹  ì—°ë„ ìœ„
            if (years.length === 0) {
                payHistoryBodyYear.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            ì—°ë„ë³„ë¡œ ì§‘ê³„í•  ê¸‰ì—¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                lastYearlyCount = 0;
            } else {
                const yearRows = years.map(y => {
                    const aggr = yearMap[y];
                    return `
                        <tr>
                            <td>${y}</td>
                            <td>${formatMins(aggr.workMinutes)}</td>
                            <td>${formatMins(aggr.juhyuMinutes)}</td>
                            <td class="text-end">${aggr.workPay ? krw(aggr.workPay) : '-'}</td>
                            <td class="text-end">${aggr.juhyuPay ? krw(aggr.juhyuPay) : '-'}</td>
                            <td class="text-end fw-semibold">${aggr.totalPay ? krw(aggr.totalPay) : '-'}</td>
                        </tr>
                    `;
                });
                payHistoryBodyYear.innerHTML = yearRows.join('');
                lastYearlyCount = years.length;
            }

            // í˜„ì¬ ë·°ì— ë§ê²Œ ê±´ìˆ˜ í‘œì‹œ
            if (currentPayView === 'MONTH') {
                payHistoryCount.textContent = `${lastMonthlyCount}ê±´`;
            } else {
                payHistoryCount.textContent = `${lastYearlyCount}ê±´`;
            }

            // í•©ê³„ ë°˜ì˜ (ì „ì²´ ê¸°ê°„ ê¸°ì¤€)
            summaryTotalWorkTime.textContent  = formatMins(totalWorkMinutes);
            summaryTotalJuhyuTime.textContent = formatMins(totalJuhyuMinutes);
            summaryTotalWorkPay.textContent   = totalWorkPay  ? krw(totalWorkPay)  : '-';
            summaryTotalJuhyuPay.textContent  = totalJuhyuPay ? krw(totalJuhyuPay) : '-';
            summaryTotalPay.textContent       = totalPay      ? krw(totalPay)      : '-';
        }

        // ===== í† ìŠ¤íŠ¸ í—¬í¼ =====
        function showToast(message, type) {
            if (!toastEl || !toastBodyEl) return;
            toastBodyEl.textContent = message;

            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            if (type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            } else if (type === 'info') {
                toastEl.classList.add('text-bg-info');
            } else {
                toastEl.classList.add('text-bg-success');
            }

            if (window.bootstrap && bootstrap.Toast) {
                const t = bootstrap.Toast.getOrCreateInstance(toastEl);
                t.show();
            } else {
                toastEl.style.display = 'block';
                setTimeout(() => { toastEl.style.display = 'none'; }, 2000);
            }
        }

        // ===== ìœ í‹¸ í•¨ìˆ˜ë“¤ =====
        function pad2(n) {
            return String(n).padStart(2,'0');
        }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v/60);
            const m = v % 60;
            return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function krw(v) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        function colorForMember(m) {
            const key = (m?.id != null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key) % 360, s = 65, l = 55;
            return hslToHex(h, s, l);
        }

        function seededHash(str) {
            let h = 2166136261 >>> 0;
            for (let i=0;i<str.length;i++) {
                h ^= str.charCodeAt(i);
                h = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }

        function hslToHex(h,s,l) {
            s/=100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1-l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }

        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        // âœ… ì§€ê¸‰ì¼ í¬ë§·í„°: 2025-11-12 10:20
        function formatDateTime(value) {
            if (!value) return '-';

            let d;

            if (value instanceof Date) {
                d = value;
            } else if (typeof value === 'number') {
                // ms / s ë‘˜ ë‹¤ ëŒ€ì¶© ëŒ€ì‘
                d = new Date(value < 1e12 ? value * 1000 : value);
            } else {
                // ë¬¸ìì—´: "2025-11-12T10:20:00", "2025-11-12 10:20:00", "2025-11-12T10:20:00+09:00" ë“±
                const s = String(value).replace(' ', 'T');
                const parsed = new Date(s);
                if (isNaN(parsed.getTime())) {
                    // íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ
                    return String(value);
                }
                d = parsed;
            }

            const y  = d.getFullYear();
            const M  = pad2(d.getMonth() + 1);
            const D  = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mm = pad2(d.getMinutes());

            return `${y}-${M}-${D} ${hh}:${mm}`;
        }
    })();
</script>

{{>layouts/footer}}
