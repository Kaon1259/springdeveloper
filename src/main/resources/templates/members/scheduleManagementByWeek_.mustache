{{>layouts/header}}

<main class="container my-4">
    <!-- ============ ìƒë‹¨: ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸° (ì›”ê°„ í™”ë©´ê³¼ ë™ì¼ UI) ============ -->
    <div class="card mb-3">
        <div class="card-body p-0">
            <div class="status-panel-blue">
                <!-- íƒ€ì´í‹€ + ì¡°íšŒ ì£¼ê°„ -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="status-title">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</div>
                        <div class="status-subtitle-small">
                            ìƒíƒœë³„ë¡œ ì•„ë¥´ë°”ì´íŠ¸ìƒì„ í•„í„°ë§í•˜ê³ , ì„ íƒí•œ ìƒíƒœì˜ ì£¼ê°„ ì¼ì •ì„ í•¨ê»˜ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <span class="status-period-label-caption">ì¡°íšŒ ì£¼ê°„</span>
                        <!-- ì£¼ê°„ ë²”ìœ„ ë¼ë²¨: JSì—ì„œ weekRangeLabel ë¡œ ì±„ì›€ -->
                        <span id="weekRangeLabel" class="status-period-label-value">0000.00.01 ~ 00.00</span>
                    </div>
                </div>

                <!-- ë³¸ë¬¸: ìƒíƒœ ì„ íƒ + ì¹© ë¦¬ìŠ¤íŠ¸ -->
                <div class="row g-3 align-items-start">
                    <!-- ì™¼ìª½: ìƒíƒœ ì„ íƒ -->
                    <div class="col-12 col-md-4">
                        <label class="form-label small status-label" for="statusSelect">ìƒíƒœ</label>
                        <select id="statusSelect" class="form-select status-select">
                            <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                            <option value="WAITING">ì‹œì‘ì „</option>
                            <option value="RESTING">íœ´ì‹ì¤‘</option>
                            <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                            <option value="RESIGNED">í‡´ì‚¬</option>
                        </select>
                        <div class="form-text status-help-text">
                            ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ì™€ ì•„ë˜ íƒ€ì„í…Œì´ë¸”ì´ í•¨ê»˜ ë°”ë€ë‹ˆë‹¤.
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ ìƒ ì¹© ë¦¬ìŠ¤íŠ¸ -->
                    <div class="col-12 col-md-8">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small status-subtitle">í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ</span>
                            <span id="memberCountBadge" class="badge bg-light text-dark status-count-badge">0ëª…</span>
                        </div>

                        <!-- ì¹© ë¦¬ìŠ¤íŠ¸ (ì›”ê°„ í™”ë©´ê³¼ ë™ì¼ pill UI) -->
                        <div id="memberList" class="vlist status-pill-list"></div>

                        <div class="small status-caption mt-2">
                            * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤. (ì•„ë˜ ì£¼ê°„ íƒ€ì„í…Œì´ë¸”ì—ë„ ë™ì¼ ìƒ‰ ì‚¬ìš©)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: ì£¼ê°„ íƒ€ì„í…Œì´ë¸” -->
    <div class="card weekly-card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center weekly-card-header">
            <div class="d-flex flex-column">
                <span>ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</span>
                <div class="mt-1 btn-group btn-group-sm" role="group" aria-label="ë‹¨ìœ„ ì„ íƒ">
                    <button type="button" id="btnSlot10" class="btn btn-sm btn-outline-light">10ë¶„</button>
                    <button type="button" id="btnSlot30" class="btn btn-sm btn-outline-light">30ë¶„</button>
                    <button type="button" id="btnSlot60" class="btn btn-sm btn-outline-light active">1ì‹œê°„</button>
                </div>
                <span class="small text-light mt-1 opacity-75">
                    í•œ ì¹¸ = ì„ íƒëœ ë‹¨ìœ„, ê° ìš”ì¼ ì‚¬ì´ì˜ ì—´ì€ í•´ë‹¹ ì‹œê°„ëŒ€ ì¸ì›ìˆ˜, ë§ˆì§€ë§‰ ì—´ì€ ì „ì²´ ì¸ì›ìˆ˜
                </span>
            </div>

            <!-- ìš°ì¸¡: ì§€ë‚œì£¼ / [ë‚ ì§œë²”ìœ„] / ê¸ˆì£¼ / ë‹¤ìŒì£¼ + PDF ì¶œë ¥ ë²„íŠ¼ -->
            <div class="d-flex align-items-center gap-2">
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-light">â—€ ì§€ë‚œì£¼</button>
                <span id="weekRangeLabelRight" class="small text-light px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-light">ê¸ˆì£¼</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-light">ë‹¤ìŒì£¼ â–¶</button>

                <!-- PDF ì „ì²´ / ê°œë³„ ì¶œë ¥ ë²„íŠ¼ -->
                <button id="btnOpenPrintPage" class="btn btn-sm btn-light fw-semibold text-primary">
                    PDF ì¶œë ¥
                </button>
                <button id="btnOpenPrintMemberPage" class="btn btn-sm btn-outline-light fw-semibold">
                    PDF(ê°œë³„)
                </button>
            </div>
        </div>
        <div class="card-body weekly-card-body">
            <div id="noMemberState" class="text-muted small d-none">
                í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <div id="timetableWrapper" class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weekStaffTable">
                    <thead>
                    <tr>
                        <th style="width:80px;">ì‹œê°„</th>

                        <!-- ì›” -->
                        <th data-dow="0" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">ì›”</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- í™” -->
                        <th data-dow="1" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">í™”</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- ìˆ˜ -->
                        <th data-dow="2" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">ìˆ˜</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- ëª© -->
                        <th data-dow="3" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">ëª©</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- ê¸ˆ -->
                        <th data-dow="4" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">ê¸ˆ</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- í†  -->
                        <th data-dow="5" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">í† </span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- ì¼ -->
                        <th data-dow="6" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">ì¼</span>
                                    <span class="day-date ms-1 small opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <th style="width:80px;">í•©ê³„</th>
                    </tr>
                    </thead>
                    <tbody id="weekStaffTbody">
                    <!-- JS ë Œë” -->
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">
                * í•˜ì´ë¼ì´íŠ¸(ìƒë‹¨ ì¹© ì„ íƒ)ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ í¬í•¨ëœ ì…€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ìš”ì¼ í—¤ë”ì— <b>â€˜ê·¼ë¬´ì¼ì • ìˆ˜ì •â€™</b> ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.<br>
                * í¬í•¨ë˜ì§€ ì•Šì€ ì…€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ìš”ì¼ í—¤ë”ì— <b>â€˜ì¼ì •ìƒì„±í•˜ê¸°â€™</b> ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.<br>
                * ê° ìš”ì¼ ì‚¬ì´ì˜ íšŒìƒ‰ ì—´ì€ í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ì¸ì›ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ ê°œë³„ ì£¼ê°„ ì¼ì • (í•˜ë‹¨) -->
    <div class="card mt-3 member-week-card d-none" id="memberWeekCard">
        <div class="card-header d-flex justify-content-between align-items-center member-week-card-header">
            <div>
                <span class="fw-bold" id="memberWeekTitle">ê°œë³„ ì£¼ê°„ ì¼ì •</span>
                <span class="badge bg-light text-white ms-2" id="memberWeekNameBadge"></span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-light" id="btnToggleMemberWeek">í¼ì¹˜ê¸°</button>
                <span class="fw-bold text-light small" id="memberWeekSaveHint">(10ë‹¨ìœ„ ì €ì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.)</span>
                <button type="submit" class="btn btn-sm btn-light fw-semibold" form="memberWeekForm" id="btnSaveWeek" disabled>ì €ì¥</button>
            </div>
        </div>
        <div class="card-body member-week-card-body d-none" id="memberWeekBody">
            <div id="noPlanAlert" class="alert alert-warning py-2 px-3 d-none">
                <strong>ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</strong> ì¼ì •ì„ ìƒì„±í•˜ì„¸ìš”.
            </div>

            <form id="memberWeekForm" class="mt-0">
                <div class="grid-toolbar mb-2">
                    <div class="left">
                        <div class="btn-group btn-group-sm" id="gridSlotButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„ ì„ íƒ">
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="10">10ë¶„</button>
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30ë¶„</button>
                            <button type="button" class="btn btn-outline-secondary active" data-grid-slot="60">1ì‹œê°„</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="btnGridClearAll">ì „ì²´ ì´ˆê¸°í™”</button>
                    </div>
                    <div class="right small text-muted">
                        ì‹œê°„ ìŠ¬ë¡¯ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒ/í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (06:00 ~ 22:00)
                    </div>
                </div>

                <div class="week-grid mb-0">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:74px;">ì‹œê°„</th>
                            <th data-day-offset="0">ì›”</th>
                            <th data-day-offset="1">í™”</th>
                            <th data-day-offset="2">ìˆ˜</th>
                            <th data-day-offset="3">ëª©</th>
                            <th data-day-offset="4">ê¸ˆ</th>
                            <th data-day-offset="5">í† </th>
                            <th data-day-offset="6">ì¼</th>
                        </tr>
                        </thead>
                        <tbody id="memberWeekGridBody">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- ===== í¸ì§‘ ëª¨ë‹¬ ===== -->
<div class="modal" id="editModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <div class="d-flex justify-content-between align-items-center mb-2 edit-modal-header">
                <div class="fw-bold">
                    <span id="editTitleDate">0000-00-00</span>
                    <span class="text-muted">/</span>
                    <span id="editTitleMember">ì•Œë°”ìƒ ì´ë¦„</span>
                </div>
            </div>

            <div class="edit-modal-body">
                <div class="row g-3">
                    <!-- ì¢Œ: ì¼ì • ìš”ì•½ -->
                    <div class="col-12 col-md-5">
                        <div class="summary-box p-2 border rounded-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="small text-muted">ì¼ì • ìš”ì•½</div>
                                <span class="badge bg-light text-dark" id="summaryStepBadge">ìŠ¬ë¡¯: 30ë¶„</span>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">ì €ì¥ëœ ì¼ì •</div>
                                <div id="summaryOriginal" class="d-flex flex-wrap gap-2 small text-muted"></div>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">ìˆ˜ì •ì•ˆ(í˜„ì¬ ì„ íƒ)</div>
                                <div id="summaryCurrent" class="d-flex flex-wrap gap-2 small"></div>
                            </div>

                            <div class="mt-2 small">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ì›ë³¸ ì´ ì‹œê°„</span>
                                    <span id="summaryOriginalTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ìˆ˜ì •ì•ˆ ì´ ì‹œê°„</span>
                                    <span id="summaryCurrentTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">ì¦ê°(ìˆ˜ì •ì•ˆ - ì›ë³¸)</span>
                                    <span id="summaryDiffTotal" class="fw-semibold">0ë¶„</span>
                                </div>
                            </div>

                            <div class="mt-2 small">
                                <span class="legend legend-actual"></span> ì›ë³¸ ìœ ì§€ ë¸”ë¡
                                &nbsp;Â·&nbsp;
                                <span class="legend legend-plan"></span> ìƒˆë¡œ ì¶”ê°€ëœ ë¸”ë¡(íŒŒë€ìƒ‰)
                            </div>
                        </div>
                    </div>

                    <!-- ìš°: í¸ì§‘ ê·¸ë¦¬ë“œ -->
                    <div class="col-12 col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" id="slotStepButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„">
                                <button type="button" class="btn btn-outline-secondary" data-step="10">10ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary active" data-step="30">30ë¶„</button>
                                <button type="button" class="btn btn-outline-secondary" data-step="60">1ì‹œê°„</button>
                            </div>
                            <div class="small text-muted">ì‹œê°„ ìŠ¬ë¡¯ì„ ë“œë˜ê·¸ë¡œ ì„ íƒ/í•´ì œí•©ë‹ˆë‹¤. (06:00 ~ 22:00)</div>
                        </div>

                        <div class="day-grid mb-2">
                            <table id="dayGridTable">
                                <thead>
                                <tr>
                                    <th style="width:74px;">ì‹œê°„</th>
                                    <th>ì„ íƒ</th>
                                </tr>
                                </thead>
                                <tbody id="dayGridBody">
                                <!-- JS ë Œë” -->
                                </tbody>
                            </table>
                        </div>

                        <div class="text-end small">
                            ì´ ì„ íƒ: <span id="selectedMinutes" class="fw-bold">0</span>ë¶„
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-2">
                <button id="btnSaveEdit" class="btn btn-sm btn-primary" disabled>ì €ì¥</button>
                <button id="btnCancelEdit" class="btn btn-sm btn-outline-secondary">ë˜ëŒë¦¬ê¸°</button>
                <button id="btnCloseModal" class="btn btn-sm btn-outline-dark">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== ğŸ”µ ìƒë‹¨ ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœ íŒ¨ë„ (ì›”ê°„ í™”ë©´ê³¼ ë™ì¼) ===== */
    .status-panel-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        border-radius: 18px;
        padding: 16px 20px 18px;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
        color: #e5eeff;
    }
    .status-title {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: .02em;
    }
    .status-subtitle-small {
        font-size: .8rem;
        margin-top: 2px;
        color: rgba(226, 232, 255, 0.78);
    }
    .status-period-label-caption {
        font-size: .75rem;
        color: rgba(226, 232, 255, 0.7);
    }
    .status-period-label-value {
        font-size: .85rem;
        font-weight: 600;
        margin-top: 1px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.32);
        border: 1px solid rgba(191, 219, 254, 0.6);
    }
    .status-label {
        color: rgba(226, 232, 255, 0.9) !important;
    }
    .status-help-text {
        color: rgba(226, 232, 255, 0.85) !important;
    }
    .status-subtitle {
        color: rgba(226, 232, 255, 0.9);
    }
    .status-caption {
        color: rgba(226, 232, 255, 0.8);
    }
    .status-legend-text {
        color: rgba(226, 232, 255, 0.85);
    }
    .status-count-badge {
        border-radius: 999px;
        padding: 3px 10px;
        font-weight: 600;
    }
    .status-select {
        background: rgba(15, 23, 42, 0.25);
        border-color: rgba(191, 219, 254, 0.6);
        color: #e5eeff;
    }
    .status-select:focus {
        background: rgba(15, 23, 42, 0.35);
        border-color: #bfdbfe;
        box-shadow: 0 0 0 0.2rem rgba(191, 219, 254, 0.45);
        color: #f9fbff;
    }
    .status-select option {
        color: #111827;
    }
    .status-pill-list {
        margin-top: 2px;
    }

    /* ===== ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸: ì¹© ìŠ¤íƒ€ì¼ (ì›”ê°„ í™”ë©´ê³¼ ë™ì¼) ===== */
    .vlist { display:flex; flex-wrap:wrap; gap:8px; }
    .pill {
        display:flex; align-items:center; gap:8px; padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(191, 219, 254, 0.7);
        background: rgba(15, 23, 42, 0.18);
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s, transform .08s, opacity .15s, filter .15s;
        color:#e5eeff;
    }
    .pill:hover {
        background: rgba(15, 23, 42, 0.28);
        border-color: rgba(248, 250, 252, 0.95);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.45);
    }
    .pill.active {
        border-color: rgba(191, 219, 254, 0.95);
        box-shadow: 0 0 0 2px rgba(191, 219, 254, 0.7), 0 10px 25px rgba(15, 23, 42, 0.55);
        background: rgba(15, 23, 42, 0.4);
        transform: translateY(-1px);
    }
    .pill .dot {
        width:12px; height:12px; border-radius:50%;
        border:1px solid rgba(15, 23, 42,.15);
        flex:0 0 12px;
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:rgba(226, 232, 255, 0.8); font-size:.8rem; }

    /* â˜… ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ ì™¸ ë‚˜ë¨¸ì§€ ë¸”ëŸ¬/ë””ë° (ì£¼ê°„ í™”ë©´ì—ì„œë„ ë™ì¼ ëŠë‚Œ) */
    body.alba-has-selected .pill:not(.active) {
        opacity: .35;
        filter: grayscale(.4);
    }
    body.alba-has-selected .pill.active {
        opacity: 1;
        filter: none;
    }
    body.alba-has-selected .staff-tag:not(.selected-member-tag) {
        opacity: .35;
        filter: grayscale(.35);
    }
    body.alba-has-selected .staff-tag.selected-member-tag {
        opacity: 1;
        filter: none;
    }

    /* ===== ì£¼ê°„ íƒ€ì„í…Œì´ë¸” ì¹´ë“œ (í•˜ë‹¨ ì „ì²´ íŒŒë€ ë¼ìš´ë“œ) ===== */
    .weekly-card {
        border-radius: 18px;
        overflow: hidden;
        border: none;
        box-shadow: 0 10px 25px rgba(15,23,42,0.12);
    }
    .weekly-card-header {
        background: linear-gradient(135deg,#1d4ed8,#2563eb);
        color:#ffffff;
        border-bottom:none;
    }
    .weekly-card-header .btn-outline-light.active {
        background-color:#ffffff;
        color:#1d4ed8;
        border-color:#ffffff;
    }
    .weekly-card-body {
        background:#ffffff;
        border-top:1px solid rgba(148,163,184,0.35);
    }

    /* ===== íƒ€ì„í…Œì´ë¸” ===== */
    #weekStaffTable { border-collapse: separate; border-spacing: 0; }

    #weekStaffTable thead th {
        background:#0d6efd !important;
        color:#ffffff !important;
        border-color:#0b5ed7 !important;
        vertical-align:top;
        font-weight:600;
        font-size:0.9rem;
    }

    #weekStaffTable thead .day-head-rect{
        padding:0;
        margin:0;
        background:transparent;
        border-radius:0;
        box-shadow:none;
    }
    .day-head-main {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:4px;
    }
    .day-name {
        font-weight:700;
        font-size:0.9rem;
    }
    .day-date { line-height: 1.1; color: rgba(255,255,255,.85); }
    .day-edit-wrap {
        min-height: 24px;
        display:flex;
        justify-content:flex-end;
        align-items:center;
        margin-top:2px;
    }
    .day-edit-btn {
        padding: 2px 8px;
        font-size: .75rem;
        border-radius:999px;
    }

    /* í˜„ì¬ ìš”ì¼ í—¤ë”(th) â€“ ì£¼í™©ìƒ‰ */
    #weekStaffTable thead th.today-col-head{
        background: linear-gradient(135deg,#f97316,#ea580c) !important;
        color:#ffffff !important;
        border-color:#c0560a !important;
    }

    .hour-row-header { font-variant-numeric: tabular-nums; background:#f8fafc; }
    .staff-cell {
        vertical-align: middle;
        font-size:.85rem;
        cursor:pointer;
        padding:0 !important;
    }
    .day-count-cell {
        font-size:0.75rem;
        color:#6c757d;
        padding:0 !important;
        font-variant-numeric: tabular-nums;
        line-height:1.1;
    }

    tr.hour-separator > td, tr.hour-separator > th { border-top:2px solid #dee2e6 !important; }

    .time-band-cell {
        border:none !important;
        background:transparent !important;
    }
    .time-band-inner {
        height:100%;
        width:100%;
        padding:.25rem .25rem;
        background:#f9fafb;
        border-top:1px solid #e5e7eb;
        border-bottom:1px solid #e5e7eb;
        display:flex;
        align-items:center;
        justify-content:center;
        box-sizing:border-box;
    }
    .time-band-left .time-band-inner {
        border-left:1px solid #e5e7eb;
        border-top-left-radius:12px;
        border-bottom-left-radius:12px;
    }
    .time-band-right .time-band-inner {
        border-right:1px solid #e5e7eb;
        border-top-right-radius:12px;
        border-bottom-right-radius:12px;
    }

    .staff-tags { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; }
    .staff-tag {
        display:inline-flex; align-items:center; gap:4px;
        border-radius:999px; padding:2px 6px; font-size:.75rem;
        background:#f8f9fa; border:1px solid #dee2e6; max-width:90px;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        transition: background-color .15s ease, border-color .15s ease, transform .1s ease, opacity .15s ease, filter .15s ease;
    }
    .staff-tag-dot { width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.08); flex:0 0 10px; }
    .staff-count { font-weight:600; font-size:.9rem; }

    /* ì˜¤ëŠ˜ ì»¬ëŸ¼ ë³¸ë¬¸ â€“ ì€ì€í•œ ê°•ì¡°ë§Œ (í–‰ ì „ì²´ ì—°í•œ ë°°ê²½ ì œê±°) */
    td.today-col .time-band-inner {
        background: rgba(249,115,22,0.08);
    }

    /* í˜„ì¬ ì‹œê°„í–‰ ë°°ê²½ ê°•ì¡° ì œê±°: classëŠ” ìœ ì§€í•˜ë˜ ìŠ¤íƒ€ì¼ì€ ê¸°ë³¸ê³¼ ë™ì¼ */
    .current-time-row .hour-row-header {
        background:#f8fafc !important;
    }
    .current-time-row .time-band-inner {
        background:#f9fafb;
    }
    .current-time-row td.today-col .time-band-inner {
        background: rgba(249,115,22,0.08);
    }

    /* ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ íƒœê·¸ ê°•ì¡° */
    .staff-tag.selected-member-tag {
        background: rgba(13,110,253,.10);
        border-color: rgba(13,110,253,.7);
        font-weight: 600;
        transform: scale(1.02);
    }

    /* í˜„ì¬ ì‹œê°„ëŒ€ ì•„ë¥´ë°”ì´íŠ¸ íƒœê·¸ ê¹œë¹¡ì„ (ìœ ì§€) */
    .staff-tag-current {
        animation: staffTagBlink 1.05s step-start infinite;
        background: rgba(255,193,7,0.95) !important;
        border-color: rgba(255,193,7,1) !important;
        box-shadow: 0 0 0 2px rgba(255,193,7,0.7);
        color:#212529;
    }
    @keyframes staffTagBlink {
        0%   { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(255,193,7,0.0); }
        50%  { filter:brightness(1.15); box-shadow:0 0 0 3px rgba(255,193,7,0.7); }
        100% { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(255,193,7,0.0); }
    }

    /* ê°œë³„ ì£¼ê°„ ì¼ì • ì¹´ë“œ â€“ íŒŒë€ ë¼ìš´ë“œë ‰íŠ¸ */
    .member-week-card {
        border-radius:18px;
        overflow:hidden;
        border:none;
        box-shadow:0 10px 22px rgba(15,23,42,0.12);
    }
    .member-week-card-header {
        background:linear-gradient(135deg,#1d4ed8,#2563eb);
        color:#ffffff;
        border-bottom:none;
    }
    .member-week-card-body {
        background:#ffffff;
        border-top:1px solid rgba(148,163,184,0.35);
    }
    .member-week-card-header .badge {
        background-color:rgba(15,23,42,0.16) !important;
        border-radius:999px;
        padding:.2rem .7rem;
    }

    .week-grid { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; user-select: none; background:#fff; }
    .week-grid table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    .week-grid thead th {
        background: #0d6efd;
        color:#ffffff;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 1px solid #0b5ed7;
        text-align: center;
        padding: .5rem .4rem;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    .week-grid tbody th {
        background: #fafafa;
        color:#6b7280;
        font-weight: 600;
        width: 74px;
        border-right: 1px solid #e5e7eb;
        text-align: center;
        padding: .25rem .25rem;
        font-size: .8rem;
        position: sticky;
        left: 0;
        z-index: 1;
    }

    .slot-10m { border-bottom: 1px dashed #eef2f6; border-right: 1px dashed #eef2f6; height: 18px; cursor: pointer; background: #ffffff; border-radius: 6px; margin: 1px 0; }
    .slot-10m:hover { background: #f8fbff; }
    .slot-10m.selected { background: rgba(25,135,84,.18); box-shadow: inset 0 0 0 1px rgba(25,135,84,.25); }

    .row-hour-start td, .row-hour-start th { border-top: 2px solid #e5e7eb !important; }
    .timecell { font-variant-numeric: tabular-nums; }

    .grid-toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: .5rem; font-size: .85rem; }
    .grid-toolbar .left, .grid-toolbar .right { display: flex; gap: 8px; align-items: center; }

    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(13,110,253,.25); border-color: rgba(13,110,253,.45); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.40); }

    .modal { background:rgba(0,0,0,.35); position:fixed; inset:0; display:none; z-index:1055; }
    .modal-dialog { margin:50px auto; max-width:980px; }
    .modal-content { background:#fff; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
    .edit-modal-header { padding-bottom:4px; border-bottom:1px solid #e9ecef; }
    .edit-modal-body { padding-top:8px; }

    .summary-box .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e9ecef; border-radius:14px; background:#fff; }
    .chip .dot { width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.08); }

    .day-grid { width:100%; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; user-select:none; background:#fff; max-height:70vh; overflow-y:auto; }
    .day-grid table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .day-grid thead th { background:#f8fafc; color:#64748b; font-weight:600; font-size:.95rem; border-bottom:1px solid #e5e7eb; text-align:center; padding:.6rem .4rem; position:sticky; top:0; z-index:2; }
    .day-grid tbody th.timecell { background:#fafafa; color:#6b7280; font-weight:600; width:74px; border-right:1px solid #e5e7eb; text-align:center; padding:.25rem .25rem; font-size:.85rem; position:sticky; left:0; z-index:1; font-variant-numeric:tabular-nums; }
    .slot-cell { border-bottom:1px dashed #eef2f6; height:18px; cursor:pointer; background:#ffffff; transition: background .12s; }
    .slot-cell:hover { background:#f8fbff; }
    .slot-cell.selected { background:rgba(25,135,84,.18); box-shadow:inset 0 0 0 1px rgba(25,135,84,.25); }
    .slot-cell.selected.selected-diff { background:rgba(13,110,253,0.16); box-shadow:inset 0 0 0 1px rgba(13,110,253,0.45); border-color:rgba(13,110,253,0.55); }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>
<script>
    (function(){
        const API_BASE   = '/api/schedule/work';
        const API_UPDATE = '/api/schedule/work/update';
        const HOUR_START = 6;
        const HOUR_END   = 22;

        // DOM
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');

        const noMemberState    = document.getElementById('noMemberState');
        const timetableWrapper = document.getElementById('timetableWrapper');
        const weekStaffTable   = document.getElementById('weekStaffTable');
        const weekStaffTbody   = document.getElementById('weekStaffTbody');
        const dayHeaderCells   = document.querySelectorAll('#weekStaffTable thead th[data-dow]');

        const btnSlot10 = document.getElementById('btnSlot10');
        const btnSlot30 = document.getElementById('btnSlot30');
        const btnSlot60 = document.getElementById('btnSlot60');

        const btnPrevWeek = document.getElementById('btnPrevWeek');
        const btnThisWeek = document.getElementById('btnThisWeek');
        const btnNextWeek = document.getElementById('btnNextWeek');
        const btnOpenPrintPage        = document.getElementById('btnOpenPrintPage');
        const btnOpenPrintMemberPage  = document.getElementById('btnOpenPrintMemberPage');

        const memberWeekCard      = document.getElementById('memberWeekCard');
        const memberWeekTitle     = document.getElementById('memberWeekTitle');
        const memberWeekNameBadge = document.getElementById('memberWeekNameBadge');
        const memberWeekForm      = document.getElementById('memberWeekForm');
        const btnSaveWeek         = document.getElementById('btnSaveWeek');
        const memberWeekBody      = document.getElementById('memberWeekBody');
        const btnToggleMemberWeek = document.getElementById('btnToggleMemberWeek');

        const memberWeekGridBody      = document.getElementById('memberWeekGridBody');
        const gridSlotButtonsWrapper  = document.getElementById('gridSlotButtons');
        const btnGridClearAll         = document.getElementById('btnGridClearAll');
        const noPlanAlert             = document.getElementById('noPlanAlert');

        // í¸ì§‘ ëª¨ë‹¬
        const editModal            = document.getElementById('editModal');
        const editTitleDate        = document.getElementById('editTitleDate');
        const editTitleMember      = document.getElementById('editTitleMember');
        const btnSaveEdit          = document.getElementById('btnSaveEdit');
        const btnCancelEdit        = document.getElementById('btnCancelEdit');
        const btnCloseModal        = document.getElementById('btnCloseModal');
        const slotStepButtons      = document.getElementById('slotStepButtons');
        const dayGridBody          = document.getElementById('dayGridBody');
        const selectedMinutesEl    = document.getElementById('selectedMinutes');
        const summaryStepBadge     = document.getElementById('summaryStepBadge');
        const summaryOriginal      = document.getElementById('summaryOriginal');
        const summaryCurrent       = document.getElementById('summaryCurrent');
        const summaryOriginalTotal = document.getElementById('summaryOriginalTotal');
        const summaryCurrentTotal  = document.getElementById('summaryCurrentTotal');
        const summaryDiffTotal     = document.getElementById('summaryDiffTotal');

        // ìƒíƒœ
        let allMembers = [];
        let currentStatusMembers = [];
        let currentWeekStart = toMonday(new Date());
        let selectedMember = null;
        let selectedWeekDaysMap = {};

        let slotMinutes = 60;
        let gridStepMinutes = 60;
        const GRID_DAY_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

        // ëª¨ë‹¬/ì¼í¸ì§‘ ìƒíƒœ
        const START_MIN = HOUR_START * 60;
        const END_MIN   = HOUR_END   * 60;
        let stepMinutes  = 30;
        let totalRows    = (END_MIN - START_MIN) / stepMinutes;
        let originalSegments = [];
        let originalSlotSet  = new Set();
        let slotState        = new Set();
        let modalMode        = 'edit';

        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); } catch(e){ allMembers = []; }

        (function safeInitStatus(){
            if (!statusSelect) return;
            const initial = statusSelect.value || 'WORKING';
            const hasInInitial = (allMembers||[]).some(m => m.status === initial);
            if (!hasInInitial) {
                const counts = (allMembers||[]).reduce((acc,m)=>{ acc[m.status]=(acc[m.status]||0)+1; return acc; },{});
                const best = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0];
                if (best && Array.from(statusSelect.options).some(o=>o.value===best)) {
                    statusSelect.value = best;
                }
            }
        })();

        attachHandlers();

        (async () => {
            await handleStatusChange(true);
            updateSaveButtonState();
            updateCurrentTimeHighlight();
            setInterval(updateCurrentTimeHighlight, 15000);
        })();

        function attachHandlers(){
            statusSelect.addEventListener('change', async ()=> { await handleStatusChange(); });

            if (btnSlot10) btnSlot10.addEventListener('click', async ()=> { setSlotMinutes(10); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });
            if (btnSlot30) btnSlot30.addEventListener('click', async ()=> { setSlotMinutes(30); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });
            if (btnSlot60) btnSlot60.addEventListener('click', async ()=> { setSlotMinutes(60); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });

            if (btnPrevWeek) btnPrevWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = addDays(currentWeekStart, -7); await handleStatusChange(); });
            if (btnThisWeek) btnThisWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = toMonday(new Date()); await handleStatusChange(); });
            if (btnNextWeek) btnNextWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = addDays(currentWeekStart, +7); await handleStatusChange(); });

            if (btnOpenPrintPage) {
                btnOpenPrintPage.addEventListener('click', () => {
                    openPrintPage();
                });
            }

            if (btnOpenPrintMemberPage) {
                btnOpenPrintMemberPage.addEventListener('click', () => {
                    openPrintMemberPage();
                });
            }

            if (weekStaffTable) {
                weekStaffTable.addEventListener('click', async (e) => {
                    const td = e.target.closest('td.staff-cell');
                    if (!td || !selectedMember) return;

                    const dayIdx = parseInt(td.dataset.dayIdx || '-1', 10);
                    if (dayIdx < 0 || dayIdx > 6) return;

                    const iso = toIso(addDays(currentWeekStart, dayIdx));
                    const hasSel = td.dataset.hasSelected === '1';

                    if (hasSel) {
                        showDayEditButton(dayIdx, iso);
                    } else {
                        showDayCreateButton(dayIdx, iso);
                    }
                });
            }

            if (gridSlotButtonsWrapper) {
                gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mins = parseInt(btn.dataset.gridSlot, 10);
                        if (!mins || gridStepMinutes === mins) {
                            gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            updateSaveButtonState();
                            return;
                        }
                        gridStepMinutes = mins;
                        gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        buildMemberWeekGrid();
                        hydrateGridFromDayMap(selectedWeekDaysMap);
                        updateSaveButtonState();
                    });
                });
            }

            if (btnGridClearAll) {
                btnGridClearAll.addEventListener('click', () => {
                    if (!memberWeekGridBody) return;
                    memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));
                });
            }

            if (memberWeekForm) {
                memberWeekForm.addEventListener('submit', onSubmitWeekForm);
            }

            if (btnToggleMemberWeek && memberWeekBody) {
                btnToggleMemberWeek.addEventListener('click', () => {
                    const collapsed = memberWeekBody.classList.toggle('d-none');
                    btnToggleMemberWeek.textContent = collapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
                });
            }

            btnSaveEdit.addEventListener('click', onSaveEdit);
            btnCancelEdit.addEventListener('click', onCancelEdit);
            btnCloseModal.addEventListener('click', closeEditModal);
            editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });

            if (slotStepButtons) {
                slotStepButtons.querySelectorAll('button[data-step]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        const newStep = parseInt(btn.dataset.step,10);
                        if(!newStep || newStep === stepMinutes){
                            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                            btn.classList.add('active');
                            updateModalSaveButton();
                            return;
                        }
                        stepMinutes = newStep;
                        totalRows = (END_MIN - START_MIN) / stepMinutes;
                        slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');

                        summaryStepBadge.textContent = `ìŠ¬ë¡¯: ${stepMinutes===60?'1ì‹œê°„':(stepMinutes+'ë¶„')}`;
                        originalSlotSet = segmentsToSlotSet(originalSegments, stepMinutes);
                        slotState = new Set([...originalSlotSet]);

                        buildDayGrid();
                        updateSelectedMinutes();
                        renderLeftSummary();
                        updateModalSaveButton();
                    });
                });
            }
            window.addEventListener('mouseup', ()=>{ modalDragging=false; });
        }

        function openPrintPage() {
            const status = statusSelect.value;
            const weekStartIso = toIso(currentWeekStart);
            const slot = slotMinutes;

            const url = `/schedules/work/weekly/print?status=${encodeURIComponent(status)}&weekStart=${encodeURIComponent(weekStartIso)}&slot=${encodeURIComponent(slot)}`;
            window.open(url, '_blank');
        }

        function openPrintMemberPage() {
            if (!selectedMember) {
                alert('ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const weekStartIso = toIso(currentWeekStart);
            const slot = slotMinutes;

            const url =
                    `/schedules/work/weekly/print/individual` +
                    `?memberId=${encodeURIComponent(selectedMember.id)}` +
                    `&weekStart=${encodeURIComponent(weekStartIso)}` +
                    `&slot=${encodeURIComponent(slot)}`;

            window.open(url, '_blank');
        }

        function setSlotMinutes(mins){
            if (slotMinutes === mins) return;
            slotMinutes = mins;
            updateSlotButtons();
        }
        function updateSlotButtons(){
            [btnSlot10, btnSlot30, btnSlot60].forEach(btn=>{ if (!btn) return; btn.classList.remove('active'); });
            if (slotMinutes === 10 && btnSlot10) btnSlot10.classList.add('active');
            if (slotMinutes === 30 && btnSlot30) btnSlot30.classList.add('active');
            if (slotMinutes === 60 && btnSlot60) btnSlot60.classList.add('active');
        }

        async function handleStatusChange(){
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            if (selectedMember && !currentStatusMembers.some(x => String(x.id) === String(selectedMember.id))) {
                selectedMember = null;
            }

            renderMemberList(currentStatusMembers);
            renderWeekRangeLabel(currentWeekStart);

            if (currentStatusMembers.length === 0) {
                weekStaffTbody.innerHTML = '';
                noMemberState.classList.remove('d-none');
                timetableWrapper.classList.add('d-none');
                hideMemberWeekCard();
                clearAllDayEditButtons();
                return;
            }

            noMemberState.classList.add('d-none');
            timetableWrapper.classList.remove('d-none');

            if (!selectedMember) {
                selectedMember = currentStatusMembers[0];
            }
            updatePillActive();

            await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
            await loadSelectedMemberWeek();
            clearAllDayEditButtons();
            updateCurrentTimeHighlight();
        }

        function renderMemberList(members){
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if (members.length === 0) {
                memberList.innerHTML = `<span class="text-light small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                return;
            }

            members.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko')).forEach(m => {
                const color = colorForMember(m);
                const pill = document.createElement('button');
                pill.type = 'button';
                pill.className = 'pill';
                pill.dataset.memberId = String(m.id);
                pill.innerHTML = `
                <span class="dot" style="background:${color}"></span>
                <span class="name">${escapeHtml(m.name ?? '-')}</span>
                <span class="meta">${escapeHtml(m.phone ?? '')}</span>
            `;
                pill.addEventListener('click', async (evt) => {
                    evt.preventDefault();
                    evt.stopPropagation();
                    if (selectedMember && String(selectedMember.id) === String(m.id)) {
                        selectedMember = null;
                    } else {
                        selectedMember = m;
                    }
                    updatePillActive();
                    await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                    await loadSelectedMemberWeek();
                    clearAllDayEditButtons();
                    updateCurrentTimeHighlight();
                });
                memberList.appendChild(pill);
            });

            updatePillActive();
        }

        function updatePillActive(){
            const pills = memberList.querySelectorAll('.pill');
            pills.forEach(p => {
                if (!selectedMember) { p.classList.remove('active'); return; }
                const id = p.dataset.memberId;
                if (String(id) === String(selectedMember.id)) p.classList.add('active');
                else p.classList.remove('active');
            });

            if (selectedMember) {
                document.body.classList.add('alba-has-selected');
            } else {
                document.body.classList.remove('alba-has-selected');
            }
        }

        function renderWeekRangeLabel(weekStart){
            const weekEnd = addDays(weekStart, 6);

            const sY = weekStart.getFullYear();
            const sM = pad2(weekStart.getMonth()+1);
            const sD = pad2(weekStart.getDate());
            const eM = pad2(weekEnd.getMonth()+1);
            const eD = pad2(weekEnd.getDate());
            const label = `${sY}.${sM}.${sD} ~ ${eM}.${eD}`;

            if (weekRangeLabel) weekRangeLabel.textContent = label;
            if (weekRangeLabelRight) weekRangeLabelRight.textContent = label;

            if (dayHeaderCells && dayHeaderCells.length === 7) {
                const weekDates = [];
                for (let i=0; i<7; i++) {
                    const d = addDays(weekStart, i);
                    weekDates.push(toIso(d));

                    const mm = pad2(d.getMonth()+1);
                    const dd = pad2(d.getDate());
                    const cell = dayHeaderCells[i];
                    const dateSpan = cell.querySelector('.day-date');
                    if (dateSpan) dateSpan.textContent = `${mm}/${dd}`;

                    cell.classList.remove('today-col-head');
                }

                const today    = new Date();
                const todayIso = toIso(today);
                const todayIdx = weekDates.indexOf(todayIso);
                if (todayIdx !== -1) {
                    dayHeaderCells[todayIdx].classList.add('today-col-head');
                }
            }
        }

        async function fetchAndRenderWeekTable(members, weekStart){
            const weekEnd = addDays(weekStart, 6);
            const startIso = toIso(weekStart);
            const endIso   = toIso(weekEnd);

            const weekDatesForToday = Array.from({length:7}, (_,i)=> toIso(addDays(weekStart, i)));
            const today    = new Date();
            const todayIso = toIso(today);
            const todayIdx = weekDatesForToday.indexOf(todayIso);

            const totalStartMin = HOUR_START * 60;
            const totalEndMin   = HOUR_END * 60;
            const slots = [];
            for (let t = totalStartMin; t < totalEndMin; t += slotMinutes) {
                slots.push({ start: t, end: t + slotMinutes });
            }

            const slotData = slots.map(() => Array.from({length:7}, ()=> new Set()));

            try {
                await Promise.all(
                        members.map(async (m) => {
                            const url = `${API_BASE}/${encodeURIComponent(m.id)}/${startIso}/${endIso}`;
                            const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                            if (!resp.ok) { console.warn('[weekTable] fetch fail:', m.id, resp.status); return; }
                            const data = await resp.json().catch(()=>null);
                            const dayMap = normalizeDays(data);

                            const weekDates = Array.from({length:7}, (_,i)=> toIso(addDays(weekStart, i)));
                            weekDates.forEach((iso, dayIdx) => {
                                const day = dayMap[iso];
                                if (!day || !Array.isArray(day.segments)) return;

                                day.segments.forEach(seg => {
                                    const segStartMin = hmToMin(seg.start);
                                    const segEndMin   = hmToMin(seg.end);
                                    slots.forEach((slot, slotIdx) => {
                                        const slotStart = slot.start, slotEnd = slot.end;
                                        if (segEndMin <= slotStart || segStartMin >= slotEnd) return;
                                        slotData[slotIdx][dayIdx].add(m.id);
                                    });
                                });
                            });
                        })
                );
            } catch(e){ console.error('[weekTable] unexpected error:', e); }

            const rows = [];
            const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

            slots.forEach((slot, slotIdx)=>{
                const tr = document.createElement('tr');
                tr.dataset.rowIdx = String(slotIdx);

                if (slotMinutes === 60){
                    const hourFromStart = (slot.start/60) - HOUR_START;
                    if (hourFromStart % 3 === 0) tr.classList.add('hour-separator');
                } else {
                    if (slot.start % 60 === 0) tr.classList.add('hour-separator');
                }

                const h = Math.floor(slot.start / 60);
                const m = slot.start % 60;
                const th = document.createElement('th');
                th.scope = 'row';
                th.className = 'hour-row-header';
                th.textContent = `${pad2(h)}:${pad2(m)}`;
                tr.appendChild(th);

                let totalCount = 0;

                for (let dayIdx=0; dayIdx<7; dayIdx++){
                    const cell = document.createElement('td');
                    cell.className = 'staff-cell time-band-cell';
                    cell.dataset.dayIdx = String(dayIdx);

                    if (todayIdx !== -1 && dayIdx === todayIdx) cell.classList.add('today-col');

                    const inner = document.createElement('div');
                    inner.className = 'time-band-inner';

                    const memberIdSet = slotData[slotIdx][dayIdx];
                    const count = memberIdSet.size;
                    totalCount += count;

                    if (dayIdx === 0) {
                        cell.classList.add('time-band-left');
                    }

                    if (count === 0){
                        inner.innerHTML = `<span class="text-muted small">-</span>`;
                        cell.dataset.hasSelected = '0';
                    } else {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'staff-tags';

                        let hasSelected = false;
                        memberIdSet.forEach(memberId => {
                            const mObj = members.find(x => String(x.id) === String(memberId));
                            if (!mObj) return;
                            const color = colorForMember(mObj);
                            const tag = document.createElement('span');
                            tag.className = 'staff-tag';

                            if (selectedMember && String(mObj.id) === String(selectedMember.id)) {
                                tag.classList.add('selected-member-tag');
                                hasSelected = true;
                            }

                            tag.title = `${mObj.name || ''} (${DOW_LABELS[dayIdx]} ${pad2(h)}:${pad2(m)})`;
                            tag.innerHTML = `
                            <span class="staff-tag-dot" style="background:${color}"></span>
                            <span class="staff-tag-name">${escapeHtml(mObj.name ?? '-')}</span>
                        `;
                            tagsDiv.appendChild(tag);
                        });

                        cell.dataset.hasSelected = hasSelected ? '1' : '0';
                        inner.appendChild(tagsDiv);
                    }

                    cell.appendChild(inner);
                    tr.appendChild(cell);

                    const countTd = document.createElement('td');
                    countTd.className = 'day-count-cell time-band-cell';
                    if (todayIdx !== -1 && dayIdx === todayIdx) {
                        countTd.classList.add('today-col');
                    }
                    if (dayIdx === 6) {
                        countTd.classList.add('time-band-right');
                    }
                    const countInner = document.createElement('div');
                    countInner.className = 'time-band-inner';
                    countInner.textContent = count > 0 ? `${count}` : '';
                    countTd.appendChild(countInner);
                    tr.appendChild(countTd);
                }

                const tdTotal = document.createElement('td');
                tdTotal.className = 'staff-cell';
                tdTotal.style.padding = '.25rem .25rem';
                tdTotal.innerHTML = `<span class="staff-count">${totalCount}</span><span class="small text-muted">ëª…</span>`;
                tr.appendChild(tdTotal);

                rows.push(tr);
            });

            weekStaffTbody.innerHTML = '';
            rows.forEach(r => weekStaffTbody.appendChild(r));

            updateCurrentTimeHighlight();
        }

        function updateCurrentTimeHighlight(){
            if (!weekStaffTbody) return;
            const now = new Date();

            const weekDates = Array.from({length:7}, (_,i)=> toIso(addDays(currentWeekStart, i)));
            const todayIso = toIso(now);
            const todayIdx = weekDates.indexOf(todayIso);

            weekStaffTbody.querySelectorAll('.current-time-row').forEach(tr => tr.classList.remove('current-time-row'));
            weekStaffTbody.querySelectorAll('.staff-tag-current').forEach(el => el.classList.remove('staff-tag-current'));

            if (todayIdx === -1) return;

            const minutes = now.getHours()*60 + now.getMinutes();
            const startMin = HOUR_START*60;
            const endMin   = HOUR_END*60;
            if (minutes < startMin || minutes >= endMin) return;

            const idx = Math.floor((minutes - startMin) / slotMinutes);
            const row = weekStaffTbody.querySelector(`tr[data-row-idx="${idx}"]`);
            if (!row) return;

            row.classList.add('current-time-row');

            const todayCell = row.querySelector(`td.staff-cell[data-day-idx="${todayIdx}"]`);
            if (todayCell) {
                todayCell.querySelectorAll('.staff-tag').forEach(tag => {
                    tag.classList.add('staff-tag-current');
                });
            }
        }

        function showDayEditButton(dayIdx, iso){
            clearAllDayEditButtons();
            const head = document.querySelector(`#weekStaffTable thead th[data-dow="${dayIdx}"] .day-edit-wrap`);
            if (!head) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-light btn-sm day-edit-btn';
            btn.textContent = 'ê·¼ë¬´ì¼ì • ìˆ˜ì •';
            btn.dataset.dateIso = iso;
            btn.addEventListener('click', async ()=>{
                if (!selectedMember) return;
                let segs = (selectedWeekDaysMap[iso]?.segments) || [];
                if (!segs.length) {
                    try{
                        const resp = await fetch(`${API_BASE}/${encodeURIComponent(selectedMember.id)}/${iso}/${iso}`, { headers:{'Accept':'application/json'} });
                        if (resp.ok){
                            const data = await resp.json().catch(()=>null);
                            const map = normalizeDays(data);
                            segs = (map[iso]?.segments)||[];
                        }
                    }catch(e){ console.warn('single-day fetch fail', e); }
                }
                openEditModal(iso, selectedMember, segs, 'edit');
            });
            head.appendChild(btn);
        }

        function showDayCreateButton(dayIdx, iso){
            clearAllDayEditButtons();
            const head = document.querySelector(`#weekStaffTable thead th[data-dow="${dayIdx}"] .day-edit-wrap`);
            if (!head) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-light btn-sm day-edit-btn';
            btn.textContent = 'ì¼ì •ìƒì„±í•˜ê¸°';
            btn.dataset.dateIso = iso;
            btn.addEventListener('click', async ()=>{
                if (!selectedMember) return;
                let segs = (selectedWeekDaysMap[iso]?.segments) || [];
                if (!segs.length) {
                    try{
                        const resp = await fetch(`${API_BASE}/${encodeURIComponent(selectedMember.id)}/${iso}/${iso}`, { headers:{'Accept':'application/json'} });
                        if (resp.ok){
                            const data = await resp.json().catch(()=>null);
                            const map = normalizeDays(data);
                            segs = (map[iso]?.segments)||[];
                        }
                    }catch(e){ console.warn('single-day fetch fail', e); }
                }
                openEditModal(iso, selectedMember, segs, 'create');
            });
            head.appendChild(btn);
        }

        function clearAllDayEditButtons(){
            document.querySelectorAll('.day-edit-wrap').forEach(w => w.innerHTML = '');
        }

        async function loadSelectedMemberWeek(){
            if (!selectedMember) {
                hideMemberWeekCard();
                return;
            }
            const weekStart = currentWeekStart;
            const weekEnd   = addDays(weekStart, 6);
            const startIso  = toIso(weekStart);

            memberWeekCard.classList.remove('d-none');
            memberWeekNameBadge.textContent = selectedMember.name || '-';
            memberWeekTitle.textContent = `ê°œë³„ ì£¼ê°„ ì¼ì • (${startIso} ~ ${toIso(weekEnd)})`;

            try {
                const url = `${API_BASE}/${encodeURIComponent(selectedMember.id)}/${startIso}/${toIso(weekEnd)}`;
                const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                if (!resp.ok) {
                    console.warn('[memberWeek] fetch fail:', selectedMember.id, resp.status);
                    selectedWeekDaysMap = {};
                } else {
                    const data = await resp.json().catch(()=>null);
                    selectedWeekDaysMap = normalizeDays(data) || {};
                }
            } catch (e) {
                console.error('[memberWeek] unexpected error:', e);
                selectedWeekDaysMap = {};
            }

            updateNoPlanAlert(selectedWeekDaysMap);
            buildMemberWeekGrid();
            hydrateGridFromDayMap(selectedWeekDaysMap);
            updateSaveButtonState();
        }

        function hideMemberWeekCard(){ memberWeekCard.classList.add('d-none'); }

        function buildMemberWeekGrid(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.innerHTML = '';

            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;

            for (let idx=0; idx<totalRows; idx++){
                const tMin = START_MIN + idx * gridStepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m % 30 === 0) ? hmLabel : '';
                tr.appendChild(th);

                for (let dayOffset=0; dayOffset<7; dayOffset++){
                    const td = document.createElement('td');
                    const div = document.createElement('div');
                    div.className = 'slot-10m';
                    div.dataset.dayOffset = String(dayOffset);
                    div.dataset.idx = String(idx);
                    td.appendChild(div);
                    tr.appendChild(td);
                }

                memberWeekGridBody.appendChild(tr);
            }

            attachMemberGridDragHandlers();
        }

        let gridDragging = false;
        let gridDragAdding = true;

        function attachMemberGridDragHandlers(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.querySelectorAll('.slot-10m').forEach(div => {
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    gridDragging = true;
                    gridDragAdding = !div.classList.contains('selected');
                    toggleGridSlot(div, gridDragAdding);
                });
                div.addEventListener('mouseenter', () => {
                    if (!gridDragging) return;
                    toggleGridSlot(div, gridDragAdding);
                });
            });
            window.addEventListener('mouseup', () => { if (gridDragging){ gridDragging = false; } });
        }
        function toggleGridSlot(el, on) { if (on) el.classList.add('selected'); else el.classList.remove('selected'); }

        function updateNoPlanAlert(dayMap){
            const hasAny = hasAnySegments(dayMap);
            if (noPlanAlert) noPlanAlert.classList.toggle('d-none', hasAny);
        }

        function hydrateGridFromDayMap(dayMap){
            if (!memberWeekGridBody) return;

            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;
            memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));

            const weekStart = currentWeekStart;

            for (let offset=0; offset<7; offset++){
                const date = addDays(weekStart, offset);
                const iso  = toIso(date);
                const segments = (dayMap[iso]?.segments) || [];
                if (!segments.length) continue;

                segments.forEach(seg => {
                    const segStartMin = hmToMin(seg.start);
                    const segEndMin   = hmToMin(seg.end);
                    const a = Math.max(START_MIN, segStartMin);
                    const b = Math.min(END_MIN,   segEndMin);
                    if (a >= b) return;

                    const sIdx = Math.floor((a - START_MIN)/gridStepMinutes);
                    const eIdx = Math.ceil((b - START_MIN)/gridStepMinutes) - 1;

                    for (let idx = Math.max(0,sIdx); idx <= Math.min(totalRows-1, eIdx); idx++){
                        const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${offset}"][data-idx="${idx}"]`);
                        if (slot) slot.classList.add('selected');
                    }
                });
            }
        }

        function mergeConsecutive(arr){
            const out=[]; if(!arr.length) return out;
            arr.sort((a,b)=>a-b);
            let s=arr[0], p=arr[0];
            for(let i=1;i<arr.length;i++){
                if(arr[i]===p+1){ p=arr[i]; continue; }
                out.push([s,p]); s=p=arr[i];
            }
            out.push([s,p]);
            return out;
        }

        function collectSegmentsByDateFromGrid(){
            if (!memberWeekGridBody) return {};
            const res = {};
            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;
            const weekStart = currentWeekStart;

            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const iso = toIso(addDays(weekStart, dayOffset));
                const indexes = [];
                for (let idx=0; idx<totalRows; idx++){
                    const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${dayOffset}"][data-idx="${idx}"]`);
                    if (slot && slot.classList.contains('selected')) indexes.push(idx);
                }
                const merged = mergeConsecutive(indexes);
                if (!merged.length) continue;

                res[iso] = merged.map(([sIdx,eIdxInclusive]) => {
                    const stMin = START_MIN + sIdx*gridStepMinutes;
                    const edMin = START_MIN + (eIdxInclusive+1)*gridStepMinutes;
                    return { start: minToHm(stMin), end: minToHm(edMin) };
                });
            }
            return res;
        }

        function updateSaveButtonState(){
            if (!btnSaveWeek) return;
            const enable = (gridStepMinutes === 10);
            btnSaveWeek.disabled = !enable;
            btnSaveWeek.title = enable ? '' : 'ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            document.getElementById('memberWeekSaveHint').classList.toggle('text-danger', !enable);
        }

        async function onSubmitWeekForm(e){
            e.preventDefault();
            if (!selectedMember) { alert('ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
            if (gridStepMinutes !== 10) { alert('ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê·¸ë¦¬ë“œ ë‹¨ìœ„ë¥¼ 10ë¶„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”)'); return; }

            const byDate = collectSegmentsByDateFromGrid();
            const weekStart = currentWeekStart;

            let summaryLines = [];
            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const date = addDays(weekStart, dayOffset);
                const iso  = toIso(date);
                const label = `${GRID_DAY_LABELS[dayOffset]} (${iso})`;
                const segs  = byDate[iso] || [];
                summaryLines.push(!segs.length ? `${label}: íœ´ë¬´` : `${label}: ${segs.map(s => `${s.start}~${s.end}`).join(', ')}`);
            }

            const ok = confirm(`ë‹¤ìŒê³¼ ê°™ì´ ì£¼ê°„ ê·¼ë¬´ì‹œê°„ì„ ì €ì¥í•©ë‹ˆë‹¤:\n\n${summaryLines.join('\n')}\n\nì´ëŒ€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!ok) return;

            const dates = [];
            for (let offset=0; offset<7; offset++){ dates.push(toIso(addDays(weekStart, offset))); }

            try {
                for (const iso of dates){
                    const segments = byDate[iso] || [];
                    const payload = { memberId: selectedMember.id, date: iso, segments };
                    const resp = await fetch(API_UPDATE, {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) {
                        const txt = await resp.text().catch(()=> '');
                        alert(`ì €ì¥ ì‹¤íŒ¨ (${iso}): ${resp.status} ${txt}`);
                        return;
                    }
                }

                alert('í•´ë‹¹ ì£¼ê°„ ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                await loadSelectedMemberWeek();
                clearAllDayEditButtons();
                updateCurrentTimeHighlight();
            } catch (e) {
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        let modalDragging = false, modalDragAdding = true;

        function openEditModal(dateIso, member, segments, mode='edit'){
            if(!member) return;
            modalMode = mode === 'create' ? 'create' : 'edit';
            editTitleDate.textContent = dateIso;
            editTitleMember.textContent = member.name ?? '-';

            btnSaveEdit.textContent = (modalMode === 'create') ? 'ì¼ì •ìƒì„±í•˜ê¸°' : 'ì €ì¥';

            stepMinutes = 30;
            totalRows = (END_MIN - START_MIN) / stepMinutes;
            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
            slotStepButtons.querySelector('button[data-step="30"]').classList.add('active');
            summaryStepBadge.textContent = 'ìŠ¬ë¡¯: 30ë¶„';

            originalSegments = Array.isArray(segments) ? segments.slice() : [];
            originalSlotSet  = segmentsToSlotSet(originalSegments, stepMinutes);
            slotState        = new Set([...originalSlotSet]);

            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
            updateModalSaveButton();

            editModal.dataset.memberId = String(member.id);
            editModal.dataset.dateIso = dateIso;

            editModal.style.display = 'block';
        }
        function closeEditModal(){ editModal.style.display = 'none'; }
        function onCancelEdit(){
            slotState = new Set([...originalSlotSet]);
            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
        }
        async function onSaveEdit(){
            if(stepMinutes !== 10){
                alert('ì €ì¥ì€ 10ë¶„ ë‹¨ìœ„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            const mid = editModal.dataset.memberId;
            const dateIso = editModal.dataset.dateIso;
            if(!mid || !dateIso) return;

            const segments = slotSetToSegments(slotState, stepMinutes);
            try{
                const body = { memberId: mid, date: dateIso, segments };
                const resp = await fetch(API_UPDATE, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Accept':'application/json'},
                    body: JSON.stringify(body)
                });
                if(!resp.ok){
                    const text = await resp.text().catch(()=> '');
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${resp.status} ${text}`);
                    return;
                }
                closeEditModal();
                await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                await loadSelectedMemberWeek();
                clearAllDayEditButtons();
                updateCurrentTimeHighlight();
            }catch(e){
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        function updateModalSaveButton(){ btnSaveEdit.disabled = (stepMinutes !== 10); }

        function buildDayGrid(){
            dayGridBody.innerHTML = '';
            const rows = (END_MIN - START_MIN) / stepMinutes;
            for(let idx=0; idx<rows; idx++){
                const tMin = START_MIN + idx*stepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m%30===0) ? hmLabel : '';
                tr.appendChild(th);

                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = 'slot-cell';
                div.dataset.hm = hmLabel;

                if(slotState.has(hmLabel)){
                    div.classList.add('selected');
                    if(!originalSlotSet.has(hmLabel)){
                        div.classList.add('selected-diff');
                    }
                }
                td.appendChild(div);
                tr.appendChild(td);
                dayGridBody.appendChild(tr);
            }
            attachDayGridDragHandlers();
        }

        function attachDayGridDragHandlers(){
            modalDragging = false;
            dayGridBody.querySelectorAll('.slot-cell').forEach(div=>{
                div.addEventListener('mousedown', (e)=>{
                    e.preventDefault();
                    modalDragging = true;
                    const hm = div.dataset.hm;
                    const has = slotState.has(hm);
                    modalDragAdding = !has;
                    toggleModalSlot(div, modalDragAdding);
                });
                div.addEventListener('mouseenter', ()=>{
                    if(!modalDragging) return;
                    toggleModalSlot(div, modalDragAdding);
                });
            });
            window.addEventListener('mouseup', ()=>{ if(modalDragging) modalDragging=false; });
        }

        function toggleModalSlot(el, on){
            const hm = el.dataset.hm;
            if(on){
                if(!slotState.has(hm)){
                    slotState.add(hm);
                    el.classList.add('selected');
                    if(!originalSlotSet.has(hm)) el.classList.add('selected-diff');
                }
            }else{
                if(slotState.has(hm)){
                    slotState.delete(hm);
                    el.classList.remove('selected','selected-diff');
                }
            }
            updateSelectedMinutes();
            renderLeftSummary();
        }
        function updateSelectedMinutes(){ selectedMinutesEl.textContent = (slotState.size * stepMinutes)|0; }

        function renderLeftSummary(){
            summaryOriginal.innerHTML = originalSegments.length
                    ? originalSegments.map(s => chipHtml('#198754', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const currentSegments = slotSetToSegments(slotState, stepMinutes);
            summaryCurrent.innerHTML = currentSegments.length
                    ? currentSegments.map(s => chipHtml('#0d6efd', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const orgMin = segmentsMinutes(originalSegments);
            const curMin = segmentsMinutes(currentSegments);
            summaryOriginalTotal.textContent = `${orgMin}ë¶„`;
            summaryCurrentTotal.textContent  = `${curMin}ë¶„`;
            const diff = curMin - orgMin;
            summaryDiffTotal.textContent = (diff>=0?'+':'') + `${diff}ë¶„`;
            summaryDiffTotal.classList.toggle('text-primary', diff>0);
            summaryDiffTotal.classList.toggle('text-danger', diff<0);
        }

        // ===== Utils =====
        function toMonday(date){
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            return d;
        }
        function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        function normalizeDays(apiData){
            const map = {};
            if (!apiData) return map;

            if (Array.isArray(apiData.days)) {
                apiData.days.forEach(d => {
                    const date = String(d.date);
                    const segments = Array.isArray(d.segments) ? d.segments : [];
                    const minutes = (typeof d.minutes === 'number') ? d.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[date] = { segments, minutes };
                });
                return map;
            }
            if (Array.isArray(apiData)) {
                apiData.forEach(d => {
                    const date = String(d.date);
                    const segments = Array.isArray(d.segments) ? d.segments : [];
                    const minutes = (typeof d.minutes === 'number') ? d.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[date] = { segments, minutes };
                });
                return map;
            }
            if (typeof apiData === 'object') {
                Object.keys(apiData).forEach(date => {
                    const v = apiData[date] || {};
                    const segments = Array.isArray(v.segments) ? v.segments : [];
                    const minutes = (typeof v.minutes === 'number') ? v.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[String(date)] = { segments, minutes };
                });
                return map;
            }
            return map;
        }

        function hasAnySegments(dayMap){
            return Object.values(dayMap || {}).some(v => Array.isArray(v.segments) && v.segments.length > 0);
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const [h,m] = String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60 + (m||0);
        }
        function minToHm(min){ const h = Math.floor(min/60); const m = min%60; return `${pad2(h)}:${pad2(m)}`; }

        function colorForMember(m){
            const key = (m?.id!=null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        function segmentsToSlotSet(segments, step){
            const set = new Set();
            (segments||[]).forEach(seg=>{
                let s = Math.max(hmToMin(seg.start), START_MIN);
                let e = Math.min(hmToMin(seg.end),   END_MIN);
                for(let t=s; t<e; t+=step){ set.add(minToHm(t)); }
            });
            return set;
        }
        function slotSetToSegments(set, step){
            const sorted = Array.from(set).map(hmToMin).sort((a,b)=>a-b);
            const res = [];
            let i=0;
            while(i<sorted.length){
                let s = sorted[i], t = s + step; i++;
                while(i<sorted.length && sorted[i]===t){ t += step; i++; }
                res.push({start:minToHm(s), end:minToHm(t)});
            }
            return res;
        }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="dot" style="background:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function segmentsMinutes(segs){ return (segs||[]).reduce((acc,s)=> acc + (hmToMin(s.end)-hmToMin(s.start)), 0); }

    })();
</script>

{{>layouts/footer}}
