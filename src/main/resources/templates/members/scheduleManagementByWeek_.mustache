{{>layouts/header}}

<main class="container my-4">
    <!-- ìƒë‹¨: ìƒíƒœ ì„ íƒ + í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</div>
            <div class="small text-muted">
                <span id="weekRangeLabel"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label small text-muted" for="statusSelect">ìƒíƒœ</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>
                    <div class="form-text">ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì•„ë˜ ë¦¬ìŠ¤íŠ¸ì™€ íƒ€ì„í…Œì´ë¸”ì´ í•¨ê»˜ ë°”ë€ë‹ˆë‹¤.</div>
                </div>
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ</span>
                        <span id="memberCountBadge" class="badge bg-secondary">0ëª…</span>
                    </div>
                    <div id="memberList" class="vlist"></div>
                    <div class="small text-muted mt-2">
                        * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ í•´ë‹¹ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤. (ì•„ë˜ íƒ€ì„í…Œì´ë¸”ì—ë„ ë™ì¼ ìƒ‰ ì‚¬ìš©)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (10/30/60ë¶„ ë‹¨ìœ„ + ì§€ë‚œ/ê¸ˆ/ë‹¤ìŒì£¼) -->
    <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
                <span>ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</span>
                <div class="mt-1 btn-group btn-group-sm" role="group" aria-label="ë‹¨ìœ„ ì„ íƒ">
                    <button type="button" id="btnSlot10" class="btn btn-sm btn-outline-secondary">10ë¶„</button>
                    <button type="button" id="btnSlot30" class="btn btn-sm btn-outline-secondary">30ë¶„</button>
                    <button type="button" id="btnSlot60" class="btn btn-sm btn-outline-secondary active">1ì‹œê°„</button>
                </div>
                <span class="small text-muted mt-1">í•œ ì¹¸ = ì„ íƒëœ ë‹¨ìœ„, ë§ˆì§€ë§‰ ì—´ì€ ì „ì²´ ì¸ì›ìˆ˜</span>
            </div>

            <!-- ìš°ì¸¡: ì§€ë‚œì£¼ / [ë‚ ì§œë²”ìœ„] / ê¸ˆì£¼ / ë‹¤ìŒì£¼ -->
            <div class="d-flex align-items-center gap-2">
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-secondary">â—€ ì§€ë‚œì£¼</button>
                <span id="weekRangeLabelRight" class="small text-muted px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-secondary">ê¸ˆì£¼</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-secondary">ë‹¤ìŒì£¼ â–¶</button>
            </div>
        </div>
        <div class="card-body">
            <div id="noMemberState" class="text-muted small d-none">
                í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <div id="timetableWrapper" class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weekStaffTable">
                    <thead class="table-light">
                    <tr>
                        <th style="width:80px;">ì‹œê°„</th>
                        <!-- data-dow: 0=ì›”, 1=í™”, ... 6=ì¼ -->
                        <th data-dow="0">
                            <div>ì›”</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="1">
                            <div>í™”</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="2">
                            <div>ìˆ˜</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="3">
                            <div>ëª©</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="4">
                            <div>ê¸ˆ</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="5">
                            <div>í† </div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th data-dow="6">
                            <div>ì¼</div>
                            <div class="small text-muted day-date"></div>
                        </th>
                        <th style="width:80px;">í•©ê³„</th>
                    </tr>
                    </thead>
                    <tbody id="weekStaffTbody">
                    <!-- JS ë Œë” -->
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">
                * ê° ì¹¸ì—ëŠ” í•´ë‹¹ ì‹œê°„ëŒ€ì— ê·¼ë¬´ ì¤‘ì¸ ì¸ì› ìˆ˜ì™€, ê° ê·¼ë¡œìì˜ ìƒ‰ìƒ íƒœê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ë‹¨ìœ„ ë²„íŠ¼(10ë¶„/30ë¶„/1ì‹œê°„)ì— ë”°ë¼ íƒ€ì„í…Œì´ë¸” í–‰ì´ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ ê°œë³„ ì£¼ê°„ ì¼ì • (í•˜ë‹¨) -->
    <div class="card mt-3 d-none" id="memberWeekCard">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <span class="fw-bold" id="memberWeekTitle">ê°œë³„ ì£¼ê°„ ì¼ì •</span>
                <span class="badge bg-secondary ms-2" id="memberWeekNameBadge"></span>
            </div>
            <!-- ì €ì¥ ë²„íŠ¼ -->
            <button type="submit" class="btn btn-sm btn-primary" form="memberWeekForm">ì €ì¥</button>
        </div>
        <div class="card-body">
            <!-- ìˆ˜ì •ìš© íƒ€ì„í…Œì´ë¸” (ì£¼ê°„ ê·¸ë¦¬ë“œ) -->
            <form id="memberWeekForm" class="mt-0">
                <!-- íˆ´ë°” -->
                <div class="grid-toolbar mb-2">
                    <div class="left">
                        <div class="btn-group btn-group-sm" id="gridSlotButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„ ì„ íƒ">
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="10">10ë¶„</button>
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30ë¶„</button>
                            <button type="button" class="btn btn-outline-secondary active" data-grid-slot="60">1ì‹œê°„</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="btnGridClearAll">ì „ì²´ ì´ˆê¸°í™”</button>
                    </div>
                    <div class="right small text-muted">
                        ì‹œê°„ ìŠ¬ë¡¯ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒ/í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (06:00 ~ 22:00)
                    </div>
                </div>

                <!-- ì£¼ê°„ ê·¸ë¦¬ë“œ -->
                <div class="week-grid mb-0">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:74px;">ì‹œê°„</th>
                            <th data-day-offset="0">ì›”</th>
                            <th data-day-offset="1">í™”</th>
                            <th data-day-offset="2">ìˆ˜</th>
                            <th data-day-offset="3">ëª©</th>
                            <th data-day-offset="4">ê¸ˆ</th>
                            <th data-day-offset="5">í† </th>
                            <th data-day-offset="6">ì¼</th>
                        </tr>
                        </thead>
                        <tbody id="memberWeekGridBody">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
</main>

<style>
    /* ===== ìƒë‹¨ ë¦¬ìŠ¤íŠ¸ ===== */
    .vlist {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:#6c757d; font-size:.8rem; }
    .pill.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ===== íƒ€ì„í…Œì´ë¸” ===== */
    #weekStaffTable {
        border-collapse: separate;
        border-spacing: 0;
    }

    .hour-row-header {
        font-variant-numeric: tabular-nums;
    }
    .staff-cell {
        vertical-align: middle;
        font-size:.85rem;
        transition: background-color .15s ease, box-shadow .15s ease;
    }
    .staff-tags {
        display:flex;
        flex-wrap:wrap;
        gap:4px;
        justify-content:center;
    }
    .staff-tag {
        display:inline-flex;
        align-items:center;
        gap:4px;
        border-radius:999px;
        padding:2px 6px;
        font-size:.75rem;
        background:#f8f9fa;
        border:1px solid #dee2e6;
        max-width:90px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        transition: background-color .15s ease, border-color .15s ease, transform .1s ease;
    }
    .staff-tag-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 10px;
    }
    .staff-count {
        font-weight:600;
        font-size:.9rem;
    }
    tr.hour-separator > td,
    tr.hour-separator > th {
        border-top:2px solid #dee2e6 !important;
    }

    .day-date {
        line-height: 1.1;
    }

    /* ì˜¤ëŠ˜ ì»¬ëŸ¼: ë…¹ìƒ‰ ì™¸ê³½ì„  + ëª¨ì„œë¦¬ ë¼ìš´ë“œ + í›¨ì”¬ ì—°í•œ ë°°ê²½ */
    #weekStaffTable .today-col {
        background-color: rgba(40,167,69,0.02);  /* ğŸ”§ 0.04 â†’ 0.02 */
        border-left: 2px solid #28a745 !important;
        border-right: 2px solid #28a745 !important;
    }
    #weekStaffTable thead .today-col {
        border-top: 2px solid #28a745 !important;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    #weekStaffTable tbody tr:last-child .today-col {
        border-bottom: 2px solid #28a745 !important;
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
    }

    /* âœ… ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ ê·¼ë¬´ ìŠ¬ë¡¯: ë¼ìš´ë“œ ë ‰íŠ¸ì•µê¸€ ëŠë‚Œ */
    .staff-cell.selected-member-cell {
        position: relative;
        background-color: #e7f1ff !important;
        box-shadow: inset 0 0 0 1px rgba(13,110,253,.25);
        border-radius: 8px;                /* ğŸ”§ ë‘¥ê·¼ ì‚¬ê°í˜• */
        padding-top: 4px;
        padding-bottom: 4px;
    }

    .staff-tag.selected-member-tag {
        background: rgba(13,110,253,.10);
        border-color: rgba(13,110,253,.7);
        font-weight: 600;
        transform: scale(1.02);
    }

    /* ê°œë³„ ì£¼ê°„ ì¼ì • ì¹´ë“œ */
    #memberWeekCard .table-sm td,
    #memberWeekCard .table-sm th {
        padding: .35rem .5rem;
    }

    /* ì£¼ê°„ ê·¸ë¦¬ë“œ */
    .week-grid {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        user-select: none;
        background:#fff;
    }
    .week-grid table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
    }
    .week-grid thead th {
        background: #f8fafc;
        color:#64748b;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: center;
        padding: .5rem .4rem;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    .week-grid tbody th {
        background: #fafafa;
        color:#6b7280;
        font-weight: 600;
        width: 74px;
        border-right: 1px solid #e5e7eb;
        text-align: center;
        padding: .25rem .25rem;
        font-size: .8rem;
        position: sticky;
        left: 0;
        z-index: 1;
    }

    /* âœ… ê°œë³„ ì£¼ê°„ ì¼ì •ì˜ ì„ íƒ ë°•ìŠ¤: ë¼ìš´ë“œ ë ‰íŠ¸ì•µê¸€ */
    .slot-10m {
        border-bottom: 1px dashed #eef2f6;
        border-right: 1px dashed #eef2f6;
        height: 18px;
        cursor: pointer;
        background: #ffffff;
        border-radius: 6px;   /* ë‘¥ê·¼ ì‚¬ê°í˜• */
        margin: 1px 0;
    }
    .slot-10m:hover {
        background: #f8fbff;
    }
    .slot-10m.selected {
        background: rgba(25,135,84,.18);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,.25);
    }

    .row-hour-start td, .row-hour-start th {
        border-top: 2px solid #e5e7eb !important;
    }
    .timecell { font-variant-numeric: tabular-nums; }

    .grid-toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: .5rem;
        font-size: .85rem;
    }
    .grid-toolbar .left,
    .grid-toolbar .right {
        display: flex;
        gap: 8px;
        align-items: center;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const API_BASE   = '/api/schedule/work';           // GET /{memberId}/{start}/{end}
        const API_UPDATE = '/api/schedule/work/update';    // POST { memberId, date, segments[] }
        const HOUR_START = 6;
        const HOUR_END   = 22;

        // DOM
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');

        const noMemberState    = document.getElementById('noMemberState');
        const timetableWrapper = document.getElementById('timetableWrapper');
        const weekStaffTbody   = document.getElementById('weekStaffTbody');
        const dayHeaderCells   = document.querySelectorAll('#weekStaffTable thead th[data-dow]');

        const btnSlot10 = document.getElementById('btnSlot10');
        const btnSlot30 = document.getElementById('btnSlot30');
        const btnSlot60 = document.getElementById('btnSlot60');

        const btnPrevWeek = document.getElementById('btnPrevWeek');
        const btnThisWeek = document.getElementById('btnThisWeek');
        const btnNextWeek = document.getElementById('btnNextWeek');

        const memberWeekCard      = document.getElementById('memberWeekCard');
        const memberWeekTitle     = document.getElementById('memberWeekTitle');
        const memberWeekNameBadge = document.getElementById('memberWeekNameBadge');
        const memberWeekForm      = document.getElementById('memberWeekForm');

        const memberWeekGridBody      = document.getElementById('memberWeekGridBody');
        const gridSlotButtonsWrapper  = document.getElementById('gridSlotButtons');
        const btnGridClearAll         = document.getElementById('btnGridClearAll');

        let allMembers = [];
        let currentStatusMembers = [];
        let currentWeekStart = toMonday(new Date());
        let selectedMember = null;
        let selectedWeekDaysMap = {};

        let slotMinutes = 60;     // ë©”ì¸ í…Œì´ë¸” ë‹¨ìœ„
        let gridStepMinutes = 60; // í•˜ë‹¨ ê°œì¸ ê·¸ë¦¬ë“œ ë‹¨ìœ„ (ê¸°ë³¸ 1ì‹œê°„)
        const GRID_DAY_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e){
            allMembers = [];
        }

        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        attachHandlers();
        handleStatusChange();

        function attachHandlers(){
            statusSelect.addEventListener('change', handleStatusChange);

            if (btnSlot10) btnSlot10.addEventListener('click', ()=> setSlotMinutes(10));
            if (btnSlot30) btnSlot30.addEventListener('click', ()=> setSlotMinutes(30));
            if (btnSlot60) btnSlot60.addEventListener('click', ()=> setSlotMinutes(60));

            if (btnPrevWeek) btnPrevWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, -7);
                handleStatusChange();
            });
            if (btnThisWeek) btnThisWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = toMonday(new Date());
                handleStatusChange();
            });
            if (btnNextWeek) btnNextWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, +7);
                handleStatusChange();
            });

            updateSlotButtons();

            if (gridSlotButtonsWrapper) {
                gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mins = parseInt(btn.dataset.gridSlot, 10);
                        if (!mins || gridStepMinutes === mins) {
                            gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            return;
                        }
                        gridStepMinutes = mins;
                        gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        buildMemberWeekGrid();
                        hydrateGridFromDayMap(selectedWeekDaysMap);
                    });
                });
            }

            if (btnGridClearAll) {
                btnGridClearAll.addEventListener('click', () => {
                    if (!memberWeekGridBody) return;
                    memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));
                });
            }

            if (memberWeekForm) {
                memberWeekForm.addEventListener('submit', onSubmitWeekForm);
            }
        }

        /* ===== ë©”ì¸ ì£¼ê°„ íƒ€ì„í…Œì´ë¸” ìŠ¬ë¡¯ ë‹¨ìœ„ ===== */
        function setSlotMinutes(mins){
            if (slotMinutes === mins) return;
            slotMinutes = mins;
            updateSlotButtons();
            if (currentStatusMembers.length > 0) {
                fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
            }
        }
        function updateSlotButtons(){
            [btnSlot10, btnSlot30, btnSlot60].forEach(btn=>{
                if (!btn) return;
                btn.classList.remove('active');
            });
            if (slotMinutes === 10 && btnSlot10) btnSlot10.classList.add('active');
            if (slotMinutes === 30 && btnSlot30) btnSlot30.classList.add('active');
            if (slotMinutes === 60 && btnSlot60) btnSlot60.classList.add('active');
        }

        /* ===== ìƒíƒœ ë³€ê²½ ===== */
        function handleStatusChange(){
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            if (selectedMember && !currentStatusMembers.some(x => String(x.id) === String(selectedMember.id))) {
                selectedMember = null;
            }

            renderMemberList(currentStatusMembers);
            renderWeekRangeLabel(currentWeekStart);

            if (currentStatusMembers.length === 0) {
                weekStaffTbody.innerHTML = '';
                noMemberState.classList.remove('d-none');
                timetableWrapper.classList.add('d-none');
                hideMemberWeekCard();
                return;
            }

            noMemberState.classList.add('d-none');
            timetableWrapper.classList.remove('d-none');

            if (!selectedMember) {
                selectedMember = currentStatusMembers[0];
            }
            updatePillActive();

            fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
            loadSelectedMemberWeek();
        }

        /* ===== ìƒë‹¨ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ===== */
        function renderMemberList(members){
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if (members.length === 0) {
                memberList.innerHTML =
                        `<span class="text-muted small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const color = colorForMember(m);
                        const pill = document.createElement('div');
                        pill.className = 'pill';
                        pill.dataset.memberId = String(m.id);
                        pill.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        pill.addEventListener('click', () => {
                            selectedMember = m;
                            updatePillActive();
                            fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                            loadSelectedMemberWeek();
                        });
                        memberList.appendChild(pill);
                    });

            updatePillActive();
        }

        function updatePillActive(){
            const pills = memberList.querySelectorAll('.pill');
            pills.forEach(p => {
                if (!selectedMember) {
                    p.classList.remove('active');
                    return;
                }
                const id = p.dataset.memberId;
                if (String(id) === String(selectedMember.id)) p.classList.add('active');
                else p.classList.remove('active');
            });
        }

        /* ===== ì£¼ê°„ ë²”ìœ„ ë¼ë²¨ ===== */
        function renderWeekRangeLabel(weekStart){
            const weekEnd = addDays(weekStart, 6);

            const sY = weekStart.getFullYear();
            const sM = pad2(weekStart.getMonth()+1);
            const sD = pad2(weekStart.getDate());
            const eM = pad2(weekEnd.getMonth()+1);
            const eD = pad2(weekEnd.getDate());
            const label = `${sY}.${sM}.${sD} ~ ${eM}.${eD}`;

            if (weekRangeLabel) {
                weekRangeLabel.textContent = label;
            }
            if (weekRangeLabelRight) {
                weekRangeLabelRight.textContent = label;
            }

            if (dayHeaderCells && dayHeaderCells.length === 7) {
                const weekDates = [];
                for (let i=0; i<7; i++) {
                    const d = addDays(weekStart, i);
                    weekDates.push(toIso(d));

                    const mm = pad2(d.getMonth()+1);
                    const dd = pad2(d.getDate());
                    const cell = dayHeaderCells[i];
                    const dateSpan = cell.querySelector('.day-date');
                    if (dateSpan) {
                        dateSpan.textContent = `${mm}/${dd}`;
                    }
                    cell.classList.remove('today-col');
                }

                const today    = new Date();
                const todayIso = toIso(today);
                const todayIdx = weekDates.indexOf(todayIso);

                if (todayIdx !== -1) {
                    dayHeaderCells[todayIdx].classList.add('today-col');
                }
            }
        }

        /* ===== ë©”ì¸ ì£¼ê°„ íƒ€ì„í…Œì´ë¸” ë Œë” ===== */
        async function fetchAndRenderWeekTable(members, weekStart){
            const weekEnd = addDays(weekStart, 6);
            const startIso = toIso(weekStart);
            const endIso   = toIso(weekEnd);

            const weekDatesForToday = Array.from(
                    {length:7},
                    (_,i)=> toIso(addDays(weekStart, i))
            );
            const today    = new Date();
            const todayIso = toIso(today);
            const todayIdx = weekDatesForToday.indexOf(todayIso);

            const totalStartMin = HOUR_START * 60;
            const totalEndMin   = HOUR_END * 60;
            const slots = [];
            for (let t = totalStartMin; t < totalEndMin; t += slotMinutes) {
                slots.push({ start: t, end: t + slotMinutes });
            }

            const slotData = slots.map(
                    ()=> Array.from({length:7}, ()=> new Set())
            );

            try {
                await Promise.all(
                        members.map(async (m) => {
                            const url = `${API_BASE}/${encodeURIComponent(m.id)}/${startIso}/${endIso}`;
                            const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                            if (!resp.ok) return;
                            const data = await resp.json();
                            const dayMap = normalizeDays(data);
                            const weekDates = Array.from(
                                    {length:7},
                                    (_,i)=> toIso(addDays(weekStart, i))
                            );

                            weekDates.forEach((iso, dayIdx) => {
                                const day = dayMap[iso];
                                if (!day || !Array.isArray(day.segments)) return;

                                day.segments.forEach(seg => {
                                    const segStartMin = hmToMin(seg.start);
                                    const segEndMin   = hmToMin(seg.end);

                                    slots.forEach((slot, slotIdx) => {
                                        const slotStart = slot.start;
                                        const slotEnd   = slot.end;
                                        if (segEndMin <= slotStart || segStartMin >= slotEnd) return;
                                        slotData[slotIdx][dayIdx].add(m.id);
                                    });
                                });
                            });
                        })
                );
            } catch(e){
                console.error(e);
            }

            const rows = [];
            const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

            slots.forEach((slot, slotIdx)=>{
                const tr = document.createElement('tr');

                if (slotMinutes === 60){
                    const hourFromStart = (slot.start/60) - HOUR_START;
                    if (hourFromStart % 3 === 0) tr.classList.add('hour-separator');
                } else {
                    if (slot.start % 60 === 0) tr.classList.add('hour-separator');
                }

                const h = Math.floor(slot.start / 60);
                const m = slot.start % 60;
                const th = document.createElement('th');
                th.scope = 'row';
                th.className = 'hour-row-header';
                th.textContent = `${pad2(h)}:${pad2(m)}`;
                tr.appendChild(th);

                let totalCount = 0;

                for (let dayIdx=0; dayIdx<7; dayIdx++){
                    const cell = document.createElement('td');
                    cell.className = 'staff-cell';

                    if (todayIdx !== -1 && dayIdx === todayIdx) {
                        cell.classList.add('today-col');
                    }

                    const memberIdSet = slotData[slotIdx][dayIdx];
                    const count = memberIdSet.size;
                    totalCount += count;

                    if (count === 0){
                        cell.innerHTML = `<span class="text-muted small">-</span>`;
                    } else {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'staff-tags';

                        let hasSelected = false;

                        memberIdSet.forEach(memberId => {
                            const mObj = members.find(x => String(x.id) === String(memberId));
                            if (!mObj) return;
                            const color = colorForMember(mObj);
                            const tag = document.createElement('span');
                            tag.className = 'staff-tag';

                            if (selectedMember && String(mObj.id) === String(selectedMember.id)) {
                                tag.classList.add('selected-member-tag');
                                hasSelected = true;
                            }

                            tag.title =
                                    `${mObj.name || ''} (${DOW_LABELS[dayIdx]} ${pad2(h)}:${pad2(m)})`;
                            tag.innerHTML = `
                                <span class="staff-tag-dot" style="background:${color}"></span>
                                <span class="staff-tag-name">${escapeHtml(mObj.name ?? '-')}</span>
                            `;
                            tagsDiv.appendChild(tag);
                        });

                        if (hasSelected) {
                            cell.classList.add('selected-member-cell');
                        }

                        cell.appendChild(tagsDiv);
                    }

                    tr.appendChild(cell);
                }

                const tdTotal = document.createElement('td');
                tdTotal.className = 'staff-cell';
                tdTotal.innerHTML =
                        `<span class="staff-count">${totalCount}</span><span class="small text-muted">ëª…</span>`;
                tr.appendChild(tdTotal);

                rows.push(tr);
            });

            weekStaffTbody.innerHTML = '';
            rows.forEach(r => weekStaffTbody.appendChild(r));
        }

        /* ===== ê°œë³„ ì£¼ê°„ ì¼ì • ë¡œë”© ===== */
        async function loadSelectedMemberWeek(){
            if (!selectedMember) {
                hideMemberWeekCard();
                return;
            }
            const weekStart = currentWeekStart;
            const weekEnd   = addDays(weekStart, 6);
            const startIso  = toIso(weekStart);

            memberWeekCard.classList.remove('d-none');
            memberWeekNameBadge.textContent = selectedMember.name || '-';
            memberWeekTitle.textContent = `ê°œë³„ ì£¼ê°„ ì¼ì • (${startIso} ~ ${toIso(weekEnd)})`;

            try {
                const url = `${API_BASE}/${encodeURIComponent(selectedMember.id)}/${startIso}/${toIso(weekEnd)}`;
                const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                if (!resp.ok) {
                    console.error('ê°œë³„ ì£¼ê°„ ì¼ì • ì¡°íšŒ ì‹¤íŒ¨', resp.status);
                    selectedWeekDaysMap = {};
                    buildMemberWeekGrid();
                    hydrateGridFromDayMap(selectedWeekDaysMap);
                    return;
                }
                const data = await resp.json();
                selectedWeekDaysMap = normalizeDays(data) || {};
            } catch (e) {
                console.error(e);
                selectedWeekDaysMap = {};
            }

            buildMemberWeekGrid();
            hydrateGridFromDayMap(selectedWeekDaysMap);
        }

        function hideMemberWeekCard(){
            memberWeekCard.classList.add('d-none');
        }

        /* ===== ê°œì¸ ì£¼ê°„ ê·¸ë¦¬ë“œ ìƒì„± ===== */
        function buildMemberWeekGrid(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.innerHTML = '';

            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END * 60;
            const totalRows = (endMin - startMin) / gridStepMinutes;

            for (let idx=0; idx<totalRows; idx++){
                const tMin = startMin + idx * gridStepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m % 30 === 0) ? hmLabel : '';
                tr.appendChild(th);

                for (let dayOffset=0; dayOffset<7; dayOffset++){
                    const td = document.createElement('td');
                    const div = document.createElement('div');
                    div.className = 'slot-10m';
                    div.dataset.dayOffset = String(dayOffset);
                    div.dataset.idx = String(idx);
                    td.appendChild(div);
                    tr.appendChild(td);
                }

                memberWeekGridBody.appendChild(tr);
            }

            attachMemberGridDragHandlers();
        }

        /* ===== ê·¸ë¦¬ë“œ ë“œë˜ê·¸ ì„ íƒ/í•´ì œ ===== */
        let gridDragging = false;
        let gridDragAdding = true;

        function attachMemberGridDragHandlers(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.querySelectorAll('.slot-10m').forEach(div => {
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    gridDragging = true;
                    gridDragAdding = !div.classList.contains('selected');
                    toggleGridSlot(div, gridDragAdding);
                });
                div.addEventListener('mouseenter', () => {
                    if (!gridDragging) return;
                    toggleGridSlot(div, gridDragAdding);
                });
            });
            window.addEventListener('mouseup', () => {
                if (gridDragging){
                    gridDragging = false;
                }
            });
        }

        function toggleGridSlot(el, on) {
            if (on) el.classList.add('selected');
            else el.classList.remove('selected');
        }

        /* ===== ì„œë²„ì—ì„œ ë°›ì€ ì¼ì •ì„ ê·¸ë¦¬ë“œì— ë°˜ì˜ ===== */
        function hydrateGridFromDayMap(dayMap){
            if (!memberWeekGridBody) return;

            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END * 60;
            const totalRows = (endMin - startMin) / gridStepMinutes;

            memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));

            const weekStart = currentWeekStart;

            for (let offset=0; offset<7; offset++){
                const date = addDays(weekStart, offset);
                const iso  = toIso(date);
                const segments = (dayMap[iso]?.segments) || [];
                if (!segments.length) continue;

                segments.forEach(seg => {
                    const segStartMin = hmToMin(seg.start);
                    const segEndMin   = hmToMin(seg.end);

                    const a = Math.max(startMin, segStartMin);
                    const b = Math.min(endMin,   segEndMin);
                    if (a >= b) return;

                    const sIdx = Math.floor((a - startMin)/gridStepMinutes);
                    const eIdx = Math.ceil((b - startMin)/gridStepMinutes) - 1;

                    for (let idx = Math.max(0,sIdx); idx <= Math.min(totalRows-1, eIdx); idx++){
                        const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${offset}"][data-idx="${idx}"]`);
                        if (slot) slot.classList.add('selected');
                    }
                });
            }
        }

        function mergeConsecutive(arr){
            const out=[]; if(!arr.length) return out;
            arr.sort((a,b)=>a-b);
            let s=arr[0], p=arr[0];
            for(let i=1;i<arr.length;i++){
                if(arr[i]===p+1){ p=arr[i]; continue; }
                out.push([s,p]); s=p=arr[i];
            }
            out.push([s,p]);
            return out;
        }

        function collectSegmentsByDateFromGrid(){
            if (!memberWeekGridBody) return {};
            const res = {};
            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END * 60;
            const totalRows = (endMin - startMin) / gridStepMinutes;
            const weekStart = currentWeekStart;

            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const iso = toIso(addDays(weekStart, dayOffset));
                const indexes = [];
                for (let idx=0; idx<totalRows; idx++){
                    const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${dayOffset}"][data-idx="${idx}"]`);
                    if (slot && slot.classList.contains('selected')) indexes.push(idx);
                }
                const merged = mergeConsecutive(indexes);
                if (!merged.length) continue;

                res[iso] = merged.map(([sIdx,eIdxInclusive]) => {
                    const stMin = startMin + sIdx*gridStepMinutes;
                    const edMin = startMin + (eIdxInclusive+1)*gridStepMinutes;
                    return {
                        start: minToHm(stMin),
                        end:   minToHm(edMin)
                    };
                });
            }
            return res;
        }

        /* ===== ì €ì¥: ìš”ì•½ + confirm ===== */
        async function onSubmitWeekForm(e){
            e.preventDefault();
            if (!selectedMember) {
                alert('ì„ íƒëœ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const byDate = collectSegmentsByDateFromGrid();
            const weekStart = currentWeekStart;

            let summaryLines = [];
            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const date = addDays(weekStart, dayOffset);
                const iso  = toIso(date);
                const label = `${GRID_DAY_LABELS[dayOffset]} (${iso})`;
                const segs  = byDate[iso] || [];

                if (!segs.length) {
                    summaryLines.push(`${label}: íœ´ë¬´`);
                } else {
                    const ranges = segs.map(s => `${s.start}~${s.end}`).join(', ');
                    summaryLines.push(`${label}: ${ranges}`);
                }
            }

            const summaryText =
                    `ë‹¤ìŒê³¼ ê°™ì´ ì£¼ê°„ ê·¼ë¬´ì‹œê°„ì„ ì €ì¥í•©ë‹ˆë‹¤:\n\n` +
                    summaryLines.join('\n') +
                    `\n\nì´ëŒ€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            const ok = confirm(summaryText);
            if (!ok) return;

            const dates = [];
            for (let offset=0; offset<7; offset++){
                dates.push(toIso(addDays(weekStart, offset)));
            }

            try {
                for (const iso of dates){
                    const segments = byDate[iso] || [];
                    const payload = {
                        memberId: selectedMember.id,
                        date: iso,
                        segments
                    };
                    const resp = await fetch(API_UPDATE, {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) {
                        const txt = await resp.text().catch(()=> '');
                        alert(`ì €ì¥ ì‹¤íŒ¨ (${iso}): ${resp.status} ${txt}`);
                        return;
                    }
                }

                alert('í•´ë‹¹ ì£¼ê°„ ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                await loadSelectedMemberWeek();
            } catch (e) {
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /* ===== Utils ===== */
        function toMonday(date){
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay(); // 0=ì¼,1=ì›”,...
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            return d;
        }
        function addDays(d, n){
            const x = new Date(d);
            x.setDate(x.getDate()+n);
            return x;
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){
            return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        }

        function normalizeDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce(
                                (acc,s)=> acc + (hmToMin(s.end) - hmToMin(s.start)),
                                0
                        );
                map[date] = { segments, minutes };
            });
            return map;
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const [h,m] = String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60 + (m||0);
        }
        function minToHm(min){
            const h = Math.floor(min/60);
            const m = min%60;
            return `${pad2(h)}:${pad2(m)}`;
        }

        function colorForMember(m){
            const key = (m?.id!=null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

    })();
</script>

{{>layouts/footer}}
