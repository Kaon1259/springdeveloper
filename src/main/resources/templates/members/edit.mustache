{{>layouts/header}}
{{>layouts/toast}}

<style>
    .week-grid { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; user-select: none; background:#fff; }
    .week-grid table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    .week-grid thead th {
        background: #f8fafc; color:#64748b; font-weight: 600; font-size: 0.95rem;
        border-bottom: 1px solid #e5e7eb; text-align: center; padding: .6rem .4rem;
        position: sticky; top: 0; z-index: 2;
    }
    .week-grid tbody th {
        background: #fafafa; color:#6b7280; font-weight: 600; width: 74px;
        border-right: 1px solid #e5e7eb; text-align: center; padding: .25rem .25rem; font-size: .85rem;
        position: sticky; left: 0; z-index: 1;
    }
    .slot-10m {
        border-bottom: 1px dashed #eef2f6; border-right: 1px dashed #eef2f6;
        height: 18px; cursor: pointer; background: #ffffff;
    }
    .slot-10m:hover { background: #f8fbff; }
    .slot-10m.selected { background: rgba(25,135,84,.18); box-shadow: inset 0 0 0 1px rgba(25,135,84,.25); }
    .row-hour-start td, .row-hour-start th { border-top: 2px solid #e5e7eb !important; }
    .grid-toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
    .modal { background: rgba(0,0,0,.35); position: fixed; inset: 0; display:none; }
    .modal-dialog { margin: 50px auto; max-width: 980px; }
    .modal-content { background:#fff; border-radius: 12px; }
</style>

<main class="container my-4">
    <h2 class="mb-3">ğŸ‘¤ ì•„ë¥´ë°”ì´íŠ¸ íšŒì› ì •ë³´ ìˆ˜ì •</h2>

    <form class="container px-0" action="/members/{{member.id}}/update" method="post" id="memberForm">
        {{#_csrf}}<input type="hidden" name="{{parameterName}}" value="{{token}}">{{/_csrf}}
        <input type="hidden" name="id" value="{{member.id}}"/>

        <div class="row g-3">
            <!-- ì™¼ìª½: ê¸°ë³¸ ì •ë³´ -->
            <div class="col-12 col-lg-6">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ê¸°ë³¸ ì •ë³´</span>
                        <select class="form-select form-select-sm w-auto" name="status" id="statusHeader" required>
                            <option value="">ìƒíƒœ</option>
                            <option value="WAITING">ì‹œì‘ì „</option>
                            <option value="WORKING">ê·¼ë¬´ì¤‘</option>
                            <option value="RESTING">íœ´ì‹ì¤‘</option>
                            <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                            <option value="RESIGNED">í‡´ì‚¬</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ì´ë¦„</label>
                            <input class="form-control" type="text" name="name" value="{{member.name}}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ì„±ë³„</label>
                            <select class="form-select" name="gender" id="gender" required>
                                <option value="">ì„±ë³„ ì„ íƒ</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ì—°ë½ì²˜</label>
                            <input class="form-control" type="tel" id="phone" name="phone" value="{{member.phone}}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ì´ë©”ì¼</label>
                            <input class="form-control" type="email" name="email" value="{{member.email}}">
                        </div>
                    </div>
                </div>

                <!-- ë³´ê±´ì¦ -->
                <div class="card mb-3">
                    <div class="card-header fw-bold">ë³´ê±´ì¦</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label d-block">ë³´ê±´ì¦ ë³´ìœ </label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="hasHealthCertificate" value="true" id="healthYes" {{#member}}{{#hasHealthCertificate}}checked{{/hasHealthCertificate}}{{/member}}>
                                <label class="form-check-label" for="healthYes">ë³´ìœ </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="hasHealthCertificate" value="false" id="healthNo" {{#member}}{{^hasHealthCertificate}}checked{{/hasHealthCertificate}}{{/member}}>
                                <label class="form-check-label" for="healthNo">ë¯¸ë³´ìœ </label>
                            </div>
                        </div>
                        <div id="healthExpiryPanel" class="mt-2" style="display:none;">
                            <label class="form-label mb-1">ìœ íš¨ê¸°ê°„(ë§Œë£Œì¼)</label>
                            <input type="date" class="form-control" id="healthExpiryDate" name="healthCertExpiry" value="{{healthCertExpiry}}">
                        </div>
                    </div>
                </div>

                <!-- ê³„ì¢Œ -->
                <div class="card mb-3">
                    <div class="card-header fw-bold">ê¸‰ì—¬ ì…ê¸ˆ ê³„ì¢Œ</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ì€í–‰</label>
                            <select class="form-select" name="bankName" id="bankName">
                                <option value="">ì€í–‰ ì„ íƒ</option>
                                <option>KBêµ­ë¯¼</option><option>ì‹ í•œ</option><option>ìš°ë¦¬</option><option>í•˜ë‚˜</option>
                                <option>ë†í˜‘</option><option>IBKê¸°ì—…</option><option>ì¹´ì¹´ì˜¤ë±…í¬</option><option>í† ìŠ¤ë±…í¬</option>
                                <option>SCì œì¼</option><option>ì”¨í‹°</option><option>ë¶€ì‚°</option><option>ëŒ€êµ¬</option>
                                <option>ê²½ë‚¨</option><option>ê´‘ì£¼</option><option>ì „ë¶</option><option>ìˆ˜í˜‘</option>
                                <option>ìƒˆë§ˆì„</option><option>ìš°ì²´êµ­</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
                            <input class="form-control" type="text" name="bankAccount" value="{{member.bankAccount}}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ê·¼ë¬´ì¡°ê±´ -->
            <div class="col-12 col-lg-6">
                <div class="card mb-3">
                    <div class="card-header fw-bold">ê·¼ë¬´ ì¡°ê±´</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ì‹œì‘ì¼</label>
                            <input class="form-control" type="date" name="startDate" value="{{member.startDate}}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ì‹œê¸‰(ì›)</label>
                            <input class="form-control" type="number" name="hourlyWage" id="hourlyWage" value="{{member.hourlyWage}}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ê¸‰ì—¬ì§€ê¸‰ì¼</label>
                            <select class="form-select" name="payday" id="payday">
                                <option value="">ë¯¸ì§€ì •</option>
                                <option value="EOM">ë§ì¼</option>
                                {{#days}}<option value="{{.}}">{{.}}ì¼</option>{{/days}}
                            </select>
                        </div>
                        <div>
                            <label class="form-label d-block">ì£¼íœ´ìˆ˜ë‹¹ ì ìš©</label>
                            <input class="form-check-input" type="checkbox" id="includeWeeklyHolidayAllowance" name="includeWeeklyHolidayAllowance" value="true">
                            <label class="form-check-label" for="includeWeeklyHolidayAllowance">ì ìš© (ì£¼15ì‹œê°„ ì´ìƒ ì‹œ)</label>
                        </div>
                    </div>
                </div>

                <!-- ê·¼ë¬´ì‹œê°„ -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ê·¼ë¬´ì‹œê°„(ìš”ì¼/ì‹œê°„)</span>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="openScheduleModal">ë“±ë¡/ìˆ˜ì •</button>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm" id="scheduleTableView">
                            <thead><tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th></tr></thead>
                            <tbody>
                            {{#schedules}}
                                <tr>
                                    <td data-day="{{day}}">{{dayLabel}}</td>
                                    <td data-start="{{start}}">{{start}}</td>
                                    <td data-end="{{end}}">{{end}}</td>
                                </tr>
                            {{/schedules}}
                            {{^schedules}}
                                <tr class="placeholder"><td colspan="3" class="text-muted">ë“±ë¡ëœ ê·¼ë¬´ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {{/schedules}}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-success btn-lg">ìˆ˜ì •í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </form>
</main>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="scheduleModal">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ìš”ì¼/ì‹œê°„ ë“±ë¡</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="closeScheduleModal">ë‹«ê¸°</button>
            </div>
            <div class="grid-toolbar mb-2">
                <div class="left"><button type="button" class="btn btn-sm btn-outline-secondary" id="clearAll">ì „ì²´ ì´ˆê¸°í™”</button></div>
                <small class="text-muted">10ë¶„ ë‹¨ìœ„ ì„ íƒ ê°€ëŠ¥</small>
            </div>
            <div class="week-grid mb-3">
                <table>
                    <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th data-day="MON">ì›”</th><th data-day="TUE">í™”</th><th data-day="WED">ìˆ˜</th>
                        <th data-day="THU">ëª©</th><th data-day="FRI">ê¸ˆ</th><th data-day="SAT">í† </th><th data-day="SUN">ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="weekGridBody"></tbody>
                </table>
            </div>
            <div>
                <table class="table table-sm" id="schedulePreviewTable">
                    <thead><tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="text-end mt-2">
                <button type="button" class="btn btn-success" id="applySchedule">ì ìš©</button>
            </div>
        </div>
    </div>
</div>

{{>layouts/footer}}

<script>
    // ì´ˆê¸°ê°’ ì„¸íŒ…
    (function(){
        const bankName="{{member.bankName}}"; if(bankName)document.getElementById('bankName').value=bankName;
        const gender="{{#member}}{{gender}}{{/member}}"; if(gender)document.getElementById('gender').value=gender;
        const status="{{#member}}{{status}}{{/member}}"; if(status)document.getElementById('statusHeader').value=status;
        document.getElementById('includeWeeklyHolidayAllowance').checked=(String("{{member.includeWeeklyHolidayAllowance}}").toLowerCase()==='true');

        const hasHC=String("{{#member}}{{hasHealthCertificate}}{{/member}}").toLowerCase()==='true';
        const panel=document.getElementById('healthExpiryPanel');const dateInput=document.getElementById('healthExpiryDate');
        if(hasHC){panel.style.display='block';dateInput.disabled=false;}else{panel.style.display='none';dateInput.disabled=true;}
        document.getElementById('healthYes').addEventListener('change',()=>{panel.style.display='block';dateInput.disabled=false;});
        document.getElementById('healthNo').addEventListener('change',()=>{panel.style.display='none';dateInput.disabled=true;});

        // payday ë³´ì •
        const paydaySelect=document.getElementById('payday');
        let raw="{{member.payday}}";
        const hasNumeric=Array.from(paydaySelect.options).some(o=>/^\d+$/.test(o.value));
        if(!hasNumeric){for(let d=1;d<=31;d++){const opt=document.createElement('option');opt.value=String(d);opt.textContent=`${d}ì¼`;paydaySelect.appendChild(opt);}}
        function normalize(v){if(!v)return'';v=String(v).trim();if(v.toUpperCase()==='EOM')return'EOM';if(/^\d+$/.test(v))return String(parseInt(v,10));return v;}
        const norm=normalize(raw);
        const exist=Array.from(paydaySelect.options).some(o=>String(o.value)===norm);
        if(exist)paydaySelect.value=norm;
    })();
</script>

<script>
    (function(){
        const form=document.getElementById('memberForm');
        const modal=document.getElementById('scheduleModal');
        const openBtn=document.getElementById('openScheduleModal');
        const closeBtn=document.getElementById('closeScheduleModal');
        const applyBtn=document.getElementById('applySchedule');
        const clearBtn=document.getElementById('clearAll');
        const gridBody=document.getElementById('weekGridBody');
        const previewBody=document.querySelector('#schedulePreviewTable tbody');
        const viewBody=document.querySelector('#scheduleTableView tbody');
        const dayMap={MON:'ì›”',TUE:'í™”',WED:'ìˆ˜',THU:'ëª©',FRI:'ê¸ˆ',SAT:'í† ',SUN:'ì¼'};
        const days=['MON','TUE','WED','THU','FRI','SAT','SUN'];
        const HOUR_START=6,HOUR_END=22,STEP=10;
        const START_MIN=HOUR_START*60,END_MIN=HOUR_END*60;
        const TOTAL=(END_MIN-START_MIN)/STEP;

        openBtn.addEventListener('click',()=>{buildGrid();hydrate();preview();modal.style.display='block';});
        closeBtn.addEventListener('click',()=>modal.style.display='none');

        function buildGrid(){
            gridBody.innerHTML='';
            for(let i=0;i<TOTAL;i++){
                const t=START_MIN+i*STEP;const h=Math.floor(t/60),m=t%60;const label=(m%30===0)?`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`:'';
                const tr=document.createElement('tr');if(m===0)tr.classList.add('row-hour-start');
                const th=document.createElement('th');th.textContent=label;tr.appendChild(th);
                days.forEach(d=>{const td=document.createElement('td');const div=document.createElement('div');div.className='slot-10m';div.dataset.day=d;div.dataset.idx=i;td.appendChild(div);tr.appendChild(td);});
                gridBody.appendChild(tr);
            }
            attachDrag();
        }
        let dragging=false,adding=true;
        function attachDrag(){
            gridBody.querySelectorAll('.slot-10m').forEach(div=>{
                div.addEventListener('mousedown',e=>{e.preventDefault();dragging=true;adding=!div.classList.contains('selected');toggle(div,adding);});
                div.addEventListener('mouseenter',()=>{if(!dragging)return;toggle(div,adding);});
            });
            window.addEventListener('mouseup',()=>{if(dragging){dragging=false;preview();}});
        }
        function toggle(el,on){on?el.classList.add('selected'):el.classList.remove('selected');}
        clearBtn.addEventListener('click',()=>{gridBody.querySelectorAll('.selected').forEach(s=>s.classList.remove('selected'));preview();});

        function hydrate(){
            const rows=Array.from(viewBody.querySelectorAll('tr')).filter(r=>!r.classList.contains('placeholder'));
            rows.forEach(r=>{
                const d=r.querySelector('td:nth-child(1)')?.getAttribute('data-day');
                const s=r.querySelector('td:nth-child(2)')?.getAttribute('data-start')||r.querySelector('td:nth-child(2)')?.textContent?.trim();
                const e=r.querySelector('td:nth-child(3)')?.getAttribute('data-end')||r.querySelector('td:nth-child(3)')?.textContent?.trim();
                if(!d||!s||!e)return;
                const sMin=toMin(s),eMin=toMin(e);const a=Math.max(START_MIN,sMin),b=Math.min(END_MIN,eMin);if(a>=b)return;
                const si=Math.floor((a-START_MIN)/STEP),ei=Math.ceil((b-START_MIN)/STEP)-1;
                for(let i=si;i<=ei;i++){const el=gridBody.querySelector(`.slot-10m[data-day="${d}"][data-idx="${i}"]`);if(el)el.classList.add('selected');}
            });
        }
        function preview(){
            previewBody.innerHTML='';
            days.forEach(d=>{
                const idxs=[];for(let i=0;i<TOTAL;i++){const el=gridBody.querySelector(`.slot-10m[data-day="${d}"][data-idx="${i}"]`);if(el&&el.classList.contains('selected'))idxs.push(i);}
                const merged=merge(idxs);
                merged.forEach(([s,e])=>{
                    const sMin=START_MIN+s*STEP,eMin=START_MIN+(e+1)*STEP;
                    const tr=document.createElement('tr');
                    tr.innerHTML=`<td data-day="${d}">${dayMap[d]}(${d})</td><td data-start="${toHM(sMin)}">${toHM(sMin)}</td><td data-end="${toHM(eMin)}">${toHM(eMin)}</td>`;
                    previewBody.appendChild(tr);
                });
            });
            if(!previewBody.children.length){const tr=document.createElement('tr');tr.innerHTML=`<td colspan="3" class="text-muted">ì„ íƒëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;previewBody.appendChild(tr);}
        }
        function merge(a){const out=[];if(!a.length)return out;a.sort((x,y)=>x-y);let s=a[0],p=a[0];for(let i=1;i<a.length;i++){if(a[i]===p+1){p=a[i];continue;}out.push([s,p]);s=p=a[i];}out.push([s,p]);return out;}
        applyBtn.addEventListener('click',()=>{const rows=Array.from(previewBody.querySelectorAll('tr')).filter(r=>r.querySelector('td[data-day]'));viewBody.innerHTML='';
            if(!rows.length){const tr=document.createElement('tr');tr.className='placeholder';tr.innerHTML=`<td colspan="3" class="text-muted">ë“±ë¡ëœ ê·¼ë¬´ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;viewBody.appendChild(tr);}
            else{rows.forEach(r=>{const d=r.querySelector('td:nth-child(1)').dataset.day,s=r.querySelector('td:nth-child(2)').dataset.start,e=r.querySelector('td:nth-child(3)').dataset.end;
                const tr=document.createElement('tr');tr.innerHTML=`<td data-day="${d}">${dayMap[d]}(${d})</td><td data-start="${s}">${s}</td><td data-end="${e}">${e}</td>`;viewBody.appendChild(tr);});}
            buildHidden();modal.style.display='none';
        });
        function buildHidden(){
            form.querySelectorAll('input[data-schedule="1"]').forEach(n=>n.remove());
            const rows=Array.from(viewBody.querySelectorAll('tr')).filter(r=>!r.classList.contains('placeholder'));
            rows.forEach((r,i)=>{const d=r.querySelector('td:nth-child(1)').dataset.day,s=r.querySelector('td:nth-child(2)').dataset.start,e=r.querySelector('td:nth-child(3)').dataset.end;
                add(`schedule[${i}].day`,d);add(`schedule[${i}].start`,s);add(`schedule[${i}].end`,e);});
        }
        function add(n,v){const input=document.createElement('input');input.type='hidden';input.name=n;input.value=v;input.dataset.schedule='1';form.appendChild(input);}
        form.addEventListener('submit',()=>{const chk=document.getElementById('includeWeeklyHolidayAllowance');
            form.querySelectorAll('input[name="includeWeeklyHolidayAllowance"]').forEach(n=>{if(n!==chk)n.remove();});
            chk.removeAttribute('name');
            const hidden=document.createElement('input');hidden.type='hidden';hidden.name='includeWeeklyHolidayAllowance';hidden.value=chk.checked?'true':'false';form.appendChild(hidden);
            buildHidden();
        });
        function toMin(hm){const [H,M]=hm.split(':').map(Number);return (H||0)*60+(M||0);}
        function toHM(m){const H=Math.floor(m/60),M=m%60;return`${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}`;}
    })();
</script>
