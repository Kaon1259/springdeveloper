{{>layouts/header}}
{{>layouts/toast}}

<!-- ê°„ë‹¨ ìŠ¤íƒ€ì¼(ì„ íƒ) -->
<style>
    .text-mono { font-variant-numeric: tabular-nums; letter-spacing:-0.01em; }
    .wage-preview-header { background: linear-gradient(135deg, #198754 0%, #20c997 100%); color:#fff; border-bottom:none; }
    .wage-preview-card .table > :not(caption) > * > * { padding: 0.9rem 1rem; }
    .wage-preview-table thead th { background:#f6f9fb; color:#6c757d; font-weight:600; border-bottom:1px solid #e9ecef; }
    .wage-preview-table tbody tr:not(.table-subtle) td { border-top: 1px dashed #eef2f6; }
    .wage-preview-table .table-subtle td { background:#fafcfd; color:#7a8a99; }
</style>

<main class="container page-container center-page">
    <div class="form-box">
        <h2>ğŸ‘¤ ì•„ë¥´ë°”ì´íŠ¸ íšŒì› ìˆ˜ì •</h2>

        <!-- ìˆ˜ì •: ë©¤ë²„ idì— ë§ì¶° ì—…ë°ì´íŠ¸ë¡œ ë³´ë‚¼ ê²ƒì„ ê°€ì • -->
        <form class="container" action="/members/{{member.id}}/update" method="post" id="memberForm">
            <!-- PK -->
            <input type="hidden" name="id" value="{{member.id}}"/>

            <!-- ì´ë¦„ -->
            <div class="mb-3">
                <label class="form-label">ì´ë¦„</label>
                <input class="form-input" type="text" name="name" id="name" value="{{member.name}}" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>

            <!-- ì„±ë³„ -->
            <div class="mb-3">
                <label class="form-label">ì„±ë³„</label>
                <select class="form-select" name="gender" id="gender" required>
                    <option value="">ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                    <option value="ì—¬ì„±">ì—¬ì„±</option>
                </select>
            </div>

            <!-- ì•„ë¥´ë°”ì´íŠ¸ ì‹œì‘ì¼ -->
            <div class="mb-3">
                <label class="form-label">ì•„ë¥´ë°”ì´íŠ¸ ì‹œì‘ì¼</label>
                <input class="form-input" type="date" name="startDate" id="startDate" value="{{member.startDate}}" required>
            </div>

            <!-- ì—°ë½ì²˜ -->
            <div class="mb-3">
                <label class="form-label">ì—°ë½ì²˜</label>
                <input
                        class="form-input"
                        type="tel"
                        name="phone"
                        id="phone"
                        value="{{member.phone}}"
                        placeholder="010-1234-5678"
                        pattern="^0\d{1,2}-\d{3,4}-\d{4}$"
                        required>
                <div class="form-text">ìˆ«ìë§Œ ì…ë ¥í•´ë„ ìë™ìœ¼ë¡œ <code>010-1234-5678</code> í˜•íƒœë¡œ í¬ë§·íŒ…ë©ë‹ˆë‹¤.</div>
            </div>

            <!-- ì´ë©”ì¼ -->
            <div class="mb-3">
                <label class="form-label">ì´ë©”ì¼</label>
                <input class="form-input" type="email" name="email" id="email" value="{{member.email}}" placeholder="name@example.com">
                <div class="form-text">ì„ íƒ ì…ë ¥ì…ë‹ˆë‹¤.</div>
            </div>

            <!-- ì‹œê°„ë‹¹ ë‹¨ê°€(ì›) -->
            <div class="mb-3">
                <label class="form-label">ì‹œê°„ë‹¹ ë‹¨ê°€(ì›)</label>
                <input
                        class="form-input"
                        type="number"
                        name="hourlyWage"
                        id="hourlyWage"
                        min="0"
                        step="100"
                        value="{{member.hourlyWage}}"
                        placeholder="12000"
                        required>
                <div class="form-text">ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 12000). ì„œë²„ì—ì„œëŠ” ì •ìˆ˜(ì›)ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
            </div>

            <!-- ë³´ê±´ì¦ ë³´ìœ  ì—¬ë¶€ -->
            <div class="mb-3">
                <label class="form-label">ë³´ê±´ì¦ ë³´ìœ </label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hasHealthCertificate" value="true" id="healthYes">
                    <label class="form-check-label" for="healthYes">ë³´ìœ </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="hasHealthCertificate" value="false" id="healthNo">
                    <label class="form-check-label" for="healthNo">ë¯¸ë³´ìœ </label>
                </div>
            </div>

            <!-- ë³´ê±´ì¦ ìœ íš¨ê¸°ê°„ ì¸ë¼ì¸ í¼(ë³´ìœ  ì„ íƒ ì‹œ í‘œì‹œ) -->
            <div id="healthExpiryPanel" class="mt-2" style="display:none;">
                <div class="d-flex align-items-end gap-2">
                    <div>
                        <label class="form-label mb-1">ìœ íš¨ê¸°ê°„(ë§Œë£Œì¼)</label>
                        <!-- ğŸ”¶ controllerì—ì„œ ë‚´ë ¤ì¤€ ë¬¸ìì—´ë§Œ ì‚¬ìš© -->
                        <input type="date" class="form-input" id="healthExpiryDate" value="{{healthCertExpiryStr}}">
                    </div>
                    <div class="mb-2">
                        <button type="button" class="btn btn-success btn-sm" id="applyHealthExpiry">ì ìš©</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cancelHealthExpiry">ì·¨ì†Œ</button>
                    </div>
                </div>
                <div id="healthExpiryPreview" class="text-muted mt-2">
                    ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.
                </div>
            </div>

            <!-- í˜„ì¬ ìƒíƒœ -->
            <div class="mb-3">
                <label class="form-label">í˜„ì¬ ìƒíƒœ</label>
                <select class="form-select" name="status" id="status" required>
                    <option value="">ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="WAITING">ì‹œì‘ì „</option>
                    <option value="WORKING">ê·¼ë¬´ì¤‘</option>
                    <option value="RESTING">íœ´ì‹ì¤‘</option>
                    <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                    <option value="RESIGNED">í‡´ì‚¬</option>
                </select>
            </div>

            <!-- ìš”ì¼/ì‹œê°„ ë“±ë¡ ë²„íŠ¼ -->
            <div class="mb-2 d-flex gap-2">
                <label class="form-label" style="margin-right:8px;">ì•„ë¥´ë°”ì´íŠ¸ ìš”ì¼/ì‹œê°„</label>
                <button type="button" class="btn btn-outline-primary btn-sm" id="openScheduleModal">ìš”ì¼/ì‹œê°„ ë“±ë¡</button>
            </div>

            <!-- ì ìš© ìŠ¤ì¼€ì¤„ í‘œ -->
            <div class="mb-3">
                <table class="table table-sm" id="scheduleTableView">
                    <thead>
                    <tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th></tr>
                    </thead>
                    <tbody>
                    {{#schedules}}
                        <tr>
                            <td data-day="{{day}}">{{day}}</td>
                            <td data-start="{{start}}">{{start}}</td>
                            <td data-end="{{end}}">{{end}}</td>
                        </tr>
                    {{/schedules}}
                    {{^schedules}}
                        <tr class="placeholder">
                            <td colspan="3" class="text-muted">ì•„ì§ ë“±ë¡ëœ ìš”ì¼/ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. â€œìš”ì¼/ì‹œê°„ ë“±ë¡â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</td>
                        </tr>
                    {{/schedules}}
                    </tbody>
                </table>
            </div>

            <!-- âœ… ì˜ˆìƒ ê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸° (í…Œì´ë¸”í˜•) -->
            <div class="mb-4">
                <div class="card wage-preview-card shadow-sm">
                    <div class="card-header wage-preview-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ì˜ˆìƒ ê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸°</span>
                        <small class="text-white-50">ìŠ¤ì¼€ì¤„/ì‹œê¸‰ ë³€ê²½ ì‹œ ìë™ ë°˜ì˜</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-borderless table-hover align-middle mb-0 wage-preview-table">
                                <thead>
                                <tr>
                                    <th class="w-50">í•­ëª©</th>
                                    <th class="text-end w-50">ê°’</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="text-muted">ì£¼ê°„ ì´ ê·¼ë¬´ì‹œê°„</td>
                                    <td class="text-end text-mono fw-semibold" id="previewWeeklyHours">0ì‹œê°„ 0ë¶„</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">ì£¼ê°„ ì˜ˆìƒ ê¸‰ì—¬</td>
                                    <td class="text-end text-mono fw-bold" id="previewWeeklyPay">â‚©0</td>
                                </tr>
                                <tr class="table-subtle">
                                    <td class="text-muted">ì›” í™˜ì‚° ì£¼ì°¨</td>
                                    <td class="text-end text-mono">Ã— 4.345</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">ì›”ê°„ ì˜ˆìƒ ê¸‰ì—¬</td>
                                    <td class="text-end text-mono fw-bold text-success" id="previewMonthlyPay">â‚©0</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="px-3 pb-3 pt-2 small text-muted">
                            * ì›” í™˜ì‚°ì€ í‰ê·  1ê°œì›” â‰ˆ 4.345ì£¼ ê¸°ì¤€ì…ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-submit">ìˆ˜ì •í•˜ê¸°</button>
        </form>
    </div>
</main>

<!-- ëª¨ë‹¬: ìš”ì¼/ì‹œê°„ í¸ì§‘ -->
<div class="modal" id="scheduleModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content" style="padding:1rem;">
            <h3 class="mb-2">ìš”ì¼/ì‹œê°„ ë“±ë¡</h3>

            <div class="row mb-2">
                <div class="col">
                    <label class="form-label">ìš”ì¼</label>
                    <select class="form-select" id="daySelect">
                        <option value="MON">ì›”ìš”ì¼</option>
                        <option value="TUE">í™”ìš”ì¼</option>
                        <option value="WED">ìˆ˜ìš”ì¼</option>
                        <option value="THU">ëª©ìš”ì¼</option>
                        <option value="FRI">ê¸ˆìš”ì¼</option>
                        <option value="SAT">í† ìš”ì¼</option>
                        <option value="SUN">ì¼ìš”ì¼</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label">ì‹œì‘</label>
                    <input type="time" class="form-input" id="startTime" value="10:00">
                </div>
                <div class="col">
                    <label class="form-label">ì¢…ë£Œ</label>
                    <input type="time" class="form-input" id="endTime" value="19:00">
                </div>
            </div>

            <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-primary" id="addScheduleRow">ì¶”ê°€</button>
            </div>

            <div class="mb-3">
                <table class="table table-sm" id="scheduleTableEdit">
                    <thead>
                    <tr><th>ìš”ì¼</th><th>ì‹œì‘</th><th>ì¢…ë£Œ</th><th>ì‚­ì œ</th></tr>
                    </thead>
                    <tbody><!-- í¸ì§‘ ì¤‘ì¸ í–‰ë“¤ --></tbody>
                </table>
            </div>

            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-success" id="applySchedule">ì ìš©</button>
                <button type="button" class="btn btn-secondary" id="cancelSchedule">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

{{>layouts/footer}}

<!-- ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    (function() {
        const form = document.getElementById('memberForm');

        /* ===== ì—°ë½ì²˜ ìë™ í¬ë§· ===== */
        const phone = document.getElementById('phone');
        phone.addEventListener('input', () => {
            let v = phone.value.replace(/\\D/g, '');
            if (v.startsWith('02')) {
                if (v.length > 2 && v.length <= 6)      phone.value = v.replace(/(02)(\\d{0,4})/, '$1-$2');
                else if (v.length > 6)                  phone.value = v.replace(/(02)(\\d{3,4})(\\d{0,4}).*/, '$1-$2-$3');
                else                                    phone.value = v;
            } else {
                if (v.length <= 3)                      phone.value = v;
                else if (v.length <= 7)                 phone.value = v.replace(/(0\\d{2})(\\d{0,4})/, '$1-$2');
                else                                    phone.value = v.replace(/(0\\d{2})(\\d{3,4})(\\d{0,4}).*/, '$1-$2-$3');
            }
        });

        /* ===== ê¸°ë³¸ê°’ ì„¸íŒ…: ì…€ë ‰íŠ¸/ë¼ë””ì˜¤ ===== */
        const genderSel = document.getElementById('gender');
        const statusSel = document.getElementById('status');
        const healthYes = document.getElementById('healthYes');
        const healthNo  = document.getElementById('healthNo');
        const panel     = document.getElementById('healthExpiryPanel');
        const dateInput = document.getElementById('healthExpiryDate');
        const preview   = document.getElementById('healthExpiryPreview');
        const hourlyWage = document.getElementById('hourlyWage');

        // ğŸ”¶ ì„œë²„ ê°’: ëª¨ë‘ ì¡´ì¬í•˜ëŠ” ë³´ì¡° í•„ë“œ/í‚¤ë§Œ ì‚¬ìš©
        const serverGender = "{{#member}}{{gender}}{{/member}}";
        const serverStatus = "{{#member}}{{status}}{{/member}}";
        const serverHasHC  = "{{#member}}{{hasHealthCertificate}}{{/member}}";
        const serverHCExp  = "{{healthCertExpiryStr}}";

        if (serverGender) genderSel.value = serverGender;
        if (serverStatus) statusSel.value = serverStatus;

        // ë¼ë””ì˜¤/íŒ¨ë„ ì´ˆê¸°ê°’
        if (serverHasHC === "true" || serverHasHC === "TRUE") {
            healthYes.checked = true;
            panel.style.display = 'block';
            if (serverHCExp) {
                dateInput.value = serverHCExp;
                preview.textContent = "ìœ íš¨ê¸°ê°„: " + serverHCExp;
                preview.classList.remove('text-muted');
            } else {
                preview.textContent = 'ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.';
                preview.classList.add('text-muted');
            }
        } else {
            healthNo.checked = true;
            panel.style.display = 'none';
            preview.textContent = 'ë³´ìœ  ì„ íƒ ì‹œ ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            preview.classList.add('text-muted');
        }

        /* ===== ë‹¨ê°€ ê²€ì¦ & ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  ===== */
        hourlyWage.addEventListener('blur', () => {
            const val = parseInt(hourlyWage.value || '0', 10);
            if (isNaN(val) || val < 0) {
                alert('ì‹œê°„ë‹¹ ë‹¨ê°€ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');
                hourlyWage.focus();
            }
            updatePreview();
        });
        hourlyWage.addEventListener('input', updatePreview);

        /* ===== ìŠ¤ì¼€ì¤„ í…Œì´ë¸” DOM ===== */
        const viewTableBody = document.querySelector('#scheduleTableView tbody');
        const editTableBody = document.querySelector('#scheduleTableEdit tbody');

        /* ===== ëª¨ë‹¬ ê´€ë ¨ ===== */
        const openBtn = document.getElementById('openScheduleModal');
        const modal = document.getElementById('scheduleModal');
        const scheduleApplyBtn = document.getElementById('applySchedule');
        const scheduleCancelBtn = document.getElementById('cancelSchedule');
        const addRowBtn = document.getElementById('addScheduleRow');

        /* ===== ì…ë ¥ ì»¨íŠ¸ë¡¤ ===== */
        const daySelect = document.getElementById('daySelect');
        const startInput = document.getElementById('startTime');
        const endInput = document.getElementById('endTime');

        const dayMap = { MON:'ì›”', TUE:'í™”', WED:'ìˆ˜', THU:'ëª©', FRI:'ê¸ˆ', SAT:'í† ', SUN:'ì¼' };

        /* ëª¨ë‹¬ ì—´ê¸°: View â†’ Edit ë³µì‚¬ */
        openBtn.addEventListener('click', () => {
            editTableBody.innerHTML = '';
            Array.from(viewTableBody.querySelectorAll('tr')).forEach(tr => {
                if (tr.classList.contains('placeholder')) return;
                const d = tr.querySelector('td:nth-child(1)').getAttribute('data-day');
                const s = tr.querySelector('td:nth-child(2)').getAttribute('data-start');
                const e = tr.querySelector('td:nth-child(3)').getAttribute('data-end');
                appendEditRow(d, s, e);
            });
            modal.style.display = 'block';
        });

        /* ìŠ¤ì¼€ì¤„ í–‰ ì¶”ê°€ */
        addRowBtn.addEventListener('click', () => {
            const day = daySelect.value;
            const start = startInput.value;
            const end = endInput.value;
            if (!start || !end) { alert('ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (start >= end)   { alert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'); return; }
            appendEditRow(day, start, end);
        });

        /* ìŠ¤ì¼€ì¤„ í–‰ ì‚­ì œ */
        editTableBody.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('remove-row')) {
                e.target.closest('tr').remove();
                updatePreview();
            }
        });

        /* ìŠ¤ì¼€ì¤„ ì ìš©: Edit â†’ View + íˆë“  ì¬ìƒì„± + ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  */
        scheduleApplyBtn.addEventListener('click', () => {
            viewTableBody.innerHTML = '';
            const rows = Array.from(editTableBody.querySelectorAll('tr'));
            if (rows.length === 0) {
                addViewPlaceholder();
            } else {
                rows.forEach(r => {
                    const d = r.querySelector('td:nth-child(1)').getAttribute('data-day');
                    const s = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                    const e = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                    appendViewRow(d, s, e);
                });
            }
            rebuildHiddenInputsFromView();
            modal.style.display = 'none';
            updatePreview();
        });

        /* ìŠ¤ì¼€ì¤„ ì·¨ì†Œ */
        scheduleCancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        /* í¼ ì œì¶œ ì „ íˆë“  ìµœì‹ í™” */
        form.addEventListener('submit', () => {
            rebuildHiddenInputsFromView();
        });

        /* ìœ í‹¸: View/Edit ë Œë” */
        function appendEditRow(day, start, end) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td data-day="${day}">${day}(${dayMap[day]||''})</td>
      <td data-start="${start}">${start}</td>
      <td data-end="${end}">${end}</td>
      <td><button type="button" class="btn btn-link text-danger btn-sm remove-row">ì‚­ì œ</button></td>
    `;
            editTableBody.appendChild(tr);
        }
        function appendViewRow(day, start, end) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td data-day="${day}">${day}</td>
      <td data-start="${start}">${start}</td>
      <td data-end="${end}">${end}</td>
    `;
            viewTableBody.appendChild(tr);
        }
        function addViewPlaceholder() {
            const tr = document.createElement('tr');
            tr.className = 'placeholder';
            tr.innerHTML = `<td colspan="3" class="text-muted">ì•„ì§ ë“±ë¡ëœ ìš”ì¼/ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. â€œìš”ì¼/ì‹œê°„ ë“±ë¡â€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</td>`;
            viewTableBody.appendChild(tr);
        }

        /* íˆë“  ì¸í’‹ ì¬êµ¬ì„± */
        function rebuildHiddenInputsFromView() {
            form.querySelectorAll('input[type="hidden"][data-schedule="1"]').forEach(n => n.remove());
            const rows = Array.from(viewTableBody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('placeholder'));
            rows.forEach((r, i) => {
                const day = r.querySelector('td:nth-child(1)').getAttribute('data-day');
                const start = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                const end = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                addHidden(`schedule[${i}].day`, day);
                addHidden(`schedule[${i}].start`, start);
                addHidden(`schedule[${i}].end`, end);
            });
        }
        function addHidden(name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            input.setAttribute('data-schedule', '1');
            form.appendChild(input);
        }

        /* ë³´ê±´ì¦ ì¸ë¼ì¸ í¼ */
        const applyHealthBtn  = document.getElementById('applyHealthExpiry');
        const cancelHealthBtn = document.getElementById('cancelHealthExpiry');

        function onHealthRadioChange() {
            if (healthYes.checked) {
                panel.style.display = 'block';
                const existing = form.querySelector('input[type="hidden"][name="healthCertExpiry"]');
                if (existing && existing.value) {
                    dateInput.value = existing.value;
                    preview.textContent = `ìœ íš¨ê¸°ê°„: ${existing.value}`;
                    preview.classList.remove('text-muted');
                } else if (serverHCExp) {
                    dateInput.value = serverHCExp;
                    preview.textContent = `ìœ íš¨ê¸°ê°„: ${serverHCExp}`;
                    preview.classList.remove('text-muted');
                } else {
                    dateInput.value = '';
                    preview.textContent = 'ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.';
                    preview.classList.add('text-muted');
                }
            } else {
                panel.style.display = 'none';
                removeHealthExpiryHidden();
                dateInput.value = '';
                preview.textContent = 'ë³´ìœ  ì„ íƒ ì‹œ ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                preview.classList.add('text-muted');
            }
        }
        healthYes.addEventListener('change', onHealthRadioChange);
        healthNo.addEventListener('change', onHealthRadioChange);

        applyHealthBtn.addEventListener('click', () => {
            const val = dateInput.value;
            if (!val) { alert('ìœ íš¨ê¸°ê°„(ë§Œë£Œì¼)ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
            const today = new Date().toISOString().slice(0,10);
            if (val < today && !confirm('ì„ íƒí•œ ë‚ ì§œê°€ ì´ë¯¸ ì§€ë‚¬ìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì ìš©í• ê¹Œìš”?')) return;

            removeHealthExpiryHidden();
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'healthCertExpiry';
            hidden.value = val;
            hidden.setAttribute('data-health-expiry', '1');
            form.appendChild(hidden);

            preview.textContent = `ìœ íš¨ê¸°ê°„: ${val}`;
            preview.classList.remove('text-muted');
        });

        cancelHealthBtn.addEventListener('click', () => {
            const existing = form.querySelector('input[type="hidden"][name="healthCertExpiry"]');
            if (existing && existing.value) {
                dateInput.value = existing.value;
                preview.textContent = `ìœ íš¨ê¸°ê°„: ${existing.value}`;
                preview.classList.remove('text-muted');
            } else if (serverHCExp) {
                dateInput.value = serverHCExp;
                preview.textContent = `ìœ íš¨ê¸°ê°„: ${serverHCExp}`;
                preview.classList.remove('text-muted');
            } else {
                dateInput.value = '';
                preview.textContent = 'ìœ íš¨ê¸°ê°„ì„ ë“±ë¡í•˜ì„¸ìš”.';
                preview.classList.add('text-muted');
            }
        });

        function removeHealthExpiryHidden() {
            form.querySelectorAll('input[type="hidden"][data-health-expiry="1"]').forEach(n => n.remove());
        }

        form.addEventListener('submit', (e) => {
            if (healthYes.checked) {
                const hidden = form.querySelector('input[type="hidden"][name="healthCertExpiry"]');
                if (!hidden && !confirm('ë³´ê±´ì¦ â€œë³´ìœ â€ë¡œ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ìœ íš¨ê¸°ê°„ ì—†ì´ ê³„ì† ì§„í–‰í• ê¹Œìš”?')) {
                    e.preventDefault();
                }
            }
        });

        onHealthRadioChange(); // ì´ˆê¸° 1íšŒ

        /* === ì˜ˆìƒ ê¸‰ì—¬ ë¯¸ë¦¬ë³´ê¸° === */
        const weeklyHoursEl  = document.getElementById('previewWeeklyHours');
        const weeklyPayEl    = document.getElementById('previewWeeklyPay');
        const monthlyPayEl   = document.getElementById('previewMonthlyPay');

        const viewObserver = new MutationObserver(() => updatePreview());
        viewObserver.observe(viewTableBody, { childList: true });

        function updatePreview() {
            const totalMin = computeWeeklyMinutesFromView();
            const wage = parseInt(String(hourlyWage.value || '0').replace(/,/g,''), 10) || 0;

            const hours = Math.floor(totalMin / 60);
            const mins  = totalMin % 60;
            weeklyHoursEl.textContent = `${hours}ì‹œê°„ ${mins}ë¶„`;

            const weeklyPay = Math.round((totalMin / 60) * wage);
            weeklyPayEl.textContent  = formatKRW(weeklyPay);

            const monthlyPay = Math.round(weeklyPay * 4.345);
            monthlyPayEl.textContent = formatKRW(monthlyPay);
        }

        function computeWeeklyMinutesFromView() {
            const rows = Array.from(viewTableBody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('placeholder'));
            let total = 0;
            rows.forEach(r => {
                const start = r.querySelector('td:nth-child(2)').getAttribute('data-start');
                const end   = r.querySelector('td:nth-child(3)').getAttribute('data-end');
                total += diffMinutes(start, end);
            });
            return total;
        }

        function diffMinutes(start, end) {
            if (!start || !end) return 0;
            const [sh, sm] = start.split(':').map(n => parseInt(n,10));
            const [eh, em] = end.split(':').map(n => parseInt(n,10));
            return (eh*60 + em) - (sh*60 + sm);
        }

        function formatKRW(n) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(n || 0);
        }

        // ì´ˆê¸° 1íšŒ í‘œì‹œ
        updatePreview();
    })();
</script>
