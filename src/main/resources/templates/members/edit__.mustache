{{>layouts/header}}

<main class="schedule-shell py-4">
    <div class="schedule-layout container">

        <!-- ============ 상단: 한 명의 이름 + 상태 선택 + 상단 저장 버튼 ============ -->
        <section class="panel card-info mb-3">
            <header class="panel-header panel-header-compact d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">STAFF EDIT</div>

                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <h2 class="title-lg mb-0">아르바이트 정보 수정</h2>
                        <span class="name-pill">
                            {{member.name}}
                        </span>

                        <!-- 이름 옆 상태 선택 드롭다운 (form 속성으로 폼에 연결) -->
                        <div class="status-inline ms-2">
                            <span class="text-xs text-muted mb-0">상태</span>
                            <select id="statusSelectTop"
                                    class="form-select form-select-sm"
                                    name="status"
                                    form="memberEditForm"
                                    required>
                                <!-- isWorking/isWaiting 등 제거, JS로 value 세팅 -->
                                <option value="WORKING">근무중</option>   <!-- <-- 변경 -->
                                <option value="WAITING">시작전</option>  <!-- <-- 변경 -->
                                <option value="RESTING">휴식중</option>  <!-- <-- 변경 -->
                                <option value="PAUSED">일시중지</option> <!-- <-- 변경 -->
                                <option value="RESIGNED">퇴사</option>   <!-- <-- 변경 -->
                            </select>
                        </div>
                    </div>

                    <div class="text-xs text-muted mt-1">
                        {{#member}}
                            <span>
                            (등록일:
                                {{#createdAt}}
                                    {{createdAt}}
                                {{/createdAt}}
                                {{^createdAt}}
                                    -
                                {{/createdAt}}
                                )
                        </span>
                        {{/member}}
                    </div>
                </div>

                <!-- 오른쪽 끝: 상태 뱃지 제거하고 상단 저장 버튼 배치 -->
                <div class="d-flex flex-column align-items-end gap-2">
                    <button type="submit"
                            form="memberEditForm"
                            class="btn btn-sm btn-primary">
                        저장하기
                    </button>
                </div>
            </header>
        </section>

        <!-- ============ 패널: 기본 정보 편집 폼 ============ -->
        <section class="panel mb-3">
            <div class="panel-body">

                <!-- action / method / csrf는 프로젝트 설정에 맞게 -->
                <form id="memberEditForm" method="post" action="/members/{{member.id}}/update" autocomplete="off">

                    <!-- 1줄: 기본 정보 -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <div class="label">이름</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="name"
                                   value="{{member.name}}"
                                   required>
                        </div>

                        <div class="info-item">
                            <div class="label">성별</div>
                            <select class="form-select form-select-sm"
                                    name="gender"
                                    required>
                                <option value="">선택</option>
                                <!-- isMale / isFemale 제거, JS에서 member.gender로 세팅 -->
                                <option value="M">남</option> <!-- <-- 변경 -->
                                <option value="F">여</option> <!-- <-- 변경 -->
                            </select>
                        </div>
                        <div class="info-item">
                            <div class="label">전화번호</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="phone"
                                   value="{{member.phone}}">
                        </div>

                        <div class="info-item">
                            <div class="label">이메일</div>
                            <input type="email"
                                   class="form-control form-control-sm"
                                   name="email"
                                   value="{{member.email}}">
                        </div>
                    </div>

                    <!-- 2줄: 시작일/시급/급여지급일/주휴수당 -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <div class="label">시작일(근무)</div>
                            <input type="date"
                                   class="form-control form-control-sm"
                                   name="startDate"
                                   value="{{member.startDate}}">
                        </div>
                        <div class="info-item">
                            <div class="label">시급(원)</div>
                            <input type="number"
                                   min="0"
                                   step="10"
                                   class="form-control form-control-sm text-end"
                                   name="hourlyWage"
                                   value="{{member.hourlyWage}}">
                        </div>
                        <div class="info-item">
                            <div class="label">급여지급일</div>
                            <select class="form-select form-select-sm"
                                    name="payday"
                                    required>
                                <option value="">선택</option>
                                <!-- isPaydayEom 제거, JS로 value=member.payday -->
                                <option value="EOM">말일</option> <!-- <-- 변경 -->
                                {{#paydayOptions}}
                                    <!-- selected 플래그 안 쓰고, JS에서 통으로 세팅해도 됨 -->
                                    <option value="{{value}}">{{label}}</option> <!-- <-- 변경 -->
                                {{/paydayOptions}}
                            </select>
                        </div>

                        <div class="info-item">
                            <div class="label">주휴수당 적용</div>
                            <div class="form-check form-switch mt-1">
                                <!-- name 없이 id만, JS가 checked 세팅 + submit 때 hidden 생성 -->
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="includeWeeklyHolidayAllowance">
                                <label class="form-check-label text-xs text-muted" for="includeWeeklyHolidayAllowance">
                                    주 15시간 이상 근무 시 자동 계산
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3줄: 급여/주휴/세금 -->
                    <div class="info-grid mb-3">

                        <div class="info-item">
                            <div class="label">은행</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="bankName"
                                   value="{{member.bankName}}">
                        </div>

                        <div class="info-item">
                            <div class="label">계좌번호</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="bankAccount"
                                   value="{{member.bankAccount}}">
                        </div>

                        <div class="info-item">
                            <div class="label">세금 적용</div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="applyTax">
                                <label class="form-check-label text-xs text-muted" for="applyTax">
                                    3.3% 등 소득세 공제 적용
                                </label>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="label"></div>
                        </div>
                    </div>

                    <!-- 4줄: 보건증 정보 -->
                    <div class="info-grid mb-4">
                        <div class="info-item">
                            <div class="label">보건증 보유 여부</div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="hasHealthCertificate">
                                <label class="form-check-label text-xs text-muted" for="hasHealthCertificate">
                                    보건증 소지
                                </label>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="label">보건증 유효기간</div>
                            <input type="date"
                                   class="form-control form-control-sm"
                                   name="healthCertExpiry"
                                   value="{{member.healthCertExpiry}}">
                        </div>

                        <div class="info-item"></div>
                        <div class="info-item"></div>
                    </div>

                    <div class="info-grid mb-4">
                        <div class="info-item">
                            <div class="label">메모</div>
                            <textarea class="form-control form-control-sm"
                                      name="memo"
                                      rows="2"
                                      placeholder="간단 메모를 남겨두세요."></textarea>
                        </div>
                    </div>

                    <!-- ============ 주간 템플릿 편집 ============ -->
                    <section class="panel panel-schedule mb-3 mt-4">
                        <header class="panel-header d-flex justify-content-between align-items-center">
                            <div>
                                <div class="title-sm">SCHEDULE TEMPLATE</div>
                                <h3 class="title-md mb-0">
                                    {{member.name}} — 주간 템플릿 (월~일)
                                </h3>
                            </div>
                            <div class="text-end">
                                <div class="text-xs text-muted">
                                    10/30/60분 단위 · 드래그로 선택/해제<br>
                                    <span class="text-primary">폼 저장 시 현재 템플릿이 함께 저장됩니다.</span>
                                </div>
                            </div>
                        </header>

                        <div class="panel-body">

                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-xs text-muted">슬롯 단위</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="btn-group btn-group-sm slot-btn-group" id="gridSlotButtons" role="group" aria-label="슬롯 단위 선택">
                                            <button type="button" class="btn btn-outline-secondary active" data-grid-slot="10">10분</button>
                                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30분</button>
                                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="60">1시간</button>
                                        </div>

                                        <!-- 새 버튼: 초기화 / 원래대로 -->
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary"
                                                id="btnGridClear">
                                            초기화
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary"
                                                id="btnGridRestore">
                                            원래대로
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-muted text-end">
                                    마우스를 드래그하거나 클릭하여 <strong>주간 템플릿(계획)</strong>을 설정하세요.<br>
                                    다시 선택하면 <span class="text-primary">해제</span>됩니다.
                                </div>
                            </div>

                            <div class="schedule-board">
                                <div class="table-responsive schedule-table-wrap">
                                    <table class="table schedule-table text-center" id="tableWeek10m">
                                        <thead>
                                        <tr id="theadWeek">
                                            <th class="time-col">시간</th>
                                            <th>월</th>
                                            <th>화</th>
                                            <th>수</th>
                                            <th>목</th>
                                            <th>금</th>
                                            <th>토</th>
                                            <th>일</th>
                                        </tr>
                                        </thead>
                                        <tbody id="tbodyWeek10m"></tbody>
                                    </table>
                                </div>
                                <div class="legend-row text-xs text-muted mt-2">
                                    <span class="legend-box legend-plan"></span> 선택된 템플릿 셀
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- 버튼 영역 (하단) -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <a href="/members"
                           class="btn btn-sm btn-outline-secondary">
                            ← 목록으로
                        </a>
                    </div>
                </form>

            </div>
        </section>

    </div>
</main>

<style>
    /* ===== 전체 배경/레이아웃 ===== */
    body {
        background:
                radial-gradient(circle at top left, #f5f7ff 0, #eef3ff 36%, transparent 70%),
                radial-gradient(circle at bottom right, #fef6f3 0, #ffe8da 40%, #ffe1f0 75%);
    }
    .schedule-shell {
        min-height: calc(100vh - 80px);
    }

    .schedule-layout {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .panel {
        border-radius: 18px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 18px 40px rgba(15,23,42,0.08);
        border: 1px solid rgba(148,163,184,0.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
    }

    .panel-header {
        padding: 1.1rem 1.3rem 0.7rem 1.3rem;
        border-bottom: 1px solid rgba(226,232,240,0.9);
    }
    .panel-header-compact {
        padding-bottom: 0.4rem;
    }
    .panel-body {
        padding: 0.9rem 1.3rem 1.2rem 1.3rem;
    }

    .card-info {
        border-radius: 18px;
    }

    .title-sm {
        font-size: 0.7rem;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: #9ca3af;
        font-weight: 600;
    }
    .title-lg {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }
    .title-md {
        font-size: 0.98rem;
        font-weight: 600;
        color: #111827;
    }
    .text-xs {
        font-size: 0.75rem;
    }

    .name-pill {
        display:inline-flex;
        align-items:center;
        padding:0.2rem 0.7rem;
        border-radius:999px;
        background:#0f172a;
        color:#f9fafb;
        font-size:0.8rem;
    }

    .info-grid {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap:0.9rem 1.2rem;
    }
    .info-item .label {
        font-size:0.7rem;
        text-transform:uppercase;
        letter-spacing:.12em;
        color:#9ca3af;
        margin-bottom:0.25rem;
    }
    .info-item .value {
        font-size:0.9rem;
        font-weight:500;
        color:#111827;
    }

    .form-control-sm,
    .form-select-sm {
        font-size:0.82rem;
        padding:.25rem .5rem;
        border-radius:0.6rem;
    }

    .form-control-sm:focus,
    .form-select-sm:focus {
        box-shadow:0 0 0 1px rgba(59,130,246,0.3);
        border-color:#2563eb;
    }

    /* ===== 주간 템플릿용 추가 스타일 ===== */
    .panel-schedule {
        border-radius: 18px;
    }

    .slot-btn-group .btn {
        border-radius:999px;
        font-size:0.76rem;
        padding-inline:0.6rem;
    }
    .slot-btn-group .btn.active {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
    }

    .schedule-board {
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.9);
        padding:0.8rem;
        background:linear-gradient(135deg, rgba(248,250,252,0.9), rgba(239,246,255,0.95));
    }
    .schedule-table-wrap {
        max-height: 520px;
        overflow:auto;
    }
    .schedule-table {
        margin-bottom:0;
        border-collapse:separate;
        border-spacing:0;
        font-size:0.78rem;
    }
    .schedule-table thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: linear-gradient(135deg,#e5edff,#f9fafb);
        border-bottom:1px solid rgba(209,213,219,0.9);
        font-size:0.75rem;
        font-weight:600;
        color:#4b5563;
    }
    .schedule-table th, .schedule-table td {
        border:0;
        padding:2px 2px;
        vertical-align:middle;
    }
    .schedule-table .time-col {
        width:70px;
        font-variant-numeric:tabular-nums;
        font-size:0.7rem;
        color:#6b7280;
        background:rgba(15,23,42,0.04);
        position: sticky;
        left:0;
        z-index:2;
    }

    .cell-10m {
        height: 14px;
        border-radius: 4px;
        background: #ffffff;
        cursor: pointer;
        user-select: none;
        border:1px solid rgba(229,231,235,0.85);
        transition: background .08s, border-color .08s, box-shadow .08s, transform .04s;
    }
    .cell-10m:hover {
        box-shadow: 0 0 0 1px rgba(59,130,246,0.45);
        transform: translateY(-0.5px);
    }

    /* 선택된 템플릿 셀 */
    .cell-10m.schedule-on {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
        box-shadow: 0 0 0 1px rgba(248,164,76,0.8);
    }

    tr.hour-start > td, tr.hour-start > th {
        border-top: 1px dashed rgba(148,163,184,0.5) !important;
    }

    .legend-row {
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-wrap:wrap;
    }
    .legend-box {
        display:inline-block;
        width:14px;
        height:14px;
        border-radius:4px;
        border:1px solid rgba(209,213,219,0.9);
        vertical-align:middle;
    }
    .legend-plan {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
    }

    @media (max-width: 768px) {
        .schedule-layout {
            gap:0.8rem;
        }
    }

    .status-inline {
        display: inline-flex;
        flex-wrap: nowrap;
        align-items: center;
        gap: 0.25rem;
    }

    .status-inline .form-select-sm {
        width: auto;
        min-width: 110px;
    }
</style>

<!-- ===== memberDto JSON (schedule 포함) ===== -->
<script id="memberData" type="application/json">
{{{memberJson}}}
</script>

<script>
    (function () {
        const HOUR_START = 6;
        const HOUR_END   = 22;
        const DAY_CODES  = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
        const DOW_LABELS = ['월','화','수','목','금','토','일'];

        const tbodyWeek         = document.getElementById('tbodyWeek10m');
        const theadWeek         = document.getElementById('theadWeek');
        const gridSlotButtons   = document.getElementById('gridSlotButtons');
        const btnGridClear      = document.getElementById('btnGridClear');
        const btnGridRestore    = document.getElementById('btnGridRestore');
        const form              = document.getElementById('memberEditForm');

        let gridStepMinutes     = 10;   // 10 / 30 / 60
        let scheduleMapByDay    = {};   // { MON: [{start,end}, ...], ... }
        let originalScheduleMapByDay = {}; // 초기 DTO 기준 스케줄 (원래대로 버튼용)

        let gridDragging        = false;
        let gridDragAdding      = true; // 드래그 중 상태(on/off)

        // ===== JSON 파싱: memberDto.schedule → scheduleMapByDay =====
        let member = {};
        try {
            member = JSON.parse(document.getElementById('memberData').textContent || '{}');
        } catch (e) {
            member = {};
        }

        // 기본 필드들(성별/상태/급여지급일/체크박스) 초기화  <-- 추가
        initBasicFieldsFromMember(member);

        scheduleMapByDay = buildScheduleMapFromMember(member);
        originalScheduleMapByDay = cloneScheduleMap(scheduleMapByDay);

        // ===== 초기 그리드 생성 + 헤더(요일) 세팅 + 스케줄 반영 =====
        buildWeekGrid();
        renderWeekHeadDays();
        paintScheduleFromMap(scheduleMapByDay);

        attachCellDragHandlers();
        attachSlotButtons();
        attachFormSubmitHandler();
        attachResetButtons();

        // ===== functions =====

        // 기본 Getter 값(member.gender, member.status, member.payday, boolean들)로 UI 초기화  <-- 추가
        function initBasicFieldsFromMember(m) {
            if (!form || !m) return;

            // 상태 select (상단)
            const statusSelectTop = document.getElementById('statusSelectTop');
            if (statusSelectTop && m.status) {
                statusSelectTop.value = m.status;
            }

            // 성별 select
            const genderSelect = form.querySelector('select[name="gender"]');
            if (genderSelect && m.gender) {
                genderSelect.value = m.gender;
            }

            // 급여지급일 select
            const paydaySelect = form.querySelector('select[name="payday"]');
            if (paydaySelect && m.payday) {
                paydaySelect.value = m.payday;
            }

            // 주휴수당 체크박스
            const weeklyCb = document.getElementById('includeWeeklyHolidayAllowance');
            if (weeklyCb && typeof m.includeWeeklyHolidayAllowance === 'boolean') {
                weeklyCb.checked = m.includeWeeklyHolidayAllowance;
            }

            // 세금 적용 체크박스
            const applyTaxCb = document.getElementById('applyTax');
            if (applyTaxCb && typeof m.applyTax === 'boolean') {
                applyTaxCb.checked = m.applyTax;
            }

            // 보건증 체크박스
            const healthCb = document.getElementById('hasHealthCertificate');
            if (healthCb && typeof m.hasHealthCertificate === 'boolean') {
                healthCb.checked = m.hasHealthCertificate;
            }
        }

        function buildScheduleMapFromMember(m) {
            const map = {};
            DAY_CODES.forEach(dc => map[dc] = []);

            if (!m || !Array.isArray(m.schedule)) return map;

            m.schedule.forEach(row => {
                if (!row) return;
                const dayCode = String(row.day || '').toUpperCase();
                if (!DAY_CODES.includes(dayCode)) return;

                const startRaw = row.start != null ? String(row.start) : '';
                const endRaw   = row.end   != null ? String(row.end)   : '';

                const startHm = startRaw.slice(0,5); // "HH:mm:ss" → "HH:mm"
                const endHm   = endRaw.slice(0,5);

                if (!startHm || !endHm) return;

                map[dayCode].push({ start: startHm, end: endHm });
            });

            return map;
        }

        function cloneScheduleMap(src) {
            const dst = {};
            DAY_CODES.forEach(dc => {
                const arr = src[dc] || [];
                dst[dc] = arr.map(s => ({ start: s.start, end: s.end }));
            });
            return dst;
        }

        function buildWeekGrid() {
            tbodyWeek.innerHTML = '';

            const totalMinutes = (HOUR_END - HOUR_START) * 60;
            const totalRows    = totalMinutes / gridStepMinutes;

            for (let idx = 0; idx < totalRows; idx++) {
                const absMin = HOUR_START * 60 + idx * gridStepMinutes;
                const h = Math.floor(absMin / 60);
                const m = absMin % 60;
                const hm = pad2(h) + ':' + pad2(m);

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('hour-start');

                let tds = '';
                for (let col = 1; col <= 7; col++) {
                    tds += `<td data-col="${col}"><div class="cell-10m" data-row="${idx}" data-day-index="${col-1}"></div></td>`;
                }

                tr.innerHTML = `
                    <th class="timecell time-col" scope="row">${hm}</th>
                    ${tds}
                `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDays() {
            const ths = theadWeek.querySelectorAll('th');
            for (let i = 0; i < 7; i++) {
                const th = ths[i + 1];
                if (!th) continue;
                th.innerHTML = `${DOW_LABELS[i]}`;
            }
        }

        function paintScheduleFromMap(map) {
            // 전체 초기화
            tbodyWeek.querySelectorAll('.cell-10m').forEach(c => {
                c.classList.remove('schedule-on');
            });

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const dayCode = DAY_CODES[dayIdx];
                const segs = map[dayCode] || [];
                if (!segs.length) continue;

                rows.forEach((tr, rIdx) => {
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if (!cellDiv) return;

                    const interval = rowToInterval(rIdx);
                    const startMin = interval.startMin;
                    const endMin   = interval.endMin;

                    const overlaps = segs.some(seg => {
                        const ss = hmToMin(seg.start);
                        const ee = hmToMin(seg.end);
                        return !(ee <= startMin || ss >= endMin);
                    });

                    if (overlaps) {
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        function rowToInterval(rowIdx) {
            const startMin = HOUR_START * 60 + rowIdx * gridStepMinutes;
            const endMin   = startMin + gridStepMinutes;
            return { startMin, endMin };
        }

        function hmToMin(hm) {
            const parts = String(hm).split(':');
            const h = parseInt(parts[0] || '0', 10);
            const m = parseInt(parts[1] || '0', 10);
            return h * 60 + m;
        }

        function pad2(n) { return String(n).padStart(2, '0'); }

        // === 여기서 HH:mm:ss 로 변경 ===
        function minToHm(min) {
            const h = Math.floor(min / 60);
            const m = min % 60;
            return pad2(h) + ':' + pad2(m) + ':00';
        }

        function clearGridSelection() {
            if (!tbodyWeek) return;
            tbodyWeek.querySelectorAll('.cell-10m').forEach(c => {
                c.classList.remove('schedule-on');
            });
        }

        // ===== 드래그/클릭 선택 =====
        function attachCellDragHandlers() {
            if (!tbodyWeek) return;

            // mousedown: 기준 상태를 정하고 바로 토글 + 드래그 시작
            tbodyWeek.addEventListener('mousedown', (e) => {
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                e.preventDefault();

                gridDragging = true;
                const nowOn  = cell.classList.contains('schedule-on');
                const nextOn = !nowOn;
                gridDragAdding = nextOn;

                toggleCell(cell, nextOn);
            });

            // mouseover: 드래그 중이면 같은 상태로 칠하기
            tbodyWeek.addEventListener('mouseover', (e) => {
                if (!gridDragging) return;
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;
                toggleCell(cell, gridDragAdding);
            });

            // mouseup: 드래그 종료
            window.addEventListener('mouseup', () => {
                if (gridDragging) {
                    gridDragging = false;
                }
            }, { passive: true });
        }

        function toggleCell(cell, on) {
            if (on) {
                cell.classList.add('schedule-on');
            } else {
                cell.classList.remove('schedule-on');
            }
        }

        // ===== 슬롯 단위 버튼 =====
        function attachSlotButtons() {
            if (!gridSlotButtons) return;

            gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mins = parseInt(btn.dataset.gridSlot, 10);
                    if (!mins || mins === gridStepMinutes) return;

                    gridStepMinutes = mins;

                    // 버튼 active 처리
                    gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // 그리드 재구성 후 현재 scheduleMapByDay 기준으로 다시 칠함
                    buildWeekGrid();
                    renderWeekHeadDays();
                    paintScheduleFromMap(scheduleMapByDay);
                    attachCellDragHandlers(); // 다시 바인딩
                });
            });
        }

        // ===== 초기화 / 원래대로 버튼 =====
        function attachResetButtons() {
            if (btnGridClear) {
                btnGridClear.addEventListener('click', () => {
                    clearGridSelection();
                });
            }
            if (btnGridRestore) {
                btnGridRestore.addEventListener('click', () => {
                    clearGridSelection();
                    paintScheduleFromMap(originalScheduleMapByDay);
                    // 현재 view 기준으로만 칠하고, scheduleMapByDay는 그대로 둔다
                });
            }
        }

        // === 체크박스를 true/false 로 강제 변환 ===
        function normalizeBooleanCheckbox(id, fieldName) {
            if (!form) return;
            const cb = document.getElementById(id);
            if (!cb) return;

            // 기존 hidden 제거
            Array.from(form.querySelectorAll('input[type="hidden"][name="' + fieldName + '"]'))
                    .forEach(el => el.remove());

            // 체크박스 name 제거 (중복 파라미터 방지)
            if (cb.hasAttribute('name')) {
                cb.removeAttribute('name');
            }

            // 현재 체크 상태 기준으로 true/false 하나만 전송
            appendHidden(fieldName, cb.checked ? 'true' : 'false');
        }

        // ===== 폼 submit 시: 불리언 + 그리드 상태를 hidden input으로 생성 =====
        function attachFormSubmitHandler() {
            if (!form) return;

            form.addEventListener('submit', () => {
                // 1) 불리언 필드 보정 (항상 true/false)
                normalizeBooleanCheckbox('includeWeeklyHolidayAllowance', 'includeWeeklyHolidayAllowance');
                normalizeBooleanCheckbox('applyTax', 'applyTax');
                normalizeBooleanCheckbox('hasHealthCertificate', 'hasHealthCertificate');

                // 2) 기존 schedule hidden 제거
                Array.from(form.querySelectorAll('input[name^="schedule["]')).forEach(el => el.remove());

                // 3) 그리드 → 구간 수집
                const daySegMap = collectSegmentsFromGrid(); // { MON: [{start,end}], ... }

                let idx = 0;
                DAY_CODES.forEach(dayCode => {
                    const segs = daySegMap[dayCode] || [];
                    segs.forEach(seg => {
                        appendHidden(`schedule[${idx}].day`, dayCode);
                        appendHidden(`schedule[${idx}].start`, seg.start);
                        appendHidden(`schedule[${idx}].end`, seg.end);
                        idx++;
                    });
                });
                // 기본 submit 진행
            });
        }

        function collectSegmentsFromGrid() {
            const result = {};
            DAY_CODES.forEach(dc => result[dc] = []);

            if (!tbodyWeek) return result;

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const indices = [];

                rows.forEach((tr, rIdx) => {
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if (cellDiv && cellDiv.classList.contains('schedule-on')) {
                        indices.push(rIdx);
                    }
                });

                if (!indices.length) continue;

                const merged = mergeConsecutive(indices);
                const dayCode = DAY_CODES[dayIdx];

                merged.forEach(([sIdx, eIdx]) => {
                    const startMin = HOUR_START * 60 + sIdx * gridStepMinutes;
                    const endMin   = HOUR_START * 60 + (eIdx + 1) * gridStepMinutes;

                    result[dayCode].push({
                        start: minToHm(startMin),
                        end:   minToHm(endMin)
                    });
                });
            }

            // 폼 저장 전에 이 상태를 scheduleMapByDay 에도 반영
            scheduleMapByDay = result;
            return result;
        }

        function mergeConsecutive(arr) {
            if (!arr.length) return [];
            const sorted = arr.slice().sort((a,b) => a - b);
            const out = [];
            let s = sorted[0];
            let prev = sorted[0];

            for (let i = 1; i < sorted.length; i++) {
                const v = sorted[i];
                if (v === prev + 1) {
                    prev = v;
                    continue;
                }
                out.push([s, prev]);
                s = prev = v;
            }
            out.push([s, prev]);
            return out;
        }

        function appendHidden(name, value) {
            const input = document.createElement('input');
            input.type  = 'hidden';
            input.name  = name;
            input.value = value;
            form.appendChild(input);
        }

    })();
</script>

{{>layouts/footer}}
