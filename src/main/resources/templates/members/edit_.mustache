{{>layouts/header}}
{{>layouts/toast}}

<main class="schedule-shell py-4">
    <div class="schedule-layout container">

        <!-- ============ ìƒë‹¨: í•œ ëª…ì˜ ì´ë¦„ + ìƒíƒœ ì„ íƒ + ìƒë‹¨ ì €ì¥ ë²„íŠ¼ ============ -->
        <section class="panel card-info mb-3">
            <header class="panel-header panel-header-compact d-flex justify-content-between align-items-center">
                <div>
                    <div class="title-sm">STAFF EDIT</div>

                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <h2 class="title-lg mb-0">ì•„ë¥´ë°”ì´íŠ¸ ì •ë³´ ìˆ˜ì •</h2>
                        <span class="name-pill">
                            {{member.name}}
                        </span>

                        <!-- ì´ë¦„ ì˜† ìƒíƒœ ì„ íƒ ë“œë¡­ë‹¤ìš´ (form ì†ì„±ìœ¼ë¡œ í¼ì— ì—°ê²°) -->
                        <div class="status-inline ms-2">
                            <span class="text-xs text-muted mb-0">ìƒíƒœ</span>
                            <select id="statusSelectTop"
                                    class="form-select form-select-sm"
                                    name="status"
                                    form="memberEditForm"
                                    required>
                                <option value="WORKING">ê·¼ë¬´ì¤‘</option>
                                <option value="WAITING">ì‹œì‘ì „</option>
                                <option value="RESTING">íœ´ì‹ì¤‘</option>
                                <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                                <option value="RESIGNED">í‡´ì‚¬</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-xs text-muted mt-1">
                        {{#member}}
                            <span>
                            (ë“±ë¡ì¼:
                                {{#createdAt}}
                                    {{createdAt}}
                                {{/createdAt}}
                                {{^createdAt}}
                                    -
                                {{/createdAt}}
                                )
                        </span>
                        {{/member}}
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ë: ìƒë‹¨ ì €ì¥ ë²„íŠ¼ -->
                <div class="d-flex flex-column align-items-end gap-2">

                        <a href="/members"
                           class="btn btn-sm btn-outline-secondary">
                            ëª©ë¡ìœ¼ë¡œ
                        </a>

                    <button type="submit"
                            form="memberEditForm"
                            class="btn btn-sm btn-primary">
                        ì €ì¥í•˜ê¸°
                    </button>
                    <!-- ë²„íŠ¼ ì˜ì—­ (í•˜ë‹¨) -->
                </div>
            </header>
        </section>

        <!-- ============ íŒ¨ë„: ê¸°ë³¸ ì •ë³´ í¸ì§‘ í¼ ============ -->
        <section class="panel mb-3">
            <div class="panel-body">

                <!-- action / method / csrfëŠ” í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ -->
                <form id="memberEditForm" method="post" action="/members/{{member.id}}/update" autocomplete="off">

                    <!-- 1ì¤„: ê¸°ë³¸ ì •ë³´ -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <div class="label">ì´ë¦„</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="name"
                                   value="{{member.name}}"
                                   required>
                        </div>

                        <div class="info-item">
                            <div class="label">ì„±ë³„</div>
                            <select class="form-select form-select-sm"
                                    name="gender"
                                    required>
                                <option value="">ì„ íƒ</option>
                                <option value="M">ë‚¨</option>
                                <option value="F">ì—¬</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <div class="label">ì „í™”ë²ˆí˜¸</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="phone"
                                   value="{{member.phone}}">
                        </div>

                        <div class="info-item">
                            <div class="label">ì´ë©”ì¼</div>
                            <input type="email"
                                   class="form-control form-control-sm"
                                   name="email"
                                   value="{{member.email}}">
                        </div>
                    </div>

                    <!-- 2ì¤„: ì‹œì‘ì¼/ì‹œê¸‰/ê¸‰ì—¬ì§€ê¸‰ì¼/ì£¼íœ´ìˆ˜ë‹¹ -->
                    <div class="info-grid mb-3">
                        <div class="info-item">
                            <div class="label">ì‹œì‘ì¼(ê·¼ë¬´)</div>
                            <input type="date"
                                   class="form-control form-control-sm"
                                   name="startDate"
                                   value="{{member.startDate}}">
                        </div>
                        <div class="info-item">
                            <div class="label">ì‹œê¸‰(ì›)</div>
                            <input type="number"
                                   min="0"
                                   step="10"
                                   class="form-control form-control-sm text-end"
                                   name="hourlyWage"
                                   value="{{member.hourlyWage}}">
                        </div>
                        <div class="info-item">
                            <div class="label">ê¸‰ì—¬ì§€ê¸‰ì¼</div>
                            <select class="form-select form-select-sm"
                                    name="payday"
                                    required>
                                <option value="">ì„ íƒ</option>
                                <option value="EOM">ë§ì¼</option>
                                <!-- ğŸ”¹ 1 ~ 31ì¼ê¹Œì§€ ëª¨ë‘ ê³ ì • ì˜µì…˜ìœ¼ë¡œ í‘œì‹œ -->
                                <option value="1">1ì¼</option>
                                <option value="2">2ì¼</option>
                                <option value="3">3ì¼</option>
                                <option value="4">4ì¼</option>
                                <option value="5">5ì¼</option>
                                <option value="6">6ì¼</option>
                                <option value="7">7ì¼</option>
                                <option value="8">8ì¼</option>
                                <option value="9">9ì¼</option>
                                <option value="10">10ì¼</option>
                                <option value="11">11ì¼</option>
                                <option value="12">12ì¼</option>
                                <option value="13">13ì¼</option>
                                <option value="14">14ì¼</option>
                                <option value="15">15ì¼</option>
                                <option value="16">16ì¼</option>
                                <option value="17">17ì¼</option>
                                <option value="18">18ì¼</option>
                                <option value="19">19ì¼</option>
                                <option value="20">20ì¼</option>
                                <option value="21">21ì¼</option>
                                <option value="22">22ì¼</option>
                                <option value="23">23ì¼</option>
                                <option value="24">24ì¼</option>
                                <option value="25">25ì¼</option>
                                <option value="26">26ì¼</option>
                                <option value="27">27ì¼</option>
                                <option value="28">28ì¼</option>
                                <option value="29">29ì¼</option>
                                <option value="30">30ì¼</option>
                                <option value="31">31ì¼</option>
                            </select>
                        </div>

                        <div class="info-item">
                            <div class="label">ì£¼íœ´ìˆ˜ë‹¹ ì ìš©</div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="includeWeeklyHolidayAllowance"
                                       name="includeWeeklyHolidayAllowance">
                                <label class="form-check-label text-xs text-muted" for="includeWeeklyHolidayAllowance">
                                    ì£¼ 15ì‹œê°„ ì´ìƒ ê·¼ë¬´ ì‹œ ìë™ ê³„ì‚°
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 3ì¤„: ê¸‰ì—¬/ì£¼íœ´/ì„¸ê¸ˆ -->
                    <div class="info-grid mb-3">

                        <div class="info-item">
                            <div class="label">ì€í–‰</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="bankName"
                                   value="{{member.bankName}}">
                        </div>

                        <div class="info-item">
                            <div class="label">ê³„ì¢Œë²ˆí˜¸</div>
                            <input type="text"
                                   class="form-control form-control-sm"
                                   name="bankAccount"
                                   value="{{member.bankAccount}}">
                        </div>

                        <div class="info-item">
                            <div class="label">ì„¸ê¸ˆ ì ìš©</div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="applyTax"
                                       name="applyTax">
                                <label class="form-check-label text-xs text-muted" for="applyTax">
                                    3.3% ë“± ì†Œë“ì„¸ ê³µì œ ì ìš©
                                </label>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="label"></div>
                        </div>
                    </div>

                    <!-- 4ì¤„: ë³´ê±´ì¦ ì •ë³´ -->
                    <div class="info-grid mb-4">
                        <div class="info-item">
                            <div class="label">ë³´ê±´ì¦ ë³´ìœ  ì—¬ë¶€</div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="hasHealthCertificate"
                                       name="hasHealthCertificate">
                                <label class="form-check-label text-xs text-muted" for="hasHealthCertificate">
                                    ë³´ê±´ì¦ ì†Œì§€
                                </label>
                            </div>
                        </div>

                        <div class="info-item">
                            <div class="label">ë³´ê±´ì¦ ìœ íš¨ê¸°ê°„</div>
                            <div class="d-flex align-items-center gap-2">
                                <input type="date"
                                       class="form-control form-control-sm"
                                       name="healthCertExpiry"
                                       id="healthCertExpiry"
                                       value="{{member.healthCertExpiryStr}}">
                            </div>

                        </div>
                        <div class="info-item"></div>
                        <div>
                            <button type="button"
                                    id="btnOpenPayEstimate"
                                    class="btn btn-sm btn-outline-primary">
                                ì˜ˆìƒ ê¸‰ì—¬ ë³´ê¸°
                            </button>
                        </div>
                    </div>

                    <div class="info-grid mb-4">
                        <div class="info-item">
                            <div class="label">ë©”ëª¨</div>
                            <textarea class="form-control form-control-sm"
                                      name="memo"
                                      rows="2"
                                      placeholder="ê°„ë‹¨ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë‘ì„¸ìš”."></textarea>
                        </div>
                    </div>

                    <!-- ============ ì£¼ê°„ í…œí”Œë¦¿ í¸ì§‘ ============ -->
                    <section class="panel panel-schedule mb-3 mt-4">
                        <header class="panel-header d-flex justify-content-between align-items-center">
                            <div>
                                <div class="title-sm">SCHEDULE TEMPLATE</div>
                                <h3 class="title-md mb-0">
                                    {{member.name}} â€” ì£¼ê°„ í…œí”Œë¦¿ (ì›”~ì¼)
                                </h3>
                            </div>
                            <div class="text-end">
                                <div class="text-xs text-muted">
                                    10/30/60ë¶„ ë‹¨ìœ„ Â· ë“œë˜ê·¸ë¡œ ì„ íƒ/í•´ì œ<br>
                                    <span class="text-primary">í¼ ì €ì¥ ì‹œ í˜„ì¬ í…œí”Œë¦¿ì´ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.</span>
                                </div>
                            </div>
                        </header>

                        <div class="panel-body">

                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-xs text-muted">ìŠ¬ë¡¯ ë‹¨ìœ„</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="btn-group btn-group-sm slot-btn-group" id="gridSlotButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„ ì„ íƒ">
                                            <button type="button" class="btn btn-outline-secondary active" data-grid-slot="10">10ë¶„</button>
                                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30ë¶„</button>
                                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="60">1ì‹œê°„</button>
                                        </div>

                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary"
                                                id="btnGridClear">
                                            ì´ˆê¸°í™”
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-secondary"
                                                id="btnGridRestore">
                                            ì›ë˜ëŒ€ë¡œ
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-muted text-end">
                                    ë§ˆìš°ìŠ¤ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ <strong>ì£¼ê°„ í…œí”Œë¦¿(ê³„íš)</strong>ì„ ì„¤ì •í•˜ì„¸ìš”.<br>
                                    ë‹¤ì‹œ ì„ íƒí•˜ë©´ <span class="text-primary">í•´ì œ</span>ë©ë‹ˆë‹¤.
                                </div>
                            </div>

                            <div class="schedule-board">
                                <div class="table-responsive schedule-table-wrap">
                                    <table class="table schedule-table text-center" id="tableWeek10m">
                                        <thead>
                                        <tr id="theadWeek">
                                            <th class="time-col">ì‹œê°„</th>
                                            <th>ì›”</th>
                                            <th>í™”</th>
                                            <th>ìˆ˜</th>
                                            <th>ëª©</th>
                                            <th>ê¸ˆ</th>
                                            <th>í† </th>
                                            <th>ì¼</th>
                                        </tr>
                                        </thead>
                                        <tbody id="tbodyWeek10m"></tbody>
                                    </table>
                                </div>
                                <div class="legend-row text-xs text-muted mt-2">
                                    <span class="legend-box legend-plan"></span> ì„ íƒëœ í…œí”Œë¦¿ ì…€
                                </div>
                            </div>

                        </div>
                    </section>

                </form>

            </div>
        </section>

    </div>
</main>

<style>
    /* ===== ì „ì²´ ë°°ê²½/ë ˆì´ì•„ì›ƒ ===== */
    body {
        background:
                radial-gradient(circle at top left, #f5f7ff 0, #eef3ff 36%, transparent 70%),
                radial-gradient(circle at bottom right, #fef6f3 0, #ffe8da 40%, #ffe1f0 75%);
    }
    .schedule-shell {
        min-height: calc(100vh - 80px);
    }

    .schedule-layout {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .panel {
        border-radius: 18px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 18px 40px rgba(15,23,42,0.08);
        border: 1px solid rgba(148,163,184,0.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
    }

    .panel-header {
        padding: 1.1rem 1.3rem 0.7rem 1.3rem;
        border-bottom: 1px solid rgba(226,232,240,0.9);
    }
    .panel-header-compact {
        padding-bottom: 0.4rem;
    }
    .panel-body {
        padding: 0.9rem 1.3rem 1.2rem 1.3rem;
    }

    .card-info {
        border-radius: 18px;
    }

    .title-sm {
        font-size: 0.7rem;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: #9ca3af;
        font-weight: 600;
    }
    .title-lg {
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }
    .title-md {
        font-size: 0.98rem;
        font-weight: 600;
        color: #111827;
    }
    .text-xs {
        font-size: 0.75rem;
    }

    .name-pill {
        display:inline-flex;
        align-items:center;
        padding:0.2rem 0.7rem;
        border-radius:999px;
        background:#0f172a;
        color:#f9fafb;
        font-size:0.8rem;
    }

    .info-grid {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap:0.9rem 1.2rem;
    }
    .info-item .label {
        font-size:0.7rem;
        text-transform:uppercase;
        letter-spacing:.12em;
        color:#9ca3af;
        margin-bottom:0.25rem;
    }
    .info-item .value {
        font-size:0.9rem;
        font-weight:500;
        color:#111827;
    }

    .form-control-sm,
    .form-select-sm {
        font-size:0.82rem;
        padding:.25rem .5rem;
        border-radius:0.6rem;
    }

    .form-control-sm:focus,
    .form-select-sm:focus {
        box-shadow:0 0 0 1px rgba(59,130,246,0.3);
        border-color:#2563eb;
    }

    /* ===== ì£¼ê°„ í…œí”Œë¦¿ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ ===== */
    .panel-schedule {
        border-radius: 18px;
    }

    .slot-btn-group .btn {
        border-radius:999px;
        font-size:0.76rem;
        padding-inline:0.6rem;
    }
    .slot-btn-group .btn.active {
        background:#0f172a;
        color:#f9fafb;
        border-color:#0f172a;
    }

    .schedule-board {
        border-radius:14px;
        border:1px solid rgba(226,232,240,0.9);
        padding:0.8rem;
        background:linear-gradient(135deg, rgba(248,250,252,0.9), rgba(239,246,255,0.95));
    }
    .schedule-table-wrap {
        max-height: 520px;
        overflow:auto;
    }
    .schedule-table {
        margin-bottom:0;
        border-collapse:separate;
        border-spacing:0;
        font-size:0.78rem;
    }
    .schedule-table thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: linear-gradient(135deg,#e5edff,#f9fafb);
        border-bottom:1px solid rgba(209,213,219,0.9);
        font-size:0.75rem;
        font-weight:600;
        color:#4b5563;
    }
    .schedule-table th, .schedule-table td {
        border:0;
        padding:2px 2px;
        vertical-align:middle;
    }
    .schedule-table .time-col {
        width:70px;
        font-variant-numeric:tabular-nums;
        font-size:0.7rem;
        color:#6b7280;
        background:rgba(15,23,42,0.04);
        position: sticky;
        left:0;
        z-index:2;
    }

    .cell-10m {
        height: 14px;
        border-radius: 4px;
        background: #ffffff;
        cursor: pointer;
        user-select: none;
        border:1px solid rgba(229,231,235,0.85);
        transition: background .08s, border-color .08s, box-shadow .08s, transform .04s;
    }
    .cell-10m:hover {
        box-shadow: 0 0 0 1px rgba(59,130,246,0.45);
        transform: translateY(-0.5px);
    }

    .cell-10m.schedule-on {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
        box-shadow: 0 0 0 1px rgba(248,164,76,0.8);
    }

    tr.hour-start > td, tr.hour-start > th {
        border-top: 1px dashed rgba(148,163,184,0.5) !important;
    }

    .legend-row {
        display:flex;
        align-items:center;
        gap:0.5rem;
        flex-wrap:wrap;
    }
    .legend-box {
        display:inline-block;
        width:14px;
        height:14px;
        border-radius:4px;
        border:1px solid rgba(209,213,219,0.9);
        vertical-align:middle;
    }
    .legend-plan {
        background: rgba(248, 164, 76, 0.6);
        border-color: rgba(248, 164, 76, 0.9);
    }

    @media (max-width: 768px) {
        .schedule-layout {
            gap:0.8rem;
        }
    }

    .status-inline {
        display: inline-flex;
        flex-wrap: nowrap;
        align-items: center;
        gap: 0.25rem;
    }

    .status-inline .form-select-sm {
        width: auto;
        min-width: 110px;
    }
</style>

<!-- ===== memberDto JSON (schedule í¬í•¨) ===== -->
<script id="memberData" type="application/json">
{{{memberJson}}}
</script>

<script>
    (function () {
        const HOUR_START = 6;
        const HOUR_END   = 22;
        const DAY_CODES  = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
        const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

        const tbodyWeek         = document.getElementById('tbodyWeek10m');
        const theadWeek         = document.getElementById('theadWeek');
        const gridSlotButtons   = document.getElementById('gridSlotButtons');
        const btnGridClear      = document.getElementById('btnGridClear');
        const btnGridRestore    = document.getElementById('btnGridRestore');
        const form              = document.getElementById('memberEditForm');

        let gridStepMinutes     = 10;
        let scheduleMapByDay    = {};
        let originalScheduleMapByDay = {};

        let gridDragging        = false;
        let gridDragAdding      = true;

        let member = {};
        try {
            member = JSON.parse(document.getElementById('memberData').textContent || '{}');
        } catch (e) {
            member = {};
        }

        // ê¸°ë³¸ í•„ë“œë“¤ ì´ˆê¸°í™” (status, gender, payday, booleanë“¤)
        initBasicFieldsFromMember(member);

        scheduleMapByDay = buildScheduleMapFromMember(member);
        originalScheduleMapByDay = cloneScheduleMap(scheduleMapByDay);

        buildWeekGrid();
        renderWeekHeadDays();
        paintScheduleFromMap(scheduleMapByDay);

        attachCellDragHandlers();
        attachSlotButtons();
        attachFormSubmitHandler();
        attachResetButtons();

        function initBasicFieldsFromMember(m) {
            if (!form || !m) return;

            const statusSelectTop = document.getElementById('statusSelectTop');
            if (statusSelectTop && m.status) {
                statusSelectTop.value = m.status;
            }

            const genderSelect = form.querySelector('select[name="gender"]');
            if (genderSelect && m.gender) {
                genderSelect.value = m.gender;
            }

            const paydaySelect = form.querySelector('select[name="payday"]');
            if (paydaySelect && m.payday) {
                paydaySelect.value = m.payday;   // ğŸ”¹ EOM ë˜ëŠ” "1"~"31" ìë™ ì„ íƒ
            }

            const weeklyCb = document.getElementById('includeWeeklyHolidayAllowance');
            if (weeklyCb && typeof m.includeWeeklyHolidayAllowance === 'boolean') {
                weeklyCb.checked = m.includeWeeklyHolidayAllowance;
            }

            const applyTaxCb = document.getElementById('applyTax');
            if (applyTaxCb && typeof m.applyTax === 'boolean') {
                applyTaxCb.checked = m.applyTax;
            }

            const healthCb = document.getElementById('hasHealthCertificate');
            if (healthCb && typeof m.hasHealthCertificate === 'boolean') {
                healthCb.checked = m.hasHealthCertificate;
            }
        }

        function buildScheduleMapFromMember(m) {
            const map = {};
            DAY_CODES.forEach(dc => map[dc] = []);

            if (!m || !Array.isArray(m.schedule)) return map;

            m.schedule.forEach(row => {
                if (!row) return;
                const dayCode = String(row.day || '').toUpperCase();
                if (!DAY_CODES.includes(dayCode)) return;

                const startRaw = row.start != null ? String(row.start) : '';
                const endRaw   = row.end   != null ? String(row.end)   : '';

                const startHm = startRaw.slice(0,5);
                const endHm   = endRaw.slice(0,5);

                if (!startHm || !endHm) return;

                map[dayCode].push({ start: startHm, end: endHm });
            });

            return map;
        }

        function cloneScheduleMap(src) {
            const dst = {};
            DAY_CODES.forEach(dc => {
                const arr = src[dc] || [];
                dst[dc] = arr.map(s => ({ start: s.start, end: s.end }));
            });
            return dst;
        }

        function buildWeekGrid() {
            tbodyWeek.innerHTML = '';

            const totalMinutes = (HOUR_END - HOUR_START) * 60;
            const totalRows    = totalMinutes / gridStepMinutes;

            for (let idx = 0; idx < totalRows; idx++) {
                const absMin = HOUR_START * 60 + idx * gridStepMinutes;
                const h = Math.floor(absMin / 60);
                const m = absMin % 60;
                const hm = pad2(h) + ':' + pad2(m);

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('hour-start');

                let tds = '';
                for (let col = 1; col <= 7; col++) {
                    tds += `<td data-col="${col}"><div class="cell-10m" data-row="${idx}" data-day-index="${col-1}"></div></td>`;
                }

                tr.innerHTML = `
                    <th class="timecell time-col" scope="row">${hm}</th>
                    ${tds}
                `;
                tbodyWeek.appendChild(tr);
            }
        }

        function renderWeekHeadDays() {
            const ths = theadWeek.querySelectorAll('th');
            for (let i = 0; i < 7; i++) {
                const th = ths[i + 1];
                if (!th) continue;
                th.innerHTML = `${DOW_LABELS[i]}`;
            }
        }

        function paintScheduleFromMap(map) {
            tbodyWeek.querySelectorAll('.cell-10m').forEach(c => {
                c.classList.remove('schedule-on');
            });

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const dayCode = DAY_CODES[dayIdx];
                const segs = map[dayCode] || [];
                if (!segs.length) continue;

                rows.forEach((tr, rIdx) => {
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if (!cellDiv) return;

                    const interval = rowToInterval(rIdx);
                    const startMin = interval.startMin;
                    const endMin   = interval.endMin;

                    const overlaps = segs.some(seg => {
                        const ss = hmToMin(seg.start);
                        const ee = hmToMin(seg.end);
                        return !(ee <= startMin || ss >= endMin);
                    });

                    if (overlaps) {
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        function rowToInterval(rowIdx) {
            const startMin = HOUR_START * 60 + rowIdx * gridStepMinutes;
            const endMin   = startMin + gridStepMinutes;
            return { startMin, endMin };
        }

        function hmToMin(hm) {
            const parts = String(hm).split(':');
            const h = parseInt(parts[0] || '0', 10);
            const m = parseInt(parts[1] || '0', 10);
            return h * 60 + m;
        }

        function pad2(n) { return String(n).padStart(2, '0'); }

        function minToHm(min) {
            const h = Math.floor(min / 60);
            const m = min % 60;
            return pad2(h) + ':' + pad2(m) + ':00';
        }

        function clearGridSelection() {
            if (!tbodyWeek) return;
            tbodyWeek.querySelectorAll('.cell-10m').forEach(c => {
                c.classList.remove('schedule-on');
            });
        }

        function attachCellDragHandlers() {
            if (!tbodyWeek) return;

            tbodyWeek.addEventListener('mousedown', (e) => {
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;

                e.preventDefault();

                gridDragging = true;
                const nowOn  = cell.classList.contains('schedule-on');
                const nextOn = !nowOn;
                gridDragAdding = nextOn;

                toggleCell(cell, nextOn);
            });

            tbodyWeek.addEventListener('mouseover', (e) => {
                if (!gridDragging) return;
                const cell = e.target.closest('.cell-10m');
                if (!cell || !tbodyWeek.contains(cell)) return;
                toggleCell(cell, gridDragAdding);
            });

            window.addEventListener('mouseup', () => {
                if (gridDragging) {
                    gridDragging = false;
                }
            }, { passive: true });
        }

        function toggleCell(cell, on) {
            if (on) {
                cell.classList.add('schedule-on');
            } else {
                cell.classList.remove('schedule-on');
            }
        }

        function attachSlotButtons() {
            if (!gridSlotButtons) return;

            gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mins = parseInt(btn.dataset.gridSlot, 10);
                    if (!mins || mins === gridStepMinutes) return;

                    gridStepMinutes = mins;

                    gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    buildWeekGrid();
                    renderWeekHeadDays();
                    paintScheduleFromMap(scheduleMapByDay);
                    attachCellDragHandlers();
                });
            });
        }

        function attachResetButtons() {
            if (btnGridClear) {
                btnGridClear.addEventListener('click', () => {
                    clearGridSelection();
                });
            }
            if (btnGridRestore) {
                btnGridRestore.addEventListener('click', () => {
                    clearGridSelection();
                    paintScheduleFromMap(originalScheduleMapByDay);
                });
            }
        }

        function normalizeBooleanCheckbox(id, fieldName) {
            if (!form) return;
            const cb = document.getElementById(id);
            if (!cb) return;

            Array.from(form.querySelectorAll('input[type="hidden"][name="' + fieldName + '"]'))
                    .forEach(el => el.remove());

            if (cb.hasAttribute('name')) {
                cb.removeAttribute('name');
            }

            appendHidden(fieldName, cb.checked ? 'true' : 'false');
        }

        function attachFormSubmitHandler() {
            if (!form) return;

            form.addEventListener('submit', () => {
                normalizeBooleanCheckbox('includeWeeklyHolidayAllowance', 'includeWeeklyHolidayAllowance');
                normalizeBooleanCheckbox('applyTax', 'applyTax');
                normalizeBooleanCheckbox('hasHealthCertificate', 'hasHealthCertificate');

                Array.from(form.querySelectorAll('input[name^="schedule["]')).forEach(el => el.remove());

                const daySegMap = collectSegmentsFromGrid();

                let idx = 0;
                DAY_CODES.forEach(dayCode => {
                    const segs = daySegMap[dayCode] || [];
                    segs.forEach(seg => {
                        appendHidden(`schedule[${idx}].day`, dayCode);
                        appendHidden(`schedule[${idx}].start`, seg.start);
                        appendHidden(`schedule[${idx}].end`, seg.end);
                        idx++;
                    });
                });
            });
        }

        function collectSegmentsFromGrid() {
            const result = {};
            DAY_CODES.forEach(dc => result[dc] = []);

            if (!tbodyWeek) return result;

            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const indices = [];

                rows.forEach((tr, rIdx) => {
                    const cellDiv = tr.querySelector(`td[data-col="${dayIdx+1}"] .cell-10m`);
                    if (cellDiv && cellDiv.classList.contains('schedule-on')) {
                        indices.push(rIdx);
                    }
                });

                if (!indices.length) continue;

                const merged = mergeConsecutive(indices);
                const dayCode = DAY_CODES[dayIdx];

                merged.forEach(([sIdx, eIdx]) => {
                    const startMin = HOUR_START * 60 + sIdx * gridStepMinutes;
                    const endMin   = HOUR_START * 60 + (eIdx + 1) * gridStepMinutes;

                    result[dayCode].push({
                        start: minToHm(startMin),
                        end:   minToHm(endMin)
                    });
                });
            }

            scheduleMapByDay = result;
            return result;
        }

        function mergeConsecutive(arr) {
            if (!arr.length) return [];
            const sorted = arr.slice().sort((a,b) => a - b);
            const out = [];
            let s = sorted[0];
            let prev = sorted[0];

            for (let i = 1; i < sorted.length; i++) {
                const v = sorted[i];
                if (v === prev + 1) {
                    prev = v;
                    continue;
                }
                out.push([s, prev]);
                s = prev = v;
            }
            out.push([s, prev]);
            return out;
        }

        function appendHidden(name, value) {
            const input = document.createElement('input');
            input.type  = 'hidden';
            input.name  = name;
            input.value = value;
            form.appendChild(input);
        }

    })();

    document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('btnOpenPayEstimate');
        if (!btn) return;

        btn.addEventListener('click', function () {
            const memberId = '{{member.id}}';

            if (!memberId) {
                alert('ì˜ˆìƒ ê¸‰ì—¬ë¥¼ ì¡°íšŒí•  ì•„ë¥´ë°”ì´íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const today = new Date();

            const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const day    = monday.getDay();
            const offset = (day + 6) % 7;
            monday.setDate(monday.getDate() - offset);

            const sunday = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + 6);

            function pad2(n) {
                return String(n).padStart(2, '0');
            }
            function toIso(d) {
                return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate());
            }

            const weekStart = toIso(monday);
            const weekEnd   = toIso(sunday);

            const url =
                    '/members/pay-estimate'
                    + '?memberId=' + encodeURIComponent(memberId)
                    + '&weekStart=' + encodeURIComponent(weekStart)
                    + '&weekEnd=' + encodeURIComponent(weekEnd);

            window.open(
                    url,
                    'payEstimatePopup',
                    'width=1200,height=900,scrollbars=yes,resizable=yes'
            );
        });
    });
</script>

{{>layouts/footer}}
