{{>layouts/header_}}

<main class="container my-4">
    <!-- í•˜ë‹¨: ì›”ê°„ í†µê³„ (ì£¼ì°¨ë³„ í•©ê³„) + ì¢Œì¸¡ì— ì•„ë¥´ë°”ì´íŠ¸ìƒ ì´ë¦„ + ë§ˆì§€ë§‰ ì›”ê°„í•©ê³„ ì»¬ëŸ¼ -->
    <div class="card">
        <div class="card-header week-card-header-blue fw-bold d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <span>ì›”ê°„ ê·¼ë¬´ í†µê³„ (ì£¼ì°¨ë³„)</span>

                <!-- ğŸ”¹ ìƒíƒœ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                <select id="statusSelect" class="form-select status-header-select">
                    <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                    <option value="WAITING">ì‹œì‘ì „</option>
                    <option value="RESTING">íœ´ì‹ì¤‘</option>
                    <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                    <option value="RESIGNED">í‡´ì‚¬</option>
                </select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- ğŸ”¹ â€œì›”â€ ë‹¨ìœ„ ì´ë™ -->
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-light">â—€ ì§€ë‚œë‹¬</button>
                <span id="weekRangeLabelRight" class="small text-light px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-light">ë‹¹ì›”</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-light">ë‹¤ìŒë‹¬ â–¶</button>
            </div>
        </div>
        <div class="card-body">
            <div id="noMemberState" class="text-muted small d-none">
                í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </div>

            <div id="weekCalendarWrapper">
                <!-- ì›”ê°„ ë©¤ë²„ Ã— ì£¼ì°¨ í…Œì´ë¸” -->
                <div class="week-calendar-grid" id="weekCalendarGrid">
                    <!-- JSì—ì„œ table ìƒì„± -->
                </div>
            </div>

            <div class="small text-muted mt-2">
                * ê° ì£¼ì°¨ ì»¬ëŸ¼ì—ëŠ” <strong>ê³„íš ê·¼ë¬´ì‹œê°„</strong>ê³¼ <strong>ì‹¤ì œ ê·¼ë¬´ì‹œê°„</strong>ì´<br>
                &nbsp;&nbsp;ë‘ ê°œì˜ ìƒ‰ìƒì´ ë‹¤ë¥¸ ì‚¬ê°í˜•(Plan/Actual)ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ì¢Œì¸¡ì—ëŠ” ìƒíƒœ í•„í„°ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ì•„ë¥´ë°”ì´íŠ¸ìƒ ì´ë¦„ì´ í‘œì‹œë˜ë©°,<br>
                &nbsp;&nbsp;ê° í–‰ì€ í•´ë‹¹ ì•„ë¥´ë°”ì´íŠ¸ìƒì˜ <strong>ì£¼ì°¨ë³„ ì‹¤ì œ ê·¼ë¬´ì‹œê°„</strong>ê³¼<br>
                &nbsp;&nbsp;ë§ˆì§€ë§‰ ì»¬ëŸ¼ì˜ <strong>ì›”ê°„ ê³„íš/ì‹¤ì œ ê·¼ë¬´ì‹œê°„ í•©ê³„</strong>ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.<br>
                * ë§ˆì§€ë§‰ í–‰ â€œí•©ê³„â€ì—ëŠ” ê° ì£¼ì°¨ë³„ ì „ì²´ ê³„íš/ì‹¤ì œ í•©ê³„ì™€, ì „ì²´ ì›”ê°„ ê³„íš/ì‹¤ì œ í•©ê³„ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</main>

<style>
    /* ==== ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœ íŒ¨ë„ ê³µí†µ (í˜„ì¬ í™”ë©´ì—ëŠ” ë¯¸ì‚¬ìš©ì¼ ìˆ˜ ìˆìŒ) ==== */
    .status-panel-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        border-radius: 18px;
        padding: 16px 18px 18px;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
        color: #e5eeff;
    }
    .status-panel-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 10px;
    }
    .status-panel-title {
        font-weight: 700;
        font-size: 1rem;
        color:#f9fbff;
    }
    .status-panel-period {
        font-size:.85rem;
        opacity:.9;
    }
    .status-panel-body { margin-top: 4px; }

    .status-panel-blue .form-label,
    .status-panel-blue .form-text,
    .status-panel-blue .small.text-muted {
        color: #dbeafe !important;
    }
    .status-panel-blue .badge.bg-light {
        background:#e5eeff !important;
        color:#0f172a !important;
    }

    .status-panel-blue .vlist {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
    }
    .status-panel-blue .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(191,219,254,0.55);
        background: rgba(15,23,42,0.20);
        font-size:.9rem;
        color:#e5eeff;
    }
    .status-panel-blue .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(15,23,42,.5);
        flex:0 0 12px;
    }
    .status-panel-blue .pill .name { font-weight:600; }
    .status-panel-blue .pill .meta {
        color:#cbd5f5;
        font-size:.8rem;
    }

    /* ê³µí†µ ì¹© ëª¨ì–‘ */
    .chip {
        display:inline-flex;
        align-items:center;
        gap:6px;
        border:1px solid #e9ecef;
        border-radius:14px;
        padding:4px 8px;
        background:#fff;
        font-size:.8rem;
    }

    /* ìƒë‹¨ ë¦¬ìŠ¤íŠ¸(ê¸°ë³¸ ìŠ¤íƒ€ì¼) */
    .vlist {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        font-size:.9rem;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:#6c757d; font-size:.8rem; }

    /* ===== ì›”ê°„ í†µê³„ ì¹´ë“œ í—¤ë” íŒŒë€ìƒ‰ ===== */
    .week-card-header-blue {
        background: #1d4ed8;
        color:#f9fbff;
    }
    .week-card-header-blue .form-select.status-header-select {
        height: 32px;
        padding: 2px 32px 2px 8px;
        font-size: .85rem;
        border-radius: 999px;
        border: 1px solid rgba(191,219,254,0.85);
        background: rgba(15,23,42,0.22);
        color: #e5eeff;
    }
    .week-card-header-blue .form-select.status-header-select:focus {
        background: rgba(15,23,42,0.30);
        border-color:#bfdbfe;
        box-shadow:0 0 0 0.12rem rgba(191,219,254,0.6);
        color:#f9fbff;
    }

    .week-card-header-blue .btn-outline-light {
        border-color: rgba(226,232,240,0.8);
        color:#e2e8f0;
    }
    .week-card-header-blue .btn-outline-light:hover {
        background:#e2e8f0;
        color:#1e293b;
    }

    /* ===== ì›”ê°„ ì£¼ì°¨ë³„ í†µê³„ í…Œì´ë¸” ===== */

    .week-calendar-grid {
        overflow-x: auto;
        padding: 4px;
    }

    .week-calendar-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 900px;
        font-size: .9rem;

        border-radius: 14px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 8px 20px rgba(15,23,42,0.06);
        background: #ffffff;
        overflow: hidden;
    }
    .week-calendar-table thead th {
        background: #f8fafc;
        border: 1px solid #e9ecef;
        text-align: center;
        padding: 6px 4px;
        font-weight: 600;
        vertical-align: middle;
    }
    .week-calendar-table thead th:first-child {
        border-top-left-radius: 14px;
    }
    .week-calendar-table thead th:last-child {
        border-top-right-radius: 14px;
    }
    .week-calendar-table tbody tr:last-child td:first-child {
        border-bottom-left-radius: 14px;
    }
    .week-calendar-table tbody tr:last-child td:last-child {
        border-bottom-right-radius: 14px;
    }

    /* ğŸ”¹ ì•„ë¥´ë°”ì´íŠ¸ìƒ ì»¬ëŸ¼: ì—°í•œ í•˜ëŠ˜ìƒ‰ í†¤ */
    .week-calendar-table thead th.member-header-cell {
        min-width: 140px;
        width: 160px;
        text-align: left;
        background:#dbeafe;
        color:#0f172a;
    }
    .week-calendar-table thead th.week-total-header {
        min-width: 160px;
        width: 180px;
    }
    .week-calendar-table tbody td {
        border: 1px solid #e9ecef;
        padding: 6px;
        vertical-align: middle;
        background:#fff;
        text-align:right;
    }
    .week-calendar-table tbody td.member-cell {
        white-space: nowrap;
        font-weight: 600;
        background:#dbeafe;
        color:#0f172a;
        text-align:left;
    }
    .week-calendar-table tbody td.member-total-cell {
        background:#f8fafc;
        text-align:right;
    }
    .week-calendar-table tbody tr.summary-row td {
        background:#f1f3f5;
        font-weight:600;
        text-align:right;
    }
    .week-calendar-table tbody tr.summary-row td.member-cell {
        background:#dbeafe;
        color:#0f172a;
        text-align:left;
    }

    .member-dot {
        display:inline-block;
        width:10px;
        height:10px;
        border-radius:50%;
        margin-right:4px;
        border:1px solid rgba(15,23,42,0.2);
        background:#fff;
    }
    .member-name-wrap {
        display:block;
    }

    .week-cell-month {
        font-size:.85rem;
        font-variant-numeric: tabular-nums;
        text-align:center;
    }

    /* ğŸ”¹ ì£¼ì°¨ë³„ Plan/Actual ë‘ ê°œì˜ ë ‰íŠ¸ ì•µê¸€ */
    .week-rect-group {
        display:flex;
        flex-direction:column;
        gap:2px;
        align-items:stretch;
    }
    .week-rect {
        border-radius:6px;
        padding:2px 4px;
        font-size:.78rem;
        white-space:nowrap;
    }
    .week-rect-plan {
        background:rgba(16,185,129,0.06);
        border:1px solid rgba(16,185,129,0.35);
        color:#0f766e;
    }
    .week-rect-actual {
        background:rgba(59,130,246,0.06);
        border:1px solid rgba(59,130,246,0.35);
        color:#1d4ed8;
    }
    .week-rect.empty {
        opacity:0.5;
    }

    /* ğŸ”¹ ì›”ê°„ í•©ê³„ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ìƒ‰+ë³¼ë“œ+ì¡°ê¸ˆ í¬ê²Œ) */
    .member-month-total-strong {
        font-size: .9rem;
        font-weight: 700;
        line-height: 1.4;
    }
    .member-month-total-strong .month-total-plan {
        color:#0f766e;   /* Plan ìƒ‰ */
        font-weight:700;
    }
    .member-month-total-strong .month-total-actual {
        color:#1d4ed8;   /* Actual ìƒ‰ */
        font-weight:700;
    }

    .summary-month-total {
        font-size:.95rem;
        font-weight:700;
        line-height:1.4;
    }
    .summary-month-total .summary-month-total-plan {
        color:#0f766e;
        font-weight:700;
    }
    .summary-month-total .summary-month-total-actual {
        color:#1d4ed8;
        font-weight:700;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function () {
        const API_WORK   = '/api/schedule';        // ì‹¤ì œ: GET /{memberId}/{start}/{end}
        const API_PLAN   = '/api/schedule/work';   // ê³„íš: GET /{memberId}/{start}/{end}

        // DOM
        const statusSelect        = document.getElementById('statusSelect');

        // ìƒë‹¨ ìƒíƒœ íŒ¨ë„(ë‹¤ë¥¸ partialì—ì„œ ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ optional)
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');

        const noMemberState       = document.getElementById('noMemberState');
        const weekCalendarWrapper = document.getElementById('weekCalendarWrapper');
        const weekCalendarGrid    = document.getElementById('weekCalendarGrid');

        // ê¸°ì¡´ ì•„ì´ë”” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ë§Œ â€œì›” ì´ë™â€ìœ¼ë¡œ ë™ì‘
        const btnPrevWeek         = document.getElementById('btnPrevWeek');
        const btnThisWeek         = document.getElementById('btnThisWeek');
        const btnNextWeek         = document.getElementById('btnNextWeek');

        // ìƒíƒœ
        let allMembers = [];
        let currentStatusMembers = [];
        let currentMonthStart = firstDayOfMonth(new Date());

        // memberId -> { dateIso -> { segments, minutes? } }
        let monthPlanByMember   = {};
        let monthActualByMember = {};

        // membersJson íŒŒì‹±
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch (e) {
            allMembers = [];
        }

        attachHandlers();
        handleStatusChange();

        function attachHandlers() {
            statusSelect.addEventListener('change', handleStatusChange);

            if (btnPrevWeek) btnPrevWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentMonthStart = shiftMonth(currentMonthStart, -1);
                handleStatusChange();
            });
            if (btnThisWeek) btnThisWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentMonthStart = firstDayOfMonth(new Date());
                handleStatusChange();
            });
            if (btnNextWeek) btnNextWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentMonthStart = shiftMonth(currentMonthStart, +1);
                handleStatusChange();
            });
        }

        /* ===== ìƒíƒœ ë³€ê²½ ì‹œ ì „ì²´ íë¦„ ===== */
        function handleStatusChange() {
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            renderMemberList(currentStatusMembers);
            renderMonthRangeLabel(currentMonthStart);

            if (currentStatusMembers.length === 0) {
                if (noMemberState) noMemberState.classList.remove('d-none');
                if (weekCalendarWrapper) weekCalendarWrapper.classList.add('d-none');
                if (weekCalendarGrid) weekCalendarGrid.innerHTML = '';
                return;
            }

            if (noMemberState) noMemberState.classList.add('d-none');
            if (weekCalendarWrapper) weekCalendarWrapper.classList.remove('d-none');

            loadMonthForCurrentStatusMembers();
        }

        /* ===== ìƒë‹¨ í•„í„°ëœ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ (ìˆìœ¼ë©´ ë Œë”, ì—†ìœ¼ë©´ ë¬´ì‹œ) ===== */
        function renderMemberList(members) {
            if (!memberList || !memberCountBadge) return;

            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if (members.length === 0) {
                memberList.innerHTML = `<span class="text-muted small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const color = colorForMember(m);
                        const pill = document.createElement('div');
                        pill.className = 'pill';
                        pill.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        memberList.appendChild(pill);
                    });
        }

        /* ===== ì›” ë²”ìœ„ ë¼ë²¨ (ì˜ˆ: 2024.12.01 ~ 12.31) ===== */
        function renderMonthRangeLabel(monthStart) {
            const monthEnd = lastDayOfMonth(monthStart);
            const y = monthStart.getFullYear();
            const sM = pad2(monthStart.getMonth()+1);
            const sD = '01';
            const eM = pad2(monthEnd.getMonth()+1);
            const eD = pad2(monthEnd.getDate());
            const label = `${y}.${sM}.${sD} ~ ${eM}.${eD}`;
            if (weekRangeLabel) weekRangeLabel.textContent = label;
            if (weekRangeLabelRight) weekRangeLabelRight.textContent = label;
        }

        /* ===== í•„í„°ëœ ëª¨ë“  ë©¤ë²„ì— ëŒ€í•œ ì›”ê°„ ê³„íš/ì‹¤ì œ ë°ì´í„° ë¡œë”© ===== */
        async function loadMonthForCurrentStatusMembers() {
            monthPlanByMember   = {};
            monthActualByMember = {};

            const monthStart = currentMonthStart;
            const monthEnd   = lastDayOfMonth(monthStart);
            const startIso   = toIso(monthStart);
            const endIso     = toIso(monthEnd);

            const members = currentStatusMembers.slice();

            await Promise.all(members.map(async (m) => {
                const memberId = m.id;
                monthPlanByMember[memberId]   = {};
                monthActualByMember[memberId] = {};
                try {
                    const [planResp, workResp] = await Promise.all([
                        fetch(`${API_PLAN}/${encodeURIComponent(memberId)}/${startIso}/${endIso}`, { headers: { 'Accept':'application/json' }}),
                        fetch(`${API_WORK}/${encodeURIComponent(memberId)}/${startIso}/${endIso}`,  { headers: { 'Accept':'application/json' }}),
                    ]);

                    if (planResp.ok) {
                        const planData = await planResp.json();
                        monthPlanByMember[memberId] = normalizeDays(planData, false);
                    }
                    if (workResp.ok) {
                        const workData = await workResp.json();
                        monthActualByMember[memberId] = normalizeDays(workData, true);
                    }
                } catch (e) {
                    console.error('ì›”ê°„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨ (memberId=', memberId, ')', e);
                }
            }));

            renderMonthCalendar();
        }

        /* ===== ë©¤ë²„ Ã— ì£¼ì°¨ ì›”ê°„ ìº˜ë¦°ë” ë Œë” ===== */
        function renderMonthCalendar() {
            if (!weekCalendarGrid) return;

            weekCalendarGrid.innerHTML = '';

            const monthStart   = currentMonthStart;
            const weekRanges   = buildWeekRangesForMonth(monthStart); // [{start,end,dateIsos},...]

            const table = document.createElement('table');
            table.className = 'week-calendar-table';

            // í—¤ë”
            const thead = document.createElement('thead');
            const headTr = document.createElement('tr');

            const thName = document.createElement('th');
            thName.className = 'member-header-cell';
            thName.textContent = 'ì•„ë¥´ë°”ì´íŠ¸ìƒ';
            headTr.appendChild(thName);

            // ì£¼ì°¨ë³„ ì»¬ëŸ¼ í—¤ë” (ì˜ˆ: 12.01~12.07)
            weekRanges.forEach((wr) => {
                const th = document.createElement('th');
                const m = pad2(wr.start.getMonth()+1);
                const sD = pad2(wr.start.getDate());
                const eD = pad2(wr.end.getDate());
                th.innerHTML = `${m}.${sD}~${m}.${eD}`;
                headTr.appendChild(th);
            });

            // ğŸ”¹ ë§ˆì§€ë§‰ ì»¬ëŸ¼: ì›”ê°„ í•©ê³„
            const thMonthTotal = document.createElement('th');
            thMonthTotal.className = 'week-total-header';
            thMonthTotal.textContent = 'ì›”ê°„ í•©ê³„';
            headTr.appendChild(thMonthTotal);

            thead.appendChild(headTr);
            table.appendChild(thead);

            // ë°”ë””: ë©¤ë²„ë³„ í–‰
            const tbody = document.createElement('tbody');

            // ì£¼ì°¨ë³„ ì „ì²´ ì‹¤ì œ/ê³„íš í•©ê³„ (ëª¨ë“  ë©¤ë²„)
            const weekActualTotals = new Array(weekRanges.length).fill(0);
            const weekPlanTotals   = new Array(weekRanges.length).fill(0);

            // ì „ì²´(ëª¨ë“  ë©¤ë²„) ì›”ê°„ ê³„íš/ì‹¤ì œ í•©ê³„
            let allMembersMonthPlanTotal   = 0;
            let allMembersMonthActualTotal = 0;

            currentStatusMembers.forEach((member) => {
                const tr = document.createElement('tr');

                // ì¢Œì¸¡ ì´ë¦„ ì…€
                const nameTd = document.createElement('td');
                nameTd.className = 'member-cell';
                const color = colorForMember(member);
                nameTd.innerHTML = `
                    <span class="member-name-wrap">
                        <span class="member-dot" style="background:${color}"></span>
                        <span>${escapeHtml(member.name || '-')}</span>
                    </span>
                `;
                tr.appendChild(nameTd);

                const planMap   = monthPlanByMember[member.id]   || {};
                const actualMap = monthActualByMember[member.id] || {};

                let memberMonthPlanTotalMins   = 0;
                let memberMonthActualTotalMins = 0;

                // ì£¼ì°¨ë³„ ì¹¸
                weekRanges.forEach((wr, idx) => {
                    let weekPlanMins   = 0;
                    let weekActualMins = 0;

                    wr.dateIsos.forEach(iso => {
                        const planDay   = planMap[iso];
                        const actualDay = actualMap[iso];

                        if (planDay && Array.isArray(planDay.segments)) {
                            weekPlanMins += segmentsMinutes(planDay.segments);
                        }
                        if (actualDay) {
                            if (typeof actualDay.minutes === 'number') {
                                weekActualMins += actualDay.minutes;
                            } else if (Array.isArray(actualDay.segments)) {
                                weekActualMins += segmentsMinutes(actualDay.segments);
                            }
                        }
                    });

                    memberMonthPlanTotalMins   += weekPlanMins;
                    memberMonthActualTotalMins += weekActualMins;
                    weekActualTotals[idx]      += weekActualMins;
                    weekPlanTotals[idx]        += weekPlanMins;

                    const td = document.createElement('td');
                    td.className = 'week-cell-month';

                    const planLabel   = weekPlanMins   > 0 ? formatMins(weekPlanMins)   : '-';
                    const actualLabel = weekActualMins > 0 ? formatMins(weekActualMins) : '-';

                    td.innerHTML = `
                        <div class="week-rect-group">
                            <div class="week-rect week-rect-plan ${weekPlanMins>0 ? '' : 'empty'}">
                                ê³„íš ${planLabel}
                            </div>
                            <div class="week-rect week-rect-actual ${weekActualMins>0 ? '' : 'empty'}">
                                ì‹¤ì œ ${actualLabel}
                            </div>
                        </div>
                    `;
                    tr.appendChild(td);
                });

                allMembersMonthPlanTotal   += memberMonthPlanTotalMins;
                allMembersMonthActualTotal += memberMonthActualTotalMins;

                // ğŸ”¹ ë§ˆì§€ë§‰ ì»¬ëŸ¼: í•´ë‹¹ ì•„ë¥´ë°”ì´íŠ¸ìƒì˜ ì›”ê°„ ê³„íš/ì‹¤ì œ í•©ê³„
                const monthPlanLabel   = memberMonthPlanTotalMins   > 0 ? formatMins(memberMonthPlanTotalMins)   : '-';
                const monthActualLabel = memberMonthActualTotalMins > 0 ? formatMins(memberMonthActualTotalMins) : '-';

                const totalTd = document.createElement('td');
                totalTd.className = 'member-total-cell';
                totalTd.innerHTML = `
                    <div class="member-month-total-strong">
                        <div><span class="text-muted small">ê³„íš</span> : <span class="month-total-plan">${monthPlanLabel}</span></div>
                        <div><span class="text-muted small">ì‹¤ì œ</span> : <span class="month-total-actual">${monthActualLabel}</span></div>
                    </div>
                `;
                tr.appendChild(totalTd);

                tbody.appendChild(tr);
            });

            // ===== ë§ˆì§€ë§‰ ìš”ì•½ í–‰: ì£¼ì°¨ë³„ ì „ì²´ ê³„íš/ì‹¤ì œ í•©ê³„ + ì „ì²´ ì›”ê°„ í•©ê³„(ê³„íš/ì‹¤ì œ) =====
            const summaryTr = document.createElement('tr');
            summaryTr.className = 'summary-row';

            const sumNameTd = document.createElement('td');
            sumNameTd.className = 'member-cell';
            sumNameTd.textContent = 'í•©ê³„';
            summaryTr.appendChild(sumNameTd);

            weekRanges.forEach((_, idx) => {
                const planMins   = weekPlanTotals[idx];
                const actualMins = weekActualTotals[idx];

                const planLabel   = planMins   > 0 ? formatMins(planMins)   : '-';
                const actualLabel = actualMins > 0 ? formatMins(actualMins) : '-';

                const td = document.createElement('td');
                td.className = 'week-cell-month';
                td.innerHTML = `
                    <div class="week-rect-group">
                        <div class="week-rect week-rect-plan ${planMins>0 ? '' : 'empty'}">
                            ê³„íš ${planLabel}
                        </div>
                        <div class="week-rect week-rect-actual ${actualMins>0 ? '' : 'empty'}">
                            ì‹¤ì œ ${actualLabel}
                        </div>
                    </div>
                `;
                summaryTr.appendChild(td);
            });

            const totalSummaryTd = document.createElement('td');
            const totalPlanLabel   = allMembersMonthPlanTotal   > 0 ? formatMins(allMembersMonthPlanTotal)   : '-';
            const totalActualLabel = allMembersMonthActualTotal > 0 ? formatMins(allMembersMonthActualTotal) : '-';
            totalSummaryTd.innerHTML = `
                <div class="summary-month-total">
                    <div><span class="text-muted small">ê³„íš</span> : <span class="summary-month-total-plan">${totalPlanLabel}</span></div>
                    <div><span class="text-muted small">ì‹¤ì œ</span> : <span class="summary-month-total-actual">${totalActualLabel}</span></div>
                </div>
            `;
            summaryTr.appendChild(totalSummaryTd);

            tbody.appendChild(summaryTr);

            table.appendChild(tbody);
            weekCalendarGrid.appendChild(table);
        }

        /* ===== Utils ===== */

        function firstDayOfMonth(d){
            return new Date(d.getFullYear(), d.getMonth(), 1);
        }
        function lastDayOfMonth(d){
            return new Date(d.getFullYear(), d.getMonth()+1, 0);
        }
        function shiftMonth(d, offset){
            return new Date(d.getFullYear(), d.getMonth()+offset, 1);
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        function buildWeekRangesForMonth(monthStart){
            const year = monthStart.getFullYear();
            const month = monthStart.getMonth();
            const lastDay = lastDayOfMonth(monthStart).getDate();
            const ranges = [];

            for (let day = 1; day <= lastDay; day += 7) {
                const start = new Date(year, month, day);
                const endDay = Math.min(day + 6, lastDay);
                const end = new Date(year, month, endDay);

                const dateIsos = [];
                for (let d = day; d <= endDay; d++) {
                    const dt = new Date(year, month, d);
                    dateIsos.push(toIso(dt));
                }
                ranges.push({ start, end, dateIsos });
            }
            return ranges;
        }

        function normalizeDays(apiData, needMinutes){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                let minutes = d.minutes;
                if (needMinutes) {
                    minutes = (typeof d.minutes==='number')
                            ? d.minutes
                            : segments.reduce((acc,s)=> acc + (hmToMin(s.end) - hmToMin(s.start)), 0);
                }
                map[date] = needMinutes ? { segments, minutes } : { segments };
            });
            return map;
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const parts = String(hm).split(':');
            const h = parseInt(parts[0],10)||0;
            const m = parseInt(parts[1],10)||0;
            return h*60+m;
        }

        function segmentsMinutes(segs){
            return (segs||[]).reduce((acc,s)=> acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
        }

        function formatMins(mins){
            const v=Math.max(0, mins|0);
            const h=Math.floor(v/60), m=v%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }

        function colorForMember(m){
            const key = (m?.id!=null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer_}}
