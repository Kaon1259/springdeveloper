{{>layouts/header}}

<main class="container my-4">

    <!-- ============ ìƒë‹¨: ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸° (ì¹© ë¦¬ìŠ¤íŠ¸) ============ -->
    <!-- âœ… íŒŒë€ ë°°ê²½ + ìƒë‹¨ ë¼ìš´ë“œ ì ìš©: state-card-blue í´ë˜ìŠ¤ -->
    <div class="card mb-3 state-card-blue">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</span>
            <a href="/members/new" class="btn btn-sm btn-light">ì¶”ê°€ë“±ë¡</a>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- ìƒíƒœ ì„ íƒ -->
                <div class="col-12 col-md-4">
                    <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>
                    <div class="form-text">
                        ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì•„ë˜ ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ì™€ ê¸‰ì—¬ í…Œì´ë¸”ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ (ì¹© UI) -->
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">ì•„ë¥´ë°”ì´íŠ¸ ëª©ë¡</div>
                        <span id="memberCountBadge" class="badge bg-light text-dark">0ëª…</span>
                    </div>
                    <div id="memberPills" class="vlist"><!-- JS ë Œë” --></div>
                    <div class="small text-muted mt-2">
                        * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ìƒë‹¨: ì œëª© + ì›” ë‚´ë¹„ (ê³µìš©, sticky) ============ -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2 sticky-top"
         style="top:70px;background:#fff;padding:.25rem 0;z-index:5;">
        <!-- ğŸ”¹ ì œëª© + PDF ë²„íŠ¼ ë¬¶ìŒ -->
        <div class="d-flex align-items-center gap-2">
            <div class="h5 mb-0 fw-bold">ì£¼ì°¨ë³„ ê¸‰ì—¬ í…Œì´ë¸” (ì‹¤ê·¼ë¬´ ê¸°ì¤€)</div>
            <!-- ğŸ”¹ PDF ë²„íŠ¼ (ìƒˆ ì°½ìœ¼ë¡œ ì¶œë ¥ìš© í˜ì´ì§€ í˜¸ì¶œ) -->
            <a id="pdfBtn"
               class="btn btn-sm btn-outline-primary"
               target="_blank">
                PDF
            </a>
        </div>

        <div class="d-flex align-items-center small text-muted gap-2">
            <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">â—€ ì´ì „ ë‹¬</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthThis">ì´ë²ˆ ë‹¬</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthNext">ë‹¤ìŒ ë‹¬ â–¶</button>
        </div>
    </div>

    <!-- ============ í•˜ë‹¨: ì¬êµ¬ì„± í…Œì´ë¸” ============ -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weeklyPayTable">
                    <!-- âœ… í—¤ë”ë¥¼ íŒŒë€ìƒ‰ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ: weekly-table-header í´ë˜ìŠ¤ ì‚¬ìš© -->
                    <thead class="weekly-table-header">
                    <tr>
                        <th style="width:120px;">ì£¼ì°¨</th>
                        <th style="width:160px;">ê·¼ë¬´ìëª…</th>
                        <th style="width:140px;" class="text-end">ê·¼ë¬´ì‹œê°„</th>
                        <th style="width:120px;" class="text-end">ì‹œê¸‰</th>
                        <th style="width:130px;">ì£¼íœ´ìˆ˜ë‹¹ë¶€ê°€</th>
                        <th style="width:130px;">ì„¸ê¸ˆë¶€ê°€</th>
                        <th style="width:140px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹</th>
                        <th style="width:140px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹</th>
                        <th style="width:140px;" class="text-end">ì„¸ê¸ˆ(3.3%)</th>
                        <th style="width:140px;" class="text-end">ì‹¤ìˆ˜ë ¹ì•¡</th>
                        <!-- âœ… ì‹¤ìˆ˜ë ¹ì•¡ ì˜† ì§€ê¸‰ì¼ ì»¬ëŸ¼ ì¶”ê°€ -->
                        <th style="width:120px;">ì§€ê¸‰ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="weeklyPayBody">
                    <!-- JS ë Œë” -->
                    </tbody>
                    <tfoot>
                    <tr class="table-secondary fw-bold">
                        <!-- ì „ì²´ 11ì»¬ëŸ¼: 6 + 4 + 1 -->
                        <td colspan="6" class="text-end">ì›” í•©ê³„</td>
                        <td class="text-end" id="monthWorkPaySum">-</td>
                        <td class="text-end" id="monthJuhyuPaySum">-</td>
                        <td class="text-end" id="monthTaxSum">-</td>
                        <td class="text-end" id="monthNetSum">-</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
            <div class="small text-muted">
                * ì£¼íœ´ìˆ˜ë‹¹ì€ ë©¤ë²„ ì„¤ì •ì´ â€œì ìš©â€ì´ê³  í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ê°€ 15ì‹œê°„ ì´ìƒì¼ ë•Œë§Œ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                * ê·¼ë¬´ì‹œê°„ í‘œê¸°ëŠ” â€œHì‹œê°„ Më¶„â€. ê¸ˆì•¡ì€ KRW í†µí™” í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.<br>
                * ì„¸ê¸ˆ(3.3%)ì€ ê·¼ë¬´ìˆ˜ë‹¹+ì£¼íœ´ìˆ˜ë‹¹ì— ì¼ê´„ ì ìš©ë˜ë©°, ì‹¤ìˆ˜ë ¹ì•¡ = (ê·¼ë¬´ìˆ˜ë‹¹+ì£¼íœ´ìˆ˜ë‹¹) - ì„¸ê¸ˆ ì…ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</main>

<style>
    /* âœ… ìƒë‹¨ ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœ ì¹´ë“œ: íŒŒë€ ë°°ê²½ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    .state-card-blue{
        border-radius:1rem;
        overflow:hidden;
        background:#0d6efd;
        color:#fff;
        border:none;
    }
    .state-card-blue .card-header{
        background:rgba(255,255,255,0.08);
        border-bottom:1px solid rgba(255,255,255,0.25);
    }
    .state-card-blue .card-body{
        background:transparent;
    }
    .state-card-blue .form-label,
    .state-card-blue .form-text,
    .state-card-blue .text-muted{
        color:rgba(255,255,255,0.85) !important;
    }
    .state-card-blue .form-select{
        background-color:#ffffff;
        border-color:rgba(0,0,0,0.1);
    }
    .state-card-blue .btn-light{
        color:#0d6efd;
        border-color:transparent;
    }

    /* ===== ìƒë‹¨ ì¹© ë¦¬ìŠ¤íŠ¸ ===== */
    .vlist{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #e9ecef;background:#fff;cursor:pointer;font-size:.9rem;transition:background .15s, box-shadow .15s, border-color .15s}
    .pill:hover{background:#fafafa;border-color:#dee2e6}
    .pill.active{border-color:rgba(13,110,253,.45);box-shadow:0 0 0 3px rgba(13,110,253,.15) inset;background:#f0f6ff}
    .pill .dot{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,.08);flex:0 0 12px}

    .text-money{color:#0d6efd;font-weight:600}
    .text-time{color:#198754;font-weight:600}
    .small-muted{color:#6c757d;font-size:.85rem}
    .week-label{white-space:nowrap}

    /* âœ… ì£¼ì°¨/ê·¼ë¬´ìëª… ë“± í…Œì´ë¸” í—¤ë” íŒŒë€ìƒ‰ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    .weekly-table-header th{
        background:#0d6efd !important;
        color:#fff !important;
        border-color:#0b5ed7 !important;
        vertical-align:middle;
    }
    /* ë§¨ ì™¼ìª½/ì˜¤ë¥¸ìª½ ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    .weekly-table-header th:first-child{
        border-top-left-radius:0.75rem;
    }
    .weekly-table-header th:last-child{
        border-top-right-radius:0.75rem;
    }
    /* í…Œì´ë¸” ìì²´ë„ ìƒë‹¨ ëª¨ì„œë¦¬ ë³´ì´ë„ë¡ */
    #weeklyPayTable{
        border-collapse:separate;
        border-spacing:0;
        border-radius:0.75rem;
        overflow:hidden;
    }

    /* âœ… ì£¼ì°¨ë³„ ê°€ë¡œ êµ¬ë¶„ì„ : ì£¼ ë§ˆì§€ë§‰ í–‰ í•˜ë‹¨ ë³´ë” ë‘ê»ê²Œ */
    #weeklyPayTable tbody tr.week-end-border td{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }

    /* âœ… ì£¼ì°¨ ì»¬ëŸ¼(td, rowspan ì ìš©ëœ ì…€)ì—ë„ ë™ì¼í•˜ê²Œ êµµì€ í•˜ë‹¨ì„  */
    #weeklyPayTable tbody td.week-label-border{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }
</style>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        /* ===== ì„¤ì •/API ===== */
        const API_BASE_ACTUAL = '/api/schedule'; // GET /{memberId}/{startIso}/{endIso}

        /* ===== DOM ===== */
        const statusSelect     = document.getElementById('statusSelect');
        const memberPills      = document.getElementById('memberPills');
        const memberCountBadge = document.getElementById('memberCountBadge');

        const btnMonthPrev     = document.getElementById('btnMonthPrev');
        const btnMonthThis     = document.getElementById('btnMonthThis');
        const btnMonthNext     = document.getElementById('btnMonthNext');
        const monthRangeLabel  = document.getElementById('monthRangeLabel');

        const weeklyPayBody        = document.getElementById('weeklyPayBody');
        const monthWorkPaySumEl    = document.getElementById('monthWorkPaySum');
        const monthJuhyuPaySumEl   = document.getElementById('monthJuhyuPaySum');
        const monthTaxSumEl        = document.getElementById('monthTaxSum');
        const monthNetSumEl        = document.getElementById('monthNetSum');

        /* ===== ìƒíƒœ ===== */
        let allMembers = [];
        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); }
        catch(e){ allMembers = []; }

        let filteredMembers   = [];
        let currentMonthStart = firstDayOfMonth(new Date());

        /* ===== ì´ˆê¸°í™” ===== */
        if (Array.isArray(allMembers) && allMembers.length>0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }
        statusSelect.addEventListener('change', refreshMembers);
        btnMonthPrev.addEventListener('click', ()=> {
            currentMonthStart = new Date(
                    currentMonthStart.getFullYear(),
                    currentMonthStart.getMonth()-1,
                    1
            );
            loadWeeklyTable();
        });
        btnMonthThis.addEventListener('click', ()=> {
            currentMonthStart = firstDayOfMonth(new Date());
            loadWeeklyTable();
        });
        btnMonthNext.addEventListener('click', ()=> {
            currentMonthStart = new Date(
                    currentMonthStart.getFullYear(),
                    currentMonthStart.getMonth()+1,
                    1
            );
            loadWeeklyTable();
        });

        // ğŸ”¹ PDF ë²„íŠ¼ â€“ í˜„ì¬ ìƒíƒœê°’ì„ ì¿¼ë¦¬ë¡œ ë¶™ì—¬ì„œ í˜¸ì¶œ
        document.getElementById('pdfBtn').addEventListener('click', function(e){
            const status = document.getElementById('statusSelect').value;
            this.href = `/payment/paymanagerdashboard/print?status=${encodeURIComponent(status)}`;
        });

        refreshMembers();

        /* ===== ë©¤ë²„ í•„í„°/ì¹© ë Œë” ===== */
        function refreshMembers(){
            const status = statusSelect.value;
            filteredMembers = (allMembers||[]).filter(m => m.status === status);
            memberCountBadge.textContent = `${filteredMembers.length}ëª…`;

            memberPills.innerHTML = '';
            if (!filteredMembers.length){
                memberPills.innerHTML = `<span class="small-muted">í•´ë‹¹ ìƒíƒœì˜ ê·¼ë¬´ìê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
            } else {
                filteredMembers
                        .slice()
                        .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                        .forEach(m=>{
                            const color = colorForMember(m);
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'pill active';
                            btn.innerHTML = `
          <span class="dot" style="background:${color}"></span>
          <span class="name">${escapeHtml(m.name ?? '-')}</span>
          <span class="small-muted">${escapeHtml(m.phone ?? '')}</span>
        `;
                            memberPills.appendChild(btn);
                        });
            }
            loadWeeklyTable();
        }

        /* ===== ì£¼ì°¨ í…Œì´ë¸” ë Œë” ===== */
        async function loadWeeklyTable(){
            const ms = firstDayOfMonth(currentMonthStart);
            const me = lastDayOfMonth(currentMonthStart);
            monthRangeLabel.textContent =
                    `${ms.getFullYear()}.${pad2(ms.getMonth()+1)}.01 ~ ${pad2(me.getMonth()+1)}.${pad2(me.getDate())}`;

            weeklyPayBody.innerHTML = '';
            setFooterSums(0,0,0,0);

            if (!filteredMembers.length){
                const tr = document.createElement('tr');
                tr.classList.add('week-end-border'); // ì£¼ê°€ ì•„ì˜ˆ ì—†ì„ ë•Œë„ í•˜ë‹¨ì„  ìœ ì§€
                tr.innerHTML = `<td colspan="11" class="text-muted">í‘œì‹œí•  ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                weeklyPayBody.appendChild(tr);
                return;
            }

            const msIso = toIso(ms), meIso = toIso(me);
            const memberDayMap = {}; // { memberId: { isoDate: {minutes, segments[]} } }

            await Promise.all(filteredMembers.map(async m=>{
                try{
                    const url = `${API_BASE_ACTUAL}/${encodeURIComponent(m.id)}/${msIso}/${meIso}`;
                    const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                    if (resp.ok){
                        const data = await resp.json();
                        memberDayMap[m.id] = normalizeDays(data);
                    } else {
                        memberDayMap[m.id] = {};
                    }
                }catch(e){
                    console.error('schedule fetch error', e);
                    memberDayMap[m.id] = {};
                }
            }));

            // ì›”ì„ í¬í•¨í•˜ëŠ” ëª¨ë“  ì£¼(ì›”~ì¼) ì‹œì‘ì¼ ëª©ë¡(Mon)
            const weeks   = [];
            let wStart    = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd){
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate()+7);
            }

            // ì›” í•©ê³„
            let monthWorkPaySum = 0;
            let monthJuhyuPaySum = 0;
            let monthTaxSum = 0;
            let monthNetSum = 0;

            // ì£¼ì°¨ë³„ ë Œë”
            weeks.forEach((weekStart, idx)=>{
                const weekEnd = addDays(weekStart, 6);

                // í•´ë‹¹ ì£¼ ê° ë©¤ë²„ì˜ ì£¼ê°„ í•©ê³„ ê³„ì‚°
                const rows = []; // [{member, weekMinutes, wage, juhyuApplied, workPay, juhyuPay, applyTax, taxAmount, grossTotal, netTotal}]
                filteredMembers.forEach(m=>{
                    const wage = Number(m.hourlyWage)||0;
                    const includeJuhyu = !!m.includeWeeklyHolidayAllowance;
                    const applyTax = isTaxApplied(m);

                    let weekMinutes = 0;
                    for (let i=0;i<7;i++){
                        const d = addDays(weekStart, i);
                        if (d < ms || d > me) continue;
                        const iso = toIso(d);
                        const info = (memberDayMap[m.id]||{})[iso] || {minutes:0};
                        weekMinutes += (info.minutes||0);
                    }
                    if (weekMinutes <= 0) return; // ê·¼ë¬´ ì—†ëŠ” ë©¤ë²„ëŠ” í‘œì—ì„œ ì œì™¸

                    const workPay = Math.round((weekMinutes/60) * wage);
                    let juhyuPay = 0;
                    let juhyuApplied = false;
                    if (includeJuhyu && weekMinutes >= 15*60){
                        const juhyuMinutes = Math.round(weekMinutes / 5);
                        juhyuPay = Math.round((juhyuMinutes/60) * wage);
                        juhyuApplied = true;
                    }

                    const grossTotal = workPay + juhyuPay;
                    let taxAmount = 0;
                    let netTotal = grossTotal;
                    if (applyTax && grossTotal > 0){
                        taxAmount = Math.round(grossTotal * 0.033);
                        netTotal  = grossTotal - taxAmount;
                    }

                    rows.push({
                        member: m,
                        weekMinutes,
                        wage,
                        juhyuApplied,
                        workPay,
                        juhyuPay,
                        applyTax,
                        taxAmount,
                        grossTotal,
                        netTotal
                    });
                });

                // ì£¼ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ë‹¤ë©´ í•œ ì¤„ë¡œ "í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ ì—†ìŒ"
                if (rows.length === 0) {
                    const tr = document.createElement('tr');
                    const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;
                    tr.innerHTML = `
          <td class="week-label week-label-border">${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small></td>
          <td colspan="10" class="text-muted text-start">í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        `;
                    tr.classList.add('week-end-border'); // ì£¼ ë§ˆì§€ë§‰ í–‰
                    weeklyPayBody.appendChild(tr);
                    return;
                }

                // ì´ë¦„ìˆœ ì •ë ¬
                rows.sort((a,b)=>(a.member.name||'').localeCompare(b.member.name||'','ko'));

                // ì£¼ì°¨ rowSpan
                const rowSpan   = rows.length;
                const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                rows.forEach((r, i)=>{
                    const tr = document.createElement('tr');
                    const weekCell = (i===0)
                            ? `<td class="week-label week-label-border" rowspan="${rowSpan}">
               ${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small>
             </td>`
                            : '';

                    tr.innerHTML = `
          ${weekCell}
          <td class="text-start">${escapeHtml(r.member.name||'-')}</td>
          <td class="text-end"><span class="text-time">${formatMins(r.weekMinutes)}</span></td>
          <td class="text-end">${r.wage ? krw(r.wage) : '-'}</td>
          <td>${r.juhyuApplied ? '<span class="text-success fw-bold">ì ìš©</span>' : '<span class="text-muted">ë¯¸ì ìš©</span>'}</td>
          <td>${r.applyTax ? '<span class="text-danger fw-bold">ë¶€ê³¼</span>' : '<span class="text-muted">ë¯¸ë¶€ê³¼</span>'}</td>
          <td class="text-end">${krw(r.workPay)}</td>
          <td class="text-end">${krw(r.juhyuPay)}</td>
          <td class="text-end">${r.applyTax ? krw(r.taxAmount) : '-'}</td>
          <td class="text-end"><span class="fw-bold text-primary">${krw(r.netTotal)}</span></td>
          <!-- âœ… ì§€ê¸‰ì¼(payday) ì¶œë ¥ -->
          <td class="text-center small">(ë§¤ì›”)${formatPayday(r.member.payday)}</td>
        `;

                    // âœ… ì´ ì£¼(week)ì˜ ë§ˆì§€ë§‰ í–‰ì´ë©´, ê°€ë¡œ êµ¬ë¶„ì„  í´ë˜ìŠ¤ ì¶”ê°€
                    if (i === rows.length - 1) {
                        tr.classList.add('week-end-border');
                    }

                    weeklyPayBody.appendChild(tr);
                });

                // ì›” í•©ê³„ ëˆ„ì 
                monthWorkPaySum  += rows.reduce((sum,r)=> sum + r.workPay,    0);
                monthJuhyuPaySum += rows.reduce((sum,r)=> sum + r.juhyuPay,   0);
                monthTaxSum      += rows.reduce((sum,r)=> sum + r.taxAmount,  0);
                monthNetSum      += rows.reduce((sum,r)=> sum + r.netTotal,   0);
            });

            setFooterSums(monthWorkPaySum, monthJuhyuPaySum, monthTaxSum, monthNetSum);
        }

        function setFooterSums(work, juhyu, tax, net){
            monthWorkPaySumEl.textContent  = krw(work|0);
            monthJuhyuPaySumEl.textContent = krw(juhyu|0);
            monthTaxSumEl.textContent      = tax ? krw(tax|0) : '-';
            monthNetSumEl.textContent      = krw(net|0);
        }

        /* ===== ìœ í‹¸ ===== */
        function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
        function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d;
        }
        function normalizeDays(apiData){
            const map={}; const arr=Array.isArray(apiData?.days)?apiData.days:[];
            arr.forEach(d=>{
                const date=String(d.date);
                const segs=Array.isArray(d.segments)?d.segments:[];
                const minutes=(typeof d.minutes==='number')
                        ? d.minutes
                        : segs.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments: segs, minutes };
            });
            return map;
        }
        function diffMinutes(start,end){
            const s=parseHm(start), e=parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm || typeof hm!=='string') return {h:0,m:0};
            const [h,m]=hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function formatMins(mins){
            mins=Math.max(0, mins|0);
            const h=Math.floor(mins/60), m=mins%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }
        function krw(v){
            return new Intl.NumberFormat('ko-KR',{
                style:'currency',
                currency:'KRW',
                maximumFractionDigits:0
            }).format(v|0);
        }
        function colorForMember(m){
            const key=(m?.id!=null?String(m.id):(m?.name||'x'));
            const h=seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        // applyTax ê°’(Y/N, true/false, 1/0 ë“±)ì„ boolean ìœ¼ë¡œ ì •ê·œí™”
        function isTaxApplied(member){
            const v = member?.applyTax;
            if (v === true) return true;
            if (v === false || v == null) return false;
            if (typeof v === 'number') return v === 1;
            if (typeof v === 'string'){
                const s = v.trim().toUpperCase();
                return s === 'Y' || s === 'TRUE' || s === 'T' || s === '1';
            }
            return false;
        }

        // âœ… payday í¬ë§·íŒ… (MemberDto.payday ì‚¬ìš©)
        function formatPayday(v){
            if (!v) return 'ë¯¸ì§€ì •';
            const s = String(v).trim().toUpperCase();
            if (s === 'EOM') return 'ë§ì¼';
            if (/^\d+$/.test(s)) {
                const n = parseInt(s, 10);
                if (n >= 1 && n <= 31) return `${n}ì¼`;
            }
            return s;
        }

    })();
</script>

{{>layouts/footer}}
