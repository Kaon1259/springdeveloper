{{>layouts/header_}}

<main class="container my-4">

    <!-- âœ… ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ë¼ìš´ë“œ ë°•ìŠ¤(ì™¸ë¶€ í…Œì´ë¸” ëŠë‚Œ) -->
    <div class="pay-shell">

        <!-- âœ… ì™¸ë¶€ ìƒë‹¨ í—¤ë” : íŒŒë€ìƒ‰ ë°°ê²½ -->
        <div class="pay-shell-header">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold text-white fs-5">ì£¼ì°¨ë³„ ê¸‰ì—¬ í…Œì´ë¸” (ì‹¤ê·¼ë¬´ ê¸°ì¤€)</span>
            </div>
        </div>

        <!-- âœ… ì™¸ë¶€ ë‚´ìš© ì˜ì—­ -->
        <div class="pay-shell-body">

            <!-- ìƒë‹¨: ìƒíƒœë³„ ë³´ê¸° + ìƒíƒœ ì„ íƒ + PDF + ì›” ë„¤ë¹„ -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                <!-- ì™¼ìª½: ìƒíƒœë³„ ë³´ê¸° + ë“œë¡­ë‹¤ìš´ + PDF -->
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <span class="small text-muted">ìƒíƒœë³„ ë³´ê¸°</span>

                    <select id="statusSelect" class="form-select form-select-sm" style="width:auto;min-width:140px;">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>

                    <a id="pdfBtn"
                       class="btn btn-sm btn-outline-primary ms-1"
                       target="_blank">
                        PDF
                    </a>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ì›” ì´ë™ ë‚´ë¹„ê²Œì´ì…˜ -->
                <div class="d-flex align-items-center small text-muted gap-2 flex-wrap">
                    <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthPrev">â—€ ì´ì „ ë‹¬</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthThis">ì´ë²ˆ ë‹¬</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMonthNext">ë‹¤ìŒ ë‹¬ â–¶</button>
                </div>
            </div>

            <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
            <div class="small text-muted mb-3">
                ì„ íƒí•œ <b>ìƒíƒœ</b>ì˜ ì•„ë¥´ë°”ì´íŠ¸ë§Œ ëŒ€ìƒìœ¼ë¡œ, í•´ë‹¹ ì›”ì˜ <b>ì£¼ì°¨ë³„ ì‹¤ê·¼ë¬´ ê¸°ì¤€ ê¸‰ì—¬</b>ë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤.<br>
                ê° ì£¼ì°¨ì˜ ë§ˆì§€ë§‰ í–‰ì€ íŒŒë€ìƒ‰ í•˜ë‹¨ ë³´ë”ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.
            </div>

            <!-- ğŸ“Š ë‚´ë¶€: ì£¼ì°¨ë³„ ê¸‰ì—¬ ìƒì„¸ í…Œì´ë¸” (ì‹¤ê·¼ë¬´ ê¸°ì¤€) -->
            <div class="table-responsive mb-4">
                <table class="table table-bordered align-middle text-center" id="weeklyPayTable">
                    <!-- âœ… ë‚´ë¶€ í—¤ë”: íŒŒë€ìƒ‰ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ -->
                    <thead class="inner-table-header">
                    <tr>
                        <th style="width:120px;">ì£¼ì°¨</th>
                        <th style="width:160px;">ê·¼ë¬´ìëª…</th>
                        <th style="width:140px;" class="text-end">ê·¼ë¬´ì‹œê°„</th>
                        <th style="width:120px;" class="text-end">ì‹œê¸‰</th>
                        <th style="width:130px;">ì£¼íœ´ìˆ˜ë‹¹ë¶€ê°€</th>
                        <th style="width:130px;">ì„¸ê¸ˆë¶€ê°€</th>
                        <th style="width:140px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹</th>
                        <th style="width:140px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹</th>
                        <th style="width:140px;" class="text-end">ì„¸ê¸ˆ(3.3%)</th>
                        <th style="width:140px;" class="text-end">ì‹¤ìˆ˜ë ¹ì•¡</th>
                        <th style="width:120px;">ì§€ê¸‰ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="weeklyPayBody">
                    <!-- JS ë Œë” -->
                    </tbody>
                    <tfoot>
                    <tr class="table-secondary fw-bold">
                        <!-- ì „ì²´ 11ì»¬ëŸ¼: 6 + 4 + 1 -->
                        <td colspan="6" class="text-end">ì›” í•©ê³„ (ì‹¤ê·¼ë¬´)</td>
                        <td class="text-end" id="monthWorkPaySum">-</td>
                        <td class="text-end" id="monthJuhyuPaySum">-</td>
                        <td class="text-end" id="monthTaxSum">-</td>
                        <td class="text-end" id="monthNetSum">-</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <!-- í•˜ë‹¨ ì„¤ëª… (ì‹¤ê·¼ë¬´ ê¸°ì¤€) -->
            <div class="small text-muted mb-4">
                * ì£¼íœ´ìˆ˜ë‹¹ì€ ë©¤ë²„ ì„¤ì •ì´ â€œì ìš©â€ì´ê³  í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ê°€ 15ì‹œê°„ ì´ìƒì¼ ë•Œë§Œ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
                * ê·¼ë¬´ì‹œê°„ í‘œê¸°ëŠ” â€œHì‹œê°„ Më¶„â€. ê¸ˆì•¡ì€ KRW í†µí™” í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.<br>
                * ì„¸ê¸ˆ(3.3%)ëŠ” ê·¼ë¬´ìˆ˜ë‹¹+ì£¼íœ´ìˆ˜ë‹¹ì— ì¼ê´„ ì ìš©ë˜ë©°, ì‹¤ìˆ˜ë ¹ì•¡ = (ê·¼ë¬´ìˆ˜ë‹¹+ì£¼íœ´ìˆ˜ë‹¹) - ì„¸ê¸ˆ ì…ë‹ˆë‹¤.
            </div>

            <!-- ============================== -->
            <!-- ğŸ”µ ì¶”ê°€: ê³„íšì¼ì • ê¸°ì¤€ ì£¼ì°¨ë³„ ê¸‰ì—¬ í…Œì´ë¸” -->
            <!-- ============================== -->

            <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                <span class="fw-bold">ì£¼ì°¨ë³„ ê¸‰ì—¬ í…Œì´ë¸” (ê³„íšì¼ì • ê¸°ì¤€)</span>
                <span class="small text-muted">ì‹¤ê·¼ë¬´ê°€ ì•„ë‹Œ, ê³„íš ì¼ì •ë§Œìœ¼ë¡œ í™˜ì‚°í•œ ì£¼ì°¨ë³„ ê¸‰ì—¬ì…ë‹ˆë‹¤.</span>
                <!-- âœ… ìš”ì•½ë³´ê¸° ë²„íŠ¼ -->
                <button type="button"
                        id="btnPlanSummary"
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#planSummaryModal">
                    ìš”ì•½ë³´ê¸°
                </button>
            </div>

            <!-- ğŸ“Š ë‚´ë¶€: ì£¼ì°¨ë³„ ê¸‰ì—¬ ìƒì„¸ í…Œì´ë¸” (ê³„íš ê¸°ì¤€) -->
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weeklyPlanTable">
                    <thead class="inner-table-header">
                    <tr>
                        <th style="width:120px;">ì£¼ì°¨</th>
                        <th style="width:160px;">ê·¼ë¬´ìëª…</th>
                        <th style="width:140px;" class="text-end">ê³„íšê·¼ë¬´ì‹œê°„</th>
                        <th style="width:120px;" class="text-end">ì‹œê¸‰</th>
                        <th style="width:130px;">ì£¼íœ´ìˆ˜ë‹¹ë¶€ê°€</th>
                        <th style="width:130px;">ì„¸ê¸ˆë¶€ê°€</th>
                        <th style="width:140px;" class="text-end">ê·¼ë¬´ìˆ˜ë‹¹(ê³„íš)</th>
                        <th style="width:140px;" class="text-end">ì£¼íœ´ìˆ˜ë‹¹(ê³„íš)</th>
                        <th style="width:140px;" class="text-end">ì„¸ê¸ˆ(3.3%)</th>
                        <th style="width:140px;" class="text-end">ì‹¤ìˆ˜ë ¹ì•¡(ê³„íš)</th>
                        <th style="width:120px;">ì§€ê¸‰ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="weeklyPlanBody">
                    <!-- JS ë Œë” -->
                    </tbody>
                    <tfoot>
                    <tr class="table-secondary fw-bold">
                        <!-- ì „ì²´ 11ì»¬ëŸ¼: 6 + 4 + 1 -->
                        <td colspan="6" class="text-end">ì›” í•©ê³„ (ê³„íš)</td>
                        <td class="text-end" id="monthPlanWorkPaySum">-</td>
                        <td class="text-end" id="monthPlanJuhyuPaySum">-</td>
                        <td class="text-end" id="monthPlanTaxSum">-</td>
                        <td class="text-end" id="monthPlanNetSum">-</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <!-- í•˜ë‹¨ ì„¤ëª… (ê³„íš ê¸°ì¤€) -->
            <div class="small text-muted mt-2">
                * ìƒë‹¨ ì‹¤ê·¼ë¬´ ê¸°ì¤€ í…Œì´ë¸”ê³¼ ê³„ì‚° ë°©ì‹ì€ ë™ì¼í•˜ë‚˜, ì‹¤ì œ ê·¼ë¬´ì‹œê°„ ëŒ€ì‹  <b>ê³„íšëœ ê·¼ë¬´ì‹œê°„</b>ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì¶œí•©ë‹ˆë‹¤.<br>
                * ì‹¤ì œ ì§€ê¸‰ì•¡ê³¼ì˜ ì°¨ì´ë¥¼ ë¹„êµí•  ë•Œ ì°¸ê³ ìš©ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div><!-- .pay-shell-body -->
    </div><!-- .pay-shell -->

</main>

<!-- ğŸ”µ ê³„íš ìš”ì•½ ëª¨ë‹¬ (Look & Feel ì¼ì¹˜) -->
<div class="modal fade" id="planSummaryModal" tabindex="-1" aria-labelledby="planSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planSummaryModalLabel">ê³„íšì¼ì • ê¸°ì¤€ ì›” í•©ì‚° ìš”ì•½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">
                    í˜„ì¬ ì„ íƒëœ <b>ìƒíƒœ</b>ì™€ <b>ì›”</b>ì„ ê¸°ì¤€ìœ¼ë¡œ, ê° ì¸ì›ì˜ ëª¨ë“  ì£¼ì°¨(ê³„íš) ê¸‰ì—¬ë¥¼ í•©ì‚°í•œ ìš”ì•½ì…ë‹ˆë‹¤.
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center" id="planSummaryTable">
                        <!-- âœ… ë™ì¼í•œ íŒŒë€ í—¤ë” / ë¼ìš´ë“œ ì½”ë„ˆ -->
                        <thead class="inner-table-header">
                        <tr>
                            <th style="width:160px;">ê·¼ë¬´ìëª…</th>
                            <th class="text-end" style="width:150px;">ê³„íšê·¼ë¬´ì‹œê°„ í•©ê³„</th>
                            <th class="text-end" style="width:120px;">ì‹œê¸‰</th>
                            <th style="width:110px;">ì£¼íœ´ìˆ˜ë‹¹ë¶€ê°€</th>
                            <th style="width:110px;">ì„¸ê¸ˆë¶€ê°€</th>
                            <th class="text-end" style="width:150px;">ê·¼ë¬´ìˆ˜ë‹¹ í•©ê³„</th>
                            <th class="text-end" style="width:150px;">ì£¼íœ´ìˆ˜ë‹¹ í•©ê³„</th>
                            <th class="text-end" style="width:150px;">ì„¸ê¸ˆ í•©ê³„</th>
                            <th class="text-end" style="width:150px;">ì‹¤ìˆ˜ë ¹ì•¡ í•©ê³„</th>
                        </tr>
                        </thead>
                        <tbody id="planSummaryTbody">
                        <!-- JS ë Œë” -->
                        </tbody>
                        <tfoot>
                        <tr class="table-secondary fw-bold">
                            <td class="text-end">ì„ íƒ ìƒíƒœ/ì›” ì „ì²´ í•©ê³„</td>
                            <td class="text-end" id="planSummaryTotalWorkTime">-</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td class="text-end" id="planSummaryTotalWorkPay">-</td>
                            <td class="text-end" id="planSummaryTotalJuhyuPay">-</td>
                            <td class="text-end" id="planSummaryTotalTax">-</td>
                            <td class="text-end" id="planSummaryTotalNet">-</td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ’„ ìŠ¤íƒ€ì¼ -->
<style>
    .text-money{color:#0d6efd;font-weight:600}
    .text-time{color:#198754;font-weight:600}
    .small-muted{color:#6c757d;font-size:.85rem}
    .week-label{white-space:nowrap}

    /* âœ… ì „ì²´ ì™¸ë¶€ ë¼ìš´ë“œ ë°•ìŠ¤ */
    .pay-shell{
        border-radius:1rem;
        border:1px solid #dee2e6;
        overflow:hidden;
        background:#ffffff;
        box-shadow:0 4px 12px rgba(0,0,0,0.03);
    }

    /* âœ… ì™¸ë¶€ ìƒë‹¨ í—¤ë” (íŒŒë€ìƒ‰) */
    .pay-shell-header{
        background:#0d6efd;
        color:#ffffff;
        padding:0.75rem 1rem;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:1rem;
    }

    /* ì™¸ë¶€ ë‚´ìš© ì˜ì—­ */
    .pay-shell-body{
        padding:1.25rem 1.5rem 1.5rem;
    }

    /* âœ… ë‚´ë¶€ ì£¼ì°¨ë³„ ê¸‰ì—¬/ìš”ì•½ í…Œì´ë¸” í—¤ë”: íŒŒë€ìƒ‰ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    .inner-table-header th{
        background:#0d6efd !important;
        color:#ffffff !important;
        border-color:#0b5ed7 !important;
        vertical-align:middle;
    }
    .inner-table-header th:first-child{
        border-top-left-radius:0.75rem;
    }
    .inner-table-header th:last-child{
        border-top-right-radius:0.75rem;
    }

    /* ë‚´ë¶€ í…Œì´ë¸” ìì²´ ëª¨ì„œë¦¬ ë¼ìš´ë“œ (ì‹¤ê·¼ë¬´/ê³„íš/ìš”ì•½ ê³µí†µ) */
    #weeklyPayTable,
    #weeklyPlanTable,
    #planSummaryTable{
        border-collapse:separate;
        border-spacing:0;
        border-radius:0.75rem;
        overflow:hidden;
        background:#ffffff;
    }

    /* âœ… ì£¼ì°¨ë³„ ê°€ë¡œ êµ¬ë¶„ì„ : ì£¼ ë§ˆì§€ë§‰ í–‰ í•˜ë‹¨ ë³´ë” ë‘ê»ê²Œ (ì‹¤ê·¼ë¬´/ê³„íš ê³µí†µ) */
    #weeklyPayTable tbody tr.week-end-border td,
    #weeklyPlanTable tbody tr.week-end-border td{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }

    /* âœ… ì£¼ì°¨ ì»¬ëŸ¼(td, rowspan ì ìš©ëœ ì…€)ì—ë„ ë™ì¼í•˜ê²Œ êµµì€ í•˜ë‹¨ì„  (ì‹¤ê·¼ë¬´/ê³„íš ê³µí†µ) */
    #weeklyPayTable tbody td.week-label-border,
    #weeklyPlanTable tbody td.week-label-border{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }
</style>

<!-- ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ë©¤ë²„ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        /* ===== ì„¤ì •/API ===== */
        const API_BASE_ACTUAL = '/api/schedule';       // GET /{memberId}/{startIso}/{endIso}  (ì‹¤ì œ)
        const API_BASE_PLAN   = '/api/schedule/work';  // GET /{memberId}/{startIso}/{endIso}  (ê³„íš)

        /* ===== DOM ===== */
        const statusSelect     = document.getElementById('statusSelect');

        const btnMonthPrev     = document.getElementById('btnMonthPrev');
        const btnMonthThis     = document.getElementById('btnMonthThis');
        const btnMonthNext     = document.getElementById('btnMonthNext');
        const monthRangeLabel  = document.getElementById('monthRangeLabel');

        // ì‹¤ê·¼ë¬´ ê¸°ì¤€ í…Œì´ë¸”
        const weeklyPayBody        = document.getElementById('weeklyPayBody');
        const monthWorkPaySumEl    = document.getElementById('monthWorkPaySum');
        const monthJuhyuPaySumEl   = document.getElementById('monthJuhyuPaySum');
        const monthTaxSumEl        = document.getElementById('monthTaxSum');
        const monthNetSumEl        = document.getElementById('monthNetSum');

        // ê³„íš ê¸°ì¤€ í…Œì´ë¸”
        const weeklyPlanBody          = document.getElementById('weeklyPlanBody');
        const monthPlanWorkPaySumEl   = document.getElementById('monthPlanWorkPaySum');
        const monthPlanJuhyuPaySumEl  = document.getElementById('monthPlanJuhyuPaySum');
        const monthPlanTaxSumEl       = document.getElementById('monthPlanTaxSum');
        const monthPlanNetSumEl       = document.getElementById('monthPlanNetSum');

        // ê³„íš ìš”ì•½ ëª¨ë‹¬ ê´€ë ¨ DOM
        const btnPlanSummary                = document.getElementById('btnPlanSummary');
        const planSummaryTbody              = document.getElementById('planSummaryTbody');
        const planSummaryTotalWorkTimeEl    = document.getElementById('planSummaryTotalWorkTime');
        const planSummaryTotalWorkPayEl     = document.getElementById('planSummaryTotalWorkPay');
        const planSummaryTotalJuhyuPayEl    = document.getElementById('planSummaryTotalJuhyuPay');
        const planSummaryTotalTaxEl         = document.getElementById('planSummaryTotalTax');
        const planSummaryTotalNetEl         = document.getElementById('planSummaryTotalNet');

        /* ===== ìƒíƒœ ===== */
        let allMembers = [];
        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); }
        catch(e){ allMembers = []; }

        let filteredMembers   = [];
        let currentMonthStart = firstDayOfMonth(new Date());

        // ê³„íš ìš”ì•½ìš© ëˆ„ì  ë§µ: { memberId: { member, minutesSum, workPaySum, juhyuPaySum, taxSum, netSum } }
        let planSummaryMap = {};

        /* ===== ì´ˆê¸°í™” ===== */
        if (Array.isArray(allMembers) && allMembers.length>0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        statusSelect.addEventListener('change', refreshMembers);
        btnMonthPrev.addEventListener('click', ()=> {
            currentMonthStart = new Date(
                    currentMonthStart.getFullYear(),
                    currentMonthStart.getMonth()-1,
                    1
            );
            loadAllTables();
        });
        btnMonthThis.addEventListener('click', ()=> {
            currentMonthStart = firstDayOfMonth(new Date());
            loadAllTables();
        });
        btnMonthNext.addEventListener('click', ()=> {
            currentMonthStart = new Date(
                    currentMonthStart.getFullYear(),
                    currentMonthStart.getMonth()+1,
                    1
            );
            loadAllTables();
        });

        // ğŸ”¹ PDF ë²„íŠ¼ â€“ í˜„ì¬ ìƒíƒœê°’ì„ ì¿¼ë¦¬ë¡œ ë¶™ì—¬ì„œ í˜¸ì¶œ (ì‹¤ê·¼ë¬´ ê¸°ì¤€ ìš©)
        document.getElementById('pdfBtn').addEventListener('click', function(){
            const status = document.getElementById('statusSelect').value;
            this.href = `/payment/paymanagerdashboard/print?status=${encodeURIComponent(status)}`;
        });

        // ğŸ”¹ ìš”ì•½ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ, ìš”ì•½ í…Œì´ë¸” ë Œë”
        if (btnPlanSummary) {
            btnPlanSummary.addEventListener('click', renderPlanSummaryTable);
        }

        refreshMembers();

        /* ===== ë©¤ë²„ í•„í„° ===== */
        function refreshMembers(){
            const status = statusSelect.value;
            filteredMembers = (allMembers||[]).filter(m => m.status === status);
            loadAllTables();
        }

        /* ===== ì‹¤ê·¼ë¬´/ê³„íš í…Œì´ë¸” ë‘˜ ë‹¤ ë¡œë”© ===== */
        function loadAllTables(){
            loadWeeklyActualTable();
            loadWeeklyPlanTable();
        }

        /* ===== ì£¼ì°¨ í…Œì´ë¸” ë Œë” (ì‹¤ê·¼ë¬´ ê¸°ì¤€) ===== */
        async function loadWeeklyActualTable(){
            const ms = firstDayOfMonth(currentMonthStart);
            const me = lastDayOfMonth(currentMonthStart);
            monthRangeLabel.textContent =
                    `${ms.getFullYear()}.${pad2(ms.getMonth()+1)}.01 ~ ${pad2(me.getMonth()+1)}.${pad2(me.getDate())}`;

            weeklyPayBody.innerHTML = '';
            setFooterSumsActual(0,0,0,0);

            if (!filteredMembers.length){
                const tr = document.createElement('tr');
                tr.classList.add('week-end-border'); // ì£¼ê°€ ì•„ì˜ˆ ì—†ì„ ë•Œë„ í•˜ë‹¨ì„  ìœ ì§€
                tr.innerHTML = `<td colspan="11" class="text-muted">í‘œì‹œí•  ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                weeklyPayBody.appendChild(tr);
                return;
            }

            const msIso = toIso(ms), meIso = toIso(me);
            const memberDayMap = {}; // { memberId: { isoDate: {minutes, segments[]} } }

            await Promise.all(filteredMembers.map(async m=>{
                try{
                    const url = `${API_BASE_ACTUAL}/${encodeURIComponent(m.id)}/${msIso}/${meIso}`;
                    const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                    if (resp.ok){
                        const data = await resp.json();
                        memberDayMap[m.id] = normalizeDays(data);
                    } else {
                        memberDayMap[m.id] = {};
                    }
                }catch(e){
                    console.error('schedule actual fetch error', e);
                    memberDayMap[m.id] = {};
                }
            }));

            // ì›”ì„ í¬í•¨í•˜ëŠ” ëª¨ë“  ì£¼(ì›”~ì¼) ì‹œì‘ì¼ ëª©ë¡(Mon)
            const weeks   = [];
            let wStart    = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd){
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate()+7);
            }

            // ì›” í•©ê³„
            let monthWorkPaySum = 0;
            let monthJuhyuPaySum = 0;
            let monthTaxSum = 0;
            let monthNetSum = 0;

            // ì£¼ì°¨ë³„ ë Œë”
            weeks.forEach((weekStart, idx)=>{
                const weekEnd = addDays(weekStart, 6);

                // í•´ë‹¹ ì£¼ ê° ë©¤ë²„ì˜ ì£¼ê°„ í•©ê³„ ê³„ì‚°
                const rows = [];
                filteredMembers.forEach(m=>{
                    const wage = Number(m.hourlyWage)||0;
                    const includeJuhyu = !!m.includeWeeklyHolidayAllowance;
                    const applyTax = isTaxApplied(m);

                    let weekMinutes = 0;
                    for (let i=0;i<7;i++){
                        const d = addDays(weekStart, i);
                        if (d < ms || d > me) continue;
                        const iso = toIso(d);
                        const info = (memberDayMap[m.id]||{})[iso] || {minutes:0};
                        weekMinutes += (info.minutes||0);
                    }
                    if (weekMinutes <= 0) return; // ê·¼ë¬´ ì—†ëŠ” ë©¤ë²„ëŠ” í‘œì—ì„œ ì œì™¸

                    const workPay = Math.round((weekMinutes/60) * wage);
                    let juhyuPay = 0;
                    let juhyuApplied = false;
                    if (includeJuhyu && weekMinutes >= 15*60){
                        const juhyuMinutes = Math.round(weekMinutes / 5);
                        juhyuPay = Math.round((juhyuMinutes/60) * wage);
                        juhyuApplied = true;
                    }

                    const grossTotal = workPay + juhyuPay;
                    let taxAmount = 0;
                    let netTotal = grossTotal;
                    if (applyTax && grossTotal > 0){
                        taxAmount = Math.round(grossTotal * 0.033);
                        netTotal  = grossTotal - taxAmount;
                    }

                    rows.push({
                        member: m,
                        weekMinutes,
                        wage,
                        juhyuApplied,
                        workPay,
                        juhyuPay,
                        applyTax,
                        taxAmount,
                        grossTotal,
                        netTotal
                    });
                });

                // ì£¼ì— í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ë‹¤ë©´ í•œ ì¤„ë¡œ "í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ ì—†ìŒ"
                if (rows.length === 0) {
                    const tr = document.createElement('tr');
                    const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;
                    tr.innerHTML = `
          <td class="week-label week-label-border">${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small></td>
          <td colspan="10" class="text-muted text-start">í•´ë‹¹ ì£¼ ì‹¤ê·¼ë¬´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        `;
                    tr.classList.add('week-end-border'); // ì£¼ ë§ˆì§€ë§‰ í–‰
                    weeklyPayBody.appendChild(tr);
                    return;
                }

                // ì´ë¦„ìˆœ ì •ë ¬
                rows.sort((a,b)=>(a.member.name||'').localeCompare(b.member.name||'','ko'));

                // ì£¼ì°¨ rowSpan
                const rowSpan   = rows.length;
                const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                rows.forEach((r, i)=>{
                    const tr = document.createElement('tr');
                    const weekCell = (i===0)
                            ? `<td class="week-label week-label-border" rowspan="${rowSpan}">
               ${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small>
             </td>`
                            : '';

                    tr.innerHTML = `
          ${weekCell}
          <td class="text-start">${escapeHtml(r.member.name||'-')}</td>
          <td class="text-end"><span class="text-time">${formatMins(r.weekMinutes)}</span></td>
          <td class="text-end">${r.wage ? krw(r.wage) : '-'}</td>
          <td>${r.juhyuApplied ? '<span class="text-success fw-bold">ì ìš©</span>' : '<span class="text-muted">ë¯¸ì ìš©</span>'}</td>
          <td>${r.applyTax ? '<span class="text-danger fw-bold">ë¶€ê³¼</span>' : '<span class="text-muted">ë¯¸ë¶€ê³¼</span>'}</td>
          <td class="text-end">${krw(r.workPay)}</td>
          <td class="text-end">${krw(r.juhyuPay)}</td>
          <td class="text-end">${r.applyTax ? krw(r.taxAmount) : '-'}</td>
          <td class="text-end"><span class="fw-bold text-primary">${krw(r.netTotal)}</span></td>
          <td class="text-center small">(ë§¤ì›”)${formatPayday(r.member.payday)}</td>
        `;

                    // âœ… ì´ ì£¼(week)ì˜ ë§ˆì§€ë§‰ í–‰ì´ë©´, ê°€ë¡œ êµ¬ë¶„ì„  í´ë˜ìŠ¤ ì¶”ê°€
                    if (i === rows.length - 1) {
                        tr.classList.add('week-end-border');
                    }

                    weeklyPayBody.appendChild(tr);
                });

                // ì›” í•©ê³„ ëˆ„ì 
                monthWorkPaySum  += rows.reduce((sum,r)=> sum + r.workPay,    0);
                monthJuhyuPaySum += rows.reduce((sum,r)=> sum + r.juhyuPay,   0);
                monthTaxSum      += rows.reduce((sum,r)=> sum + r.taxAmount,  0);
                monthNetSum      += rows.reduce((sum,r)=> sum + r.netTotal,   0);
            });

            setFooterSumsActual(monthWorkPaySum, monthJuhyuPaySum, monthTaxSum, monthNetSum);
        }

        /* ===== ì£¼ì°¨ í…Œì´ë¸” ë Œë” (ê³„íšì¼ì • ê¸°ì¤€) ===== */
        async function loadWeeklyPlanTable(){
            const ms = firstDayOfMonth(currentMonthStart);
            const me = lastDayOfMonth(currentMonthStart);

            weeklyPlanBody.innerHTML = '';
            setFooterSumsPlan(0,0,0,0);

            // ìš”ì•½ ë§µ ì´ˆê¸°í™”
            planSummaryMap = {};

            if (!filteredMembers.length){
                const tr = document.createElement('tr');
                tr.classList.add('week-end-border');
                tr.innerHTML = `<td colspan="11" class="text-muted">í‘œì‹œí•  ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                weeklyPlanBody.appendChild(tr);
                return;
            }

            const msIso = toIso(ms), meIso = toIso(me);
            const memberDayMapPlan = {}; // { memberId: { isoDate: {minutes, segments[]} } }

            await Promise.all(filteredMembers.map(async m=>{
                try{
                    const url = `${API_BASE_PLAN}/${encodeURIComponent(m.id)}/${msIso}/${meIso}`;
                    const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                    if (resp.ok){
                        const data = await resp.json();
                        memberDayMapPlan[m.id] = normalizeDays(data);
                    } else {
                        memberDayMapPlan[m.id] = {};
                    }
                }catch(e){
                    console.error('schedule plan fetch error', e);
                    memberDayMapPlan[m.id] = {};
                }
            }));

            // ì›”ì„ í¬í•¨í•˜ëŠ” ëª¨ë“  ì£¼(ì›”~ì¼) ì‹œì‘ì¼ ëª©ë¡(Mon)
            const weeks   = [];
            let wStart    = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd){
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate()+7);
            }

            // ì›” í•©ê³„ (ê³„íš)
            let monthPlanWorkPaySum  = 0;
            let monthPlanJuhyuPaySum = 0;
            let monthPlanTaxSum      = 0;
            let monthPlanNetSum      = 0;

            weeks.forEach((weekStart, idx)=>{
                const weekEnd = addDays(weekStart, 6);

                const rows = [];
                filteredMembers.forEach(m=>{
                    const wage = Number(m.hourlyWage)||0;
                    const includeJuhyu = !!m.includeWeeklyHolidayAllowance;
                    const applyTax = isTaxApplied(m);

                    let weekMinutes = 0;
                    for (let i=0;i<7;i++){
                        const d = addDays(weekStart, i);
                        if (d < ms || d > me) continue;
                        const iso = toIso(d);
                        const info = (memberDayMapPlan[m.id]||{})[iso] || {minutes:0};
                        weekMinutes += (info.minutes||0);
                    }
                    if (weekMinutes <= 0) return; // ê³„íš ì—†ëŠ” ë©¤ë²„ëŠ” í‘œì—ì„œ ì œì™¸

                    const workPay = Math.round((weekMinutes/60) * wage);
                    let juhyuPay = 0;
                    let juhyuApplied = false;
                    if (includeJuhyu && weekMinutes >= 15*60){
                        const juhyuMinutes = Math.round(weekMinutes / 5);
                        juhyuPay = Math.round((juhyuMinutes/60) * wage);
                        juhyuApplied = true;
                    }

                    const grossTotal = workPay + juhyuPay;
                    let taxAmount = 0;
                    let netTotal = grossTotal;
                    if (applyTax && grossTotal > 0){
                        taxAmount = Math.round(grossTotal * 0.033);
                        netTotal  = grossTotal - taxAmount;
                    }

                    rows.push({
                        member: m,
                        weekMinutes,
                        wage,
                        juhyuApplied,
                        workPay,
                        juhyuPay,
                        applyTax,
                        taxAmount,
                        grossTotal,
                        netTotal
                    });

                    // ğŸ”µ ê³„íš ìš”ì•½ ë§µì— ëˆ„ì  (ëª¨ë“  ì£¼ì°¨ í•©ì‚°)
                    let acc = planSummaryMap[m.id];
                    if (!acc){
                        acc = {
                            member: m,
                            minutesSum: 0,
                            workPaySum: 0,
                            juhyuPaySum: 0,
                            taxSum: 0,
                            netSum: 0
                        };
                        planSummaryMap[m.id] = acc;
                    }
                    acc.minutesSum += weekMinutes;
                    acc.workPaySum += workPay;
                    acc.juhyuPaySum += juhyuPay;
                    acc.taxSum     += taxAmount;
                    acc.netSum     += netTotal;
                });

                if (rows.length === 0) {
                    const tr = document.createElement('tr');
                    const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;
                    tr.innerHTML = `
          <td class="week-label week-label-border">${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small></td>
          <td colspan="10" class="text-muted text-start">í•´ë‹¹ ì£¼ ê³„íš ê·¼ë¬´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        `;
                    tr.classList.add('week-end-border');
                    weeklyPlanBody.appendChild(tr);
                    return;
                }

                rows.sort((a,b)=>(a.member.name||'').localeCompare(b.member.name||'','ko'));

                const rowSpan   = rows.length;
                const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                rows.forEach((r, i)=>{
                    const tr = document.createElement('tr');
                    const weekCell = (i===0)
                            ? `<td class="week-label week-label-border" rowspan="${rowSpan}">
               ${idx+1}ì£¼ì°¨<br><small class="text-muted">(${weekLabel})</small>
             </td>`
                            : '';

                    tr.innerHTML = `
          ${weekCell}
          <td class="text-start">${escapeHtml(r.member.name||'-')}</td>
          <td class="text-end"><span class="text-time">${formatMins(r.weekMinutes)}</span></td>
          <td class="text-end">${r.wage ? krw(r.wage) : '-'}</td>
          <td>${r.juhyuApplied ? '<span class="text-success fw-bold">ì ìš©</span>' : '<span class="text-muted">ë¯¸ì ìš©</span>'}</td>
          <td>${r.applyTax ? '<span class="text-danger fw-bold">ë¶€ê³¼</span>' : '<span class="text-muted">ë¯¸ë¶€ê³¼</span>'}</td>
          <td class="text-end">${krw(r.workPay)}</td>
          <td class="text-end">${krw(r.juhyuPay)}</td>
          <td class="text-end">${r.applyTax ? krw(r.taxAmount) : '-'}</td>
          <td class="text-end"><span class="fw-bold text-primary">${krw(r.netTotal)}</span></td>
          <td class="text-center small">(ë§¤ì›”)${formatPayday(r.member.payday)}</td>
        `;

                    if (i === rows.length - 1) {
                        tr.classList.add('week-end-border');
                    }

                    weeklyPlanBody.appendChild(tr);
                });

                monthPlanWorkPaySum  += rows.reduce((sum,r)=> sum + r.workPay,    0);
                monthPlanJuhyuPaySum += rows.reduce((sum,r)=> sum + r.juhyuPay,   0);
                monthPlanTaxSum      += rows.reduce((sum,r)=> sum + r.taxAmount,  0);
                monthPlanNetSum      += rows.reduce((sum,r)=> sum + r.netTotal,   0);
            });

            setFooterSumsPlan(monthPlanWorkPaySum, monthPlanJuhyuPaySum, monthPlanTaxSum, monthPlanNetSum);
        }

        function setFooterSumsActual(work, juhyu, tax, net){
            monthWorkPaySumEl.textContent  = krw(work|0);
            monthJuhyuPaySumEl.textContent = krw(juhyu|0);
            monthTaxSumEl.textContent      = tax ? krw(tax|0) : '-';
            monthNetSumEl.textContent      = krw(net|0);
        }

        function setFooterSumsPlan(work, juhyu, tax, net){
            monthPlanWorkPaySumEl.textContent  = krw(work|0);
            monthPlanJuhyuPaySumEl.textContent = krw(juhyu|0);
            monthPlanTaxSumEl.textContent      = tax ? krw(tax|0) : '-';
            monthPlanNetSumEl.textContent      = krw(net|0);
        }

        /* ===== ê³„íš ìš”ì•½ ëª¨ë‹¬ ë Œë” ===== */
        function renderPlanSummaryTable(){
            planSummaryTbody.innerHTML = '';

            const entries = Object.values(planSummaryMap || {}).filter(e => (e.minutesSum||0) > 0);

            if (!entries.length){
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="9" class="text-muted">í‘œì‹œí•  ìš”ì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
                planSummaryTbody.appendChild(tr);
                setPlanSummaryFooter(0,0,0,0,0);
                return;
            }

            // ì´ë¦„ ìˆœ ì •ë ¬
            entries.sort((a,b)=>(a.member.name||'').localeCompare(b.member.name||'','ko'));

            let totalMinutes = 0;
            let totalWorkPay = 0;
            let totalJuhyuPay = 0;
            let totalTax = 0;
            let totalNet = 0;

            entries.forEach(e=>{
                const m = e.member || {};
                totalMinutes += e.minutesSum||0;
                totalWorkPay += e.workPaySum||0;
                totalJuhyuPay += e.juhyuPaySum||0;
                totalTax     += e.taxSum||0;
                totalNet     += e.netSum||0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td class="text-start">${escapeHtml(m.name || '-')}</td>
          <td class="text-end"><span class="text-time">${formatMins(e.minutesSum||0)}</span></td>
          <td class="text-end">${m.hourlyWage ? krw(m.hourlyWage) : '-'}</td>
          <td>${m.includeWeeklyHolidayAllowance ? '<span class="text-success fw-bold">ì ìš©</span>' : '<span class="text-muted">ë¯¸ì ìš©</span>'}</td>
          <td>${isTaxApplied(m) ? '<span class="text-danger fw-bold">ë¶€ê³¼</span>' : '<span class="text-muted">ë¯¸ë¶€ê³¼</span>'}</td>
          <td class="text-end">${krw(e.workPaySum||0)}</td>
          <td class="text-end">${krw(e.juhyuPaySum||0)}</td>
          <td class="text-end">${isTaxApplied(m) ? krw(e.taxSum||0) : '-'}</td>
          <td class="text-end"><span class="fw-bold text-primary">${krw(e.netSum||0)}</span></td>
        `;
                planSummaryTbody.appendChild(tr);
            });

            setPlanSummaryFooter(totalMinutes, totalWorkPay, totalJuhyuPay, totalTax, totalNet);
        }

        function setPlanSummaryFooter(totalMinutes, totalWorkPay, totalJuhyuPay, totalTax, totalNet){
            if (!planSummaryTotalWorkTimeEl) return; // ì•ˆì „ì¥ì¹˜

            planSummaryTotalWorkTimeEl.textContent = totalMinutes > 0 ? formatMins(totalMinutes) : '-';
            planSummaryTotalWorkPayEl.textContent  = krw(totalWorkPay|0);
            planSummaryTotalJuhyuPayEl.textContent = krw(totalJuhyuPay|0);
            planSummaryTotalTaxEl.textContent      = totalTax ? krw(totalTax|0) : '-';
            planSummaryTotalNetEl.textContent      = krw(totalNet|0);
        }

        /* ===== ìœ í‹¸ ===== */
        function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
        function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d;
        }
        function normalizeDays(apiData){
            const map={}; const arr=Array.isArray(apiData?.days)?apiData.days:[];
            arr.forEach(d=>{
                const date=String(d.date);
                const segs=Array.isArray(d.segments)?d.segments:[];
                const minutes=(typeof d.minutes==='number')
                        ? d.minutes
                        : segs.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments: segs, minutes };
            });
            return map;
        }
        function diffMinutes(start,end){
            const s=parseHm(start), e=parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm || typeof hm!=='string') return {h:0,m:0};
            const [h,m]=hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function formatMins(mins){
            mins=Math.max(0, mins|0);
            const h=Math.floor(mins/60), m=mins%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }
        function krw(v){
            return new Intl.NumberFormat('ko-KR',{
                style:'currency',
                currency:'KRW',
                maximumFractionDigits:0
            }).format(v|0);
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        // applyTax ê°’(Y/N, true/false, 1/0 ë“±)ì„ boolean ìœ¼ë¡œ ì •ê·œí™”
        function isTaxApplied(member){
            const v = member?.applyTax;
            if (v === true) return true;
            if (v === false || v == null) return false;
            if (typeof v === 'number') return v === 1;
            if (typeof v === 'string'){
                const s = v.trim().toUpperCase();
                return s === 'Y' || s === 'TRUE' || s === 'T' || s === '1';
            }
            return false;
        }

        // âœ… payday í¬ë§·íŒ…
        function formatPayday(v){
            if (!v) return 'ë¯¸ì§€ì •';
            const s = String(v).trim().toUpperCase();
            if (s === 'EOM') return 'ë§ì¼';
            if (/^\d+$/.test(s)) {
                const n = parseInt(s, 10);
                if (n >= 1 && n <= 31) return `${n}ì¼`;
            }
            return s;
        }

    })();
</script>

{{>layouts/footer_}}
