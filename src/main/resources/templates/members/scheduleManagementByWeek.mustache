{{>layouts/header}}

<main class="container my-4">
    <!-- 상단: 상태 선택 + 필터된 아르바이트 리스트 -->
    <div class="card mb-3 status-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="fw-bold">아르바이트 상태별 보기</div>
            <div class="small">
                <span id="weekRangeLabel"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label small" for="statusSelect">상태</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>근무중</option>
                        <option value="WAITING">시작전</option>
                        <option value="RESTING">휴식중</option>
                        <option value="PAUSED">일시중지</option>
                        <option value="RESIGNED">퇴사</option>
                    </select>
                    <div class="form-text">상태를 바꾸면 아래 리스트와 타임테이블이 함께 바뀝니다.</div>
                </div>
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">필터된 아르바이트생</span>
                        <span id="memberCountBadge" class="badge bg-secondary">0명</span>
                    </div>
                    <div id="memberList" class="vlist"></div>
                    <div class="small mt-2">
                        * 각 사람 옆의 색상은 해당 근로자의 고유 색입니다. (아래 타임테이블에도 동일 색 사용)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단: 주간 타임테이블 -->
    <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
                <span>주간 타임테이블 (월~일)</span>
                <div class="mt-1 btn-group btn-group-sm" role="group" aria-label="단위 선택">
                    <button type="button" id="btnSlot10" class="btn btn-sm btn-outline-secondary">10분</button>
                    <button type="button" id="btnSlot30" class="btn btn-sm btn-outline-secondary">30분</button>
                    <button type="button" id="btnSlot60" class="btn btn-sm btn-outline-secondary active">1시간</button>
                </div>
                <span class="small text-muted mt-1">
                    한 칸 = 선택된 단위, 각 요일 사이의 열은 해당 시간대 인원수, 마지막 열은 전체 인원수
                </span>
            </div>

            <!-- 우측: 지난주 / [날짜범위] / 금주 / 다음주 -->
            <div class="d-flex align-items-center gap-2">
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-secondary">◀ 지난주</button>
                <span id="weekRangeLabelRight" class="small text-muted px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-secondary">금주</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-secondary">다음주 ▶</button>
            </div>
        </div>
        <div class="card-body">
            <div id="noMemberState" class="text-muted small d-none">
                해당 상태의 아르바이트생이 없습니다.
            </div>
            <div id="timetableWrapper" class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weekStaffTable">
                    <thead class="table-light">
                    <tr>
                        <th style="width:80px;">시간</th>

                        <!-- 월: 헤더 요일/인원 합치기 -->
                        <th data-dow="0" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">월</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 화 -->
                        <th data-dow="1" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">화</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 수 -->
                        <th data-dow="2" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">수</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 목 -->
                        <th data-dow="3" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">목</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 금 -->
                        <th data-dow="4" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">금</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 토 -->
                        <th data-dow="5" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">토</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <!-- 일 -->
                        <th data-dow="6" class="dow-head" colspan="2">
                            <div class="day-head-rect">
                                <div class="day-head-main">
                                    <span class="day-name">일</span>
                                    <span class="day-date ms-1 small text-light opacity-75"></span>
                                </div>
                                <div class="day-edit-wrap mt-1"></div>
                            </div>
                        </th>

                        <th style="width:80px;">합계</th>
                    </tr>
                    </thead>
                    <tbody id="weekStaffTbody">
                    <!-- JS 렌더 -->
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">
                * 하이라이트(상단 칩 선택)된 아르바이트생이 포함된 셀을 클릭하면 해당 요일 헤더에 <b>‘근무일정 수정’</b> 버튼이 나타납니다.<br>
                * 포함되지 않은 셀을 클릭하면 해당 요일 헤더에 <b>‘일정생성하기’</b> 버튼이 나타납니다.<br>
                * 각 요일 사이의 회색 열은 해당 시간대의 인원수를 나타냅니다.
            </div>
        </div>
    </div>

    <!-- 선택된 아르바이트생 개별 주간 일정 (하단, 기본 접힘) -->
    <div class="card mt-3 d-none" id="memberWeekCard">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <span class="fw-bold" id="memberWeekTitle">개별 주간 일정</span>
                <span class="badge bg-secondary ms-2" id="memberWeekNameBadge"></span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnToggleMemberWeek">펼치기</button>
                <span class="fw-bold" id="memberWeekSaveHint">(10단위 저장만 가능합니다.)</span>
                <button type="submit" class="btn btn-sm btn-primary" form="memberWeekForm" id="btnSaveWeek" disabled>저장</button>
            </div>
        </div>
        <div class="card-body d-none" id="memberWeekBody">
            <div id="noPlanAlert" class="alert alert-warning py-2 px-3 d-none">
                <strong>예정된 일정이 없습니다.</strong> 일정을 생성하세요.
            </div>

            <form id="memberWeekForm" class="mt-0">
                <div class="grid-toolbar mb-2">
                    <div class="left">
                        <div class="btn-group btn-group-sm" id="gridSlotButtons" role="group" aria-label="슬롯 단위 선택">
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="10">10분</button>
                            <button type="button" class="btn btn-outline-secondary" data-grid-slot="30">30분</button>
                            <button type="button" class="btn btn-outline-secondary active" data-grid-slot="60">1시간</button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="btnGridClearAll">전체 초기화</button>
                    </div>
                    <div class="right small text-muted">
                        시간 슬롯을 드래그해서 선택/해제할 수 있습니다. (06:00 ~ 22:00)
                    </div>
                </div>

                <div class="week-grid mb-0">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:74px;">시간</th>
                            <th data-day-offset="0">월</th>
                            <th data-day-offset="1">화</th>
                            <th data-day-offset="2">수</th>
                            <th data-day-offset="3">목</th>
                            <th data-day-offset="4">금</th>
                            <th data-day-offset="5">토</th>
                            <th data-day-offset="6">일</th>
                        </tr>
                        </thead>
                        <tbody id="memberWeekGridBody">
                        <!-- JS 렌더 -->
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- ===== 편집 모달 ===== -->
<div class="modal" id="editModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <div class="d-flex justify-content-between align-items-center mb-2 edit-modal-header">
                <div class="fw-bold">
                    <span id="editTitleDate">0000-00-00</span>
                    <span class="text-muted">/</span>
                    <span id="editTitleMember">알바생 이름</span>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnSaveEdit" class="btn btn-sm btn-primary" disabled>저장</button>
                    <button id="btnCancelEdit" class="btn btn-sm btn-outline-secondary">취소</button>
                    <button id="btnCloseModal" class="btn btn-sm btn-outline-dark">닫기</button>
                </div>
            </div>

            <div class="edit-modal-body">
                <div class="row g-3">
                    <!-- 좌: 일정 요약 -->
                    <div class="col-12 col-md-5">
                        <div class="summary-box p-2 border rounded-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="small text-muted">일정 요약</div>
                                <span class="badge bg-light text-dark" id="summaryStepBadge">슬롯: 30분</span>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">저장된 일정</div>
                                <div id="summaryOriginal" class="d-flex flex-wrap gap-2 small text-muted"></div>
                            </div>

                            <div class="mb-2">
                                <div class="small fw-semibold">수정안(현재 선택)</div>
                                <div id="summaryCurrent" class="d-flex flex-wrap gap-2 small"></div>
                            </div>

                            <div class="mt-2 small">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">원본 총 시간</span>
                                    <span id="summaryOriginalTotal" class="fw-semibold">0분</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">수정안 총 시간</span>
                                    <span id="summaryCurrentTotal" class="fw-semibold">0분</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">증감(수정안 - 원본)</span>
                                    <span id="summaryDiffTotal" class="fw-semibold">0분</span>
                                </div>
                            </div>

                            <div class="mt-2 small">
                                <span class="legend legend-actual"></span> 원본 유지 블록
                                &nbsp;·&nbsp;
                                <span class="legend legend-plan" style="background: rgba(13,110,253,.16); border-color: rgba(13,110,253,.45)"></span> 새로 추가된 블록(파란색)
                            </div>
                        </div>
                    </div>

                    <!-- 우: 편집 그리드 -->
                    <div class="col-12 col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" id="slotStepButtons" role="group" aria-label="슬롯 단위">
                                <button type="button" class="btn btn-outline-secondary" data-step="10">10분</button>
                                <button type="button" class="btn btn-outline-secondary active" data-step="30">30분</button>
                                <button type="button" class="btn btn-outline-secondary" data-step="60">1시간</button>
                            </div>
                            <div class="small text-muted">시간 슬롯을 드래그로 선택/해제합니다. (06:00 ~ 22:00)</div>
                        </div>

                        <div class="day-grid mb-2">
                            <table id="dayGridTable">
                                <thead>
                                <tr>
                                    <th style="width:74px;">시간</th>
                                    <th>선택</th>
                                </tr>
                                </thead>
                                <tbody id="dayGridBody">
                                <!-- JS 렌더 -->
                                </tbody>
                            </table>
                        </div>

                        <div class="text-end small">
                            총 선택: <span id="selectedMinutes" class="fw-bold">0</span>분
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* ===== 상단 카드(아르바이트 상태별 보기) 파란 라운드렉트 스타일 ===== */
    .status-card {
        border: none;
        border-radius: 18px;

        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        color: #f8fafc;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    }
    .status-card .card-header {
        border-bottom: none;
        background: transparent;
        color: #e5edff;
        padding-bottom: .5rem;
    }
    .status-card .card-body {
        background: transparent;
        color: #f9fafb;
        padding-top: .5rem;
    }
    .status-card .form-text,
    .status-card .small {
        color: rgba(248, 250, 252, 0.75) !important;
    }
    .status-card label.form-label {
        color: rgba(248, 250, 252, 0.85);
    }
    .status-card .form-select {
        background: rgba(15, 23, 42, 0.18);
        border-color: rgba(148, 163, 184, 0.6);
        color: #e5edff;
    }
    .status-card .form-select:focus {
        box-shadow: 0 0 0 .1rem rgba(191, 219, 254, .65);
        border-color: rgba(191, 219, 254, .9);
        background: rgba(15, 23, 42, 0.24);
        color: #eff6ff;
    }
    .status-card .badge.bg-secondary {
        background-color: rgba(15, 23, 42, 0.65) !important;
        color: #e5edff !important;
    }
    .status-card #memberCountBadge {
        background-color: #f9fafb !important;
        color: #2563eb !important;
    }
    .status-card .pill {
        background: #ffffff;
        border-color: rgba(148, 163, 184, 0.5);
    }
    .status-card .pill.active {
        background: #eff6ff;
        border-color: rgba(59, 130, 246, 0.9);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35) inset;
    }
    .status-card .pill .meta {
        color: #6b7280;
    }
    .status-card .pill .name {
        color: #000 !important;
        font-weight: 700 !important;
    }

    /* ===== 상단 리스트 ===== */
    .vlist { display:flex; flex-wrap:wrap; gap:8px; }
    .pill {
        display:flex; align-items:center; gap:8px; padding:8px 10px;
        border-radius:999px; border:1px solid #e9ecef; background:#fff; cursor:pointer;
        font-size:.9rem; transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .pill .dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.08); flex:0 0 12px; }
    .pill .name { font-weight:600; }
    .pill .meta { color:#6c757d; font-size:.8rem; }
    .pill.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset; background:#f0f6ff;
    }

    /* ===== 타임테이블 ===== */
    #weekStaffTable { border-collapse: separate; border-spacing: 0; }
    .hour-row-header { font-variant-numeric: tabular-nums; }
    .staff-cell {
        vertical-align: middle;
        font-size:.85rem;
        cursor:pointer;
        padding:0 !important; /* 라운드 박스용 inner에 패딩 위임 */
    }
    .day-count-cell {
        font-size:0.75rem;
        color:#6c757d;
        padding:0 !important;
        font-variant-numeric: tabular-nums;
        line-height:1.1;
    }

    .staff-tags { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; }
    .staff-tag {
        display:inline-flex; align-items:center; gap:4px;
        border-radius:999px; padding:2px 6px; font-size:.75rem;
        background:#f8f9fa; border:1px solid #dee2e6; max-width:90px;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        transition: background-color .15s ease, border-color .15s ease, transform .1s ease;
    }
    .staff-tag-dot { width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.08); flex:0 0 10px; }
    .staff-count { font-weight:600; font-size:.9rem; }

    tr.hour-separator > td, tr.hour-separator > th { border-top:2px solid #dee2e6 !important; }

    .day-date { line-height: 1.1; }
    .dow-head {
        padding:4px 4px;
        background:transparent !important;
        border-bottom:none !important;
        vertical-align: top;
    }
    .day-head-rect {
        border-radius:14px;
        padding:6px 10px;
        background:linear-gradient(135deg, #1d4ed8, #2563eb);
        color:#f9fafb;
        box-shadow:0 10px 20px rgba(15,23,42,0.25);
        position:relative;
    }
    /* 오늘 요일 헤더: 주황색 */
    .day-head-rect.today-head {
        background: linear-gradient(135deg, #f97316, #ea580c);
    }
    .day-head-main {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:4px;
    }
    .day-name {
        font-weight:700;
        font-size:0.9rem;
    }
    .day-edit-wrap {
        min-height: 24px;
        display:flex;
        justify-content:flex-end;
        align-items:center;
        margin-top:4px;
    }
    .day-edit-btn {
        padding: 2px 8px;
        font-size: .75rem;
        border-radius:999px;
    }

    /* ===== 같은 시간대(월~일) 라운드 박스 ===== */
    .time-band-cell {
        border:none !important;       /* 테이블 cell 보더 제거 */
        background:transparent !important;
    }
    .time-band-inner {
        height:100%;
        width:100%;
        padding:.25rem .25rem;
        background:#f9fafb;
        border-top:1px solid #e5e7eb;
        border-bottom:1px solid #e5e7eb;
        display:flex;
        align-items:center;
        justify-content:center;
        box-sizing:border-box;
    }
    .time-band-left .time-band-inner {
        border-left:1px solid #e5e7eb;
        border-top-left-radius:12px;
        border-bottom-left-radius:12px;
    }
    .time-band-right .time-band-inner {
        border-right:1px solid #e5e7eb;
        border-top-right-radius:12px;
        border-bottom-right-radius:12px;
    }

    /* 오늘 컬럼 기본 강조 (라운드 박스 안쪽 배경) */
    td.today-col .time-band-inner {
        background-color: rgba(40,167,69,0.04);
    }

    /* 현재 시간대 행 강조 + 깜빡임용 */
    .current-time-row .hour-row-header {
        background:#fff7d6 !important;
        position:sticky;
        left:0;
        z-index:1;
    }
    .current-time-row .time-band-inner {
        background:rgba(255,249,196,0.6);
    }
    .current-time-row td.today-col .time-band-inner {
        background:rgba(255,243,205,0.9);
    }

    /* 선택된 아르바이트생 태그 강조 */
    .staff-tag.selected-member-tag {
        background: rgba(13,110,253,.10);
        border-color: rgba(13,110,253,.7);
        font-weight: 600;
        transform: scale(1.02);
    }

    /* 현재 시간대 아르바이트 태그 깜빡임 */
    .staff-tag-current {
        animation: staffTagBlink 1.05s step-start infinite;
        background: rgba(255,193,7,0.95) !important;
        border-color: rgba(255,193,7,1) !important;
        box-shadow: 0 0 0 2px rgba(255,193,7,0.7);
        color:#212529;
    }
    @keyframes staffTagBlink {
        0%   { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(255,193,7,0.0); }
        50%  { filter:brightness(1.15); box-shadow:0 0 0 3px rgba(255,193,7,0.7); }
        100% { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(255,193,7,0.0); }
    }

    /* 오늘 요일 헤더 깜빡임 (주황 계열) */
    .day-head-rect.current-time-day {
        animation: dayHeadBlink 1.05s step-start infinite;
        box-shadow:0 0 0 0 rgba(249,115,22,0.0);
    }
    @keyframes dayHeadBlink {
        0%   { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(249,115,22,0.0); }
        50%  { filter:brightness(1.1); box-shadow:0 0 0 4px rgba(249,115,22,0.7); }
        100% { filter:brightness(1.0); box-shadow:0 0 0 0 rgba(249,115,22,0.0); }
    }

    /* 개별 주간 일정 카드 */
    #memberWeekCard .table-sm td, #memberWeekCard .table-sm th { padding: .35rem .5rem; }

    /* 주간 그리드 */
    .week-grid { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; user-select: none; background:#fff; }
    .week-grid table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    .week-grid thead th { background: #f8fafc; color:#64748b; font-weight: 600; font-size: 0.9rem; border-bottom: 1px solid #e5e7eb; text-align: center; padding: .5rem .4rem; position: sticky; top: 0; z-index: 2; }
    .week-grid tbody th { background: #fafafa; color:#6b7280; font-weight: 600; width: 74px; border-right: 1px solid #e5e7eb; text-align: center; padding: .25rem .25rem; font-size: .8rem; position: sticky; left: 0; z-index: 1; }

    .slot-10m { border-bottom: 1px dashed #eef2f6; border-right: 1px dashed #eef2f6; height: 18px; cursor: pointer; background: #ffffff; border-radius: 6px; margin: 1px 0; }
    .slot-10m:hover { background: #f8fbff; }
    .slot-10m.selected { background: rgba(25,135,84,.18); box-shadow: inset 0 0 0 1px rgba(25,135,84,.25); }

    .row-hour-start td, .row-hour-start th { border-top: 2px solid #e5e7eb !important; }
    .timecell { font-variant-numeric: tabular-nums; }

    .grid-toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: .5rem; font-size: .85rem; }
    .grid-toolbar .left, .grid-toolbar .right { display: flex; gap: 8px; align-items: center; }

    /* ===== 편집 모달용 스타일 ===== */
    .legend { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #ddd; vertical-align:middle; }
    .legend-plan { background: rgba(13,110,253,.25); border-color: rgba(13,110,253,.45); }
    .legend-actual { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.40); }

    .modal { background:rgba(0,0,0,.35); position:fixed; inset:0; display:none; z-index:1055; }
    .modal-dialog { margin:50px auto; max-width:980px; }
    .modal-content { background:#fff; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.2); }
    .edit-modal-header { padding-bottom:4px; border-bottom:1px solid #e9ecef; }
    .edit-modal-body { padding-top:8px; }

    .summary-box .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e9ecef; border-radius:14px; background:#fff; }
    .chip .dot { width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.08); }

    .day-grid { width:100%; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; user-select:none; background:#fff; max-height:70vh; overflow-y:auto; }
    .day-grid table { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .day-grid thead th { background:#f8fafc; color:#64748b; font-weight:600; font-size:.95rem; border-bottom:1px solid #e5e7eb; text-align:center; padding:.6rem .4rem; position:sticky; top:0; z-index:2; }
    .day-grid tbody th.timecell { background:#fafafa; color:#6b7280; font-weight:600; width:74px; border-right:1px solid #e5e7eb; text-align:center; padding:.25rem .25rem; font-size:.85rem; position:sticky; left:0; z-index:1; font-variant-numeric:tabular-nums; }
    .slot-cell { border-bottom:1px dashed #eef2f6; height:18px; cursor:pointer; background:#ffffff; transition: background .12s; }
    .slot-cell:hover { background:#f8fbff; }
    .slot-cell.selected { background:rgba(25,135,84,.18); box-shadow:inset 0 0 0 1px rgba(25,135,84,.25); }
    .slot-cell.selected.selected-diff { background:rgba(13,110,253,0.16); box-shadow:inset 0 0 0 1px rgba(13,110,253,0.45); border-color:rgba(13,110,253,0.55); }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const API_BASE   = '/api/schedule/work';
        const API_UPDATE = '/api/schedule/work/update';
        const HOUR_START = 6;
        const HOUR_END   = 22;

        // DOM
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');

        const noMemberState    = document.getElementById('noMemberState');
        const timetableWrapper = document.getElementById('timetableWrapper');
        const weekStaffTable   = document.getElementById('weekStaffTable');
        const weekStaffTbody   = document.getElementById('weekStaffTbody');
        const dayHeaderCells   = document.querySelectorAll('#weekStaffTable thead th[data-dow]');

        const btnSlot10 = document.getElementById('btnSlot10');
        const btnSlot30 = document.getElementById('btnSlot30');
        const btnSlot60 = document.getElementById('btnSlot60');

        const btnPrevWeek = document.getElementById('btnPrevWeek');
        const btnThisWeek = document.getElementById('btnThisWeek');
        const btnNextWeek = document.getElementById('btnNextWeek');

        const memberWeekCard      = document.getElementById('memberWeekCard');
        const memberWeekTitle     = document.getElementById('memberWeekTitle');
        const memberWeekNameBadge = document.getElementById('memberWeekNameBadge');
        const memberWeekForm      = document.getElementById('memberWeekForm');
        const btnSaveWeek         = document.getElementById('btnSaveWeek');
        const memberWeekBody      = document.getElementById('memberWeekBody');
        const btnToggleMemberWeek = document.getElementById('btnToggleMemberWeek');

        const memberWeekGridBody      = document.getElementById('memberWeekGridBody');
        const gridSlotButtonsWrapper  = document.getElementById('gridSlotButtons');
        const btnGridClearAll         = document.getElementById('btnGridClearAll');
        const noPlanAlert             = document.getElementById('noPlanAlert');

        // 편집 모달
        const editModal            = document.getElementById('editModal');
        const editTitleDate        = document.getElementById('editTitleDate');
        const editTitleMember      = document.getElementById('editTitleMember');
        const btnSaveEdit          = document.getElementById('btnSaveEdit');
        const btnCancelEdit        = document.getElementById('btnCancelEdit');
        const btnCloseModal        = document.getElementById('btnCloseModal');
        const slotStepButtons      = document.getElementById('slotStepButtons');
        const dayGridBody          = document.getElementById('dayGridBody');
        const selectedMinutesEl    = document.getElementById('selectedMinutes');
        const summaryStepBadge     = document.getElementById('summaryStepBadge');
        const summaryOriginal      = document.getElementById('summaryOriginal');
        const summaryCurrent       = document.getElementById('summaryCurrent');
        const summaryOriginalTotal = document.getElementById('summaryOriginalTotal');
        const summaryCurrentTotal  = document.getElementById('summaryCurrentTotal');
        const summaryDiffTotal     = document.getElementById('summaryDiffTotal');

        // 상태
        let allMembers = [];
        let currentStatusMembers = [];
        let currentWeekStart = toMonday(new Date());
        let selectedMember = null;
        let selectedWeekDaysMap = {};

        let slotMinutes = 60;
        let gridStepMinutes = 60;
        const GRID_DAY_LABELS = ['월','화','수','목','금','토','일'];

        // 모달/일편집 상태
        const START_MIN = HOUR_START * 60;
        const END_MIN   = HOUR_END   * 60;
        let stepMinutes  = 30;
        let totalRows    = (END_MIN - START_MIN) / stepMinutes;
        let originalSegments = [];
        let originalSlotSet  = new Set();
        let slotState        = new Set();
        let modalMode        = 'edit';

        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); } catch(e){ allMembers = []; }

        (function safeInitStatus(){
            if (!statusSelect) return;
            const initial = statusSelect.value || 'WORKING';
            const hasInInitial = (allMembers||[]).some(m => m.status === initial);
            if (!hasInInitial) {
                const counts = (allMembers||[]).reduce((acc,m)=>{ acc[m.status]=(acc[m.status]||0)+1; return acc; },{});
                const best = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0];
                if (best && Array.from(statusSelect.options).some(o=>o.value===best)) {
                    statusSelect.value = best;
                }
            }
        })();

        attachHandlers();

        (async () => {
            await handleStatusChange(true);
            updateSaveButtonState();
            updateCurrentTimeHighlight();
            setInterval(updateCurrentTimeHighlight, 15000);
        })();

        function attachHandlers(){
            statusSelect.addEventListener('change', async ()=> { await handleStatusChange(); });

            if (btnSlot10) btnSlot10.addEventListener('click', async ()=> { setSlotMinutes(10); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });
            if (btnSlot30) btnSlot30.addEventListener('click', async ()=> { setSlotMinutes(30); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });
            if (btnSlot60) btnSlot60.addEventListener('click', async ()=> { setSlotMinutes(60); await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart); });

            if (btnPrevWeek) btnPrevWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = addDays(currentWeekStart, -7); await handleStatusChange(); });
            if (btnThisWeek) btnThisWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = toMonday(new Date()); await handleStatusChange(); });
            if (btnNextWeek) btnNextWeek.addEventListener('click', async (e)=>{ e.preventDefault(); currentWeekStart = addDays(currentWeekStart, +7); await handleStatusChange(); });

            if (weekStaffTable) {
                weekStaffTable.addEventListener('click', async (e) => {
                    const td = e.target.closest('td.staff-cell');
                    if (!td || !selectedMember) return;

                    const dayIdx = parseInt(td.dataset.dayIdx || '-1', 10);
                    if (dayIdx < 0 || dayIdx > 6) return;

                    const iso = toIso(addDays(currentWeekStart, dayIdx));
                    const hasSel = td.dataset.hasSelected === '1';

                    if (hasSel) {
                        showDayEditButton(dayIdx, iso);
                    } else {
                        showDayCreateButton(dayIdx, iso);
                    }
                });
            }

            if (gridSlotButtonsWrapper) {
                gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mins = parseInt(btn.dataset.gridSlot, 10);
                        if (!mins || gridStepMinutes === mins) {
                            gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            updateSaveButtonState();
                            return;
                        }
                        gridStepMinutes = mins;
                        gridSlotButtonsWrapper.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        buildMemberWeekGrid();
                        hydrateGridFromDayMap(selectedWeekDaysMap);
                        updateSaveButtonState();
                    });
                });
            }

            if (btnGridClearAll) {
                btnGridClearAll.addEventListener('click', () => {
                    if (!memberWeekGridBody) return;
                    memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));
                });
            }

            if (memberWeekForm) {
                memberWeekForm.addEventListener('submit', onSubmitWeekForm);
            }

            if (btnToggleMemberWeek && memberWeekBody) {
                btnToggleMemberWeek.addEventListener('click', () => {
                    const collapsed = memberWeekBody.classList.toggle('d-none');
                    btnToggleMemberWeek.textContent = collapsed ? '펼치기' : '접기';
                });
            }

            btnSaveEdit.addEventListener('click', onSaveEdit);
            btnCancelEdit.addEventListener('click', onCancelEdit);
            btnCloseModal.addEventListener('click', closeEditModal);
            editModal.addEventListener('click', (e)=>{ if(e.target===editModal) closeEditModal(); });

            if (slotStepButtons) {
                slotStepButtons.querySelectorAll('button[data-step]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        const newStep = parseInt(btn.dataset.step,10);
                        if(!newStep || newStep === stepMinutes){
                            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                            btn.classList.add('active');
                            updateModalSaveButton();
                            return;
                        }
                        stepMinutes = newStep;
                        totalRows = (END_MIN - START_MIN) / stepMinutes;
                        slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');

                        summaryStepBadge.textContent = `슬롯: ${stepMinutes===60?'1시간':(stepMinutes+'분')}`;
                        originalSlotSet = segmentsToSlotSet(originalSegments, stepMinutes);
                        slotState = new Set([...originalSlotSet]);

                        buildDayGrid();
                        updateSelectedMinutes();
                        renderLeftSummary();
                        updateModalSaveButton();
                    });
                });
            }
            window.addEventListener('mouseup', ()=>{ modalDragging=false; });
        }

        function setSlotMinutes(mins){
            if (slotMinutes === mins) return;
            slotMinutes = mins;
            updateSlotButtons();
        }
        function updateSlotButtons(){
            [btnSlot10, btnSlot30, btnSlot60].forEach(btn=>{ if (!btn) return; btn.classList.remove('active'); });
            if (slotMinutes === 10 && btnSlot10) btnSlot10.classList.add('active');
            if (slotMinutes === 30 && btnSlot30) btnSlot30.classList.add('active');
            if (slotMinutes === 60 && btnSlot60) btnSlot60.classList.add('active');
        }

        async function handleStatusChange(){
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            if (selectedMember && !currentStatusMembers.some(x => String(x.id) === String(selectedMember.id))) {
                selectedMember = null;
            }

            renderMemberList(currentStatusMembers);
            renderWeekRangeLabel(currentWeekStart);

            if (currentStatusMembers.length === 0) {
                weekStaffTbody.innerHTML = '';
                noMemberState.classList.remove('d-none');
                timetableWrapper.classList.add('d-none');
                hideMemberWeekCard();
                clearAllDayEditButtons();
                return;
            }

            noMemberState.classList.add('d-none');
            timetableWrapper.classList.remove('d-none');

            if (!selectedMember) {
                selectedMember = currentStatusMembers[0];
            }
            updatePillActive();

            await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
            await loadSelectedMemberWeek();
            clearAllDayEditButtons();
            updateCurrentTimeHighlight();
        }

        function renderMemberList(members){
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;

            if (members.length === 0) {
                memberList.innerHTML = `<span class="text-muted small">해당 상태의 아르바이트생이 없습니다.</span>`;
                return;
            }

            members.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko')).forEach(m => {
                const color = colorForMember(m);
                const pill = document.createElement('div');
                pill.className = 'pill';
                pill.dataset.memberId = String(m.id);
                pill.innerHTML = `
                <span class="dot" style="background:${color}"></span>
                <span class="name">${escapeHtml(m.name ?? '-')}</span>
                <span class="meta">${escapeHtml(m.phone ?? '')}</span>
            `;
                pill.addEventListener('click', async () => {
                    selectedMember = m;
                    updatePillActive();
                    await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                    await loadSelectedMemberWeek();
                    clearAllDayEditButtons();
                    updateCurrentTimeHighlight();
                });
                memberList.appendChild(pill);
            });

            updatePillActive();
        }

        function updatePillActive(){
            const pills = memberList.querySelectorAll('.pill');
            pills.forEach(p => {
                if (!selectedMember) { p.classList.remove('active'); return; }
                const id = p.dataset.memberId;
                if (String(id) === String(selectedMember.id)) p.classList.add('active');
                else p.classList.remove('active');
            });
        }

        function renderWeekRangeLabel(weekStart){
            const weekEnd = addDays(weekStart, 6);

            const sY = weekStart.getFullYear();
            const sM = pad2(weekStart.getMonth()+1);
            const sD = pad2(weekStart.getDate());
            const eM = pad2(weekEnd.getMonth()+1);
            const eD = pad2(weekEnd.getDate());
            const label = `${sY}.${sM}.${sD} ~ ${eM}.${eD}`;

            if (weekRangeLabel) weekRangeLabel.textContent = label;
            if (weekRangeLabelRight) weekRangeLabelRight.textContent = label;

            if (dayHeaderCells && dayHeaderCells.length === 7) {
                const weekDates = [];
                for (let i=0; i<7; i++) {
                    const d = addDays(weekStart, i);
                    weekDates.push(toIso(d));

                    const mm = pad2(d.getMonth()+1);
                    const dd = pad2(d.getDate());
                    const cell = dayHeaderCells[i];
                    const dateSpan = cell.querySelector('.day-date');
                    if (dateSpan) dateSpan.textContent = `${mm}/${dd}`;
                    cell.classList.remove('today-col');

                    const rect = cell.querySelector('.day-head-rect');
                    if (rect) {
                        rect.classList.remove('current-time-day');
                        rect.classList.remove('today-head');
                    }
                }

                const today    = new Date();
                const todayIso = toIso(today);
                const todayIdx = weekDates.indexOf(todayIso);
                if (todayIdx !== -1) {
                    dayHeaderCells[todayIdx].classList.add('today-col');
                    const rect = dayHeaderCells[todayIdx].querySelector('.day-head-rect');
                    if (rect) rect.classList.add('today-head');
                }
            }
        }

        async function fetchAndRenderWeekTable(members, weekStart){
            const weekEnd = addDays(weekStart, 6);
            const startIso = toIso(weekStart);
            const endIso   = toIso(weekEnd);

            const weekDatesForToday = Array.from({length:7}, (_,i)=> toIso(addDays(weekStart, i)));
            const today    = new Date();
            const todayIso = toIso(today);
            const todayIdx = weekDatesForToday.indexOf(todayIso);

            const totalStartMin = HOUR_START * 60;
            const totalEndMin   = HOUR_END * 60;
            const slots = [];
            for (let t = totalStartMin; t < totalEndMin; t += slotMinutes) {
                slots.push({ start: t, end: t + slotMinutes });
            }

            const slotData = slots.map(() => Array.from({length:7}, ()=> new Set()));

            try {
                await Promise.all(
                        members.map(async (m) => {
                            const url = `${API_BASE}/${encodeURIComponent(m.id)}/${startIso}/${endIso}`;
                            const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                            if (!resp.ok) { console.warn('[weekTable] fetch fail:', m.id, resp.status); return; }
                            const data = await resp.json().catch(()=>null);
                            const dayMap = normalizeDays(data);

                            const weekDates = Array.from({length:7}, (_,i)=> toIso(addDays(weekStart, i)));
                            weekDates.forEach((iso, dayIdx) => {
                                const day = dayMap[iso];
                                if (!day || !Array.isArray(day.segments)) return;

                                day.segments.forEach(seg => {
                                    const segStartMin = hmToMin(seg.start);
                                    const segEndMin   = hmToMin(seg.end);
                                    slots.forEach((slot, slotIdx) => {
                                        const slotStart = slot.start, slotEnd = slot.end;
                                        if (segEndMin <= slotStart || segStartMin >= slotEnd) return;
                                        slotData[slotIdx][dayIdx].add(m.id);
                                    });
                                });
                            });
                        })
                );
            } catch(e){ console.error('[weekTable] unexpected error:', e); }

            const rows = [];
            const DOW_LABELS = ['월','화','수','목','금','토','일'];

            slots.forEach((slot, slotIdx)=>{
                const tr = document.createElement('tr');
                tr.dataset.rowIdx = String(slotIdx);

                if (slotMinutes === 60){
                    const hourFromStart = (slot.start/60) - HOUR_START;
                    if (hourFromStart % 3 === 0) tr.classList.add('hour-separator');
                } else {
                    if (slot.start % 60 === 0) tr.classList.add('hour-separator');
                }

                const h = Math.floor(slot.start / 60);
                const m = slot.start % 60;
                const th = document.createElement('th');
                th.scope = 'row';
                th.className = 'hour-row-header';
                th.textContent = `${pad2(h)}:${pad2(m)}`;
                tr.appendChild(th);

                let totalCount = 0;

                for (let dayIdx=0; dayIdx<7; dayIdx++){
                    const cell = document.createElement('td');
                    cell.className = 'staff-cell time-band-cell';
                    cell.dataset.dayIdx = String(dayIdx);

                    if (todayIdx !== -1 && dayIdx === todayIdx) cell.classList.add('today-col');

                    const inner = document.createElement('div');
                    inner.className = 'time-band-inner';

                    const memberIdSet = slotData[slotIdx][dayIdx];
                    const count = memberIdSet.size;
                    totalCount += count;

                    if (dayIdx === 0) {
                        cell.classList.add('time-band-left');
                    }

                    if (count === 0){
                        inner.innerHTML = `<span class="text-muted small">-</span>`;
                        cell.dataset.hasSelected = '0';
                    } else {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'staff-tags';

                        let hasSelected = false;
                        memberIdSet.forEach(memberId => {
                            const mObj = members.find(x => String(x.id) === String(memberId));
                            if (!mObj) return;
                            const color = colorForMember(mObj);
                            const tag = document.createElement('span');
                            tag.className = 'staff-tag';

                            if (selectedMember && String(mObj.id) === String(selectedMember.id)) {
                                tag.classList.add('selected-member-tag');
                                hasSelected = true;
                            }

                            tag.title = `${mObj.name || ''} (${DOW_LABELS[dayIdx]} ${pad2(h)}:${pad2(m)})`;
                            tag.innerHTML = `
                            <span class="staff-tag-dot" style="background:${color}"></span>
                            <span class="staff-tag-name">${escapeHtml(mObj.name ?? '-')}</span>
                        `;
                            tagsDiv.appendChild(tag);
                        });

                        cell.dataset.hasSelected = hasSelected ? '1' : '0';
                        inner.appendChild(tagsDiv);
                    }

                    cell.appendChild(inner);
                    tr.appendChild(cell);

                    // 인원 셀
                    const countTd = document.createElement('td');
                    countTd.className = 'day-count-cell time-band-cell';
                    if (todayIdx !== -1 && dayIdx === todayIdx) {
                        countTd.classList.add('today-col');
                    }
                    if (dayIdx === 6) {
                        countTd.classList.add('time-band-right');
                    }
                    const countInner = document.createElement('div');
                    countInner.className = 'time-band-inner';
                    countInner.textContent = count > 0 ? `${count}` : '';
                    countTd.appendChild(countInner);
                    tr.appendChild(countTd);
                }

                const tdTotal = document.createElement('td');
                tdTotal.className = 'staff-cell';
                tdTotal.style.padding = '.25rem .25rem';
                tdTotal.innerHTML = `<span class="staff-count">${totalCount}</span><span class="small text-muted">명</span>`;
                tr.appendChild(tdTotal);

                rows.push(tr);
            });

            weekStaffTbody.innerHTML = '';
            rows.forEach(r => weekStaffTbody.appendChild(r));

            updateCurrentTimeHighlight();
        }

        function updateCurrentTimeHighlight(){
            if (!weekStaffTbody) return;
            const now = new Date();

            const weekDates = Array.from({length:7}, (_,i)=> toIso(addDays(currentWeekStart, i)));
            const todayIso = toIso(now);
            const todayIdx = weekDates.indexOf(todayIso);

            weekStaffTbody.querySelectorAll('.current-time-row').forEach(tr => tr.classList.remove('current-time-row'));
            weekStaffTbody.querySelectorAll('.staff-tag-current').forEach(el => el.classList.remove('staff-tag-current'));
            document.querySelectorAll('.day-head-rect.current-time-day').forEach(el => el.classList.remove('current-time-day'));

            if (todayIdx === -1) return;

            const minutes = now.getHours()*60 + now.getMinutes();
            const startMin = HOUR_START*60;
            const endMin   = HOUR_END*60;
            if (minutes < startMin || minutes >= endMin) return;

            const idx = Math.floor((minutes - startMin) / slotMinutes);
            const row = weekStaffTbody.querySelector(`tr[data-row-idx="${idx}"]`);
            if (!row) return;

            row.classList.add('current-time-row');

            const todayCell = row.querySelector(`td.staff-cell[data-day-idx="${todayIdx}"]`);
            if (todayCell) {
                todayCell.querySelectorAll('.staff-tag').forEach(tag => {
                    tag.classList.add('staff-tag-current');
                });
            }

            const headTh = document.querySelector(`#weekStaffTable thead th[data-dow="${todayIdx}"]`);
            if (headTh) {
                const rect = headTh.querySelector('.day-head-rect');
                if (rect) rect.classList.add('current-time-day');
            }
        }

        function showDayEditButton(dayIdx, iso){
            clearAllDayEditButtons();
            const head = document.querySelector(`#weekStaffTable thead th[data-dow="${dayIdx}"] .day-edit-wrap`);
            if (!head) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-primary btn-sm day-edit-btn';
            btn.textContent = '근무일정 수정';
            btn.dataset.dateIso = iso;
            btn.addEventListener('click', async ()=>{
                if (!selectedMember) return;
                let segs = (selectedWeekDaysMap[iso]?.segments) || [];
                if (!segs.length) {
                    try{
                        const resp = await fetch(`${API_BASE}/${encodeURIComponent(selectedMember.id)}/${iso}/${iso}`, { headers:{'Accept':'application/json'} });
                        if (resp.ok){
                            const data = await resp.json().catch(()=>null);
                            const map = normalizeDays(data);
                            segs = (map[iso]?.segments)||[];
                        }
                    }catch(e){ console.warn('single-day fetch fail', e); }
                }
                openEditModal(iso, selectedMember, segs, 'edit');
            });
            head.appendChild(btn);
        }

        function showDayCreateButton(dayIdx, iso){
            clearAllDayEditButtons();
            const head = document.querySelector(`#weekStaffTable thead th[data-dow="${dayIdx}"] .day-edit-wrap`);
            if (!head) return;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-success btn-sm day-edit-btn';
            btn.textContent = '일정생성하기';
            btn.dataset.dateIso = iso;
            btn.addEventListener('click', async ()=>{
                if (!selectedMember) return;
                let segs = (selectedWeekDaysMap[iso]?.segments) || [];
                if (!segs.length) {
                    try{
                        const resp = await fetch(`${API_BASE}/${encodeURIComponent(selectedMember.id)}/${iso}/${iso}`, { headers:{'Accept':'application/json'} });
                        if (resp.ok){
                            const data = await resp.json().catch(()=>null);
                            const map = normalizeDays(data);
                            segs = (map[iso]?.segments)||[];
                        }
                    }catch(e){ console.warn('single-day fetch fail', e); }
                }
                openEditModal(iso, selectedMember, segs, 'create');
            });
            head.appendChild(btn);
        }

        function clearAllDayEditButtons(){
            document.querySelectorAll('.day-edit-wrap').forEach(w => w.innerHTML = '');
        }

        async function loadSelectedMemberWeek(){
            if (!selectedMember) {
                hideMemberWeekCard();
                return;
            }
            const weekStart = currentWeekStart;
            const weekEnd   = addDays(weekStart, 6);
            const startIso  = toIso(weekStart);

            memberWeekCard.classList.remove('d-none');
            memberWeekNameBadge.textContent = selectedMember.name || '-';
            memberWeekTitle.textContent = `개별 주간 일정 (${startIso} ~ ${toIso(weekEnd)})`;

            try {
                const url = `${API_BASE}/${encodeURIComponent(selectedMember.id)}/${startIso}/${toIso(weekEnd)}`;
                const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                if (!resp.ok) {
                    console.warn('[memberWeek] fetch fail:', selectedMember.id, resp.status);
                    selectedWeekDaysMap = {};
                } else {
                    const data = await resp.json().catch(()=>null);
                    selectedWeekDaysMap = normalizeDays(data) || {};
                }
            } catch (e) {
                console.error('[memberWeek] unexpected error:', e);
                selectedWeekDaysMap = {};
            }

            updateNoPlanAlert(selectedWeekDaysMap);
            buildMemberWeekGrid();
            hydrateGridFromDayMap(selectedWeekDaysMap);
            updateSaveButtonState();
        }

        function hideMemberWeekCard(){ memberWeekCard.classList.add('d-none'); }

        function buildMemberWeekGrid(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.innerHTML = '';

            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;

            for (let idx=0; idx<totalRows; idx++){
                const tMin = START_MIN + idx * gridStepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m % 30 === 0) ? hmLabel : '';
                tr.appendChild(th);

                for (let dayOffset=0; dayOffset<7; dayOffset++){
                    const td = document.createElement('td');
                    const div = document.createElement('div');
                    div.className = 'slot-10m';
                    div.dataset.dayOffset = String(dayOffset);
                    div.dataset.idx = String(idx);
                    td.appendChild(div);
                    tr.appendChild(td);
                }

                memberWeekGridBody.appendChild(tr);
            }

            attachMemberGridDragHandlers();
        }

        let gridDragging = false;
        let gridDragAdding = true;

        function attachMemberGridDragHandlers(){
            if (!memberWeekGridBody) return;
            memberWeekGridBody.querySelectorAll('.slot-10m').forEach(div => {
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    gridDragging = true;
                    gridDragAdding = !div.classList.contains('selected');
                    toggleGridSlot(div, gridDragAdding);
                });
                div.addEventListener('mouseenter', () => {
                    if (!gridDragging) return;
                    toggleGridSlot(div, gridDragAdding);
                });
            });
            window.addEventListener('mouseup', () => { if (gridDragging){ gridDragging = false; } });
        }
        function toggleGridSlot(el, on) { if (on) el.classList.add('selected'); else el.classList.remove('selected'); }

        function updateNoPlanAlert(dayMap){
            const hasAny = hasAnySegments(dayMap);
            if (noPlanAlert) noPlanAlert.classList.toggle('d-none', hasAny);
        }

        function hydrateGridFromDayMap(dayMap){
            if (!memberWeekGridBody) return;

            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;
            memberWeekGridBody.querySelectorAll('.slot-10m.selected').forEach(el => el.classList.remove('selected'));

            const weekStart = currentWeekStart;

            for (let offset=0; offset<7; offset++){
                const date = addDays(weekStart, offset);
                const iso  = toIso(date);
                const segments = (dayMap[iso]?.segments) || [];
                if (!segments.length) continue;

                segments.forEach(seg => {
                    const segStartMin = hmToMin(seg.start);
                    const segEndMin   = hmToMin(seg.end);
                    const a = Math.max(START_MIN, segStartMin);
                    const b = Math.min(END_MIN,   segEndMin);
                    if (a >= b) return;

                    const sIdx = Math.floor((a - START_MIN)/gridStepMinutes);
                    const eIdx = Math.ceil((b - START_MIN)/gridStepMinutes) - 1;

                    for (let idx = Math.max(0,sIdx); idx <= Math.min(totalRows-1, eIdx); idx++){
                        const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${offset}"][data-idx="${idx}"]`);
                        if (slot) slot.classList.add('selected');
                    }
                });
            }
        }

        function mergeConsecutive(arr){
            const out=[]; if(!arr.length) return out;
            arr.sort((a,b)=>a-b);
            let s=arr[0], p=arr[0];
            for(let i=1;i<arr.length;i++){
                if(arr[i]===p+1){ p=arr[i]; continue; }
                out.push([s,p]); s=p=arr[i];
            }
            out.push([s,p]);
            return out;
        }

        function collectSegmentsByDateFromGrid(){
            if (!memberWeekGridBody) return {};
            const res = {};
            const totalRows = (END_MIN - START_MIN) / gridStepMinutes;
            const weekStart = currentWeekStart;

            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const iso = toIso(addDays(weekStart, dayOffset));
                const indexes = [];
                for (let idx=0; idx<totalRows; idx++){
                    const slot = memberWeekGridBody.querySelector(`.slot-10m[data-day-offset="${dayOffset}"][data-idx="${idx}"]`);
                    if (slot && slot.classList.contains('selected')) indexes.push(idx);
                }
                const merged = mergeConsecutive(indexes);
                if (!merged.length) continue;

                res[iso] = merged.map(([sIdx,eIdxInclusive]) => {
                    const stMin = START_MIN + sIdx*gridStepMinutes;
                    const edMin = START_MIN + (eIdxInclusive+1)*gridStepMinutes;
                    return { start: minToHm(stMin), end: minToHm(edMin) };
                });
            }
            return res;
        }

        function updateSaveButtonState(){
            if (!btnSaveWeek) return;
            const enable = (gridStepMinutes === 10);
            btnSaveWeek.disabled = !enable;
            btnSaveWeek.title = enable ? '' : '저장은 10분 단위에서만 가능합니다.';
            document.getElementById('memberWeekSaveHint').classList.toggle('text-danger', !enable);
        }

        async function onSubmitWeekForm(e){
            e.preventDefault();
            if (!selectedMember) { alert('선택된 아르바이트생이 없습니다.'); return; }
            if (gridStepMinutes !== 10) { alert('저장은 10분 단위에서만 가능합니다. (그리드 단위를 10분으로 변경하세요)'); return; }

            const byDate = collectSegmentsByDateFromGrid();
            const weekStart = currentWeekStart;

            let summaryLines = [];
            for (let dayOffset=0; dayOffset<7; dayOffset++){
                const date = addDays(weekStart, dayOffset);
                const iso  = toIso(date);
                const label = `${GRID_DAY_LABELS[dayOffset]} (${iso})`;
                const segs  = byDate[iso] || [];
                summaryLines.push(!segs.length ? `${label}: 휴무` : `${label}: ${segs.map(s => `${s.start}~${s.end}`).join(', ')}`);
            }

            const ok = confirm(`다음과 같이 주간 근무시간을 저장합니다:\n\n${summaryLines.join('\n')}\n\n이대로 저장하시겠습니까?`);
            if (!ok) return;

            const dates = [];
            for (let offset=0; offset<7; offset++){ dates.push(toIso(addDays(weekStart, offset))); }

            try {
                for (const iso of dates){
                    const segments = byDate[iso] || [];
                    const payload = { memberId: selectedMember.id, date: iso, segments };
                    const resp = await fetch(API_UPDATE, {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) {
                        const txt = await resp.text().catch(()=> '');
                        alert(`저장 실패 (${iso}): ${resp.status} ${txt}`);
                        return;
                    }
                }

                alert('해당 주간 일정이 저장되었습니다.');
                await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                await loadSelectedMemberWeek();
                clearAllDayEditButtons();
                updateCurrentTimeHighlight();
            } catch (e) {
                console.error(e);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        let modalDragging = false, modalDragAdding = true;

        function openEditModal(dateIso, member, segments, mode='edit'){
            if(!member) return;
            modalMode = mode === 'create' ? 'create' : 'edit';
            editTitleDate.textContent = dateIso;
            editTitleMember.textContent = member.name ?? '-';

            btnSaveEdit.textContent = (modalMode === 'create') ? '일정생성하기' : '저장';

            stepMinutes = 30;
            totalRows = (END_MIN - START_MIN) / stepMinutes;
            slotStepButtons.querySelectorAll('button[data-step]').forEach(b=>b.classList.remove('active'));
            slotStepButtons.querySelector('button[data-step="30"]').classList.add('active');
            summaryStepBadge.textContent = '슬롯: 30분';

            originalSegments = Array.isArray(segments) ? segments.slice() : [];
            originalSlotSet  = segmentsToSlotSet(originalSegments, stepMinutes);
            slotState        = new Set([...originalSlotSet]);

            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
            updateModalSaveButton();

            editModal.dataset.memberId = String(member.id);
            editModal.dataset.dateIso = dateIso;

            editModal.style.display = 'block';
        }
        function closeEditModal(){ editModal.style.display = 'none'; }
        function onCancelEdit(){
            slotState = new Set([...originalSlotSet]);
            buildDayGrid();
            updateSelectedMinutes();
            renderLeftSummary();
        }
        async function onSaveEdit(){
            if(stepMinutes !== 10){
                alert('저장은 10분 단위에서만 가능합니다.');
                return;
            }
            const mid = editModal.dataset.memberId;
            const dateIso = editModal.dataset.dateIso;
            if(!mid || !dateIso) return;

            const segments = slotSetToSegments(slotState, stepMinutes);
            try{
                const body = { memberId: mid, date: dateIso, segments };
                const resp = await fetch(API_UPDATE, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', 'Accept':'application/json'},
                    body: JSON.stringify(body)
                });
                if(!resp.ok){
                    const text = await resp.text().catch(()=> '');
                    alert(`저장 실패: ${resp.status} ${text}`);
                    return;
                }
                closeEditModal();
                await fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
                await loadSelectedMemberWeek();
                clearAllDayEditButtons();
                updateCurrentTimeHighlight();
            }catch(e){
                console.error(e);
                alert('저장 중 오류가 발생했습니다.');
            }
        }
        function updateModalSaveButton(){ btnSaveEdit.disabled = (stepMinutes !== 10); }

        function buildDayGrid(){
            dayGridBody.innerHTML = '';
            const rows = (END_MIN - START_MIN) / stepMinutes;
            for(let idx=0; idx<rows; idx++){
                const tMin = START_MIN + idx*stepMinutes;
                const h = Math.floor(tMin/60);
                const m = tMin%60;
                const hmLabel = `${pad2(h)}:${pad2(m)}`;

                const tr = document.createElement('tr');
                if(m===0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m%30===0) ? hmLabel : '';
                tr.appendChild(th);

                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = 'slot-cell';
                div.dataset.hm = hmLabel;

                if(slotState.has(hmLabel)){
                    div.classList.add('selected');
                    if(!originalSlotSet.has(hmLabel)){
                        div.classList.add('selected-diff');
                    }
                }
                td.appendChild(div);
                tr.appendChild(td);
                dayGridBody.appendChild(tr);
            }
            attachDayGridDragHandlers();
        }

        function attachDayGridDragHandlers(){
            modalDragging = false;
            dayGridBody.querySelectorAll('.slot-cell').forEach(div=>{
                div.addEventListener('mousedown', (e)=>{
                    e.preventDefault();
                    modalDragging = true;
                    const hm = div.dataset.hm;
                    const has = slotState.has(hm);
                    modalDragAdding = !has;
                    toggleModalSlot(div, modalDragAdding);
                });
                div.addEventListener('mouseenter', ()=>{
                    if(!modalDragging) return;
                    toggleModalSlot(div, modalDragAdding);
                });
            });
            window.addEventListener('mouseup', ()=>{ if(modalDragging) modalDragging=false; });
        }

        function toggleModalSlot(el, on){
            const hm = el.dataset.hm;
            if(on){
                if(!slotState.has(hm)){
                    slotState.add(hm);
                    el.classList.add('selected');
                    if(!originalSlotSet.has(hm)) el.classList.add('selected-diff');
                }
            }else{
                if(slotState.has(hm)){
                    slotState.delete(hm);
                    el.classList.remove('selected','selected-diff');
                }
            }
            updateSelectedMinutes();
            renderLeftSummary();
        }
        function updateSelectedMinutes(){ selectedMinutesEl.textContent = (slotState.size * stepMinutes)|0; }

        function renderLeftSummary(){
            summaryOriginal.innerHTML = originalSegments.length
                    ? originalSegments.map(s => chipHtml('#198754', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const currentSegments = slotSetToSegments(slotState, stepMinutes);
            summaryCurrent.innerHTML = currentSegments.length
                    ? currentSegments.map(s => chipHtml('#0d6efd', s.start, s.end)).join(' ')
                    : '<span class="text-muted">-</span>';

            const orgMin = segmentsMinutes(originalSegments);
            const curMin = segmentsMinutes(currentSegments);
            summaryOriginalTotal.textContent = `${orgMin}분`;
            summaryCurrentTotal.textContent  = `${curMin}분`;
            const diff = curMin - orgMin;
            summaryDiffTotal.textContent = (diff>=0?'+':'') + `${diff}분`;
            summaryDiffTotal.classList.toggle('text-primary', diff>0);
            summaryDiffTotal.classList.toggle('text-danger', diff<0);
        }

        // ===== Utils =====
        function toMonday(date){
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            return d;
        }
        function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        function normalizeDays(apiData){
            const map = {};
            if (!apiData) return map;

            if (Array.isArray(apiData.days)) {
                apiData.days.forEach(d => {
                    const date = String(d.date);
                    const segments = Array.isArray(d.segments) ? d.segments : [];
                    const minutes = (typeof d.minutes === 'number') ? d.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[date] = { segments, minutes };
                });
                return map;
            }
            if (Array.isArray(apiData)) {
                apiData.forEach(d => {
                    const date = String(d.date);
                    const segments = Array.isArray(d.segments) ? d.segments : [];
                    const minutes = (typeof d.minutes === 'number') ? d.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[date] = { segments, minutes };
                });
                return map;
            }
            if (typeof apiData === 'object') {
                Object.keys(apiData).forEach(date => {
                    const v = apiData[date] || {};
                    const segments = Array.isArray(v.segments) ? v.segments : [];
                    const minutes = (typeof v.minutes === 'number') ? v.minutes
                            : segments.reduce((acc, s) => acc + (hmToMin(s.end)-hmToMin(s.start)), 0);
                    map[String(date)] = { segments, minutes };
                });
                return map;
            }
            return map;
        }

        function hasAnySegments(dayMap){
            return Object.values(dayMap || {}).some(v => Array.isArray(v.segments) && v.segments.length > 0);
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const [h,m] = String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60 + (m||0);
        }
        function minToHm(min){ const h = Math.floor(min/60); const m = min%60; return `${pad2(h)}:${pad2(m)}`; }

        function colorForMember(m){
            const key = (m?.id!=null ? String(m.id) : (m?.name || 'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        function segmentsToSlotSet(segments, step){
            const set = new Set();
            (segments||[]).forEach(seg=>{
                let s = Math.max(hmToMin(seg.start), START_MIN);
                let e = Math.min(hmToMin(seg.end),   END_MIN);
                for(let t=s; t<e; t+=step){ set.add(minToHm(t)); }
            });
            return set;
        }
        function slotSetToSegments(set, step){
            const sorted = Array.from(set).map(hmToMin).sort((a,b)=>a-b);
            const res = [];
            let i=0;
            while(i<sorted.length){
                let s = sorted[i], t = s + step; i++;
                while(i<sorted.length && sorted[i]===t){ t += step; i++; }
                res.push({start:minToHm(s), end:minToHm(t)});
            }
            return res;
        }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="dot" style="background:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function segmentsMinutes(segs){ return (segs||[]).reduce((acc,s)=> acc + (hmToMin(s.end)-hmToMin(s.start)), 0); }

    })();
</script>

{{>layouts/footer}}
