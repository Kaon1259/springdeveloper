{{>layouts/header}}

<main class="container my-4">
    <!-- ìƒë‹¨: ìƒíƒœ ì„ íƒ + í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="fw-bold">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</div>
            <div class="small text-muted">
                <span id="weekRangeLabel"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label small text-muted" for="statusSelect">ìƒíƒœ</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>
                    <div class="form-text">ìƒíƒœë¥¼ ë°”ê¾¸ë©´ ì•„ë˜ ë¦¬ìŠ¤íŠ¸ì™€ íƒ€ì„í…Œì´ë¸”ì´ í•¨ê»˜ ë°”ë€ë‹ˆë‹¤.</div>
                </div>
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">í•„í„°ëœ ì•„ë¥´ë°”ì´íŠ¸ìƒ</span>
                        <span id="memberCountBadge" class="badge bg-secondary">0ëª…</span>
                    </div>
                    <div id="memberList" class="vlist"></div>
                    <div class="small text-muted mt-2">
                        * ê° ì‚¬ëŒ ì˜†ì˜ ìƒ‰ìƒì€ í•´ë‹¹ ê·¼ë¡œìì˜ ê³ ìœ  ìƒ‰ì…ë‹ˆë‹¤. (ì•„ë˜ íƒ€ì„í…Œì´ë¸”ì—ë„ ë™ì¼ ìƒ‰ ì‚¬ìš©)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (10/30/60ë¶„ ë‹¨ìœ„ + ì§€ë‚œ/ê¸ˆ/ë‹¤ìŒì£¼) -->
    <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
                <span>ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</span>
                <div class="mt-1 btn-group btn-group-sm" role="group" aria-label="ë‹¨ìœ„ ì„ íƒ">
                    <button type="button" id="btnSlot10" class="btn btn-sm btn-outline-secondary">10ë¶„</button>
                    <button type="button" id="btnSlot30" class="btn btn-sm btn-outline-secondary">30ë¶„</button>
                    <button type="button" id="btnSlot60" class="btn btn-sm btn-outline-secondary active">1ì‹œê°„</button>
                </div>
                <span class="small text-muted mt-1">í•œ ì¹¸ = ì„ íƒëœ ë‹¨ìœ„, ë§ˆì§€ë§‰ ì—´ì€ ì „ì²´ ì¸ì›ìˆ˜</span>
            </div>

            <!-- ğŸ”¹ ìš°ì¸¡: ì§€ë‚œì£¼ / [ë‚ ì§œë²”ìœ„] / ê¸ˆì£¼ / ë‹¤ìŒì£¼ -->
            <div class="d-flex align-items-center gap-2">
                <button id="btnPrevWeek" class="btn btn-sm btn-outline-secondary">â—€ ì§€ë‚œì£¼</button>
                <span id="weekRangeLabelRight" class="small text-muted px-1"></span>
                <button id="btnThisWeek" class="btn btn-sm btn-outline-secondary">ê¸ˆì£¼</button>
                <button id="btnNextWeek" class="btn btn-sm btn-outline-secondary">ë‹¤ìŒì£¼ â–¶</button>
            </div>
        </div>
        <div class="card-body">
            <div id="noMemberState" class="text-muted small d-none">
                í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <div id="timetableWrapper" class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weekStaffTable">
                    <thead class="table-light">
                    <tr>
                        <th style="width:80px;">ì‹œê°„</th>
                        <th>ì›”</th>
                        <th>í™”</th>
                        <th>ìˆ˜</th>
                        <th>ëª©</th>
                        <th>ê¸ˆ</th>
                        <th>í† </th>
                        <th>ì¼</th>
                        <th style="width:80px;">í•©ê³„</th>
                    </tr>
                    </thead>
                    <tbody id="weekStaffTbody">
                    <!-- JS ë Œë” -->
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">
                * ê° ì¹¸ì—ëŠ” í•´ë‹¹ ì‹œê°„ëŒ€ì— ê·¼ë¬´ ì¤‘ì¸ ì¸ì› ìˆ˜ì™€, ê° ê·¼ë¡œìì˜ ìƒ‰ìƒ íƒœê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ë‹¨ìœ„ ë²„íŠ¼(10ë¶„/30ë¶„/1ì‹œê°„)ì— ë”°ë¼ íƒ€ì„í…Œì´ë¸” í–‰ì´ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</main>

<style>
    /* ===== ìƒë‹¨ ë¦¬ìŠ¤íŠ¸ ===== */
    .vlist {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name { font-weight:600; }
    .pill .meta { color:#6c757d; font-size:.8rem; }
    .pill.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }

    /* ===== íƒ€ì„í…Œì´ë¸” ===== */
    .hour-row-header {
        font-variant-numeric: tabular-nums;
    }
    .staff-cell {
        vertical-align: middle;
        font-size:.85rem;
    }
    .staff-tags {
        display:flex;
        flex-wrap:wrap;
        gap:4px;
        justify-content:center;
    }
    .staff-tag {
        display:inline-flex;
        align-items:center;
        gap:4px;
        border-radius:999px;
        padding:2px 6px;
        font-size:.75rem;
        background:#f8f9fa;
        border:1px solid #dee2e6;
        max-width:90px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
    }
    .staff-tag-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 10px;
    }
    .staff-count {
        font-weight:600;
        font-size:.9rem;
    }
    tr.hour-separator > td,
    tr.hour-separator > th {
        border-top:2px solid #dee2e6 !important;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const API_BASE = '/api/schedule/work'; // /{memberId}/{start}/{end}
        const HOUR_START = 6;   // ì‹œì‘ ì‹œê°„ (06ì‹œ)
        const HOUR_END   = 22;  // ë ì‹œê°„ (22ì‹œ, 22:00~23:00 ì „ê¹Œì§€ í¬í•¨ X)

        // DOM
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');
        const weekRangeLabel      = document.getElementById('weekRangeLabel');        // ìƒë‹¨ ì¹´ë“œ
        const weekRangeLabelRight = document.getElementById('weekRangeLabelRight');   // ì§€ë‚œì£¼/ê¸ˆì£¼ ì‚¬ì´

        const noMemberState   = document.getElementById('noMemberState');
        const timetableWrapper = document.getElementById('timetableWrapper');
        const weekStaffTbody  = document.getElementById('weekStaffTbody');

        // ë‹¨ìœ„ ì„ íƒ ë²„íŠ¼
        const btnSlot10       = document.getElementById('btnSlot10');
        const btnSlot30       = document.getElementById('btnSlot30');
        const btnSlot60       = document.getElementById('btnSlot60');

        // ì£¼ê°„ ì´ë™ ë²„íŠ¼
        const btnPrevWeek     = document.getElementById('btnPrevWeek');
        const btnThisWeek     = document.getElementById('btnThisWeek');
        const btnNextWeek     = document.getElementById('btnNextWeek');

        // ìƒíƒœ
        let allMembers = [];
        let currentStatusMembers = [];
        let currentWeekStart = toMonday(new Date()); // ê¸°ë³¸: ì˜¤ëŠ˜ì´ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼

        // ìŠ¬ë¡¯ ë‹¨ìœ„ (ë¶„)
        let slotMinutes = 60; // ê¸°ë³¸ 1ì‹œê°„

        // ë©¤ë²„ ë°ì´í„° íŒŒì‹±
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e){ allMembers = []; }

        if(Array.isArray(allMembers) && allMembers.length > 0){
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // ì´ˆê¸° ë Œë”
        attachHandlers();
        handleStatusChange();

        function attachHandlers(){
            statusSelect.addEventListener('change', handleStatusChange);

            // ë‹¨ìœ„ ë²„íŠ¼
            if(btnSlot10) btnSlot10.addEventListener('click', ()=> setSlotMinutes(10));
            if(btnSlot30) btnSlot30.addEventListener('click', ()=> setSlotMinutes(30));
            if(btnSlot60) btnSlot60.addEventListener('click', ()=> setSlotMinutes(60));

            // ì£¼ê°„ ì´ë™
            if(btnPrevWeek) btnPrevWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, -7);
                handleStatusChange();
            });
            if(btnThisWeek) btnThisWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = toMonday(new Date());
                handleStatusChange();
            });
            if(btnNextWeek) btnNextWeek.addEventListener('click', (e)=>{
                e.preventDefault();
                currentWeekStart = addDays(currentWeekStart, +7);
                handleStatusChange();
            });

            // ì´ˆê¸° ë‹¨ìœ„ active ì„¸íŒ…
            updateSlotButtons();
        }

        // ===== ë‹¨ìœ„ ë³€ê²½ =====
        function setSlotMinutes(mins){
            if(slotMinutes === mins) return;
            slotMinutes = mins;
            updateSlotButtons();

            if(currentStatusMembers.length > 0){
                fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
            }
        }

        function updateSlotButtons(){
            [btnSlot10, btnSlot30, btnSlot60].forEach(btn=>{
                if(!btn) return;
                btn.classList.remove('active');
            });
            if(slotMinutes === 10 && btnSlot10) btnSlot10.classList.add('active');
            if(slotMinutes === 30 && btnSlot30) btnSlot30.classList.add('active');
            if(slotMinutes === 60 && btnSlot60) btnSlot60.classList.add('active');
        }

        // ===== ìƒíƒœ ë³€ê²½ ì‹œ ë©¤ë²„ í•„í„° + íƒ€ì„í…Œì´ë¸” ì¬ê³„ì‚° =====
        function handleStatusChange(){
            const status = statusSelect.value;
            currentStatusMembers = (allMembers || []).filter(m => m.status === status);

            renderMemberList(currentStatusMembers);
            renderWeekRangeLabel(currentWeekStart);

            if(currentStatusMembers.length === 0){
                weekStaffTbody.innerHTML = '';
                noMemberState.classList.remove('d-none');
                timetableWrapper.classList.add('d-none');
                return;
            }

            noMemberState.classList.add('d-none');
            timetableWrapper.classList.remove('d-none');

            fetchAndRenderWeekTable(currentStatusMembers, currentWeekStart);
        }

        // ===== ìƒë‹¨ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë Œë” =====
        function renderMemberList(members){
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if(members.length === 0){
                memberList.innerHTML = `<span class="text-muted small">í•´ë‹¹ ìƒíƒœì˜ ì•„ë¥´ë°”ì´íŠ¸ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>`;
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const color = colorForMember(m);
                        const pill = document.createElement('div');
                        pill.className = 'pill';
                        pill.dataset.memberId = String(m.id);
                        pill.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;
                        memberList.appendChild(pill);
                    });
        }

        // ğŸ”¹ í˜„ì¬ ì„ íƒëœ ì£¼(ì›”~ì¼) ë²”ìœ„ë¥¼ ìƒë‹¨ ë¼ë²¨ + ë²„íŠ¼ ê·¸ë£¹ ì‚¬ì´ ë¼ë²¨ ë‘˜ ë‹¤ì— í‘œì‹œ
        function renderWeekRangeLabel(weekStart){
            const weekEnd = addDays(weekStart, 6);

            const sY = weekStart.getFullYear();
            const sM = pad2(weekStart.getMonth()+1);
            const sD = pad2(weekStart.getDate());
            const eM = pad2(weekEnd.getMonth()+1);
            const eD = pad2(weekEnd.getDate());
            const label = `${sY}.${sM}.${sD} ~ ${eM}.${eD}`;

            if(weekRangeLabel){
                weekRangeLabel.textContent = label;
            }
            if(weekRangeLabelRight){
                weekRangeLabelRight.textContent = label;
            }
        }

        // ===== ì£¼ê°„ íƒ€ì„í…Œì´ë¸” ë Œë”ë§ (10/30/60ë¶„ ê³µí†µ) =====
        async function fetchAndRenderWeekTable(members, weekStart){
            const weekEnd = addDays(weekStart, 6);
            const startIso = toIso(weekStart);
            const endIso   = toIso(weekEnd);

            // ìŠ¬ë¡¯ ì •ì˜: [HOUR_START, HOUR_END) êµ¬ê°„ì„ slotMinutes ë‹¨ìœ„ë¡œ ìª¼ê°¬
            const totalStartMin = HOUR_START * 60;
            const totalEndMin   = HOUR_END * 60;
            const slots = [];
            for(let t = totalStartMin; t < totalEndMin; t += slotMinutes){
                slots.push({ start: t, end: t + slotMinutes });
            }

            // slotData[slotIndex][dayIndex] = Set(memberId)
            const slotData = slots.map(()=> Array.from({length:7}, ()=> new Set()));

            // ë©¤ë²„ë³„ë¡œ ì£¼ê°„ ì¼ì • ê°€ì ¸ì˜¤ê¸°
            try {
                await Promise.all(
                        members.map(async (m) => {
                            const url = `${API_BASE}/${encodeURIComponent(m.id)}/${startIso}/${endIso}`;
                            const resp = await fetch(url, { headers:{'Accept':'application/json'} });
                            if(!resp.ok) return;
                            const data = await resp.json();
                            const dayMap = normalizeDays(data); // {date: {segments, minutes}}
                            const weekDates = Array.from({length:7}, (_,i)=> toIso(addDays(weekStart, i)));

                            weekDates.forEach((iso, dayIdx) => {
                                const day = dayMap[iso];
                                if(!day || !Array.isArray(day.segments)) return;

                                day.segments.forEach(seg => {
                                    const segStartMin = hmToMin(seg.start);
                                    const segEndMin   = hmToMin(seg.end);

                                    slots.forEach((slot, slotIdx) => {
                                        const slotStart = slot.start;
                                        const slotEnd   = slot.end;
                                        // ìŠ¬ë¡¯ê³¼ segmentê°€ ê²¹ì¹˜ë©´ ê·¼ë¬´
                                        if(segEndMin <= slotStart || segStartMin >= slotEnd) return;
                                        slotData[slotIdx][dayIdx].add(m.id);
                                    });
                                });
                            });
                        })
                );
            } catch(e){
                console.error(e);
            }

            const rows = [];
            const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

            slots.forEach((slot, slotIdx)=>{
                const tr = document.createElement('tr');

                // êµ¬ë¶„ì„ : 1ì‹œê°„ ë‹¨ìœ„(60ë¶„)ì¼ ë•ŒëŠ” 3ì‹œê°„ë§ˆë‹¤, ê·¸ ì™¸ì—ëŠ” ë§¤ ì •ì‹œë§ˆë‹¤
                if(slotMinutes === 60){
                    const hourFromStart = (slot.start/60) - HOUR_START;
                    if(hourFromStart % 3 === 0) tr.classList.add('hour-separator');
                } else {
                    if(slot.start % 60 === 0) tr.classList.add('hour-separator');
                }

                // ì‹œê°„ ì—´
                const h = Math.floor(slot.start / 60);
                const m = slot.start % 60;
                const th = document.createElement('th');
                th.scope = 'row';
                th.className = 'hour-row-header';
                th.textContent = `${pad2(h)}:${pad2(m)}`;
                tr.appendChild(th);

                let totalCount = 0;

                // ì›”~ì¼ ì¹¸
                for(let dayIdx=0; dayIdx<7; dayIdx++){
                    const cell = document.createElement('td');
                    cell.className = 'staff-cell';

                    const memberIdSet = slotData[slotIdx][dayIdx];
                    const count = memberIdSet.size;
                    totalCount += count;

                    if(count === 0){
                        cell.innerHTML = `<span class="text-muted small">-</span>`;
                    } else {
                        const tagsDiv = document.createElement('div');
                        tagsDiv.className = 'staff-tags';

                        memberIdSet.forEach(memberId => {
                            const mObj = members.find(x => String(x.id) === String(memberId));
                            if(!mObj) return;
                            const color = colorForMember(mObj);
                            const tag = document.createElement('span');
                            tag.className = 'staff-tag';
                            tag.title = `${mObj.name || ''} (${DOW_LABELS[dayIdx]} ${pad2(h)}:${pad2(m)})`;
                            tag.innerHTML = `
                                <span class="staff-tag-dot" style="background:${color}"></span>
                                <span class="staff-tag-name">${escapeHtml(mObj.name ?? '-')}</span>
                            `;
                            tagsDiv.appendChild(tag);
                        });

                        cell.appendChild(tagsDiv);
                    }

                    tr.appendChild(cell);
                }

                // ë§ˆì§€ë§‰: í•©ê³„ ì—´
                const tdTotal = document.createElement('td');
                tdTotal.className = 'staff-cell';
                tdTotal.innerHTML = `<span class="staff-count">${totalCount}</span><span class="small text-muted">ëª…</span>`;
                tr.appendChild(tdTotal);

                rows.push(tr);
            });

            weekStaffTbody.innerHTML = '';
            rows.forEach(r => weekStaffTbody.appendChild(r));
        }

        // ===== Utils =====
        function toMonday(date){
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const day = d.getDay(); // 0=ì¼,1=ì›”,...
            const diff = (day === 0 ? -6 : 1 - day);
            d.setDate(d.getDate() + diff);
            return d;
        }
        function addDays(d, n){
            const x = new Date(d);
            x.setDate(x.getDate()+n);
            return x;
        }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

        // /api/schedule ì‘ë‹µ -> {date: {segments, minutes}} í˜•íƒœë¡œ ë³€í™˜
        function normalizeDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=> acc + (hmToMin(s.end) - hmToMin(s.start)), 0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function hmToMin(hm){
            if(!hm) return 0;
            const [h,m] = String(hm).split(':').map(n=>parseInt(n,10));
            return (h||0)*60 + (m||0);
        }

        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs((h/60)%2-1)), m=l-c/2;
            let r=0,g=0,b=0;
            if(0<=h&&h<60){ r=c; g=x; b=0; }
            else if(60<=h&&h<120){ r=x; g=c; b=0; }
            else if(120<=h&&h<180){ r=0; g=c; b=x; }
            else if(180<=h&&h<240){ r=0; g=x; b=c; }
            else if(240<=h&&h<300){ r=x; g=0; b=c; }
            else { r=c; g=0; b=x; }
            const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

    })();
</script>

{{>layouts/footer}}
