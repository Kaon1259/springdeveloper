{{>layouts/header}}

<main class="container my-4">

    <!-- ============ 상단: 상태 선택(왼쪽) + 알바생 이름 칩(오른쪽, 같은 라인) ============ -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">아르바이트 상태별 보기</span>
            <a href="/members/new" class="btn btn-sm btn-primary">추가등록</a>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <!-- 왼쪽: 상태 선택 -->
                <div class="col-12 col-md-4">
                    <label for="statusSelect" class="form-label small text-muted">상태</label>
                    <select id="statusSelect" class="form-select form-select-sm">
                        <option value="WORKING" selected>근무중</option>
                        <option value="WAITING">시작전</option>
                        <option value="RESTING">휴식중</option>
                        <option value="PAUSED">일시중지</option>
                        <option value="RESIGNED">퇴사</option>
                    </select>
                    <div class="form-text">
                        상태를 변경하면 오른쪽 알바생 목록과 아래 타임테이블이 함께 갱신됩니다.
                    </div>
                </div>

                <!-- 오른쪽: 같은 라인에서 이름 칩을 가로로 나열 -->
                <div class="col-12 col-md-8">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <span class="small text-muted me-1">알바생</span>

                        <!-- 이름 칩들이 가로로 나열되는 영역 -->
                        <div id="memberList"
                             class="d-flex flex-wrap gap-2 flex-grow-1 member-pill-container">
                            <!-- JS 렌더 -->
                        </div>

                        <!-- 맨 오른쪽 인원수 배지 -->
                        <span id="memberCountBadge" class="badge bg-light text-dark ms-auto">0명</span>
                    </div>
                    <div class="small text-muted mt-1">
                        · 이름을 클릭하면 아래 주간 타임테이블이 해당 알바생 기준으로 바뀝니다.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ 하단: 주간 타임테이블 (계획 / 실제) ============ -->
    <div class="card">
        <!-- sticky 헤더 유지 -->
        <div class="card-header fw-bold d-flex align-items-center justify-content-between week-header">
            <span class="d-flex align-items-center">
                <span id="weekHeaderTitle">주간(월~일) 타임테이블</span>
                <span id="weekHeaderStatus" class="badge bg-secondary ms-2 d-none">-</span>
            </span>
            <div class="small text-muted">
                <span id="weekRangeLabel">{{weekRangeLabel}}</span>
                <a class="ms-2 btn btn-sm btn-outline-secondary" href="{{weekPrevUrl}}">◀ 이전 주</a>
                <a class="ms-1 btn btn-sm btn-outline-secondary" href="{{weekNextUrl}}">다음 주 ▶</a>
            </div>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle" id="workTable">
                    <thead class="table-light">
                    <tr>
                        <th style="width:110px;">요일</th>
                        <th>계획 근무기간 (API /work)</th>
                        <th>실 근무시간 (실데이터)</th>
                        <th style="width:120px;" class="text-end">실 합계</th>
                    </tr>
                    </thead>
                    <tbody id="workTableBody">
                    <!-- JS가 7행 생성 -->
                    </tbody>
                    <tfoot>
                    <tr>
                        <th>합계(계획)</th>
                        <td class="text-end fw-semibold" id="weekPlannedTotalCell">0시간</td>
                        <td class="text-muted">계획 미 반영</td>
                        <th></th>
                    </tr>
                    <tr class="highlight-row">
                        <th>합계(실제)</th>
                        <td></td>
                        <td class="text-end fw-semibold" colspan="2" id="weekActualTotalCell">0시간</td>
                    </tr>
                    <tr>
                        <th>시급</th>
                        <td></td>
                        <td class="text-end">기준 시급</td>
                        <th class="text-end" id="hourlyWageCell">-</th>
                    </tr>
                    <tr class="highlight-row">
                        <th>예상 급여</th>
                        <td></td>
                        <td class="text-end">주간 실근무 × 시급</td>
                        <th class="text-end text-primary" id="weekPayCell">-</th>
                    </tr>
                    <tr>
                        <th>실제-계획</th>
                        <td></td>
                        <td class="text-end">플러스면 초과근무</td>
                        <th class="text-end" id="weekDeltaCell">0분</th>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <div class="small text-muted">
                * 계획은 <code>/api/schedule/work/{memberId}/{start}/{end}</code> 기반이고, 실제는 일자별 실근무 데이터(API) 기반입니다.
            </div>
        </div>
    </div>

</main>

<style>
    .chip {
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid #e9ecef; border-radius:14px; padding:4px 8px; background:#fff;
    }
    .chip .dot { width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.08); }

    /* ===== 상단: 오른쪽 이름 칩 영역 ===== */
    .member-pill-container {
        min-height: 32px;
    }

    .member-pill {
        display:inline-flex;
        align-items:center;
        gap:4px;
        padding:2px 8px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        font-size:.8rem;
        cursor:pointer;
        white-space:nowrap;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .member-pill:hover {
        background:#f8f9fa;
    }

    .member-pill-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 10px;
    }

    .member-pill-name {
        font-weight:600;
    }

    .member-pill-meta {
        font-size:.7rem;
        color:#6c757d;
    }

    /* 선택된 멤버 하이라이트 */
    .member-pill.active {
        border-color: rgba(13,110,253,.6);
        box-shadow: 0 0 0 2px rgba(13,110,253,.15);
        background:#f0f6ff;
    }

    /* 주간 헤더 sticky (상단 네비 아래에 달라붙도록) */
    .week-header {
        position: sticky;
        top: var(--week-header-offset, 0);
        z-index: 25;
        background: #fff;
    }
</style>

<!-- 컨트롤러에서 내려준 JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    // JSON 파싱
    let allMembers = [];
    try {
        allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
    } catch(e) { allMembers = []; }
</script>

<script>
    (function() {
        // ===== DOM =====
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');

        const workTableBody       = document.getElementById('workTableBody');
        const weekPlannedTotalCell= document.getElementById('weekPlannedTotalCell');
        const weekActualTotalCell = document.getElementById('weekActualTotalCell');
        const weekDeltaCell       = document.getElementById('weekDeltaCell');
        const hourlyWageCell      = document.getElementById('hourlyWageCell');
        const weekPayCell         = document.getElementById('weekPayCell');

        const weekRangeLabelEl    = document.getElementById('weekRangeLabel');

        const weekHeaderTitle     = document.getElementById('weekHeaderTitle');
        const weekHeaderStatus    = document.getElementById('weekHeaderStatus');

        // 주 범위
        const { weekStartIso, weekEndIso } = parseWeekRange(weekRangeLabelEl?.textContent || '');

        const DOW = ['일','월','화','수','목','금','토'];

        const API_BASE_ACTUAL = '/api/schedule';       // 실제 근무 주간 API
        const API_BASE_PLAN   = '/api/schedule/work';  // 계획 근무 주간 API

        let selectedMemberId = null;

        // 헤더 sticky offset (상단 navbar 높이 고려)
        function computeWeekHeaderOffset() {
            const fixedHeader = document.querySelector('.navbar.fixed-top, .fixed-top, header.sticky-top');
            const navH = fixedHeader ? fixedHeader.getBoundingClientRect().height : 0;
            const top = navH;
            document.documentElement.style.setProperty('--week-header-offset', top + 'px');
        }
        computeWeekHeaderOffset();
        window.addEventListener('resize', computeWeekHeaderOffset);

        // 초기 상태
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // 이벤트
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        // 시작
        handleStatusChange();

        // ===== Handlers =====
        async function handleStatusChange() {
            const status   = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered.length) {
                // 이전 선택 유지, 없으면 첫 번째 선택
                const keep = filtered.find(m => String(m.id) === String(selectedMemberId)) || filtered[0];
                await pickMember(keep);
            } else {
                selectedMemberId = null;
                clearWorkTable();
            }
        }

        async function onMemberListClick(e) {
            const pill = e.target.closest('.member-pill');
            if (!pill) return;

            const id      = pill.getAttribute('data-member-id');
            const members = getCurrentFilteredMembers();
            const target  = members.find(m => String(m.id) === String(id));
            if (target) {
                await pickMember(target);
            }
        }

        function getCurrentFilteredMembers() {
            const status = statusSelect.value;
            return (allMembers || []).filter(m => m.status === status);
        }

        // ===== 알바생 이름 칩 렌더링 (상태 선택 오른쪽, 같은 라인) =====
        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;

            if (!members.length) {
                const span = document.createElement('span');
                span.className = 'text-muted small';
                span.textContent = '해당 상태의 알바생이 없습니다.';
                memberList.appendChild(span);
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const memberName  = escapeHtml(m.name ?? '-');
                        const memberPhone = escapeHtml(m.phone ?? '');
                        const memberCode  = escapeHtml(m.code ?? m.memberCode ?? '');
                        const color       = colorForMember(m);

                        const pill = document.createElement('span');
                        pill.className = 'member-pill';
                        pill.dataset.memberId = String(m.id);

                        pill.innerHTML = `
                        <span class="member-pill-dot" style="background:${color}"></span>
                        <span class="member-pill-name">${memberName}</span>
                        ${
                                memberPhone || memberCode
                                        ? `<span class="member-pill-meta">
                                     ${memberPhone ? memberPhone : ''}
                                     ${memberPhone && memberCode ? ' · ' : ''}
                                     ${memberCode ? memberCode : ''}
                                   </span>`
                                        : ''
                        }
                    `;

                        memberList.appendChild(pill);
                    });

            updateMemberListActive();
        }

        // 멤버 선택 공통 처리
        async function pickMember(m) {
            if (!m) return;
            selectedMemberId = m.id;

            updateMemberListActive();

            const baseTitle = '주간(월~일) 타임테이블';
            if (m?.name) {
                weekHeaderTitle.textContent = `${baseTitle} (${m.name})`;
            } else {
                weekHeaderTitle.textContent = baseTitle;
            }

            if (m?.status) {
                weekHeaderStatus.textContent = m.status;
                weekHeaderStatus.className = `badge ${statusClass(m.status)} ms-2`;
                weekHeaderStatus.classList.remove('d-none');
            } else {
                weekHeaderStatus.textContent = '-';
                weekHeaderStatus.className = 'badge bg-secondary ms-2 d-none';
            }

            await loadAndRenderWeek(m);
        }

        function updateMemberListActive() {
            Array.from(memberList.querySelectorAll('.member-pill')).forEach(pill => {
                pill.classList.toggle('active', pill.dataset.memberId === String(selectedMemberId));
            });
        }

        // ===== 하단: 계획 + 실제 =====
        async function loadAndRenderWeek(member) {
            let plannedMap = {};
            try {
                plannedMap = await fetchPlannedWeek(member.id);
            } catch (err) {
                console.error('planned fetch error:', err);
                plannedMap = {};
            }

            let actualMap = {};
            try {
                const url  = `${API_BASE_ACTUAL}/${encodeURIComponent(member.id)}/${weekStartIso}/${weekEndIso}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                actualMap = normalizeDays(data);
            } catch (err) {
                console.error('worklogs fetch error:', err);
                actualMap = {};
            }

            renderWeekTableRows(member, plannedMap, actualMap);
        }

        async function fetchPlannedWeek(memberId) {
            const url  = `${API_BASE_PLAN}/${encodeURIComponent(memberId)}/${weekStartIso}/${weekEndIso}`;
            const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!resp.ok) {
                const text = await resp.text().catch(()=> '');
                throw new Error(`planned API ${resp.status} ${text}`);
            }
            const data = await resp.json();
            return normalizeDays(data);
        }

        function normalizeDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date     = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes  = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }

        function renderWeekTableRows(member, plannedMap, actualMap) {
            const rows   = [];
            let wPlanned = 0, wActual = 0;
            const colorPlan   = '#0d6efd';
            const colorActual = colorForMember(member);

            const start = new Date(weekStartIso);
            for (let i=0;i<7;i++){
                const d   = new Date(start); d.setDate(start.getDate()+i);
                const iso = toIso(d);
                const dow = d.getDay();
                const dayLabel = DOW[dow];

                const p = plannedMap[iso] || {segments:[], minutes:0};
                const a = actualMap[iso]  || {segments:[], minutes:0};

                wPlanned += (p.minutes||0);
                wActual  += (a.minutes||0);

                const chipsPlanned = p.segments.length
                        ? p.segments.map(s=>chipHtml(colorPlan, s.start, s.end)).join(' ')
                        : '<span class="text-muted">—</span>';

                const chipsActual = a.segments.length
                        ? a.segments.map(s=>chipHtml(colorActual, s.start, s.end)).join(' ')
                        : '<span class="text-muted">—</span>';

                rows.push(`
        <tr>
          <th scope="row">${dayLabel}</th>
          <td>${chipsPlanned}</td>
          <td>${chipsActual}</td>
          <td class="text-end">${formatMins(a.minutes||0)}</td>
        </tr>
      `);
            }

            workTableBody.innerHTML = rows.join('');

            weekPlannedTotalCell.textContent = formatMins(wPlanned);
            weekActualTotalCell.textContent  = formatMins(wActual);
            weekDeltaCell.textContent        = deltaString(wActual - wPlanned);

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            hourlyWageCell.textContent =
                    (wage!=null)
                            ? new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(wage)
                            : '-';

            const pay = (wage!=null) ? Math.round((wActual/60)*wage) : null;
            weekPayCell.textContent =
                    (pay!=null)
                            ? new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(pay)
                            : '-';
        }

        function clearWorkTable() {
            workTableBody.innerHTML = '';
            weekPlannedTotalCell.textContent = '0시간';
            weekActualTotalCell.textContent  = '0시간';
            weekDeltaCell.textContent        = '0분';
            hourlyWageCell.textContent       = '-';
            weekPayCell.textContent          = '-';

            const baseTitle = '주간(월~일) 타임테이블';
            weekHeaderTitle.textContent      = baseTitle;
            weekHeaderStatus.textContent     = '-';
            weekHeaderStatus.className       = 'badge bg-secondary ms-2 d-none';

            selectedMemberId = null;
            Array.from(memberList.querySelectorAll('.member-pill')).forEach(pill=>{
                pill.classList.remove('active');
            });
        }

        // ===== 날짜/시간 유틸 =====
        function parseWeekRange(label) {
            // "YYYY.MM.DD ~ MM.DD"
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (!m) {
                const today  = new Date();
                const monday = toMonday(today);
                return { weekStartIso: toIso(monday), weekEndIso: toIso(addDays(monday,6)) };
            }
            const y=+m[1], mo=+m[2], d=+m[3];
            const start = new Date(y,mo-1,d);
            return { weekStartIso: toIso(start), weekEndIso: toIso(addDays(start,6)) };
        }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const w=d.getDay(); const off=(w+6)%7; d.setDate(d.getDate()-off); return d;
        }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function formatMins(mins){
            const v = Math.max(0, mins|0);
            const h=Math.floor(v/60), m=v%60;
            return m===0 ? `${h}시간` : `${h}시간 ${m}분`;
        }
        function deltaString(min){
            const sign = min>0?'+':min<0?'-':'';
            const v = Math.abs(min); const h=Math.floor(v/60), m=v%60;
            const body = m===0? `${h}시간` : `${h}시간 ${m}분`;
            return `${sign}${body}`;
        }

        // ✅ "HH:MM:SS" → "HH:MM" 으로 잘라서 표시하는 함수
        function displayHm(value){
            if(!value) return '';
            const parts = String(value).split(':');
            const h = parseInt(parts[0], 10) || 0;
            const m = parseInt(parts[1], 10) || 0;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        // ===== 유틸 =====
        // ✅ 여기에서도 displayHm 사용
        function chipHtml(color, start, end){
            return `<span class="chip">
                        <span class="dot" style="background:${color}"></span>
                        <span class="small">${displayHm(start)} ~ ${displayHm(end)}</span>
                    </span>`;
        }
        function statusClass(s){
            const map = {
                WORKING:'bg-success',
                WAITING:'bg-secondary',
                RESTING:'bg-info',
                PAUSED:'bg-warning',
                RESIGNED:'bg-danger'
            };
            return map[s] || 'bg-secondary';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer}}
