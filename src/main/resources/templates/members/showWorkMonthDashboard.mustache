{{>layouts/header_}}

<main class="container my-4">

    <!-- ============ ìƒë‹¨: ìƒíƒœ ì„ íƒ(ì™¼ìª½) + ì•Œë°”ìƒ ì´ë¦„ ì¹©(ì˜¤ë¥¸ìª½, ê°™ì€ ë¼ì¸) ============ -->
    <!-- ğŸ”µ íŒŒë€ ë¼ìš´ë“œ íŒ¨ë„ë¡œ ë³€ê²½ -->
    <div class="status-panel-blue mb-3">
        <div class="status-panel-header">
            <div class="status-panel-title">ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°</div>
            <a href="/members/new" class="btn btn-sm btn-light status-panel-add-btn">ì¶”ê°€ë“±ë¡</a>
        </div>

        <div class="status-panel-body">
            <div class="row g-3 align-items-center">
                <!-- ì™¼ìª½: ìƒíƒœ ì„ íƒ -->
                <div class="col-12 col-md-4">
                    <label for="statusSelect" class="form-label small text-muted">ìƒíƒœ</label>
                    <select id="statusSelect" class="form-select form-select-sm status-panel-select">
                        <option value="WORKING" selected>ê·¼ë¬´ì¤‘</option>
                        <option value="WAITING">ì‹œì‘ì „</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PAUSED">ì¼ì‹œì¤‘ì§€</option>
                        <option value="RESIGNED">í‡´ì‚¬</option>
                    </select>
                    <div class="form-text">
                        ìƒíƒœë¥¼ ë³€ê²½í•˜ë©´ ì˜¤ë¥¸ìª½ ì•Œë°”ìƒ ëª©ë¡ê³¼ í•˜ë‹¨ ìº˜ë¦°ë” í…Œì´ë¸”ì´ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ê°™ì€ ë¼ì¸ì—ì„œ ì´ë¦„ ì¹©ì„ ê°€ë¡œë¡œ ë‚˜ì—´ -->
                <div class="col-12 col-md-8">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <span class="small text-muted me-1">ì•Œë°”ìƒ</span>

                        <!-- ì´ë¦„ ì¹©ë“¤ì´ ê°€ë¡œë¡œ ë‚˜ì—´ë˜ëŠ” ì˜ì—­ -->
                        <div id="memberList"
                             class="d-flex flex-wrap gap-2 flex-grow-1 member-pill-container">
                            <!-- JS ë Œë” -->
                        </div>

                        <!-- ë§¨ ì˜¤ë¥¸ìª½ ì¸ì›ìˆ˜ ë°°ì§€ -->
                        <span id="memberCountBadge" class="badge bg-light text-dark ms-auto">0ëª…</span>
                    </div>
                    <div class="small text-muted mt-1">
                        Â· ì´ë¦„ì„ í´ë¦­í•˜ë©´ ì•„ë˜ ì›”ê°„ ìº˜ë¦°ë”ê°€ í•´ë‹¹ ì•Œë°”ìƒ ê¸°ì¤€ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ í•˜ë‹¨: ì›”ê°„ ìº˜ë¦°ë” (ì‹¤ ê·¼ë¬´) ============ -->
    <div class="card">
        <!-- sticky í—¤ë” -->
        <div class="card-header fw-bold d-flex align-items-center justify-content-between month-header">
            <span class="d-flex align-items-center">
                <span id="calendarTitle">ì›”ê°„ ìº˜ë¦°ë”</span>
                <span id="headerStatusBadge" class="badge bg-secondary ms-2 d-none">-</span>
            </span>
            <div class="small text-muted">
                <span id="monthRangeLabel">{{monthRangeLabel}}</span>
                <a class="ms-2 btn btn-sm btn-outline-secondary" href="{{monthPrevUrl}}">â—€ ì´ì „ ë‹¬</a>
                <a class="ms-1 btn btn-sm btn-outline-secondary" href="{{monthNextUrl}}">ë‹¤ìŒ ë‹¬ â–¶</a>
            </div>
        </div>

        <div class="card-body">
            <!-- ë‹¬ë ¥ -->
            <div class="calendar">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS ë Œë”: ìš”ì¼ í—¤ë”, ê³µë°±, ë‚ ì§œ ì…€, ì£¼ í•©ê³„ ë°” -->
                </div>
            </div>

            <!-- ì›” í•©ê³„/ê¸‰ì—¬ -->
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì›” í•©ê³„(ì‹¤ê·¼ë¬´)</div>
                    <div class="fw-semibold" id="monthActualTotalCell">0ì‹œê°„</div>
                </div>
                <!--
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì‹œê¸‰</div>
                    <div id="hourlyWageCell">-</div>
                </div>
                -->
                <!--
                <div class="d-flex justify-content-between">
                    <div class="small text-muted">ì›” ì˜ˆìƒ ê¸‰ì—¬</div>
                    <div class="text-primary fw-semibold" id="monthPayCell">-</div>
                </div>
                -->
            </div>

            <div class="small text-muted mt-2">
                * ë‚ ì§œ ì¹¸ì— ìŠ¤ì¼€ì¤„, ì‹¤ì œ ê·¼ë¬´ì‹œê°„, ì¼ë³„ ê·¼ë¬´ì‹œê°„ í•©ê³„ê°€ ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>
                * ê·¼ë¬´ì‹œê°„ì´ ìˆëŠ” ë‚ ì§œ ì…€ì„ í´ë¦­í•˜ë©´ ë‚ ì§œ ì˜†ì— â€˜ì¡°ì •â€™ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚˜ë©°, ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•´ë‹¹ ì¼ìì˜ ê·¼ë¬´ì‹œê°„ì„ ìƒì„¸ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ============ ì¼ì ê·¼ë¬´ì‹œê°„ ì¡°ì • íŒì—… ============ -->
    <div id="dayAdjustModal" class="day-modal-backdrop d-none">
        <div class="day-modal">
            <div class="day-modal-header">
                <div>
                    <div class="small text-muted">ì„ íƒ ì¼ì</div>
                    <div class="fw-semibold" id="dayModalDateLabel">-</div>
                </div>
                <button type="button" class="btn-close btn-sm" id="btnDayModalClose" aria-label="Close"></button>
            </div>
            <div class="day-modal-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="btn-group btn-group-sm" id="daySlotButtons" role="group" aria-label="ìŠ¬ë¡¯ ë‹¨ìœ„ ì„ íƒ">
                        <button type="button" class="btn btn-outline-secondary" data-slot="10">10ë¶„</button>
                        <button type="button" class="btn btn-outline-secondary active" data-slot="30">30ë¶„</button>
                        <button type="button" class="btn btn-outline-secondary" data-slot="60">1ì‹œê°„</button>
                    </div>
                    <div class="small text-muted">
                        ì‹œê°„ ìŠ¬ë¡¯ì„ ë“œë˜ê·¸í•´ì„œ ì‹¤ì œ ê·¼ë¬´ì‹œê°„ì„ ì„ íƒ/í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (06:00 ~ 22:00)
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-5">
                        <div class="small text-muted mb-1">ì‹¤ì œ ê³„íš ì¼ì •</div>
                        <div id="dayPlanBox" class="day-plan-box">
                            <!-- ê³„íš ì¼ì • ì¹© ë Œë” -->
                        </div>
                    </div>
                    <div class="col-12 col-md-7">
                        <div class="small text-muted mb-1">ì‹¤ì œ ê·¼ë¬´ì‹œê°„ (ë“œë˜ê·¸ë¡œ ì„ íƒ)</div>
                        <div class="day-grid-wrapper">
                            <table>
                                <tbody id="dayGridBody">
                                <!-- JS ë Œë” -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="day-modal-footer">
                <button type="button" class="btn btn-sm btn-secondary me-2" id="btnDayModalCancel">ë‹«ê¸°</button>
                <button type="button" class="btn btn-sm btn-primary" id="btnDayModalSave">ì €ì¥</button>
            </div>
        </div>
    </div>

</main>

<style>
    /* ==== ì•„ë¥´ë°”ì´íŠ¸ ìƒíƒœë³„ ë³´ê¸°: íŒŒë€ ë¼ìš´ë“œ íŒ¨ë„ ==== */
    .status-panel-blue {
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        border-radius: 18px;
        padding: 16px 18px 18px;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
        color: #e5eeff;
    }
    .status-panel-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom: 10px;
    }
    .status-panel-title {
        font-weight: 700;
        font-size: 1rem;
        color:#f9fbff;
    }
    .status-panel-body {
        margin-top: 4px;
    }
    .status-panel-add-btn {
        border-radius: 999px;
        padding-inline: 14px;
        font-weight: 600;
    }

    /* íŒ¨ë„ ì•ˆì˜ í…ìŠ¤íŠ¸/ë ˆì´ë¸” í†¤ ì¡°ì • */
    .status-panel-blue .form-label,
    .status-panel-blue .form-text,
    .status-panel-blue .small.text-muted {
        color: #dbeafe !important;
    }

    /* ì…€ë ‰íŠ¸/ì¸í’‹ì„ ì•½ê°„ íˆ¬ëª…í•œ ë„¤ì´ë¹„ í†¤ìœ¼ë¡œ */
    .status-panel-blue .status-panel-select {
        background: rgba(15,23,42,0.22);
        border-color: rgba(191,219,254,0.85);
        color:#e5eeff;
    }
    .status-panel-blue .status-panel-select:focus {
        background: rgba(15,23,42,0.30);
        border-color:#bfdbfe;
        box-shadow:0 0 0 0.15rem rgba(191,219,254,0.45);
        color:#f9fbff;
    }

    .status-panel-blue .badge.bg-light {
        background:#e5eeff !important;
        color:#0f172a !important;
    }

    /* íŒ¨ë„ ì•ˆ member-pill ìŠ¤íƒ€ì¼ íŠœë‹ */
    .status-panel-blue .member-pill-container {
        min-height: 32px;
    }
    .status-panel-blue .member-pill {
        display:inline-flex;
        align-items:center;
        gap:4px;
        padding:4px 10px;
        border-radius:999px;
        border:1px solid rgba(191,219,254,0.55);
        background: rgba(15,23,42,0.20);
        font-size:.8rem;
        cursor:pointer;
        white-space:nowrap;
        transition: background .15s, box-shadow .15s, border-color .15s, transform .08s;
        color:#e5eeff;
    }
    .status-panel-blue .member-pill-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(15,23,42,.6);
        flex:0 0 10px;
    }
    .status-panel-blue .member-pill-name {
        font-weight:600;
    }
    .status-panel-blue .member-pill-meta {
        font-size:.7rem;
        color:#cbd5f5;
    }
    .status-panel-blue .member-pill:hover {
        background: rgba(15,23,42,0.30);
        border-color: rgba(191,219,254,0.9);
        transform: translateY(-1px);
        box-shadow: 0 4px 14px rgba(15,23,42,0.35);
    }
    .status-panel-blue .member-pill.active {
        border-color: rgba(191,219,254,1);
        box-shadow: 0 0 0 2px rgba(191,219,254,.95) inset;
        background: rgba(15,23,42,0.42);
    }

    .chip {
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid #e9ecef; border-radius:14px; padding:4px 8px; background:#fff;
    }
    .chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
    }

    .dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 auto;
    }

    /* ===== ìƒë‹¨: ì˜¤ë¥¸ìª½ ì´ë¦„ ì¹© ì˜ì—­ (ê¸°ë³¸) ===== */
    .member-pill-container {
        min-height: 32px;
    }

    .member-pill {
        display:inline-flex;
        align-items:center;
        gap:4px;
        padding:2px 8px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        font-size:.8rem;
        cursor:pointer;
        white-space:nowrap;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .member-pill:hover {
        background:#f8f9fa;
    }

    .member-pill-dot {
        width:10px;
        height:10px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 10px;
    }

    .member-pill-name {
        font-weight:600;
    }

    .member-pill-meta {
        font-size:.7rem;
        color:#6c757d;
    }

    .member-pill.active {
        border-color: rgba(13,110,253,.6);
        box-shadow: 0 0 0 2px rgba(13,110,253,.15);
        background:#f0f6ff;
    }

    /* ì›”ê°„ ìº˜ë¦°ë” í—¤ë” sticky */
    .month-header {
        position: sticky;
        top: var(--calendar-header-offset, 0);
        z-index: 25;
        background: #fff;
    }

    /* ===== Calendar ===== */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* ì¼~í†  */
        gap: 8px;
    }
    .calendar-grid .dow {
        text-align: center;
        font-weight: 600;
        color: #6c757d;
        padding: 6px 0;
        border-bottom: 1px dashed #e9ecef;

        position: sticky;
        top: var(--calendar-dow-offset, 0);
        z-index: 20;
        background: #fff;
    }
    .calendar-grid .cell {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 8px;
        min-height: 120px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: default;
    }
    .cell .date-head {
        display: flex; align-items: center; justify-content: space-between;
        font-weight: 600; font-size: .95rem;
        gap: 4px;
    }
    .cell .date-head .left-date {
        display:flex;
        align-items:center;
        gap:4px;
    }
    .cell .date-head .dow-mini { color:#6c757d; font-weight: 500; font-size: .85rem; }

    /* ë‚ ì§œ ì…€ ë‚´ë¶€ 3ê°œ ë¼ìš´ë“œë ‰íŠ¸ */
    .cell-rect {
        border-radius: 8px;
        padding: 4px 6px;
        min-height: 32px;
        margin-top: 3px;
    }

    /* 1. ë§¨ ìœ„: ìŠ¤ì¼€ì¤„(ê³„íš) â€“ ì—°í•œ ì´ˆë¡ í†¤ */
    .cell-rect-top {
        border: 1px solid rgba(25,135,84,0.5);
        background: rgba(25,135,84,0.04);
    }

    /* 2. ë‘ ë²ˆì§¸: ì‹¤ì œ ê·¼ë¬´ì‹œê°„ â€“ ì¤‘ë¦½ í†¤ */
    .cell-rect-middle {
        border: 1px solid #e9ecef;
        background: #f8f9fa;
    }

    /* 3. ë§ˆì§€ë§‰: ê·¼ë¬´ì‹œê°„ í•©ê³„ â€“ ì‚´ì§ ê°•ì¡°ëœ ë°°ê²½ */
    .cell-rect-bottom {
        border: 1px solid #e9ecef;
        background: #fcfcfc;
    }

    .cell .segments {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: flex-start;
    }
    .cell .day-total {
        text-align: right;
        font-size: .875rem;
        color:#212529;
    }

    .cell.muted { background: #fcfcfc; color:#96a0aa; }
    .cell.today { outline: 2px solid #51cf66; outline-offset: 2px; }

    .week-summary {
        grid-column: 1 / -1;
        border: 1px dashed #e9ecef;
        border-radius: 8px;
        padding: 8px 10px;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .week-summary .label { font-weight: 600; color:#495057; }
    .week-summary .value { font-weight: 600; }

    .btn-day-adjust {
        padding: 0 6px;
        font-size: .7rem;
        line-height: 1.3;
    }

    /* ===== ì¼ì ê·¼ë¬´ì‹œê°„ ì¡°ì • ëª¨ë‹¬ ===== */
    .day-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }
    .day-modal-backdrop.d-none {
        display: none;
    }
    .day-modal {
        width: min(900px, 100% - 32px);
        max-height: 90vh;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(15,23,42,0.35);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .day-modal-header {
        padding: 10px 14px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        background: #f8fafc;
    }
    .day-modal-body {
        padding: 12px 14px;
        overflow: auto;
    }
    .day-modal-footer {
        padding: 10px 14px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        background: #f9fafb;
    }

    .day-plan-box {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px;
        min-height: 80px;
        background: #f9fafb;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: flex-start;
    }

    .day-grid-wrapper {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
    }
    .day-grid-wrapper table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
    }
    .day-grid-wrapper th {
        width: 60px;
        text-align: center;
        font-size: .8rem;
        color: #6b7280;
        padding: 2px 4px;
        background: #f9fafb;
    }
    .day-grid-wrapper td {
        padding: 0;
    }

    .day-slot {
        height: 22px;
        border-radius: 4px;
        border: 1px solid #eef2f6;
        background: #ffffff;
        cursor: pointer;
        transition: background .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .day-slot:hover {
        background: #f8fbff;
    }

    .day-slot.plan-slot {
        background: rgba(25,135,84,0.05);
        border-color: rgba(25,135,84,0.30);
    }

    .day-slot.selected {
        background: rgba(25,135,84,0.18);
        box-shadow: inset 0 0 0 1px rgba(25,135,84,0.25);
    }

    .day-slot.selected.selected-diff {
        background: rgba(13,110,253,0.16);
        box-shadow: inset 0 0 0 1px rgba(13,110,253,0.45);
        border-color: rgba(13,110,253,0.55);
    }

    .row-hour-start td,
    .row-hour-start th {
        border-top: 2px solid #e5e7eb !important;
    }
    .timecell {
        font-variant-numeric: tabular-nums;
    }
</style>

<!-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‚´ë ¤ì¤€ JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    // JSON íŒŒì‹±
    let allMembers = [];
    try {
        allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
    } catch(e) { allMembers = []; }
</script>

<script>
    (function() {
        const statusSelect        = document.getElementById('statusSelect');
        const memberList          = document.getElementById('memberList');
        const memberCountBadge    = document.getElementById('memberCountBadge');

        const calendarTitle       = document.getElementById('calendarTitle');
        const headerStatusBadge   = document.getElementById('headerStatusBadge');
        const monthRangeLabelEl   = document.getElementById('monthRangeLabel');
        const calendarGrid        = document.getElementById('calendarGrid');
        const monthActualTotalCell= document.getElementById('monthActualTotalCell');
        //const monthPayCell        = document.getElementById('monthPayCell');
        //const hourlyWageCell      = document.getElementById('hourlyWageCell');
        const monthHeaderEl       = document.querySelector('.month-header');

        const dayAdjustModal      = document.getElementById('dayAdjustModal');
        const dayModalDateLabel   = document.getElementById('dayModalDateLabel');
        const dayPlanBox          = document.getElementById('dayPlanBox');
        const dayGridBody         = document.getElementById('dayGridBody');
        const daySlotButtons      = document.getElementById('daySlotButtons');
        const btnDayModalClose    = document.getElementById('btnDayModalClose');
        const btnDayModalCancel   = document.getElementById('btnDayModalCancel');
        const btnDayModalSave     = document.getElementById('btnDayModalSave');

        const API_PLAN   = '/api/schedule/work';
        const API_BASE   = '/api/schedule';
        const API_UPDATE = '/api/schedule/update';
        const DOW_HEAD   = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

        const HOUR_START = 6;
        const HOUR_END   = 22;

        let selectedMemberId    = null;
        let selectedDateIso     = null;
        let dayGridStepMinutes  = 30;

        let currentDayGridDate    = null;
        let currentDayGridMember  = null;
        let currentDayPlanSegments= [];

        function computeCalendarOffsets() {
            const fixedHeader = document.querySelector('.navbar.fixed-top, .fixed-top, header.sticky-top');
            const navH = fixedHeader ? fixedHeader.getBoundingClientRect().height : 0;
            const headerOffset = navH;

            document.documentElement.style.setProperty('--calendar-header-offset', (headerOffset) + 'px');

            if (monthHeaderEl) {
                const headerHeight = monthHeaderEl.getBoundingClientRect().height;
                const dowOffset = headerOffset + headerHeight;
                document.documentElement.style.setProperty('--calendar-dow-offset', (dowOffset) + 'px');
            }
        }
        computeCalendarOffsets();
        window.addEventListener('resize', computeCalendarOffsets);

        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        if (btnDayModalClose)  btnDayModalClose.addEventListener('click', closeDayModal);
        if (btnDayModalCancel) btnDayModalCancel.addEventListener('click', closeDayModal);

        if (daySlotButtons) {
            daySlotButtons.querySelectorAll('button[data-slot]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mins = parseInt(btn.dataset.slot, 10);
                    if (!mins) return;
                    dayGridStepMinutes = mins;

                    daySlotButtons.querySelectorAll('button[data-slot]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    buildDayGrid();
                    hydrateDayGrid({ segments: currentDayPlanSegments });
                });
            });
        }

        if (btnDayModalSave) {
            btnDayModalSave.addEventListener('click', onSaveDayGrid);
        }

        if (dayAdjustModal) {
            dayAdjustModal.addEventListener('click', (e) => {
                if (e.target === dayAdjustModal) {
                    closeDayModal();
                }
            });
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !dayAdjustModal.classList.contains('d-none')) {
                closeDayModal();
            }
        });

        handleStatusChange();

        async function handleStatusChange() {
            const status   = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered.length) {
                const keep = filtered.find(m => String(m.id) === String(selectedMemberId)) || filtered[0];
                await pickMember(keep);
            } else {
                selectedMemberId = null;
                clearCalendar();
            }
        }

        async function onMemberListClick(e) {
            const pill = e.target.closest('.member-pill');
            if (!pill) return;

            const id      = pill.getAttribute('data-member-id');
            const members = getCurrentFilteredMembers();
            const target  = members.find(m => String(m.id) === String(id));
            if (target) {
                selectedDateIso = null;
                await pickMember(target);
            }
        }

        function getCurrentFilteredMembers() {
            const status = statusSelect.value;
            return (allMembers || []).filter(m => m.status === status);
        }

        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}ëª…`;

            if (!members.length) {
                const span = document.createElement('span');
                span.className = 'text-muted small';
                span.textContent = 'í•´ë‹¹ ìƒíƒœì˜ ì•Œë°”ìƒì´ ì—†ìŠµë‹ˆë‹¤.';
                memberList.appendChild(span);
                return;
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const memberName  = escapeHtml(m.name ?? '-');
                        const memberPhone = escapeHtml(m.phone ?? '');
                        const memberCode  = escapeHtml(m.code ?? m.memberCode ?? '');
                        const color       = colorForMember(m);

                        const pill = document.createElement('span');
                        pill.className = 'member-pill';
                        pill.dataset.memberId = String(m.id);

                        pill.innerHTML = `
                        <span class="member-pill-dot" style="background:${color}"></span>
                        <span class="member-pill-name">${memberName}</span>
                        ${
                                memberPhone || memberCode
                                        ? `<span class="member-pill-meta">
                                     ${memberPhone ? memberPhone : ''}
                                     ${memberPhone && memberCode ? ' Â· ' : ''}
                                     ${memberCode ? memberCode : ''}
                                   </span>`
                                        : ''
                        }
                    `;

                        memberList.appendChild(pill);
                    });

            updateMemberListActive();
        }

        async function pickMember(m) {
            if (!m) return;
            selectedMemberId = m.id;

            updateMemberListActive();

            if (m?.name) {
                calendarTitle.textContent = `ì›”ê°„ ìº˜ë¦°ë” (${m.name})`;
            } else {
                calendarTitle.textContent = 'ì›”ê°„ ìº˜ë¦°ë”';
            }

            if (m?.status) {
                headerStatusBadge.textContent = m.status;
                headerStatusBadge.className = `badge ${statusClass(m.status)} ms-2`;
                headerStatusBadge.classList.remove('d-none');
            } else {
                headerStatusBadge.textContent = '-';
            }

            computeCalendarOffsets();

            await loadAndRenderMonth(m);
        }

        function updateMemberListActive() {
            Array.from(memberList.querySelectorAll('.member-pill')).forEach(pill=>{
                pill.classList.toggle('active', pill.dataset.memberId === String(selectedMemberId));
            });
        }

        // ======================== ì›” ë°ì´í„° ë¡œë”©/ë Œë” =========================

        async function loadAndRenderMonth(member) {
            const { monthStartIso, monthEndIso } = parseMonthRange(monthRangeLabelEl?.textContent || '');

            let planMap = {};
            let actualMap = {};

            try {
                const planUrl = `${API_PLAN}/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const planResp = await fetch(planUrl, { headers: { 'Accept': 'application/json' } });
                if (planResp.ok) {
                    const planData = await planResp.json();
                    planMap = normalizeActualDays(planData);
                }
            } catch (err) {
                console.error('plan fetch error:', err);
            }

            try {
                const actUrl = `${API_BASE}/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const actResp = await fetch(actUrl, { headers: { 'Accept': 'application/json' } });
                if (actResp.ok) {
                    const actData = await actResp.json();
                    actualMap = normalizeActualDays(actData);
                }
            } catch (err) {
                console.error('actual fetch error:', err);
            }

            const mergedMap = mergePlanAndActual(planMap, actualMap);
            renderMonthCalendar(member, monthStartIso, monthEndIso, mergedMap);
        }

        function mergePlanAndActual(planMap, actualMap) {
            const merged = {};
            const allDates = new Set([...Object.keys(planMap), ...Object.keys(actualMap)]);
            allDates.forEach(date => {
                merged[date] = {
                    planSegments: planMap[date]?.segments || [],
                    actualSegments: actualMap[date]?.segments || [],
                    minutes: actualMap[date]?.minutes || 0
                };
            });
            return merged;
        }

        function renderMonthCalendar(member, startIso, endIso, dayMap) {
            calendarGrid.innerHTML = '';

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;

            // ìš”ì¼ í—¤ë”
            DOW_HEAD.forEach(label => {
                const h = document.createElement('div');
                h.className = 'dow';
                h.textContent = label;
                calendarGrid.appendChild(h);
            });

            const start = parseIsoDate(startIso);
            const end   = parseIsoDate(endIso);
            const todayIso = toIso(new Date());
            const firstDow = start.getDay();
            for (let i = 0; i < firstDow; i++) {
                const blank = document.createElement('div');
                blank.className = 'cell muted';
                calendarGrid.appendChild(blank);
            }

            let monthMinutes = 0;
            let weekMinutes = 0;
            let weekIndex = 0;

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const iso = toIso(d);
                const dow = d.getDay();
                const a = dayMap[iso] || { planSegments: [], actualSegments: [], minutes: 0 };

                monthMinutes += (a.minutes || 0);
                weekMinutes  += (a.minutes || 0);

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.date = iso;
                cell.dataset.hasWork = (a.minutes || 0) > 0 ? '1' : '0';
                if (iso === todayIso) cell.classList.add('today');

                const planChips   = a.planSegments.length
                        ? a.planSegments.map(s => chipHtml('#198754', s.start, s.end)).join(' ')
                        : '<span class="text-muted small">-</span>';

                const actualChips = a.actualSegments.length
                        ? a.actualSegments.map(s => chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted small">-</span>';

                const totalLabel = formatMins(a.minutes || 0);

                const showAdjust =
                        (selectedDateIso === iso) && (
                                (a.minutes || 0) > 0 || (a.planSegments?.length ?? 0) > 0
                        );
                const adjustBtnHtml = showAdjust
                        ? `<button type="button" class="btn btn-xs btn-outline-secondary btn-day-adjust" data-date="${iso}">ê·¼ë¬´ì‹œê°„ì¡°ì •</button>`
                        : '';

                cell.innerHTML = `
                    <div class="date-head">
                        <span class="left-date">
                            <span>${iso.split('-')[2]}ì¼</span>
                            <span class="dow-mini">${DOW_HEAD[dow]}</span>
                        </span>
                        ${adjustBtnHtml}
                    </div>

                    <div class="cell-rect cell-rect-top">
                        <div class="segments">${planChips}</div>
                    </div>

                    <div class="cell-rect cell-rect-middle">
                        <div class="segments">${actualChips}</div>
                    </div>

                    <div class="cell-rect cell-rect-bottom">
                        <div class="day-total">${totalLabel}</div>
                    </div>
                `;
                calendarGrid.appendChild(cell);

                const isWeekEnd = (dow === 6);
                const isLastDay = (iso === endIso);

                if (isWeekEnd || isLastDay) {
                    const wk = document.createElement('div');
                    wk.className = 'week-summary';
                    const weekPay = (wage != null) ? Math.round((weekMinutes / 60) * wage) : null;
                    wk.innerHTML = `
                        <span class="label">ì£¼ ${++weekIndex} í•©ê³„</span>
                        <span class="value">${formatMins(weekMinutes)} Â· ${weekPay != null ? krw(weekPay) : '-'}</span>
                    `;
                    calendarGrid.appendChild(wk);
                    weekMinutes = 0;
                }
            }

            monthActualTotalCell.textContent = formatMins(monthMinutes);
            attachCalendarCellHandlers(member, startIso, endIso, dayMap);
        }

        function attachCalendarCellHandlers(member, startIso, endIso, actualMap) {
            Array.from(calendarGrid.querySelectorAll('.cell[data-date]')).forEach(cell => {
                const iso = cell.dataset.date;
                const hasWork = cell.dataset.hasWork === '1';
                if (!hasWork) return;

                cell.style.cursor = 'pointer';

                cell.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-day-adjust')) return;
                    selectedDateIso = iso;
                    renderMonthCalendar(member, startIso, endIso, actualMap);
                });
            });

            Array.from(calendarGrid.querySelectorAll('.btn-day-adjust')).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const iso = btn.dataset.date;
                    const dayObj = actualMap[iso] || {segments:[], minutes:0};
                    openDayModal(member, iso, dayObj);
                });
            });
        }

        function clearCalendar(){
            calendarGrid.innerHTML = '';
            monthActualTotalCell.textContent = '0ì‹œê°„';

            calendarTitle.textContent = 'ì›”ê°„ ìº˜ë¦°ë”';
            headerStatusBadge.textContent = '-';
            headerStatusBadge.className = 'badge bg-secondary ms-2 d-none';

            Array.from(memberList.querySelectorAll('.member-pill')).forEach(pill=>{
                pill.classList.remove('active');
            });
        }

        function openDayModal(member, iso, dayObj) {
            currentDayGridDate    = iso;
            currentDayGridMember  = member;
            currentDayPlanSegments = Array.isArray(dayObj?.planSegments)
                    ? dayObj.planSegments
                    : [];

            const actualSegments = Array.isArray(dayObj?.actualSegments)
                    ? dayObj.actualSegments
                    : [];

            const d = parseIsoDate(iso);
            const dowLabel = DOW_HEAD[d.getDay()] || '';
            dayModalDateLabel.textContent = `${iso} (${dowLabel})`;

            if (currentDayPlanSegments.length > 0) {
                dayPlanBox.innerHTML = currentDayPlanSegments
                        .map(s => chipHtml('#198754', s.start, s.end))
                        .join(' ');
            } else {
                dayPlanBox.innerHTML = '<span class="text-muted small">ë“±ë¡ëœ ê³„íš ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
            }

            buildDayGrid();
            hydrateDayGrid({ segments: actualSegments });

            if (currentDayPlanSegments.length > 0) {
                overlayPlanOnGrid(currentDayPlanSegments);
            }

            dayAdjustModal.classList.remove('d-none');
        }

        function closeDayModal() {
            dayAdjustModal.classList.add('d-none');
        }

        function overlayPlanOnGrid(planSegments) {
            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END   * 60;
            const totalRows= (endMin - startMin) / dayGridStepMinutes;

            planSegments.forEach(seg => {
                const segStartMin = hmToMin(seg.start);
                const segEndMin   = hmToMin(seg.end);
                const a = Math.max(startMin, segStartMin);
                const b = Math.min(endMin, segEndMin);
                if (a >= b) return;

                const sIdx = Math.floor((a - startMin) / dayGridStepMinutes);
                const eIdx = Math.ceil ((b - startMin) / dayGridStepMinutes) - 1;

                for (let idx = Math.max(0, sIdx); idx <= Math.min(totalRows-1, eIdx); idx++) {
                    const slot = dayGridBody.querySelector(`.day-slot[data-idx="${idx}"]`);
                    if (!slot) continue;
                    slot.classList.add('plan-slot');
                }
            });
        }

        function buildDayGrid() {
            if (!dayGridBody) return;
            dayGridBody.innerHTML = '';

            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END   * 60;
            const totalRows = (endMin - startMin) / dayGridStepMinutes;

            for (let idx=0; idx<totalRows; idx++) {
                const tMin = startMin + idx * dayGridStepMinutes;
                const h = Math.floor(tMin / 60);
                const m = tMin % 60;
                const hmLabel = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                const tr = document.createElement('tr');
                if (m === 0) tr.classList.add('row-hour-start');

                const th = document.createElement('th');
                th.className = 'timecell';
                th.textContent = (m % 30 === 0) ? hmLabel : '';
                tr.appendChild(th);

                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = 'day-slot';
                div.dataset.idx = String(idx);
                div.dataset.plan = '0';
                td.appendChild(div);
                tr.appendChild(td);

                dayGridBody.appendChild(tr);
            }

            attachDayGridDragHandlers();
        }

        let dayGridDragging  = false;
        let dayGridDragAdding= true;

        function attachDayGridDragHandlers() {
            if (!dayGridBody) return;
            const slots = dayGridBody.querySelectorAll('.day-slot');

            slots.forEach(slot => {
                slot.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    dayGridDragging  = true;
                    dayGridDragAdding= !slot.classList.contains('selected');
                    toggleDaySlot(slot, dayGridDragAdding);
                });
                slot.addEventListener('mouseenter', () => {
                    if (!dayGridDragging) return;
                    toggleDaySlot(slot, dayGridDragAdding);
                });
            });

            window.addEventListener('mouseup', () => {
                if (dayGridDragging) dayGridDragging = false;
            });
        }

        function toggleDaySlot(el, on) {
            if (on) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }

            const isPlan = el.dataset.plan === '1';

            if (el.classList.contains('selected') && !isPlan) {
                el.classList.add('selected-diff');
            } else {
                el.classList.remove('selected-diff');
            }
        }

        function hydrateDayGrid(dayObj) {
            if (!dayGridBody) return;

            dayGridBody.querySelectorAll('.day-slot').forEach(el => {
                el.classList.remove('selected', 'selected-diff', 'plan-slot');
                el.dataset.plan = '0';
            });

            const segments = Array.isArray(dayObj?.segments) ? dayObj.segments : [];
            if (!segments.length) return;

            const startMin = HOUR_START * 60;
            const endMin   = HOUR_END   * 60;
            const totalRows= (endMin - startMin) / dayGridStepMinutes;

            segments.forEach(seg => {
                const segStartMin = hmToMin(seg.start);
                const segEndMin   = hmToMin(seg.end);

                const a = Math.max(startMin, segStartMin);
                const b = Math.min(endMin,   segEndMin);
                if (a >= b) return;

                const sIdx = Math.floor((a - startMin) / dayGridStepMinutes);
                const eIdx = Math.ceil ((b - startMin) / dayGridStepMinutes) - 1;

                for (let idx = Math.max(0, sIdx); idx <= Math.min(totalRows-1, eIdx); idx++) {
                    const slot = dayGridBody.querySelector(`.day-slot[data-idx="${idx}"]`);
                    if (!slot) continue;

                    slot.dataset.plan = '1';
                    slot.classList.add('plan-slot');

                    toggleDaySlot(slot, true);
                }
            });
        }

        function collectDaySegmentsFromGrid() {
            if (!dayGridBody) return [];
            const startMin = HOUR_START * 60;

            const indexes = [];
            dayGridBody.querySelectorAll('.day-slot.selected').forEach(slot => {
                const idx = parseInt(slot.dataset.idx, 10);
                if (!isNaN(idx)) indexes.push(idx);
            });

            const merged = mergeConsecutive(indexes);
            return merged.map(([sIdx, eIdx]) => {
                const stMin = startMin + sIdx * dayGridStepMinutes;
                const edMin = startMin + (eIdx + 1) * dayGridStepMinutes;
                return {
                    start: minToHm(stMin),
                    end:   minToHm(edMin)
                };
            });
        }

        async function onSaveDayGrid() {
            if (!currentDayGridMember || !currentDayGridDate) {
                alert('ì„ íƒëœ ì¼ì ë˜ëŠ” ì•„ë¥´ë°”ì´íŠ¸ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const segments = collectDaySegmentsFromGrid();

            const payload = {
                memberId: currentDayGridMember.id,
                date:     currentDayGridDate,
                segments: segments
            };

            try {
                const resp = await fetch(API_UPDATE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const txt = await resp.text().catch(()=> '');
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${resp.status} ${txt}`);
                    return;
                }

                alert('í•´ë‹¹ ì¼ìì˜ ê·¼ë¬´ì‹œê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeDayModal();

                const members = getCurrentFilteredMembers();
                const member  = members.find(m => String(m.id) === String(currentDayGridMember.id));

                if (member) {
                    selectedDateIso = currentDayGridDate;
                    await loadAndRenderMonth(member);
                }
            } catch (e) {
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' + e.toString());
            }
        }

        function parseMonthRange(label){
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (!m) {
                const today = new Date();
                const ms = new Date(today.getFullYear(), today.getMonth(), 1);
                const me = new Date(today.getFullYear(), today.getMonth()+1, 0);
                return { monthStartIso: toIso(ms), monthEndIso: toIso(me) };
            }
            const y=+m[1], mo=+m[2], d=+m[3];
            const start = new Date(y, mo-1, d);
            const end = new Date(start.getFullYear(), start.getMonth()+1, 0);
            return { monthStartIso: toIso(start), monthEndIso: toIso(end) };
        }
        function parseIsoDate(iso){ const [y,m,d]=iso.split('-').map(n=>parseInt(n,10)); return new Date(y,m-1,d); }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function formatMins(mins){
            const v = Math.max(0, mins|0);
            const h=Math.floor(v/60), m=v%60;
            return m===0?`${h}ì‹œê°„`:`${h}ì‹œê°„ ${m}ë¶„`;
        }
        function krw(v){
            if (v == null || isNaN(v)) return '-';
            return new Intl.NumberFormat('ko-KR',{
                style:'currency',
                currency:'KRW',
                maximumFractionDigits:0
            }).format(v);
        }

        function normalizeActualDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }
        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function hmToMin(hm){
            const {h,m} = parseHm(hm);
            return h*60 + m;
        }
        function minToHm(min){
            const h = Math.floor(min/60);
            const m = min%60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }
        function mergeConsecutive(arr){
            const out=[]; if(!arr || !arr.length) return out;
            arr.sort((a,b)=>a-b);
            let s=arr[0], p=arr[0];
            for(let i=1;i<arr.length;i++){
                if(arr[i]===p+1){ p=arr[i]; continue; }
                out.push([s,p]); s=p=arr[i];
            }
            out.push([s,p]);
            return out;
        }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="dot" style="background:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function statusClass(s){
            const map = {WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            return map[s] || 'bg-secondary';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}{${toHex(f(8))}${toHex(f(4))}`.replace('{','');
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer_}}
