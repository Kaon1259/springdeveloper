{{>layouts/header}}

<main class="container my-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h3 class="mb-0">ğŸ“… ê¸ˆì£¼ì˜ ê·¼ë¬´ íƒ€ì„í…Œì´ë¸”</h3>
        <div class="text-muted small" id="weekRange">-</div>
    </div>

    <!-- ë²”ë¡€(ì§ì› ìƒ‰ìƒ/í† ê¸€) -->
    <div class="card mb-3">
        <div class="card-header fw-bold d-flex align-items-center justify-content-between">
            <span>ê·¼ë¬´ì ìƒ‰ìƒ ë²”ë¡€</span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="showAllBtn">ëª¨ë‘ í‘œì‹œ</button>
                <button class="btn btn-sm btn-outline-secondary" id="clearFilterBtn">í•„í„° í•´ì œ</button>
            </div>
        </div>
        <div class="card-body">
            <div id="legend" class="d-flex flex-wrap gap-2"></div>
            <div class="form-text">ì´ë¦„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¸ì›ë§Œ í•˜ì´ë¼ì´íŠ¸(í† ê¸€) ë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <!-- íƒ€ì„í…Œì´ë¸” -->
    <div class="card">
        <div class="card-header fw-bold">ì£¼ê°„ íƒ€ì„í…Œì´ë¸” (ì›”~ì¼)</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center timetable mb-0" id="timetable">
                    <thead>
                    <tr>
                        <th style="width:90px;">ì‹œê°„</th>
                        <th>ì›”</th><th>í™”</th><th>ìˆ˜</th>
                        <th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
                    </tr>
                    </thead>
                    <tbody id="timetableBody">
                    <!-- JSê°€ 08:00~22:00 ì‹œê°„ ìŠ¬ë¡¯ì„ ì±„ì›ë‹ˆë‹¤. -->
                    </tbody>
                </table>
            </div>
            <div class="small text-muted mt-2">
                * ê°™ì€ ì‹œê°„ëŒ€ì— ì—¬ëŸ¬ ëª…ì´ ê·¼ë¬´í•˜ë©´, ì…€ ì•ˆì— ì—¬ëŸ¬ ê°œì˜ ì»¬ëŸ¬ ì¹©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</main>

<style>
    .timetable th, .timetable td { vertical-align: middle; }
    .chip {
        display:inline-flex; align-items:center; gap:.35rem;
        padding:.2rem .5rem; border-radius:999px; font-size:.8rem; line-height:1;
        background: #e9ecef; color:#333; border:1px solid rgba(0,0,0,.05);
        white-space:nowrap;
    }
    .chip .dot {
        width:10px; height:10px; border-radius:50%;
        border:1px solid rgba(0,0,0,.15);
    }
    .chip.muted { opacity:.25; filter:grayscale(60%); }
    .chip.highlight { box-shadow:0 0 0 2px rgba(0,0,0,.05) inset; }
    .cell-stack { display:flex; flex-wrap:wrap; gap:.25rem; justify-content:center; }
    .legend-item {
        cursor:pointer; user-select:none;
        display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem;
        border-radius:8px; border:1px solid #e9ecef; background:#fff;
    }
    .legend-item.active { outline:2px solid rgba(25,135,84,.25); }
    .legend-item .dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.15); }
    .legend-name { font-weight:600; }
    .legend-role { font-size:.8rem; color:#6c757d; }
    .sticky-note { position:sticky; top:10px; }
</style>

<!-- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë‚´ë ¤ì£¼ëŠ” ì£¼ê°„ ìŠ¤ì¼€ì¤„ JSON
  ê¸°ëŒ€ í¬ë§· (ì˜ˆì‹œ):
  [
    {
      "memberId": 1,
      "name": "ê¹€ë¯¼ìˆ˜",
      "phone": "010-1234-5678",      // ì„ íƒ
      "email": "minsu@example.com",  // ì„ íƒ
      "color": "#4caf50",            // ì„ íƒ(ì—†ìœ¼ë©´ ìë™ HSL)
      "shifts": [
        {"day":"MON","start":"10:00","end":"16:00"},
        {"day":"WED","start":"12:00","end":"20:00"},
        {"day":"FRI","start":"09:00","end":"15:00"}
      ]
    },
    {
      "memberId": 2,
      "name": "ì´ì§€ì€",
      "shifts": [
        {"day":"TUE","start":"11:00","end":"18:00"},
        {"day":"THU","start":"14:00","end":"22:00"},
        {"day":"SAT","start":"09:30","end":"13:30"}
      ]
    }
  ]
-->
<script id="schedulesData" type="application/json">
{{{schedulesJson}}}
</script>

<script>
    (function() {
        const DAYS = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
        const DAY_LABEL = {MON:'ì›”',TUE:'í™”',WED:'ìˆ˜',THU:'ëª©',FRI:'ê¸ˆ',SAT:'í† ',SUN:'ì¼'};
        const HOUR_START = 8, HOUR_END = 22; // [08:00 ~ 22:00)
        const timetableBody = document.getElementById('timetableBody');
        const legend = document.getElementById('legend');
        const weekRange = document.getElementById('weekRange');
        const showAllBtn = document.getElementById('showAllBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');

        // ===== ì£¼(ì›”~ì¼) ë¼ë²¨ =====
        setWeekRangeLabel();

        // ===== ë°ì´í„° íŒŒì‹± =====
        let schedules = [];
        try {
            schedules = JSON.parse(document.getElementById('schedulesData').textContent || '[]') || [];
        } catch (e) {
            schedules = [];
        }

        // ë©¤ë²„ ìƒ‰ìƒ ë³´ì • (ì—†ìœ¼ë©´ í•´ì‹œâ†’HSL)
        schedules.forEach(m => {
            if (!m.color) m.color = colorFromString(`${m.memberId ?? ''}${m.name ?? ''}`);
        });

        // ===== í…Œì´ë¸” ê·¸ë¦¬ë“œ ìƒì„± =====
        renderGrid();

        // ===== ì±„ìš°ê¸° =====
        fillCellsWithShifts(schedules);

        // ===== ë²”ë¡€ ìƒì„± =====
        let activeFilter = null; // memberId or null
        renderLegend(schedules, activeFilter);
        applyFilter(activeFilter);

        // ===== ì´ë²¤íŠ¸ =====
        showAllBtn.addEventListener('click', () => {
            activeFilter = null;
            renderLegend(schedules, activeFilter);
            applyFilter(activeFilter);
        });
        clearFilterBtn.addEventListener('click', () => {
            activeFilter = null;
            renderLegend(schedules, activeFilter);
            applyFilter(activeFilter);
        });

        // ===== Functions =====
        function renderGrid() {
            const rows = [];
            for (let h = HOUR_START; h < HOUR_END; h++) {
                const label = `${String(h).padStart(2,'0')}:00`;
                const tds = DAYS.map(d => `<td data-day="${d}" data-hour="${h}"><div class="cell-stack"></div></td>`).join('');
                rows.push(`
        <tr>
          <th scope="row">${label}</th>
          ${tds}
        </tr>
      `);
            }
            timetableBody.innerHTML = rows.join('');
        }

        function fillCellsWithShifts(members) {
            // ê° ë©¤ë²„ì˜ ê° shiftë¥¼ ì‹œê°„ ìŠ¬ë¡¯ìœ¼ë¡œ ë¶„í•´í•´ì„œ ì¹© ì¶”ê°€
            members.forEach(m => {
                (m.shifts || []).forEach(s => {
                    const {start, end, day} = s;
                    if (!DAYS.includes(day)) return;
                    // ì‹œê°„ ë‹¨ìœ„(1h) ë¸”ë¡ ê¸°ì¤€ìœ¼ë¡œ í¬í•¨ë˜ë©´ í‘œì‹œ (ê²½ê³„ í¬í•¨ ë¡œì§: [h, h+1)ì™€ [start,end) ê²¹ì¹¨)
                    const {h:sh, m:sm} = parseHm(start);
                    const {h:eh, m:em} = parseHm(end);
                    // ì‹œ:ë¶„ì„ ë¶„ ë‹¨ìœ„ë¡œ
                    const startMin = sh*60 + sm;
                    const endMin   = eh*60 + em;

                    for (let h = HOUR_START; h < HOUR_END; h++) {
                        const blockStart = h*60;
                        const blockEnd   = (h+1)*60;
                        if (rangesOverlap(startMin, endMin, blockStart, blockEnd)) {
                            const cell = timetableBody.querySelector(`td[data-day="${day}"][data-hour="${h}"] .cell-stack`);
                            if (cell) {
                                const chip = document.createElement('span');
                                chip.className = 'chip';
                                chip.setAttribute('data-member-id', String(m.memberId ?? ''));
                                chip.style.background = withAlpha(m.color, .18);
                                chip.style.borderColor = withAlpha(m.color, .35);
                                chip.innerHTML = `<span class="dot" style="background:${m.color}"></span>${escapeHtml(m.name || 'ì´ë¦„ì—†ìŒ')}`;
                                cell.appendChild(chip);
                            }
                        }
                    }
                });
            });
        }

        function renderLegend(members, filterId) {
            legend.innerHTML = '';
            members.forEach(m => {
                const item = document.createElement('div');
                item.className = 'legend-item' + (filterId && String(filterId) === String(m.memberId) ? ' active' : '');
                item.setAttribute('data-member-id', String(m.memberId ?? ''));
                item.innerHTML = `
        <span class="dot" style="background:${m.color}"></span>
        <span class="legend-name">${escapeHtml(m.name || 'ì´ë¦„ì—†ìŒ')}</span>
        ${m.phone ? `<span class="legend-role">Â· ${escapeHtml(m.phone)}</span>` : ''}
      `;
                item.addEventListener('click', () => {
                    activeFilter = (activeFilter && String(activeFilter) === String(m.memberId)) ? null : m.memberId;
                    renderLegend(members, activeFilter);
                    applyFilter(activeFilter);
                });
                legend.appendChild(item);
            });
        }

        function applyFilter(filterMemberId) {
            const chips = Array.from(document.querySelectorAll('.chip'));
            if (!filterMemberId) {
                chips.forEach(c => { c.classList.remove('muted','highlight'); });
                return;
            }
            chips.forEach(c => {
                const mid = c.getAttribute('data-member-id') || '';
                if (String(mid) === String(filterMemberId)) {
                    c.classList.remove('muted');
                    c.classList.add('highlight');
                } else {
                    c.classList.add('muted');
                    c.classList.remove('highlight');
                }
            });
        }

        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n => parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        function rangesOverlap(aStart, aEnd, bStart, bEnd) {
            // [aStart, aEnd)ì™€ [bStart, bEnd) ê²¹ì¹¨ ì—¬ë¶€
            return Math.max(aStart, bStart) < Math.min(aEnd, bEnd);
        }

        function colorFromString(str) {
            // ì•ˆì •ì  HSL: 0~359 hue
            const h = (hashCode(str) % 360 + 360) % 360;
            const s = 70;  // %
            const l = 50;  // %
            return `hsl(${h} ${s}% ${l}%)`;
        }
        function hashCode(s) {
            let h = 0;
            for (let i=0; i<s.length; i++) {
                h = ((h<<5)-h) + s.charCodeAt(i);
                h |= 0;
            }
            return h;
        }
        function withAlpha(hslOrHex, alpha) {
            // hsl(...) â†’ hsla; hex â†’ rgba ë¡œ ë‹¨ìˆœ ë³€í™˜ ì‹œë„
            if (hslOrHex.startsWith('hsl')) {
                return hslOrHex.replace('hsl', 'hsla').replace(')', ` / ${alpha})`);
            }
            // ë§¤ìš° ë‹¨ìˆœí•œ hex íŒŒì„œ
            const c = hexToRgb(hslOrHex);
            if (!c) return hslOrHex;
            return `rgba(${c.r},${c.g},${c.b},${alpha})`;
        }
        function hexToRgb(hex) {
            if (!hex) return null;
            const s = hex.replace('#','').trim();
            if (![3,6].includes(s.length)) return null;
            const n = s.length === 3 ? s.split('').map(ch=>ch+ch).join('') : s;
            const num = parseInt(n,16);
            if (Number.isNaN(num)) return null;
            return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
        }
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        function setWeekRangeLabel() {
            const now = new Date();
            const monday = startOfWeek(now); // ì›”ìš”ì¼
            const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
            weekRange.textContent = fmtYmd(monday) + ' ~ ' + fmtYmd(sunday) + ` (ì£¼ì°¨: ${getWeekNumber(now)}ì£¼ì°¨)`;
        }
        function startOfWeek(d) {
            const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const day = nd.getDay(); // 0=ì¼
            const diff = (day === 0 ? -6 : 1 - day); // ì›”ìš”ì¼ ì‹œì‘
            nd.setDate(nd.getDate()+diff);
            return nd;
        }
        function fmtYmd(d) {
            const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${dd}`;
        }
        function getWeekNumber(d) {
            // ISO week-number-ish (ê°„ë‹¨): ëª©ìš”ì¼ í¬í•¨ ì£¼ ê¸°ì¤€
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = (date.getUTCDay() + 6) % 7;
            date.setUTCDate(date.getUTCDate() - dayNum + 3);
            const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
            const weekNo = 1 + Math.round(((date - firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
            return weekNo;
        }
    })();
</script>

{{>layouts/footer}}
