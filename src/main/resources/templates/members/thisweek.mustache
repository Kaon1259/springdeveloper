{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ 왼쪽: 상태 선택 + 알바생 리스트(색 점) ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top: 12px;">

                <!-- 상태 선택 + 알바생 리스트업 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">아르바이트 상태별 보기</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">추가등록</a>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <!-- 상태 -->
                            <div class="col-12">
                                <label for="statusSelect" class="form-label small text-muted">상태</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>근무중</option>
                                    <option value="WAITING">시작전</option>
                                    <option value="RESTING">휴식중</option>
                                    <option value="PAUSED">일시중지</option>
                                    <option value="RESIGNED">퇴사</option>
                                </select>
                                <div class="form-text">상태를 변경하면 좌측 리스트와 우측 타임테이블이 함께 갱신됩니다.</div>
                            </div>
                        </div>

                        <hr>

                        <!-- 알바생 리스트 (색 점 + 이름 + 상세보기 버튼) -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">알바생 목록</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0명</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS로 상태별 전원 렌더링 -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- (선택) 알바생 정보 패널: 리스트에서 클릭 시 상세 표시 -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>아르바이트 정보</span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6">
                                <div class="text-muted">이름</div>
                                <div id="infoName" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">성별</div>
                                <div id="infoGender" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">전화번호</div>
                                <div id="infoPhone" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">이메일</div>
                                <div id="infoEmail" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">시작일</div>
                                <div id="infoStartDate" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">보건증</div>
                                <div id="infoHealth" class="fw-semibold">-</div>
                            </div>
                            <div class="col-12">
                                <div class="text-muted">시급(원)</div>
                                <div id="infoHourlyWage" class="fw-semibold">-</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ============ 오른쪽: 주간 타임테이블(다중 멤버 색 표시) ============ -->
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-header fw-bold">주간 타임테이블 (월~일)</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center timetable" id="timetable">
                            <thead>
                            <tr id="timetableHeadRow">
                                <th style="width:80px;">시간</th>
                                <th>월</th><th>화</th><th>수</th>
                                <th>목</th><th>금</th><th>토</th><th>일</th>
                            </tr>
                            </thead>
                            <tbody id="timetableBody">
                            <!-- JS가 06:00~22:00 시간 슬롯을 채웁니다. -->
                            </tbody>
                        </table>
                    </div>
                    <div class="small text-muted">
                        * 각 셀에 표시되는 작은 색 바는 해당 시간에 근무하는 알바생을 나타냅니다. (여러 명이면 여러 바가 중첩 표시)
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .timetable th, .timetable td { vertical-align: middle; }

    /* 헤더에 날짜(월/일) 표시 */
    .weekday-title { display:block; font-weight:600; }
    .date-label { display:block; font-size:.8rem; color:#6c757d; margin-top:2px; }

    /* 셀 내부에 다중 멤버 바(색) 표시를 위한 컨테이너 */
    .cell-stack {
        display: flex;
        flex-wrap: wrap;
        gap: 2px 4px;
        justify-content: center;
        align-items: center;
        min-height: 26px;
    }
    .member-bar {
        height: 8px;
        border-radius: 4px;
        display: inline-block;
        padding: 0;
        border: 1px solid rgba(0,0,0,.08);
    }
    .member-chip {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #eee;
        margin-bottom: 6px;
        cursor: pointer;
    }
    .member-chip:hover { background: #f8f9fa; }
    .member-chip .left {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .dot {
        width: 12px; height: 12px; border-radius: 50%;
        border: 1px solid rgba(0,0,0,.08);
    }

    /* 오늘 컬럼 하이라이트: 아주 연한 연두색 */
    .today-col { background: rgba(25,135,84,.12) !important; }
    .today-head { background: rgba(25,135,84,.16) !important; }
</style>

<!-- 컨트롤러에서 내려준 JSON: membersJson (없으면 빈 배열) -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    // JSON 파싱
    let allMembers = [];
    try {
        allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
    } catch(e) { allMembers = []; }
</script>

<script>
    (function() {
        // ===== Constants & DOM =====
        const HOUR_START = 6, HOUR_END = 22;
        const statusSelect = document.getElementById('statusSelect');
        const memberList = document.getElementById('memberList');
        const memberCountBadge = document.getElementById('memberCountBadge');
        const timetableBody = document.getElementById('timetableBody');
        const timetableHeadRow = document.getElementById('timetableHeadRow');

        // info panel
        const statusBadge  = document.getElementById('statusBadge');
        const infoName = document.getElementById('infoName');
        const infoGender = document.getElementById('infoGender');
        const infoPhone = document.getElementById('infoPhone');
        const infoEmail = document.getElementById('infoEmail');
        const infoStartDate = document.getElementById('infoStartDate');
        const infoHealth = document.getElementById('infoHealth');
        const infoHourlyWage = document.getElementById('infoHourlyWage');

        // 요일(월~일)
        const dayTitles = ['월','화','수','목','금','토','일'];

        // 최초 그리드/헤더 생성
        renderTimeGrid();
        renderWeekHeaderDatesAndHighlight(); // ← 요일 위 날짜 + 오늘 하이라이트

        // 초기 상태 값 보정
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // 이벤트
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick); // 목록 영역(상세보기 버튼) 위임

        // 초기 렌더
        handleStatusChange();

        // ====== Week header: (월/일) 라벨 + 오늘 컬럼 하이라이트 ======
        function renderWeekHeaderDatesAndHighlight(baseDate = new Date()) {
            // 월요일 시작 주의 월~일 날짜 계산
            const today = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
            const monOffset = (today.getDay() + 6) % 7; // 월=0 … 일=6
            const monday = new Date(today);
            monday.setDate(today.getDate() - monOffset);

            // 헤더 <th>들 가져오기 (첫 번째는 '시간')
            const ths = timetableHeadRow.querySelectorAll('th');
            // data-col 부여 및 텍스트 구성
            for (let i = 0; i < 7; i++) {
                const th = ths[i + 1]; // 0은 '시간'이므로 +1
                if (!th) continue;
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const label = `${d.getMonth() + 1}/${d.getDate()}`; // M/D

                th.setAttribute('data-col', String(i + 1));
                th.innerHTML = `<span class="weekday-title">${dayTitles[i]}</span><small class="date-label">(${label})</small>`;
                th.classList.remove('today-head');
            }

            // 오늘이 속한 컬럼 인덱스(1~7)
            const todayCol = ((today.getDay() + 6) % 7) + 1;

            // 헤더 오늘 컬럼 하이라이트
            const todayHead = timetableHeadRow.querySelector(`th[data-col="${todayCol}"]`);
            if (todayHead) todayHead.classList.add('today-head');

            // 바디 오늘 컬럼 하이라이트
            timetableBody.querySelectorAll(`td[data-col="${todayCol}"]`).forEach(td => td.classList.add('today-col'));
        }

        // ====== Rendering ======

        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            // 좌측: 리스트업
            renderMemberList(filtered);

            // 우측: 전원 동시에 색 렌더
            renderAllMembersSchedule(filtered);

            // info 패널 초기화
            if (filtered[0]) renderMemberInfo(filtered[0]);
            else clearInfo();
        }

        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;

            members
                    .slice()
                    .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
                    .forEach(m => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item member-chip';
                        li.dataset.memberId = String(m.id);

                        const color = colorForMember(m);
                        li.innerHTML = `
          <span class="left">
            <span class="dot" style="background:${color}"></span>
            <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
            <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
          </span>
          <button type="button"
                  class="btn btn-sm btn-outline-primary view-btn"
                  data-id="${String(m.id)}"
                  aria-label="상세보기">
            상세보기
          </button>
        `;

                        // 리스트 항목 클릭: 정보 패널/하이라이트
                        li.addEventListener('click', () => {
                            renderMemberInfo(m);
                            highlightMemberInGrid(m);
                        });

                        memberList.appendChild(li);
                    });

            // 리스트 없으면 안내
            if (!members.length) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = '해당 상태의 알바생이 없습니다.';
                memberList.appendChild(li);
            }
        }

        // 상세보기 버튼(우측) 클릭 핸들러: 이벤트 위임
        function onMemberListClick(e) {
            const btn = e.target.closest('.view-btn');
            if (!btn) return;
            e.stopPropagation(); // li 클릭 이벤트와 충돌 방지
            const id = btn.getAttribute('data-id');
            if (!id) return;
            window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
        }

        function renderAllMembersSchedule(members) {
            // 그리드 초기화 (오늘 컬럼 하이라이트 유지 위해 클래스 제거 전 재적용)
            clearGridCells();

            const mapToCol = { 'MON':1, 'TUE':2, 'WED':3, 'THU':4, 'FRI':5, 'SAT':6, 'SUN':7 };

            members.forEach(m => {
                const color = colorForMember(m);
                const schedules = getSchedules(m);
                schedules.forEach(s => {
                    const st = parseHm(s.start), ed = parseHm(s.end);
                    const dayIdx = mapToCol[s.day];
                    if (!dayIdx) return;

                    // 시간 단위 셀에 투영 ([h, h+1) 포함 여부)
                    for (let h = HOUR_START; h < HOUR_END; h++) {
                        if (intervalHitHour(st, ed, h)) {
                            const row = timetableBody.querySelector(`tr[data-hour="${h}"]`);
                            if (!row) continue;
                            const cell = row.querySelector(`td[data-col="${dayIdx}"]`);
                            if (!cell) continue;

                            // 셀 내부 컨테이너
                            let stack = cell.querySelector('.cell-stack');
                            if (!stack) {
                                stack = document.createElement('div');
                                stack.className = 'cell-stack';
                                cell.appendChild(stack);
                            }

                            // 멤버 색 바 추가
                            const bar = document.createElement('span');
                            bar.className = 'member-bar';
                            bar.style.background = hexWithAlpha(color, 0.85);
                            bar.style.minWidth = '18px';
                            bar.style.maxWidth = '46px';
                            bar.style.width = '20%';
                            bar.title = `${m.name || ''} ${s.start || ''}~${s.end || ''}`;
                            stack.appendChild(bar);
                        }
                    }
                });
            });

            // 오늘 컬럼 하이라이트를 다시 적용 (초기화 과정에서 제거될 수 있으므로)
            reapplyTodayHighlight();
        }

        function highlightMemberInGrid(member) {
            const color = colorForMember(member);
            const bars = document.querySelectorAll('.member-bar');
            bars.forEach(el => el.style.outline = 'none');
            const name = member.name || '';
            document.querySelectorAll(`.member-bar[title*="${cssEscape(name)}"]`).forEach(el => {
                el.style.outline = `2px solid ${hexWithAlpha(color, 1)}`;
            });
        }

        function renderMemberInfo(m) {
            infoName.textContent = m.name ?? '-';
            infoGender.textContent = m.gender ?? '-';
            infoPhone.textContent = m.phone ?? '-';
            infoEmail.textContent = m.email ?? '-';
            infoStartDate.textContent = m.startDate ?? '-';

            if (m.hasHealthCertificate) {
                infoHealth.textContent = m.healthCertExpiry ? `보유 (유효기간: ${m.healthCertExpiry})` : '보유';
            } else {
                infoHealth.textContent = '미보유';
            }

            infoHourlyWage.textContent =
                    (typeof m.hourlyWage === 'number')
                            ? new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(m.hourlyWage)
                            : '-';

            const badgeMap = {
                WORKING: 'bg-success', WAITING: 'bg-secondary', RESTING: 'bg-info',
                PAUSED: 'bg-warning', RESIGNED: 'bg-danger'
            };
            statusBadge.textContent = m.status || '-';
            statusBadge.className = `badge ${badgeMap[m.status] || 'bg-secondary'}`;
        }

        function clearInfo() {
            statusBadge.textContent = '-';
            statusBadge.className = 'badge bg-secondary';
            infoName.textContent = '-';
            infoGender.textContent = '-';
            infoPhone.textContent = '-';
            infoEmail.textContent = '-';
            infoStartDate.textContent = '-';
            infoHealth.textContent = '-';
            infoHourlyWage.textContent = '-';
        }

        // ====== Grid helpers ======

        function renderTimeGrid() {
            const rows = [];
            for (let h = HOUR_START; h <= HOUR_END; h++) {
                const label = `${String(h).padStart(2,'0')}:00`;
                rows.push(`
        <tr data-hour="${h}">
          <th scope="row">${label}</th>
          <td data-col="1"></td>
          <td data-col="2"></td>
          <td data-col="3"></td>
          <td data-col="4"></td>
          <td data-col="5"></td>
          <td data-col="6"></td>
          <td data-col="7"></td>
        </tr>
      `);
            }
            timetableBody.innerHTML = rows.join('');
        }

        function clearGridCells() {
            timetableBody.querySelectorAll('td').forEach(td => {
                td.classList.remove('today-col'); // 하이라이트 초기화
                td.innerHTML = '';
            });
        }

        function reapplyTodayHighlight() {
            const today = new Date();
            const todayCol = ((today.getDay() + 6) % 7) + 1;
            timetableBody.querySelectorAll(`td[data-col="${todayCol}"]`).forEach(td => td.classList.add('today-col'));
        }

        // ====== Data helpers ======

        function getSchedules(m) {
            if (Array.isArray(m?.schedule)) return m.schedule;
            if (Array.isArray(m?.schedules)) return m.schedules;
            return [];
        }

        function parseHm(hm) {
            if (!hm || typeof hm !== 'string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n => parseInt(n,10));
            return {h: isNaN(h)?0:h, m: isNaN(m)?0:m};
        }

        // [start, end) 구간이 특정 정시 h를 포함하는지
        function intervalHitHour(st, ed, h) {
            const stMin = st.h*60 + st.m;
            const edMin = ed.h*60 + ed.m;
            const a = h*60, b = (h+1)*60; // [a,b)
            return Math.max(0, Math.min(edMin, b) - Math.max(stMin, a)) > 0;
        }

        // ====== Color helpers (랜덤 느낌의 안정적 색상) ======

        function colorForMember(m) {
            const key = (m.id != null ? String(m.id) : (m.name || 'x'));
            const h = seededHash(key) % 360; // Hue: 0~359
            const s = 65;                    // Saturation
            const l = 55;                    // Lightness
            return hslToHex(h, s, l);
        }

        function seededHash(str) {
            let h = 2166136261 >>> 0; // FNV-like
            for (let i=0; i<str.length; i++) {
                h ^= str.charCodeAt(i);
                h = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }

        function hslToHex(h, s, l){
            s /= 100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1 - l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n), 1)));
            const toHex = x => Math.round(255 * x).toString(16).padStart(2, '0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }

        function hexWithAlpha(hex, alpha=1){
            const a = Math.round(alpha*255).toString(16).padStart(2,'0');
            return `${hex}${a}`;
        }

        // ====== Utils ======

        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

        function cssEscape(s) {
            // 매우 단순화: 따옴표만 이스케이프
            return String(s || '').replace(/["'`]/g, '\\$&');
        }

    })();
</script>

{{>layouts/footer}}
