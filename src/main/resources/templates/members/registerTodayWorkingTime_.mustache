{{>layouts/header}}

<main class="container my-4">
  <div class="row g-3">
    <!-- ============ 왼쪽: 날짜 + 현재 근무자(테이블) ============ -->
    <div class="col-12 col-lg-4">
      <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
        <!-- 날짜 라벨 -->
        <div class="h5 mb-0" id="todayKR"></div>

        <!-- 현재 근무자 (테이블) -->
        <div class="card">
          <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <span>현재 근무자</span>
            <span class="d-inline-flex align-items-center gap-2">
              <small class="text-muted" id="nowClock">--:--</small>
              <span id="todayWorkingCount" class="badge bg-light text-dark">0명</span>
            </span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="workingTable">
                <thead>
                <tr class="text-muted">
                  <th style="width:28px;"></th>
                  <th>이름</th>
                  <th style="width:80px;">상태</th>
                  <th style="width:120px;">예정</th>
                  <th style="width:64px;">선택</th>
                </tr>
                </thead>
                <tbody id="workingTbody">
                <!-- JS 렌더 -->
                </tbody>
              </table>
            </div>
            <div id="workingEmpty" class="text-muted small mt-2" style="display:none;">
              현재 근무중인 인원이 없습니다.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ 오른쪽: 10분 단위 스케줄 + 실제 + 1시간 단위 선택 버튼 ============ -->
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>금일 10분 단위 타임테이블</span>
          <small class="text-muted" id="selectedMemberTitle">선택된 알바생 없음</small>
        </div>
        <div class="card-body">
          <!-- 툴바 -->
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div class="small text-muted">
              왼쪽 “현재 근무자”에서 선택하세요. 스케줄은 <b>주황</b>, 실제는 <b>10분 단위</b> 선택.
              우측 버튼으로 <b>1시간 단위</b> 토글! <b>전체선택(실제)</b>은 스케줄과 동일 구간만 선택합니다.
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnClearActual" disabled>실제 선택 초기화</button>
              <button class="btn btn-outline-primary btn-sm" id="btnSelectAllActual" disabled>전체선택(실제)</button>
              <button class="btn btn-success btn-sm" id="btnSaveActual" disabled>선택 저장</button>
            </div>
          </div>

          <!-- 10분 테이블 -->
          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center timetable-10m mb-2" id="table10m">
              <thead>
              <tr>
                <th style="width:80px;">시간</th>
                <th style="width:40%;">스케줄</th>
                <th style="width:40%;">실제(10분 단위)</th>
                <th style="width:140px;">1시간 단위 선택</th>
              </tr>
              </thead>
              <tbody id="tbody10m">
              <!-- JS 렌더 -->
              </tbody>
            </table>
          </div>

          <!-- 선택 요약 -->
          <div>
            <div class="small text-muted mb-1">실제 선택 구간</div>
            <div id="actualSummary" class="small">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
  .timetable-10m th, .timetable-10m td { vertical-align: middle; }
  .slot-10m {
    height: 16px; border: 1px solid #eef2f6; border-radius: 3px;
    background: #fff; position: relative; cursor: pointer;
  }
  .slot-10m:hover { background:#f8fbff; }

  /* 스케줄: 주황색 하이라이트 */
  .slot-10m.schedule { cursor: default; }
  .slot-10m.schedule.on {
    background: rgba(255, 159, 67, .35);
    border-color: rgba(255, 159, 67, .65);
  }

  /* 실제: 10분 단위 선택 */
  .slot-10m.actual.on { background: rgba(25,135,84,.25); border-color: rgba(25,135,84,.35); }
  .slot-10m.actual.dragging { box-shadow: inset 0 0 0 2px rgba(25,135,84,.5); }

  /* 1시간 단위 버튼 셀 스타일 */
  .hour-select-cell { vertical-align: middle !important; }
  .hour-select-cell .btn { width: 100%; }

  .dot { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.08); }
  .timecell { font-variant-numeric: tabular-nums; }
</style>

<!-- 컨트롤러에서 내려준 JSON: membersJson -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
/* ===== 오늘 한국어 날짜 라벨 ===== */
(function setTodayLabel(){
  const el = document.getElementById('todayKR');
  if (!el) return;
  const days = ['일','월','화','수','목','금','토'];
  const d = new Date();
  el.textContent = `${d.getFullYear()}년${d.getMonth()+1}월${d.getDate()}일 ${days[d.getDay()]}요일`;
})();
</script>

<script>
(function(){
  /** ===== 상수/DOM ===== */
  const HOUR_START = 6, HOUR_END = 22;       // 06:00 ~ 22:00
  const STEP_MIN = 10;                        // 10분 단위
  const SLOTS_PER_HOUR = 60 / STEP_MIN;       // 6

  const nowClock = document.getElementById('nowClock');
  const workingTbody = document.getElementById('workingTbody');
  const workingEmpty = document.getElementById('workingEmpty');
  const todayWorkingCount = document.getElementById('todayWorkingCount');

  const tbody10m = document.getElementById('tbody10m');
  const selectedMemberTitle = document.getElementById('selectedMemberTitle');
  const btnClearActual = document.getElementById('btnClearActual');
  const btnSelectAllActual = document.getElementById('btnSelectAllActual');
  const btnSaveActual = document.getElementById('btnSaveActual');
  const actualSummary = document.getElementById('actualSummary');

  /** ===== 데이터 로드 ===== */
  let allMembers = [];
  try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); }
  catch(e) { allMembers = []; }

  /** ===== 상태 ===== */
  let selectedMemberId = null;
  let dragging = false;       // 실제 칼럼 드래그 여부
  let dragSelecting = true;   // 드래그 시작 시 on/off 결정

  /** ===== 초기 ===== */
  renderWorkingTable();
  tick();
  setInterval(tick, 30*1000);

  function tick(){
    const d = new Date();
    nowClock.textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  /** 현재 근무자 테이블 (WORKING/BREAK + 금일 스케줄 보유) */
  function renderWorkingTable(){
    const todayKey = dayKeyOf(new Date());
    const items = (allMembers||[])
      .filter(m => (m.status==='WORKING' || m.status==='BREAK'))
      .filter(m => getSchedules(m).some(s => s.day===todayKey));

    workingTbody.innerHTML = '';
    todayWorkingCount.textContent = `${items.length}명`;
    workingEmpty.style.display = items.length ? 'none' : 'block';

    items
      .slice()
      .sort((a,b) => (a.name||'').localeCompare(b.name||'', 'ko'))
      .forEach(m=>{
        const tr = document.createElement('tr');
        const color = colorForMember(m);
        tr.innerHTML = `
          <td><span class="dot" style="background:${color}"></span></td>
          <td class="fw-semibold">${escapeHtml(m.name||'-')}</td>
          <td><span class="badge ${m.status==='BREAK'?'bg-warning text-dark':'bg-success'}">${m.status==='BREAK'?'휴식중':'근무중'}</span></td>
          <td>${escapeHtml(todayPlanLabel(m) || '-')}</td>
          <td><button class="btn btn-sm btn-outline-primary">선택</button></td>
        `;
        tr.querySelector('button').addEventListener('click', ()=>pickMember(m));
        tr.addEventListener('click', (e)=>{ if (e.target.tagName!=='BUTTON') pickMember(m); });
        workingTbody.appendChild(tr);
      });
  }

  function pickMember(m){
    selectedMemberId = m.id;
    selectedMemberTitle.textContent = `${m.name} — 금일 타임테이블`;
    buildTenMinuteTableFor(m);
    btnClearActual.disabled = false;
    btnSelectAllActual.disabled = false;
    btnSaveActual.disabled  = false;
  }

  function todayPlanLabel(m){
    const key = dayKeyOf(new Date());
    const seg = getSchedules(m).find(s=>s.day===key);
    return seg ? `${seg.start}–${seg.end}` : '';
  }

  /** ===== 10분 단위 타임테이블 (스케줄=주황, 실제=10분, +1시간 버튼) ===== */
  function buildTenMinuteTableFor(member){
    tbody10m.innerHTML = '';

    // 06:00 ~ 22:00 → 10분 슬롯
    const slots = [];
    for (let h=HOUR_START; h<HOUR_END; h++){
      for (let m=0; m<60; m+=STEP_MIN){
        slots.push({ h, m, hm: `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` });
      }
    }
    // 오늘 스케줄
    const todayKey = dayKeyOf(new Date());
    const segs = getSchedules(member).filter(s=>s.day===todayKey);

    for (let i=0; i<slots.length; i++){
      const slot = slots[i];
      const isHourStart = (slot.m === 0);

      const tr = document.createElement('tr');

      // 시간
      const timeTd = document.createElement('td');
      timeTd.className='timecell';
      timeTd.textContent = slot.hm;

      // 스케줄(주황)
      const schTd = document.createElement('td');
      const schDiv = document.createElement('div');
      schDiv.className='slot-10m schedule';
      if (segs.some(s => slotInside(slot.hm, s.start, s.end))) schDiv.classList.add('on');
      schTd.appendChild(schDiv);

      // 실제(10분)
      const actTd = document.createElement('td');
      const actDiv = document.createElement('div');
      actDiv.className='slot-10m actual';
      actDiv.dataset.index = String(i);
      actTd.appendChild(actDiv);

      tr.appendChild(timeTd);
      tr.appendChild(schTd);
      tr.appendChild(actTd);

      // 1시간 단위 버튼 (해당 시간의 첫 행에만 생성, rowSpan=6)
      if (isHourStart){
        const hourTd = document.createElement('td');
        hourTd.className = 'hour-select-cell';
        hourTd.rowSpan = SLOTS_PER_HOUR; // 6
        const label = `${String(slot.h).padStart(2,'0')}:00`;
        hourTd.innerHTML = `
          <button class="btn btn-outline-dark btn-sm hour-toggle" data-hour="${slot.h}">${label} 선택/해제</button>
        `;
        tr.appendChild(hourTd);
      }

      tbody10m.appendChild(tr);
    }

    // === 드래그(10분) 선택 ===
    const actualSlots   = Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
    const scheduleSlots = Array.from(tbody10m.querySelectorAll('.slot-10m.schedule'));

    actualSlots.forEach(div=>{
      div.addEventListener('mousedown', (e)=>{
        e.preventDefault();
        dragging = true;
        const willOn = !div.classList.contains('on');
        dragSelecting = willOn;
        toggleActual(div, dragSelecting);
        div.classList.add('dragging');
      });
      div.addEventListener('mouseenter', ()=>{
        if (!dragging) return;
        toggleActual(div, dragSelecting);
        div.classList.add('dragging');
      });
      div.addEventListener('mouseleave', ()=>{ div.classList.remove('dragging'); });
      div.addEventListener('mouseup',    ()=>{ div.classList.remove('dragging'); });
    });
    window.addEventListener('mouseup', ()=>{
      if (!dragging) return;
      dragging=false;
      actualSlots.forEach(d=>d.classList.remove('dragging'));
      updateActualSummary();
    });

    // === 1시간 단위 버튼 ===
    tbody10m.querySelectorAll('.hour-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const hour = parseInt(btn.dataset.hour, 10);
        const start = (hour - HOUR_START) * SLOTS_PER_HOUR;
        const end   = start + SLOTS_PER_HOUR;
        // 모두 on이면 해제, 아니면 모두 on
        let allOn = true;
        for (let i=start; i<end; i++){
          if (!actualSlots[i]?.classList.contains('on')) { allOn=false; break; }
        }
        for (let i=start; i<end; i++){
          if (!actualSlots[i]) continue;
          if (allOn) actualSlots[i].classList.remove('on');
          else actualSlots[i].classList.add('on');
        }
        updateActualSummary();
      });
    });

    // ✅ 전체선택(실제) → 스케줄과 동일 슬롯만 on
    btnSelectAllActual.onclick = ()=>{
      for (let i=0; i<actualSlots.length; i++){
        if (scheduleSlots[i]?.classList.contains('on')) actualSlots[i].classList.add('on');
        else actualSlots[i].classList.remove('on');
      }
      updateActualSummary();
    };

    // 초기 요약
    updateActualSummary();
  }

  function toggleActual(div, on){ on ? div.classList.add('on') : div.classList.remove('on'); }

  /** 실제 선택 요약/병합 */
  function updateActualSummary(){
    const selected = getSelectedRanges();
    actualSummary.textContent = selected.length ? selected.map(r=>`${r.start}~${r.end}`).join(', ') : '-';
  }
  function getSelectedRanges(){
    const slots = Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
    const onIdx = slots.map((d,i)=>d.classList.contains('on')?i:null).filter(i=>i!=null);
    if (!onIdx.length) return [];
    const ranges=[]; let s=onIdx[0], p=onIdx[0];
    for (let i=1;i<onIdx.length;i++){
      if (onIdx[i]===p+1){ p=onIdx[i]; continue; }
      ranges.push([s,p]); s=onIdx[i]; p=onIdx[i];
    }
    ranges.push([s,p]);
    return ranges.map(([a,b])=>{
      const startHM = indexToHM(a);
      const endHM   = addMinutes(indexToHM(b), STEP_MIN); // end는 다음 슬롯 시작
      return { start:startHM, end:endHM };
    });
  }

  /** 버튼 */
  btnClearActual.addEventListener('click', ()=>{
    tbody10m.querySelectorAll('.slot-10m.actual.on').forEach(d=>d.classList.remove('on'));
    updateActualSummary();
  });

  btnSaveActual.addEventListener('click', ()=>{
    if (!selectedMemberId){ alert('알바생을 먼저 선택하세요.'); return; }
    const ranges = getSelectedRanges();
    const payload = {
      memberId: selectedMemberId,
      date: fmtDateYYYYMMDD(new Date()),
      segments: ranges
    };

    const ok = confirm('실제 근무한 구간을 저장하시겠습니까?');
    if (!ok) {
        alert('저장이 취소되었습니다.');
        return;
    }

    fetch('/api/schedule/save', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload) })
            .then(response => {
                if (!response.ok) {
                    // HTTP 200이 아닌 경우
                    throw new Error('서버 오류 발생 (' + response.status + ')');
                }
                return response.json(); // or .text() — 서버 반환 형식에 맞게
            })
            .then(result => {
                console.log('서버 응답:', result);

                // result.success == true 이면 성공 처리
                if (result.success) {
                    alert('✅ 저장 성공!');
                } else {
                    alert('⚠️ 저장 실패: ' + (result.message || '알 수 없는 오류'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('❌ 저장 중 오류가 발생했습니다.');
            });
  });

  /** ===== 유틸 ===== */
  function getSchedules(m){
    if (Array.isArray(m?.schedule)) return m.schedule;
    if (Array.isArray(m?.schedules)) return m.schedules;
    return [];
  }
  function dayKeyOf(d){ return ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()]; }
  function slotInside(hm, start, end){
    const t = hmToMin(hm), s=hmToMin(start), e=hmToMin(end);
    return t>=s && t<e;
  }
  function hmToMin(hm){ const [h,m]=hm.split(':').map(n=>parseInt(n,10)); return h*60+m; }
  function fmtDateYYYYMMDD(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function indexToHM(idx){
    const totalMin = (HOUR_START*60) + (idx*STEP_MIN);
    const h = Math.floor(totalMin/60), m=totalMin%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }
  function addMinutes(hm, mins){
    const [h,m] = hm.split(':').map(n=>parseInt(n,10));
    const total = h*60+m+mins;
    const hh = Math.floor(total/60), mm = total%60;
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  }
  function colorForMember(m){
    const key = (m.id!=null?String(m.id):(m.name||'x'));
    const h = seededHash(key)%360, s=65, l=55;
    return hslToHex(h,s,l);
  }
  function seededHash(str){
    let h=2166136261>>>0;
    for (let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
    return h>>>0;
  }
  function hslToHex(h,s,l){
    s/=100; l/=100;
    const k=n=>(n + h/30)%12;
    const a=s*Math.min(l,1-l);
    const f=n=>l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
    const to=x=>Math.round(255 * x).toString(16).padStart(2,'0');
    return `#${to(f(0))}${to(f(8))}${to(f(4))}`;
  }
  function escapeHtml(s){
    if (s == null) return '';
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
})();
</script>

{{>layouts/footer}}
