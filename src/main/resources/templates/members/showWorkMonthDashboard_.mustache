{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ============ 왼쪽: 상태 선택 + 알바생 리스트(색 점) ============ -->
        <div class="col-12 col-lg-5">
            <div class="d-grid gap-3 sticky-lg-top" style="top: 12px;">

                <!-- 상태 선택 + 알바생 리스트업 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="fw-bold">아르바이트 상태별 보기</span>
                        <a href="/members/new" class="btn btn-sm btn-primary">추가등록</a>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-12">
                                <label for="statusSelect" class="form-label small text-muted">상태</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="WORKING" selected>근무중</option>
                                    <option value="WAITING">시작전</option>
                                    <option value="RESTING">휴식중</option>
                                    <option value="PAUSED">일시중지</option>
                                    <option value="RESIGNED">퇴사</option>
                                </select>
                                <div class="form-text">상태를 변경하면 좌측 리스트와 우측 타임테이블이 함께 갱신됩니다.</div>
                            </div>
                        </div>

                        <hr>

                        <!-- 알바생 리스트 -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="small text-muted">알바생 목록</div>
                                <span id="memberCountBadge" class="badge bg-light text-dark">0명</span>
                            </div>
                            <ul id="memberList" class="list-group list-group-flush">
                                <!-- JS 렌더 -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- (선택) 알바생 정보 패널 -->
                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>아르바이트 정보</span>
                        <span id="statusBadge" class="badge bg-secondary">-</span>
                    </div>
                    <div class="card-body">
                        <div class="row gy-2">
                            <div class="col-6">
                                <div class="text-muted">이름</div>
                                <div id="infoName" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">성별</div>
                                <div id="infoGender" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">전화번호</div>
                                <div id="infoPhone" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">이메일</div>
                                <div id="infoEmail" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">시작일</div>
                                <div id="infoStartDate" class="fw-semibold">-</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted">보건증</div>
                                <div id="infoHealth" class="fw-semibold">-</div>
                            </div>
                            <div class="col-12">
                                <div class="text-muted">시급(원)</div>
                                <div id="infoHourlyWage" class="fw-semibold">-</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ============ 오른쪽: 월간 타임테이블 (일별 + 주별 합계 + 월 합계) ============ -->
        <div class="col-12 col-lg-7">
            <div class="card">
                <div class="card-header fw-bold d-flex align-items-center justify-content-between">
                    <span>월간 타임테이블 (일별)</span>
                    <div class="small text-muted">
                        <span id="monthRangeLabel">{{monthRangeLabel}}</span>
                        <a class="ms-2 btn btn-sm btn-outline-secondary" href="{{monthPrevUrl}}">◀ 이전 달</a>
                        <a class="ms-1 btn btn-sm btn-outline-secondary" href="{{monthNextUrl}}">다음 달 ▶</a>
                    </div>
                </div>

                <div class="card-body">
                    <!-- 선택 멤버 타이틀/상태 -->
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="h5 mb-0" id="selectedMemberTitle">-</div>
                        <span id="selectedMemberStatus" class="badge bg-secondary">-</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered align-middle" id="monthWorkTable">
                            <thead class="table-light">
                            <tr>
                                <th style="width:160px;">날짜(요일)</th>
                                <th>실 근무시간 (구간)</th>
                                <th style="width:140px;" class="text-end">일 합계</th>
                            </tr>
                            </thead>
                            <tbody id="monthWorkTbody">
                            <!-- JS 렌더: 일별 행 + (주별 합계 행) -->
                            </tbody>
                            <tfoot>
                            <tr>
                                <th>월 합계</th>
                                <td class="text-end fw-semibold" id="monthActualTotalCell">0시간</td>
                                <th class="text-end text-primary" id="monthPayCell">-</th>
                            </tr>
                            <tr>
                                <th>시급</th>
                                <td class="text-end">기준 시급</td>
                                <th class="text-end" id="hourlyWageCell">-</th>
                            </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="small text-muted">
                        * 실제는 일자별 실근무 데이터(API) 기반입니다. 각 주의 마지막에 ‘주 합계/예상 급여’가 표시되고, 표 맨 아래에 월 합계가 표시됩니다.
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .chip {
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid #e9ecef; border-radius:14px; padding:4px 8px; background:#fff;
    }
    .chip .dot { width:10px; height:10px; border-radius:50%; border:1px solid rgba(0,0,0,.08); }
    .member-chip {
        display:flex; align-items:center; justify-content:space-between; gap:8px;
        padding:8px 10px; border-radius:10px; background:#fff; border:1px solid #eee; margin-bottom:6px; cursor:pointer;
    }
    .member-chip:hover { background:#f8f9fa; }
    .member-chip .left { display:inline-flex; align-items:center; gap:8px; }
</style>

<!-- 컨트롤러에서 내려준 JSON -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    // JSON 파싱
    let allMembers = [];
    try {
        allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
    } catch(e) { allMembers = []; }
</script>

<script>
    (function() {
        // ===== DOM: 좌측 공용 =====
        const statusSelect = document.getElementById('statusSelect');
        const memberList = document.getElementById('memberList');
        const memberCountBadge = document.getElementById('memberCountBadge');

        // 좌측 info
        const statusBadge  = document.getElementById('statusBadge');
        const infoName = document.getElementById('infoName');
        const infoGender = document.getElementById('infoGender');
        const infoPhone = document.getElementById('infoPhone');
        const infoEmail = document.getElementById('infoEmail');
        const infoStartDate = document.getElementById('infoStartDate');
        const infoHealth = document.getElementById('infoHealth');
        const infoHourlyWage = document.getElementById('infoHourlyWage');

        // ===== DOM: 우측(월간) =====
        const selectedMemberTitle = document.getElementById('selectedMemberTitle');
        const selectedMemberStatus = document.getElementById('selectedMemberStatus');
        const monthRangeLabelEl = document.getElementById('monthRangeLabel');
        const monthWorkTbody = document.getElementById('monthWorkTbody');
        const monthActualTotalCell = document.getElementById('monthActualTotalCell');
        const monthPayCell = document.getElementById('monthPayCell');
        const hourlyWageCell = document.getElementById('hourlyWageCell');

        // 상수/유틸
        const API_BASE = '/api/schedule'; // GET /api/schedule/{memberId}/{startIso}/{endIso}
        const DOW_KO = ['일','월','화','수','목','금','토'];

        // 초기 상태 지정
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        // 이벤트 바인딩
        statusSelect.addEventListener('change', handleStatusChange);
        memberList.addEventListener('click', onMemberListClick);

        // 시작
        handleStatusChange();

        // ===== Handlers =====
        async function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);

            renderMemberList(filtered);

            if (filtered[0]) {
                renderMemberInfo(filtered[0]);
                await loadAndRenderMonth(filtered[0]);
            } else {
                clearInfo();
                clearMonthTable();
            }
        }

        async function onMemberListClick(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                e.stopPropagation();
                const id = btn.getAttribute('data-id');
                if (id) window.location.assign(`/members/${encodeURIComponent(id)}/edit`);
                return;
            }
            const li = e.target.closest('li.member-chip');
            if (!li) return;
            const id = li.getAttribute('data-member-id');
            const members = getCurrentFilteredMembers();
            const target = members.find(m => String(m.id) === String(id));
            if (target) {
                renderMemberInfo(target);
                await loadAndRenderMonth(target);
            }
        }

        function getCurrentFilteredMembers() {
            const status = statusSelect.value;
            return (allMembers || []).filter(m => m.status === status);
        }

        // ===== 좌측: 리스트 & 정보 =====
        function renderMemberList(members) {
            memberList.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;
            members.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko')).forEach(m=>{
                const li = document.createElement('li');
                li.className = 'list-group-item member-chip';
                li.dataset.memberId = String(m.id);
                const color = colorForMember(m);
                li.innerHTML = `
        <span class="left">
          <span class="dot" style="background:${color}"></span>
          <span class="fw-semibold">${escapeHtml(m.name ?? '-')}</span>
          <span class="text-muted small">${escapeHtml(m.phone ?? '')}</span>
        </span>
        <button type="button" class="btn btn-sm btn-outline-primary view-btn" data-id="${String(m.id)}">상세보기</button>
      `;
                memberList.appendChild(li);
            });
            if (!members.length) {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = '해당 상태의 알바생이 없습니다.';
                memberList.appendChild(li);
            }
        }

        function renderMemberInfo(m) {
            infoName.textContent = m.name ?? '-';
            infoGender.textContent = m.gender ?? '-';
            infoPhone.textContent = m.phone ?? '-';
            infoEmail.textContent = m.email ?? '-';
            infoStartDate.textContent = m.startDate ?? '-';
            if (m.hasHealthCertificate) {
                infoHealth.textContent = m.healthCertExpiry ? `보유 (유효기간: ${m.healthCertExpiry})` : '보유';
            } else {
                infoHealth.textContent = '미보유';
            }
            infoHourlyWage.textContent =
                    (typeof m.hourlyWage === 'number')
                            ? krw(m.hourlyWage)
                            : '-';

            const badgeMap = {WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            statusBadge.textContent = m.status || '-';
            statusBadge.className = `badge ${badgeMap[m.status] || 'bg-secondary'}`;
        }

        function clearInfo() {
            statusBadge.textContent = '-';
            statusBadge.className = 'badge bg-secondary';
            infoName.textContent = '-';
            infoGender.textContent = '-';
            infoPhone.textContent = '-';
            infoEmail.textContent = '-';
            infoStartDate.textContent = '-';
            infoHealth.textContent = '-';
            infoHourlyWage.textContent = '-';
        }

        // ===== 우측: 월간 렌더링 =====
        async function loadAndRenderMonth(member){
            selectedMemberTitle.textContent = member?.name ? `${member.name} — 월간 실근무` : '-';
            selectedMemberStatus.textContent = member?.status || '-';
            selectedMemberStatus.className = `badge ${statusClass(member?.status)}`;

            // 월 범위 계산
            const { monthStartIso, monthEndIso } = parseMonthRange(monthRangeLabelEl?.textContent || '');

            // 해당 월의 실제 구간/분 조회
            let actualMap = {};
            try {
                const url = `${API_BASE}/${encodeURIComponent(member.id)}/${monthStartIso}/${monthEndIso}`;
                const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                actualMap = normalizeActualDays(data); // 'YYYY-MM-DD' -> {segments, minutes}
            } catch (err) {
                console.error('monthly worklogs fetch error:', err);
                actualMap = {};
            }

            renderMonthTable(member, monthStartIso, monthEndIso, actualMap);
        }

        function renderMonthTable(member, startIso, endIso, actualMap){
            monthWorkTbody.innerHTML = '';
            let monthMinutes = 0;

            const wage = (typeof member?.hourlyWage === 'number') ? member.hourlyWage : null;
            hourlyWageCell.textContent = (wage!=null) ? krw(wage) : '-';

            const start = parseIsoDate(startIso);
            const end   = parseIsoDate(endIso);

            let weekMinutes = 0;
            let rows = [];
            let prevWeekNo = weekNumber(start);

            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const iso = toIso(d);
                const dayName = DOW_KO[d.getDay()];
                const a = actualMap[iso] || {segments:[], minutes:0};
                monthMinutes += (a.minutes||0);
                weekMinutes  += (a.minutes||0);

                const chips = (a.segments?.length)
                        ? a.segments.map(s=>chipHtml(colorForMember(member), s.start, s.end)).join(' ')
                        : '<span class="text-muted">—</span>';

                rows.push(`
        <tr>
          <th scope="row">${iso} (${dayName})</th>
          <td>${chips}</td>
          <td class="text-end">${formatMins(a.minutes||0)}</td>
        </tr>
      `);

                const isWeekEnd = d.getDay() === 0; // 일요일
                const isLastDay = toIso(d) === endIso;
                const curWeekNo = weekNumber(d);

                // 주 경계 또는 월 마지막에 주 합계 행 삽입
                if (isWeekEnd || isLastDay || curWeekNo !== prevWeekNo) {
                    const weekPay = (wage!=null) ? Math.round((weekMinutes/60)*wage) : null;
                    rows.push(`
          <tr class="table-secondary">
            <th>주 합계</th>
            <td class="text-end fw-semibold">${formatMins(weekMinutes)}</td>
            <th class="text-end">${weekPay!=null ? krw(weekPay) : '-'}</th>
          </tr>
        `);
                    weekMinutes = 0;
                    prevWeekNo = curWeekNo;
                }
            }

            monthWorkTbody.innerHTML = rows.join('');

            // 월 합계/급여
            monthActualTotalCell.textContent = formatMins(monthMinutes);
            const monthPay = (wage!=null) ? Math.round((monthMinutes/60)*wage) : null;
            monthPayCell.textContent = (monthPay!=null) ? krw(monthPay) : '-';
        }

        function clearMonthTable(){
            monthWorkTbody.innerHTML = '';
            monthActualTotalCell.textContent = '0시간';
            monthPayCell.textContent = '-';
            hourlyWageCell.textContent = '-';
            selectedMemberTitle.textContent = '-';
            selectedMemberStatus.textContent = '-';
            selectedMemberStatus.className = 'badge bg-secondary';
        }

        // ===== 날짜/시간/주차 유틸 =====
        function parseMonthRange(label){
            // 기대형태 예: "2025.11.01 ~ 11.30"
            const m = String(label).match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (!m) {
                const today = new Date();
                const ms = monthStart(today), me = monthEnd(today);
                return { monthStartIso: toIso(ms), monthEndIso: toIso(me) };
            }
            const y=+m[1], mo=+m[2], d=+m[3];
            const start = new Date(y, mo-1, d);
            const end = monthEnd(start);
            return { monthStartIso: toIso(start), monthEndIso: toIso(end) };
        }
        function monthStart(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
        function monthEnd(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }
        function parseIsoDate(iso){ const [y,m,d]=iso.split('-').map(n=>parseInt(n,10)); return new Date(y,m-1,d); }
        function toIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function formatMins(mins){ const h=Math.floor(mins/60), m=mins%60; return m===0?`${h}시간`:`${h}시간 ${m}분`; }
        function krw(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }

        // ISO-8601 주차(월요일 시작)
        function weekNumber(d){
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = (date.getUTCDay() + 6) % 7; // 0=월
            date.setUTCDate(date.getUTCDate() - dayNum + 3); // 목요일 기준
            const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
            const diff = (date - firstThu) / 86400000;
            return 1 + Math.floor(diff / 7);
        }

        // ===== 응답 정규화/보조 유틸 =====
        function normalizeActualDays(apiData){
            const map = {};
            const arr = Array.isArray(apiData?.days) ? apiData.days : [];
            arr.forEach(d=>{
                const date = String(d.date);
                const segments = Array.isArray(d.segments) ? d.segments : [];
                const minutes = (typeof d.minutes==='number')
                        ? d.minutes
                        : segments.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments, minutes };
            });
            return map;
        }
        function diffMinutes(start, end){
            const s = parseHm(start), e = parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm||typeof hm!=='string') return {h:0,m:0};
            const [h,m] = hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function chipHtml(color, start, end){
            return `<span class="chip"><span class="dot" style="background:${color}"></span><span class="small">${start} ~ ${end}</span></span>`;
        }
        function statusClass(s){
            const map = {WORKING:'bg-success',WAITING:'bg-secondary',RESTING:'bg-info',PAUSED:'bg-warning',RESIGNED:'bg-danger'};
            return map[s] || 'bg-secondary';
        }
        function colorForMember(m){
            const key = (m?.id!=null?String(m.id):(m?.name||'x'));
            const h = seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0; }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }
    })();
</script>

{{>layouts/footer}}
