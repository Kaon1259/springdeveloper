{{>layouts/header}}

<main class="container my-4">
    <div class="row g-3">
        <!-- ì™¼ìª½ í˜„ì¬ ê·¼ë¬´ì -->
        <div class="col-12 col-lg-4">
            <div class="d-grid gap-3 sticky-lg-top" style="top:12px;">
                <div class="h5 mb-0" id="todayKR"></div>

                <div class="card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>í˜„ì¬ ê·¼ë¬´ì</span>
                        <span class="d-inline-flex align-items-center gap-2">
              <small class="text-muted" id="nowClock">--:--</small>
              <span id="todayWorkingCount" class="badge bg-light text-dark">0ëª…</span>
            </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0" id="workingTable">
                                <thead>
                                <tr class="text-muted">
                                    <th style="width:28px;"></th>
                                    <th>ì´ë¦„</th>
                                    <th style="width:80px;">ìƒíƒœ</th>
                                    <th style="width:120px;">ì˜ˆì •</th>
                                    <th style="width:64px;">ì„ íƒ</th>
                                </tr>
                                </thead>
                                <tbody id="workingTbody"></tbody>
                            </table>
                        </div>
                        <div id="workingEmpty" class="text-muted small mt-2" style="display:none;">
                            í˜„ì¬ ê·¼ë¬´ì¤‘ì¸ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ íƒ€ì„í…Œì´ë¸” -->
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>ê¸ˆì¼ 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸”</span>
                    <small class="text-muted" id="selectedMemberTitle">ì„ íƒëœ ì•Œë°”ìƒ ì—†ìŒ</small>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                        <div class="small text-muted">
                            ì™¼ìª½ â€œí˜„ì¬ ê·¼ë¬´ìâ€ì—ì„œ ì„ íƒí•˜ì„¸ìš”. ìŠ¤ì¼€ì¤„ì€ <b>ì£¼í™©</b>, ì‹¤ì œëŠ” <b>10ë¶„ ë‹¨ìœ„</b> ì„ íƒ.
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" id="btnClearActual" disabled>ì‹¤ì œ ì´ˆê¸°í™”</button>
                            <button class="btn btn-outline-primary btn-sm" id="btnSelectAllActual" disabled>ì „ì²´ì„ íƒ(ì‹¤ì œ)</button>
                            <button class="btn btn-success btn-sm" id="btnSaveActual" disabled>ì €ì¥</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered align-middle text-center timetable-10m mb-2" id="table10m">
                            <thead>
                            <tr>
                                <th style="width:80px;">ì‹œê°„</th>
                                <th style="width:40%;">ìŠ¤ì¼€ì¤„</th>
                                <th style="width:40%;">ì‹¤ì œ</th>
                                <th style="width:140px;">1ì‹œê°„ ë‹¨ìœ„</th>
                            </tr>
                            </thead>
                            <tbody id="tbody10m"></tbody>
                        </table>
                    </div>

                    <div>
                        <div class="small text-muted mb-1">ì‹¤ì œ ì„ íƒ êµ¬ê°„</div>
                        <div id="actualSummary" class="small">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
    .slot-10m {height:16px; border:1px solid #eef2f6; border-radius:3px; background:#fff; cursor:pointer;}
    .slot-10m.schedule.on {background:rgba(255,159,67,.35);border-color:rgba(255,159,67,.65);}
    .slot-10m.actual.on {background:rgba(25,135,84,.25);border-color:rgba(25,135,84,.35);}
    .hour-select-cell .btn {width:100%;}
    .timecell {font-variant-numeric: tabular-nums;}
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const HOUR_START=6,HOUR_END=22,STEP_MIN=10,SLOTS_PER_HOUR=6;
        const tbody10m=document.getElementById('tbody10m');
        const selectedMemberTitle=document.getElementById('selectedMemberTitle');
        const btnClearActual=document.getElementById('btnClearActual');
        const btnSelectAllActual=document.getElementById('btnSelectAllActual');
        const btnSaveActual=document.getElementById('btnSaveActual');
        const actualSummary=document.getElementById('actualSummary');

        let allMembers=[];
        try{allMembers=JSON.parse(document.getElementById('membersData').textContent||'[]');}catch(e){allMembers=[];}

        let selectedMemberId=null;
        let dragging=false,dragSelecting=true;

        renderWorkingTable();

        function renderWorkingTable(){
            const tbody=document.getElementById('workingTbody');
            tbody.innerHTML='';
            const todayKey=dayKeyOf(new Date());
            const list=allMembers.filter(m=>getSchedules(m).some(s=>s.day===todayKey));
            list.forEach(m=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
        <td><span class="dot" style="background:#999"></span></td>
        <td>${m.name}</td>
        <td><span class="badge bg-success">ê·¼ë¬´ì¤‘</span></td>
        <td>${todayPlanLabel(m)}</td>
        <td><button class="btn btn-sm btn-outline-primary">ì„ íƒ</button></td>`;
                tr.querySelector('button').addEventListener('click',()=>pickMember(m));
                tbody.appendChild(tr);
            });
        }

        /** âœ… ì•Œë°” ì„ íƒ ì‹œ DBì˜ ì‹¤ì œê·¼ë¬´ ë°ì´í„° ë¡œë“œ */
        function pickMember(m){
            selectedMemberId=m.id;
            selectedMemberTitle.textContent=`${m.name} â€” ê¸ˆì¼ íƒ€ì„í…Œì´ë¸”`;
            buildTenMinuteTableFor(m);

            const date=fmtDateYYYYMMDD(new Date());

            fetch(`/api/schedule/${m.id}/${date}`)
                    .then(res=>res.ok?res.json():null)
                    .then(data=>{
                        if(!data) return;
                        if(Array.isArray(data.segments) && data.segments.length){
                            console.log('ğŸ”¹ ê¸°ì¡´ ì‹¤ì œ ë°ì´í„°:',data);
                            applyActualSegments(data.segments); // âœ… ì‹¤ì œ ì¹¸ í‘œì‹œ
                        }
                    }).catch(err=>console.error(err));

            btnClearActual.disabled=false;
            btnSelectAllActual.disabled=false;
            btnSaveActual.disabled=false;
        }

        /** âœ… ì‹¤ì œê·¼ë¬´ êµ¬ê°„ í‘œì‹œ */
        function applyActualSegments(segments){
            const slots=Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
            segments.forEach(seg=>{
                const s=hmToMin(seg.start),e=hmToMin(seg.end);
                slots.forEach((d,i)=>{
                    const t=hmToMin(indexToHM(i));
                    if(t>=s && t<e) d.classList.add('on');
                });
            });
            updateActualSummary();
        }

        /** 10ë¶„ ë‹¨ìœ„ íƒ€ì„í…Œì´ë¸” ìƒì„± */
        function buildTenMinuteTableFor(member){
            tbody10m.innerHTML='';
            const slots=[];
            for(let h=HOUR_START;h<HOUR_END;h++){
                for(let m=0;m<60;m+=STEP_MIN){
                    slots.push({h,m,hm:`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`});
                }
            }
            const todayKey=dayKeyOf(new Date());
            const segs=getSchedules(member).filter(s=>s.day===todayKey);

            for(let i=0;i<slots.length;i++){
                const slot=slots[i];
                const tr=document.createElement('tr');
                tr.innerHTML=`
        <td class="timecell">${slot.hm}</td>
        <td><div class="slot-10m schedule ${segs.some(s=>slotInside(slot.hm,s.start,s.end))?'on':''}"></div></td>
        <td><div class="slot-10m actual" data-index="${i}"></div></td>
      `;
                if(slot.m===0){
                    const td=document.createElement('td');
                    td.className='hour-select-cell';
                    td.rowSpan=SLOTS_PER_HOUR;
                    td.innerHTML=`<button class="btn btn-outline-dark btn-sm hour-toggle" data-hour="${slot.h}">${String(slot.h).padStart(2,'0')}:00 ì„ íƒ</button>`;
                    tr.appendChild(td);
                }
                tbody10m.appendChild(tr);
            }

            // ë“œë˜ê·¸, ë²„íŠ¼, ì „ì²´ì„ íƒ ë¡œì§ ë™ì¼
            const actualSlots=Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
            const scheduleSlots=Array.from(tbody10m.querySelectorAll('.slot-10m.schedule'));
            actualSlots.forEach(div=>{
                div.addEventListener('mousedown',e=>{
                    e.preventDefault(); dragging=true;
                    dragSelecting=!div.classList.contains('on');
                    toggleActual(div,dragSelecting);
                });
                div.addEventListener('mouseenter',()=>{if(dragging)toggleActual(div,dragSelecting);});
            });
            window.addEventListener('mouseup',()=>{dragging=false;updateActualSummary();});

            tbody10m.querySelectorAll('.hour-toggle').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const h=parseInt(btn.dataset.hour);
                    const s=(h-HOUR_START)*SLOTS_PER_HOUR, e=s+SLOTS_PER_HOUR;
                    let allOn=true;
                    for(let i=s;i<e;i++){if(!actualSlots[i].classList.contains('on')){allOn=false;break;}}
                    for(let i=s;i<e;i++){allOn?actualSlots[i].classList.remove('on'):actualSlots[i].classList.add('on');}
                    updateActualSummary();
                });
            });

            btnSelectAllActual.onclick=()=>{
                for(let i=0;i<actualSlots.length;i++){
                    if(scheduleSlots[i].classList.contains('on'))actualSlots[i].classList.add('on');
                    else actualSlots[i].classList.remove('on');
                }
                updateActualSummary();
            };

            updateActualSummary();
        }

        /** ì €ì¥ */
        btnSaveActual.addEventListener('click',()=>{
            if(!selectedMemberId){alert('ì•Œë°”ìƒ ì„ íƒ');return;}
            const ranges=getSelectedRanges();
            const payload={memberId:selectedMemberId,date:fmtDateYYYYMMDD(new Date()),segments:ranges};
            if(!confirm('ì‹¤ì œ ê·¼ë¬´í•œ êµ¬ê°„ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;

            fetch('/api/schedule/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
                    .then(r=>r.json())
                    .then(result=>{
                        if(result.success) alert('âœ… ì €ì¥ ì„±ê³µ!');
                        else alert('âš ï¸ ì‹¤íŒ¨: '+(result.message||'ì˜¤ë¥˜'));
                    }).catch(()=>alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜'));
        });

        /** ìœ í‹¸ */
        function toggleActual(div,on){on?div.classList.add('on'):div.classList.remove('on');}
        function getSchedules(m){return m.schedules||m.schedule||[];}
        function dayKeyOf(d){return ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()];}
        function hmToMin(hm){const[a,b]=hm.split(':').map(Number);return a*60+b;}
        function indexToHM(i){const t=(HOUR_START*60)+i*STEP_MIN;return `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;}
        function slotInside(hm,s,e){const t=hmToMin(hm),ss=hmToMin(s),ee=hmToMin(e);return t>=ss&&t<ee;}
        function getSelectedRanges(){
            const s=Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
            const idx=s.map((d,i)=>d.classList.contains('on')?i:null).filter(i=>i!=null);
            if(!idx.length)return[];
            const r=[];let a=idx[0],p=idx[0];
            for(let i=1;i<idx.length;i++){if(idx[i]===p+1)p=idx[i];else{r.push([a,p]);a=idx[i];p=idx[i];}}
            r.push([a,p]);
            return r.map(([a,b])=>({start:indexToHM(a),end:addMinutes(indexToHM(b),STEP_MIN)}));
        }
        function addMinutes(hm,mins){const[h,m]=hm.split(':').map(Number);const t=h*60+m+mins;return `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;}
        function updateActualSummary(){const s=getSelectedRanges();actualSummary.textContent=s.length?s.map(r=>`${r.start}~${r.end}`).join(', '):'-';}
        function fmtDateYYYYMMDD(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
        function todayPlanLabel(m){const k=dayKeyOf(new Date());const seg=getSchedules(m).find(s=>s.day===k);return seg?`${seg.start}â€“${seg.end}`:'';}
    })();
</script>

{{>layouts/footer}}
