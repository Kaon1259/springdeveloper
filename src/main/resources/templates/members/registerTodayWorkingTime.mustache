{{>layouts/header}}

<main class="container my-4">

    <!-- ============ 상단: 아르바이트 상태별 보기 (칩 리스트) ============ -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">아르바이트 상태별 보기</span>
            <a href="/members/new" class="btn btn-sm btn-primary">추가등록</a>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- 상태 선택 -->
                <div class="col-12 col-md-4">
                    <label for="statusSelect" class="form-label small text-muted">상태</label>
                    <select id="statusSelect" class="form-select">
                        <option value="WORKING" selected>근무중</option>
                        <option value="WAITING">시작전</option>
                        <option value="RESTING">휴식중</option>
                        <option value="PAUSED">일시중지</option>
                        <option value="RESIGNED">퇴사</option>
                    </select>
                    <div class="form-text">
                        상태를 변경하면 아르바이트 목록과 아래 타임테이블이 함께 갱신됩니다.
                    </div>
                </div>

                <!-- 아르바이트 리스트 (칩) -->
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">아르바이트 목록</div>
                        <span id="memberCountBadge" class="badge bg-light text-dark">0명</span>
                    </div>
                    <div id="memberPills" class="vlist">
                        <!-- JS 렌더 -->
                    </div>
                    <div class="small text-muted mt-2">
                        * 각 사람 옆의 색상은 근로자의 고유 색입니다.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ 하단: 일간 타임테이블 ============ -->
    <div class="card">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            <span>일간 근무 타임테이블</span>
            <div class="d-flex flex-column align-items-end">
                <small class="text-muted" id="selectedMemberTitle">선택된 알바생 없음</small>
                <small class="text-muted" id="currentDateLabel"></small>
            </div>
        </div>
        <div class="card-body">

            <!-- 상단 안내 + 버튼들 -->
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <div class="small text-muted">
                    위의 아르바이트생 중 한 명을 선택하세요. <br class="d-sm-none">
                    아래 표의 한 칸은 <b>10분 / 30분 / 1시간</b> 단위로 변경할 수 있습니다.
                </div>

                <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">

                    <!-- 선택 단위 버튼 -->
                    <div class="btn-group btn-group-sm" role="group" aria-label="slot resolution">
                        <button type="button" class="btn btn-primary" data-res="10" id="btnRes10">10분</button>
                        <button type="button" class="btn btn-outline-secondary" data-res="30" id="btnRes30">30분</button>
                        <button type="button" class="btn btn-outline-secondary" data-res="60" id="btnRes60">1시간</button>
                    </div>

                    <!-- 작업 버튼 -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="btnClearActual" disabled>실제 초기화</button>
                        <button class="btn btn-outline-primary btn-sm" id="btnSelectAllActual" disabled>전체선택(실제)</button>
                        <button class="btn btn-success btn-sm" id="btnSaveActual" disabled>저장</button>
                    </div>

                    <!-- 날짜 이동 버튼 그룹 -->
                    <div class="btn-group btn-group-sm" role="group" aria-label="day navigation">
                        <button type="button" class="btn btn-outline-secondary" id="btnDayPrev">D-1</button>
                        <button type="button" class="btn btn-outline-secondary" id="btnDayToday">오늘</button>
                        <button type="button" class="btn btn-outline-secondary" id="btnDayNext">D+1</button>
                    </div>
                </div>
            </div>

            <!-- 타임테이블 -->
            <div class="table-responsive" id="tableWrapper">
                <table class="table table-bordered align-middle text-center mb-2" id="table10m">
                    <thead>
                    <tr>
                        <th style="width:80px;">시간</th>
                        <th id="thSchedule" style="width:40%;">스케줄</th>
                        <th style="width:40%;">실제</th>
                        <th style="width:140px;">1시간 단위</th>
                    </tr>
                    </thead>
                    <tbody id="tbody10m"></tbody>
                </table>
            </div>

            <!-- 하단 요약 -->
            <div>
                <div class="small text-muted mb-1">실제 선택 구간</div>
                <div id="actualSummary" class="small">-</div>
            </div>
        </div>
    </div>
</main>

<style>
    /* ===== 상단 아르바이트 리스트: 칩 스타일 ===== */
    .vlist {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .pill {
        display:flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid #e9ecef;
        background:#fff;
        cursor:pointer;
        font-size:.9rem;
        transition: background .15s, box-shadow .15s, border-color .15s;
    }
    .pill:hover {
        background:#fafafa;
        border-color:#dee2e6;
    }
    .pill.active {
        border-color: rgba(13,110,253,.45);
        box-shadow: 0 0 0 3px rgba(13,110,253,.15) inset;
        background:#f0f6ff;
    }
    .pill .dot {
        width:12px;
        height:12px;
        border-radius:50%;
        border:1px solid rgba(0,0,0,.08);
        flex:0 0 12px;
    }
    .pill .name {
        font-weight:600;
    }
    .pill .meta {
        color:#6c757d;
        font-size:.8rem;
    }

    /* ===== 타임테이블 셀 ===== */
    .slot-10m {
        height:16px;
        border:1px solid #eef2f6;
        border-radius:3px;
        background:#fff;
        cursor:pointer;
    }
    .slot-10m.schedule.on {
        background:rgba(255,159,67,.35);
        border-color:rgba(255,159,67,.65);
    }
    .slot-10m.actual.on {
        background:rgba(25,135,84,.25);
        border-color:rgba(25,135,84,.35);
    }
    .hour-select-cell .btn {width:100%;}
    .timecell {font-variant-numeric: tabular-nums;}

    #tableWrapper {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: auto;
        position: relative;
    }

    /* 테이블 헤더 sticky */
    #table10m thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #f8fafc;
    }
</style>

<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const HOUR_START = 6;
        const HOUR_END   = 22;   // exclusive
        const DOW_KO     = ['일','월','화','수','목','금','토'];

        // ===== 상단 DOM =====
        const statusSelect       = document.getElementById('statusSelect');
        const memberPills        = document.getElementById('memberPills');
        const memberCountBadge   = document.getElementById('memberCountBadge');

        // ===== 타임테이블 DOM =====
        const tbody10m           = document.getElementById('tbody10m');
        const selectedMemberTitle= document.getElementById('selectedMemberTitle');
        const currentDateLabel   = document.getElementById('currentDateLabel');

        const btnClearActual     = document.getElementById('btnClearActual');
        const btnSelectAllActual = document.getElementById('btnSelectAllActual');
        const btnSaveActual      = document.getElementById('btnSaveActual');
        const actualSummary      = document.getElementById('actualSummary');

        const btnDayPrev         = document.getElementById('btnDayPrev');
        const btnDayToday        = document.getElementById('btnDayToday');
        const btnDayNext         = document.getElementById('btnDayNext');

        const thSchedule         = document.getElementById('thSchedule');

        // 선택 단위 버튼
        const btnRes10           = document.getElementById('btnRes10');
        const btnRes30           = document.getElementById('btnRes30');
        const btnRes60           = document.getElementById('btnRes60');
        const resolutionButtons  = [btnRes10, btnRes30, btnRes60];

        // ===== 토스트 (간단버전) =====
        function showToast(message, toastType = 'primary') {
            const existing = document.getElementById('toastBox');
            if (existing) {
                try {
                    bootstrap.Alert.getOrCreateInstance(existing).close();
                } catch (e) {
                    existing.remove();
                }
            }

            const div = document.createElement('div');
            div.id = 'toastBox';
            div.className = `alert alert-${toastType} alert-dismissible fade show shadow-sm`;
            div.setAttribute('role', 'alert');
            div.style.position   = 'fixed';
            div.style.left       = '50%';
            div.style.top        = '20px';
            div.style.transform  = 'translateX(-50%)';
            div.style.minWidth   = '250px';
            div.style.maxWidth   = '90vw';
            div.style.zIndex     = '2000';
            div.style.textAlign  = 'center';

            const textNode = document.createTextNode(message + ' ');
            div.appendChild(textNode);

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close';
            btn.setAttribute('data-bs-dismiss', 'alert');
            btn.setAttribute('aria-label', 'Close');
            div.appendChild(btn);

            document.body.appendChild(div);

            try {
                const alertInstance = bootstrap.Alert.getOrCreateInstance(div);
                setTimeout(() => {
                    alertInstance.close();
                }, 3000);
            } catch (e) {
                setTimeout(() => {
                    if (div.parentNode) div.parentNode.removeChild(div);
                }, 3000);
            }
        }

        // ===== 상태 =====
        let allMembers = [];
        try {
            allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]');
        } catch(e) {
            allMembers = [];
        }

        let selectedMemberId   = null;
        let currentDate        = stripTime(new Date());
        let dragging           = false;
        let dragSelecting      = true;
        let currentResolution  = 10;   // 10 / 30 / 60 (분 단위)

        // mouseup: 드래그 종료
        window.addEventListener('mouseup', () => {
            if (dragging) {
                dragging = false;
                updateActualSummary();
            }
        });

        // 초기 상태 선택
        if (Array.isArray(allMembers) && allMembers.length > 0) {
            statusSelect.value = allMembers[0].status || 'WORKING';
        }

        refreshCurrentDateLabel();
        setDayNavActive('today');

        // ===== 이벤트 바인딩 =====
        statusSelect.addEventListener('change', handleStatusChange);

        btnDayPrev.addEventListener('click', () => {
            currentDate = addDays(currentDate, -1);
            refreshCurrentDateLabel();
            setDayNavActive('prev');
            reloadForCurrentSelection();
        });
        btnDayToday.addEventListener('click', () => {
            currentDate = stripTime(new Date());
            refreshCurrentDateLabel();
            setDayNavActive('today');
            reloadForCurrentSelection();
        });
        btnDayNext.addEventListener('click', () => {
            currentDate = addDays(currentDate, 1);
            refreshCurrentDateLabel();
            setDayNavActive('next');
            reloadForCurrentSelection();
        });

        // 단위 버튼
        resolutionButtons.forEach(btn => {
            if (!btn) return;
            btn.addEventListener('click', () => {
                const res = Number(btn.dataset.res || '10');
                setResolution(res);
            });
        });

        // 초기 렌더
        handleStatusChange();

        // ===== 상태 변경 시: 멤버 필터링 & 칩 렌더 =====
        function handleStatusChange() {
            const status = statusSelect.value;
            const filtered = (allMembers || []).filter(m => m.status === status);
            renderMembersByStatus(filtered);
        }

        function renderMembersByStatus(members) {
            memberPills.innerHTML = '';
            memberCountBadge.textContent = `${members.length}명`;

            if (!members.length) {
                memberPills.innerHTML =
                        `<span class="text-muted small">해당 상태의 아르바이트생이 없습니다.</span>`;
                resetRightPanel();
                return;
            }

            let toSelect = null;
            if (selectedMemberId &&
                    members.some(m => String(m.id) === String(selectedMemberId))) {
                toSelect = members.find(m => String(m.id) === String(selectedMemberId));
            } else {
                toSelect = members[0];
            }

            members
                    .slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'pill';
                        btn.dataset.memberId = String(m.id);

                        const color = colorForMember(m);
                        btn.innerHTML = `
                        <span class="dot" style="background:${color}"></span>
                        <span class="name">${escapeHtml(m.name ?? '-')}</span>
                        <span class="meta">${escapeHtml(m.phone ?? '')}</span>
                    `;

                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            pickMember(m);
                        });

                        memberPills.appendChild(btn);
                    });

            pickMember(toSelect);
        }

        function pickMember(m) {
            if (!m) return;
            selectedMemberId = m.id;

            // 칩 active
            Array.from(memberPills.querySelectorAll('.pill')).forEach(el => {
                el.classList.toggle('active', el.dataset.memberId === String(selectedMemberId));
            });

            selectedMemberTitle.textContent = `${m.name} — 일간 타임테이블`;

            buildTimeTable();     // 현재 해상도 기준으로 테이블 구성
            loadDayForMember(m);  // 스케줄/실제 데이터 로딩

            btnClearActual.disabled     = false;
            btnSelectAllActual.disabled = false;
            btnSaveActual.disabled      = false;

            btnClearActual.onclick = () => {
                tbody10m.querySelectorAll('.slot-10m.actual.on')
                        .forEach(el => el.classList.remove('on'));
                updateActualSummary();
            };

            btnSelectAllActual.onclick = () => {
                const actualSlots   = Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
                const scheduleSlots = Array.from(tbody10m.querySelectorAll('.slot-10m.schedule'));
                for (let i=0;i<actualSlots.length;i++) {
                    if (scheduleSlots[i].classList.contains('on')) {
                        actualSlots[i].classList.add('on');
                    } else {
                        actualSlots[i].classList.remove('on');
                    }
                }
                updateActualSummary();
            };

            btnSaveActual.onclick = saveActual;
        }

        function reloadForCurrentSelection() {
            buildTimeTable();
            if (!selectedMemberId) return;
            const m = (allMembers || []).find(x => String(x.id) === String(selectedMemberId));
            if (!m) return;
            selectedMemberTitle.textContent = `${m.name} — 일간 타임테이블`;
            loadDayForMember(m);
        }

        // ===== 해상도 변경 (10 / 30 / 60) =====
        function setResolution(res) {
            if (![10,30,60].includes(res)) res = 10;
            if (currentResolution === res) return;

            currentResolution = res;

            // 버튼 스타일 변경
            resolutionButtons.forEach(btn => {
                if (!btn) return;
                const bRes = Number(btn.dataset.res || '10');
                if (bRes === currentResolution) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                }
            });

            // 테이블 재구성 + 데이터 다시 반영
            reloadForCurrentSelection();
        }

        // ===== 스케줄/실제 로딩 =====
        function loadDayForMember(member) {
            const date = fmtDateYYYYMMDD(currentDate);

            fetch(`/api/schedule/work/${member.id}/${date}`)
                    .then(res => res && res.ok ? res.json() : null)
                    .then(data => {
                        const segs = (data && Array.isArray(data.segments)) ? data.segments : [];
                        applySegmentsToSlots('.slot-10m.schedule', segs);
                        return fetch(`/api/schedule/${member.id}/${date}`);
                    })
                    .then(res => res && res.ok ? res.json() : null)
                    .then(data => {
                        if (data && Array.isArray(data.segments) && data.segments.length) {
                            applySegmentsToSlots('.slot-10m.actual', data.segments);
                        }
                    })
                    .catch(console.error);
        }

        // ===== 현재 해상도 기준 테이블 빌드 =====
        function buildTimeTable() {
            tbody10m.innerHTML = '';

            if (thSchedule) {
                thSchedule.textContent = '스케줄';
                thSchedule.classList.remove('text-danger');
            }

            const step = currentResolution;
            const slotsPerHour = 60 / step; // 10분=6, 30분=2, 60분=1

            let globalIndex = 0;

            for (let h = HOUR_START; h < HOUR_END; h++) {
                for (let m = 0; m < 60; m += step) {
                    const hm = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td class="timecell">${hm}</td>
                        <td><div class="slot-10m schedule" data-index="${globalIndex}"></div></td>
                        <td><div class="slot-10m actual" data-index="${globalIndex}"></div></td>
                    `;

                    // 1시간 단위 버튼: 해당 시간의 첫 행에만
                    if (m === 0) {
                        const td = document.createElement('td');
                        td.className = 'hour-select-cell';
                        td.rowSpan   = slotsPerHour;
                        td.innerHTML = `
                            <button class="btn btn-outline-dark btn-sm hour-toggle"
                                    data-hour="${h}">
                                ${String(h).padStart(2,'0')}:00 선택
                            </button>
                        `;
                        tr.appendChild(td);
                    }

                    tbody10m.appendChild(tr);
                    globalIndex++;
                }
            }

            // 실제 영역 마우스 이벤트
            const actualSlots = Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
            actualSlots.forEach(div => {
                div.addEventListener('mousedown', e => {
                    e.preventDefault();
                    dragging = true;
                    const isOn = div.classList.contains('on');
                    dragSelecting = !isOn;
                    toggleActual(div, dragSelecting);
                });
                div.addEventListener('mouseenter', () => {
                    if (dragging) {
                        toggleActual(div, dragSelecting);
                    }
                });
            });

            // 1시간 단위 선택 버튼
            tbody10m.querySelectorAll('.hour-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const hour = parseInt(btn.dataset.hour, 10);
                    const startIndex = (hour - HOUR_START) * slotsPerHour;
                    const endIndex   = startIndex + slotsPerHour;

                    let allOn = true;
                    for (let i=startIndex; i<endIndex; i++) {
                        if (!actualSlots[i].classList.contains('on')) {
                            allOn = false;
                            break;
                        }
                    }
                    for (let i=startIndex; i<endIndex; i++) {
                        const el = actualSlots[i];
                        if (!el) continue;
                        if (allOn) el.classList.remove('on');
                        else       el.classList.add('on');
                    }
                    updateActualSummary();
                });
            });

            updateActualSummary();
        }

        // ===== segments -> 슬롯 표시(스케줄/실제 공용) =====
        function applySegmentsToSlots(selector, segments) {
            const slots = Array.from(tbody10m.querySelectorAll(selector));

            if (!Array.isArray(segments) || segments.length === 0) {
                if (selector === '.slot-10m.schedule' && thSchedule) {
                    thSchedule.textContent = '(계획된 일정 없음)';
                    thSchedule.classList.add('text-danger');
                }
                scrollToTopOfTable();
                return;
            }

            if (selector === '.slot-10m.schedule' && thSchedule) {
                thSchedule.textContent = '스케줄';
                thSchedule.classList.remove('text-danger');
            }

            const step = currentResolution;
            const dayStartMin = HOUR_START * 60;

            let firstStartMin = Infinity;

            // 먼저 segments의 가장 이른 시작시간 찾기
            segments.forEach(seg => {
                const s = hmToMin(seg.start);
                if (s < firstStartMin) firstStartMin = s;
            });

            // 각 슬롯에 segments 겹치는지 체크
            slots.forEach((slotEl, idx) => {
                const slotStart = dayStartMin + idx * step;
                const slotEnd   = slotStart + step;

                const on = segments.some(seg => {
                    const s = hmToMin(seg.start);
                    const e = hmToMin(seg.end);
                    return e > slotStart && s < slotEnd;   // 겹치면 true
                });

                if (on) slotEl.classList.add('on');
            });

            // 스케줄이면 첫 시작 근처로 스크롤
            if (selector === '.slot-10m.schedule' && firstStartMin !== Infinity) {
                scrollToSchedule(firstStartMin);
            }
        }

        // ===== 스크롤 유틸 =====
        function scrollToSchedule(firstStartMin) {
            const step        = currentResolution;
            const dayStartMin = HOUR_START * 60;
            const idxRaw      = (firstStartMin - dayStartMin) / step;
            const idx         = Math.max(0, Math.floor(idxRaw));
            const target      = tbody10m.querySelector(`.slot-10m.schedule[data-index="${idx}"]`);
            if (!target) return;

            target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        function scrollToTopOfTable() {
            const firstRow = tbody10m.querySelector('tr');
            if (!firstRow) return;
            firstRow.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // ===== 실제 저장 =====
        function saveActual() {
            if (!selectedMemberId) {
                alert('알바생을 선택하세요.');
                return;
            }
            const ranges = getSelectedRanges();
            const payload = {
                memberId: selectedMemberId,
                date: fmtDateYYYYMMDD(currentDate),
                segments: ranges
            };
            if (!confirm('실제 근무한 구간을 저장하시겠습니까?')) return;

            fetch('/api/schedule/save', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            })
                    .then(r => r.json())
                    .then(result => {
                        if (result.success) {
                            showToast('✅ 저장되었습니다.', 'success');
                        } else {
                            showToast('⚠️ 실패: ' + (result.message || '오류가 발생했습니다.'), 'danger');
                        }
                    })
                    .catch(() => {
                        showToast('❌ 저장 중 오류가 발생했습니다.', 'danger');
                    });
        }

        // ===== 오른쪽 초기화 =====
        function resetRightPanel() {
            selectedMemberId = null;
            selectedMemberTitle.textContent = '선택된 알바생 없음';
            tbody10m.innerHTML = '';
            btnClearActual.disabled     = true;
            btnSelectAllActual.disabled = true;
            btnSaveActual.disabled      = true;
            actualSummary.textContent   = '-';

            if (thSchedule) {
                thSchedule.textContent = '스케줄';
                thSchedule.classList.remove('text-danger');
            }

            Array.from(memberPills.querySelectorAll('.pill')).forEach(el => {
                el.classList.remove('active');
            });
        }

        // ===== 날짜 네비 하이라이트 =====
        function setDayNavActive(which) {
            const all = [btnDayPrev, btnDayToday, btnDayNext];
            all.forEach(btn => {
                btn.classList.remove('btn-primary','active','text-white');
                btn.classList.add('btn-outline-secondary');
            });
            let target = null;
            if (which === 'prev') target = btnDayPrev;
            else if (which === 'today') target = btnDayToday;
            else if (which === 'next') target = btnDayNext;

            if (target) {
                target.classList.remove('btn-outline-secondary');
                target.classList.add('btn-primary','active','text-white');
            }
        }

        // ===== 공통 유틸 =====
        function toggleActual(div, on) {
            if (on) div.classList.add('on');
            else    div.classList.remove('on');
        }

        function hmToMin(hm) {
            const [a,b] = hm.split(':').map(Number);
            return a*60 + b;
        }

        function indexToHM(i) {
            const step = currentResolution;
            const t = (HOUR_START*60) + i*step;
            const h = Math.floor(t/60);
            const m = t % 60;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        function getSelectedRanges() {
            const step  = currentResolution;
            const slots = Array.from(tbody10m.querySelectorAll('.slot-10m.actual'));
            const idx   = slots.map((d,i)=>d.classList.contains('on')?i:null).filter(i=>i!=null);
            if (!idx.length) return [];

            const ranges = [];
            let a = idx[0];
            let p = idx[0];
            for (let i=1;i<idx.length;i++) {
                if (idx[i] === p+1) {
                    p = idx[i];
                } else {
                    ranges.push([a,p]);
                    a = idx[i];
                    p = idx[i];
                }
            }
            ranges.push([a,p]);

            return ranges.map(([s,e]) => ({
                start: indexToHM(s),
                end  : addMinutes(indexToHM(e), step)
            }));
        }

        function addMinutes(hm, mins) {
            const [h,m] = hm.split(':').map(Number);
            const t  = h*60 + m + mins;
            const hh = Math.floor(t/60);
            const mm = t % 60;
            return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
        }

        function updateActualSummary() {
            const s = getSelectedRanges();
            actualSummary.textContent = s.length
                    ? s.map(r => `${r.start}~${r.end}`).join(', ')
                    : '-';
        }

        function fmtDateYYYYMMDD(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function fmtDateDisplay(d) {
            const iso = fmtDateYYYYMMDD(d);
            const dow = DOW_KO[d.getDay()];
            return `${iso} (${dow})`;
        }
        function stripTime(d) {
            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }
        function addDays(d, n) {
            const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            x.setDate(x.getDate() + n);
            return x;
        }
        function refreshCurrentDateLabel() {
            currentDateLabel.textContent = fmtDateDisplay(currentDate);
        }

        function colorForMember(m) {
            const key = (m.id != null ? String(m.id) : (m.name || 'x'));
            const h = seededHash(key) % 360, s = 65, l = 55;
            return hslToHex(h,s,l);
        }
        function seededHash(str) {
            let h = 2166136261 >>> 0;
            for (let i=0;i<str.length;i++) {
                h ^= str.charCodeAt(i);
                h  = (h * 16777619) >>> 0;
            }
            return h >>> 0;
        }
        function hslToHex(h,s,l) {
            s/=100; l/=100;
            const k = n => (n + h/30) % 12;
            const a = s * Math.min(l, 1-l);
            const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

    })();
</script>

{{>layouts/footer}}
