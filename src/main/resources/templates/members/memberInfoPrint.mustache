{{>layouts/header_}}

<main class="print-shell">
    <div class="print-container">

        <!-- ìƒë‹¨: ì œëª© + ê¸°ì¤€ ì£¼ ì •ë³´ -->
        <header class="print-header">
            <div>
                <div class="title-sm">STAFF PROFILE</div>
                <h1 class="title-lg">ì•„ë¥´ë°”ì´íŠ¸ ì¸ì‚¬ ì •ë³´</h1>
            </div>
            <div class="text-right">
                <div class="label-sm">ê¸°ì¤€ ì£¼</div>
                <div class="week-label">{{weekRangeLabel}}</div>
            </div>
        </header>

        <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
        <section class="card card-main">
            <div class="card-header card-header-main">
                <div class="left">
                    <div class="title-sm">BASIC INFO</div>
                    <h2 class="title-md">{{member.name}}</h2>
                    <div class="sub">
                        ë“±ë¡ì¼:
                        {{#member.createdAt}}{{member.createdAt}}{{/member.createdAt}}
                        {{^member.createdAt}}-{{/member.createdAt}}
                    </div>
                </div>
                <div class="right">
                    <!-- ğŸ”¸ ìƒíƒœ ì¶œë ¥ -->
                    <div class="pill-name">
                        {{member.status}}
                    </div>
                </div>
            </div>

            <div class="card-body">

                <!-- 1. ì¸ì  ì •ë³´ -->
                <h3 class="section-title">1. ì¸ì  ì •ë³´</h3>
                <table class="info-table">
                    <tbody>
                    <tr>
                        <th>ì´ë¦„</th>
                        <td>{{member.name}}</td>
                        <th>ì„±ë³„</th>
                        <td>{{member.gender}}</td>
                    </tr>
                    <tr>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <td>{{member.phone}}</td>
                        <th>ì´ë©”ì¼</th>
                        <td>{{member.email}}</td>
                    </tr>
                    <tr>
                        <th>ê·¼ë¬´ ì‹œì‘ì¼</th>
                        <td>{{member.startDate}}</td>
                        <th>ìƒíƒœ</th>
                        <td>{{member.status}}</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 2. ê¸‰ì—¬/ê³„ì¢Œ ì •ë³´ -->
                <h3 class="section-title">2. ê¸‰ì—¬ ë° ê³„ì¢Œ ì •ë³´</h3>
                <table class="info-table">
                    <tbody>
                    <tr>
                        <th>ì‹œê¸‰</th>
                        <td>
                            {{member.hourlyWage}}
                            <span class="unit">ì›</span>
                        </td>
                        <th>ê¸‰ì—¬ì§€ê¸‰ì¼</th>
                        <td>{{member.payday}}</td>
                    </tr>
                    <tr>
                        <th>ì£¼íœ´ìˆ˜ë‹¹ ì ìš©</th>
                        <td>
                            {{#member.includeWeeklyHolidayAllowance}}ì˜ˆ{{/member.includeWeeklyHolidayAllowance}}
                            {{^member.includeWeeklyHolidayAllowance}}ì•„ë‹ˆì˜¤{{/member.includeWeeklyHolidayAllowance}}
                        </td>
                        <th>ì„¸ê¸ˆ ì ìš©</th>
                        <td>
                            {{#member.applyTax}}ì˜ˆ (ì†Œë“ì„¸ ê³µì œ ì ìš©){{/member.applyTax}}
                            {{^member.applyTax}}ì•„ë‹ˆì˜¤{{/member.applyTax}}
                        </td>
                    </tr>
                    <tr>
                        <th>ì€í–‰</th>
                        <td>{{member.bankName}}</td>
                        <th>ê³„ì¢Œë²ˆí˜¸</th>
                        <td>{{member.bankAccount}}</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 3. ë³´ê±´ì¦ ì •ë³´ -->
                <h3 class="section-title">3. ë³´ê±´ì¦ ì •ë³´</h3>
                <table class="info-table">
                    <tbody>
                    <tr>
                        <th>ë³´ê±´ì¦ ë³´ìœ  ì—¬ë¶€</th>
                        <td>
                            {{#member.hasHealthCertificate}}ì˜ˆ{{/member.hasHealthCertificate}}
                            {{^member.hasHealthCertificate}}ì•„ë‹ˆì˜¤{{/member.hasHealthCertificate}}
                        </td>
                        <th>ë³´ê±´ì¦ ìœ íš¨ê¸°ê°„</th>
                        <td>{{member.healthCertExpiryStr}}</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 4. ë©”ëª¨ -->
                <h3 class="section-title">4. ë©”ëª¨</h3>
                <div class="memo-box">{{#member.memo}}{{member.memo}}{{/member.memo}}{{^member.memo}}-{{/member.memo}}</div>
            </div>
        </section>

        <!-- ì£¼ê°„ í…œí”Œë¦¿ (ê³„íš) -->
        <section class="card card-schedule">
            <div class="card-header card-header-schedule">
                <div class="left">
                    <div class="title-sm">SCHEDULE TEMPLATE</div>
                    <h2 class="title-md">{{member.name}} â€” ì£¼ê°„ ê·¼ë¬´ í…œí”Œë¦¿ (ì›”~ì¼)</h2>
                </div>

                <!-- ğŸ”¹ ìš°ì¸¡: 10/30/1ì‹œê°„ ë¶„í•  ë²„íŠ¼ (ë¼ìš´ë“œë ‰íŠ¸, 1ì‹œê°„ ê¸°ë³¸ ì„ íƒ) -->
                <div class="right">
                    <div class="slot-btn-pill" id="gridSlotButtons">
                        <button type="button" class="slot-btn" data-grid-slot="10">10ë¶„</button>
                        <button type="button" class="slot-btn" data-grid-slot="30">30ë¶„</button>
                        <button type="button" class="slot-btn active" data-grid-slot="60">1ì‹œê°„</button>
                    </div>
                </div>
            </div>

            <div class="card-body">

                <div class="legend-row">
                    <span class="legend-box legend-plan"></span>
                    <span class="legend-label">ì„ íƒëœ ê·¼ë¬´ ì‹œê°„ (ê³„íš)</span>
                </div>

                <div class="schedule-board">
                    <div class="table-responsive">
                        <table class="schedule-table">
                            <thead>
                            <tr id="theadWeek">
                                <th class="time-col">ì‹œê°„</th>
                                <th>ì›”</th>
                                <th>í™”</th>
                                <th>ìˆ˜</th>
                                <th>ëª©</th>
                                <th>ê¸ˆ</th>
                                <th>í† </th>
                                <th>ì¼</th>
                            </tr>
                            </thead>
                            <tbody id="tbodyWeekPrint"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </section>

        <footer class="print-footer">
            <span class="footer-left">
                ì¶œë ¥ì¼: <span id="printDate"></span>
            </span>
            <span class="footer-right">
                Staff ID: {{member.id}}
            </span>
        </footer>

        <!-- ğŸ”¹ í•˜ë‹¨ PDF ì¶œë ¥ ë²„íŠ¼ (í™”ë©´ì—ë§Œ ë³´ì´ê³ , ì¸ì‡„/PDFì—ëŠ” ë‚˜ì˜¤ì§€ ì•Šê²Œ) -->
        <div class="print-actions">
            <button type="button" id="btnPrintPdf" class="btn-print">
                PDFë¡œ ì¶œë ¥
            </button>
        </div>

    </div>
</main>

<style>
    :root {
        --border-color: #e5e7eb;
        --text-muted: #6b7280;
        --text-main: #111827;
        --primary: #2563eb;
        --bg-soft: #f9fafb;
    }

    html, body {
        margin: 0;
        padding: 0;
        background: #ffffff;
        color: var(--text-main);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        font-size: 13px;
    }

    @page {
        size: A4;
        margin: 15mm;
    }

    .print-shell {
        padding: 0;
    }

    .print-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .print-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }

    .title-sm {
        font-size: 10px;
        letter-spacing: .16em;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
    }

    .title-lg {
        font-size: 20px;
        margin: 2px 0 0;
        font-weight: 700;
        color: var(--text-main);
    }

    .title-md {
        font-size: 15px;
        margin: 0;
        font-weight: 600;
        color: var(--text-main);
    }

    .text-right {
        text-align: right;
    }

    .label-sm {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 2px;
    }

    .week-label {
        font-size: 13px;
        font-weight: 600;
    }

    .card {
        border: 1px solid var(--border-color);
        border-radius: 18px;
        margin-bottom: 12px;
        page-break-inside: avoid;
    }

    .card-header {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f3f4f6; /* ê¸°ë³¸ê°’, ì•„ë˜ì—ì„œ ì¹´ë“œë³„ë¡œ override */
    }

    /* ğŸ”¸ BASIC INFO ì˜¤ë Œì§€ í—¤ë” */
    .card-main .card-header-main {
        background: #fb923c;
        color: #fff;
    }
    .card-main .card-header-main .title-sm,
    .card-main .card-header-main .title-md,
    .card-main .card-header-main .sub {
        color: #fefce8;
    }

    /* BASIC INFO (ì£¼í™©) ìƒë‹¨ ë¼ìš´ë“œ */
    .card-main {
        border-radius: 12px;
        overflow: hidden;
    }
    .card-main .card-header-main {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }

    /* SCHEDULE TEMPLATE (íŒŒë‘) ìƒë‹¨ ë¼ìš´ë“œ */
    .card-schedule {
        border-radius: 12px;
        overflow: hidden;
    }
    .card-schedule .card-header-schedule {
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }

    .card-header .left .sub {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 3px;
    }

    .card-main .card-header-main .left .sub {
        color: #fefce8;
    }

    .card-header .right {
        text-align: right;
    }

    .pill-name {
        display: inline-flex;
        align-items: center;
        padding: 3px 10px;
        border-radius: 999px;
        background: #111827;
        color: #f9fafb;
        font-size: 11px;
        font-weight: 500;
    }

    .card-body {
        padding: 10px 10px 12px;
    }

    .section-title {
        font-size: 13px;
        font-weight: 600;
        margin: 10px 0 6px;
        border-left: 3px solid var(--primary);
        padding-left: 6px;
    }

    .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 8px;
        table-layout: fixed;
    }

    .info-table th,
    .info-table td {
        border: 1px solid var(--border-color);
        padding: 4px 6px;
        font-size: 12px;
        vertical-align: middle;
    }

    .info-table th {
        width: 18%;
        background: #f3f4f6;
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
    }

    .info-table td {
        width: 32%;
    }

    .unit {
        color: var(--text-muted);
        font-size: 11px;
        margin-left: 2px;
    }

    .memo-box {
        max-height: 40px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 4px 8px;
        background: #f9fafb;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* ğŸ”µ SCHEDULE TEMPLATE í—¤ë” íŒŒë€ìƒ‰ */
    .card-schedule .card-header-schedule {
        background: #2563eb;
        color: #e5eeff;
    }
    .card-schedule .card-header-schedule .title-sm {
        color: #dbeafe;
    }
    .card-schedule .card-header-schedule .title-md {
        color: #f9fafb;
    }

    /* ìŠ¬ë¡¯ ë²„íŠ¼ pill */
    .slot-btn-pill {
        display: inline-flex;
        align-items: center;
        padding: 2px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.18);
        gap: 2px;
    }

    .slot-btn {
        border: none;
        outline: none;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        cursor: pointer;
        background: transparent;
        color: #e5edff;
        font-weight: 500;
        line-height: 1.4;
        white-space: nowrap;
    }

    .slot-btn.active {
        background: #ffffff;
        color: #1e293b;
    }

    /* ìŠ¤ì¼€ì¤„ ì˜ì—­ */
    .legend-row {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
        font-size: 11px;
        color: var(--text-muted);
    }

    .legend-box {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        border: 1px solid #22c55e;
    }

    .legend-plan {
        background: rgba(34, 197, 94, 0.35);
    }

    .legend-label {
        font-size: 11px;
    }

    .schedule-board {
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: #ffffff;
        overflow: hidden;
    }

    .schedule-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 11px;
    }

    .schedule-table thead th {
        background: #e5edff;
        color: #1e293b;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        padding: 4px 3px;
        text-align: center;
    }

    .schedule-table th,
    .schedule-table td {
        border: 1px solid #e5e7eb;
        padding: 1px 2px;
        vertical-align: middle;
    }

    .schedule-table .time-col {
        background: #f3f4f6;
        font-weight: 600;
        width: 55px;
        font-variant-numeric: tabular-nums;
    }

    .cell {
        height: 12px;
        border-radius: 3px;
    }

    .cell.schedule-on {
        background: rgba(34, 197, 94, 0.35);
    }

    .print-footer {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px solid var(--border-color);
        font-size: 10px;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
    }

    /* í•˜ë‹¨ PDF ì¶œë ¥ ë²„íŠ¼ ì˜ì—­ */
    .print-actions {
        margin-top: 10px;
        text-align: right;
    }

    .btn-print {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #111827;
        color: #f9fafb;
        cursor: pointer;
    }

    .btn-print:hover {
        background: #020617;
    }

    @media print {
        body {
            background: #ffffff;
        }
        .print-container {
            margin: 0;
        }
        .print-actions {
            display: none;  /* ğŸ”¹ PDF/í”„ë¦°íŠ¸ì—ëŠ” ë²„íŠ¼ ì•ˆ ë‚˜ì˜¤ë„ë¡ */
        }
    }
</style>

<!-- memberJson: JSì—ì„œ ìŠ¤ì¼€ì¤„ ë Œë”ë§ìš© -->
<script id="memberData" type="application/json">
{{{memberJson}}}
</script>

<script>
    (function () {
        const HOUR_START = 6;
        const HOUR_END   = 22;
        const DAY_CODES  = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
        const DOW_LABELS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

        const tbodyWeek       = document.getElementById('tbodyWeekPrint');
        const theadWeek       = document.getElementById('theadWeek');
        const gridSlotButtons = document.getElementById('gridSlotButtons');
        const btnPrintPdf     = document.getElementById('btnPrintPdf');
        const printDateEl     = document.getElementById('printDate');

        // ê¸°ë³¸ ë¶„í•  ë‹¨ìœ„: 1ì‹œê°„ (60ë¶„)
        let gridStep = 60;

        // í—¤ë” ìš”ì¼ ë Œë”ë§
        if (theadWeek) {
            const ths = theadWeek.querySelectorAll('th');
            for (let i = 0; i < 7; i++) {
                const th = ths[i + 1];
                if (!th) continue;
                th.textContent = DOW_LABELS[i];
            }
        }

        let member = {};
        try {
            member = JSON.parse(document.getElementById('memberData').textContent || '{}');
        } catch (e) {
            member = {};
        }

        const scheduleMapByDay = buildScheduleMapFromMember(member);

        buildWeekGrid();
        paintScheduleFromMap(scheduleMapByDay);
        attachSlotButtons();
        initPrintButton();
        fillPrintDate();

        function buildScheduleMapFromMember(m) {
            const map = {};
            DAY_CODES.forEach(dc => map[dc] = []);

            if (!m || !Array.isArray(m.schedule)) return map;

            m.schedule.forEach(row => {
                if (!row) return;
                const dayCode = String(row.day || '').toUpperCase();
                if (!DAY_CODES.includes(dayCode)) return;

                const startRaw = row.start != null ? String(row.start) : '';
                const endRaw   = row.end   != null ? String(row.end)   : '';

                const startHm = startRaw.slice(0,5);
                const endHm   = endRaw.slice(0,5);

                if (!startHm || !endHm) return;

                map[dayCode].push({ start: startHm, end: endHm });
            });

            return map;
        }

        function buildWeekGrid() {
            if (!tbodyWeek) return;
            tbodyWeek.innerHTML = '';

            const totalMinutes = (HOUR_END - HOUR_START) * 60;
            const totalRows    = totalMinutes / gridStep;

            for (let idx = 0; idx < totalRows; idx++) {
                const absMin = HOUR_START * 60 + idx * gridStep;
                const h = Math.floor(absMin / 60);
                const m = absMin % 60;
                const hm = pad2(h) + ':' + pad2(m);

                const tr = document.createElement('tr');

                let html = `<th class="time-col">${hm}</th>`;
                for (let col = 0; col < 7; col++) {
                    html += `<td data-row="${idx}" data-day-index="${col}">
                                <div class="cell"></div>
                             </td>`;
                }
                tr.innerHTML = html;
                tbodyWeek.appendChild(tr);
            }
        }

        function paintScheduleFromMap(map) {
            if (!tbodyWeek) return;
            const rows = Array.from(tbodyWeek.querySelectorAll('tr'));

            for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                const dayCode = DAY_CODES[dayIdx];
                const segs = map[dayCode] || [];
                if (!segs.length) continue;

                rows.forEach((tr, rIdx) => {
                    const cellTd = tr.querySelector(`td[data-day-index="${dayIdx}"]`);
                    if (!cellTd) return;
                    const cellDiv = cellTd.querySelector('.cell');
                    if (!cellDiv) return;

                    const interval = rowToInterval(rIdx);
                    const startMin = interval.startMin;
                    const endMin   = interval.endMin;

                    const overlaps = segs.some(seg => {
                        const ss = hmToMin(seg.start);
                        const ee = hmToMin(seg.end);
                        return !(ee <= startMin || ss >= endMin);
                    });

                    if (overlaps) {
                        cellDiv.classList.add('schedule-on');
                    }
                });
            }
        }

        function attachSlotButtons() {
            if (!gridSlotButtons) return;

            gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mins = parseInt(btn.dataset.gridSlot, 10);
                    if (!mins || mins === gridStep) return;

                    gridStep = mins;

                    // active ìƒíƒœ ë³€ê²½
                    gridSlotButtons.querySelectorAll('button[data-grid-slot]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // ê·¸ë¦¬ë“œ ì¬ìƒì„± + ìŠ¤ì¼€ì¤„ ë‹¤ì‹œ ì¹ í•˜ê¸°
                    buildWeekGrid();
                    paintScheduleFromMap(scheduleMapByDay);
                });
            });
        }

        function initPrintButton() {
            if (!btnPrintPdf) return;
            btnPrintPdf.addEventListener('click', function () {
                window.print();
            });
        }

        function fillPrintDate() {
            if (!printDateEl) return;
            const now = new Date();
            const y = now.getFullYear();
            const mo = pad2(now.getMonth() + 1);
            const d = pad2(now.getDate());
            const hh = pad2(now.getHours());
            const mm = pad2(now.getMinutes());
            printDateEl.textContent = y + '-' + mo + '-' + d + ' ' + hh + ':' + mm;
        }

        function rowToInterval(rowIdx) {
            const startMin = HOUR_START * 60 + rowIdx * gridStep;
            const endMin   = startMin + gridStep;
            return { startMin, endMin };
        }

        function hmToMin(hm) {
            const parts = String(hm).split(':');
            const h = parseInt(parts[0] || '0', 10);
            const m = parseInt(parts[1] || '0', 10);
            return h * 60 + m;
        }

        function pad2(n) {
            return String(n).padStart(2, '0');
        }
    })();
</script>

{{>layouts/footer}}
