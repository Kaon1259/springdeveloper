{{>layouts/header_}}

<main class="container my-4">

    <!-- ============ 상단: 출력용 헤더 (상태/이름 고정) ============ -->
    <div class="card mb-3 state-card-blue">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">아르바이트 주차별 급여 내역 (출력용)</span>
            <span class="small">
                상태:
                <strong>{{statusLabel}}</strong>
            </span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- 상태 표시(고정) -->
                <div class="col-12 col-md-4">
                    <div class="form-label small text-muted">상태</div>
                    <div class="fs-5 fw-bold">
                        {{statusLabel}}
                    </div>
                    <div class="form-text">
                        이 페이지는 선택한 상태와 멤버를 고정한 출력용 화면입니다.
                    </div>
                </div>

                <!-- 아르바이트 리스트 (고정 칩 UI) -->
                <div class="col-12 col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">아르바이트 목록</div>
                        <span id="memberCountBadge" class="badge bg-light text-dark">0명</span>
                    </div>
                    <div id="memberPills" class="vlist"><!-- JS 렌더 --></div>
                    <div class="small text-muted mt-2">
                        * 각 사람 옆의 색상은 근로자의 고유 색입니다. (출력용, 선택 불가)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ 상단: 제목 + 월 범위 (출력용) ============ -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
        <div class="h5 mb-0 fw-bold">주차별 급여 테이블 (실근무 기준)</div>
        <div class="d-flex align-items-center small text-muted gap-2">
            <span id="monthRangeLabel">0000.00.01 ~ 00.00</span>
        </div>
    </div>

    <!-- ============ 하단: 주차별 급여 테이블 ============ -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center" id="weeklyPayTable">
                    <thead class="weekly-table-header">
                    <tr>
                        <th style="width:120px;">주차</th>
                        <th style="width:160px;">근무자명</th>
                        <th style="width:140px;" class="text-end">근무시간</th>
                        <th style="width:120px;" class="text-end">시급</th>
                        <th style="width:130px;">주휴수당부가</th>
                        <th style="width:130px;">세금부가</th>
                        <th style="width:140px;" class="text-end">근무수당</th>
                        <th style="width:140px;" class="text-end">주휴수당</th>
                        <th style="width:140px;" class="text-end">세금(3.3%)</th>
                        <th style="width:140px;" class="text-end">실수령액</th>
                        <th style="width:120px;">지급일</th>
                    </tr>
                    </thead>
                    <tbody id="weeklyPayBody">
                    <!-- JS 렌더 -->
                    </tbody>
                    <tfoot>
                    <tr class="table-secondary fw-bold">
                        <td colspan="6" class="text-end">월 합계</td>
                        <td class="text-end" id="monthWorkPaySum">-</td>
                        <td class="text-end" id="monthJuhyuPaySum">-</td>
                        <td class="text-end" id="monthTaxSum">-</td>
                        <td class="text-end" id="monthNetSum">-</td>
                        <td></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
            <div class="small text-muted">
                * 주휴수당은 멤버 설정이 “적용”이고 해당 주 실근무가 15시간 이상일 때만 계산됩니다.<br>
                * 근무시간 표기는 “H시간 M분”. 금액은 KRW 통화 형식으로 출력합니다.<br>
                * 세금(3.3%)은 근무수당+주휴수당에 일괄 적용되며, 실수령액 = (근무수당+주휴수당) - 세금 입니다.
            </div>
        </div>
    </div>

    <!-- ============ 하단: PDF 출력 버튼 ============ -->
    <div class="mt-4 text-end no-print">
        <button type="button" class="btn btn-primary" onclick="window.print()">
            PDF 출력
        </button>
    </div>
</main>

<style>
    /* ✅ 원본과 동일 스타일 복사 */

    .state-card-blue{
        border-radius:1rem;
        overflow:hidden;
        background:#0d6efd;
        color:#fff;
        border:none;
    }
    .state-card-blue .card-header{
        background:rgba(255,255,255,0.08);
        border-bottom:1px solid rgba(255,255,255,0.25);
    }
    .state-card-blue .card-body{
        background:transparent;
    }
    .state-card-blue .form-label,
    .state-card-blue .form-text,
    .state-card-blue .text-muted{
        color:rgba(255,255,255,0.85) !important;
    }

    .text-money{color:#0d6efd;font-weight:600}
    .text-time{color:#198754;font-weight:600}
    .small-muted{color:#6c757d;font-size:.85rem}
    .week-label{white-space:nowrap}

    .vlist{display:flex;flex-wrap:wrap;gap:8px}
    .pill{
        display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #e9ecef;background:#fff;font-size:.9rem;
        /* ✅ 여기 추가: 칩 텍스트는 항상 검정색 */
        color:#212529;
        }
    .pill .dot{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,.08);flex:0 0 12px}

    /* ✅ 이름은 좀 더 강조 */
    .pill .name{
        color:#212529;
        font-weight:600;
    }

    .weekly-table-header th{
        background:#0d6efd !important;
        color:#fff !important;
        border-color:#0b5ed7 !important;
        vertical-align:middle;
    }
    .weekly-table-header th:first-child{
        border-top-left-radius:0.75rem;
    }
    .weekly-table-header th:last-child{
        border-top-right-radius:0.75rem;
    }
    #weeklyPayTable{
        border-collapse:separate;
        border-spacing:0;
        border-radius:0.75rem;
        overflow:hidden;
    }

    /* ✅ 주차별 가로 구분선: 주 마지막 행 하단 보더 두껍게 */
    #weeklyPayTable tbody tr.week-end-border td{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }

    /* ✅ 주차 컬럼(td, rowspan 적용된 셀)에도 동일하게 굵은 하단선 */
    #weeklyPayTable tbody td.week-label-border{
        border-bottom-width:3px;
        border-bottom-color:#0d6efd;
    }

    /* 출력 시 버튼/불필요 요소 숨기기 */
    @media print {
        .no-print { display:none !important; }
    }
</style>

<!-- 서버에서 내려준 멤버 JSON (이미 상태별로 필터된 상태라고 가정) -->
<script id="membersData" type="application/json">
{{{membersJson}}}
</script>

<script>
    (function(){
        const API_BASE_ACTUAL = '/api/schedule'; // GET /{memberId}/{startIso}/{endIso}

        const memberPills      = document.getElementById('memberPills');
        const memberCountBadge = document.getElementById('memberCountBadge');

        const monthRangeLabel  = document.getElementById('monthRangeLabel');

        const weeklyPayBody        = document.getElementById('weeklyPayBody');
        const monthWorkPaySumEl    = document.getElementById('monthWorkPaySum');
        const monthJuhyuPaySumEl   = document.getElementById('monthJuhyuPaySum');
        const monthTaxSumEl        = document.getElementById('monthTaxSum');
        const monthNetSumEl        = document.getElementById('monthNetSum');

        let allMembers = [];
        try { allMembers = JSON.parse(document.getElementById('membersData').textContent || '[]'); }
        catch(e){ allMembers = []; }

        // 출력 페이지에서는 이미 상태로 필터된 멤버만 넘어온다고 가정 → 전체를 그대로 사용
        let filteredMembers   = Array.isArray(allMembers) ? allMembers : [];

        let currentMonthStart = firstDayOfMonth(new Date());

        initHeaderFixed();
        loadWeeklyTable();   // 초기 1회 로딩 (현재 월 기준)

        /* ===== 헤더: 고정 멤버 칩 렌더링 ===== */
        function initHeaderFixed(){
            memberPills.innerHTML = '';
            const ms = (filteredMembers || []);
            memberCountBadge.textContent = ms.length + '명';

            if (!ms.length){
                memberPills.innerHTML = `<span class="small-muted">해당 상태의 근무자가 없습니다.</span>`;
                return;
            }

            ms.slice()
                    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'))
                    .forEach(m=>{
                        const color = colorForMember(m);
                        const el = document.createElement('span');
                        el.className = 'pill';
                        el.innerHTML = `
                      <span class="dot" style="background:${color}"></span>
                      <span class="name">${escapeHtml(m.name ?? '-')}</span>
                      <span class="small-muted">${escapeHtml(m.phone ?? '')}</span>
                  `;
                        memberPills.appendChild(el);
                    });
        }

        /* ===== 주차 테이블 렌더 ===== */
        async function loadWeeklyTable(){
            const ms = firstDayOfMonth(currentMonthStart);
            const me = lastDayOfMonth(currentMonthStart);
            monthRangeLabel.textContent =
                    `${ms.getFullYear()}.${pad2(ms.getMonth()+1)}.01 ~ ${pad2(me.getMonth()+1)}.${pad2(me.getDate())}`;

            weeklyPayBody.innerHTML = '';
            setFooterSums(0,0,0,0);

            if (!filteredMembers.length){
                const tr = document.createElement('tr');
                tr.classList.add('week-end-border');
                tr.innerHTML = `<td colspan="11" class="text-muted">표시할 멤버가 없습니다.</td>`;
                weeklyPayBody.appendChild(tr);
                return;
            }

            const msIso = toIso(ms), meIso = toIso(me);
            const memberDayMap = {};

            await Promise.all(filteredMembers.map(async m=>{
                try{
                    const url = `${API_BASE_ACTUAL}/${encodeURIComponent(m.id)}/${msIso}/${meIso}`;
                    const resp = await fetch(url, { headers: { 'Accept':'application/json' } });
                    if (resp.ok){
                        const data = await resp.json();
                        memberDayMap[m.id] = normalizeDays(data);
                    } else {
                        memberDayMap[m.id] = {};
                    }
                }catch(e){
                    console.error('schedule fetch error', e);
                    memberDayMap[m.id] = {};
                }
            }));

            const weeks   = [];
            let wStart    = toMonday(ms);
            const monthEnd = new Date(me);
            while (wStart <= monthEnd){
                weeks.push(new Date(wStart));
                wStart.setDate(wStart.getDate()+7);
            }

            let monthWorkPaySum = 0;
            let monthJuhyuPaySum = 0;
            let monthTaxSum = 0;
            let monthNetSum = 0;

            weeks.forEach((weekStart, idx)=>{
                const weekEnd = addDays(weekStart, 6);

                const rows = [];
                filteredMembers.forEach(m=>{
                    const wage = Number(m.hourlyWage)||0;
                    const includeJuhyu = !!m.includeWeeklyHolidayAllowance;
                    const applyTax = isTaxApplied(m);

                    let weekMinutes = 0;
                    for (let i=0;i<7;i++){
                        const d = addDays(weekStart, i);
                        if (d < ms || d > me) continue;
                        const iso = toIso(d);
                        const info = (memberDayMap[m.id]||{})[iso] || {minutes:0};
                        weekMinutes += (info.minutes||0);
                    }
                    if (weekMinutes <= 0) return;

                    const workPay = Math.round((weekMinutes/60) * wage);
                    let juhyuPay = 0;
                    let juhyuApplied = false;
                    if (includeJuhyu && weekMinutes >= 15*60){
                        const juhyuMinutes = Math.round(weekMinutes / 5);
                        juhyuPay = Math.round((juhyuMinutes/60) * wage);
                        juhyuApplied = true;
                    }

                    const grossTotal = workPay + juhyuPay;
                    let taxAmount = 0;
                    let netTotal = grossTotal;
                    if (applyTax && grossTotal > 0){
                        taxAmount = Math.round(grossTotal * 0.033);
                        netTotal  = grossTotal - taxAmount;
                    }

                    rows.push({
                        member: m,
                        weekMinutes,
                        wage,
                        juhyuApplied,
                        workPay,
                        juhyuPay,
                        applyTax,
                        taxAmount,
                        grossTotal,
                        netTotal
                    });
                });

                // 해당 주에 실근무가 전혀 없을 때
                if (rows.length === 0) {
                    const tr = document.createElement('tr');
                    const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;
                    tr.innerHTML = `
                        <td class="week-label week-label-border">${idx+1}주차<br><small class="text-muted">(${weekLabel})</small></td>
                        <td colspan="10" class="text-muted text-start">해당 주 실근무 내역이 없습니다.</td>
                    `;
                    tr.classList.add('week-end-border');
                    weeklyPayBody.appendChild(tr);
                    return;
                }

                rows.sort((a,b)=>(a.member.name||'').localeCompare(b.member.name||'','ko'));

                const rowSpan   = rows.length;
                const weekLabel = `${pad2(weekStart.getMonth()+1)}.${pad2(weekStart.getDate())} ~ ${pad2(weekEnd.getMonth()+1)}.${pad2(weekEnd.getDate())}`;

                rows.forEach((r, i)=>{
                    const tr = document.createElement('tr');
                    const weekCell = (i===0)
                            ? `<td class="week-label week-label-border" rowspan="${rowSpan}">
                             ${idx+1}주차<br><small class="text-muted">(${weekLabel})</small>
                           </td>`
                            : '';

                    tr.innerHTML = `
                        ${weekCell}
                        <td class="text-start">${escapeHtml(r.member.name||'-')}</td>
                        <td class="text-end"><span class="text-time">${formatMins(r.weekMinutes)}</span></td>
                        <td class="text-end">${r.wage ? krw(r.wage) : '-'}</td>
                        <td>${r.juhyuApplied ? '<span class="text-success fw-bold">적용</span>' : '<span class="text-muted">미적용</span>'}</td>
                        <td>${r.applyTax ? '<span class="text-danger fw-bold">부과</span>' : '<span class="text-muted">미부과</span>'}</td>
                        <td class="text-end">${krw(r.workPay)}</td>
                        <td class="text-end">${krw(r.juhyuPay)}</td>
                        <td class="text-end">${r.applyTax ? krw(r.taxAmount) : '-'}</td>
                        <td class="text-end"><span class="fw-bold text-primary">${krw(r.netTotal)}</span></td>
                        <td class="text-center small">(매월)${formatPayday(r.member.payday)}</td>
                    `;

                    // 이 주(week)의 마지막 행 → 굵은 하단선
                    if (i === rows.length - 1) {
                        tr.classList.add('week-end-border');
                    }

                    weeklyPayBody.appendChild(tr);
                });

                monthWorkPaySum  += rows.reduce((sum,r)=> sum + r.workPay,    0);
                monthJuhyuPaySum += rows.reduce((sum,r)=> sum + r.juhyuPay,   0);
                monthTaxSum      += rows.reduce((sum,r)=> sum + r.taxAmount,  0);
                monthNetSum      += rows.reduce((sum,r)=> sum + r.netTotal,   0);
            });

            setFooterSums(monthWorkPaySum, monthJuhyuPaySum, monthTaxSum, monthNetSum);
        }

        function setFooterSums(work, juhyu, tax, net){
            monthWorkPaySumEl.textContent  = krw(work|0);
            monthJuhyuPaySumEl.textContent = krw(juhyu|0);
            monthTaxSumEl.textContent      = tax ? krw(tax|0) : '-';
            monthNetSumEl.textContent      = krw(net|0);
        }

        /* ===== 유틸 ===== */
        function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
        function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function pad2(n){ return String(n).padStart(2,'0'); }
        function addDays(d,n){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); x.setDate(x.getDate()+n); return x; }
        function toMonday(date){
            const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
            const off=(d.getDay()+6)%7; d.setDate(d.getDate()-off); return d;
        }
        function normalizeDays(apiData){
            const map={}; const arr=Array.isArray(apiData?.days)?apiData.days:[];
            arr.forEach(d=>{
                const date=String(d.date);
                const segs=Array.isArray(d.segments)?d.segments:[];
                const minutes=(typeof d.minutes==='number')
                        ? d.minutes
                        : segs.reduce((acc,s)=>acc+diffMinutes(s.start,s.end),0);
                map[date] = { segments: segs, minutes };
            });
            return map;
        }
        function diffMinutes(start,end){
            const s=parseHm(start), e=parseHm(end);
            return (e.h*60+e.m) - (s.h*60+s.m);
        }
        function parseHm(hm){
            if(!hm || typeof hm!=='string') return {h:0,m:0};
            const [h,m]=hm.split(':').map(n=>parseInt(n,10));
            return {h:isNaN(h)?0:h, m:isNaN(m)?0:m};
        }
        function formatMins(mins){
            mins=Math.max(0, mins|0);
            const h=Math.floor(mins/60), m=mins%60;
            return m===0?`${h}시간`:`${h}시간 ${m}분`;
        }
        function krw(v){
            return new Intl.NumberFormat('ko-KR',{
                style:'currency',
                currency:'KRW',
                maximumFractionDigits:0
            }).format(v|0);
        }
        function colorForMember(m){
            const key=(m?.id!=null?String(m.id):(m?.name||'x'));
            const h=seededHash(key)%360, s=65, l=55;
            return hslToHex(h,s,l);
        }
        function seededHash(str){
            let h=2166136261>>>0;
            for(let i=0;i<str.length;i++){
                h^=str.charCodeAt(i);
                h=(h*16777619)>>>0;
            }
            return h>>>0;
        }
        function hslToHex(h,s,l){
            s/=100; l/=100;
            const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
            const f=n=> l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
            const toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
            return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        function escapeHtml(s){
            if(s==null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }
        function isTaxApplied(member){
            const v = member?.applyTax;
            if (v === true) return true;
            if (v === false || v == null) return false;
            if (typeof v === 'number') return v === 1;
            if (typeof v === 'string'){
                const s = v.trim().toUpperCase();
                return s === 'Y' || s === 'TRUE' || s === 'T' || s === '1';
            }
            return false;
        }
        function formatPayday(v){
            if (!v) return '미지정';
            const s = String(v).trim().toUpperCase();
            if (s === 'EOM') return '말일';
            if (/^\d+$/.test(s)) {
                const n = parseInt(s, 10);
                if (n >= 1 && n <= 31) return `${n}일`;
            }
            return s;
        }

    })();
</script>

{{>layouts/footer}}
