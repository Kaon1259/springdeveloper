{{>layouts/header_}}

<main class="container my-4">

    <!-- âœ… ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ë¼ìš´ë“œ ë°•ìŠ¤(ì™¸ë¶€ í…Œì´ë¸” ëŠë‚Œ) -->
    <div class="pay-shell">

        <!-- âœ… ì™¸ë¶€ ìƒë‹¨ í—¤ë” : íŒŒë€ìƒ‰ ë°°ê²½ -->
        <div class="pay-shell-header">
            <div class="d-flex align-items-center gap-2">
                <span class="fw-bold text-white fs-5">ì„ê¸ˆ ì§€ê¸‰ í˜„í™©</span>
            </div>

            <!-- ğŸ”¼ ìƒë‹¨: ë·° ì „í™˜ íƒ­ (ì›”ë³„ / ì—°ë„ë³„) -->
            <ul class="nav nav-pills" id="payViewTabs">
                <li class="nav-item">
                    <button class="nav-link active" data-view="MONTH" type="button">
                        ì›”ë³„ ì§€ê¸‰í˜„í™©
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-view="YEAR" type="button">
                        ì—°ë„ë³„ ì§€ê¸‰í˜„í™©
                    </button>
                </li>
            </ul>
        </div>

        <!-- âœ… ì™¸ë¶€ ë‚´ìš© ì˜ì—­ -->
        <div class="pay-shell-body">

            <!-- ================== ğŸ—“ ì›”ë³„ ì§€ê¸‰í˜„í™© ë·° ================== -->
            <section id="viewMonth">

                <!-- ìƒë‹¨: ì›” ì„ íƒ + ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="prevMonthBtn">â—€ ì´ì „ë‹¬</button>
                        <button class="btn btn-outline-secondary btn-sm" id="thisMonthBtn">ì´ë²ˆë‹¬</button>
                        <button class="btn btn-outline-secondary btn-sm" id="nextMonthBtn">ë‹¤ìŒë‹¬ â–¶</button>

                        <input type="month" id="monthPicker"
                               class="form-control form-control-sm ms-1"
                               style="width:170px;">
                    </div>
                    <div class="text-end">
                        <div class="fw-bold h5 mb-0">ì›”ë³„ ì„ê¸ˆ ì§€ê¸‰ í˜„í™©</div>
                        <div class="small text-muted" id="monthLabelSub"></div>
                    </div>
                </div>

                <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
                <div class="small text-muted mb-3">
                    ì„ íƒí•œ <b>ì—°-ì›”</b> ê¸°ì¤€ìœ¼ë¡œ <b>ì„ì‹œì €ì¥ / í™•ì • / ì§€ê¸‰ì™„ë£Œ</b> ìƒíƒœì˜ ê·¼ë¬´ìë¥¼ ëª¨ë‘ í‘œì‹œí•©ë‹ˆë‹¤.<br>
                    ì§€ê¸‰ì™„ë£Œëœ í–‰ì€ <span class="badge bg-primary">ì—°íŒŒë‘ìƒ‰</span>ìœ¼ë¡œ ê°•ì¡°ë©ë‹ˆë‹¤.
                </div>

                <!-- ğŸ“Š ì›”ë³„ ê·¼ë¬´ì íƒ€ì„í…Œì´ë¸” -->
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center" id="monthlyPayTable">
                        <!-- âœ… ë‚´ë¶€ íƒ€ì„í…Œì´ë¸” í—¤ë”ë„ íŒŒë€ìƒ‰ + ìƒë‹¨ ë¼ìš´ë“œ -->
                        <thead class="inner-table-header">
                        <tr>
                            <th style="width:220px;">ê·¼ë¬´ì</th>
                            <th style="width:120px;">ì‹¤ê·¼ë¬´ì‹œê°„</th>
                            <th style="width:130px;">ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</th>
                            <th style="width:100px;">ì‹œê¸‰</th>
                            <th style="width:130px;" class="text-end">ì‹¤ê·¼ë¬´ ê¸‰ì—¬</th>
                            <th style="width:130px;" class="text-end">ì£¼íœ´ ìˆ˜ë‹¹</th>
                            <th style="width:150px;" class="text-end">ì „ì²´ ê¸ˆì•¡</th>
                            <th style="width:90px;">ìƒíƒœ</th>
                            <th style="width:170px;">ì²˜ë¦¬ì¼ì</th>
                        </tr>
                        </thead>
                        <tbody id="monthlyPayBody">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>

                <!-- ğŸ“Œ ì›”ë³„ ìš”ì•½ ì˜ì—­ -->
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì´ ì‹¤ê·¼ë¬´ì‹œê°„</span>
                        <span class="fw-semibold" id="sumWorkTime">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì´ ì£¼íœ´ìˆ˜ë‹¹ì‹œê°„</span>
                        <span class="fw-semibold" id="sumJuhyuTime">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì´ ì‹¤ê·¼ë¬´ ê¸‰ì—¬</span>
                        <span class="fw-semibold" id="sumWorkPay">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted">ì´ ì£¼íœ´ ìˆ˜ë‹¹</span>
                        <span class="fw-semibold" id="sumJuhyuPay">-</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small fw-bold">ì´ ì§€ê¸‰ ê¸ˆì•¡ (ì‹¤ê·¼ë¬´ ê¸‰ì—¬ + ì£¼íœ´ ìˆ˜ë‹¹)</span>
                        <span class="fw-bold text-primary" id="sumTotalPay">-</span>
                    </div>
                </div>
            </section>

            <!-- ================== ğŸ“… ì—°ë„ë³„ ì§€ê¸‰í˜„í™© ë·° ================== -->
            <section id="viewYear" class="d-none mt-4">

                <!-- ìƒë‹¨: ì—°ë„ ì„ íƒ + ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="prevYearBtn">â—€ ì´ì „í•´</button>
                        <button class="btn btn-outline-secondary btn-sm" id="thisYearBtn">ì˜¬í•´</button>
                        <button class="btn btn-outline-secondary btn-sm" id="nextYearBtn">ë‹¤ìŒí•´ â–¶</button>

                        <input type="number" id="yearInput"
                               class="form-control form-control-sm ms-1"
                               style="width:120px;"
                               min="2000" max="2100">
                    </div>
                    <div class="text-end">
                        <div class="fw-bold h5 mb-0">ì—°ë„ë³„ ì„ê¸ˆ ì§€ê¸‰ í˜„í™©</div>
                        <div class="small text-muted" id="yearLabelSub"></div>
                    </div>
                </div>

                <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
                <div class="small text-muted mb-3">
                    ì„ íƒí•œ <b>ì—°ë„ ì „ì²´</b> ê¸°ì¤€ìœ¼ë¡œ ê·¼ë¬´ìë³„ <b>ì‹¤ê·¼ë¬´/ì£¼íœ´ìˆ˜ë‹¹/ê¸‰ì—¬í•©ê³„</b>ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.<br>
                    ì—°ë„ í•©ê³„ëŠ” ê° ì›”ì˜ ì§€ê¸‰ ë‚´ì—­ì„ í•©ì‚°í•œ ê°’ì…ë‹ˆë‹¤.
                </div>

                <!-- ğŸ“Š ì—°ë„ë³„ ê·¼ë¬´ì í…Œì´ë¸” -->
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center" id="yearlyPayTable">
                        <!-- âœ… ë‚´ë¶€ íƒ€ì„í…Œì´ë¸” í—¤ë”ë„ íŒŒë€ìƒ‰ + ìƒë‹¨ ë¼ìš´ë“œ -->
                        <thead class="inner-table-header">
                        <tr>
                            <th style="width:220px;">ê·¼ë¬´ì</th>
                            <th style="width:120px;">ì—°ê°„ ì‹¤ê·¼ë¬´ì‹œê°„</th>
                            <th style="width:130px;">ì—°ê°„ ì£¼íœ´ìˆ˜ë‹¹ ì‹œê°„</th>
                            <th style="width:100px;">ê¸°ì¤€ ì‹œê¸‰</th>
                            <th style="width:130px;" class="text-end">ì—°ê°„ ì‹¤ê·¼ë¬´ ê¸‰ì—¬</th>
                            <th style="width:130px;" class="text-end">ì—°ê°„ ì£¼íœ´ ìˆ˜ë‹¹</th>
                            <th style="width:150px;" class="text-end">ì—°ê°„ ì „ì²´ ê¸ˆì•¡</th>
                            <th style="width:120px;">ë¹„ê³ </th>
                        </tr>
                        </thead>
                        <tbody id="yearlyPayBody">
                        <!-- JS ë Œë” -->
                        </tbody>
                    </table>
                </div>

                <!-- ğŸ“Œ ì—°ë„ë³„ ìš”ì•½ ì˜ì—­ -->
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì—°ê°„ ì´ ì‹¤ê·¼ë¬´ì‹œê°„</span>
                        <span class="fw-semibold" id="yearSumWorkTime">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì—°ê°„ ì´ ì£¼íœ´ìˆ˜ë‹¹ì‹œê°„</span>
                        <span class="fw-semibold" id="yearSumJuhyuTime">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small text-muted">ì—°ê°„ ì´ ì‹¤ê·¼ë¬´ ê¸‰ì—¬</span>
                        <span class="fw-semibold" id="yearSumWorkPay">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small text-muted">ì—°ê°„ ì´ ì£¼íœ´ ìˆ˜ë‹¹</span>
                        <span class="fw-semibold" id="yearSumJuhyuPay">-</span>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small fw-bold">ì—°ê°„ ì´ ì§€ê¸‰ ê¸ˆì•¡ (ì‹¤ê·¼ë¬´ ê¸‰ì—¬ + ì£¼íœ´ ìˆ˜ë‹¹)</span>
                        <span class="fw-bold text-primary" id="yearSumTotalPay">-</span>
                    </div>
                </div>
            </section>

        </div><!-- .pay-shell-body -->
    </div><!-- .pay-shell -->

</main>

<!-- ğŸ’„ ìŠ¤íƒ€ì¼ -->
<style>
    /* âœ… ì „ì²´ ì™¸ë¶€ ë¼ìš´ë“œ ë°•ìŠ¤ */
    .pay-shell{
        border-radius:1rem;
        border:1px solid #dee2e6;
        overflow:hidden;
        background:#ffffff;
        box-shadow:0 4px 12px rgba(0,0,0,0.03);
    }

    /* âœ… ì™¸ë¶€ ìƒë‹¨ í—¤ë” (íŒŒë€ìƒ‰) */
    .pay-shell-header{
        background:#0d6efd;
        color:#ffffff;
        padding:0.75rem 1rem;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:1rem;
    }

    /* í—¤ë” ì•ˆ nav-pill ìŠ¤íƒ€ì¼ íŠœë‹ */
    .pay-shell-header .nav-pills .nav-link{
        color:rgba(255,255,255,0.8);
        border-radius:999px;
        padding:0.25rem 0.9rem;
        font-size:0.9rem;
        border:1px solid transparent;
        background:transparent;
    }
    .pay-shell-header .nav-pills .nav-link:hover{
        color:#ffffff;
        border-color:rgba(255,255,255,0.4);
        background:rgba(255,255,255,0.08);
    }
    .pay-shell-header .nav-pills .nav-link.active{
        color:#0d6efd;
        background:#ffffff;
        border-color:#ffffff;
        font-weight:600;
    }

    /* ì™¸ë¶€ ë‚´ìš© ì˜ì—­ */
    .pay-shell-body{
        padding:1.25rem 1.5rem 1.5rem;
    }

    /* ìƒíƒœ ìƒ‰ìƒ ì  (ì²« ì»¬ëŸ¼ìš©) */
    .status-dot {
        display:inline-block;
        width:10px;
        height:10px;
        border-radius:50%;
        margin-right:6px;
        border:1px solid rgba(0,0,0,.08);
    }
    .status-dot-draft { background:#ced4da; }      /* ì„ì‹œì €ì¥ - íšŒìƒ‰ */
    .status-dot-confirmed { background:#ffe08a; }  /* í™•ì • - ë…¸ë‘ */
    .status-dot-paid { background:#4dabf7; }       /* ì§€ê¸‰ì™„ë£Œ - íŒŒë‘ */

    /* í–‰ ë°°ê²½ìƒ‰ */
    #monthlyPayBody tr.draft-row {
        background-color:#f8f9fa;
    }
    #monthlyPayBody tr.confirmed-row {
        background-color:#fff8e1;
    }
    #monthlyPayBody tr.paid-row {
        background-color:#e8f2ff; /* ì—°íŒŒë‘ */
    }

    /* ì´ë¦„ ì˜ì—­ ì •ë ¬ */
    .member-cell {
        text-align:left;
        white-space:nowrap;
    }
    .member-name {
        font-weight:600;
    }
    .member-meta {
        font-size:.75rem;
        color:#6c757d;
    }

    /* í† ìŠ¤íŠ¸ ìƒë‹¨ ì¤‘ì•™ ì—¬ë°± */
    .toast-top-center {
        margin-top: 70px; /* ìƒë‹¨ ë„¤ë¹„ë°” ì•„ë˜ìª½ ì—¬ë°± */
    }

    /* âœ… ë‚´ë¶€ íƒ€ì„í…Œì´ë¸” í—¤ë”: íŒŒë€ìƒ‰ + ìƒë‹¨ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    .inner-table-header th{
        background:#0d6efd !important;
        color:#ffffff !important;
        border-color:#0b5ed7 !important;
        vertical-align:middle;
    }
    .inner-table-header th:first-child{
        border-top-left-radius:0.75rem;
    }
    .inner-table-header th:last-child{
        border-top-right-radius:0.75rem;
    }

    /* í…Œì´ë¸” ìì²´ ëª¨ì„œë¦¬ ë¼ìš´ë“œ */
    #monthlyPayTable,
    #yearlyPayTable{
        border-collapse:separate;
        border-spacing:0;
        border-radius:0.75rem;
        overflow:hidden;
    }
</style>

<!-- âœ… ë¶€íŠ¸ìŠ¤íŠ¸ë© í† ìŠ¤íŠ¸ ì˜ì—­ (ìƒë‹¨ ì¤‘ì•™ ë°°ì¹˜ + 3ì´ˆ ìë™ ë‹«í˜ + X í…ìŠ¤íŠ¸ ë²„íŠ¼) -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3 toast-top-center" style="z-index:1080;">
    <div id="mainToast"
         class="toast align-items-center text-bg-success border-0"
         role="alert"
         aria-live="assertive"
         aria-atomic="true"
         data-bs-delay="3000"
         data-bs-autohide="true">
        <div class="d-flex align-items-center">
            <div class="toast-body" id="mainToastBody">
                ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
            <!-- X í…ìŠ¤íŠ¸ ë‹«ê¸° ë²„íŠ¼ -->
            <button type="button"
                    class="btn btn-sm btn-link fw-bold text-dark ms-2"
                    data-bs-dismiss="toast"
                    aria-label="Close"
                    style="text-decoration:none;font-size:1.2rem;line-height:1;">
                Ã—
            </button>
        </div>
    </div>
</div>
<script>
    (function() {
        // ğŸ“¡ API URL
        const MONTHLY_API = '/api/payroll/monthly';
        const YEARLY_API  = '/api/payroll/yearly';

        // ğŸ” íƒ­
        const tabButtons = document.querySelectorAll('#payViewTabs .nav-link');
        const viewMonthSection = document.getElementById('viewMonth');
        const viewYearSection  = document.getElementById('viewYear');

        // ì›”ë³„ ìš”ì†Œ
        const monthPicker   = document.getElementById('monthPicker');
        const monthLabelSub = document.getElementById('monthLabelSub');
        const prevMonthBtn  = document.getElementById('prevMonthBtn');
        const thisMonthBtn  = document.getElementById('thisMonthBtn');
        const nextMonthBtn  = document.getElementById('nextMonthBtn');

        const monthlyTbody  = document.getElementById('monthlyPayBody');

        const sumWorkTime   = document.getElementById('sumWorkTime');
        const sumJuhyuTime  = document.getElementById('sumJuhyuTime');
        const sumWorkPay    = document.getElementById('sumWorkPay');
        const sumJuhyuPay   = document.getElementById('sumJuhyuPay');
        const sumTotalPay   = document.getElementById('sumTotalPay');

        // ì—°ë„ë³„ ìš”ì†Œ
        const yearInput     = document.getElementById('yearInput');
        const yearLabelSub  = document.getElementById('yearLabelSub');
        const prevYearBtn   = document.getElementById('prevYearBtn');
        const thisYearBtn   = document.getElementById('thisYearBtn');
        const nextYearBtn   = document.getElementById('nextYearBtn');

        const yearlyTbody   = document.getElementById('yearlyPayBody');

        const yearSumWorkTime  = document.getElementById('yearSumWorkTime');
        const yearSumJuhyuTime = document.getElementById('yearSumJuhyuTime');
        const yearSumWorkPay   = document.getElementById('yearSumWorkPay');
        const yearSumJuhyuPay  = document.getElementById('yearSumJuhyuPay');
        const yearSumTotalPay  = document.getElementById('yearSumTotalPay');

        // í† ìŠ¤íŠ¸
        const toastEl       = document.getElementById('mainToast');
        const toastBodyEl   = document.getElementById('mainToastBody');

        // ê³µí†µ: ì˜¤ëŠ˜ ê¸°ì¤€
        const now = new Date();
        const initYm  = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
        const initYear = now.getFullYear();

        // ì´ˆê¸° ì…‹ì—… - ì›”ë³„
        monthPicker.value = initYm;
        updateMonthLabel();

        // ì´ˆê¸° ì…‹ì—… - ì—°ë„ë³„
        yearInput.value = initYear;
        updateYearLabel();

        // íƒ­ ë³€ê²½ ì´ë²¤íŠ¸
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (view === 'MONTH') {
                    viewMonthSection.classList.remove('d-none');
                    viewYearSection.classList.add('d-none');
                    loadMonthlyData();
                } else {
                    viewYearSection.classList.remove('d-none');
                    viewMonthSection.classList.add('d-none');
                    loadYearlyData();
                }
            });
        });

        // ì›”ë³„ ì´ë²¤íŠ¸
        prevMonthBtn.addEventListener('click', () => shiftMonth(-1));
        nextMonthBtn.addEventListener('click', () => shiftMonth(1));
        thisMonthBtn.addEventListener('click', () => {
            const today = new Date();
            monthPicker.value = `${today.getFullYear()}-${pad2(today.getMonth()+1)}`;
            updateMonthLabel();
            loadMonthlyData();
        });
        monthPicker.addEventListener('change', () => {
            updateMonthLabel();
            loadMonthlyData();
        });

        // ì—°ë„ë³„ ì´ë²¤íŠ¸
        prevYearBtn.addEventListener('click', () => shiftYear(-1));
        nextYearBtn.addEventListener('click', () => shiftYear(1));
        thisYearBtn.addEventListener('click', () => {
            const year = new Date().getFullYear();
            yearInput.value = year;
            updateYearLabel();
            loadYearlyData();
        });
        yearInput.addEventListener('change', () => {
            updateYearLabel();
            loadYearlyData();
        });

        // ì´ˆê¸°: ì›”ë³„ íƒ­ ê¸°ì¤€ ë°ì´í„° ë¡œë”©
        loadMonthlyData();

        // ====== ì›” ì´ë™ ======
        function shiftMonth(diff) {
            const cur = monthPicker.value || initYm;
            const d = new Date(cur + '-01T00:00:00');
            if (isNaN(d.getTime())) return;
            d.setMonth(d.getMonth() + diff);
            monthPicker.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
            updateMonthLabel();
            loadMonthlyData();
        }

        function updateMonthLabel() {
            const [y, m] = (monthPicker.value || '').split('-');
            if (y && m) {
                monthLabelSub.textContent = `${y}ë…„ ${Number(m)}ì›” ê¸°ì¤€`;
            } else {
                monthLabelSub.textContent = '';
            }
        }

        // ====== ì—°ë„ ì´ë™ ======
        function shiftYear(diff) {
            let year = Number(yearInput.value) || initYear;
            year += diff;
            yearInput.value = year;
            updateYearLabel();
            loadYearlyData();
        }

        function updateYearLabel() {
            const year = Number(yearInput.value) || initYear;
            yearLabelSub.textContent = `${year}ë…„ ì „ì²´ ì§€ê¸‰í˜„í™©`;
        }

        // ====== ì›”ë³„ ë°ì´í„° ë¡œë“œ ======
        async function loadMonthlyData() {
            const [yearStr, monthStr] = (monthPicker.value || '').split('-');
            const year  = Number(yearStr) || now.getFullYear();
            const month = Number(monthStr) || (now.getMonth()+1);

            monthlyTbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </td>
                </tr>
            `;

            try {
                const url = `${MONTHLY_API}?year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`;
                const resp = await fetch(url, { headers:{ 'Accept':'application/json' } });

                if (!resp.ok) {
                    const txt = await resp.text().catch(()=> '');
                    console.error('monthly api error', resp.status, txt);
                    showToast('ì›”ë³„ ì„ê¸ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    monthlyTbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-danger">
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    clearMonthSummary();
                    return;
                }

                let list = await resp.json();
                if (!Array.isArray(list)) list = [];

                renderMonthlyTable(list);
            } catch (e) {
                console.error('monthly api fetch error', e);
                showToast('ì›”ë³„ ì„ê¸ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                monthlyTbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                clearMonthSummary();
            }
        }

        // ====== ì—°ë„ë³„ ë°ì´í„° ë¡œë“œ ======
        async function loadYearlyData() {
            const year = Number(yearInput.value) || now.getFullYear();

            yearlyTbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </td>
                </tr>
            `;

            try {
                const url = `${YEARLY_API}?year=${encodeURIComponent(year)}`;
                const resp = await fetch(url, { headers:{ 'Accept':'application/json' } });

                if (!resp.ok) {
                    const txt = await resp.text().catch(()=> '');
                    console.error('yearly api error', resp.status, txt);
                    showToast('ì—°ë„ë³„ ì„ê¸ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                    yearlyTbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger">
                                ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    clearYearSummary();
                    return;
                }

                let list = await resp.json();
                if (!Array.isArray(list)) list = [];

                renderYearlyTable(list);
            } catch (e) {
                console.error('yearly api fetch error', e);
                showToast('ì—°ë„ë³„ ì„ê¸ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                yearlyTbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                clearYearSummary();
            }
        }

        // ====== ì›”ë³„ í…Œì´ë¸” ë Œë”ë§ ======
        function renderMonthlyTable(list) {
            monthlyTbody.innerHTML = '';

            if (!Array.isArray(list) || list.length === 0) {
                monthlyTbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            ì„ íƒí•œ ì›”ì— ëŒ€í•œ ì„ê¸ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                clearMonthSummary();
                return;
            }

            const statusOrder = { DRAFT:0, CONFIRMED:1, PAID:2 };
            list.sort((a,b) => {
                const sa = (a.status || 'DRAFT').toUpperCase();
                const sb = (b.status || 'DRAFT').toUpperCase();
                const diff = (statusOrder[sa] ?? 0) - (statusOrder[sb] ?? 0);
                if (diff !== 0) return diff;
                const na = (a.memberName || '');
                const nb = (b.memberName || '');
                return na.localeCompare(nb, 'ko');
            });

            let totalWorkMin   = 0;
            let totalJuhyuMin  = 0;
            let totalWorkPay   = 0;
            let totalJuhyuPay  = 0;
            let totalPay       = 0;

            const rows = list.map(item => {
                const workMinutes  = item.workMinutes  || 0;
                const juhyuMinutes = item.juhyuMinutes || 0;
                const workPay      = item.workPay      || 0;
                const juhyuPay     = item.juhyuPay     || 0;
                const total        = item.totalPay     || (workPay + juhyuPay);

                totalWorkMin   += workMinutes;
                totalJuhyuMin  += juhyuMinutes;
                totalWorkPay   += workPay;
                totalJuhyuPay  += juhyuPay;
                totalPay       += total;

                const status = (item.status || 'DRAFT').toUpperCase();

                const statusLabelMap = {
                    DRAFT:     'ì„ì‹œì €ì¥',
                    CONFIRMED: 'í™•ì •',
                    PAID:      'ì§€ê¸‰ì™„ë£Œ'
                };
                const badgeClassMap = {
                    DRAFT:     'bg-secondary',
                    CONFIRMED: 'bg-warning text-dark',
                    PAID:      'bg-success'
                };
                const rowClassMap = {
                    DRAFT:     'draft-row',
                    CONFIRMED: 'confirmed-row',
                    PAID:      'paid-row'
                };

                const statusLabel  = statusLabelMap[status] || status;
                const badgeClass   = badgeClassMap[status] || 'bg-secondary';
                const rowClass     = rowClassMap[status] || '';
                const dotClass     =
                        status === 'PAID'      ? 'status-dot-paid' :
                                status === 'CONFIRMED' ? 'status-dot-confirmed' : 'status-dot-draft';

                let rawDate = null;
                if (status === 'DRAFT') {
                    rawDate = item.savedAt || item.createdAt || null;
                } else if (status === 'CONFIRMED') {
                    rawDate = item.confirmedAt || null;
                } else if (status === 'PAID') {
                    rawDate = item.paidAt || null;
                }
                const dateStr = rawDate ? formatDateTime(rawDate) : '-';

                const hourly = (typeof item.hourlyWage === 'number') ? item.hourlyWage : 0;

                const memberName  = escapeHtml(item.memberName || '-');
                const memberPhone = escapeHtml(item.memberPhone || '');
                const memberCode  = escapeHtml(item.memberCode || '');

                return `
                    <tr class="${rowClass}">
                        <td class="member-cell">
                            <span class="status-dot ${dotClass}"></span>
                            <span class="member-name">${memberName}</span>
                            ${
                        (memberPhone || memberCode)
                                ? `<div class="member-meta">
                                       ${memberPhone ? memberPhone : ''}
                                       ${memberPhone && memberCode ? ' Â· ' : ''}
                                       ${memberCode ? memberCode : ''}
                                   </div>`
                                : ''
                }
                        </td>
                        <td>${formatMins(workMinutes)}</td>
                        <td>${formatMins(juhyuMinutes)}</td>
                        <td class="text-end">${hourly ? krw(hourly) : '-'}</td>
                        <td class="text-end">${workPay ? krw(workPay) : '-'}</td>
                        <td class="text-end">${juhyuPay ? krw(juhyuPay) : '-'}</td>
                        <td class="text-end fw-semibold">${total ? krw(total) : '-'}</td>
                        <td><span class="badge ${badgeClass}">${statusLabel}</span></td>
                        <td>${dateStr}</td>
                    </tr>
                `;
            });

            monthlyTbody.innerHTML = rows.join('');

            sumWorkTime.textContent  = formatMins(totalWorkMin);
            sumJuhyuTime.textContent = formatMins(totalJuhyuMin);
            sumWorkPay.textContent   = totalWorkPay   ? krw(totalWorkPay)   : '-';
            sumJuhyuPay.textContent  = totalJuhyuPay  ? krw(totalJuhyuPay)  : '-';
            sumTotalPay.textContent  = totalPay       ? krw(totalPay)       : '-';
        }

        function clearMonthSummary() {
            sumWorkTime.textContent  = '-';
            sumJuhyuTime.textContent = '-';
            sumWorkPay.textContent   = '-';
            sumJuhyuPay.textContent  = '-';
            sumTotalPay.textContent  = '-';
        }

        // ====== ì—°ë„ë³„ í…Œì´ë¸” ë Œë”ë§ ======
        function renderYearlyTable(list) {
            yearlyTbody.innerHTML = '';

            if (!Array.isArray(list) || list.length === 0) {
                yearlyTbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            ì„ íƒí•œ ì—°ë„ì— ëŒ€í•œ ì„ê¸ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                clearYearSummary();
                return;
            }

            list.sort((a,b) => {
                const na = (a.memberName || '');
                const nb = (b.memberName || '');
                return na.localeCompare(nb, 'ko');
            });

            let totalWorkMin   = 0;
            let totalJuhyuMin  = 0;
            let totalWorkPay   = 0;
            let totalJuhyuPay  = 0;
            let totalPay       = 0;

            const rows = list.map(item => {
                const workMinutes  = item.workMinutes  || 0;
                const juhyuMinutes = item.juhyuMinutes || 0;
                const workPay      = item.workPay      || 0;
                const juhyuPay     = item.juhyuPay     || 0;
                const total        = item.totalPay     || (workPay + juhyuPay);

                totalWorkMin   += workMinutes;
                totalJuhyuMin  += juhyuMinutes;
                totalWorkPay   += workPay;
                totalJuhyuPay  += juhyuPay;
                totalPay       += total;

                const hourly      = (typeof item.hourlyWage === 'number') ? item.hourlyWage : 0;
                const memberName  = escapeHtml(item.memberName || '-');
                const memberPhone = escapeHtml(item.memberPhone || '');
                const memberCode  = escapeHtml(item.memberCode || '');

                return `
                    <tr>
                        <td class="member-cell">
                            <span class="member-name">${memberName}</span>
                            ${
                        (memberPhone || memberCode)
                                ? `<div class="member-meta">
                                       ${memberPhone ? memberPhone : ''}
                                       ${memberPhone && memberCode ? ' Â· ' : ''}
                                       ${memberCode ? memberCode : ''}
                                   </div>`
                                : ''
                }
                        </td>
                        <td>${formatMins(workMinutes)}</td>
                        <td>${formatMins(juhyuMinutes)}</td>
                        <td class="text-end">${hourly ? krw(hourly) : '-'}</td>
                        <td class="text-end">${workPay ? krw(workPay) : '-'}</td>
                        <td class="text-end">${juhyuPay ? krw(juhyuPay) : '-'}</td>
                        <td class="text-end fw-semibold">${total ? krw(total) : '-'}</td>
                        <td>-</td>
                    </tr>
                `;
            });

            yearlyTbody.innerHTML = rows.join('');

            yearSumWorkTime.textContent  = formatMins(totalWorkMin);
            yearSumJuhyuTime.textContent = formatMins(totalJuhyuMin);
            yearSumWorkPay.textContent   = totalWorkPay   ? krw(totalWorkPay)   : '-';
            yearSumJuhyuPay.textContent  = totalJuhyuPay  ? krw(totalJuhyuPay)  : '-';
            yearSumTotalPay.textContent  = totalPay       ? krw(totalPay)       : '-';
        }

        function clearYearSummary() {
            yearSumWorkTime.textContent  = '-';
            yearSumJuhyuTime.textContent = '-';
            yearSumWorkPay.textContent   = '-';
            yearSumJuhyuPay.textContent  = '-';
            yearSumTotalPay.textContent  = '-';
        }

        // ====== í† ìŠ¤íŠ¸ ======
        function showToast(message, type) {
            if (!toastEl || !toastBodyEl) return;
            toastBodyEl.textContent = message;

            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            if (type === 'danger') {
                toastEl.classList.add('text-bg-danger');
            } else if (type === 'warning') {
                toastEl.classList.add('text-bg-warning');
            } else if (type === 'info') {
                toastEl.classList.add('text-bg-info');
            } else {
                toastEl.classList.add('text-bg-success');
            }

            if (window.bootstrap && bootstrap.Toast) {
                const t = bootstrap.Toast.getOrCreateInstance(toastEl, {
                    delay: 3000,
                    autohide: true
                });
                t.show();
            } else {
                toastEl.style.display = 'block';
                setTimeout(() => {
                    toastEl.style.display = 'none';
                }, 3000);
            }
        }

        // ====== ìœ í‹¸ ======
        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function formatMins(mins) {
            const v = Math.max(0, mins|0);
            const h = Math.floor(v / 60);
            const m = v % 60;
            return m === 0 ? `${h}ì‹œê°„` : `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function krw(v) {
            if (v == null || isNaN(v)) return '-';
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                maximumFractionDigits: 0
            }).format(v);
        }

        // 2025-11-12 10:20 í˜•íƒœ
        function formatDateTime(value) {
            if (!value) return '-';

            let d;
            if (value instanceof Date) {
                d = value;
            } else if (typeof value === 'number') {
                d = new Date(value < 1e12 ? value * 1000 : value);
            } else {
                const s = String(value).replace(' ', 'T');
                const parsed = new Date(s);
                if (isNaN(parsed.getTime())) return String(value);
                d = parsed;
            }

            const y  = d.getFullYear();
            const M  = pad2(d.getMonth()+1);
            const D  = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mm = pad2(d.getMinutes());

            return `${y}-${M}-${D} ${hh}:${mm}`;
        }

        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                    .replace(/&/g,'&amp;')
                    .replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;')
                    .replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
        }

    })();
</script>

{{>layouts/footer_}}
