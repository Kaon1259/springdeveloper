####################################
create table actual_work_schedule (
id bigint generated by default as identity,
member_id bigint not null,
work_date date not null,
segments_json clob not null,9
total_minutes integer not null,
created_at timestamp,
updated_at timestamp,
constraint uq_member_date unique (member_id, work_date),g
primary key (id)
);

CREATE TABLE work_schedule (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

member_id BIGINT NOT NULL,
work_date DATE NOT NULL,
start_time TIME NOT NULL,
end_time TIME NOT NULL,
source VARCHAR(20) NOT NULL,
note VARCHAR(500),

created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP,

CONSTRAINT fk_work_schedule_member
FOREIGN KEY (member_id)
REFERENCES member (id)
ON DELETE CASCADE,

CONSTRAINT uk_work_schedule_member_date_start_end
UNIQUE (member_id, work_date, start_time, end_time),

CONSTRAINT chk_work_schedule_source CHECK (source IN ('GENERATED','MANUAL','IMPORTED'))
);

CREATE INDEX idx_work_schedule_member_date
ON work_schedule (member_id, work_date);


#############################################
PAYMENT
CREATE TABLE PAYROLL_MONTH (
id                  BIGINT AUTO_INCREMENT PRIMARY KEY,

-- ??? ????
member_id           BIGINT      NOT NULL,

-- ?? ???
pay_year            INT         NOT NULL,   -- ?: 2025
pay_month           INT         NOT NULL,   -- 1~12

-- ?? ??
hourly_wage         INT         NOT NULL,   -- ?? ?? ?? (?)

-- ? ?? ?? (? ??? ??)
month_work_minutes  INT         NOT NULL,   -- ? ??? ? ?
month_juhyu_minutes INT         NOT NULL,   -- ? ???? ? ?(?? ??)

-- ?? (? ??)
month_work_pay      BIGINT      NOT NULL,   -- ??? × ??
month_juhyu_pay     BIGINT      NOT NULL,   -- ???? ??
month_total_pay     BIGINT      NOT NULL,   -- ? ??? (work + juhyu)

-- ?? ??
status              VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
-- ?: DRAFT(??), CONFIRMED(??), PAID(????)

confirmed_at        TIMESTAMP,             -- ?? ??
paid_at             TIMESTAMP,             -- ?? ?? ??(??)

created_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
updated_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,

CONSTRAINT uq_payroll_month UNIQUE (member_id, pay_year, pay_month),
CONSTRAINT fk_payroll_month_member
FOREIGN KEY (member_id) REFERENCES member(id)
);

CREATE TABLE PAYROLL_WEEK (
id                      BIGINT AUTO_INCREMENT PRIMARY KEY,

-- ?? ? ??? ????
payroll_month_id        BIGINT      NOT NULL,

-- 1??, 2?? ? (??? "1?? (11.01 ~ 11.07)" ???)
week_index              INT         NOT NULL,        -- 1, 2, 3, 4, 5 ...

-- ? ?? ??
week_start_date         DATE        NOT NULL,        -- ? ?? (??? ??)
week_end_date           DATE        NOT NULL,        -- ? ? (??? ??)

-- ??? ?? (? ??)
week_work_minutes       INT         NOT NULL,        -- ? ? ??? ? ?

-- ???? ?? (? ??, ????/5 ??)
week_juhyu_minutes      INT         NOT NULL,        -- ? ? ???? ??(?). ??? 0

-- ?? (? ??)
week_work_pay           BIGINT      NOT NULL,        -- ??? × ??
week_juhyu_pay          BIGINT      NOT NULL,        -- ???? ??
week_total_pay          BIGINT      NOT NULL,        -- week_work_pay + week_juhyu_pay

created_at              TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
updated_at              TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,

CONSTRAINT fk_payroll_week_month
FOREIGN KEY (payroll_month_id) REFERENCES PAYROLL_MONTH(id),

-- ? ???(PAYROLL_MONTH) ??? ??? 1???
CONSTRAINT uq_payroll_week UNIQUE (payroll_month_id, week_index)
);

ALTER TABLE MEMBER
ADD COLUMN payday VARCHAR(8);

ALTER TABLE MEMBER
ADD COLUMN include_weekly_holiday_allowance BOOLEAN DEFAULT FALSE;

UPDATE MEMBER SET payday = 1


ALTER TABLE MEMBER
ADD COLUMN APPLY_TAX BOOLEAN DEFAULT FALSE NOT NULL;


DROP TABLE IF EXISTS USERS;

CREATE TABLE USERS (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

nickname VARCHAR(30) NOT NULL UNIQUE,
password VARCHAR(255) NOT NULL,
email VARCHAR(100) NOT NULL UNIQUE,
phone VARCHAR(20),
agreed_terms BOOLEAN NOT NULL,

created_at TIMESTAMP NOT NULL,
updated_at TIMESTAMP NOT NULL
);


ALTER TABLE MEMBER
ADD COLUMN memo VARCHAR(250);


CREATE TABLE recipe (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
menu_name VARCHAR(100) NOT NULL,
author VARCHAR(50) NOT NULL,
description VARCHAR(255),
temperature VARCHAR(10) NOT NULL,
cup_size VARCHAR(10) NOT NULL,
category VARCHAR(30) NOT NULL,
created_at TIMESTAMP,
updated_at TIMESTAMP
);

CREATE TABLE recipe_step (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
recipe_id BIGINT NOT NULL,
step_order INT NOT NULL,
content TEXT NOT NULL,

CONSTRAINT fk_recipe_step_recipe
FOREIGN KEY (recipe_id)
REFERENCES recipe(id)
ON DELETE CASCADE
);

-- ?? ??? ?? ??? ???? ?? ???
CREATE INDEX idx_recipe_step_recipe_id
ON recipe_step (recipe_id);

ALTER TABLE recipe
ADD COLUMN visible BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE recipe
ADD COLUMN template BOOLEAN NOT NULL DEFAULT FALSE;

ALTER TABLE recipe_step
ADD COLUMN step_time INT NOT NULL DEFAULT 10;


ALTER TABLE member
    ADD COLUMN ssn VARCHAR(50);

-- 2) 기존 데이터에 임시 값 채우기 (필요에 맞게 수정 가능)
UPDATE member
SET ssn = 'TEMP-SSN'
WHERE ssn IS NULL;


ALTER TABLE member
ADD COLUMN hourly_Wage2 INT  NULL;

UPDATE member
SET hourly_Wage2 = 0;

ALTER TABLE member
ALTER COLUMN hourly_Wage2 INT NOT NULL