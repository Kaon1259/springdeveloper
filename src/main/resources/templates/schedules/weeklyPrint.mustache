{{>layouts/header_}}

<style>
    body { background: #fff !important; }

    .print-container {
        margin: 20px auto;
        padding: 10px;
        transition: all .2s ease;
    }

    .print-container.portrait-mode { max-width: 800px; }
    .print-container.landscape-mode { max-width: 1180px; }

    .print-header {
        padding-bottom: 15px;
        border-bottom: 2px solid #1d4ed8;
        margin-bottom: 20px;
    }

    .title { font-size: 1.5rem; font-weight: 700; color: #1d4ed8; }
    .meta  { font-size: .95rem; color: #444; }

    table#printTable {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: .85rem;
    }

    table#printTable th, table#printTable td {
        border: 1px solid #ccc;
        padding: 6px 4px;
        text-align: center;
        vertical-align: middle;
    }

    table#printTable thead th { background: #e2e8f0; font-weight: 700; }

    .slot-cell { height: 26px; background: #f8fafc; }
    .slot-has-work { background: #eff6ff !important; }

    .staff-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        padding: 2px 6px;
        font-size: .78rem;
        background: #fff;
        border: 1px solid #e5e7eb;
        max-width: 90px;
        white-space: nowrap;
        overflow: hidden;
        margin: 1px 2px;
    }

    .staff-dot {
        width: 10px; height: 10px;
        border-radius: 50%;
        border: 1px solid rgba(0,0,0,.1);
    }

    .staff-name { font-weight: 600; }

    @media print {
        .no-print { display: none !important; }
        table#printTable th, table#printTable td {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>

<div class="print-container portrait-mode" id="printContainer">

    <div class="print-header d-flex justify-content-between align-items-center">

        <!-- 왼쪽: 제목 + 조건 텍스트 -->
        <div>
            <div class="title">
                주간근무
                <span class="meta ms-2">
                    (상태 : {{statusLabel}} · 기간 : {{weekLabel}} · 단위 : {{slotMinutes}}분)
                </span>
            </div>
        </div>

        <!-- 오른쪽: 버튼 위치 그대로 유지 -->
        <div class="no-print d-flex align-items-center gap-2">
            <button class="btn btn-primary btn-sm" onclick="window.print()">PDF</button>
            <button id="btnPrintIndividual" class="btn btn-outline-secondary btn-sm">PDF(개별)</button>
            <button id="btnPortrait" class="btn btn-primary btn-sm">세로보기</button>
            <button id="btnLandscape" class="btn btn-outline-primary btn-sm">가로보기</button>
        </div>
    </div>

    <script>
        window.PRINT_MEMBERS = [];
            {{#members}}
            window.PRINT_MEMBERS.push({
                id: {{id}}, name: "{{name}}", phone: "{{phone}}"
            });
            {{/members}}

        window.PRINT_CONFIG = {
            weekStartIso: "{{weekStartIso}}",
            weekEndIso: "{{weekEndIso}}",
            slotMinutes: {{slotMinutes}}
        };
    </script>

    <table id="printTable">
        <thead>
        <tr>
            <th style="width:70px;">시간</th>
            <th>월</th><th>화</th><th>수</th>
            <th>목</th><th>금</th><th>토</th><th>일</th>
        </tr>
        </thead>
        <tbody id="printTableBody"></tbody>
    </table>
</div>


<script>
    /* ========== 화면 방향 전환 ========== */
    function setOrientation(mode) {
        const c = document.getElementById("printContainer");
        const bp = document.getElementById("btnPortrait");
        const bl = document.getElementById("btnLandscape");

        if (!c || !bp || !bl) return;

        if (mode === "landscape") {
            c.classList.remove("portrait-mode");
            c.classList.add("landscape-mode");

            bl.classList.remove("btn-outline-primary");
            bl.classList.add("btn-primary");

            bp.classList.remove("btn-primary");
            bp.classList.add("btn-outline-primary");
        } else {
            c.classList.add("portrait-mode");
            c.classList.remove("landscape-mode");

            bp.classList.add("btn-primary");
            bp.classList.remove("btn-outline-primary");

            bl.classList.add("btn-outline-primary");
            bl.classList.remove("btn-primary");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("btnPortrait").onclick   = () => setOrientation("portrait");
        document.getElementById("btnLandscape").onclick  = () => setOrientation("landscape");
        const btnInd = document.getElementById("btnPrintIndividual");
        if (btnInd) {
            btnInd.onclick = () => {
                if (window.printIndividualSchedules) {
                    window.printIndividualSchedules();
                } else {
                    alert("데이터 로딩 후 다시 시도해 주세요.");
                }
            };
        }
        setOrientation("portrait");
    });


    /* ========== 데이터 렌더링 + 개별 PDF 출력 ========== */
    (function () {
        const API_BASE = "/api/schedule/work";
        const HOUR_START = 6, HOUR_END = 22;

        const members = window.PRINT_MEMBERS || [];
        const cfg = window.PRINT_CONFIG || {};

        const weekStart = isoToDate(cfg.weekStartIso);
        const weekEnd   = isoToDate(cfg.weekEndIso);
        const weekDates = Array.from({ length: 7 }, (_, i) =>
                toIso(addDays(weekStart, i))
        );

        const slotMinutes = cfg.slotMinutes;
        const totalStartMin = HOUR_START * 60;
        const totalEndMin   = HOUR_END * 60;

        const slots = [];
        for (let t = totalStartMin; t < totalEndMin; t += slotMinutes) {
            slots.push({ start: t, end: t + slotMinutes });
        }

        const slotData = slots.map(() => Array.from({ length: 7 }, () => new Set()));

        (async function () {
            await Promise.all(members.map(async (m) => {
                const url = `${API_BASE}/${m.id}/${cfg.weekStartIso}/${cfg.weekEndIso}`;
                const resp = await fetch(url, { headers: { "Accept": "application/json" } });
                if (!resp.ok) return;

                const dayMap = normalizeDays(await resp.json());

                weekDates.forEach((iso, idx) => {
                    const day = dayMap[iso];
                    if (!day) return;
                    (day.segments || []).forEach(seg => {
                        const s = hmToMin(seg.start);
                        const e = hmToMin(seg.end);
                        slots.forEach((slot, si) => {
                            if (e > slot.start && s < slot.end) slotData[si][idx].add(m.id);
                        });
                    });
                });
            }));

            renderTable();

            // 전역에서 사용할 수 있게 개별 출력 함수 노출
            window.printIndividualSchedules = function () {
                printIndividualPdf(members, slots, slotData, weekDates, cfg);
            };
        })();

        function renderTable() {
            const tbody = document.getElementById("printTableBody");
            tbody.innerHTML = "";

            slots.forEach((slot, si) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<th>${minToHm(slot.start)}</th>`;

                for (let d = 0; d < 7; d++) {
                    const td = document.createElement("td");
                    td.classList.add("slot-cell");

                    const ids = Array.from(slotData[si][d]);
                    if (ids.length > 0) td.classList.add("slot-has-work");

                    td.innerHTML = ids.map(id => {
                        const m = members.find(x => String(x.id) === String(id));
                        if (!m) return "";
                        const color = colorFor(m.id);
                        return `
                            <span class="staff-tag">
                                <span class="staff-dot" style="background:${color}"></span>
                                <span class="staff-name">${escapeHtml(m.name)}</span>
                            </span>
                        `;
                    }).join("");

                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            });
        }

        /* ====== 개별 일정용 PDF 출력 ====== */
        function printIndividualPdf(members, slots, slotData, weekDates, cfg) {
            if (!members || members.length === 0) {
                alert("출력할 근무자가 없습니다.");
                return;
            }
            const win = window.open("", "_blank");
            if (!win) {
                alert("팝업이 차단되었습니다. 브라우저 팝업 허용 후 다시 시도해 주세요.");
                return;
            }

            const doc = win.document;
            doc.open();
            doc.write("<!doctype html><html><head><meta charset='utf-8'><title>개별 주간근무표</title>");
            doc.write("<style>");
            doc.write("body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif;font-size:12px;margin:16px;}");
            doc.write("h2{margin:16px 0 8px;font-size:18px;border-bottom:1px solid #e5e7eb;padding-bottom:4px;}");
            doc.write("h3{margin:8px 0 4px;font-size:14px;color:#374151;}");
            doc.write("table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:11px;margin-bottom:24px;}");
            doc.write("th,td{border:1px solid #d1d5db;padding:4px 3px;text-align:center;vertical-align:middle;}");
            doc.write("thead th{background:#e5e7eb;font-weight:700;}");
            doc.write("thead th:first-child{background:#f3f4f6;font-weight:700;}");
            doc.write(".slot-cell{height:20px;background:#f9fafb;}");
            doc.write(".slot-on{background:#bfdbfe !important;}");
            doc.write(".day-label{font-size:11px;color:#4b5563;margin-bottom:4px;}");
            doc.write("@media print{table th,table td{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}");
            doc.write("</style></head><body>");

            const weekTitle = `${cfg.weekStartIso} ~ ${cfg.weekEndIso}`;
            doc.write(`<h2>개별 주간근무표 (${weekTitle})</h2>`);

            const dayNames = ["월","화","수","목","금","토","일"];

            members.forEach(m => {
                const safeName = escapeHtml(m.name || "");
                doc.write(`<h3>${safeName}</h3>`);
                doc.write("<table><thead><tr>");
                doc.write("<th style='width:60px;'>시간</th>");
                for (let d = 0; d < 7; d++) {
                    const iso = weekDates[d] || "";
                    doc.write(`<th>${dayNames[d]}<br><span class='day-label'>${iso}</span></th>`);
                }
                doc.write("</tr></thead><tbody>");

                slots.forEach((slot, si) => {
                    doc.write("<tr>");
                    doc.write(`<th>${minToHm(slot.start)}</th>`);
                    for (let d = 0; d < 7; d++) {
                        const hasWork = slotData[si][d].has(m.id);
                        const cls = hasWork ? "slot-cell slot-on" : "slot-cell";
                        doc.write(`<td class='${cls}'>${hasWork ? "●" : ""}</td>`);
                    }
                    doc.write("</tr>");
                });

                doc.write("</tbody></table>");
            });

            doc.write("</body></html>");
            doc.close();
            win.focus();
            win.print();
        }

        /* ==== UTIL ==== */
        function isoToDate(i){ const [y,m,d]=i.split("-"); return new Date(y,m-1,d); }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
        function toIso(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
        function pad2(n){ return String(n).padStart(2,"0"); }

        function hmToMin(hm){ const [h,m]=hm.split(":").map(Number); return h*60+m; }
        function minToHm(min){ return `${pad2(Math.floor(min/60))}:${pad2(min%60)}`; }

        function normalizeDays(data){
            const map={};
            if (data?.days) data.days.forEach(d=> map[d.date]={segments:d.segments||[]});
            else if (Array.isArray(data)) data.forEach(d=> map[d.date]={segments:d.segments||[]});
            else Object.keys(data||{}).forEach(k=> map[k]={segments:data[k].segments||[]});
            return map;
        }

        function colorFor(id){
            const h = (seeded(id) % 360);
            return hsl(h,65,65);
        }

        function seeded(s){
            let h=2166136261; s=String(s);
            for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619); }
            return h>>>0;
        }

        function hsl(h,s,l){
            s/=100; l/=100;
            const c=(1-Math.abs(2*l-1))*s;
            const x=c*(1-Math.abs((h/60)%2-1));
            const m=l-c/2;
            let r=0,g=0,b=0;
            if(h<60){r=c;g=x;}
            else if(h<120){r=x;g=c;}
            else if(h<180){g=c;b=x;}
            else if(h<240){g=x;b=c;}
            else if(h<300){r=x;b=c;}
            else{r=c;b=x;}
            const toHex=v=>Math.round((v+m)*255).toString(16).padStart(2,"0");
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        function escapeHtml(s){
            return String(s ?? "").replace(/[&<>"]/g, c=>({
                "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"
            }[c]));
        }

    })();
</script>

{{>layouts/footer}}
