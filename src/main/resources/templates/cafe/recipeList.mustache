{{>layouts/header}}

<style>
    body {
        background-color: #f8f9fa;
    }

    .table-wrapper {
        border-radius: 1rem;
        overflow: hidden;
        border: 1px solid #dee2e6;
        background-color: #ffffff;
    }

    /* í…Œì´ë¸” í—¤ë” ë…¹ìƒ‰ */
    .table-rounded thead th {
        border-bottom-width: 1px;
        background-color: #198754;
        color: #ffffff;
        border-color: #198754;
        font-weight: 600;
    }

    .table-rounded thead th:first-child {
        border-top-left-radius: 1rem;
    }

    .table-rounded thead th:last-child {
        border-top-right-radius: 1rem;
    }

    .category-cell {
        background-color: #e7f5ff;
    }

    .category-badge {
        font-size: 0.9rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background-color: #fff;
        color: #000;
        display: inline-block;
        border: 2px solid #000;
        font-weight: 600;
    }

    /* ë ˆì‹œí”¼ pill */
    .recipe-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.45rem 2.6rem 0.45rem 1rem; /* ì˜¤ë¥¸ìª½ ì•„ì´ì½˜ ì—¬ìœ  */
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        border: 2px solid #dee2e6;
        background-color: #ffffff;
        transition: all 0.15s ease;
        font-size: 0.95rem;
        position: relative;
    }

    .menu-name-text {
        margin-right: 0.35rem;
    }

    /* ì„ íƒ ì‹œ ì•„ì´ì½˜ ê·¸ë£¹ (ì—°í•„ + ì‚­ì œ) */
    .pill-icon-group {
        position: absolute;
        right: 0.55rem;
        top: 50%;
        transform: translateY(-50%);
        display: none;               /* ì„ íƒ ì‹œì—ë§Œ ë³´ì„ */
        gap: 0.2rem;
        align-items: center;
    }

    .recipe-pill.selected .pill-icon-group {
        display: inline-flex;
    }

    .pill-edit-icon,
    .pill-delete-icon {
        font-size: 1.2rem;
        cursor: pointer;
        line-height: 1;
        color: #ffffff;
        background-color: rgba(0, 0, 0, 0.45);
        padding: 0.05rem 0.4rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .pill-delete-icon {
        background-color: rgba(220, 53, 69, 0.7); /* ì‚­ì œëŠ” ì•½ê°„ ë¶‰ì€ í†¤ */
    }

    /* ìƒíƒœ í‘œì‹œ ì› (visible/template ê³µí†µ) */
    .star-icon {
        margin-right: 0.35rem;
        width: 1.4rem;
        height: 1.4rem;
        border-radius: 999px;
        border: 2px solid transparent;
        background-color: transparent;
        box-sizing: border-box;
        font-size: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .star-icon::before {
        content: "â˜…";
        font-size: 0.85rem;
        line-height: 1;
        color: #ffffff;
        display: block;
        text-align: center;
    }

    /* visible == true */
    .star-visible {
        background-color: #fd7e14;
        border-color: #fd7e14;
        animation: starBorderBlinkOrange 1.2s ease-in-out infinite;
    }

    /* template == true */
    .star-template {
        background-color: #198754;
        border-color: #198754;
        animation: starBorderBlinkGreen 1.2s ease-in-out infinite;
    }

    @keyframes starBorderBlinkOrange {
        0%   { box-shadow: 0 0 0 0 rgba(253,126,20,0.7); }
        50%  { box-shadow: 0 0 0 6px rgba(253,126,20,0); }
        100% { box-shadow: 0 0 0 0 rgba(253,126,20,0); }
    }

    @keyframes starBorderBlinkGreen {
        0%   { box-shadow: 0 0 0 0 rgba(25,135,84,0.7); }
        50%  { box-shadow: 0 0 0 6px rgba(25,135,84,0); }
        100% { box-shadow: 0 0 0 0 rgba(25,135,84,0); }
    }

    /* OFF ìƒíƒœ */
    .star-visible-off,
    .star-template-off {
        display: none;
        background-color: #ffffff;
    }

    .star-visible-off {
        border-color: #fd7e14;
    }
    .star-template-off {
        border-color: #198754;
    }

    .star-visible-off::before {
        content: "â˜…";
        color: #fd7e14;
    }

    .star-template-off::before {
        content: "â˜…";
        color: #198754;
    }

    /* pill ì„ íƒ ì‹œ OFF ë³„ í‘œì‹œ */
    .recipe-pill.selected .star-visible-off,
    .recipe-pill.selected .star-template-off {
        display: inline-flex;
    }

    .recipe-pill[data-temp="HOT"] {
        border-color: #dc3545;
    }
    .recipe-pill[data-temp="ICE"] {
        border-color: #0d6efd;
    }

    .recipe-pill.selected[data-temp="HOT"] {
        background-color: #dc3545;
        color: #fff;
        border-color: #b02a37;
    }
    .recipe-pill.selected[data-temp="ICE"] {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0a58ca;
    }

    .recipe-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.25rem 0.6rem rgba(0, 0, 0, 0.1);
    }

    /* visible ê¹œë¹¡ì„ */
    .recipe-pill.visible-blink {
        animation: visibleBlink 1.3s ease-in-out infinite;
    }

    @keyframes visibleBlink {
        0%   { box-shadow: 0 0 0 0 rgba(13,110,253,0.5); }
        50%  { box-shadow: 0 0 0 6px rgba(13,110,253,0); }
        100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); }
    }

    /* íŒì—… ìŠ¤íƒ€ì¼ */
    #recipeDetailModal .modal-dialog {
        max-width: 1200px;
        width: 95%;
    }

    #recipeDetailModal .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25);
        max-height: 90vh;
    }

    #recipeDetailModal .modal-title {
        font-size: 2.4rem;
        font-weight: 700;
    }

    #recipeDetailModal .modal-body {
        font-size: 2.4rem;
        max-height: 80vh;
        overflow-y: auto;
    }

    #recipeDetailMeta {
        font-size: 2rem !important;
    }

    #recipe-steps-content {
        padding-right: 0.5rem;
    }

    /* íŒì—… ë‚´ ìŠ¤í… ì¹´ë“œ */
    .recipe-step {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.1rem 1.4rem;
        margin-bottom: 1rem;
        box-shadow: 0 0.35rem 0.8rem rgba(0, 0, 0, 0.08);
        border-left: 6px solid #0d6efd;
        font-size: 2.7rem;
        line-height: 1.45;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .step-index {
        font-weight: 900;
        margin-right: 0.9rem;
    }

    .step-text {
        display: inline-block;
        vertical-align: middle;
    }

    /* ê³„ë‹¨ íš¨ê³¼ */
    #recipe-steps-content .recipe-step:nth-child(2) { margin-left: 18px; }
    #recipe-steps-content .recipe-step:nth-child(3) { margin-left: 36px; }
    #recipe-steps-content .recipe-step:nth-child(4) { margin-left: 54px; }
    #recipe-steps-content .recipe-step:nth-child(5) { margin-left: 72px; }
    #recipe-steps-content .recipe-step:nth-child(6) { margin-left: 90px; }
    #recipe-steps-content .recipe-step:nth-child(7) { margin-left: 108px; }

    .recipe-step.step-selected {
        background-color: #0d6efd;
        color: #fff;
        box-shadow: 0 0.35rem 0.9rem rgba(13,110,253,0.45);
    }

    .recipe-step.empty-step {
        border-left-color: #adb5bd;
        color: #6c757d;
    }
</style>


<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-0">â˜• ë ˆì‹œí”¼ ëª©ë¡</h3>
            <div class="text-muted small mt-1">ë”ë¸”í´ë¦­í•˜ë©´ ìƒì„¸ ë ˆì‹œí”¼ê°€ íŒì—…ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.</div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="location.href='/cafe/recipe/new'">ë ˆì‹œí”¼ ë§Œë“¤ê¸°</button>
            <button class="btn btn-outline-primary btn-sm" id="btn-edit-recipe" disabled>ìˆ˜ì •í•˜ê¸°</button>
        </div>
    </div>

    <div class="table-wrapper shadow-sm">
        <table class="table table-rounded mb-0 align-middle">
            <thead>
            <tr>
                <th style="width: 25%;">ì¹´í…Œê³ ë¦¬</th>
                <th>ë ˆì‹œí”¼</th>
            </tr>
            </thead>

            <tbody id="recipe-table-body">

            {{#recipeGroups}}
                <tr>
                    <td class="category-cell">
                        <span class="category-badge">{{categoryLabel}}</span>
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-2">

                            {{#recipes}}
                                <div class="recipe-pill-wrapper" data-id="{{id}}" data-name="{{menuName}}">
                                    <span class="recipe-pill {{#visible}}visible-blink{{/visible}}"
                                          data-temp="{{temperature}}">

                                        {{#visible}}
                                            <span class="star-icon star-visible" title="ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ¨ê¸°ê¸°"></span>
                                        {{/visible}}
                                        {{^visible}}
                                            <span class="star-icon star-visible-off" title="ëŒ€ì‹œë³´ë“œì— í‘œì‹œí•˜ê¸°"></span>
                                        {{/visible}}

                                        {{#template}}
                                            <span class="star-icon star-template" title="í…œí”Œë¦¿ í•´ì œ"></span>
                                        {{/template}}
                                        {{^template}}
                                            <span class="star-icon star-template-off" title="í…œí”Œë¦¿ìœ¼ë¡œ ì„¤ì •"></span>
                                        {{/template}}

                                        <span class="menu-name-text">{{menuName}}</span>

                                        <!-- âœ + ğŸ—‘ ì•„ì´ì½˜ ê·¸ë£¹ -->
                                        <span class="pill-icon-group">
                                            <span class="pill-edit-icon" title="ë ˆì‹œí”¼ ìˆ˜ì •í•˜ê¸°">âœ</span>
                                            <span class="pill-delete-icon" title="ë ˆì‹œí”¼ ì‚­ì œí•˜ê¸°">ğŸ—‘</span>
                                        </span>
                                    </span>

                                    <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                        <div class="recipe-steps-wrapper">
                                            {{#steps}}
                                                <div class="recipe-step" data-step="{{stepOrder}}">
                                                    <span class="step-index">Step {{stepOrder}}.</span>
                                                    <span class="step-text">{{content}}</span>
                                                </div>
                                            {{/steps}}
                                            {{^steps}}
                                                <div class="recipe-step empty-step">
                                                    <span class="step-index">Step 1.</span>
                                                    <span class="step-text text-muted">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                                </div>
                                            {{/steps}}
                                        </div>
                                    </div>
                                </div>
                            {{/recipes}}

                        </div>
                    </td>
                </tr>
            {{/recipeGroups}}

            {{^recipeGroups}}
                <tr>
                    <td colspan="2" class="text-center py-4 text-muted">
                        ë“±ë¡ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                </tr>
            {{/recipeGroups}}

            </tbody>
        </table>
    </div>
</div>


<!-- íŒì—… -->
<div class="modal fade" id="recipeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-3">

            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="recipeDetailModalLabel">ë ˆì‹œí”¼ ìƒì„¸</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="recipeDetailMeta" class="mb-3 text-muted"></div>
                <div id="recipe-steps-content"></div>
            </div>

            <div class="modal-footer">
                <button id="modal-edit-btn" class="btn btn-outline-primary btn-lg">
                    ì´ ë ˆì‹œí”¼ ìˆ˜ì •í•˜ê¸°
                </button>
                <button class="btn btn-secondary btn-lg" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>

        </div>
    </div>
</div>


<script>
    (function () {
        const tableBody = document.getElementById("recipe-table-body");
        const pillWrappers = tableBody.querySelectorAll(".recipe-pill-wrapper");

        const editBtn = document.getElementById("btn-edit-recipe");
        const modalEditBtn = document.getElementById("modal-edit-btn");

        let selectedRecipeId = null;

        // âœ… visible ë³€ê²½ í˜¸ì¶œ
        async function updateRecipeVisible(recipeId, visible) {
            try {
                const res = await fetch("/api/cafe/recipe/" + recipeId + "/visible/" + visible, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ visible: visible })
                });

                if (!res.ok) {
                    alert("visible ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (" + res.status + ")");
                    return;
                }

                location.reload();
            } catch (e) {
                console.error(e);
                alert("visible ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // âœ… template ë³€ê²½ í˜¸ì¶œ
        async function updateRecipeTemplate(recipeId, template) {
            try {
                const res = await fetch("/api/cafe/recipe/" + recipeId + "/template/" + template, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ template: template })
                });

                if (!res.ok) {
                    alert("template ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (" + res.status + ")");
                    return;
                }

                location.reload();
            } catch (e) {
                console.error(e);
                alert("template ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // âœ… ë ˆì‹œí”¼ ì‚­ì œ í˜¸ì¶œ
        async function deleteRecipe(recipeId, recipeName) {
            const ok = confirm(
                    `"${recipeName}" ë ˆì‹œí”¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
            );
            if (!ok) return;

            try {
                const res = await fetch("/api/cafe/recipe/" + recipeId + "/delete", {
                    method: "POST"
                    // CSRF í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í—¤ë” ì¶”ê°€
                });

                if (!res.ok && res.status !== 204) {
                    alert("ë ˆì‹œí”¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (" + res.status + ")");
                    return;
                }

                // ì„±ê³µ ì‹œ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } catch (e) {
                console.error(e);
                alert("ë ˆì‹œí”¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function clearSelection() {
            tableBody
                    .querySelectorAll(".recipe-pill")
                    .forEach(p => p.classList.remove("selected"));
            selectedRecipeId = null;
            editBtn.disabled = true;
        }

        function selectRecipe(wrapper) {
            clearSelection();
            const pill = wrapper.querySelector(".recipe-pill");
            if (!pill) return;
            pill.classList.add("selected");
            selectedRecipeId = wrapper.dataset.id;
            editBtn.disabled = false;
        }

        function attachStepClickHandlers() {
            const container = document.getElementById("recipe-steps-content");
            if (!container) return;

            const steps = container.querySelectorAll(".recipe-step");
            steps.forEach(step => {
                step.addEventListener("click", () => {
                    steps.forEach(s => s.classList.remove("step-selected"));
                    step.classList.add("step-selected");
                });
            });
        }

        pillWrappers.forEach(wrapper => {
            const pill = wrapper.querySelector(".recipe-pill");
            if (!pill) return;

            const inlineEditIcon = wrapper.querySelector(".pill-edit-icon");
            const inlineDeleteIcon = wrapper.querySelector(".pill-delete-icon");

            const visibleStarOn  = wrapper.querySelector(".star-visible");
            const visibleStarOff = wrapper.querySelector(".star-visible-off");
            const templateStarOn  = wrapper.querySelector(".star-template");
            const templateStarOff = wrapper.querySelector(".star-template-off");

            /* pill í´ë¦­ = ì„ íƒ í† ê¸€ */
            pill.addEventListener("click", e => {
                e.stopPropagation();
                if (selectedRecipeId === wrapper.dataset.id) {
                    clearSelection();
                } else {
                    selectRecipe(wrapper);
                }
            });

            /* ì¸ë¼ì¸ ì—°í•„ ì•„ì´ì½˜ í´ë¦­ = ìˆ˜ì • í˜ì´ì§€ ì´ë™ */
            if (inlineEditIcon) {
                inlineEditIcon.addEventListener("click", e => {
                    e.stopPropagation();
                    const id = wrapper.dataset.id;
                    if (id) {
                        location.href = "/cafe/recipe/" + id + "/edit";
                    }
                });
            }

            /* ğŸ—‘ ì‚­ì œ ì•„ì´ì½˜ í´ë¦­ = confirm â†’ ì‚­ì œ API í˜¸ì¶œ */
            if (inlineDeleteIcon) {
                inlineDeleteIcon.addEventListener("click", e => {
                    e.stopPropagation();
                    const id = wrapper.dataset.id;
                    const name = wrapper.dataset.name || "";
                    if (!id) return;
                    deleteRecipe(id, name);
                });
            }

            /* visible == true ë³„ ì•„ì´ì½˜ í´ë¦­ ì‹œ: visible=false */
            if (visibleStarOn) {
                visibleStarOn.addEventListener("click", e => {
                    e.stopPropagation();

                    const id = wrapper.dataset.id;
                    const name = wrapper.dataset.name || "";

                    const ok = confirm(
                            `"${name}" ë ˆì‹œí”¼ë¥¼ ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ì´ì§€ ì•Šê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(visible = falseë¡œ ë³€ê²½ë©ë‹ˆë‹¤)`
                    );
                    if (!ok) return;

                    if (id) {
                        updateRecipeVisible(id, false);
                    }
                });
            }

            /* visible == false OFF ë³„ í´ë¦­: visible=true */
            if (visibleStarOff) {
                visibleStarOff.addEventListener("click", e => {
                    e.stopPropagation();

                    const id = wrapper.dataset.id;
                    const name = wrapper.dataset.name || "";

                    const ok = confirm(
                            `"${name}" ë ˆì‹œí”¼ë¥¼ ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ì´ë„ë¡ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(visible = trueë¡œ ë³€ê²½ë©ë‹ˆë‹¤)`
                    );
                    if (!ok) return;

                    if (id) {
                        updateRecipeVisible(id, true);
                    }
                });
            }

            /* template == true ë³„ ì•„ì´ì½˜ í´ë¦­ ì‹œ: template=false */
            if (templateStarOn) {
                templateStarOn.addEventListener("click", e => {
                    e.stopPropagation();

                    const id = wrapper.dataset.id;
                    const name = wrapper.dataset.name || "";

                    const ok = confirm(
                            `"${name}" ë ˆì‹œí”¼ë¥¼ í…œí”Œë¦¿ì—ì„œ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(template = falseë¡œ ë³€ê²½ë©ë‹ˆë‹¤)`
                    );
                    if (!ok) return;

                    if (id) {
                        updateRecipeTemplate(id, false);
                    }
                });
            }

            /* template == false OFF ë³„ í´ë¦­: template=true */
            if (templateStarOff) {
                templateStarOff.addEventListener("click", e => {
                    e.stopPropagation();

                    const id = wrapper.dataset.id;
                    const name = wrapper.dataset.name || "";

                    const ok = confirm(
                            `"${name}" ë ˆì‹œí”¼ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(template = trueë¡œ ë³€ê²½ë©ë‹ˆë‹¤)`
                    );
                    if (!ok) return;

                    if (id) {
                        updateRecipeTemplate(id, true);
                    }
                });
            }

            /* ë”ë¸”í´ë¦­ = íŒì—… ì˜¤í”ˆ */
            pill.addEventListener("dblclick", e => {
                e.stopPropagation();

                selectRecipe(wrapper);

                const id = wrapper.dataset.id;
                const name = wrapper.dataset.name;
                const stepsHtml = document.getElementById("recipe-steps-" + id)?.innerHTML;

                document.getElementById("recipeDetailModalLabel").innerText = name;
                document.getElementById("recipe-steps-content").innerHTML =
                        stepsHtml ? stepsHtml : "<p>ìŠ¤í… ì—†ìŒ</p>";

                const modal = new bootstrap.Modal(document.getElementById("recipeDetailModal"));
                modal.show();

                attachStepClickHandlers();

                /* íŒì—… ì—´ë¦´ ë•Œ 1 ìŠ¤í… ìë™ ì„ íƒ */
                setTimeout(() => {
                    const firstStep = document.querySelector("#recipe-steps-content .recipe-step");
                    if (firstStep) {
                        document
                                .querySelectorAll("#recipe-steps-content .recipe-step")
                                .forEach(s => s.classList.remove("step-selected"));
                        firstStep.classList.add("step-selected");
                    }
                }, 50);
            });
        });

        /* ìƒë‹¨ ìˆ˜ì • ë²„íŠ¼ */
        editBtn.addEventListener("click", () => {
            if (selectedRecipeId) {
                location.href = "/cafe/recipe/" + selectedRecipeId + "/edit";
            }
        });

        /* íŒì—… í•˜ë‹¨ 'ì´ ë ˆì‹œí”¼ ìˆ˜ì •í•˜ê¸°' ë²„íŠ¼ */
        modalEditBtn.addEventListener("click", () => {
            if (selectedRecipeId) {
                location.href = "/cafe/recipe/" + selectedRecipeId + "/edit";
            }
        });
    })();
</script>

{{>layouts/footer}}
