{{>layouts/header}}

<style>
    body {
        background-color: #f8f9fa;
    }

    .table-wrapper {
        border-radius: 1rem;
        overflow: hidden;
        border: 1px solid #dee2e6;
        background-color: #ffffff;
    }

    /* 테이블 헤더 녹색 */
    .table-rounded thead th {
        border-bottom-width: 1px;
        background-color: #198754;
        color: #ffffff;
        border-color: #198754;
        font-weight: 600;
    }

    .table-rounded thead th:first-child {
        border-top-left-radius: 1rem;
    }

    .table-rounded thead th:last-child {
        border-top-right-radius: 1rem;
    }

    /* 카테고리 영역 */
    .category-cell {
        background-color: #e7f5ff;
    }

    .category-badge {
        font-size: 0.9rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background-color: #fff;
        color: #000;
        display: inline-block;
        border: 2px solid #000;
        font-weight: 600;
    }

    /* 레시피 pill 기본 */
    .recipe-pill {
        display: inline-block;
        padding: 0.45rem 1rem;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        border: 2px solid #dee2e6;
        background-color: #ffffff;
        transition: all 0.15s ease;
        font-size: 0.95rem;
    }

    /* 외곽선 색 */
    .recipe-pill[data-temp="HOT"] {
        border-color: #dc3545;
    }
    .recipe-pill[data-temp="ICE"] {
        border-color: #0d6efd;
    }

    /* 선택 시 배경 (요청: 유지) */
    .recipe-pill.selected[data-temp="HOT"] {
        background-color: #dc3545;
        color: #fff;
        border-color: #b02a37;
    }
    .recipe-pill.selected[data-temp="ICE"] {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0a58ca;
    }

    /* hover */
    .recipe-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.25rem 0.6rem rgba(0,0,0,0.1);
    }

    /* visible blink */
    .recipe-pill.visible-blink {
        animation: visibleBlink 1.3s ease-in-out infinite;
    }
    @keyframes visibleBlink {
        0% { box-shadow: 0 0 0 0 rgba(13,110,253,0.5); transform: translateY(0); }
        50% { box-shadow: 0 0 0 6px rgba(13,110,253,0); transform: translateY(-1px); }
        100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); transform: translateY(0); }
    }

    /* -------------------------- */
    /* 팝업 전체 확대 + 1.5배 스타일 */
    /* -------------------------- */

    #recipeDetailModal .modal-dialog {
        max-width: 1200px; /* 가로 더 넓게 */
        width: 95%;
    }

    #recipeDetailModal .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25);
        max-height: 90vh;
    }

    #recipeDetailModal .modal-title {
        font-size: 2.4rem;
        font-weight: 700;
    }

    #recipeDetailModal .modal-body {
        font-size: 2.4rem;
        max-height: 80vh;
        overflow-y: auto;
    }

    #recipeDetailMeta {
        font-size: 2rem !important;
    }

    /* 본문 스텝 카드 스타일 (첫 번째 팝업 스타일) */
    #recipe-steps-content {
        padding-right: 0.5rem;
    }

    .recipe-steps-wrapper {}

    .recipe-step {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.1rem 1.4rem;
        margin-bottom: 1rem;
        box-shadow: 0 0.35rem 0.8rem rgba(0, 0, 0, 0.08);
        border-left: 6px solid #0d6efd;

        font-size: 2.7rem; /* 1.5배 확대 */
        line-height: 1.45;
        cursor: pointer;

        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .step-index {
        font-weight: 900;
        margin-right: 0.9rem;
    }

    .step-text {
        display: inline-block;
        vertical-align: middle;
    }

    /* 계단 효과 */
    .recipe-step:nth-child(2) { margin-left: 18px; }
    .recipe-step:nth-child(3) { margin-left: 36px; }
    .recipe-step:nth-child(4) { margin-left: 54px; }
    .recipe-step:nth-child(5) { margin-left: 72px; }
    .recipe-step:nth-child(6) { margin-left: 90px; }
    .recipe-step:nth-child(7) { margin-left: 108px; }

    .recipe-step.step-selected {
        background-color: #0d6efd;
        color: #fff;
        box-shadow: 0 0.35rem 0.9rem rgba(13,110,253,0.45);
    }

    .recipe-step.empty-step {
        border-left-color: #adb5bd;
        color: #6c757d;
    }
</style>


<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-0">☕ 레시피 목록</h3>
            <div class="text-muted small mt-1">더블클릭하면 상세 레시피가 팝업으로 열립니다.</div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="location.href='/cafe/recipe/new'">레시피 만들기</button>
            <button class="btn btn-outline-primary btn-sm" id="btn-edit-recipe" disabled>수정하기</button>
        </div>
    </div>

    <div class="table-wrapper shadow-sm">
        <table class="table table-rounded mb-0 align-middle">
            <thead>
            <tr>
                <th style="width: 25%;">카테고리</th>
                <th>레시피</th>
            </tr>
            </thead>

            <tbody id="recipe-table-body">

            {{#recipeGroups}}
                <tr>
                    <td class="category-cell">
                        <span class="category-badge">{{categoryLabel}}</span>
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-2">

                            {{#recipes}}
                                <div class="recipe-pill-wrapper" data-id="{{id}}" data-name="{{menuName}}">
                                    <span class="recipe-pill {{#visible}}visible-blink{{/visible}}"
                                          data-temp="{{temperature}}">
                                        {{menuName}}
                                    </span>

                                    <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                        <div class="recipe-steps-wrapper">
                                            {{#steps}}
                                                <div class="recipe-step" data-step="{{stepOrder}}">
                                                    <span class="step-index">Step {{stepOrder}}.</span>
                                                    <span class="step-text">{{content}}</span>
                                                </div>
                                            {{/steps}}
                                            {{^steps}}
                                                <div class="recipe-step empty-step">
                                                    <span class="step-index">Step 1.</span>
                                                    <span class="step-text text-muted">등록된 스텝이 없습니다.</span>
                                                </div>
                                            {{/steps}}
                                        </div>
                                    </div>
                                </div>
                            {{/recipes}}

                        </div>
                    </td>
                </tr>
            {{/recipeGroups}}

            {{^recipeGroups}}
                <tr>
                    <td colspan="2" class="text-center py-4 text-muted">
                        등록된 레시피가 없습니다.
                    </td>
                </tr>
            {{/recipeGroups}}

            </tbody>
        </table>
    </div>
</div>


<!-- 팝업 -->
<div class="modal fade" id="recipeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-3">

            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="recipeDetailModalLabel">레시피 상세</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="recipeDetailMeta" class="mb-3 text-muted"></div>
                <div id="recipe-steps-content"></div>
            </div>

            <div class="modal-footer">
                <button id="modal-edit-btn" class="btn btn-outline-primary btn-lg">
                    이 레시피 수정하기
                </button>
                <button class="btn btn-secondary btn-lg" data-bs-dismiss="modal">닫기</button>
            </div>

        </div>
    </div>
</div>


<script>
    (function () {
        const tableBody = document.getElementById("recipe-table-body");
        const pillWrappers = tableBody.querySelectorAll(".recipe-pill-wrapper");

        const editBtn = document.getElementById("btn-edit-recipe");
        const modalEditBtn = document.getElementById("modal-edit-btn");

        let selectedRecipeId = null;

        function clearSelection() {
            tableBody.querySelectorAll(".recipe-pill").forEach(p => p.classList.remove("selected"));
            selectedRecipeId = null;
            editBtn.disabled = true;
        }

        function selectRecipe(wrapper) {
            clearSelection();
            const pill = wrapper.querySelector(".recipe-pill");
            pill.classList.add("selected");
            selectedRecipeId = wrapper.dataset.id;
            editBtn.disabled = false;
        }

        /* 팝업 내부 스텝 클릭: 선택 상태 */
        function attachStepClickHandlers() {
            const container = document.getElementById("recipe-steps-content");
            if (!container) return;

            const steps = container.querySelectorAll(".recipe-step");

            steps.forEach(step => {
                step.addEventListener("click", () => {
                    steps.forEach(s => s.classList.remove("step-selected"));
                    step.classList.add("step-selected");
                });
            });
        }

        pillWrappers.forEach(wrapper => {
            const pill = wrapper.querySelector(".recipe-pill");

            /* 클릭 = 선택 */
            pill.addEventListener("click", e => {
                e.stopPropagation();
                if (selectedRecipeId === wrapper.dataset.id)
                    clearSelection();
                else
                    selectRecipe(wrapper);
            });

            /* 더블클릭 = 팝업 오픈 */
            pill.addEventListener("dblclick", e => {
                e.stopPropagation();

                selectRecipe(wrapper);

                const id = wrapper.dataset.id;
                const name = wrapper.dataset.name;
                const stepsHtml = document.getElementById("recipe-steps-" + id)?.innerHTML;

                document.getElementById("recipeDetailModalLabel").innerText = name;


                document.getElementById("recipe-steps-content").innerHTML =
                        stepsHtml ? stepsHtml : "<p>스텝 없음</p>";

                const modal = new bootstrap.Modal(document.getElementById("recipeDetailModal"));
                modal.show();

                attachStepClickHandlers();
            });
        });

        /* 수정 버튼 */
        editBtn.addEventListener("click", () => {
            if (selectedRecipeId)
                location.href = "/cafe/recipe/" + selectedRecipeId + "/edit";
        });

        modalEditBtn.addEventListener("click", () => {
            if (selectedRecipeId)
                location.href = "/cafe/recipe/" + selectedRecipeId + "/edit";
        });
    })();
</script>

{{>layouts/footer}}
