{{>layouts/header}}

<style>
    body { background-color:#f8f9fa; }

    .table-wrapper{
        border-radius:1rem; overflow:hidden;
        border:1px solid #dee2e6; background:#fff;
    }

    .table-rounded thead th{
        border-bottom-width:1px;
        background:#198754; color:#fff;
        border-color:#198754; font-weight:600;
    }
    .table-rounded thead th:first-child{ border-top-left-radius:1rem; }
    .table-rounded thead th:last-child{ border-top-right-radius:1rem; }

    .category-cell{ background:#e7f5ff; }

    .category-badge{
        font-size:0.95rem;
        padding:0.42rem 1.0rem;
        border-radius:999px;
        background:#fff;
        color:#000;
        display:inline-block;
        border:2px solid #000;
        font-weight:800;
        letter-spacing:-0.2px;
    }
    .category-badge.cat-ice{ border-color:#0d6efd; color:#0d6efd; }
    .category-badge.cat-hot{ border-color:#dc3545; color:#dc3545; }
    .category-badge.cat-hukdang{ border-color:#111; color:#111; }
    .category-badge.cat-ade{ border-color:#0d6efd; color:#0d6efd; }

    /* =========================
       ✅ (변경) 레시피 목록을 "한 줄씩" 세로 출력
       ========================= */
    .recipe-list-vertical{
        display:flex;
        flex-direction:column;
        gap:0.6rem;              /* 줄 간격 */
    }
    .recipe-pill-wrapper.recipe-line{
        width:100%;
    }

    /* =========================
       ✅ (변경) pill을 한 행(100%)으로
       ========================= */
    .recipe-pill{
        display:flex;            /* inline-flex -> flex */
        align-items:center;
        gap:0.55rem;
        padding:0.55rem 1rem 0.55rem 0.7rem;
        border-radius:999px;
        font-weight:700;
        cursor:pointer;
        white-space:nowrap;
        border:2px solid #dee2e6;
        background:#fff;
        transition:all 0.15s ease;
        font-size:0.98rem;
        user-select:none;
        line-height:1;
        width:100%;              /* ✅ 한 줄 꽉 차게 */
    }
    .recipe-pill[data-temp="HOT"]{ border-color:#dc3545; }
    .recipe-pill[data-temp="ICE"]{ border-color:#0d6efd; }
    .recipe-pill:hover{
        transform:translateY(-1px);
        box-shadow:0 0.25rem 0.6rem rgba(0,0,0,0.1);
    }

    /* =========================
       ✅ pill 좌측 썸네일 이미지
       ========================= */
    .recipe-thumb{
        width:2.2rem;
        height:2.2rem;
        min-width:2.2rem;
        border-radius:0.6rem;
        border:1px solid #dee2e6;
        background:#fff;
        object-fit:contain;
        display:inline-block;
        flex:0 0 auto;
    }
    .recipe-thumb-placeholder{
        width:2.2rem;
        height:2.2rem;
        min-width:2.2rem;
        border-radius:0.6rem;
        border:1px dashed #ced4da;
        background:#ffffff;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        color:#6c757d;
        font-weight:900;
        font-size:0.75rem;
        flex:0 0 auto;
    }

    .cup-badge{
        width:2.0rem;
        height:2.0rem;
        min-width:2.0rem;
        border-radius:999px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        font-weight:900;
        font-size:0.85rem;
        line-height:1;
        border:2px solid #198754;
        color:#198754;
        background:#fff;
        flex:0 0 auto;
    }
    .cup-badge.cup-ice{ border-color:#0d6efd; color:#0d6efd; }
    .cup-badge.cup-hot{ border-color:#dc3545; color:#dc3545; }

    .blender-img-inline{
        height:2.0rem;
        width:auto;
        display:inline-block;
        object-fit:contain;
        vertical-align:middle;
        flex:0 0 auto;
        pointer-events:none;
    }

    .menu-name-text{ font-weight:800; letter-spacing:-0.2px; }

    /* =========================
       ✅ 모달 타이틀 확장 (레시피명 + 블렌더 + 온도 + 컵)
       ========================= */
    .modal-title-wrap{
        display:flex;
        align-items:center;
        gap:0.6rem;
        flex-wrap:wrap;
    }
    .modal-title-name{
        font-size:2.4rem;
        font-weight:900;
        letter-spacing:-0.2px;
        margin-right:0.2rem;
    }

    .meta-chip{
        display:inline-flex;
        align-items:center;
        gap:0.35rem;
        padding:0.25rem 0.75rem;
        border-radius:999px;
        border:2px solid #adb5bd;
        background:#fff;
        font-size:1.2rem;
        font-weight:900;
        line-height:1;
        white-space:nowrap;
    }
    .meta-chip.temp-hot{ border-color:#dc3545; color:#dc3545; }
    .meta-chip.temp-ice{ border-color:#0d6efd; color:#0d6efd; }

    .meta-chip.cup-chip{
        border-color:#198754;
        color:#198754;
    }

    .meta-chip.blender-yes{
        border-color:#dc3545;
        color:#dc3545;
    }
    .meta-chip.blender-no{
        border-color:#6c757d;
        color:#6c757d;
    }

    .blender-img-modal{
        height:4.2rem;
        width:auto;
        object-fit:contain;
        display:inline-block;
        vertical-align:middle;
    }

    #recipeDetailModal .modal-dialog{ max-width:1200px; width:95%; }
    #recipeDetailModal .modal-content{
        border-radius:0.75rem;
        box-shadow:0 0.75rem 1.5rem rgba(0,0,0,0.25);
        max-height:90vh;
    }
    #recipeDetailModal .modal-title{ font-size:2.4rem; font-weight:700; }
    #recipeDetailModal .modal-body{
        font-size:2.4rem;
        max-height:80vh;
        overflow-y:auto;
    }

    /* =========================
       ✅ 모달 상단 이미지 영역
       ========================= */
    .modal-recipe-img{
        width:100%;
        max-height:320px;
        height:auto;
        object-fit:contain;
        border-radius:0.85rem;
        border:1px solid #e9ecef;
        background:#fff;
        margin-bottom:1rem;
        display:block;
    }

    #recipeDetailMeta{ font-size:2rem !important; }
    #recipe-steps-content{ padding-right:0.5rem; }

    .recipe-step{
        position:relative;
        background:#fff;
        border-radius:0.5rem;
        padding:1.1rem 1.4rem;
        margin-bottom:1rem;
        box-shadow:0 0.35rem 0.8rem rgba(0,0,0,0.08);
        border-left:6px solid #0d6efd;
        font-size:2.7rem;
        line-height:1.45;
        cursor:pointer;
        transition:background-color .15s ease, color .15s ease, box-shadow .15s ease;
    }
    .step-index{ font-weight:900; margin-right:0.9rem; }
    .step-text{ display:inline-block; vertical-align:middle; }

    #recipe-steps-content .recipe-step:nth-child(2){ margin-left:18px; }
    #recipe-steps-content .recipe-step:nth-child(3){ margin-left:36px; }
    #recipe-steps-content .recipe-step:nth-child(4){ margin-left:54px; }
    #recipe-steps-content .recipe-step:nth-child(5){ margin-left:72px; }
    #recipe-steps-content .recipe-step:nth-child(6){ margin-left:90px; }
    #recipe-steps-content .recipe-step:nth-child(7){ margin-left:108px; }

    .recipe-step.step-selected{
        background:#0d6efd;
        color:#fff;
        box-shadow:0 0.35rem 0.9rem rgba(13,110,253,0.45);
    }
    .recipe-step.empty-step{
        border-left-color:#adb5bd;
        color:#6c757d;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-0">☕ 레시피 목록</h3>
            <div class="text-muted small mt-1">레시피를 클릭하면 상세 레시피가 팝업으로 열립니다.</div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="location.href='/cafe/recipe/new'">레시피 만들기</button>
        </div>
    </div>

    <div class="table-wrapper shadow-sm">
        <table class="table table-rounded mb-0 align-middle">
            <thead>
            <tr>
                <th style="width: 25%;">카테고리</th>
                <th>레시피</th>
            </tr>
            </thead>

            <tbody id="recipe-table-body">
            {{#recipeGroups}}
                <tr>
                    <td class="category-cell">
                        <span class="category-badge category-badge-js">{{categoryLabel}}</span>
                    </td>
                    <td>
                        <!-- ✅ (변경) 한 행에 한 레시피씩(세로) -->
                        <div class="recipe-list-vertical">
                            {{#recipes}}
                                <div class="recipe-pill-wrapper recipe-line"
                                     data-id="{{id}}"
                                     data-name="{{menuName}}"
                                     data-temp="{{temperature}}"
                                     data-cup="{{cupSize}}"
                                     data-use-blender="{{useBlender}}"
                                     data-imgname="{{imgname}}">

                                    <span class="recipe-pill" data-temp="{{temperature}}">
                                        <!-- ✅ 썸네일: 왼쪽 -->
                                        {{#imgname}}
                                            <img class="recipe-thumb"
                                                 src="/img/{{imgname}}"
                                                 alt="{{menuName}}"
                                                 loading="lazy"
                                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.querySelector('.recipe-thumb-placeholder')?.classList.remove('d-none');">
                                            <span class="recipe-thumb-placeholder d-none">NO</span>
                                        {{/imgname}}
                                        {{^imgname}}
                                            <span class="recipe-thumb-placeholder">NO</span>
                                        {{/imgname}}

                                        <span class="cup-badge cup-badge-js">{{cupSize}}</span>
                                        <span class="menu-name-text">{{menuName}}</span>
                                    </span>

                                    <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                        <div class="recipe-steps-wrapper">
                                            {{#steps}}
                                                <div class="recipe-step" data-step="{{stepOrder}}">
                                                    <span class="step-index">Step {{stepOrder}}.</span>
                                                    <span class="step-text">{{content}}</span>
                                                </div>
                                            {{/steps}}
                                            {{^steps}}
                                                <div class="recipe-step empty-step">
                                                    <span class="step-index">Step 1.</span>
                                                    <span class="step-text text-muted">등록된 스텝이 없습니다.</span>
                                                </div>
                                            {{/steps}}
                                        </div>
                                    </div>
                                </div>
                            {{/recipes}}
                        </div>
                    </td>
                </tr>
            {{/recipeGroups}}

            {{^recipeGroups}}
                <tr>
                    <td colspan="2" class="text-center py-4 text-muted">
                        등록된 레시피가 없습니다.
                    </td>
                </tr>
            {{/recipeGroups}}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="recipeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header">
                <h4 class="modal-title fw-bold" id="recipeDetailModalLabel">레시피 상세</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="recipeDetailImgWrap"></div>

                <div id="recipeDetailMeta" class="mb-3 text-muted"></div>
                <div id="recipe-steps-content"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary btn-lg" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const tableBody = document.getElementById("recipe-table-body");
        if (!tableBody) return;

        const pillWrappers = tableBody.querySelectorAll(".recipe-pill-wrapper");

        function applyCategoryBadgeColors() {
            const badges = document.querySelectorAll(".category-badge-js");
            badges.forEach(badge => {
                const txt = (badge.textContent || "").trim();
                badge.classList.remove("cat-ice","cat-hot","cat-hukdang","cat-ade");

                const lower = txt.toLowerCase();

                if (txt.includes("흑당") || txt.includes("주스") || txt.includes("스무디") || txt.includes("퐁크러쉬")) {
                    badge.classList.add("cat-ice");
                    return;
                }
                if (txt.includes("에이드")) {
                    badge.classList.add("cat-ade");
                    return;
                }
                if (txt.includes("Ice") || txt.includes("ICE") || txt.includes("아이스") || lower.includes("ice")) {
                    badge.classList.add("cat-ice");
                    return;
                }
                if (txt.includes("Hot") || txt.includes("HOT") || txt.includes("핫") || lower.includes("hot")) {
                    badge.classList.add("cat-hot");
                }
            });
        }

        function parseTruth(v) {
            const s = String(v || "").trim().toLowerCase();
            return (s === "true" || s === "1" || s === "y" || s === "yes" || s === "on");
        }

        function normalizeOz(cupText) {
            const raw = String(cupText || "").trim();
            const m = raw.match(/(\d{2})/);
            return m ? (m[1] + "oz") : raw;
        }

        function displayBadgeText(rawCupText) {
            const raw = String(rawCupText || "").trim().toUpperCase();

            if (raw === "L17" || raw === "17L" || raw === "57" || raw === "17") return "1.7";
            if (raw === "L20" || raw === "20L" || raw === "67" || raw === "20") return "2.0";

            const m = raw.match(/(\d{2})/);
            return m ? m[1] : raw;
        }

        function normalizeCupForModal(cupText) {
            const raw = String(cupText || "").trim().toUpperCase();

            if (raw === "L17" || raw === "17" || raw === "17L" || raw === "57") return "1.7L";
            if (raw === "L20" || raw === "20" || raw === "20L" || raw === "67") return "2.0L";

            return normalizeOz(cupText);
        }

        function applyCupBadgeColorsAndBlenderImage() {
            pillWrappers.forEach(wrapper => {
                const temp = (wrapper.dataset.temp || "").toUpperCase();
                const useBlender = parseTruth(wrapper.dataset.useBlender);

                const pill = wrapper.querySelector(".recipe-pill");
                const badge = wrapper.querySelector(".cup-badge-js");
                if (!pill || !badge) return;

                badge.classList.remove("cup-ice","cup-hot");
                if (temp === "ICE") badge.classList.add("cup-ice");
                else if (temp === "HOT") badge.classList.add("cup-hot");

                const rawBadge = (badge.textContent || "").trim();
                badge.textContent = displayBadgeText(rawBadge);

                pill.querySelectorAll(".blender-img-inline").forEach(el => el.remove());

                if (useBlender) {
                    const img = document.createElement("img");
                    img.className = "blender-img-inline";
                    img.alt = "블렌더 사용";
                    img.src = "/img/blender.jpg";
                    badge.insertAdjacentElement("afterend", img);
                }
            });
        }

        function attachStepClickHandlers() {
            const container = document.getElementById("recipe-steps-content");
            if (!container) return;

            const steps = container.querySelectorAll(".recipe-step");
            steps.forEach(step => {
                step.addEventListener("click", () => {
                    steps.forEach(s => s.classList.remove("step-selected"));
                    step.classList.add("step-selected");
                });
            });
        }

        function setModalTitle(name, useBlender, temp, cupRaw) {
            const titleEl = document.getElementById("recipeDetailModalLabel");
            if (!titleEl) return;

            const t = String(temp || "").toUpperCase();
            const cupLabel = normalizeCupForModal(cupRaw);

            titleEl.innerHTML = "";

            const wrap = document.createElement("span");
            wrap.className = "modal-title-wrap";

            const nameSpan = document.createElement("span");
            nameSpan.className = "modal-title-name";
            nameSpan.textContent = name;
            wrap.appendChild(nameSpan);

            const blenderChip = document.createElement("span");
            blenderChip.className = "meta-chip " + (useBlender ? "blender-yes" : "blender-no");
            blenderChip.textContent = useBlender ? "블렌더 사용" : "블렌더 미사용";
            wrap.appendChild(blenderChip);

            if (useBlender) {
                const img = document.createElement("img");
                img.className = "blender-img-modal";
                img.alt = "블렌더 사용";
                img.src = "/img/blender.jpg";
                wrap.appendChild(img);
            }

            const tempChip = document.createElement("span");
            tempChip.className = "meta-chip " + (t === "HOT" ? "temp-hot" : (t === "ICE" ? "temp-ice" : ""));
            tempChip.textContent = t ? t : "TEMP";
            wrap.appendChild(tempChip);

            const cupChip = document.createElement("span");
            cupChip.className = "meta-chip cup-chip";
            cupChip.textContent = cupLabel || "컵";
            wrap.appendChild(cupChip);

            titleEl.appendChild(wrap);
        }

        function setModalImage(imgname, altText) {
            const wrap = document.getElementById("recipeDetailImgWrap");
            if (!wrap) return;

            wrap.innerHTML = "";
            const name = String(imgname || "").trim();
            if (!name) return;

            const img = document.createElement("img");
            img.className = "modal-recipe-img";
            img.src = "/img/" + name;
            img.alt = altText || "레시피 이미지";
            img.loading = "lazy";
            img.onerror = function () {
                wrap.innerHTML = "";
            };
            wrap.appendChild(img);
        }

        function openRecipeModal(wrapper) {
            const id = wrapper.dataset.id;
            const name = wrapper.dataset.name || "레시피 상세";
            const useBlender = parseTruth(wrapper.dataset.useBlender);
            const temp = wrapper.dataset.temp || "";
            const cup = wrapper.dataset.cup || "";
            const imgname = wrapper.dataset.imgname || "";

            const stepsHtml = document.getElementById("recipe-steps-" + id)?.innerHTML;

            setModalTitle(name, useBlender, temp, cup);
            setModalImage(imgname, name);

            document.getElementById("recipe-steps-content").innerHTML =
                    stepsHtml ? stepsHtml : "<p>스텝 없음</p>";

            const modalEl = document.getElementById("recipeDetailModal");
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            attachStepClickHandlers();

            setTimeout(() => {
                const firstStep = document.querySelector("#recipe-steps-content .recipe-step");
                if (firstStep) {
                    document.querySelectorAll("#recipe-steps-content .recipe-step")
                            .forEach(s => s.classList.remove("step-selected"));
                    firstStep.classList.add("step-selected");
                }
            }, 50);
        }

        pillWrappers.forEach(wrapper => {
            const pill = wrapper.querySelector(".recipe-pill");
            if (!pill) return;

            pill.addEventListener("click", e => {
                e.stopPropagation();
                openRecipeModal(wrapper);
            });
        });

        applyCategoryBadgeColors();
        applyCupBadgeColorsAndBlenderImage();
    })();
</script>

{{>layouts/footer}}
