{{>layouts/header}}

<style>
    body {
        background-color: #f8f9fa;
    }

    .card-count-badge {
        font-size: 0.85rem;
    }

    /* ì¹´í…Œê³ ë¦¬ ì¹© ìŠ¤íƒ€ì¼ */
    .category-chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .category-chip {
        border-radius: 999px;
        border: 1px solid #dee2e6;
        background-color: #ffffff;
        padding: 0.35rem 0.9rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.1s ease, color 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
        white-space: nowrap;
    }

    .category-chip:hover {
        background-color: #f1f3f5;
    }

    .category-chip.selected {
        background-color: #0d6efd;
        color: #ffffff;
        border-color: #0d6efd;
        box-shadow: 0 0.3rem 0.7rem rgba(13, 110, 253, 0.35);
    }

    /* HOT / ICE, ì»µ ì‚¬ì´ì¦ˆìš© ë²„íŠ¼ ê·¸ë£¹ ì•½ê°„ í¬ê²Œ */
    .temp-group .btn,
    .cup-group .btn {
        min-width: 80px;
    }

    .temp-group .btn-outline-danger,
    .temp-group .btn-outline-primary {
        font-weight: 600;
    }

    /* âœ… ë ˆì‹œí”¼ ê¸°ë³¸ì •ë³´(ìœ„ìª½ í…Œì´ë¸” ëŠë‚Œ ì˜ì—­) ë¼ìš´ë“œ ë ‰íŠ¸ */
    .form-wrapper {
        border-radius: 1rem;
        border: 2px solid #fd7e14;     /* ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ */
        padding: 1rem 1.25rem;
        background-color: #ffffff;
        margin-bottom: 1rem;
    }

    /* âœ… ë ˆì‹œí”¼ ë‹¨ê³„ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ë¼ìš´ë“œ ë ‰íŠ¸ (ì£¼í™©ìƒ‰ í…Œë‘ë¦¬) */
    .step-wrapper {
        border-radius: 1rem;
        border: 2px solid #fd7e14; /* ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ */
        padding: 0.75rem 0.75rem 0.25rem;
        background-color: #ffffff;
    }

    /* ğŸ”¢ Step ì˜† ì´ˆ ì…ë ¥ UI */
    .step-time-group {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        margin-left: 0.75rem;
    }

    .step-time-input {
        width: 70px;
        padding: 0.1rem 0.35rem;
        font-size: 0.8rem;
        text-align: right;
    }

    .step-time-label {
        font-size: 0.8rem;
        color: #6c757d;
        white-space: nowrap;
    }

    /* ==============================
       ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼
       (ëª©ë¡ í˜ì´ì§€ íŒì—… ëŠë‚Œìœ¼ë¡œ)
       ============================== */

    #recipePreviewModal .modal-dialog {
        max-width: 1200px;
        width: 95%;
    }

    #recipePreviewModal .modal-content {
        border-radius: 0.75rem;
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25);
        max-height: 90vh;
    }

    #recipePreviewModal .modal-body {
        font-size: 2.4rem;
        max-height: 80vh;
        overflow-y: auto;
    }

    #recipePreviewMeta {
        font-size: 2rem !important;
    }

    #recipe-steps-content {
        padding-right: 0.5rem;
    }

    /* íŒì—… ë‚´ ìŠ¤í… ì¹´ë“œ (ê³„ë‹¨ í˜•íƒœ + ì„ íƒ ìŠ¤íƒ€ì¼) */
    .recipe-step {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.1rem 1.4rem;
        margin-bottom: 1rem;
        box-shadow: 0 0.35rem 0.8rem rgba(0, 0, 0, 0.08);
        border-left: 6px solid #0d6efd;

        font-size: 2.7rem;
        line-height: 1.45;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .step-index {
        font-weight: 900;
        margin-right: 0.9rem;
    }

    .step-text {
        display: inline-block;
        vertical-align: middle;
    }

    /* ğŸ”¹ ê³„ë‹¨ íš¨ê³¼ */
    #recipe-steps-content .recipe-step:nth-child(2) { margin-left: 18px; }
    #recipe-steps-content .recipe-step:nth-child(3) { margin-left: 36px; }
    #recipe-steps-content .recipe-step:nth-child(4) { margin-left: 54px; }
    #recipe-steps-content .recipe-step:nth-child(5) { margin-left: 72px; }
    #recipe-steps-content .recipe-step:nth-child(6) { margin-left: 90px; }
    #recipe-steps-content .recipe-step:nth-child(7) { margin-left: 108px; }

    .recipe-step.step-selected {
        background-color: #0d6efd;
        color: #fff;
        box-shadow: 0 0.35rem 0.9rem rgba(13,110,253,0.45);
    }

    .recipe-step.empty-step {
        border-left-color: #adb5bd;
        color: #6c757d;
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">

            <!-- ì œëª© -->
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-0 fw-bold">â˜• ë©”ë‰´ ë ˆì‹œí”¼ ìˆ˜ì •</h3>
                    <div class="text-muted small mt-1">
                        ì €ì¥ëœ ë ˆì‹œí”¼ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ë‹¤ì‹œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ID ë°°ì§€ + ë ˆì‹œí”¼ ë§Œë“¤ê¸° + ëª©ë¡ ë²„íŠ¼ -->
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-muted">
                        ID: {{recipeId}}
                    </span>
                    <a href="/cafe/recipe/new" class="btn btn-sm btn-success">
                        ë ˆì‹œí”¼ ë§Œë“¤ê¸°
                    </a>
                    <a href="/cafe/recipes" class="btn btn-sm btn-outline-secondary">
                        ëª©ë¡
                    </a>
                </div>
            </div>

            <!-- ë ˆì‹œí”¼ ìˆ˜ì • í¼ -->
            <form method="post"
                  action="/cafe/recipe/{{recipeId}}/update"
                  id="recipe-form"
                  data-temp="{{recipe.temperature}}"
                  data-cup="{{recipe.cupSize}}"
                  data-category="{{recipe.category}}">

                <input type="hidden" name="id" value="{{recipeId}}">

                <!-- âœ… ê¸°ë³¸ ì •ë³´ë“¤ì„ í•˜ë‚˜ì˜ ë¼ìš´ë“œ ë°•ìŠ¤ë¡œ ê°ì‹¼ë‹¤ -->
                <div class="form-wrapper">

                    <!-- ë©”ë‰´ ì´ë¦„ + ë…¸ì¶œ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ + í…œí”Œë¦¿ ë“±ë¡ ì²´í¬ë°•ìŠ¤ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label for="menuName" class="form-label fw-semibold mb-0">ë©”ë‰´ ì´ë¦„</label>
                            <div class="d-flex align-items-center gap-3">
                                <!-- ë…¸ì¶œ ì—¬ë¶€ -->
                                <div class="form-check mb-0">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="visible"
                                           name="visible"
                                           {{#recipe.visible}}checked{{/recipe.visible}}>
                                    <label class="form-check-label small" for="visible">
                                        ë…¸ì¶œ ì—¬ë¶€
                                    </label>
                                </div>
                                <!-- í…œí”Œë¦¿ ë“±ë¡ -->
                                <div class="form-check mb-0">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="template"
                                           name="template"
                                           {{#recipe.template}}checked{{/recipe.template}}>
                                    <label class="form-check-label small" for="template">
                                        í…œí”Œë¦¿ ë“±ë¡
                                    </label>
                                </div>
                            </div>
                        </div>
                        <input type="text"
                               class="form-control"
                               id="menuName"
                               name="menuName"
                               value="{{recipe.menuName}}"
                               placeholder="ì˜ˆ) ë°”ë‹ë¼ë¼ë–¼"
                               required>
                    </div>

                    <!-- ì‘ì„±ì -->
                    <div class="mb-3">
                        <label for="author" class="form-label fw-semibold">ì‘ì„±ì</label>
                        <input type="text"
                               class="form-control"
                               id="author"
                               name="author"
                               value="{{recipe.author}}"
                               placeholder="ë³¸ì¸ ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„"
                               required>
                    </div>

                    <!-- ê°„ë‹¨ ì„¤ëª… (ì˜µì…˜) -->
                    <div class="mb-3">
                        <label for="description" class="form-label fw-semibold">
                            ê°„ë‹¨ ì„¤ëª… <span class="text-muted small">(ì„ íƒ)</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="description"
                               name="description"
                               value="{{recipe.description}}"
                               placeholder="ì˜ˆ) ì•„ì´ìŠ¤ ì „ìš©, ì—°í•œ ë‹¨ë§›, ì´ˆë³´ ë°”ë¦¬ìŠ¤íƒ€ìš©">
                    </div>

                    <!-- HOT / ICE ì„ íƒ -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-block">HOT / ICE</label>
                        <div class="btn-group temp-group" role="group" aria-label="Temperature select">
                            <input type="radio" class="btn-check" name="temperature" id="tempHot" value="HOT" autocomplete="off">
                            <label class="btn btn-outline-danger" for="tempHot">HOT</label>

                            <input type="radio" class="btn-check" name="temperature" id="tempIce" value="ICE" autocomplete="off">
                            <label class="btn btn-outline-primary" for="tempIce">ICE</label>
                        </div>
                    </div>

                    <!-- ì»µ ì‚¬ì´ì¦ˆ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-block">ì»µ ì‚¬ì´ì¦ˆ</label>
                        <div class="btn-group cup-group" role="group" aria-label="Cup size select">
                            <input type="radio" class="btn-check" name="cupSize" id="cup20" value="OZ20" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="cup20">20oz</label>

                            <input type="radio" class="btn-check" name="cupSize" id="cup24" value="OZ24" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="cup24">24oz</label>

                            <input type="radio" class="btn-check" name="cupSize" id="cup32" value="OZ32" autocomplete="off">
                            <label class="btn btn-outline-secondary" for="cup32">32oz</label>
                        </div>
                        <div class="form-text text-muted small">
                            HOT ì„ íƒ ì‹œ ê¸°ë³¸ 20oz, ICE ì„ íƒ ì‹œ ê¸°ë³¸ 24ozê°€ ìë™ ì„ íƒë©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì¹© í˜•íƒœ) -->
                    <div class="mb-1">
                        <label class="form-label fw-semibold d-block">ì¹´í…Œê³ ë¦¬</label>
                        <div class="category-chip-group" id="category-chip-group">
                            <button type="button" class="category-chip" data-value="HOT_COFFEE">Hot ì»¤í”¼</button>
                            <button type="button" class="category-chip" data-value="ICE_COFFEE">Ice ì»¤í”¼</button>
                            <button type="button" class="category-chip" data-value="HOT_LATTE">Hot ë¼ë–¼</button>
                            <button type="button" class="category-chip" data-value="ICE_LATTE">Ice ë¼ë–¼</button>
                            <button type="button" class="category-chip" data-value="ICE_NONCOFFEE">Ice ë…¼ì»¤í”¼</button>
                            <button type="button" class="category-chip" data-value="HOT_NONCOFFEE">Hot ë…¼ì»¤í”¼</button>
                            <button type="button" class="category-chip" data-value="HOT_COLD_BREW">HOT ì½œë“œë¸Œë£¨</button>
                            <button type="button" class="category-chip" data-value="HOT_LATTE_COLD_BREW">HOT ì½œë“œë¸Œë£¨ë¼ë–¼</button>
                            <button type="button" class="category-chip" data-value="ICE_COLD_BREW">ICE ì½œë“œë¸Œë£¨</button>
                            <button type="button" class="category-chip" data-value="ICE_LATTE_COLD_BREW">ICE ì½œë“œë¸Œë£¨ë¼ë–¼</button>
                            <button type="button" class="category-chip" data-value="SMOOTHIE_ADE">ìŠ¤ë¬´ë”” ì—ì´ë“œ</button>
                            <button type="button" class="category-chip" data-value="JUICE">ì£¼ìŠ¤</button>
                            <button type="button" class="category-chip" data-value="FRAPPE">í”„ë¼í˜</button>
                        </div>
                        <input type="hidden" name="category" id="category-input" required>
                        <div class="form-text text-muted small">
                            ìœ„ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
                        </div>
                    </div>

                </div> <!-- .form-wrapper ë -->

                <!-- ë ˆì‹œí”¼ ìŠ¤í…ë“¤ -->
                <div class="mb-2 d-flex justify-content-between align-items-center">
                    <label class="form-label fw-semibold mb-0">ë ˆì‹œí”¼ ë‹¨ê³„</label>
                    <div class="d-flex gap-2">
                        <!-- âœ… ìƒˆë¡œ ì¶”ê°€ëœ ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ (ë…¹ìƒ‰) -->
                        <button type="button"
                                class="btn btn-sm btn-success"
                                id="btn-preview">
                            ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸°
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                id="btn-add-step">
                            + ë‹¨ê³„ ì¶”ê°€
                        </button>
                    </div>
                </div>

                <!-- âœ… ìŠ¤í… ì¹´ë“œë“¤ì„ ì£¼í™©ìƒ‰ ë¼ìš´ë“œ ë°•ìŠ¤ë¡œ ê°ìŒˆ -->
                <div class="step-wrapper mb-3">
                    <div id="steps-container" class="mb-1">
                        {{#recipe.steps}}
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="fw-semibold d-flex align-items-center">
                                            Step <span class="step-number ms-1">0</span>
                                            <!-- ğŸ”¢ ì´ ë‹¨ê³„ì˜ ì‹œê°„ ì…ë ¥ (ì´ˆ) -->
                                            <div class="step-time-group">
                                                <input type="number"
                                                       class="form-control form-control-sm step-time-input"
                                                       name="stepTimes"
                                                       min="1"
                                                       value="10">
                                                <span class="step-time-label">ì´ˆ</span>
                                            </div>
                                        </div>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger btn-remove-step">
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                    <textarea class="form-control step-textarea"
                                              name="steps"
                                              rows="2"
                                              required>{{.}}</textarea>
                                </div>
                            </div>
                        {{/recipe.steps}}
                    </div>

                    <!-- ğŸ”¥ ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ stepTimesë¥¼ ìˆ¨ê²¨ì„œ JSì—ì„œ ë§¤í•‘ìš©ìœ¼ë¡œ ì‚¬ìš© -->
                    <div id="initial-step-times" style="display:none;">
                        {{#recipe.stepTimes}}
                            <span class="init-step-time" data-time="{{.}}"></span>
                        {{/recipe.stepTimes}}
                    </div>
                </div>

                <!-- ì €ì¥ / ì‚­ì œ ë²„íŠ¼ -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="/cafe/recipes" class="btn btn-outline-secondary">
                        ëª©ë¡
                    </a>
                    <!-- ğŸ”¥ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
                    <button type="button"
                            class="btn btn-outline-danger"
                            id="btn-delete-recipe"
                            data-recipe-id="{{recipeId}}">
                        ì‚­ì œ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ë³€ê²½ì‚¬í•­ ì €ì¥
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- âœ… ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (ëª©ë¡ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ì°¸ê³ ) -->
<div class="modal fade" id="recipePreviewModal" tabindex="-1" aria-labelledby="recipePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="recipePreviewModalLabel">ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <div class="fw-bold fs-5" id="preview-menu-name">ë©”ë‰´ ì´ë¦„</div>
                    <div class="text-muted small" id="preview-description"></div>
                </div>
                <div class="mb-2 small text-secondary" id="preview-basic-info"></div>
                <hr class="my-2">
                <div id="recipe-steps-content"></div>
                <div class="mt-2 text-muted small">
                    í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤. ì €ì¥ í›„ ì‹¤ì œ ë ˆì‹œí”¼ì— ë°˜ì˜ë©ë‹ˆë‹¤.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const form = document.getElementById('recipe-form');

        /* =========================
           ë ˆì‹œí”¼ ë‹¨ê³„ (Step) ê´€ë¦¬
           ========================= */
        const stepsContainer = document.getElementById('steps-container');
        const addStepBtn = document.getElementById('btn-add-step');

        let stepIndex = 0;

        function createStepElement(index, content) {
            const wrapper = document.createElement('div');
            wrapper.className = 'card mb-2';

            wrapper.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold d-flex align-items-center">
                            Step <span class="step-number ms-1">${index + 1}</span>
                            <div class="step-time-group">
                                <input type="number"
                                       class="form-control form-control-sm step-time-input"
                                       name="stepTimes"
                                       min="1"
                                       value="10">
                                <span class="step-time-label">ì´ˆ</span>
                            </div>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger btn-remove-step">
                            ì‚­ì œ
                        </button>
                    </div>
                    <textarea class="form-control step-textarea"
                              name="steps"
                              rows="2"
                              required>${content || ''}</textarea>
                </div>
            `;
            return wrapper;
        }

        function refreshStepNumbers() {
            const stepCards = stepsContainer.querySelectorAll('.card');
            stepCards.forEach((card, idx) => {
                const numberSpan = card.querySelector('.step-number');
                if (numberSpan) {
                    numberSpan.textContent = idx + 1;
                }
            });
            stepIndex = stepCards.length;
        }

        function bindRemoveEvent(card) {
            const removeBtn = card.querySelector('.btn-remove-step');
            if (!removeBtn) return;

            removeBtn.addEventListener('click', function () {
                const total = stepsContainer.querySelectorAll('.card').length;
                if (total <= 1) {
                    alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
                card.remove();
                refreshStepNumbers();
            });
        }

        function addStep(defaultContent) {
            const el = createStepElement(stepIndex, defaultContent);
            stepsContainer.appendChild(el);
            stepIndex++;
            bindRemoveEvent(el);
        }

        // ğŸ”¥ ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ stepTimesë¥¼ ê° ì¹´ë“œì˜ inputì— ë§¤í•‘
        function applyInitialStepTimes() {
            const initContainer = document.getElementById('initial-step-times');
            if (!initContainer) return;

            const initTimes = initContainer.querySelectorAll('.init-step-time');
            const stepCards = stepsContainer.querySelectorAll('.card');

            stepCards.forEach((card, idx) => {
                const timeInput = card.querySelector('.step-time-input');
                if (!timeInput) return;

                const span = initTimes[idx];
                if (span) {
                    const t = span.dataset.time;
                    if (t !== undefined && t !== null && t !== '') {
                        timeInput.value = t;
                    }
                }
            });
        }

        // ì´ˆê¸°: ì„œë²„ì—ì„œ ë Œë”ë§ëœ ìŠ¤í… ì¹´ë“œê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ê¸°ì¤€ìœ¼ë¡œ ì„¸íŒ…
        (function initSteps() {
            const existingCards = stepsContainer.querySelectorAll('.card');
            if (existingCards.length === 0) {
                addStep('');
            } else {
                existingCards.forEach(card => bindRemoveEvent(card));
                refreshStepNumbers();
            }

            // ğŸ”¥ stepTimes ì´ˆê¸° ê°’ ì ìš©
            applyInitialStepTimes();
        })();

        addStepBtn.addEventListener('click', function () {
            addStep('');
        });

        /* =========================
           HOT / ICE & ì»µ ì‚¬ì´ì¦ˆ ì—°ë™
           ========================= */
        const tempHot = document.getElementById('tempHot');
        const tempIce = document.getElementById('tempIce');
        const cup20 = document.getElementById('cup20');
        const cup24 = document.getElementById('cup24');
        const cup32 = document.getElementById('cup32');

        function setDefaultCupByTemp(temp) {
            if (temp === 'HOT') {
                cup20.checked = true;
            } else if (temp === 'ICE') {
                cup24.checked = true;
            }
        }

        tempHot.addEventListener('change', function () {
            if (tempHot.checked) {
                setDefaultCupByTemp('HOT');
            }
        });

        tempIce.addEventListener('change', function () {
            if (tempIce.checked) {
                setDefaultCupByTemp('ICE');
            }
        });

        /* =========================
           ì´ˆê¸°ê°’ ì„¸íŒ… (temperature, cupSize, category)
           ========================= */
        (function initSelections() {
            const initialTemp = form.dataset.temp;       // HOT / ICE
            const initialCup = form.dataset.cup;         // OZ20 / OZ24 / OZ32
            const initialCategory = form.dataset.category; // RecipeCategory enum ê°’

            // temperature
            if (initialTemp === 'ICE') {
                tempIce.checked = true;
            } else {
                tempHot.checked = true;
            }

            // cupSize
            if (initialCup === 'OZ24') {
                cup24.checked = true;
            } else if (initialCup === 'OZ32') {
                cup32.checked = true;
            } else {
                cup20.checked = true;
            }

            // category chips
            const categoryInput = document.getElementById('category-input');
            const categoryGroup = document.getElementById('category-chip-group');
            const categoryChips = categoryGroup.querySelectorAll('.category-chip');

            categoryChips.forEach(chip => {
                chip.addEventListener('click', function () {
                    categoryChips.forEach(c => c.classList.remove('selected'));
                    chip.classList.add('selected');
                    categoryInput.value = chip.dataset.value;
                });

                if (chip.dataset.value === initialCategory) {
                    chip.classList.add('selected');
                    categoryInput.value = initialCategory;
                }
            });

            if (!categoryInput.value && categoryChips.length > 0) {
                categoryChips[0].classList.add('selected');
                categoryInput.value = categoryChips[0].dataset.value;
            }
        })();

        /* =========================
           ë ˆì‹œí”¼ ë¯¸ë¦¬ë³´ê¸° íŒì—…
           ========================= */
        const previewBtn = document.getElementById('btn-preview');
        const previewModalEl = document.getElementById('recipePreviewModal');

        let previewModalInstance = null;

        function openPreviewModal() {
            if (!previewModalEl) return;

            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                if (!previewModalInstance) {
                    previewModalInstance = new bootstrap.Modal(previewModalEl);
                }
                previewModalInstance.show();
            } else {
                // Bootstrap JSê°€ ì—†ì„ ê²½ìš°ë¥¼ ìœ„í•œ fallback
                previewModalEl.style.display = 'block';
                previewModalEl.classList.add('show');
            }
        }

        function attachPreviewStepClickHandlers() {
            const container = document.getElementById('recipe-steps-content');
            if (!container) return;

            const steps = container.querySelectorAll('.recipe-step');
            steps.forEach(step => {
                step.addEventListener('click', () => {
                    steps.forEach(s => s.classList.remove('step-selected'));
                    step.classList.add('step-selected');
                });
            });
        }

        function buildPreview() {
            const menuNameInput = document.getElementById('menuName');
            const descInput = document.getElementById('description');

            const selectedTemp = form.querySelector('input[name="temperature"]:checked');
            const selectedCup = form.querySelector('input[name="cupSize"]:checked');
            const selectedChip = document.querySelector('.category-chip.selected');

            const menuName = menuNameInput ? menuNameInput.value.trim() : '';
            const description = descInput ? descInput.value.trim() : '';

            const tempValue = selectedTemp ? selectedTemp.value : '';
            const cupValue = selectedCup ? selectedCup.value : '';
            const categoryLabel = selectedChip ? selectedChip.textContent.trim() : '';

            // ìƒë‹¨ ì •ë³´ ì„¸íŒ…
            const previewMenuNameEl = document.getElementById('preview-menu-name');
            const previewDescriptionEl = document.getElementById('preview-description');
            const previewBasicInfoEl = document.getElementById('preview-basic-info');

            if (previewMenuNameEl) {
                previewMenuNameEl.textContent = menuName || 'ë©”ë‰´ ì´ë¦„ ë¯¸ì…ë ¥';
            }
            if (previewDescriptionEl) {
                previewDescriptionEl.textContent = description || '';
            }

            const infoParts = [];

            if (tempValue) {
                infoParts.push(tempValue === 'HOT' ? 'HOT (í•«)' : 'ICE (ì•„ì´ìŠ¤)');
            }

            if (cupValue) {
                let cupLabel = '';
                if (cupValue === 'OZ20') cupLabel = '20oz';
                else if (cupValue === 'OZ24') cupLabel = '24oz';
                else if (cupValue === 'OZ32') cupLabel = '32oz';
                if (cupLabel) {
                    infoParts.push('ì»µ: ' + cupLabel);
                }
            }

            if (categoryLabel) {
                infoParts.push('ì¹´í…Œê³ ë¦¬: ' + categoryLabel);
            }

            if (previewBasicInfoEl) {
                previewBasicInfoEl.textContent = infoParts.join(' Â· ');
            }

            // ìŠ¤í… ê³„ë‹¨ ìŠ¤íƒ€ì¼ ì„¸íŒ…
            const previewStepsEl = document.getElementById('recipe-steps-content');
            if (!previewStepsEl) return;

            previewStepsEl.innerHTML = '';

            // ğŸ”¥ ê° ì¹´ë“œì—ì„œ textarea + timeInput ë‘˜ ë‹¤ ì½ì–´ì„œ ë¯¸ë¦¬ë³´ê¸° êµ¬ì„±
            const stepCards = stepsContainer.querySelectorAll('.card');
            let visibleIndex = 0;

            stepCards.forEach((card) => {
                const textarea = card.querySelector('.step-textarea');
                if (!textarea) return;

                const text = (textarea.value || '').trim();
                if (!text) return;

                const timeInput = card.querySelector('.step-time-input');
                const timeVal = timeInput ? (timeInput.value || '').trim() : '';

                const row = document.createElement('div');
                row.className = 'recipe-step';

                const safeText = text.replace(/\n/g, '<br>');

                let timeHtml = '';
                if (timeVal) {
                    timeHtml = `<span class="step-time-preview ms-2 text-muted" style="font-size:2.0rem;">(${timeVal}ì´ˆ)</span>`;
                }

                row.innerHTML = `
                    <span class="step-index">Step ${visibleIndex + 1}.</span>
                    <span class="step-text">${safeText}</span>
                    ${timeHtml}
                `;

                previewStepsEl.appendChild(row);
                visibleIndex++;
            });

            if (visibleIndex === 0) {
                const emptyRow = document.createElement('div');
                emptyRow.className = 'recipe-step empty-step';
                emptyRow.innerHTML = `
                    <span class="step-index">Step 1.</span>
                    <span class="step-text text-muted">ë“±ë¡ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¨ê³„ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span>
                `;
                previewStepsEl.appendChild(emptyRow);
            }

            // í´ë¦­ í•¸ë“¤ëŸ¬ + ì²« ìŠ¤í… ìë™ ì„ íƒ
            attachPreviewStepClickHandlers();

            const firstStep = previewStepsEl.querySelector('.recipe-step');
            if (firstStep) {
                previewStepsEl
                        .querySelectorAll('.recipe-step')
                        .forEach(s => s.classList.remove('step-selected'));
                firstStep.classList.add('step-selected');
            }
        }

        if (previewBtn) {
            previewBtn.addEventListener('click', function () {
                buildPreview();
                openPreviewModal();
            });
        }

        /* =========================
           ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
           ========================= */
        const deleteBtn = document.getElementById('btn-delete-recipe');

        async function deleteRecipe(recipeId) {
            const ok = confirm('ì´ ë ˆì‹œí”¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            if (!ok) return;

            try {
                const res = await fetch('/api/cafe/recipe/' + recipeId + '/delete', {
                    method: 'POST'
                    // CSRF ì‚¬ìš© ì‹œ ì—¬ê¸°ì„œ í—¤ë” ì¶”ê°€
                });

                if (!res.ok && res.status !== 204) {
                    alert('ë ˆì‹œí”¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (' + res.status + ')');
                    return;
                }

                // ì„±ê³µ ì‹œ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = '/cafe/recipes';
            } catch (e) {
                console.error(e);
                alert('ë ˆì‹œí”¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        if (deleteBtn) {
            deleteBtn.addEventListener('click', function () {
                const recipeId = deleteBtn.dataset.recipeId ||
                        document.querySelector('input[name="id"]')?.value;
                if (!recipeId) {
                    alert('ë ˆì‹œí”¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                deleteRecipe(recipeId);
            });
        }
    })();
</script>

{{>layouts/footer}}
