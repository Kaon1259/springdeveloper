{{>layouts/header}}
<style>
    body {
        background-color: #f8f9fa;
    }

    /* ìƒë‹¨ ì„ íƒ ì •ë³´ ë°” */
    .top-status-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: #ffffff;
        border-bottom: 1px solid #dee2e6;
        padding: 0.9rem 1.5rem;
        min-height: 64px;
    }

    .menu-card {
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
        border-width: 2px;
        border-color: transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
        background-color: #ffffff;
    }

    .menu-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.08);
    }

    .menu-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0.4rem 1rem rgba(13, 110, 253, 0.25);
    }

    /* === í° ì¹´ë“œì˜ ì ‘íŒ ëª¨ì„œë¦¬ (ì¢Œì¸¡ ìƒë‹¨) === */
    .menu-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 56px;
        height: 56px;
        clip-path: polygon(0 0, 100% 0, 0 100%);
        background-color: transparent;
        z-index: 0;
    }

    .menu-card[data-recipe-temp="HOT"]::before {
        background-color: #dc3545;
    }

    .menu-card[data-recipe-temp="ICE"]::before {
        background-color: #0d6efd;
    }

    .menu-card .card-body {
        position: relative;
        z-index: 1;
    }

    /* ìƒë‹¨ ë ˆì‹œí”¼ ë²ˆí˜¸(#10) */
    .recipe-id-label {
        font-size: 3.3rem;      /* í¬ê²Œ í‘œì‹œ */
        font-weight: 800;
        color: #6c757d;
        text-align: center;
        margin-bottom: 0.25rem;
        letter-spacing: 0.06em;
    }

    .menu-name {
        font-size: 2rem;
        font-weight: 800;
        text-align: center;
    }

    .menu-tag {
        font-size: 0.9rem;
        border-radius: 999px;
        padding: 0.1rem 0.5rem;
    }

    .card-count-badge {
        font-size: 0.85rem;
    }

    /* ===== ë ˆì‹œí”¼ ì¹´ë“œ ê·¸ë¦¬ë“œ (4ì—´) ===== */
    .menu-grid-wrapper {
        height: calc(100vh - 210px);
        max-height: calc(100vh - 210px);
        overflow-y: auto;
    }

    .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        grid-auto-rows: 1fr;
        grid-auto-flow: row;
        gap: 1rem;
        height: 100%;
    }

    .menu-grid-item {
        display: flex;
    }

    .menu-grid-item .menu-card {
        width: 100%;
    }

    /* ===== HOT / ICE ë°°ì§€ (ë¼ìš´ë“œ + ì ‘íŒ ì½”ë„ˆ + ì´ëª¨ì§€) ===== */
    .temp-badge {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem 1rem;
        padding-left: 1.4rem;
        border-radius: 999px;
        background-color: #ffffff;
        border: 3px solid;
        font-size: 1.3rem;
        font-weight: 800;
        gap: 0.25rem;
        line-height: 1;
        overflow: hidden;
    }

    .temp-badge::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        clip-path: polygon(0 0, 100% 0, 0 100%);
    }

    .temp-HOT {
        border-color: #dc3545;
        color: #dc3545;
    }

    .temp-ICE {
        border-color: #0d6efd;
        color: #0d6efd;
    }

    .temp-HOT::before {
        background-color: #dc3545;
    }

    .temp-ICE::before {
        background-color: #0d6efd;
    }

    .temp-HOT::after {
        content: "ğŸ”¥";
        margin-left: 0.3rem;
        font-size: 1.4rem;
    }

    .temp-ICE::after {
        content: "â„";
        margin-left: 0.3rem;
        font-size: 1.4rem;
    }

    /* OZ (ì»µ ì‚¬ì´ì¦ˆ) ë°°ì§€ */
    .cup-badge {
        font-size: 1.3rem;
        font-weight: 800;
        padding: 0.2rem 0.8rem;
        border-radius: 999px;
        background-color: #f8f9fa;
        border: 2px solid #adb5bd;
    }

    /* ===== ë ˆì‹œí”¼ íŒì—…(ëª¨ë‹¬) ===== */
    .recipe-modal {
        position: fixed;
        inset: 0;
        z-index: 1050;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .recipe-modal.show {
        display: flex;
    }

    .recipe-modal-backdrop {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.45);
    }

    .recipe-modal-dialog {
        position: relative;
        z-index: 1060;
        background-color: #ffffff;
        border-radius: 0.75rem;
        max-width: 1280px;
        width: 95%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.25);
        padding: 1.25rem 1.5rem 1.5rem;
        margin: 0 1rem;
    }

    .recipe-modal-header {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .recipe-modal-header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .recipe-modal-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }

    .recipe-modal-body {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .recipe-step {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.3rem 1.5rem;
        margin-bottom: 1.8rem;
        box-shadow: 0 0.35rem 0.8rem rgba(0, 0, 0, 0.08);
        border-left: 6px solid #0d6efd;
        font-size: 2.2rem;
        line-height: 1.6;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .step-index {
        font-weight: 900;
        margin-right: 0.7rem;
    }

    .step-text {
        display: inline-block;
        vertical-align: middle;
    }

    .recipe-step.step-selected {
        background-color: #0d6efd;
        color: #ffffff;
        box-shadow: 0 0.35rem 0.9rem rgba(13, 110, 253, 0.45);
    }

    .btn-close {
        border: none;
        background: transparent;
        font-size: 1.7rem;
        line-height: 1;
    }

    /* ğŸ”Š TTS í† ê¸€ ë²„íŠ¼ (í—¤ë” ì˜¤ë¥¸ìª½) */
    .tts-toggle-btn {
        border: none;
        background: transparent;
        font-size: 1.9rem;
        line-height: 1;
        cursor: pointer;
        padding: 0 0.1rem;
        transition: transform 0.08s ease, opacity 0.1s ease;
    }
    .tts-toggle-btn.off {
        opacity: 0.35;
    }
    .tts-toggle-btn.on {
        opacity: 1;
        transform: scale(1.05);
    }

    /* ğŸ™ ìƒë‹¨ ê³µìš© ìŒì„± ì¸ì‹ ë²„íŠ¼ */
    .top-mic-btn {
        border-radius: 999px;
        border: 2px solid rgba(15,23,42,0.4);
        background-color: #ffffff;
        width: 50px;
        height: 50px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        cursor: pointer;
        margin-left: 0.75rem;
        box-shadow: 0 3px 10px rgba(15,23,42,0.25);
        transition: background-color 0.12s ease, transform 0.08s ease,
        box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .top-mic-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 14px rgba(15,23,42,0.35);
    }

    /* ë§ˆì´í¬ ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes micBlink {
        0% {
            box-shadow: 0 3px 10px rgba(15,23,42,0.25);
            opacity: 1;
        }
        50% {
            box-shadow: 0 0 0 4px rgba(13,110,253,0);
            opacity: 0.45;
        }
        100% {
            box-shadow: 0 3px 10px rgba(15,23,42,0.25);
            opacity: 1;
        }
    }

    .top-mic-btn.listening {
        background-color: #0d6efd;
        color: #ffffff;
        border-color: #0a58ca;
        box-shadow: 0 0 0 4px rgba(13,110,253,0.45);
        transform: translateY(0);
        animation: micBlink 1s ease-in-out infinite;
    }

    /* ë ˆì‹œí”¼ ì—†ìŒ íŒì—… */
    .no-recipe-popup {
        position: fixed;
        z-index: 2000;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffffff;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25);
        border: 1px solid #dee2e6;
        font-size: 1rem;
        font-weight: 600;
        color: #343a40;
        display: none;
    }
    .no-recipe-popup.show {
        display: block;
    }

    /* ìë™ì¬ìƒ ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì¡°ì • */
    .auto-play-switch .form-check-input {
        cursor: pointer;
    }

    /* ëª¨ë‹¬ ë‚´ 20ì´ˆ ì›í˜• íƒ€ì´ë¨¸ (SVG ê¸°ë°˜) */
    .auto-timer {
        width: 40px;
        height: 40px;
        position: relative;
        display: none;             /* JSì—ì„œ .showë¡œ ë³€ê²½ */
        align-items: center;
        justify-content: center;
    }
    .auto-timer.show {
        display: flex;
    }

    .auto-timer-svg {
        transform: rotate(-90deg); /* 12ì‹œ ë°©í–¥ì—ì„œ ì‹œì‘í•˜ë„ë¡ íšŒì „ */
    }

    .auto-timer-bg-circle {
        stroke: #d1e7dd;          /* ì—°í•œ ë…¹ìƒ‰ ë°°ê²½ */
        stroke-width: 3;
        fill: none;
    }

    .auto-timer-progress-circle {
        stroke: #198754;          /* ì§„í•œ ë…¹ìƒ‰ ì§„í–‰ */
        stroke-width: 3;
        fill: none;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.25s linear;
    }

    .auto-timer-value {
        position: absolute;
        font-weight: 700;
        color: #198754;
        font-size: 0.9rem;
        line-height: 1;
    }
</style>

<div class="container-fluid py-3">

    <!-- ìƒë‹¨ ì„ íƒ ìƒíƒœ ë°” -->
    <div class="top-status-bar d-flex flex-wrap align-items-center justify-content-between mb-3">
        <!-- ì¢Œì¸¡: ì•ˆë‚´ + ë§ˆì´í¬ -->
        <div class="d-flex flex-column flex-sm-row flex-wrap align-items-sm-center gap-2">
            <div class="fw-bold d-flex align-items-center">
                <span>ì£¼ìš” ë ˆì‹œí”¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                <span class="text-muted ms-1">(í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì„ íƒ)</span>

                <!-- ğŸ™ ìƒë‹¨ ê³µìš© ë§ˆì´í¬ ë²„íŠ¼ -->
                <button type="button"
                        id="btn-voice-recipe"
                        class="top-mic-btn"
                        title="ìŒì„±ì¸ì‹ êº¼ì§ Â· ëˆ„ë¥´ê³  'í—¬ë¦¬ì•¼ / ë ˆì‹œí”¼ ì´ë¦„ / ë²ˆí˜¸ / ë‹¤ìŒ / ê·¸ë§Œ / ìŒì„±ì¸ì‹ ê·¸ë§Œ'ì„ ë§í•´ë³´ì„¸ìš”.">
                    ğŸ™
                </button>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì„ íƒ ì¹´ìš´íŠ¸ + ìë™ì¬ìƒ ìŠ¬ë¼ì´ë” -->
        <div class="d-flex align-items-center gap-3 mt-2 mt-sm-0">
            <span class="badge bg-primary card-count-badge">
                ì„ íƒí•œ ë ˆì‹œí”¼
                <span id="selected-count" class="fw-bold ms-1">0</span> / 1
            </span>

            <div class="form-check form-switch mb-0 auto-play-switch">
                <input class="form-check-input" type="checkbox" id="auto-play-toggle">
                <label class="form-check-label small" for="auto-play-toggle">
                    ìë™ì¬ìƒ
                </label>
            </div>
        </div>
    </div>

    <!-- ë ˆì‹œí”¼ ì¹´ë“œ ê·¸ë¦¬ë“œ (4ì—´) -->
    <div class="menu-grid-wrapper mb-4">
        <div class="menu-grid">
            {{#recipeRows}}
                <div class="menu-grid-item">
                    <div class="card menu-card"
                         data-recipe-id="{{id}}"
                         data-recipe-name="{{menuName}}"
                         data-recipe-temp="{{temperature}}">

                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <!-- ë ˆì‹œí”¼ ë²ˆí˜¸(#10) -->
                            <div class="recipe-id-label">
                                #{{id}}
                            </div>

                            <!-- ê°€ìš´ë° í¬ê²Œ ë©”ë‰´ ì´ë¦„ -->
                            <div class="menu-name mb-2">
                                {{menuName}}
                            </div>

                            <!-- ì•„ë˜ì— ì¹´í…Œê³ ë¦¬ / íƒœê·¸ë“¤ -->
                            <div class="d-flex flex-column align-items-center gap-2">
                                {{#category}}
                                    <span class="badge text-bg-light">
                                        {{category}}
                                    </span>
                                {{/category}}

                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    {{#temperature}}
                                        <span class="temp-badge temp-{{temperature}}">
                                            {{temperature}}
                                        </span>
                                    {{/temperature}}

                                    {{#cupSize}}
                                        <span class="cup-badge">
                                            {{cupSize}}
                                        </span>
                                    {{/cupSize}}
                                </div>
                            </div>

                            <!-- ìˆ¨ê²¨ì§„ ë ˆì‹œí”¼ ìŠ¤í… (ëª¨ë‹¬ìš©) -->
                            <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                {{#steps}}
                                    <div class="recipe-step-text">{{.}}</div>
                                {{/steps}}
                                {{^steps}}
                                    <div class="recipe-step-text text-muted">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                {{/steps}}
                            </div>
                        </div>
                    </div>
                </div>
            {{/recipeRows}}

            {{^recipeRows}}
                <div class="menu-grid-item">
                    <div class="alert alert-warning mb-0 w-100">
                        í‘œì‹œí•  ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. <code>visible == true</code> ì¸ ë ˆì‹œí”¼ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.
                    </div>
                </div>
            {{/recipeRows}}
        </div>
    </div>
</div>

<!-- ë ˆì‹œí”¼ íŒì—…(ëª¨ë‹¬) -->
<div id="recipe-modal" class="recipe-modal">
    <div class="recipe-modal-backdrop" id="recipe-modal-backdrop"></div>
    <div class="recipe-modal-dialog">
        <div class="recipe-modal-header">
            <h5 class="recipe-modal-title" id="recipe-modal-title">ë ˆì‹œí”¼</h5>
            <div class="recipe-modal-header-right">
                <!-- â± 20ì´ˆ ì›í˜• íƒ€ì´ë¨¸ (SVG) -->
                <div class="auto-timer" id="auto-timer">
                    <svg class="auto-timer-svg" width="40" height="40" viewBox="0 0 40 40">
                        <!-- ë°°ê²½ ì› -->
                        <circle
                                class="auto-timer-bg-circle"
                                cx="20" cy="20" r="18"
                        ></circle>
                        <!-- ì§„í–‰ ì› -->
                        <circle
                                id="auto-timer-progress"
                                class="auto-timer-progress-circle"
                                cx="20" cy="20" r="18"
                        ></circle>
                    </svg>
                    <span class="auto-timer-value" id="auto-timer-value">20</span>
                </div>
                <!-- ğŸ”Š TTS í† ê¸€ ë²„íŠ¼ (ê¸°ë³¸ OFF) -->
                <button type="button"
                        class="tts-toggle-btn off"
                        id="btn-tts-toggle"
                        title="ìë™ ìŒì„± ì•ˆë‚´ ì¼œê¸°">
                    ğŸ”ˆ
                </button>
                <button type="button" class="btn-close" id="btn-close-recipe" aria-label="Close">&times;</button>
            </div>
        </div>
        <div class="recipe-modal-body" id="recipe-modal-body">
            <p class="text-muted small mb-0">
                ì„ íƒí•œ ë ˆì‹œí”¼ì˜ ìŠ¤í…ì´ ì—¬ê¸° ê³„ë‹¨í˜•ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<!-- ë ˆì‹œí”¼ ì—†ìŒ íŒì—… -->
<div id="no-recipe-popup" class="no-recipe-popup">
    ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.
</div>

<script>
    (function () {
        const AUTO_TOTAL_SECONDS = 20;

        const cards = document.querySelectorAll('.menu-card');
        const selectedCountSpan = document.getElementById('selected-count');

        const recipeModal = document.getElementById('recipe-modal');
        const recipeModalBackdrop = document.getElementById('recipe-modal-backdrop');
        const recipeModalTitle = document.getElementById('recipe-modal-title');
        const recipeModalBody = document.getElementById('recipe-modal-body');
        const btnCloseRecipe = document.getElementById('btn-close-recipe');
        const btnTtsToggle = document.getElementById('btn-tts-toggle');

        const btnVoiceRecipe = document.getElementById('btn-voice-recipe');

        const autoPlayToggle = document.getElementById('auto-play-toggle');
        const autoTimer = document.getElementById('auto-timer');
        const autoTimerValue = document.getElementById('auto-timer-value');
        const autoTimerProgress = document.getElementById('auto-timer-progress');

        const noRecipePopup = document.getElementById('no-recipe-popup');
        let noRecipePopupTimer = null;

        let currentSelectedMenu = null; // {id, name}
        let currentSelectedCard = null;

        // TTS ON/OFF ìƒíƒœ (ê¸°ë³¸ OFF) - ìˆ˜ë™ ì½ê¸°ìš© + ì•„ì´ì½˜ ìƒíƒœ
        let ttsEnabled = false;

        // ìë™ì¬ìƒ ìƒíƒœ
        let autoPlayEnabled = false;
        let autoPlayTimerId = null;
        let autoTimerIntervalId = null;
        let autoTimerSecondsLeft = AUTO_TOTAL_SECONDS;

        // ì›í˜• ì§„í–‰ë°” ê¸¸ì´ (circumference)
        const TIMER_RADIUS = 18;
        const TIMER_CIRCUMFERENCE = 2 * Math.PI * TIMER_RADIUS;

        if (autoTimerProgress) {
            autoTimerProgress.style.strokeDasharray = TIMER_CIRCUMFERENCE;
            autoTimerProgress.style.strokeDashoffset = 0;
        }

        // ìŒì„± ì¸ì‹ ìƒíƒœ
        let recognition = null;
        let recognizing = false;
        let voiceSessionActive = false;

        // ====== ìœ í‹¸: í•œê¸€ í…ìŠ¤íŠ¸ ì •ê·œí™” ======
        function normalizeKoreanText(text) {
            if (!text) return '';
            return text
                    .toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/[.!?,~\-\_]/g, '');
        }

        // ====== ìˆ«ì ì¶”ì¶œ (ì˜ˆ: "10ë²ˆ ë ˆì‹œí”¼", "10ë²ˆ ë³´ì—¬ì¤˜") ======
        function extractNumberFromText(text) {
            if (!text) return null;
            const match = text.match(/(\d{1,4})\s*(ë²ˆ|ë²ˆë ˆì‹œí”¼|ë²ˆë ˆì‹œí”¼ì¢€|ë²ˆë³´ì—¬ì¤˜|ë²ˆë³´ì—¬|ë²ˆìœ¼ë¡œ|ë²ˆì¢€)?/);
            if (match && match[1]) {
                const num = parseInt(match[1], 10);
                if (!isNaN(num)) return num;
            }
            return null;
        }

        // ====== TTS(ìŒì„± í•©ì„±) ======
        function speakText(text) {
            if (!('speechSynthesis' in window)) {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± í•©ì„±ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            if (!text || !text.trim()) return;

            window.speechSynthesis.cancel();

            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ko-KR';

            const voices = window.speechSynthesis.getVoices();
            const koVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('ko'));
            if (koVoice) {
                utter.voice = koVoice;
            }

            window.speechSynthesis.speak(utter);
        }

        function stopSpeak() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        function updateSelectedCount() {
            selectedCountSpan.textContent = currentSelectedMenu ? '1' : '0';
        }

        function clearAllSelections() {
            cards.forEach(c => c.classList.remove('selected'));
            currentSelectedMenu = null;
            currentSelectedCard = null;
            updateSelectedCount();
        }

        function updateTtsToggleVisual() {
            if (!btnTtsToggle) return;
            btnTtsToggle.classList.toggle('on', ttsEnabled);
            btnTtsToggle.classList.toggle('off', !ttsEnabled);
            btnTtsToggle.textContent = ttsEnabled ? 'ğŸ”Š' : 'ğŸ”ˆ';
            btnTtsToggle.title = ttsEnabled
                    ? 'ìë™ ìŒì„± ì•ˆë‚´ ë„ê¸°'
                    : 'ìë™ ìŒì„± ì•ˆë‚´ ì¼œê¸°';
        }

        function updateMicVisual(isOn) {
            if (!btnVoiceRecipe) return;
            btnVoiceRecipe.classList.toggle('listening', !!isOn);
            btnVoiceRecipe.title = isOn
                    ? "ìŒì„±ì¸ì‹ ì¼œì§ Â· 'í—¬ë¦¬ì•¼ / ë ˆì‹œí”¼ ì´ë¦„ / ë²ˆí˜¸ / ë‹¤ìŒ / ê·¸ë§Œ / ìŒì„±ì¸ì‹ ê·¸ë§Œ'ì„ ë§í•´ë³´ì„¸ìš”."
                    : "ìŒì„±ì¸ì‹ êº¼ì§ Â· ëˆ„ë¥´ê³  'í—¬ë¦¬ì•¼ / ë ˆì‹œí”¼ ì´ë¦„ / ë²ˆí˜¸ / ë‹¤ìŒ / ê·¸ë§Œ / ìŒì„±ì¸ì‹ ê·¸ë§Œ'ì„ ë§í•´ë³´ì„¸ìš”.";
        }

        function isRecipeModalOpen() {
            return recipeModal.classList.contains('show');
        }

        function getSelectedStepDiv() {
            return recipeModalBody.querySelector('.recipe-step.step-selected');
        }

        // force=true ì¸ ê²½ìš° ìë™ì¬ìƒì—ì„œ TTS ìƒíƒœì™€ ìƒê´€ì—†ì´ ì½ê¸°
        function speakCurrentSelectedStep(force) {
            const selectedStep = getSelectedStepDiv();
            if (!selectedStep) return;
            const textNode = selectedStep.querySelector('.step-text');
            if (!textNode) return;
            const text = textNode.textContent.trim();
            if (!text) return;

            if (!force && !ttsEnabled) return;
            speakText(text);
        }

        function moveToNextStepAndSpeak() {
            const steps = recipeModalBody.querySelectorAll('.recipe-step');
            if (!steps.length) return;

            let currentIdx = -1;
            steps.forEach((s, idx) => {
                if (s.classList.contains('step-selected')) {
                    currentIdx = idx;
                }
            });

            let nextIdx = currentIdx + 1;
            if (currentIdx === -1) {
                nextIdx = 0;
            } else if (nextIdx >= steps.length) {
                nextIdx = steps.length - 1;
            }

            steps.forEach(s => s.classList.remove('step-selected'));
            const target = steps[nextIdx];
            target.classList.add('step-selected');

            speakCurrentSelectedStep(true); // "ë‹¤ìŒ" ëª…ë ¹ì€ ê°•ì œ ì½ê¸°
        }

        // ===== ì›í˜• íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ =====
        function setTimerProgressBySeconds(secondsLeft) {
            if (!autoTimerProgress) return;
            const ratio = Math.max(0, Math.min(1, secondsLeft / AUTO_TOTAL_SECONDS));
            const offset = TIMER_CIRCUMFERENCE * (1 - ratio); // ì‹œê°„ì´ ì¤„ì–´ë“¤ìˆ˜ë¡ offset ì¦ê°€ â†’ ì™¸ê³½ì„  ì¤„ì–´ë“¦
            autoTimerProgress.style.strokeDashoffset = offset;
        }

        // ===== ìë™ì¬ìƒìš© 20ì´ˆ íƒ€ì´ë¨¸ =====
        function showAutoTimer(seconds) {
            if (!autoTimer || !autoTimerValue) return;
            autoTimerSecondsLeft = seconds;
            autoTimerValue.textContent = seconds;
            autoTimer.classList.add('show');

            setTimerProgressBySeconds(seconds);

            if (autoTimerIntervalId) {
                clearInterval(autoTimerIntervalId);
                autoTimerIntervalId = null;
            }

            autoTimerIntervalId = setInterval(() => {
                autoTimerSecondsLeft--;
                if (autoTimerSecondsLeft <= 0) {
                    autoTimerSecondsLeft = 0;
                    autoTimerValue.textContent = '0';
                    setTimerProgressBySeconds(0);
                    clearInterval(autoTimerIntervalId);
                    autoTimerIntervalId = null;
                } else {
                    autoTimerValue.textContent = autoTimerSecondsLeft;
                    setTimerProgressBySeconds(autoTimerSecondsLeft);
                }
            }, 1000);
        }

        function hideAutoTimer() {
            if (!autoTimer || !autoTimerValue) return;
            autoTimer.classList.remove('show');
            autoTimerValue.textContent = AUTO_TOTAL_SECONDS.toString();
            setTimerProgressBySeconds(AUTO_TOTAL_SECONDS);
            if (autoTimerIntervalId) {
                clearInterval(autoTimerIntervalId);
                autoTimerIntervalId = null;
            }
        }

        function stopAutoPlay() {
            if (autoPlayTimerId) {
                clearTimeout(autoPlayTimerId);
                autoPlayTimerId = null;
            }
            hideAutoTimer();
        }

        function scheduleNextAutoStep(currentIndex) {
            const steps = recipeModalBody.querySelectorAll('.recipe-step');
            if (!steps.length) {
                stopAutoPlay();
                return;
            }

            // 20ì´ˆ ì¹´ìš´íŠ¸ ì‹œì‘
            showAutoTimer(AUTO_TOTAL_SECONDS);

            if (autoPlayTimerId) {
                clearTimeout(autoPlayTimerId);
                autoPlayTimerId = null;
            }

            autoPlayTimerId = setTimeout(() => {
                if (!autoPlayEnabled || !isRecipeModalOpen()) {
                    stopAutoPlay();
                    return;
                }

                const freshSteps = recipeModalBody.querySelectorAll('.recipe-step');
                if (!freshSteps.length) {
                    stopAutoPlay();
                    return;
                }

                const nextIdx = currentIndex + 1;
                if (nextIdx >= freshSteps.length) {
                    // ë§ˆì§€ë§‰ ìŠ¤í…ê¹Œì§€ ì•ˆë‚´ ì™„ë£Œ
                    stopAutoPlay();
                    return;
                }

                freshSteps.forEach(s => s.classList.remove('step-selected'));
                const target = freshSteps[nextIdx];
                target.classList.add('step-selected');

                // ë‹¤ìŒ ìŠ¤í… ìŒì„± ì•ˆë‚´ (ê°•ì œ)
                speakCurrentSelectedStep(true);

                // ë‹¤ì‹œ ë‹¤ìŒ ìŠ¤í… ì˜ˆì•½
                scheduleNextAutoStep(nextIdx);
            }, AUTO_TOTAL_SECONDS * 1000);
        }

        function startAutoPlayFromFirstStep() {
            if (!autoPlayEnabled || !isRecipeModalOpen()) return;

            const steps = recipeModalBody.querySelectorAll('.recipe-step');
            if (!steps.length) return;

            steps.forEach(s => s.classList.remove('step-selected'));
            steps[0].classList.add('step-selected');

            // ì²« ìŠ¤í… ì¦‰ì‹œ ì•ˆë‚´
            speakCurrentSelectedStep(true);

            // ì´í›„ 20ì´ˆ ê°„ê²©ìœ¼ë¡œ ë‹¤ìŒ ìŠ¤í…
            scheduleNextAutoStep(0);
        }

        function buildStepsFromCard(recipeId) {
            const container = document.getElementById('recipe-steps-' + recipeId);
            recipeModalBody.innerHTML = '';

            if (!container) {
                recipeModalBody.innerHTML =
                        '<p class="text-muted small mb-0">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                const stepTexts = container.querySelectorAll('.recipe-step-text');

                if (stepTexts.length === 0) {
                    recipeModalBody.innerHTML =
                            '<p class="text-muted small mb-0">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    stepTexts.forEach((stepNode, index) => {
                        const text = stepNode.textContent.trim();

                        const div = document.createElement('div');
                        div.className = 'recipe-step';

                        const offset = index * 24;
                        div.style.marginLeft = offset + 'px';

                        const idxSpan = document.createElement('span');
                        idxSpan.className = 'step-index';
                        idxSpan.textContent = 'Step ' + (index + 1) + '.';

                        const textSpan = document.createElement('span');
                        textSpan.className = 'step-text';
                        textSpan.textContent = text || 'ë‚´ìš© ì—†ìŒ';

                        div.appendChild(idxSpan);
                        div.appendChild(textSpan);

                        recipeModalBody.appendChild(div);
                    });
                }
            }

            const stepDivs = recipeModalBody.querySelectorAll('.recipe-step');
            if (!stepDivs.length) return;

            // ì²« ë²ˆì§¸ ìŠ¤í…ë§Œ ì„ íƒ (ì—¬ê¸°ì„œëŠ” TTS ì¬ìƒ ì•ˆ í•¨)
            stepDivs[0].classList.add('step-selected');

            // í´ë¦­ ì‹œ ì„ íƒ & TTS (ìˆ˜ë™)
            stepDivs.forEach(step => {
                step.addEventListener('click', () => {
                    stepDivs.forEach(s => s.classList.remove('step-selected'));
                    step.classList.add('step-selected');
                    speakCurrentSelectedStep(false); // ìˆ˜ë™ì¼ ë•ŒëŠ” ttsEnabledì— ë”°ë¼
                });
            });
        }

        function openRecipeModal(menu) {
            recipeModalTitle.textContent = '#' + menu.id + ' ' + menu.name + ' ë ˆì‹œí”¼';

            stopSpeak();
            stopAutoPlay();   // ì´ì „ ìë™ì¬ìƒ/íƒ€ì´ë¨¸ ì •ë¦¬

            // ğŸ”Š ìë™ì¬ìƒì´ ì¼œì ¸ ìˆìœ¼ë©´ ìŠ¤í”¼ì»¤ ì•„ì´ì½˜ë„ ON ìƒíƒœë¡œ
            if (autoPlayEnabled) {
                ttsEnabled = true;
            }
            updateTtsToggleVisual();

            buildStepsFromCard(menu.id);

            recipeModal.classList.add('show');

            // ìë™ì¬ìƒ ìŠ¬ë¼ì´ë”ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì•ˆë‚´ ì‹œì‘
            if (autoPlayEnabled) {
                startAutoPlayFromFirstStep();
            }
        }

        function closeRecipeModal() {
            recipeModal.classList.remove('show');
            stopSpeak();
            stopAutoPlay();
        }

        function showNoRecipePopup() {
            if (!noRecipePopup) return;
            if (noRecipePopupTimer) {
                clearTimeout(noRecipePopupTimer);
                noRecipePopupTimer = null;
            }
            noRecipePopup.textContent = 'ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
            noRecipePopup.classList.add('show');
            noRecipePopupTimer = setTimeout(() => {
                noRecipePopup.classList.remove('show');
            }, 2000);
        }

        function handleCardSelect(card, options) {
            const id = card.dataset.recipeId;
            const name = card.dataset.recipeName;
            const fromVoice = options && options.fromVoice;

            if (currentSelectedCard === card && !fromVoice) {
                clearAllSelections();
                closeRecipeModal();
                return;
            }

            clearAllSelections();

            card.classList.add('selected');
            currentSelectedMenu = {id, name};
            currentSelectedCard = card;

            updateSelectedCount();
            openRecipeModal(currentSelectedMenu);
        }

        // ====== ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ======
        function initRecognition() {
            if (recognition) return recognition;

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(Chrome / Edge ìµœì‹  ë²„ì „ ê¶Œì¥)');
                return null;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;

            recognition.onresult = function (event) {
                const rawTranscript = (event.results[0][0].transcript || '').trim();
                console.log('ìŒì„± ì¸ì‹ ê²°ê³¼:', rawTranscript);

                let normTranscript = normalizeKoreanText(rawTranscript);

                // ---- 1) "í—¬ë¦¬ì•¼" ë‹¨ë… í˜¸ì¶œ: ì•ˆë‚´ë§Œ ----
                if (normTranscript === 'í—¬ë¦¬ì•¼') {
                    speakText('ë ˆì‹œí”¼ ë²ˆí˜¸ë¥¼ ë¶ˆëŸ¬ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, ì‹­ë²ˆ, ì‹­ë²ˆ ë ˆì‹œí”¼ ë¼ê³  ë§í•´ë³´ì„¸ìš”.');
                    return;
                }

                // ê¸°ë³¸ ê°’: ì „ì²´ ë¬¸ì¥ì„ ì²˜ë¦¬ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©
                let processedRaw = rawTranscript;
                let processedNorm = normTranscript;

                // ---- 2) "í—¬ë¦¬ì•¼ ~~~" í˜•íƒœë©´ ì•ì˜ í˜¸ì¶œì–´ ì œê±° í›„ ì²˜ë¦¬ ----
                if (normTranscript.startsWith('í—¬ë¦¬ì•¼')) {
                    processedRaw = rawTranscript.replace(/^\s*í—¬ë¦¬ì•¼[\s,]*/, '');
                    processedNorm = normalizeKoreanText(processedRaw);
                }

                if (!processedNorm) return;

                // === "ìŒì„±ì¸ì‹ ê·¸ë§Œ" â†’ ì™„ì „ ì¢…ë£Œ + ìŒì„± ì¶œë ¥ ì •ì§€ ===
                if (processedNorm.includes('ìŒì„±ì¸ì‹ê·¸ë§Œ')) {
                    stopVoiceSession();
                    stopSpeak();
                    return;
                }

                // === "ê·¸ë§Œ" â†’ ë ˆì‹œí”¼ íŒì—… ë‹«ê¸°ë§Œ (ì¸ì‹ì€ ìœ ì§€) ===
                if (processedNorm.includes('ê·¸ë§Œ')) {
                    if (isRecipeModalOpen()) {
                        closeRecipeModal();
                    }
                    return;
                }

                // === "ë‹¤ìŒ" â†’ ë‹¤ìŒ ìŠ¤í… ===
                if (processedNorm.includes('ë‹¤ìŒ')) {
                    if (isRecipeModalOpen()) {
                        moveToNextStepAndSpeak();
                    }
                    return;
                }

                // === (1) ìˆ«ì ê¸°ë°˜ ë ˆì‹œí”¼ ì„ íƒ: "í—¬ë¦¬ì•¼ 10ë²ˆ", "10ë²ˆ ë ˆì‹œí”¼" ë“± ===
                const num = extractNumberFromText(processedRaw);
                if (num !== null) {
                    const cardById = document.querySelector('.menu-card[data-recipe-id="' + num + '"]');
                    if (cardById) {
                        handleCardSelect(cardById, {fromVoice: true});
                        return;
                    }
                }

                // === (2) ì´ë¦„ ê¸°ë°˜ ë ˆì‹œí”¼ ì„ íƒ ===
                let bestCard = null;
                let bestScore = 0;

                function tryMatch(withNormTranscript) {
                    cards.forEach(card => {
                        const name = card.dataset.recipeName || '';
                        const normName = normalizeKoreanText(name);
                        if (!normName) return;

                        if (withNormTranscript.includes(normName) || normName.includes(withNormTranscript)) {
                            const score = normName.length;
                            if (score > bestScore) {
                                bestScore = score;
                                bestCard = card;
                            }
                        }
                    });
                }

                // 1ì°¨: processedNorm ê¸°ì¤€ìœ¼ë¡œ íƒìƒ‰
                tryMatch(processedNorm);

                // 2ì°¨: ê³µë°± ì œê±°ëœ ì›ë¬¸ì„ ë‹¤ì‹œ ì •ê·œí™”í•´ì„œ íƒìƒ‰
                if (!bestCard) {
                    const joined = processedRaw.replace(/\s+/g, '');
                    const joinedNorm = normalizeKoreanText(joined);
                    if (joinedNorm && joinedNorm !== processedNorm) {
                        tryMatch(joinedNorm);
                    }
                }

                if (bestCard) {
                    handleCardSelect(bestCard, {fromVoice: true});
                } else {
                    showNoRecipePopup();
                }
            };

            recognition.onerror = function (event) {
                console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                recognizing = false;
                if (!voiceSessionActive) {
                    updateMicVisual(false);
                }
            };

            recognition.onend = function () {
                recognizing = false;
                if (voiceSessionActive && recognition) {
                    try {
                        recognizing = true;
                        recognition.start();
                    } catch (e) {
                        console.error('ìŒì„± ì¸ì‹ ì¬ì‹œì‘ ì‹¤íŒ¨:', e);
                        recognizing = false;
                        voiceSessionActive = false;
                        updateMicVisual(false);
                    }
                } else {
                    updateMicVisual(false);
                }
            };

            return recognition;
        }

        function startVoiceSession() {
            const rec = initRecognition();
            if (!rec) return;

            if (voiceSessionActive && recognizing) {
                return;
            }

            voiceSessionActive = true;
            updateMicVisual(true);

            if (!recognizing) {
                recognizing = true;
                try {
                    rec.start();
                } catch (e) {
                    console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨:', e);
                    recognizing = false;
                    voiceSessionActive = false;
                    updateMicVisual(false);
                }
            }
        }

        function stopVoiceSession() {
            voiceSessionActive = false;
            if (recognition && recognizing) {
                try { recognition.stop(); } catch (e) {}
            }
            recognizing = false;
            updateMicVisual(false);
        }

        function toggleVoiceRecognition() {
            if (voiceSessionActive) {
                stopVoiceSession();
            } else {
                startVoiceSession();
            }
        }

        // ì¹´ë“œ í´ë¦­ â†’ ì„ íƒ
        cards.forEach(card => {
            card.addEventListener('click', () => {
                handleCardSelect(card, {fromVoice: false});
            });
        });

        // ìƒë‹¨ ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ â†’ ìŒì„± ì¸ì‹ ON/OFF
        if (btnVoiceRecipe) {
            btnVoiceRecipe.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleVoiceRecognition();
            });
        }

        // ìë™ì¬ìƒ í† ê¸€
        if (autoPlayToggle) {
            autoPlayEnabled = autoPlayToggle.checked;
            autoPlayToggle.addEventListener('change', () => {
                autoPlayEnabled = autoPlayToggle.checked;
                if (!autoPlayEnabled) {
                    stopAutoPlay();
                } else {
                    // ëª¨ë‹¬ì´ ì´ë¯¸ ì—´ë ¤ ìˆë‹¤ë©´ ì¦‰ì‹œ ìë™ì¬ìƒ ì‹œì‘ + ìŠ¤í”¼ì»¤ ON
                    if (isRecipeModalOpen()) {
                        ttsEnabled = true;
                        updateTtsToggleVisual();
                        startAutoPlayFromFirstStep();
                    }
                }
            });
        }

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        btnCloseRecipe.addEventListener('click', () => {
            closeRecipeModal();
        });

        // ë°°ê²½ í´ë¦­ â†’ ë‹«ê¸°
        recipeModalBackdrop.addEventListener('click', () => {
            closeRecipeModal();
        });

        // ESC â†’ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRecipeModal();
            }
        });

        // ğŸ”Š TTS í† ê¸€ ë²„íŠ¼ í´ë¦­ (ìˆ˜ë™ ì½ê¸° ì „ìš©)
        if (btnTtsToggle) {
            btnTtsToggle.addEventListener('click', () => {
                ttsEnabled = !ttsEnabled;
                updateTtsToggleVisual();

                if (ttsEnabled) {
                    // í˜„ì¬ ì„ íƒëœ ìŠ¤í…ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì½ìŒ
                    speakCurrentSelectedStep(false);
                } else {
                    stopSpeak();
                }
            });
        }

        // ì´ˆê¸° ìƒíƒœ
        updateSelectedCount();
        updateTtsToggleVisual();
        updateMicVisual(false);
        setTimerProgressBySeconds(AUTO_TOTAL_SECONDS);
    })();
</script>

{{>layouts/footer}}
