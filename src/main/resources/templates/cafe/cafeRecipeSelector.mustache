{{>layouts/header}}
<style>
    body {
        background-color: #f8f9fa;
    }

    /* ìƒë‹¨ ì„ íƒ ì •ë³´ ë°” */
    .top-status-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: #ffffff;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    .menu-card {
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
        border-width: 2px;
        border-color: transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 1rem;

        position: relative;   /* ì ‘íŒ ì½”ë„ˆìš© */
        overflow: hidden;     /* ì½”ë„ˆê°€ ì¹´ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
        background-color: #ffffff;
    }

    .menu-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.08);
    }

    .menu-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0.4rem 1rem rgba(13, 110, 253, 0.25);
    }

    /* === í° ì¹´ë“œì˜ ì ‘íŒ ëª¨ì„œë¦¬ (ì¢Œì¸¡ ìƒë‹¨) === */
    .menu-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 56px;    /* ì ‘íŒ ì½”ë„ˆ í¬ê¸° */
        height: 56px;
        clip-path: polygon(0 0, 100% 0, 0 100%); /* ì‚¼ê°í˜• */
        background-color: transparent;          /* ê¸°ë³¸ì€ íˆ¬ëª…, ì•„ë˜ì—ì„œ ìƒ‰ ì§€ì • */
        z-index: 0;
    }

    .menu-card[data-recipe-temp="HOT"]::before {
        background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
    }

    .menu-card[data-recipe-temp="ICE"]::before {
        background-color: #0d6efd; /* íŒŒë€ìƒ‰ */
    }

    .menu-name {
        font-size: 2rem;           /* í¬ê²Œ */
        font-weight: 800;
        text-align: center;        /* ê°€ìš´ë° ì •ë ¬ */
    }

    .menu-tag {
        font-size: 0.9rem;
        border-radius: 999px;
        padding: 0.1rem 0.5rem;
    }

    .selected-menu-chip {
        font-size: 0.95rem;
        border-radius: 999px;
        padding: 0.2rem 0.7rem;
        cursor: default;
    }

    .selected-menu-chip + .selected-menu-chip {
        margin-left: 0.25rem;
    }

    .card-count-badge {
        font-size: 0.85rem;
    }

    /* ===== ë ˆì‹œí”¼ ì¹´ë“œ ê·¸ë¦¬ë“œ (4ì—´) ===== */
    .menu-grid-wrapper {
        height: calc(100vh - 210px);     /* ìƒë‹¨ë°”/ì—¬ë°± ê³ ë ¤ê°’ */
        max-height: calc(100vh - 210px);
        overflow-y: auto;
    }

    .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));   /* 4ì—´ */
        grid-auto-rows: 1fr;
        grid-auto-flow: row;
        gap: 1rem;
        height: 100%;
    }

    .menu-grid-item {
        display: flex;
    }

    .menu-grid-item .menu-card {
        width: 100%;
    }

    /* ì¹´ë“œ ì•ˆ ë‚´ìš©ì´ ì ‘íŒ ì½”ë„ˆ ìœ„ì— ì˜¤ë„ë¡ */
    .menu-card .card-body {
        position: relative;
        z-index: 1;
    }

    /* ===== HOT / ICE ë°°ì§€ (ë¼ìš´ë“œë ‰íŠ¸ + ì ‘íŒ ì½”ë„ˆ + ì´ëª¨ì§€) ===== */
    .temp-badge {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem 1rem;
        padding-left: 1.4rem;      /* ì ‘íŒ ì½”ë„ˆ ì˜ì—­ë§Œí¼ ì‚´ì§ ì—¬ìœ  */
        border-radius: 999px;
        background-color: #ffffff;
        border: 3px solid;
        font-size: 1.3rem;         /* ì¢€ ë” í¬ê²Œ */
        font-weight: 800;          /* êµµê²Œ */
        gap: 0.25rem;
        line-height: 1;
        overflow: hidden;          /* ì ‘íŒ ì½”ë„ˆê°€ íŠ€ì–´ë‚˜ì˜¤ì§€ ì•Šë„ë¡ */
    }

    /* ë°°ì§€ ì ‘íŒ ì½”ë„ˆ(ì¢Œì¸¡ ìƒë‹¨) */
    .temp-badge::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        clip-path: polygon(0 0, 100% 0, 0 100%);  /* ì‚¼ê°í˜• ëª¨ì–‘ */
    }

    .temp-HOT {
        border-color: #dc3545;
        color: #dc3545;
    }

    .temp-ICE {
        border-color: #0d6efd;
        color: #0d6efd;
    }

    .temp-HOT::before {
        background-color: #dc3545;      /* ì ‘íŒ ì½”ë„ˆ ë¹¨ê°„ìƒ‰ */
    }

    .temp-ICE::before {
        background-color: #0d6efd;      /* ì ‘íŒ ì½”ë„ˆ íŒŒë€ìƒ‰ */
    }

    /* ì´ëª¨ì§€: í…ìŠ¤íŠ¸ ì˜¤ë¥¸ìª½ì— ë¶™ì„ */
    .temp-HOT::after {
        content: "ğŸ”¥";
        margin-left: 0.3rem;
        font-size: 1.4rem;
    }

    .temp-ICE::after {
        content: "â„";
        margin-left: 0.3rem;
        font-size: 1.4rem;
    }

    /* OZ (ì»µ ì‚¬ì´ì¦ˆ) ë°°ì§€: ë” í¬ê³  êµµê²Œ */
    .cup-badge {
        font-size: 1.3rem;          /* í¬ê²Œ */
        font-weight: 800;           /* êµµê²Œ */
        padding: 0.2rem 0.8rem;
        border-radius: 999px;
        background-color: #f8f9fa;
        border: 2px solid #adb5bd;
    }

    /* ===== ë ˆì‹œí”¼ íŒì—…(ëª¨ë‹¬) ===== */
    .recipe-modal {
        position: fixed;
        inset: 0;
        z-index: 1050;
        display: none;              /* .show ì¼ ë•Œ flexë¡œ ë°”ë€œ */
        align-items: center;
        justify-content: center;
    }

    .recipe-modal.show {
        display: flex;
    }

    .recipe-modal-backdrop {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.45);
    }

    .recipe-modal-dialog {
        position: relative;
        z-index: 1060;
        background-color: #ffffff;
        border-radius: 0.75rem;

        /* íŒì—… ê°€ë¡œ í¬ê¸° ë” í¬ê²Œ (ì•½ 1.5ë°°) */
        max-width: 1280px;
        width: 95%;

        /* í™”ë©´ ìƒí•˜ ì´ˆê³¼ ë°©ì§€ */
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;

        box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.25);
        padding: 1.25rem 1.5rem 1.5rem;
        margin: 0 1rem;
    }

    .recipe-modal-header {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .recipe-modal-title {
        font-size: 2rem;   /* ì œëª© ì•½ê°„ ë” í¬ê²Œ */
        font-weight: 700;
        margin: 0;
    }

    .recipe-modal-body {
        flex-grow: 1;
        overflow-y: auto;      /* íŒì—… ìì²´ëŠ” ê³ ì •, ë‚´ë¶€ë§Œ ìŠ¤í¬ë¡¤ */
        padding-right: 0.5rem;
    }

    /* ê³„ë‹¨(ìŠ¤í…) ìŠ¤íƒ€ì¼ + ê¸€ì”¨ ì¢€ ë” í¬ê²Œ, ìœ„ì•„ë˜ ê°„ê²© ë” ë„“ê²Œ */
    .recipe-step {
        position: relative;
        background-color: #ffffff;
        border-radius: 0.5rem;
        padding: 1.3rem 1.5rem;   /* ìƒí•˜ íŒ¨ë”© ë” ì¦ê°€ */
        margin-bottom: 1.8rem;    /* ìŠ¤í… ê°„ ê°„ê²© ë„“ê²Œ */
        box-shadow: 0 0.35rem 0.8rem rgba(0, 0, 0, 0.08);
        border-left: 6px solid #0d6efd;

        font-size: 2.2rem;        /* íŒì—… ê¸€ì”¨ ì¡°ê¸ˆ ë” í¬ê²Œ */
        line-height: 1.6;

        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
    }

    .step-index {
        font-weight: 900;
        margin-right: 0.7rem;
    }

    .step-text {
        display: inline-block;
        vertical-align: middle;
    }

    /* ì„ íƒëœ ìŠ¤í… (íŒŒë€ìƒ‰ ë°°ê²½) */
    .recipe-step.step-selected {
        background-color: #0d6efd;
        color: #ffffff;
        box-shadow: 0 0.35rem 0.9rem rgba(13, 110, 253, 0.45);
    }

    .btn-close {
        border: none;
        background: transparent;
        font-size: 1.7rem;
        line-height: 1;
    }
</style>

<div class="container-fluid py-3">

    <!-- ìƒë‹¨ ì„ íƒ ìƒíƒœ ë°” -->
    <div class="top-status-bar d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div class="d-flex flex-column flex-sm-row flex-wrap align-items-sm-center gap-2">
            <div class="fw-bold">
                ì£¼ìš” ë ˆì‹œí”¼ë¥¼ ì„ íƒí•˜ì„¸ìš”
                <span class="text-muted ms-1">(í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì„ íƒ)</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary card-count-badge">
                    ì„ íƒí•œ ë ˆì‹œí”¼
                    <span id="selected-count" class="fw-bold ms-1">0</span> / 1
                </span>
            </div>
        </div>
    </div>

    <!-- ì„ íƒí•œ ë©”ë‰´(ë ˆì‹œí”¼) ë¦¬ìŠ¤íŠ¸(ì¹©) -->
    <div class="mb-3">
        <div class="small text-muted mb-1">í˜„ì¬ ì„ íƒí•œ ë ˆì‹œí”¼</div>
        <div id="selected-menu-chips" class="d-flex flex-wrap gap-1">
            <!-- JSë¡œ chip ì¶”ê°€ -->
        </div>
    </div>

    <!-- ë ˆì‹œí”¼ ì¹´ë“œ ê·¸ë¦¬ë“œ (4ì—´) -->
    <div class="menu-grid-wrapper mb-4">
        <div class="menu-grid">
            {{#recipeRows}}
                <div class="menu-grid-item">
                    <div class="card menu-card"
                         data-recipe-id="{{id}}"
                         data-recipe-name="{{menuName}}"
                         data-recipe-temp="{{temperature}}">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                            <!-- ê°€ìš´ë° í¬ê²Œ ë©”ë‰´ ì´ë¦„ -->
                            <div class="menu-name mb-2">
                                {{menuName}}
                            </div>

                            <!-- ì•„ë˜ì— ì¹´í…Œê³ ë¦¬ / íƒœê·¸ë“¤ -->
                            <div class="d-flex flex-column align-items-center gap-2">
                                {{#category}}
                                    <span class="badge text-bg-light">
                                        {{category}}
                                    </span>
                                {{/category}}

                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    {{#temperature}}
                                        <span class="temp-badge temp-{{temperature}}">
                                            {{temperature}}
                                        </span>
                                    {{/temperature}}

                                    {{#cupSize}}
                                        <span class="cup-badge">
                                            {{cupSize}}
                                        </span>
                                    {{/cupSize}}
                                </div>
                            </div>

                            <!-- ìˆ¨ê²¨ì§„ ë ˆì‹œí”¼ ìŠ¤í… (ëª¨ë‹¬ìš©) -->
                            <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                {{#steps}}
                                    <div class="recipe-step-text">{{.}}</div>
                                {{/steps}}
                                {{^steps}}
                                    <div class="recipe-step-text text-muted">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                {{/steps}}
                            </div>
                        </div>
                    </div>
                </div>
            {{/recipeRows}}

            {{^recipeRows}}
                <div class="menu-grid-item">
                    <div class="alert alert-warning mb-0 w-100">
                        í‘œì‹œí•  ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. <code>visible == true</code> ì¸ ë ˆì‹œí”¼ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.
                    </div>
                </div>
            {{/recipeRows}}
        </div>
    </div>
</div>

<!-- ë ˆì‹œí”¼ íŒì—…(ëª¨ë‹¬) -->
<div id="recipe-modal" class="recipe-modal">
    <div class="recipe-modal-backdrop" id="recipe-modal-backdrop"></div>
    <div class="recipe-modal-dialog">
        <div class="recipe-modal-header">
            <h5 class="recipe-modal-title" id="recipe-modal-title">ë ˆì‹œí”¼</h5>
            <button type="button" class="btn-close" id="btn-close-recipe" aria-label="Close">&times;</button>
        </div>
        <div class="recipe-modal-body" id="recipe-modal-body">
            <p class="text-muted small mb-0">
                ì„ íƒí•œ ë ˆì‹œí”¼ì˜ ìŠ¤í…ì´ ì—¬ê¸° ê³„ë‹¨í˜•ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<!-- JS: ë‹¨ì¼ ì„ íƒ + íŒì—… ë ˆì‹œí”¼ -->
<script>
    (function () {
        const cards = document.querySelectorAll('.menu-card');
        const selectedCountSpan = document.getElementById('selected-count');
        const chipsContainer = document.getElementById('selected-menu-chips');

        const recipeModal = document.getElementById('recipe-modal');
        const recipeModalBackdrop = document.getElementById('recipe-modal-backdrop');
        const recipeModalTitle = document.getElementById('recipe-modal-title');
        const recipeModalBody = document.getElementById('recipe-modal-body');
        const btnCloseRecipe = document.getElementById('btn-close-recipe');

        let currentSelectedMenu = null; // {id, name}
        let currentSelectedCard = null;

        function updateSelectedCount() {
            selectedCountSpan.textContent = currentSelectedMenu ? '1' : '0';
        }

        function renderSelectedChip() {
            chipsContainer.innerHTML = '';
            if (!currentSelectedMenu) return;

            const span = document.createElement('span');
            span.className = 'badge bg-primary-subtle text-primary-emphasis selected-menu-chip';
            span.textContent = currentSelectedMenu.name;
            chipsContainer.appendChild(span);
        }

        function clearAllSelections() {
            cards.forEach(c => c.classList.remove('selected'));
            currentSelectedMenu = null;
            currentSelectedCard = null;
            renderSelectedChip();
            updateSelectedCount();
        }

        function buildStepsFromCard(recipeId) {
            const container = document.getElementById('recipe-steps-' + recipeId);
            recipeModalBody.innerHTML = '';

            if (!container) {
                recipeModalBody.innerHTML =
                        '<p class="text-muted small mb-0">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const stepTexts = container.querySelectorAll('.recipe-step-text');

            if (stepTexts.length === 0) {
                recipeModalBody.innerHTML =
                        '<p class="text-muted small mb-0">ë“±ë¡ëœ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            stepTexts.forEach((stepNode, index) => {
                const text = stepNode.textContent.trim();
                const div = document.createElement('div');
                div.className = 'recipe-step';

                // ê³„ë‹¨ í˜•íƒœ: ë‹¨ê³„ê°€ ë‚´ë ¤ê°ˆìˆ˜ë¡ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
                const offset = index * 24; // px
                div.style.marginLeft = offset + 'px';

                div.innerHTML =
                        '<span class="step-index">Step ' + (index + 1) + '.</span>' +
                        '<span class="step-text">' + (text || 'ë‚´ìš© ì—†ìŒ') + '</span>';

                recipeModalBody.appendChild(div);
            });

            // ìŠ¤í… DOM ìƒì„± í›„: ì²« ë²ˆì§¸ ìŠ¤í… ìë™ ì„ íƒ + í´ë¦­ í•¸ë“¤ëŸ¬ ë¶€ì°©
            const stepDivs = recipeModalBody.querySelectorAll('.recipe-step');
            if (!stepDivs.length) return;

            // ì²« ë²ˆì§¸ ìŠ¤í… ìë™ ì„ íƒ
            stepDivs[0].classList.add('step-selected');

            // í´ë¦­ ì‹œ ì„ íƒ í† ê¸€ (í•˜ë‚˜ë§Œ ì„ íƒ)
            stepDivs.forEach(step => {
                step.addEventListener('click', () => {
                    stepDivs.forEach(s => s.classList.remove('step-selected'));
                    step.classList.add('step-selected');
                });
            });
        }

        function openRecipeModal(menu) {
            recipeModalTitle.textContent = menu.name + ' ë ˆì‹œí”¼';
            buildStepsFromCard(menu.id);
            recipeModal.classList.add('show');
        }

        function closeRecipeModal() {
            recipeModal.classList.remove('show');
        }

        cards.forEach(card => {
            card.addEventListener('click', () => {
                const id = card.dataset.recipeId;
                const name = card.dataset.recipeName;

                // ê°™ì€ ì¹´ë“œ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ + ëª¨ë‹¬ ë‹«ê¸°
                if (currentSelectedCard === card) {
                    clearAllSelections();
                    closeRecipeModal();
                    return;
                }

                // ì´ì „ ì„ íƒ í•´ì œ
                clearAllSelections();

                // ìƒˆ ì„ íƒ
                card.classList.add('selected');
                currentSelectedMenu = {id, name};
                currentSelectedCard = card;

                renderSelectedChip();
                updateSelectedCount();
                openRecipeModal(currentSelectedMenu);
            });
        });

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        btnCloseRecipe.addEventListener('click', () => {
            closeRecipeModal();
        });

        // ë°°ê²½ í´ë¦­í•˜ë©´ ë‹«ê¸°
        recipeModalBackdrop.addEventListener('click', () => {
            closeRecipeModal();
        });

        // ESC í‚¤ë¡œ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRecipeModal();
            }
        });

        // ì´ˆê¸° ìƒíƒœ
        updateSelectedCount();
    })();
</script>

{{>layouts/footer}}
