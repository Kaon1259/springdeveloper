{{>layouts/header}}
<style>
    body { background-color: #f8f9fa; }

    .top-status-bar {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: #ffffff;
        border-bottom: 1px solid #dee2e6;
        padding: 0.9rem 1.5rem;
        min-height: 64px;
    }

    .menu-card {
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
        border-width: 2px;
        border-color: transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
        background-color: #ffffff;
    }

    .menu-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.4rem 1rem rgba(0,0,0,0.08);
    }

    .menu-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0.4rem 1rem rgba(13,110,253,0.25);
    }

    .menu-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 56px;
        height: 56px;
        clip-path: polygon(0 0, 100% 0, 0 100%);
    }

    .menu-card[data-recipe-temp="HOT"]::before { background-color: #dc3545; }
    .menu-card[data-recipe-temp="ICE"]::before { background-color: #0d6efd; }

    .menu-name {
        font-size: 2rem;
        font-weight: 800;
        text-align: center;
    }

    .menu-grid-wrapper {
        height: calc(100vh - 210px);
        overflow-y: auto;
    }

    .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 1rem;
    }

    .temp-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.4rem 1rem 0.4rem 1.4rem;
        border-radius: 999px;
        background-color: #fff;
        border: 3px solid;
        font-size: 1.3rem;
        font-weight: 800;
        position: relative;
        line-height: 1;
        white-space: nowrap;
    }

    .temp-HOT { border-color: #dc3545; color: #dc3545; }
    .temp-ICE { border-color: #0d6efd; color: #0d6efd; }

    .temp-HOT::after { content: "ğŸ”¥"; margin-left: .4rem; }
    .temp-ICE::after { content: "â„"; margin-left: .4rem; }

    .cup-badge {
        font-size: 1.3rem;
        font-weight: 800;
        padding: 0.2rem 0.8rem;
        border-radius: 999px;
        background-color: #f8f9fa;
        border: 2px solid #adb5bd;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1;
        white-space: nowrap;
    }

    /* âœ… ì¹´ë“œ ë‚´ ë¸”ë Œë” ì´ë¯¸ì§€ */
    .blender-img-inline{
        height: 1.6rem;
        width: auto;
        object-fit: contain;
        display: inline-block;
        vertical-align: middle;
        flex: 0 0 auto;
        pointer-events: none;
    }

    /* =========================
       âœ… íŒì—…(ëª¨ë‹¬) ìŠ¤íƒ€ì¼
       ========================= */
    #recipePopupModal .modal-dialog{
        max-width: 1200px;
        width: 95%;
    }
    #recipePopupModal .modal-content{
        border-radius: 0.9rem;
        max-height: 90vh;
        box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.25);
    }
    #recipePopupModal .modal-body{
        max-height: 75vh;
        overflow-y: auto;
        font-size: 2.2rem;
    }

    .popup-title-wrap{
        display:flex;
        align-items:center;
        gap: 0.75rem;
        flex-wrap:wrap;
    }
    .popup-title{
        font-size: 2.4rem;
        font-weight: 900;
        letter-spacing: -0.2px;
    }

    /* âœ… íŒì—…ì—ì„œ ë¸”ë Œë” ì´ë¯¸ì§€ëŠ” ë” í¬ê²Œ */
    .blender-img-modal{
        height: 4.6rem;
        width: auto;
        object-fit: contain;
        display:inline-block;
        vertical-align: middle;
    }
    .blender-note{
        color:#dc3545;
        font-weight: 900;
        font-size: 1.6rem;
        letter-spacing: -0.2px;
        white-space: nowrap;
    }

    .popup-meta{
        font-size: 1.6rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .popup-step{
        background: #fff;
        border-radius: 0.7rem;
        padding: 1.1rem 1.2rem;
        margin-bottom: 0.9rem;
        border-left: 8px solid #0d6efd;
        box-shadow: 0 0.35rem 0.9rem rgba(0,0,0,0.08);
        line-height: 1.35;
        cursor: pointer;
    }
    .popup-step.selected{
        background:#0d6efd;
        color:#fff;
        box-shadow: 0 0.35rem 0.9rem rgba(13,110,253,0.35);
    }
    .popup-step .idx{
        font-weight: 900;
        margin-right: 0.75rem;
    }
    .popup-step .time{
        font-size: 1.5rem;
        color: rgba(255,255,255,0.85);
        margin-left: 0.7rem;
    }
    .popup-step:not(.selected) .time{
        color:#6c757d;
    }
</style>

<div class="container-fluid py-3">
    <div class="top-status-bar d-flex justify-content-between align-items-center mb-3">
        <div class="fw-bold">
            ì£¼ìš” ë ˆì‹œí”¼ë¥¼ ì„ íƒí•˜ì„¸ìš”
            <span class="text-muted ms-1">(í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì„ íƒ)</span>
        </div>
        <span class="badge bg-primary">
            ì„ íƒí•œ ë ˆì‹œí”¼ <span id="selected-count">0</span> / 1
        </span>
    </div>

    <div class="menu-grid-wrapper">
        <div class="menu-grid" id="menu-grid">
            {{#recipeRows}}
                <div class="menu-grid-item">
                    <div class="menu-card"
                         data-recipe-id="{{id}}"
                         data-recipe-name="{{menuName}}"
                         data-recipe-temp="{{temperature}}"
                         data-recipe-cup="{{cupSize}}"
                         data-recipe-category="{{category}}"
                         data-use-blender="{{useBlender}}">

                        <div class="card-body d-flex flex-column align-items-center justify-content-center">
                            <div class="menu-name mb-3">{{menuName}}</div>

                            <div class="d-flex flex-column align-items-center gap-2">
                                <span class="badge text-bg-light">{{category}}</span>

                                <div class="d-flex gap-2 align-items-center">
                                    <span class="temp-badge temp-{{temperature}}">{{temperature}}</span>

                                    <!-- âœ… ëª©ë¡(ê¸°ë³¸ ì¶œë ¥)ì€ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ë˜, JSì—ì„œ 17/20ë§Œ 1.7/2.0ìœ¼ë¡œ ë³€í™˜ -->
                                    <span class="cup-badge cup-badge-js">{{cupSize}}
                                        {{#useBlender}}
                                            <img class="blender-img-inline"
                                                 src="/img/blender.jpg"
                                                 alt="ë¸”ë Œë” ì‚¬ìš©"
                                                 title="ë¸”ë Œë” ì‚¬ìš©">
                                        {{/useBlender}}
                                    </span>
                                </div>
                            </div>

                            <!-- âœ… hidden steps/times (íŒì—…ì—ì„œ ì‚¬ìš©) -->
                            <div class="d-none recipe-steps" id="recipe-steps-{{id}}">
                                {{#steps}}
                                    <div class="recipe-step-text">{{.}}</div>
                                {{/steps}}
                                {{#stepTimes}}
                                    <div class="recipe-step-time">{{.}}</div>
                                {{/stepTimes}}
                            </div>

                        </div>
                    </div>
                </div>
            {{/recipeRows}}

            {{^recipeRows}}
                <div class="alert alert-warning w-100">
                    í‘œì‹œí•  ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            {{/recipeRows}}
        </div>
    </div>
</div>

<div class="modal fade" id="recipePopupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="popup-title-wrap" id="popup-title-wrap">
                    <div class="popup-title" id="popup-title">ë ˆì‹œí”¼</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>

            <div class="modal-body">
                <div class="popup-meta" id="popup-meta"></div>
                <div id="popup-steps"></div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary btn-lg" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const grid = document.getElementById('menu-grid');
        if (!grid) return;

        const selectedCountEl = document.getElementById('selected-count');

        const modalEl = document.getElementById('recipePopupModal');
        const popupTitleWrap = document.getElementById('popup-title-wrap');
        const popupTitle = document.getElementById('popup-title');
        const popupMeta = document.getElementById('popup-meta');
        const popupSteps = document.getElementById('popup-steps');

        function parseTruth(v) {
            const s = String(v || '').trim().toLowerCase();
            return (s === 'true' || s === '1' || s === 'y' || s === 'yes' || s === 'on');
        }

        function clearSelected() {
            grid.querySelectorAll('.menu-card.selected').forEach(el => el.classList.remove('selected'));
        }

        function setSelectedCount(n) {
            if (selectedCountEl) selectedCountEl.textContent = String(n);
        }

        // âœ… ëª©ë¡(ê¸°ë³¸ ì¶œë ¥)ìš©: 17 -> 1.7, 20 -> 2.0 ë§Œ ì ìš©, ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ
        function displayCupInList(rawCupText) {
            const raw = String(rawCupText || '').trim().toUpperCase();

            // enum / ë¦¬í„° / ìˆ«ì(ounce ì €ì¥ê°’) ëª¨ë‘ ëŒ€ì‘
            if (raw === 'L17' || raw === '17L' || raw === '57' || raw === '17') return '1.7';
            if (raw === 'L20' || raw === '20L' || raw === '67' || raw === '20') return '2.0';

            return String(rawCupText || '').trim();
        }

        // âœ… íŒì—…(ëª¨ë‹¬)ìš©: 17 -> 1.7L, 20 -> 2.0L ë§Œ ì ìš©, ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ
        function displayCupInModal(rawCupText) {
            const raw = String(rawCupText || '').trim().toUpperCase();

            if (raw === 'L17' || raw === '17L' || raw === '57' || raw === '17') return '1.7L';
            if (raw === 'L20' || raw === '20L' || raw === '67' || raw === '20') return '2.0L';

            return String(rawCupText || '').trim();
        }

        // âœ… í˜ì´ì§€ ë¡œë“œì‹œ ê¸°ë³¸ ì¶œë ¥(ì¹´ë“œì˜ ì»µë±ƒì§€)ì—ì„œ 17/20ë§Œ ë³€í™˜
        function applyCupDisplayOnCards() {
            const badges = grid.querySelectorAll('.cup-badge-js');
            badges.forEach(badge => {
                // blender imgê°€ ê°™ì´ ë“¤ì–´ìˆìœ¼ë‹ˆ, í…ìŠ¤íŠ¸ë§Œ ì•ˆì „í•˜ê²Œ ë°”ê¾¸ê¸°
                // 1) í˜„ì¬ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                const textNodes = Array.from(badge.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
                const rawText = (textNodes.map(n => n.textContent).join('') || '').trim();

                const newText = displayCupInList(rawText);

                // 2) ê¸°ì¡´ í…ìŠ¤íŠ¸ ë…¸ë“œ ì œê±° í›„, ë§¨ ì•ì— ìƒˆ í…ìŠ¤íŠ¸ ë…¸ë“œ ì‚½ì…
                textNodes.forEach(n => badge.removeChild(n));
                badge.insertBefore(document.createTextNode(newText + ' '), badge.firstChild);
            });
        }

        function buildPopup(card) {
            const id = card.dataset.recipeId;
            const name = card.dataset.recipeName || 'ë ˆì‹œí”¼';
            const temp = (card.dataset.recipeTemp || '').toUpperCase();
            const cupRaw = card.dataset.recipeCup || '';
            const category = card.dataset.recipeCategory || '';
            const useBlender = parseTruth(card.dataset.useBlender);

            // ì œëª©
            popupTitle.textContent = name;

            // ì œëª© ì˜† ë¸”ë Œë” ì´ë¯¸ì§€(íŒì—…ì—ì„œ í¬ê²Œ)
            popupTitleWrap.querySelectorAll('img.blender-img-modal, span.blender-note').forEach(el => el.remove());
            if (useBlender) {
                const img = document.createElement('img');
                img.className = 'blender-img-modal';
                img.src = '/img/blender.jpg';
                img.alt = 'ë¸”ë Œë” ì‚¬ìš©';
                img.title = 'ë¸”ë Œë” ì‚¬ìš©';

                const note = document.createElement('span');
                note.className = 'blender-note';
                note.textContent = '(ë¸”ë Œë”ì‚¬ìš©)';

                popupTitleWrap.appendChild(img);
                popupTitleWrap.appendChild(note);
            }

            // ë©”íƒ€ ì •ë³´ (âœ… íŒì—…ì—ì„œë§Œ 1.7L / 2.0L í‘œê¸°)
            const tempLabel = temp === 'HOT' ? 'HOT ğŸ”¥' : (temp === 'ICE' ? 'ICE â„' : temp);
            const cupLabel = displayCupInModal(cupRaw);
            popupMeta.textContent = `ì¹´í…Œê³ ë¦¬: ${category} Â· ì˜¨ë„: ${tempLabel} Â· ì»µ: ${cupLabel}`;

            // ìŠ¤í…/ì‹œê°„ ì½ê¸°
            const hidden = document.getElementById('recipe-steps-' + id);
            const stepTexts = hidden ? Array.from(hidden.querySelectorAll('.recipe-step-text')).map(x => (x.textContent || '').trim()) : [];
            const stepTimes = hidden ? Array.from(hidden.querySelectorAll('.recipe-step-time')).map(x => (x.textContent || '').trim()) : [];

            // ë Œë”ë§
            popupSteps.innerHTML = '';
            if (stepTexts.length === 0) {
                popupSteps.innerHTML = '<div class="text-muted">ë“±ë¡ëœ ë‹¨ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            stepTexts.forEach((txt, idx) => {
                if (!txt) return;

                const t = stepTimes[idx] || '';
                const row = document.createElement('div');
                row.className = 'popup-step';
                row.innerHTML = `
                    <span class="idx">Step ${idx + 1}.</span>
                    <span class="txt">${txt.replace(/\n/g, '<br>')}</span>
                    ${t ? `<span class="time">(${t}ì´ˆ)</span>` : ``}
                `;

                row.addEventListener('click', () => {
                    popupSteps.querySelectorAll('.popup-step').forEach(s => s.classList.remove('selected'));
                    row.classList.add('selected');
                });

                popupSteps.appendChild(row);
            });

            // ì²« ìŠ¤í… ì„ íƒ
            const first = popupSteps.querySelector('.popup-step');
            if (first) first.classList.add('selected');
        }

        function openModal(card) {
            buildPopup(card);

            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            } else {
                alert('Bootstrap Modalì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (headerì—ì„œ bootstrap.bundle.min.js ë¡œë“œ í™•ì¸)');
            }
        }

        // âœ… ì´ë²¤íŠ¸ ìœ„ì„: ì¹´ë“œ í´ë¦­ ì‹œ íŒì—…
        grid.addEventListener('click', (e) => {
            const card = e.target.closest('.menu-card');
            if (!card) return;

            clearSelected();
            card.classList.add('selected');
            setSelectedCount(1);

            openModal(card);
        });

        // ì´ˆê¸° ì¹´ìš´íŠ¸ + ì»µ í‘œê¸° ë³´ì •
        setSelectedCount(0);
        applyCupDisplayOnCards();
    })();
</script>

{{>layouts/footer}}
